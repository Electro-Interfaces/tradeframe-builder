<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üîç –û—Ç–ª–∞–¥–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        .highlight { background: #fbbf24; color: #000; padding: 2px 4px; }
        pre { background: #262626; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 200px; }
        h2 { border-bottom: 2px solid #444; padding-bottom: 10px; }
        .step { margin: 20px 0; border-left: 3px solid #60a5fa; padding-left: 15px; }
    </style>
</head>
<body>
    <h1>üîç –ü–û–õ–ù–ê–Ø –û–¢–õ–ê–î–ö–ê: –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –¥–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤</h1>
    <div id="results"></div>

    <script type="module">
        import { tanksUnifiedService } from './src/services/tanksUnifiedService.js';
        import { tanksService } from './src/services/tanksServiceSupabase.js';

        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const className = type;
            results.innerHTML += `<div class="${className}">${message}</div>`;
            console.log(message);
        }

        async function debugDataSource() {
            log('üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –ü–û–õ–ù–£–Æ –û–¢–õ–ê–î–ö–£ –ò–°–¢–û–ß–ù–ò–ö–ê –î–ê–ù–ù–´–•...', 'info');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É
            const selectedPointId = localStorage.getItem('selectedTradingPointId');
            log(`üìç –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞: ${selectedPointId || '–ù–ï –í–´–ë–†–ê–ù–ê'}`, selectedPointId ? 'success' : 'error');
            
            if (!selectedPointId || selectedPointId === 'all') {
                log('‚ùå –°–¢–û–ü! –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–æ—á–∫—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.', 'error');
                return;
            }

            results.innerHTML += '<div class="step"><h2>–®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã tanks –≤ Supabase</h2>';
            try {
                log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É tanks –Ω–∞–ø—Ä—è–º—É—é...', 'info');
                const directTanks = await tanksService.getTanks(selectedPointId);
                log(`üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ tanks: ${directTanks.length}`, directTanks.length > 0 ? 'success' : 'warning');
                
                if (directTanks.length > 0) {
                    log(`<span class="highlight">–ù–ê–ô–î–ï–ù –ò–°–¢–û–ß–ù–ò–ö!</span> –î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã tanks`, 'success');
                    results.innerHTML += '<pre>' + JSON.stringify(directTanks.slice(0, 2), null, 2) + '</pre>';
                    
                    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                    directTanks.forEach((tank, index) => {
                        log(`üõ¢Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä ${index + 1}: ${tank.name} (${tank.fuelType}) - ${tank.currentLevelLiters}/${tank.capacityLiters}–ª`, 'info');
                    });
                } else {
                    log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ tanks –ø—É—Å—Ç–∞ - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∏–∑ API', 'success');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–∞–±–ª–∏—Ü—ã tanks: ${error.message}`, 'error');
            }
            results.innerHTML += '</div>';

            results.innerHTML += '<div class="step"><h2>–®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã equipment</h2>';
            try {
                log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É equipment (—Ç–∏–ø fuel_tank)...', 'info');
                const { equipmentSupabaseService } = await import('./src/services/equipmentSupabase.js');
                const equipmentList = await equipmentSupabaseService.list({
                    trading_point_id: selectedPointId,
                    system_type: 'fuel_tank'
                });
                
                const equipmentCount = equipmentList.data ? equipmentList.data.length : 0;
                log(`üìä –ù–∞–π–¥–µ–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Ç–∏–ø–∞ fuel_tank: ${equipmentCount}`, equipmentCount > 0 ? 'success' : 'warning');
                
                if (equipmentCount > 0) {
                    log(`<span class="highlight">–í–û–ó–ú–û–ñ–ù–´–ô –ò–°–¢–û–ß–ù–ò–ö!</span> –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—Ä–∞—Ç—å—Å—è –∏–∑ equipment`, 'warning');
                    results.innerHTML += '<pre>' + JSON.stringify(equipmentList.data.slice(0, 2), null, 2) + '</pre>';
                    
                    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                    equipmentList.data.forEach((equipment, index) => {
                        log(`‚öôÔ∏è –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ ${index + 1}: ${equipment.display_name || equipment.name}`, 'info');
                    });
                } else {
                    log('‚ÑπÔ∏è –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ fuel_tank –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'info');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ equipment: ${error.message}`, 'error');
            }
            results.innerHTML += '</div>';

            results.innerHTML += '<div class="step"><h2>–®–ê–ì 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ tanksUnifiedService</h2>';
            try {
                log('üîß –í—ã–∑—ã–≤–∞–µ–º tanksUnifiedService.getTanksForTradingPoint()...', 'info');
                const unifiedResult = await tanksUnifiedService.getTanksForTradingPoint(selectedPointId);
                
                log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç tanksUnifiedService:`, 'info');
                log(`   - –ò—Å—Ç–æ—á–Ω–∏–∫: ${unifiedResult.source}`, 'info');
                log(`   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${unifiedResult.synchronized}`, 'info');
                log(`   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${unifiedResult.tanks.length}`, 'info');
                log(`   - –û—à–∏–±–∫–∞: ${unifiedResult.error || '–ù–ï–¢'}`, unifiedResult.error ? 'error' : 'success');
                
                if (unifiedResult.tanks.length > 0) {
                    log(`<span class="highlight">–≠–¢–û –ò–°–¢–û–ß–ù–ò–ö –î–ê–ù–ù–´–• –ù–ê –°–¢–†–ê–ù–ò–¶–ï!</span>`, 'success');
                    results.innerHTML += '<pre>' + JSON.stringify(unifiedResult.tanks.slice(0, 2), null, 2) + '</pre>';
                    
                    // –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞
                    unifiedResult.tanks.forEach((tank, index) => {
                        log(`üõ¢Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä ${index + 1}: ID=${tank.id}, –ù–∞–∑–≤–∞–Ω–∏–µ=${tank.name}, –¢–æ–ø–ª–∏–≤–æ=${tank.fuelType}`, 'info');
                        log(`   –£—Ä–æ–≤–µ–Ω—å: ${tank.currentLevelLiters}–ª –∏–∑ ${tank.capacityLiters}–ª`, 'info');
                        log(`   –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${tank.temperature}¬∞C, –ü–ª–æ—Ç–Ω–æ—Å—Ç—å: ${tank.density}–∫–≥/–º¬≥`, 'info');
                    });
                } else {
                    log('‚ùå tanksUnifiedService –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç', 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤ tanksUnifiedService: ${error.message}`, 'error');
            }
            results.innerHTML += '</div>';

            results.innerHTML += '<div class="step"><h2>–®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h2>';
            try {
                log('üíæ –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                const keys = Object.keys(localStorage);
                const tankKeys = keys.filter(key => 
                    key.includes('tank') || 
                    key.includes('Tank') || 
                    key.includes('reservoir') ||
                    key.includes('fuel')
                );
                
                if (tankKeys.length > 0) {
                    log(`<span class="highlight">–ù–ê–ô–î–ï–ù–´ –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–´–ï –ö–õ–Æ–ß–ò –í localStorage!</span>`, 'warning');
                    tankKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        log(`   ${key}: ${value ? value.substring(0, 100) + '...' : '–ø—É—Å—Ç–æ'}`, 'warning');
                    });
                } else {
                    log('‚úÖ –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ localStorage –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'success');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ localStorage: ${error.message}`, 'error');
            }
            results.innerHTML += '</div>';

            log('\nüéØ –í–´–í–û–î: –ù–∞–π–¥–µ–Ω —Ç–æ—á–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö!', 'success');
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ª–∞–¥–∫—É
        debugDataSource();
    </script>
</body>
</html>