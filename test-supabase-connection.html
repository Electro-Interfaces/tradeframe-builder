<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Connection</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; overflow-x: auto; }
        .loading { opacity: 0.6; }
    </style>
</head>
<body>
    <h1>üß™ Test Supabase Connection</h1>
    
    <div id="config-info" class="result info">
        <strong>Current Configuration:</strong>
        <div id="config-details">Loading...</div>
    </div>

    <button onclick="testConnection()">üîç Test Connection</button>
    <button onclick="testEquipmentAccess()">üõ†Ô∏è Test Equipment Templates Access</button>
    <button onclick="testWithServiceKey()">üîë Test with Service Key</button>
    <button onclick="testTableStructure()">üìä Test Table Structure</button>

    <div id="results"></div>

    <script>
        const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI';
        
        // Try to get service key from localStorage or prompt
        let supabaseServiceKey = null;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function logPre(title, data, type = 'info') {
            log(`${title}:<pre>${JSON.stringify(data, null, 2)}</pre>`, type);
        }

        async function makeRequest(url, headers = {}, method = 'GET') {
            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...headers
                    }
                });
                
                return {
                    ok: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    data: response.ok ? await response.json() : await response.text()
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    statusText: 'Network Error',
                    error: error.message
                };
            }
        }

        async function testConnection() {
            log('üîç Testing basic Supabase connection...', 'info');
            
            // Test 1: Basic API endpoint
            log('Testing: /rest/v1/', 'info');
            const basicTest = await makeRequest(`${supabaseUrl}/rest/v1/`, {
                'apikey': supabaseAnonKey,
                'Authorization': `Bearer ${supabaseAnonKey}`
            });
            
            if (basicTest.ok) {
                log('‚úÖ Basic API endpoint accessible', 'success');
                logPre('Response', basicTest.data, 'success');
            } else {
                log(`‚ùå Basic API test failed: ${basicTest.status} ${basicTest.statusText}`, 'error');
                if (basicTest.error) log(`Error: ${basicTest.error}`, 'error');
                if (basicTest.data) logPre('Error Details', basicTest.data, 'error');
            }
        }

        async function testEquipmentAccess() {
            log('üõ†Ô∏è Testing equipment_templates access...', 'info');
            
            // Test with anon key
            log('Testing with anon key...', 'info');
            const equipmentTest = await makeRequest(`${supabaseUrl}/rest/v1/equipment_templates?limit=1`, {
                'apikey': supabaseAnonKey,
                'Authorization': `Bearer ${supabaseAnonKey}`
            });
            
            if (equipmentTest.ok) {
                log('‚úÖ Equipment templates accessible with anon key', 'success');
                logPre('Data', equipmentTest.data, 'success');
            } else {
                log(`‚ùå Equipment templates not accessible: ${equipmentTest.status} ${equipmentTest.statusText}`, 'error');
                if (equipmentTest.data) logPre('Error Details', equipmentTest.data, 'error');
                
                // If 401, it might be RLS policy issue
                if (equipmentTest.status === 401) {
                    log('üîç 401 Unauthorized - This is likely a Row Level Security (RLS) policy issue', 'info');
                    log('üí° RLS policies are blocking anonymous access to equipment_templates', 'info');
                }
            }
        }

        async function testWithServiceKey() {
            if (!supabaseServiceKey) {
                supabaseServiceKey = prompt('Enter Supabase Service Role Key (if available):');
                if (!supabaseServiceKey) {
                    log('‚ùå No service key provided', 'error');
                    return;
                }
            }
            
            log('üîë Testing with service key...', 'info');
            
            const serviceTest = await makeRequest(`${supabaseUrl}/rest/v1/equipment_templates?limit=1`, {
                'apikey': supabaseServiceKey,
                'Authorization': `Bearer ${supabaseServiceKey}`
            });
            
            if (serviceTest.ok) {
                log('‚úÖ Equipment templates accessible with service key', 'success');
                logPre('Data', serviceTest.data, 'success');
            } else {
                log(`‚ùå Service key test failed: ${serviceTest.status} ${serviceTest.statusText}`, 'error');
                if (serviceTest.data) logPre('Error Details', serviceTest.data, 'error');
            }
        }

        async function testTableStructure() {
            log('üìä Testing table structure access...', 'info');
            
            // Test information_schema access
            const schemaTest = await makeRequest(
                `${supabaseUrl}/rest/v1/information_schema.tables?table_schema=eq.public&table_name=like.*equipment*`, 
                {
                    'apikey': supabaseAnonKey,
                    'Authorization': `Bearer ${supabaseAnonKey}`
                }
            );
            
            if (schemaTest.ok) {
                log('‚úÖ Schema information accessible', 'success');
                logPre('Tables', schemaTest.data, 'success');
            } else {
                log(`‚ùå Schema access failed: ${schemaTest.status} ${schemaTest.statusText}`, 'error');
                if (schemaTest.data) logPre('Error Details', schemaTest.data, 'error');
            }
        }

        // Initialize page
        window.onload = function() {
            document.getElementById('config-details').innerHTML = `
                <div><strong>URL:</strong> ${supabaseUrl}</div>
                <div><strong>Anon Key:</strong> ${supabaseAnonKey.substr(0, 20)}...</div>
                <div><strong>Service Key:</strong> ${supabaseServiceKey ? 'Available' : 'Not provided'}</div>
            `;
            
            log('üöÄ Supabase Connection Tester initialized', 'info');
            log('Click buttons above to run tests', 'info');
        };
    </script>
</body>
</html>