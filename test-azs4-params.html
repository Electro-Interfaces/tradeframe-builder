<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ê–ó–° 4</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1e1e1e; 
            color: #fff; 
            padding: 20px; 
            line-height: 1.4;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .code { 
            background: #0d1117; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #444;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üîç –ü–†–û–í–ï–†–ö–ê –ü–ê–†–ê–ú–ï–¢–†–û–í –ê–ó–° 4</h1>
    <p>–î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ê–ó–° 4 –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º API</p>
    
    <button onclick="checkAzs4Params()">üöÄ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ê–ó–° 4</button>
    <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
    
    <div id="log"></div>

    <script type="module">
        const TARGET_TP_ID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59'; // –ê–ó–° 4
        const log = document.getElementById('log');
        
        function addLog(message, type = 'normal') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            log.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        window.clearLog = function() {
            log.innerHTML = '';
        }
        
        window.checkAzs4Params = async function() {
            addLog('üîç –ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ê–ó–° 4', 'info');
            addLog(`<div class="code">Target Trading Point ID: ${TARGET_TP_ID}</div>`, 'info');
            
            try {
                // –ò–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤
                addLog('üì¶ –ò–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤...', 'info');
                const { tradingPointsService } = await import('./src/services/tradingPointsService.js');
                const { networksService } = await import('./src/services/networksService.js');
                const { tradingNetworkConfigService } = await import('./src/services/tradingNetworkConfigService.js');
                addLog('‚úÖ –°–µ—Ä–≤–∏—Å—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                
                // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
                addLog('üè™ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ê–ó–° 4...', 'info');
                const tradingPoint = await tradingPointsService.getById(TARGET_TP_ID);
                
                if (!tradingPoint) {
                    addLog('‚ùå –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –ê–ó–° 4 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', 'error');
                    return;
                }
                
                addLog('‚úÖ –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞', 'success');
                addLog(`<div class="code">
                    ID: ${tradingPoint.id}<br>
                    –ù–∞–∑–≤–∞–Ω–∏–µ: ${tradingPoint.name}<br>
                    External ID: ${tradingPoint.external_id || '‚ùå –ù–ï–¢'}<br>
                    Code: ${tradingPoint.code || '‚ùå –ù–ï–¢'}<br>
                    Network ID: ${tradingPoint.networkId || '‚ùå –ù–ï–¢'}<br>
                    –°—Ç–∞—Ç—É—Å: ${tradingPoint.status || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}
                </div>`, 'info');
                
                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Station ID
                const stationId = tradingPoint.external_id || tradingPoint.code || '';
                addLog(`üìã Station ID (–¥–ª—è API): "${stationId}"`, stationId ? 'success' : 'error');
                
                if (!stationId) {
                    addLog('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –£ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –Ω–µ—Ç external_id –∏–ª–∏ code!', 'error');
                    addLog('üí° –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤—å—Ç–µ external_id –≤ —Ç–∞–±–ª–∏—Ü—É trading_points –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏', 'warning');
                }
                
                // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ç–∏
                if (!tradingPoint.networkId) {
                    addLog('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –£ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –Ω–µ—Ç networkId!', 'error');
                    return;
                }
                
                addLog('üåê –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ç–∏...', 'info');
                const network = await networksService.getById(tradingPoint.networkId);
                
                if (!network) {
                    addLog('‚ùå –°–µ—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', 'error');
                    return;
                }
                
                addLog('‚úÖ –°–µ—Ç—å –Ω–∞–π–¥–µ–Ω–∞', 'success');
                addLog(`<div class="code">
                    ID: ${network.id}<br>
                    –ù–∞–∑–≤–∞–Ω–∏–µ: ${network.name}<br>
                    External ID: ${network.external_id || '‚ùå –ù–ï–¢'}<br>
                    Code: ${network.code || '‚ùå –ù–ï–¢'}<br>
                    –°—Ç–∞—Ç—É—Å: ${network.status || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}
                </div>`, 'info');
                
                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ System ID
                const systemId = network.external_id || network.code || '';
                addLog(`üìã System ID (–¥–ª—è API): "${systemId}"`, systemId ? 'success' : 'error');
                
                if (!systemId) {
                    addLog('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –£ —Å–µ—Ç–∏ –Ω–µ—Ç external_id –∏–ª–∏ code!', 'error');
                    addLog('üí° –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤—å—Ç–µ external_id –≤ —Ç–∞–±–ª–∏—Ü—É networks –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏', 'warning');
                }
                
                // –¢–µ—Å—Ç API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ tradingNetworkConfigService
                addLog('üîß –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å...', 'info');
                try {
                    const apiParams = await tradingNetworkConfigService.getApiParamsFromDB(TARGET_TP_ID);
                    
                    if (apiParams) {
                        addLog('‚úÖ API –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å', 'success');
                        addLog(`<div class="code">
                            System ID: "${apiParams.systemId}"<br>
                            Station ID: "${apiParams.stationId}"<br>
                            –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–º: ${apiParams.systemId === systemId && apiParams.stationId === stationId ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}
                        </div>`, 'success');
                    } else {
                        addLog('‚ùå API –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ù–ï –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å', 'error');
                    }
                } catch (error) {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: ${error.message}`, 'error');
                }
                
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                addLog('üéØ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê –ì–û–¢–û–í–ù–û–°–¢–ò:', 'info');
                const readyForApi = !!(systemId && stationId);
                
                addLog(`<div class="code">
                    System ID –≥–æ—Ç–æ–≤: ${systemId ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}<br>
                    Station ID –≥–æ—Ç–æ–≤: ${stationId ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}<br>
                    –ì–æ—Ç–æ–≤ –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤: ${readyForApi ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}<br>
                    –û–∂–∏–¥–∞–µ–º—ã–π URL: https://pos.autooplata.ru/tms/tanks?system=${systemId}&station=${stationId}
                </div>`, readyForApi ? 'success' : 'error');
                
                if (readyForApi) {
                    addLog('üéâ –ê–ó–° 4 –≥–æ—Ç–æ–≤–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º API!', 'success');
                    addLog('üí° –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã" –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'success');
                } else {
                    addLog('‚ö†Ô∏è –ê–ó–° 4 –ù–ï –≥–æ—Ç–æ–≤–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º API', 'warning');
                    addLog('üîß –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å external_id –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î', 'warning');
                }
                
                // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é
                if (!systemId) {
                    addLog('üìù SQL –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ç–∏:', 'warning');
                    addLog(`<div class="code">UPDATE networks SET external_id = '15' WHERE id = '${network.id}';</div>`, 'warning');
                }
                
                if (!stationId) {
                    addLog('üìù SQL –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏:', 'warning');
                    addLog(`<div class="code">UPDATE trading_points SET external_id = '4' WHERE id = '${TARGET_TP_ID}';</div>`, 'warning');
                }
                
            } catch (error) {
                addLog(`üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
                addLog(`<div class="code">${error.stack}</div>`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        addLog('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ê–ó–° 4" –¥–ª—è –Ω–∞—á–∞–ª–∞.', 'info');
    </script>
</body>
</html>