<!DOCTYPE html>
<html>
<head>
    <title>Test Page Help Database</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .success { background: #e8f5e8; }
        .error { background: #fde8e8; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; max-height: 300px; }
    </style>
</head>
<body>
    <h1>🧪 Test Page Help Database Direct</h1>
    <div id="results"></div>

    <script type="module">
        const results = document.getElementById('results');
        
        function addResult(title, success, data) {
            const div = document.createElement('div');
            div.className = `test ${success ? 'success' : 'error'}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        // Import Supabase client
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

        const supabase = createClient(supabaseUrl, serviceRoleKey);

        async function testDatabaseConnection() {
            try {
                addResult('🔧 Testing Supabase Connection', true, 'Connecting to Supabase...');
                
                // Test basic connection
                const { data, error } = await supabase
                    .from('networks')
                    .select('count')
                    .limit(1);

                if (error) {
                    addResult('❌ Database Connection Failed', false, error);
                } else {
                    addResult('✅ Database Connection Success', true, 'Connected to Supabase successfully');
                }
            } catch (error) {
                addResult('❌ Connection Error', false, error.message);
            }
        }

        async function testPageHelpTable() {
            try {
                addResult('📋 Testing page_help table', true, 'Checking if table exists...');
                
                const { data, error } = await supabase
                    .from('page_help')
                    .select('*')
                    .limit(5);

                if (error) {
                    addResult('❌ Page Help Table Error', false, error);
                } else {
                    addResult('✅ Page Help Table Success', true, {
                        message: 'Table exists and accessible',
                        recordCount: data.length,
                        sampleRecords: data
                    });
                }
            } catch (error) {
                addResult('❌ Page Help Table Error', false, error.message);
            }
        }

        async function testInstructionsService() {
            try {
                addResult('🔧 Testing InstructionsService Methods', true, 'Testing service methods...');
                
                // Test getTopics equivalent
                const { data: topicsData, error: topicsError } = await supabase
                    .from('page_help')
                    .select('*')
                    .is('deleted_at', null)
                    .eq('is_active', true)
                    .order('route');

                if (topicsError) {
                    addResult('❌ Get Topics Test Failed', false, topicsError);
                } else {
                    // Group by route and get latest version
                    const topicsMap = new Map();
                    topicsData.forEach(record => {
                        const existing = topicsMap.get(record.route);
                        if (!existing || record.version > existing.version) {
                            topicsMap.set(record.route, record);
                        }
                    });
                    
                    const topics = Array.from(topicsMap.values()).map(record => ({
                        id: record.id,
                        key: record.route.replace(/^\//, '').replace(/\//g, '-'),
                        route: record.route,
                        title: record.title,
                        description: record.content.substring(0, 100) + '...',
                        is_active: record.is_active,
                        views_total: 0,
                        created_at: record.created_at,
                        updated_at: record.updated_at
                    }));

                    addResult('✅ Get Topics Test Success', true, {
                        message: 'Topics retrieved successfully',
                        topicsCount: topics.length,
                        topics: topics
                    });
                }

                // Test getInstructionForUser equivalent
                const { data: instructionData, error: instructionError } = await supabase
                    .from('page_help')
                    .select('*')
                    .eq('route', '/dashboard')
                    .eq('status', 'published')
                    .is('deleted_at', null)
                    .eq('is_active', true)
                    .order('version', { ascending: false })
                    .limit(1);

                if (instructionError) {
                    addResult('❌ Get Instruction Test Failed', false, instructionError);
                } else if (instructionData && instructionData.length > 0) {
                    const record = instructionData[0];
                    addResult('✅ Get Instruction Test Success', true, {
                        message: 'Instruction found for /dashboard',
                        instruction: {
                            id: record.id,
                            route: record.route,
                            title: record.title,
                            content_preview: record.content.substring(0, 200) + '...',
                            status: record.status,
                            version: record.version
                        }
                    });
                } else {
                    addResult('⚠️ Get Instruction Test - No Data', false, 'No published instruction found for /dashboard');
                }

            } catch (error) {
                addResult('❌ InstructionsService Test Error', false, error.message);
            }
        }

        async function testStats() {
            try {
                const { data, error } = await supabase
                    .from('page_help')
                    .select('route, status, is_active')
                    .is('deleted_at', null);

                if (error) {
                    addResult('❌ Stats Test Failed', false, error);
                } else {
                    const topics = new Set();
                    let activeTopics = 0;
                    let publishedVersions = 0;

                    data.forEach(record => {
                        topics.add(record.route);
                        if (record.is_active) activeTopics++;
                        if (record.status === 'published') publishedVersions++;
                    });

                    addResult('✅ Stats Test Success', true, {
                        total_topics: topics.size,
                        total_versions: data.length,
                        active_topics: activeTopics,
                        published_versions: publishedVersions
                    });
                }
            } catch (error) {
                addResult('❌ Stats Test Error', false, error.message);
            }
        }

        // Run all tests
        async function runTests() {
            addResult('🚀 Starting Database Tests', true, 'Testing page_help table and InstructionsService compatibility');
            
            await testDatabaseConnection();
            await testPageHelpTable();
            await testInstructionsService();
            await testStats();
            
            addResult('🎉 Tests Complete', true, 'All database tests finished');
        }

        runTests();
    </script>
</body>
</html>