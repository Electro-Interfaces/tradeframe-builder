<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>PWA –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ TradeFrame</title>
  
  <!-- –ü–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; media-src 'self'; object-src 'none'; frame-src 'none';" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="DENY" />
  
  <!-- PWA –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <meta name="theme-color" content="#1e293b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/tradeframe-builder/manifest.json">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e293b;
      color: white;
      padding: 20px;
      margin: 0;
      line-height: 1.6;
    }
    
    .test-section {
      background: rgba(255, 255, 255, 0.1);
      margin: 20px 0;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    
    .success { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .warning { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    
    .info {
      font-family: monospace;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 5px;
      white-space: pre-wrap;
      font-size: 12px;
    }
    
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    
    button:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <h1>üîç PWA –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ TradeFrame</h1>
  
  <div class="test-section">
    <h2>üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ</h2>
    <div id="browser-info" class="info"></div>
  </div>
  
  <div class="test-section">
    <h2>üõ°Ô∏è Service Worker</h2>
    <div id="sw-status"></div>
    <button onclick="testServiceWorker()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SW</button>
    <button onclick="unregisterSW()">–£–¥–∞–ª–∏—Ç—å SW</button>
    <div id="sw-info" class="info"></div>
  </div>
  
  <div class="test-section">
    <h2>üìã PWA Manifest</h2>
    <div id="manifest-status"></div>
    <button onclick="testManifest()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Manifest</button>
    <div id="manifest-info" class="info"></div>
  </div>
  
  <div class="test-section">
    <h2>üíæ –ö—ç—à –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</h2>
    <div id="storage-status"></div>
    <button onclick="testStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Storage</button>
    <button onclick="clearAllStorage()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    <div id="storage-info" class="info"></div>
  </div>
  
  <div class="test-section">
    <h2>üåê –°–µ—Ç—å –∏ HTTPS</h2>
    <div id="network-status"></div>
    <button onclick="testNetwork()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç—å</button>
    <div id="network-info" class="info"></div>
  </div>

  <script>
    function addStatus(containerId, message, type = 'info') {
      const container = document.getElementById(containerId);
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.textContent = message;
      container.appendChild(div);
    }

    function updateInfo(containerId, info) {
      document.getElementById(containerId).textContent = info;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–∞—É–∑–µ—Ä–µ
    function initBrowserInfo() {
      const info = {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        cookiesEnabled: navigator.cookieEnabled,
        onLine: navigator.onLine,
        viewport: `${window.innerWidth}x${window.innerHeight}`,
        screen: `${window.screen.width}x${window.screen.height}`,
        devicePixelRatio: window.devicePixelRatio,
        location: window.location.href,
        protocol: window.location.protocol,
        isSecure: window.location.protocol === 'https:' || window.location.hostname === 'localhost',
        standalone: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone
      };
      
      updateInfo('browser-info', JSON.stringify(info, null, 2));
    }

    // –¢–µ—Å—Ç Service Worker
    function testServiceWorker() {
      document.getElementById('sw-status').innerHTML = '';
      
      if (!('serviceWorker' in navigator)) {
        addStatus('sw-status', '‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
        return;
      }

      addStatus('sw-status', '‚úÖ Service Worker –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
      
      navigator.serviceWorker.getRegistrations()
        .then(registrations => {
          let swInfo = `–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö SW: ${registrations.length}\n\n`;
          
          registrations.forEach((reg, index) => {
            swInfo += `SW ${index + 1}:\n`;
            swInfo += `  Scope: ${reg.scope}\n`;
            swInfo += `  State: ${reg.active?.state || 'none'}\n`;
            swInfo += `  Script URL: ${reg.active?.scriptURL || 'none'}\n\n`;
          });
          
          updateInfo('sw-info', swInfo);
          
          if (registrations.length > 0) {
            addStatus('sw-status', `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${registrations.length} Service Worker(s)`, 'success');
          } else {
            addStatus('sw-status', '‚ö†Ô∏è Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'warning');
          }
        })
        .catch(error => {
          addStatus('sw-status', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ SW: ${error.message}`, 'error');
          updateInfo('sw-info', error.stack);
        });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ Service Worker
    function unregisterSW() {
      navigator.serviceWorker.getRegistrations()
        .then(registrations => {
          Promise.all(registrations.map(reg => reg.unregister()))
            .then(() => {
              addStatus('sw-status', '‚úÖ –í—Å–µ Service Workers —É–¥–∞–ª–µ–Ω—ã', 'success');
              updateInfo('sw-info', 'Service Workers —É–¥–∞–ª–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            });
        });
    }

    // –¢–µ—Å—Ç Manifest
    function testManifest() {
      document.getElementById('manifest-status').innerHTML = '';
      
      fetch('/tradeframe-builder/manifest.json')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(manifest => {
          addStatus('manifest-status', '‚úÖ Manifest –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
          updateInfo('manifest-info', JSON.stringify(manifest, null, 2));
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
          if (manifest.name && manifest.short_name) {
            addStatus('manifest-status', '‚úÖ –ò–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω–æ', 'success');
          }
          if (manifest.icons && manifest.icons.length > 0) {
            addStatus('manifest-status', `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${manifest.icons.length} –∏–∫–æ–Ω–æ–∫`, 'success');
          }
          if (manifest.start_url) {
            addStatus('manifest-status', '‚úÖ Start URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω', 'success');
          }
        })
        .catch(error => {
          addStatus('manifest-status', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ manifest: ${error.message}`, 'error');
          updateInfo('manifest-info', error.stack);
        });
    }

    // –¢–µ—Å—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    function testStorage() {
      document.getElementById('storage-status').innerHTML = '';
      
      let storageInfo = '';
      
      // localStorage
      try {
        const testKey = '__test_storage__';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        addStatus('storage-status', '‚úÖ localStorage –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
        storageInfo += `localStorage: ${Object.keys(localStorage).length} –∫–ª—é—á–µ–π\n`;
      } catch (e) {
        addStatus('storage-status', '‚ùå localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
      }

      // sessionStorage
      try {
        const testKey = '__test_session__';
        sessionStorage.setItem(testKey, 'test');
        sessionStorage.removeItem(testKey);
        addStatus('storage-status', '‚úÖ sessionStorage –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
        storageInfo += `sessionStorage: ${Object.keys(sessionStorage).length} –∫–ª—é—á–µ–π\n`;
      } catch (e) {
        addStatus('storage-status', '‚ùå sessionStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
      }

      // Cache API
      if ('caches' in window) {
        caches.keys().then(cacheNames => {
          addStatus('storage-status', '‚úÖ Cache API –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
          storageInfo += `Caches: ${cacheNames.length} (${cacheNames.join(', ')})\n`;
          updateInfo('storage-info', storageInfo);
        });
      } else {
        addStatus('storage-status', '‚ùå Cache API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
        updateInfo('storage-info', storageInfo);
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    function clearAllStorage() {
      localStorage.clear();
      sessionStorage.clear();
      
      if ('caches' in window) {
        caches.keys().then(cacheNames => {
          return Promise.all(cacheNames.map(name => caches.delete(name)));
        }).then(() => {
          addStatus('storage-status', '‚úÖ –í—Å—ë —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—á–∏—â–µ–Ω–æ', 'success');
        });
      }
    }

    // –¢–µ—Å—Ç —Å–µ—Ç–∏
    function testNetwork() {
      document.getElementById('network-status').innerHTML = '';
      
      const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
      
      if (isSecure) {
        addStatus('network-status', '‚úÖ Secure context (HTTPS)', 'success');
      } else {
        addStatus('network-status', '‚ùå –ù–µ secure context (HTTP)', 'error');
      }
      
      if (navigator.onLine) {
        addStatus('network-status', '‚úÖ –ë—Ä–∞—É–∑–µ—Ä –≤ —Å–µ—Ç–∏', 'success');
      } else {
        addStatus('network-status', '‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –≤ offline —Ä–µ–∂–∏–º–µ', 'warning');
      }
      
      // –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
      const testUrls = [
        '/tradeframe-builder/',
        '/tradeframe-builder/manifest.json',
        '/tradeframe-builder/sw.js'
      ];
      
      Promise.all(testUrls.map(url => 
        fetch(url, { method: 'HEAD' })
          .then(response => ({ url, status: response.status, ok: response.ok }))
          .catch(error => ({ url, status: 'ERROR', error: error.message }))
      )).then(results => {
        let networkInfo = '–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤:\n\n';
        results.forEach(result => {
          networkInfo += `${result.url}: ${result.status}${result.ok ? ' ‚úÖ' : ' ‚ùå'}\n`;
          if (result.error) networkInfo += `  Error: ${result.error}\n`;
        });
        updateInfo('network-info', networkInfo);
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
      initBrowserInfo();
      testServiceWorker();
      testManifest();
      testStorage();
      testNetwork();
    });
  </script>
</body>
</html>