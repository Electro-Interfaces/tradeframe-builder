<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fixed 422 Error</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .error { background: #f44336; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { background: #2196F3; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #4CAF50; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .danger { background: #f44336; }
        pre {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Fixed 422 Error</h1>
        
        <div class="info">
            <strong>–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏–ª–∏:</strong><br>
            1. ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ stsApi.ts<br>
            2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ networkId –∏ tradingPointId - —á–∏—Å–ª–∞<br>
            3. ‚úÖ –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö 422<br>
            4. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è external_id —Å–µ—Ç–∏ –≤ Tanks.tsx<br>
            5. ‚úÖ –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="testTanksPageWithMonitoring()">‚õΩ –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º</button>
            <button onclick="openDebugTools()">üîß –û—Ç–∫—Ä—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç–ª–∞–¥–∫–∏</button>
            <button onclick="testDirectAPI()">üß™ –¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ API</button>
            <button onclick="clearLogs()" class="danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let logs = [];
        let testWindow = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({
                time: timestamp,
                message: message,
                type: type
            });
            updateDisplay();
            console.log(`[${timestamp}] ${message}`);
        }

        function updateDisplay() {
            const resultsDiv = document.getElementById('results');
            
            let html = '';
            
            if (logs.length > 0) {
                html += '<h2>üìù –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h2>';
                logs.slice(-15).forEach(logEntry => {
                    const className = logEntry.type === 'error' ? 'error' : logEntry.type === 'success' ? 'success' : 'info';
                    html += `<div class="${className}">
                        <strong>[${logEntry.time}]</strong> ${logEntry.message}
                    </div>`;
                });
            }
            
            resultsDiv.innerHTML = html;
        }

        function testTanksPageWithMonitoring() {
            log('üîÑ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π...', 'info');
            
            if (testWindow && !testWindow.closed) {
                testWindow.close();
            }
            
            testWindow = window.open('http://localhost:3004/point/tanks', 'tanksTest', 'width=1400,height=900');
            
            log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –æ—Ç–∫—Ä—ã—Ç–∞. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –∫–æ–Ω—Å–æ–ª—å—é –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è!', 'success');
            log('üìã –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:', 'info');
            log('1. –í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏ –≤–∏–¥–∞ "üîç –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤" —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π', 'info');
            log('2. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ 422 - —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ', 'info');
            log('3. –ï—Å–ª–∏ external_id —Å–µ—Ç–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —è—Å–Ω–∞—è –æ—à–∏–±–∫–∞', 'info');
            log('4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ API" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤', 'info');
            
            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –æ–∫–Ω–æ
            const checkInterval = setInterval(() => {
                if (testWindow.closed) {
                    clearInterval(checkInterval);
                    log('üîÑ –û–∫–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–æ', 'info');
                }
            }, 1000);
            
            // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã
            setTimeout(() => {
                if (testWindow && !testWindow.closed) {
                    testWindow.close();
                    log('üîÑ –û–∫–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã', 'info');
                }
                clearInterval(checkInterval);
            }, 120000);
        }

        function openDebugTools() {
            log('üîß –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç–ª–∞–¥–∫–∏...', 'info');
            
            window.open('debug-sts-422.html', '_blank', 'width=1200,height=800');
            window.open('debug-selection-context.html', '_blank', 'width=800,height=600');
            
            log('‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç–ª–∞–¥–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã –≤ –Ω–æ–≤—ã—Ö –≤–∫–ª–∞–¥–∫–∞—Ö', 'success');
        }

        async function testDirectAPI() {
            log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ API...', 'info');
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ localStorage
                const configStr = localStorage.getItem('sts-api-config');
                if (!configStr) {
                    log('‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è STS API –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage', 'error');
                    log('üí° –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API –≤ —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ -> API CTC"', 'info');
                    return;
                }
                
                const config = JSON.parse(configStr);
                
                if (!config.enabled) {
                    log('‚ö†Ô∏è STS API –æ—Ç–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'error');
                    return;
                }
                
                if (!config.token) {
                    log('‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è API', 'error');
                    log('üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö API', 'info');
                    return;
                }
                
                log(`üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ ${config.url}/v1/tanks...`, 'info');
                
                // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                const testUrl = new URL(`${config.url}/v1/tanks`);
                testUrl.searchParams.set('system', '1'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                testUrl.searchParams.set('station', '1'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                
                log(`üì° URL –∑–∞–ø—Ä–æ—Å–∞: ${testUrl.toString()}`, 'info');
                
                const response = await fetch(testUrl.toString(), {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${config.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log(`‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã! –†–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${Array.isArray(data) ? data.length : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`, 'success');
                        log(`<pre>${JSON.stringify(data, null, 2).substring(0, 1000)}${responseText.length > 1000 ? '\n...(–æ–±—Ä–µ–∑–∞–Ω–æ)' : ''}</pre>`, 'info');
                    } catch (e) {
                        log(`‚úÖ –ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, –Ω–æ –æ—Ç–≤–µ—Ç –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:`, 'success');
                        log(`<pre>${responseText.substring(0, 500)}</pre>`, 'info');
                    }
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ API:`, 'error');
                    log(`<pre>${responseText}</pre>`, 'error');
                    
                    if (response.status === 422) {
                        try {
                            const errorData = JSON.parse(responseText);
                            log(`üîç –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ 422:`, 'error');
                            if (errorData.detail) {
                                errorData.detail.forEach((detail, index) => {
                                    log(`${index + 1}. –ü–æ–ª–µ: ${detail.loc?.join('.')} | –¢–∏–ø: ${detail.type} | –°–æ–æ–±—â–µ–Ω–∏–µ: ${detail.msg}`, 'error');
                                });
                            }
                        } catch (e) {
                            log(`–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ 422`, 'error');
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            logs.length = 0;
            updateDisplay();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            log('üöÄ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
            log('üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: —É–ª—É—á—à–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö', 'info');
        };
    </script>
</body>
</html>