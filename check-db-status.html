<!DOCTYPE html>
<html>
<head>
    <title>Database Connection Status</title>
    <style>
        body { 
            font-family: Arial; 
            background: #1a1a1a; 
            color: #fff; 
            padding: 20px; 
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid; 
        }
        .success { 
            background: #2d5a2d; 
            border-color: #4a9a4a; 
        }
        .error { 
            background: #5a2d2d; 
            border-color: #9a4a4a; 
        }
        .warning { 
            background: #5a5a2d; 
            border-color: #9a9a4a; 
        }
        .info { 
            background: #2d2d5a; 
            border-color: #4a4a9a; 
        }
        button {
            background: #4a9a4a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #5aaa5a; }
        pre { 
            background: #2a2a2a; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto; 
            white-space: pre-wrap; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π</h1>
        
        <div class="status info">
            <h3>üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</h3>
            <div id="status-info">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
        </div>
        
        <div>
            <button onclick="checkAll()">üîÑ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
            <button onclick="testConnection()">üåê –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
            <button onclick="loadRoles()">üë• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–æ–ª–∏</button>
            <button onclick="openSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function checkStorageSettings() {
            const settings = localStorage.getItem('externalDatabase');
            if (!settings) {
                log('‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–π –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage', 'error');
                return null;
            }
            
            try {
                const parsed = JSON.parse(settings);
                if (!parsed.url || !parsed.apiKey) {
                    log('‚ùå –ù–µ–ø–æ–ª–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç URL –∏–ª–∏ API –∫–ª—é—á', 'error');
                    return null;
                }
                
                log(`‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–π–¥–µ–Ω—ã: URL ${parsed.url}`, 'success');
                return parsed;
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${error.message}`, 'error');
                return null;
            }
        }

        async function testConnection() {
            document.getElementById('results').innerHTML = '';
            
            const config = checkStorageSettings();
            if (!config) return;
            
            log('üåê –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...', 'warning');
            
            try {
                const response = await fetch(`${config.url}/rest/v1/`, {
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': `Bearer ${config.apiKey}`
                    }
                });
                
                if (response.ok) {
                    log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –°—Ç–∞—Ç—É—Å: ${response.status}`, 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ roles
                    const rolesResponse = await fetch(`${config.url}/rest/v1/roles?limit=1`, {
                        headers: {
                            'apikey': config.apiKey,
                            'Authorization': `Bearer ${config.apiKey}`
                        }
                    });
                    
                    if (rolesResponse.ok) {
                        log('‚úÖ –î–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ roles –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω', 'success');
                    } else {
                        log(`‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ roles: ${rolesResponse.status}`, 'error');
                    }
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }

        async function loadRoles() {
            const config = checkStorageSettings();
            if (!config) return;
            
            log('üë• –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª–∏ –∏–∑ –ë–î...', 'warning');
            
            try {
                const response = await fetch(`${config.url}/rest/v1/roles?deleted_at=is.null&order=created_at.desc`, {
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const roles = await response.json();
                    log(`‚úÖ –†–æ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${roles.length} —à—Ç.`, 'success');
                    
                    if (roles.length > 0) {
                        const pre = document.createElement('pre');
                        pre.textContent = JSON.stringify(roles, null, 2);
                        document.getElementById('results').appendChild(pre);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
                        const firstRole = roles[0];
                        const hasRequiredFields = firstRole.id && firstRole.code && firstRole.name;
                        if (hasRequiredFields) {
                            log('‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞', 'success');
                        } else {
                            log('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–æ–ª–∏', 'warning');
                        }
                    } else {
                        log('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ —Ä–æ–ª–µ–π –ø—É—Å—Ç–∞', 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–ª–µ–π: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function checkAll() {
            document.getElementById('results').innerHTML = '';
            log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...', 'info');
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const config = checkStorageSettings();
            if (!config) return;
            
            // 2. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ  
            await testConnection();
            
            // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª–∏
            await loadRoles();
            
            log('‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
        }

        function openSettings() {
            window.open('http://localhost:3001/settings/external-database', '_blank');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            const config = checkStorageSettings();
            const statusDiv = document.getElementById('status-info');
            
            if (config) {
                statusDiv.innerHTML = `
                    <div>‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–π–¥–µ–Ω—ã</div>
                    <div>URL: ${config.url}</div>
                    <div>API –∫–ª—é—á: ${config.apiKey.substring(0, 20)}...</div>
                `;
            } else {
                statusDiv.innerHTML = '‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã';
            }
        };
    </script>
</body>
</html>