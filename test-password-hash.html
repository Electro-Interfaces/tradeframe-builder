<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Password Hash</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Тестирование хеширования паролей</h1>

    <div>
        <h3>Данные пользователя L@me.com:</h3>
        <p><strong>Salt:</strong> 1Eu4HEM8j9PDpm/tv27WtA==</p>
        <p><strong>Hash:</strong> kWPBsWlIu1wO8rkKnt+XXrXaldfRa5dCQCJpjFAuL5M=</p>
    </div>

    <div>
        <h3>Тестируем пароли:</h3>
        <input type="text" id="password" placeholder="Пароль для проверки" value="qwerty">
        <button onclick="testPassword()">Проверить</button>
    </div>

    <div>
        <h3>Популярные пароли:</h3>
        <button onclick="testCommonPasswords()">Тестировать популярные пароли</button>
    </div>

    <div id="results"></div>

    <script>
        const userData = {
            email: 'L@me.com',
            pwd_salt: '1Eu4HEM8j9PDpm/tv27WtA==',
            pwd_hash: 'kWPBsWlIu1wO8rkKnt+XXrXaldfRa5dCQCJpjFAuL5M='
        };

        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        async function hashPassword(password, salt) {
            try {
                const encoder = new TextEncoder();
                const passwordBytes = encoder.encode(password);
                const saltBytes = base64ToArrayBuffer(salt);

                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    passwordBytes,
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits']
                );

                const hashBuffer = await crypto.subtle.deriveBits(
                    {
                        name: 'PBKDF2',
                        salt: saltBytes,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    32 * 8
                );

                return arrayBufferToBase64(hashBuffer);
            } catch (error) {
                return `ERROR: ${error.message}`;
            }
        }

        function fallbackHash(password, salt) {
            try {
                const passwordWithSalt = password + salt;
                return btoa(passwordWithSalt);
            } catch (error) {
                return `ERROR: ${error.message}`;
            }
        }

        function addResult(password, pbkdf2Hash, fallbackHashResult, match) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${match ? 'success' : 'error'}`;
            div.innerHTML = `
                <h4>Пароль: "${password}" ${match ? '✅ СОВПАДЕНИЕ!' : '❌ Не совпадает'}</h4>
                <p><strong>PBKDF2 Hash:</strong> ${pbkdf2Hash}</p>
                <p><strong>Fallback Hash:</strong> ${fallbackHashResult}</p>
                <p><strong>Ожидаемый Hash:</strong> ${userData.pwd_hash}</p>
                <p><strong>PBKDF2 Match:</strong> ${pbkdf2Hash === userData.pwd_hash ? '✅' : '❌'}</p>
                <p><strong>Fallback Match:</strong> ${fallbackHashResult === userData.pwd_hash ? '✅' : '❌'}</p>
            `;
            results.appendChild(div);
        }

        async function testPassword() {
            const password = document.getElementById('password').value;
            if (!password) return;

            const pbkdf2Hash = await hashPassword(password, userData.pwd_salt);
            const fallbackHashResult = fallbackHash(password, userData.pwd_salt);

            const match = pbkdf2Hash === userData.pwd_hash || fallbackHashResult === userData.pwd_hash;
            addResult(password, pbkdf2Hash, fallbackHashResult, match);
        }

        async function testCommonPasswords() {
            const commonPasswords = [
                'qwerty', 'password', '123456', '12345', 'admin',
                'test', 'user', 'demo', 'pass', '1234',
                'password123', 'qwerty123', 'admin123',
                'Qwerty', 'Password', 'Test', 'Demo'
            ];

            document.getElementById('results').innerHTML = '<h3>Результаты тестирования:</h3>';

            for (const password of commonPasswords) {
                const pbkdf2Hash = await hashPassword(password, userData.pwd_salt);
                const fallbackHashResult = fallbackHash(password, userData.pwd_salt);

                const match = pbkdf2Hash === userData.pwd_hash || fallbackHashResult === userData.pwd_hash;
                addResult(password, pbkdf2Hash, fallbackHashResult, match);

                if (match) {
                    alert(`НАЙДЕН ПАРОЛЬ: "${password}"`);
                    break;
                }
            }
        }

        // Проверим доступность crypto API
        window.addEventListener('load', () => {
            const cryptoStatus = document.createElement('div');
            cryptoStatus.innerHTML = `
                <h3>Статус Crypto API:</h3>
                <p>Protocol: ${window.location.protocol}</p>
                <p>isSecure: ${window.isSecureContext}</p>
                <p>crypto available: ${!!crypto}</p>
                <p>crypto.subtle available: ${!!(crypto && crypto.subtle)}</p>
            `;
            document.body.insertBefore(cryptoStatus, document.getElementById('results'));
        });
    </script>
</body>
</html>