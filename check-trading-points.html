<!DOCTYPE html>
<html>
<head>
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <h1 class="text-xl font-bold mb-4">üìç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫</h1>
    
    <button onclick="checkTradingPoints()" class="bg-blue-600 px-4 py-2 rounded mb-4">–ù–∞–π—Ç–∏ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏</button>
    <div id="results" class="mt-4 space-y-2"></div>

    <script>
        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';
        
        const PROBLEM_TP_ID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';

        async function checkTradingPoints() {
            const results = document.getElementById('results');
            results.innerHTML = '';
            
            function log(message, type = 'info') {
                const div = document.createElement('div');
                div.className = type === 'error' ? 'text-red-400 bg-red-900 p-3 rounded' : 
                                 type === 'success' ? 'text-green-400 bg-green-900 p-3 rounded' : 
                                 type === 'warning' ? 'text-yellow-400 bg-yellow-900 p-3 rounded' : 
                                 'text-blue-400 bg-blue-900 p-3 rounded';
                div.innerHTML = message;
                results.appendChild(div);
            }
            
            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏
                log('üìç –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏...');
                
                const url = `${SUPABASE_URL}/rest/v1/trading_points?limit=20`;
                const response = await fetch(url, {
                    headers: {
                        'apikey': SERVICE_ROLE_KEY,
                        'Authorization': `Bearer ${SERVICE_ROLE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const tradingPoints = await response.json();
                log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${tradingPoints.length}`, 'success');
                
                if (tradingPoints.length === 0) {
                    log('‚ùå –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫!', 'error');
                    return;
                }
                
                // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏
                log('<br><strong>üìã –í—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏:</strong>', 'info');
                tradingPoints.forEach((tp, i) => {
                    const isTarget = tp.id === PROBLEM_TP_ID;
                    const highlight = isTarget ? 'style="background-color: #dc2626; font-weight: bold;"' : '';
                    log(`<div ${highlight}>  ${i+1}. ${tp.name} <br>     ID: ${tp.id} <br>     –°–µ—Ç—å: ${tp.network_id}</div>`);
                });
                
                // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—É—é —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É
                const problemTP = tradingPoints.find(tp => tp.id === PROBLEM_TP_ID);
                
                if (problemTP) {
                    log(`<br>‚úÖ –ü—Ä–æ–±–ª–µ–º–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –ù–ê–ô–î–ï–ù–ê: <strong>${problemTP.name}</strong>`, 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
                    await checkEquipmentForTP(problemTP);
                } else {
                    log(`<br>‚ùå –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ —Å ID ${PROBLEM_TP_ID} –ù–ï –ù–ê–ô–î–ï–ù–ê –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!`, 'error');
                    log('üí° –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã - –Ω—É–∂–Ω–∞ –¥—Ä—É–≥–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        async function checkEquipmentForTP(tp) {
            function log(message, type = 'info') {
                const results = document.getElementById('results');
                const div = document.createElement('div');
                div.className = type === 'error' ? 'text-red-400 bg-red-900 p-3 rounded' : 
                                 type === 'success' ? 'text-green-400 bg-green-900 p-3 rounded' : 
                                 type === 'warning' ?  'text-yellow-400 bg-yellow-900 p-3 rounded' : 
                                 'text-blue-400 bg-blue-900 p-3 rounded';
                div.innerHTML = message;
                results.appendChild(div);
            }
            
            try {
                log(`<br>üõ†Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è "${tp.name}"...`);
                
                const url = `${SUPABASE_URL}/rest/v1/equipment?trading_point_id=eq.${tp.id}`;
                const response = await fetch(url, {
                    headers: {
                        'apikey': SERVICE_ROLE_KEY,
                        'Authorization': `Bearer ${SERVICE_ROLE_KEY}`
                    }
                });
                
                const equipment = await response.json();
                log(`üìä –í—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: ${equipment.length}`);
                
                const tanks = equipment.filter(eq => eq.system_type === 'fuel_tank');
                log(`üõ¢Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${tanks.length}`, tanks.length > 0 ? 'success' : 'error');
                
                if (tanks.length > 0) {
                    log('<strong>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã:</strong>');
                    tanks.forEach((tank, i) => {
                        const fuelType = tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'] || '–ù–ï –£–ö–ê–ó–ê–ù';
                        const status = tank.status || 'unknown';
                        const isValid = status !== 'deleted' && tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'];
                        
                        const statusColor = isValid ? 'success' : 'error';
                        log(`  ${i+1}. <strong>${tank.name}</strong> | –¢–æ–ø–ª–∏–≤–æ: ${fuelType} | –°—Ç–∞—Ç—É—Å: ${status}`, statusColor);
                    });
                    
                    const validTanks = tanks.filter(t => t.status !== 'deleted' && t.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞']);
                    log(`<br>‚úÖ <strong>–í–ê–õ–ò–î–ù–´–• —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${validTanks.length}</strong>`, 
                        validTanks.length > 0 ? 'success' : 'error');
                        
                    if (validTanks.length === 0) {
                        log('‚ùå –ù–ï–¢ –≤–∞–ª–∏–¥–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ —Å —Ç–∏–ø–æ–º —Ç–æ–ø–ª–∏–≤–∞!', 'error');
                        log('üí° –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä "–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞" –∫ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞–º', 'warning');
                    }
                } else {
                    log('‚ùå –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!', 'error');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        checkTradingPoints();
    </script>
</body>
</html>