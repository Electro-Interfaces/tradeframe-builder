<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéâ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button.success { background: #28a745; }
        button.danger { background: #dc3545; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        th { background: #f2f2f2; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 11px; max-height: 300px; }
    </style>
</head>
<body>
    <h1>üéâ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–µ—Ç–µ–π –∏ —Ç–æ—á–µ–∫</h1>
    
    <div class="section success">
        <h3>‚úÖ –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏: –ó–ê–í–ï–†–®–ï–ù–ê</h3>
        <p><strong>6 —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫</strong> —É—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ localStorage –≤ Supabase</p>
        <p>–í—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –∞–¥—Ä–µ—Å–∞, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏ —Å–µ—Ä–≤–∏—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</p>
    </div>

    <div class="section">
        <button onclick="testNetworksService()" class="success">üè¢ –¢–µ—Å—Ç —Å–µ—Ä–≤–∏—Å–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–µ—Ç–µ–π</button>
        <button onclick="testTradingPointsService()" class="success">üè™ –¢–µ—Å—Ç —Å–µ—Ä–≤–∏—Å–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫</button>
        <button onclick="testRelationship()">üîó –¢–µ—Å—Ç —Å–≤—è–∑–∏ networks ‚Üî trading_points</button>
        <button onclick="testAppIntegration()" class="danger">üöÄ –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (typeof data === 'string') {
                    content += `<pre>${data}</pre>`
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
            console.log(message, data)
        }

        window.testNetworksService = async function() {
            logResult('üè¢ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–µ—Ç–µ–π...', 'info')
            
            try {
                const { data, error } = await supabase
                    .from('networks')
                    .select('*')
                    .order('name')
                
                if (error) throw error
                
                if (data && data.length > 0) {
                    logResult(`‚úÖ –¢–æ—Ä–≥–æ–≤—ã–µ —Å–µ—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${data.length} —Å–µ—Ç–µ–π`, 'success', data)
                } else {
                    logResult('‚ö†Ô∏è –¢–æ—Ä–≥–æ–≤—ã–µ —Å–µ—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning')
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–µ—Ç–µ–π', 'error', error)
            }
        }

        window.testTradingPointsService = async function() {
            logResult('üè™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫...', 'info')
            
            try {
                const { data, error } = await supabase
                    .from('trading_points')
                    .select('*')
                    .order('name')
                
                if (error) throw error
                
                if (data && data.length > 0) {
                    logResult(`‚úÖ –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${data.length} —Ç–æ—á–µ–∫`, 'success')
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
                    const samplePoint = data[0]
                    const hasCoordinates = samplePoint.latitude && samplePoint.longitude
                    const hasAddress = !!samplePoint.address
                    const hasGeolocation = !!samplePoint.geolocation
                    
                    logResult('üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫:', 'info', {
                        '–í—Å–µ–≥–æ —Ç–æ—á–µ–∫': data.length,
                        '–ï—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã': hasCoordinates,
                        '–ï—Å—Ç—å –∞–¥—Ä–µ—Å': hasAddress,
                        '–ï—Å—Ç—å geolocation': hasGeolocation,
                        '–û–±—Ä–∞–∑–µ—Ü —Ç–æ—á–∫–∏': samplePoint
                    })
                } else {
                    logResult('‚ö†Ô∏è –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning')
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫', 'error', error)
            }
        }

        window.testRelationship = async function() {
            logResult('üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏ networks ‚Üî trading_points...', 'info')
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å JOIN
                const { data, error } = await supabase
                    .from('trading_points')
                    .select(`
                        id,
                        external_id,
                        name,
                        address,
                        network_id,
                        networks!inner (
                            id,
                            name,
                            external_id
                        )
                    `)
                    .order('name')
                
                if (error) throw error
                
                if (data && data.length > 0) {
                    logResult(`‚úÖ –°–≤—è–∑—å —Ä–∞–±–æ—Ç–∞–µ—Ç! ${data.length} —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π`, 'success')
                    
                    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å–µ—Ç—è–º
                    const byNetwork = data.reduce((acc, point) => {
                        const networkName = point.networks.name
                        if (!acc[networkName]) acc[networkName] = []
                        acc[networkName].push(point)
                        return acc
                    }, {})
                    
                    logResult('üìã –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –ø–æ —Å–µ—Ç—è–º:', 'info', byNetwork)
                } else {
                    logResult('‚ö†Ô∏è –°–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'warning')
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–∏', 'error', error)
            }
        }

        window.testAppIntegration = async function() {
            logResult('üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º...', 'info')
            
            try {
                // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                logResult('1Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–µ—Ç–∏ –∫–∞–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏...', 'info')
                
                const networksResponse = await supabase
                    .from('networks')
                    .select('*')
                    .eq('status', 'active')
                    .order('name')
                
                if (networksResponse.error) throw networksResponse.error
                
                logResult('2Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è –ø–µ—Ä–≤–æ–π —Å–µ—Ç–∏...', 'info')
                
                if (networksResponse.data && networksResponse.data.length > 0) {
                    const firstNetwork = networksResponse.data[0]
                    
                    const pointsResponse = await supabase
                        .from('trading_points')
                        .select('*')
                        .eq('network_id', firstNetwork.id)
                        .order('name')
                    
                    if (pointsResponse.error) throw pointsResponse.error
                    
                    logResult(`‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!`, 'success', {
                        '–°–µ—Ç—å': firstNetwork.name,
                        'ID —Å–µ—Ç–∏': firstNetwork.id,
                        '–¢–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤ —Å–µ—Ç–∏': pointsResponse.data?.length || 0,
                        '–¢–æ—á–∫–∏': pointsResponse.data?.map(p => ({ name: p.name, address: p.address })) || []
                    })
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                    logResult('üåê –û—Ç–∫—Ä—ã–≤–∞—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏...', 'info')
                    setTimeout(() => {
                        window.open('http://localhost:3002/admin/networks', '_blank')
                        window.open('http://localhost:3002/point/equipment', '_blank')
                    }, 1000)
                    
                } else {
                    logResult('‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–µ—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning')
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º', 'error', error)
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 500))
            
            logResult('üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...', 'info')
            
            await testNetworksService()
            await new Promise(resolve => setTimeout(resolve, 1000))
            
            await testTradingPointsService()
            await new Promise(resolve => setTimeout(resolve, 1000))
            
            await testRelationship()
            await new Promise(resolve => setTimeout(resolve, 1000))
            
            logResult('üéâ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã! –ù–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏" –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏', 'success')
        })
    </script>
</body>
</html>