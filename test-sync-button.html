<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π</h1>
    
    <div>
        <button onclick="testSyncFunction()">üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</button>
        <button onclick="testImports()">üì¶ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã</button>
        <button onclick="testStepByStep()">üîß –ü–æ—à–∞–≥–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    </div>
    
    <div id="logs"></div>

    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            logsDiv.appendChild(logEntry);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function testImports() {
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ tradingTransactionsSyncService –≤ window...', 'info');
            
            if (window.tradingTransactionsSyncService) {
                log('‚úÖ tradingTransactionsSyncService –Ω–∞–π–¥–µ–Ω!', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥—ã
                const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(window.tradingTransactionsSyncService));
                log(`üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã: ${methods.join(', ')}`, 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
                try {
                    const status = window.tradingTransactionsSyncService.getSyncStatus();
                    log(`üìä –°—Ç–∞—Ç—É—Å: isRunning=${status.isRunning}, lastSyncTime=${status.lastSyncTime || '–Ω–∏–∫–æ–≥–¥–∞'}`, 'info');
                } catch (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå tradingTransactionsSyncService –ù–ï –Ω–∞–π–¥–µ–Ω –≤ window', 'error');
                log('üí° –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–∏—Å –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'info');
            }
        }

        async function testSyncFunction() {
            log('üöÄ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é...', 'info');
            
            try {
                if (!window.tradingTransactionsSyncService) {
                    log('‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å', 'error');
                    return;
                }
                
                log('üîß –í—ã–∑—ã–≤–∞–µ–º syncTransactions —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ system=15, station=4...', 'info');
                
                const result = await window.tradingTransactionsSyncService.syncTransactions({
                    systemId: 15,
                    stationNumber: 4,
                    startDate: '2025-09-02',
                    endDate: '2025-09-30'
                });
                
                log(`‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:`, 'success');
                log(`üìä Success: ${result.success}`, result.success ? 'success' : 'error');
                log(`üì• Synced: ${result.syncedTransactions}`, 'info');
                log(`‚è≠Ô∏è Skipped: ${result.skippedTransactions}`, 'info');
                log(`‚ùå Errors: ${result.errors.length}`, result.errors.length > 0 ? 'error' : 'success');
                
                if (result.errors.length > 0) {
                    result.errors.forEach((error, index) => {
                        log(`‚ùå Error ${index + 1}: ${error}`, 'error');
                    });
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');
                log(`‚ùå Stack: ${error.stack}`, 'error');
            }
        }

        async function testStepByStep() {
            log('üîß –ü–æ—à–∞–≥–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...', 'info');
            
            try {
                // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                log('üìã –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API...', 'info');
                
                const configResponse = await fetch('/supabase-proxy/rest/v1/system_config?key=eq.trading_network_config', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY'
                    }
                });
                
                const configData = await configResponse.json();
                const config = configData[0]?.value;
                
                if (!config) {
                    log('‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    return;
                }
                
                log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞', 'success');
                log(`üåê Base URL: ${config.baseUrl}`, 'info');
                log(`üì° Endpoints: ${JSON.stringify(config.endpoints)}`, 'info');
                
                // –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä—É–µ–º API –Ω–∞–ø—Ä—è–º—É—é
                log('üìã –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ—Ä–≥–æ–≤–æ–µ API –Ω–∞–ø—Ä—è–º—É—é...', 'info');
                
                const params = new URLSearchParams({
                    system: '15',
                    station: '4'
                });
                
                const authString = `${config.username}:${config.password}`;
                const authHeader = `Basic ${btoa(authString)}`;
                
                const apiUrl = `${config.baseUrl}${config.endpoints.transactions}?${params.toString()}`;
                log(`üåê API URL: ${apiUrl}`, 'info');
                
                const apiResponse = await fetch(apiUrl, {
                    headers: {
                        'Authorization': authHeader,
                        'Accept': 'application/json'
                    }
                });
                
                log(`üì° API Response: ${apiResponse.status} ${apiResponse.statusText}`, 
                    apiResponse.ok ? 'success' : 'error');
                
                if (apiResponse.ok) {
                    const apiData = await apiResponse.json();
                    if (Array.isArray(apiData)) {
                        log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${apiData.length}`, 'success');
                        if (apiData.length > 0) {
                            log(`üìã –ü–µ—Ä–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: ${JSON.stringify(apiData[0], null, 2)}`, 'info');
                        }
                    } else {
                        log(`üìÑ –û—Ç–≤–µ—Ç API: ${JSON.stringify(apiData)}`, 'info');
                    }
                } else {
                    const errorText = await apiResponse.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ API: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ—à–∞–≥–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            log('üöÄ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            setTimeout(() => {
                testImports();
            }, 2000); // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        };
    </script>
</body>
</html>