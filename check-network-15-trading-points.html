<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ —Å–µ—Ç–∏ 15</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1a1a1a; 
            color: #0f0; 
            padding: 20px;
            line-height: 1.4;
        }
        .section { 
            margin: 15px 0; 
            padding: 10px; 
            border: 1px solid #0f0;
            background: #0a0a0a;
        }
        h1 { color: #0ff; }
        h2 { color: #ff0; }
        .step {
            margin: 10px 0;
            padding: 8px;
            background: #001100;
            border-left: 3px solid #0f0;
        }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .success { color: #0f0; }
        pre {
            background: #000;
            padding: 10px;
            border: 1px solid #333;
            overflow-x: auto;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: #0a0a0a;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            cursor: pointer;
            font-family: monospace;
            margin: 5px;
        }
        button:hover {
            background: #001100;
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏ 15 –∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</h1>
    
    <div class="section">
        <h2>–®–∞–≥ 1: –ü–æ–∏—Å–∫ —Å–µ—Ç–∏ 15</h2>
        <button onclick="findNetwork15()">üè¢ –ù–∞–π—Ç–∏ —Å–µ—Ç—å 15</button>
        <div id="networkResult"></div>
    </div>

    <div class="section">
        <h2>–®–∞–≥ 2: –ü–æ–∏—Å–∫ –≤—Å–µ—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ —Å–µ—Ç–∏</h2>
        <button onclick="findTradingPoints()">üè™ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏</button>
        <div id="tradingPointsResult"></div>
    </div>

    <div class="section">
        <h2>–®–∞–≥ 3: –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞–Ω—Ü–∏–∏ 4</h2>
        <button onclick="findStation4()">üéØ –ù–∞–π—Ç–∏ —Å—Ç–∞–Ω—Ü–∏—é 4</button>
        <div id="station4Result"></div>
    </div>

    <div class="section">
        <h2>–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ 4</h2>
        <button onclick="checkTanksForStation4()">üõ¢Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã</button>
        <div id="tanksResult"></div>
    </div>

    <script>
        const log = (containerId, msg, type = '') => {
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = msg;
            document.getElementById(containerId).appendChild(div);
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞
        const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        let network15Id = null;
        let station4Id = null;

        async function findNetwork15() {
            document.getElementById('networkResult').innerHTML = '';
            log('networkResult', 'üîç –ò—â–µ–º —Å–µ—Ç—å —Å ID 15...', 'warning');
            
            try {
                // –ò—â–µ–º —Å–µ—Ç–∏ —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
                const queries = [
                    { filter: 'external_id.eq.15', desc: 'external_id = 15' },
                    { filter: 'external_id.eq."15"', desc: 'external_id = "15"' },
                    { filter: 'name.ilike.%15%', desc: '–Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "15"' },
                    { filter: 'name.ilike.%—Å–µ—Ç—å 15%', desc: '–Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "—Å–µ—Ç—å 15"' }
                ];

                let allNetworks = [];

                for (const query of queries) {
                    const { data: networks, error } = await supabase
                        .from('networks')
                        .select('*')
                        .or(query.filter);

                    if (!error && networks && networks.length > 0) {
                        log('networkResult', `‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å–µ—Ç–µ–π —á–µ—Ä–µ–∑ ${query.desc}: ${networks.length}`, 'success');
                        networks.forEach(network => {
                            allNetworks.push(network);
                            log('networkResult', `  ‚Ä¢ ID: ${network.id}, –ù–∞–∑–≤–∞–Ω–∏–µ: "${network.name}", external_id: ${network.external_id}`);
                        });
                    } else {
                        log('networkResult', `‚ö†Ô∏è –ß–µ—Ä–µ–∑ ${query.desc}: –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`, 'warning');
                    }
                }

                // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                const uniqueNetworks = allNetworks.filter((network, index, self) => 
                    index === self.findIndex(n => n.id === network.id)
                );

                if (uniqueNetworks.length > 0) {
                    // –ü—Ä–µ–¥–ø–æ—á—Ç–µ–º —Å–µ—Ç—å —Å external_id = 15
                    const preferred = uniqueNetworks.find(n => n.external_id == 15) || uniqueNetworks[0];
                    network15Id = preferred.id;
                    
                    log('networkResult', `<br>üéØ –í–´–ë–†–ê–ù–ù–ê–Ø –°–ï–¢–¨:`, 'success');
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify({
                        id: preferred.id,
                        name: preferred.name,
                        external_id: preferred.external_id,
                        description: preferred.description,
                        created_at: preferred.created_at
                    }, null, 2);
                    document.getElementById('networkResult').appendChild(pre);
                } else {
                    log('networkResult', '‚ùå –°–µ—Ç—å 15 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∏ –æ–¥–Ω–∏–º —Å–ø–æ—Å–æ–±–æ–º!', 'error');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–µ—Ç–∏ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏
                    const { data: allNets } = await supabase.from('networks').select('*').limit(10);
                    log('networkResult', '<br>üìã –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ç–∏:', 'warning');
                    if (allNets) {
                        allNets.forEach(net => {
                            log('networkResult', `  ‚Ä¢ ${net.name} (ID: ${net.id}, external_id: ${net.external_id})`);
                        });
                    }
                }

            } catch (error) {
                log('networkResult', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function findTradingPoints() {
            document.getElementById('tradingPointsResult').innerHTML = '';
            
            if (!network15Id) {
                log('tradingPointsResult', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ —Å–µ—Ç—å 15', 'warning');
                return;
            }

            log('tradingPointsResult', `üîç –ò—â–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è —Å–µ—Ç–∏ ${network15Id}...`, 'warning');
            
            try {
                const { data: tradingPoints, error } = await supabase
                    .from('trading_points')
                    .select('*')
                    .eq('network_id', network15Id);

                if (error) {
                    log('tradingPointsResult', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                    return;
                }

                log('tradingPointsResult', `üìä –ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${tradingPoints.length}`, 'success');

                if (tradingPoints.length > 0) {
                    tradingPoints.forEach((tp, index) => {
                        log('tradingPointsResult', `<br><strong>üè™ –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ ${index + 1}:</strong>`);
                        const tpInfo = {
                            id: tp.id,
                            name: tp.name,
                            external_id: tp.external_id,
                            address: tp.address,
                            status: tp.status,
                            created_at: tp.created_at
                        };
                        
                        const pre = document.createElement('pre');
                        pre.textContent = JSON.stringify(tpInfo, null, 2);
                        document.getElementById('tradingPointsResult').appendChild(pre);
                        
                        // –ò—â–µ–º —Å—Ç–∞–Ω—Ü–∏—é 4
                        if (tp.external_id == 4 || tp.name.includes('4') || tp.name.includes('–ê–ó–°-004')) {
                            log('tradingPointsResult', `üéØ –≠–¢–û –ú–û–ñ–ï–¢ –ë–´–¢–¨ –°–¢–ê–ù–¶–ò–Ø 4! üéØ`, 'success');
                            station4Id = tp.id;
                        }
                    });
                } else {
                    log('tradingPointsResult', '‚ùå –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —ç—Ç–æ–π —Å–µ—Ç–∏', 'error');
                }

            } catch (error) {
                log('tradingPointsResult', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function findStation4() {
            document.getElementById('station4Result').innerHTML = '';
            
            if (!network15Id) {
                log('station4Result', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ —Å–µ—Ç—å 15', 'warning');
                return;
            }

            log('station4Result', `üéØ –ò—â–µ–º —Å—Ç–∞–Ω—Ü–∏—é 4 –¥–ª—è —Å–µ—Ç–∏ ${network15Id}...`, 'warning');
            
            try {
                const { data: tradingPoints, error } = await supabase
                    .from('trading_points')
                    .select('*')
                    .eq('network_id', network15Id);

                if (error) {
                    log('station4Result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                    return;
                }

                // –ò—â–µ–º —Å—Ç–∞–Ω—Ü–∏—é 4 —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
                const station4Candidates = tradingPoints.filter(tp => 
                    tp.external_id == 4 || 
                    tp.external_id === '4' ||
                    tp.name.includes('4') || 
                    tp.name.includes('–ê–ó–°-004') ||
                    tp.name.includes('–°—Ç–∞–Ω—Ü–∏—è 4') ||
                    tp.name.toLowerCase().includes('station 4')
                );

                if (station4Candidates.length > 0) {
                    const station4 = station4Candidates[0];
                    station4Id = station4.id;
                    
                    log('station4Result', `‚úÖ –ù–ê–ô–î–ï–ù–ê –°–¢–ê–ù–¶–ò–Ø 4:`, 'success');
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify({
                        id: station4.id,
                        name: station4.name,
                        external_id: station4.external_id,
                        address: station4.address,
                        network_id: station4.network_id,
                        status: station4.status
                    }, null, 2);
                    document.getElementById('station4Result').appendChild(pre);
                    
                    if (station4Candidates.length > 1) {
                        log('station4Result', `‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ ${station4Candidates.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, –≤—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è`, 'warning');
                    }
                } else {
                    log('station4Result', '‚ùå –°—Ç–∞–Ω—Ü–∏—è 4 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', 'error');
                    log('station4Result', '–í—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ —ç—Ç–æ–π —Å–µ—Ç–∏:', 'warning');
                    tradingPoints.forEach(tp => {
                        log('station4Result', `  ‚Ä¢ ${tp.name} (external_id: ${tp.external_id})`);
                    });
                }

            } catch (error) {
                log('station4Result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function checkTanksForStation4() {
            document.getElementById('tanksResult').innerHTML = '';
            
            if (!station4Id) {
                log('tanksResult', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é 4', 'warning');
                return;
            }

            log('tanksResult', `üõ¢Ô∏è –ò—â–µ–º —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ ${station4Id}...`, 'warning');
            
            try {
                // –ò—â–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ fuel_tank
                const { data: equipment, error } = await supabase
                    .from('equipment')
                    .select('*')
                    .eq('trading_point_id', station4Id)
                    .eq('system_type', 'fuel_tank');

                if (error) {
                    log('tanksResult', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');
                    return;
                }

                log('tanksResult', `üìä –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –≤ equipment: ${equipment.length}`, equipment.length > 0 ? 'success' : 'warning');

                if (equipment.length > 0) {
                    equipment.forEach((tank, index) => {
                        log('tanksResult', `<br><strong>üõ¢Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä ${index + 1} –∏–∑ equipment:</strong>`);
                        const tankInfo = {
                            id: tank.id,
                            name: tank.name,
                            display_name: tank.display_name,
                            external_id: tank.external_id,
                            system_type: tank.system_type,
                            status: tank.status,
                            params: tank.params,
                            template_id: tank.template_id,
                            installation_date: tank.installation_date
                        };
                        
                        const pre = document.createElement('pre');
                        pre.textContent = JSON.stringify(tankInfo, null, 2);
                        document.getElementById('tanksResult').appendChild(pre);
                    });
                } else {
                    log('tanksResult', '‚ùå –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ equipment', 'error');
                    
                    // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ª—é–±–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π —Å—Ç–∞–Ω—Ü–∏–∏
                    const { data: allEquip } = await supabase
                        .from('equipment')
                        .select('*')
                        .eq('trading_point_id', station4Id);
                    
                    log('tanksResult', `üìã –í—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ 4: ${allEquip?.length || 0}`, 'warning');
                    if (allEquip && allEquip.length > 0) {
                        allEquip.forEach(eq => {
                            log('tanksResult', `  ‚Ä¢ ${eq.name || eq.display_name} (—Ç–∏–ø: ${eq.system_type}, —Å—Ç–∞—Ç—É—Å: ${eq.status})`);
                        });
                    }
                }

                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º localStorage
                log('tanksResult', '<br>üíæ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage...', 'warning');
                const tanksData = localStorage.getItem('tanks_data');
                if (tanksData) {
                    const tanks = JSON.parse(tanksData);
                    log('tanksResult', `üì¶ –í localStorage –Ω–∞–π–¥–µ–Ω–æ ${tanks.length} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤`, 'success');
                    
                    const station4Tanks = tanks.filter(tank => 
                        tank.name && (
                            tank.name.includes('4') || 
                            tank.name.includes('–ê–ó–°-004') ||
                            tank.id?.includes('4')
                        )
                    );
                    
                    if (station4Tanks.length > 0) {
                        log('tanksResult', `üõ¢Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã —Å—Ç–∞–Ω—Ü–∏–∏ 4 –≤ localStorage: ${station4Tanks.length}`, 'success');
                        station4Tanks.forEach((tank, i) => {
                            log('tanksResult', `  ‚Ä¢ ${tank.name}: ${tank.fuelType}, ${tank.currentLevelLiters}–ª`);
                        });
                    }
                } else {
                    log('tanksResult', '‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –≤ localStorage –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
                }

            } catch (error) {
                log('tanksResult', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            findNetwork15();
        };
    </script>
</body>
</html>