<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã trading_points</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã trading_points</h1>
    
    <div class="section">
        <button onclick="checkTableStructure()">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã</button>
        <button onclick="checkExistingData()">üìã –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ</button>
        <button onclick="generateFixSQL()">üîß –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å SQL –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (typeof data === 'string') {
                    content += `<pre>${data}</pre>`
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
            console.log(message, data)
        }

        window.checkTableStructure = async function() {
            document.getElementById('results').innerHTML = ''
            
            logResult('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã trading_points...', 'info')
            
            try {
                // –ü—Ä–æ–±—É–µ–º —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å —Å LIMIT 0 —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                const { data, error } = await supabase
                    .from('trading_points')
                    .select('*')
                    .limit(1)
                
                if (error) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã', 'error', error)
                    return
                }
                
                if (data && data.length > 0) {
                    const columns = Object.keys(data[0])
                    logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ (${columns.length}):`, 'success', columns)
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö
                    logResult('üìä –û–±—Ä–∞–∑–µ—Ü —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö:', 'info', data[0])
                } else {
                    logResult('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ-–¥—Ä—É–≥–æ–º—É', 'warning')
                    
                    // –ü—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å —Å –æ—à–∏–±–∫–æ–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫
                    try {
                        await supabase
                            .from('trading_points')
                            .select('non_existent_column')
                            .limit(1)
                    } catch (structureError) {
                        logResult('üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–∑ –æ—à–∏–±–∫–∏:', 'info', structureError)
                    }
                }
                
            } catch (error) {
                logResult('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã', 'error', error)
            }
        }

        window.checkExistingData = async function() {
            logResult('üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ trading_points...', 'info')
            
            try {
                // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                const { data, error } = await supabase
                    .from('trading_points')
                    .select('*')
                
                if (error) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö', 'error', error)
                    return
                }
                
                if (data && data.length > 0) {
                    logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data.length} –∑–∞–ø–∏—Å–µ–π:`, 'success')
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
                    const columns = Object.keys(data[0])
                    logResult('üìä –ö–æ–ª–æ–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—ã:', 'info', columns)
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
                    data.forEach((row, index) => {
                        logResult(`–ó–∞–ø–∏—Å—å ${index + 1}:`, 'info', row)
                    })
                } else {
                    logResult('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ trading_points –ø—É—Å—Ç–∞', 'warning')
                }
                
            } catch (error) {
                logResult('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error', error)
            }
        }

        window.generateFixSQL = function() {
            logResult('üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SQL –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã trading_points...', 'info')
            
            const fixSQL = `-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã trading_points
-- –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ Supabase SQL Editor

-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
DO $$
BEGIN
    -- –î–æ–±–∞–≤–ª—è–µ–º external_id –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trading_points' AND column_name = 'external_id') THEN
        ALTER TABLE public.trading_points ADD COLUMN external_id TEXT;
    END IF;
    
    -- –î–æ–±–∞–≤–ª—è–µ–º block_reason –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç  
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trading_points' AND column_name = 'block_reason') THEN
        ALTER TABLE public.trading_points ADD COLUMN block_reason TEXT;
    END IF;
    
    -- –î–æ–±–∞–≤–ª—è–µ–º website –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trading_points' AND column_name = 'website') THEN
        ALTER TABLE public.trading_points ADD COLUMN website TEXT;
    END IF;
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ is_blocked —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –µ—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trading_points' AND column_name = 'is_blocked') THEN
        ALTER TABLE public.trading_points ADD COLUMN is_blocked BOOLEAN DEFAULT false;
    END IF;
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ external_codes —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∫–∞–∫ JSONB
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trading_points' AND column_name = 'external_codes') THEN
        ALTER TABLE public.trading_points ADD COLUMN external_codes JSONB DEFAULT '[]'::jsonb;
    END IF;
    
END $$;

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è external_id –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
CREATE INDEX IF NOT EXISTS idx_trading_points_external_id ON public.trading_points(external_id);

-- –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
COMMENT ON COLUMN public.trading_points.external_id IS '–í–Ω–µ—à–Ω–∏–π ID –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Ç–æ—Ä–≥–æ–≤—ã–º API';
COMMENT ON COLUMN public.trading_points.block_reason IS '–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏';

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'trading_points' 
ORDER BY ordinal_position;`
            
            logResult('üìú SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', 'success', fixSQL)
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkTableStructure, 500)
        })
    </script>
</body>
</html>