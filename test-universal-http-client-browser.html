<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞</title>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API</h1>
    <div id="log"></div>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
        import { httpClient } from './src/services/universalHttpClient.js';
        import { tradingNetworkConfigService } from './src/services/tradingNetworkConfigService.js';

        const log = document.getElementById('log');

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.style.padding = '5px';
            div.style.margin = '2px 0';
            
            if (type === 'error') {
                div.style.color = 'red';
                div.style.backgroundColor = '#ffebee';
            } else if (type === 'success') {
                div.style.color = 'green';
                div.style.backgroundColor = '#e8f5e8';
            } else {
                div.style.color = 'black';
                div.style.backgroundColor = '#f5f5f5';
            }
            
            div.textContent = message;
            log.appendChild(div);
        }

        async function testHttpClient() {
            try {
                addLog('üß™ –ù–ê–ß–ò–ù–ê–ï–ú –¢–ï–°–¢ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ì–û HTTP –ö–õ–ò–ï–ù–¢–ê');
                addLog('===========================================');
                
                // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                addLog('üîß –¢–ï–°–¢ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Ç–∏');
                
                let config;
                try {
                    config = await tradingNetworkConfigService.getConfig();
                    addLog('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ:', 'success');
                    addLog(`   - –í–∫–ª—é—á–µ–Ω–∞: ${config.enabled}`);
                    addLog(`   - Base URL: ${config.baseUrl}`);
                    addLog(`   - Auth Type: ${config.authType}`);
                    addLog(`   - Username: ${config.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}`);
                    addLog(`   - Endpoints: ${JSON.stringify(config.endpoints)}`);
                } catch (asyncError) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ' + asyncError.message, 'error');
                    
                    // –ü—Ä–æ–±—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
                    try {
                        config = tradingNetworkConfigService.getConfigSync();
                        addLog('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:', 'success');
                        addLog(`   - –í–∫–ª—é—á–µ–Ω–∞: ${config.enabled}`);
                        addLog(`   - Base URL: ${config.baseUrl}`);
                        addLog(`   - Auth Type: ${config.authType}`);
                        addLog(`   - Username: ${config.username}`);
                    } catch (syncError) {
                        addLog('‚ùå –ò —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ' + syncError.message, 'error');
                        return;
                    }
                }

                // –¢–µ—Å—Ç 2: –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
                addLog('');
                addLog('üåê –¢–ï–°–¢ 2: –ó–∞–ø—Ä–æ—Å –∫ API —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤');
                addLog('-----------------------------------');
                
                const testEndpoint = '/tanks';
                const queryParams = {
                    system: '15',  // Network external_id (–ù–æ—Ä–¥ –õ–∞–π–Ω)
                    station: '4'   // –ê–ó–° 4 external_id
                };
                
                addLog(`üì° –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å: ${testEndpoint}`);
                addLog(`üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ${JSON.stringify(queryParams)}`);
                addLog(`üîó –ü–æ–ª–Ω—ã–π URL –±—É–¥–µ—Ç: ${config.baseUrl}${testEndpoint}?system=${queryParams.system}&station=${queryParams.station}`);
                
                const startTime = Date.now();
                
                const response = await httpClient.get(testEndpoint, {
                    destination: 'external-api',
                    queryParams: queryParams,
                    timeout: 10000,
                    retryAttempts: 1
                });
                
                const responseTime = Date.now() - startTime;
                
                addLog('');
                addLog('üìä –†–ï–ó–£–õ–¨–¢–ê–¢ –ó–ê–ü–†–û–°–ê:');
                addLog(`   - –£—Å–ø–µ—Ö: ${response.success}`);
                addLog(`   - HTTP —Å—Ç–∞—Ç—É—Å: ${response.status || '–Ω–µ —É–∫–∞–∑–∞–Ω'}`);
                addLog(`   - –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${response.responseTime || responseTime}ms`);
                addLog(`   - –û—à–∏–±–∫–∞: ${response.error || '–Ω–µ—Ç'}`);
                
                if (response.success && response.data) {
                    addLog('   - –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', 'success');
                    if (Array.isArray(response.data)) {
                        addLog(`     üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${response.data.length}`, 'success');
                        if (response.data.length > 0) {
                            addLog(`     üõ¢Ô∏è  –ü–µ—Ä–≤—ã–π —Ä–µ–∑–µ—Ä–≤—É–∞—Ä: ${JSON.stringify(response.data[0], null, 2)}`);
                        }
                    } else if (typeof response.data === 'object') {
                        addLog(`     üìÑ –î–∞–Ω–Ω—ã–µ (–æ–±—ä–µ–∫—Ç): ${JSON.stringify(response.data, null, 2)}`);
                    } else {
                        addLog(`     üìÑ –î–∞–Ω–Ω—ã–µ (—Ç–µ–∫—Å—Ç): ${response.data}`);
                    }
                } else {
                    if (response.error) {
                        addLog(`‚ùå –û—à–∏–±–∫–∞: ${response.error}`, 'error');
                    }
                    if (response.data) {
                        addLog(`üìÑ –î–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏: ${JSON.stringify(response.data, null, 2)}`, 'error');
                    }
                    if (response.headers) {
                        addLog(`üìã –ó–∞–≥–æ–ª–æ–≤–∫–∏: ${JSON.stringify(response.headers, null, 2)}`);
                    }
                }
                
                // –¢–µ—Å—Ç 3: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                addLog('');
                addLog('üîÑ –¢–ï–°–¢ 3: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã');
                addLog('----------------------------------');
                
                const altParams = [
                    { system: '1', station: '1' },
                    { systemId: '15', stationId: '4' },
                    { networkId: '15', pointId: '4' }
                ];
                
                for (let i = 0; i < altParams.length; i++) {
                    const params = altParams[i];
                    addLog(`üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ${i+1}: ${JSON.stringify(params)}`);
                    
                    try {
                        const altResponse = await httpClient.get(testEndpoint, {
                            destination: 'external-api',
                            queryParams: params,
                            timeout: 5000,
                            retryAttempts: 0
                        });
                        
                        if (altResponse.success) {
                            addLog(`   ‚úÖ –£—Å–ø–µ—Ö! –°—Ç–∞—Ç—É—Å: ${altResponse.status}`, 'success');
                            if (Array.isArray(altResponse.data)) {
                                addLog(`   üìä –†–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${altResponse.data.length}`, 'success');
                            }
                            break;
                        } else {
                            addLog(`   ‚ùå –û—à–∏–±–∫–∞: ${altResponse.error}`, 'error');
                        }
                    } catch (altError) {
                        addLog(`   üí• –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${altError.message}`, 'error');
                    }
                }
                
                addLog('');
                addLog('üèÅ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù');
                
            } catch (error) {
                addLog('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ' + error.message, 'error');
                console.error('Full error:', error);
            }
        }

        // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞
        testHttpClient();
    </script>
</body>
</html>