<!DOCTYPE html>
<html>
<head>
    <title>Fix Operations Table Schema</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 10px 0; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        .danger { background: #f44336; }
        .danger:hover { background: #da190b; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 4px; margin: 10px 0; max-height: 600px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        .warning { color: orange; }
        .sql-command { background: #e8f4f8; padding: 10px; margin: 5px 0; border-left: 4px solid #2196F3; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°—Ö–µ–º—ã –¢–∞–±–ª–∏—Ü—ã Operations</h1>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã operations –¥–ª—è API.</p>
        
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 4px;">
            <strong>‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï:</strong> –≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É operations —Å –ø–æ—Ç–µ—Ä–µ–π –¥–∞–Ω–Ω—ã—Ö!
        </div>
        
        <button onclick="checkCurrentSchema()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¢–µ–∫—É—â—É—é –°—Ö–µ–º—É</button>
        <button onclick="createCorrectTable()" class="danger">–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –¢–∞–±–ª–∏—Ü—É Operations</button>
        <button onclick="addTestData()">–î–æ–±–∞–≤–∏—Ç—å –¢–µ—Å—Ç–æ–≤—ã–µ –î–∞–Ω–Ω—ã–µ</button>
        <button onclick="testAPI()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API</button>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –õ–æ–≥</button>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjUzNTk5NTIsImV4cCI6MjA0MDkzNTk1Mn0.Y_LhIvHnBbMAErYzBt2hHxd6xVtNJoOJ4xm0Y-nOQHY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : 
                             type === 'success' ? 'success' : 
                             type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function checkCurrentSchema() {
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã operations...', 'info');
            
            try {
                const { data, error } = await supabase
                    .from('operations')
                    .select('*')
                    .limit(1);

                if (error) {
                    if (error.message.includes('relation "operations" does not exist')) {
                        log('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ operations –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
                    } else {
                        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                    }
                    return;
                }

                if (data && data.length > 0) {
                    log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ operations –Ω–∞–π–¥–µ–Ω–∞', 'success');
                    log('üîç –ü–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ:', 'info');
                    Object.keys(data[0]).forEach(key => {
                        log(`  - ${key}`, 'info');
                    });
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è
                    const requiredFields = ['start_time', 'operation_type', 'status'];
                    const missingFields = requiredFields.filter(field => !(field in data[0]));
                    
                    if (missingFields.length > 0) {
                        log(`‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—è: ${missingFields.join(', ')}`, 'error');
                        log('üí° –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É', 'warning');
                    } else {
                        log('‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç', 'success');
                    }
                } else {
                    log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ operations —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—É—Å—Ç–∞', 'success');
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ö–µ–º—ã: ${error.message}`, 'error');
            }
        }

        async function createCorrectTable() {
            if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É operations –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –Ω–µ–π. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                log('‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warning');
                return;
            }
            
            log('üîß –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã operations...', 'info');
            
            // SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
            const sqlCommands = [
                'DROP TABLE IF EXISTS operations CASCADE;',
                
                \`CREATE TABLE operations (
                    id VARCHAR(255) PRIMARY KEY,
                    operation_type VARCHAR(50) NOT NULL CHECK (operation_type IN ('sale', 'refund', 'correction', 'maintenance', 'tank_loading', 'diagnostics', 'sensor_calibration')),
                    status VARCHAR(20) NOT NULL CHECK (status IN ('completed', 'in_progress', 'failed', 'pending', 'cancelled')),
                    start_time TIMESTAMPTZ,
                    end_time TIMESTAMPTZ,
                    duration INTEGER,
                    trading_point_id VARCHAR(255),
                    trading_point_name VARCHAR(255),
                    device_id VARCHAR(255),
                    transaction_id VARCHAR(255),
                    fuel_type VARCHAR(100),
                    quantity DECIMAL(10,2),
                    price DECIMAL(10,2),
                    total_cost DECIMAL(10,2),
                    payment_method VARCHAR(50) CHECK (payment_method IN ('cash', 'bank_card', 'fuel_card', 'bank_transfer', 'mobile_payment')),
                    details TEXT,
                    progress INTEGER DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),
                    operator_name VARCHAR(255),
                    customer_id VARCHAR(255),
                    vehicle_number VARCHAR(50),
                    metadata JSONB DEFAULT '{}',
                    created_at TIMESTAMPTZ DEFAULT NOW(),
                    updated_at TIMESTAMPTZ DEFAULT NOW()
                );\`,
                
                'CREATE INDEX operations_start_time_idx ON operations (start_time);',
                'CREATE INDEX operations_status_idx ON operations (status);',
                'CREATE INDEX operations_operation_type_idx ON operations (operation_type);',
                'CREATE INDEX operations_trading_point_id_idx ON operations (trading_point_id);',
                'CREATE INDEX operations_created_at_idx ON operations (created_at);',
                
                \`CREATE OR REPLACE FUNCTION update_updated_at_column()
                RETURNS TRIGGER AS $$
                BEGIN
                    NEW.updated_at = NOW();
                    RETURN NEW;
                END;
                $$ language 'plpgsql';\`,
                
                \`CREATE TRIGGER update_operations_updated_at 
                    BEFORE UPDATE ON operations 
                    FOR EACH ROW 
                    EXECUTE FUNCTION update_updated_at_column();\`,
                
                'ALTER TABLE operations ENABLE ROW LEVEL SECURITY;',
                
                \`CREATE POLICY "Enable all operations for authenticated users" ON operations
                    FOR ALL USING (true) WITH CHECK (true);\`,
                
                \`CREATE POLICY "Enable read access for anon" ON operations
                    FOR SELECT USING (true);\`,
                
                \`CREATE POLICY "Enable insert access for anon" ON operations
                    FOR INSERT WITH CHECK (true);\`
            ];
            
            log('üìã SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:', 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            
            for (const [index, sql] of sqlCommands.entries()) {
                log(`${index + 1}. ${sql.slice(0, 80)}${sql.length > 80 ? '...' : ''}`, 'info');
            }
            
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('‚ö†Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –≤ Supabase Dashboard > SQL Editor', 'warning');
            log('üîó https://app.supabase.com/project/' + supabaseUrl.split('//')[1].split('.')[0] + '/sql', 'info');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π SQL
            const fullSQL = sqlCommands.join('\\n\\n');
            log('üìÑ –ü–æ–ª–Ω—ã–π SQL —Å–∫—Ä–∏–ø—Ç:', 'info');
            log(fullSQL, 'info');
        }

        async function addTestData() {
            log('üìä –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...', 'info');
            
            const testOperations = [
                {
                    id: 'op-001',
                    operation_type: 'sale',
                    status: 'completed',
                    start_time: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                    end_time: new Date(Date.now() - 2 * 60 * 60 * 1000 + 5 * 60 * 1000).toISOString(),
                    duration: 300,
                    trading_point_id: 'tp-001',
                    trading_point_name: '–ê–ó–° –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è',
                    device_id: 'pump-01',
                    transaction_id: 'txn-001',
                    fuel_type: '–ê–ò-95',
                    quantity: 35.50,
                    price: 52.30,
                    total_cost: 1856.65,
                    payment_method: 'bank_card',
                    details: '–û–±—ã—á–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞ —Ç–æ–ø–ª–∏–≤–∞',
                    progress: 100,
                    operator_name: '–ò–≤–∞–Ω–æ–≤ –ê.–ü.',
                    customer_id: 'cust-001',
                    vehicle_number: '–ê123–ë–í77',
                    metadata: { receipt_number: "12345", bonus_points: 18 }
                },
                {
                    id: 'op-002',
                    operation_type: 'sale',
                    status: 'in_progress',
                    start_time: new Date(Date.now() - 5 * 60 * 1000).toISOString(),
                    end_time: null,
                    duration: null,
                    trading_point_id: 'tp-002',
                    trading_point_name: '–ê–ó–° –°–µ–≤–µ—Ä–Ω–∞—è',
                    device_id: 'pump-03',
                    transaction_id: 'txn-003',
                    fuel_type: '–ê–ò-92',
                    quantity: 25.00,
                    price: 50.90,
                    total_cost: 1272.50,
                    payment_method: 'bank_card',
                    details: '–ó–∞–ø—Ä–∞–≤–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ',
                    progress: 75,
                    operator_name: '–°–∏–¥–æ—Ä–æ–≤ –í.–ö.',
                    customer_id: 'cust-003',
                    vehicle_number: '–ï789–ñ–ó55',
                    metadata: { estimated_time: "2 min" }
                },
                {
                    id: 'op-003',
                    operation_type: 'maintenance',
                    status: 'completed',
                    start_time: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(),
                    end_time: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
                    duration: 3600,
                    trading_point_id: 'tp-001',
                    trading_point_name: '–ê–ó–° –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è',
                    device_id: 'pump-02',
                    transaction_id: null,
                    fuel_type: null,
                    quantity: null,
                    price: null,
                    total_cost: null,
                    payment_method: null,
                    details: '–ü–ª–∞–Ω–æ–≤–æ–µ –¢–û –∫–æ–ª–æ–Ω–∫–∏ ‚Ññ2',
                    progress: 100,
                    operator_name: '–¢–µ—Ö–Ω–∏–∫ –ö–æ–∑–ª–æ–≤ –î.–ê.',
                    customer_id: null,
                    vehicle_number: null,
                    metadata: { maintenance_type: "scheduled", work_performed: ["filter_change", "calibration"] }
                }
            ];

            try {
                const { data, error } = await supabase
                    .from('operations')
                    .insert(testOperations)
                    .select();

                if (error) {
                    log(\`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: \${error.message}\`, 'error');
                    return;
                }

                log(\`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ \${data.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\`, 'success');
                data.forEach((op, index) => {
                    log(\`\${index + 1}. \${op.id} - \${op.operation_type} (\${op.status})\`, 'info');
                });

            } catch (error) {
                log(\`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: \${error.message}\`, 'error');
            }
        }

        async function testAPI() {
            log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º API operations...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/v1/operations');
                const result = await response.json();
                
                if (response.ok) {
                    log('‚úÖ API –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω!', 'success');
                    log(\`üìä –ü–æ–ª—É—á–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π: \${result.data?.length || 0}\`, 'success');
                    
                    if (result.data && result.data.length > 0) {
                        log('üîç –ü–µ—Ä–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:', 'info');
                        result.data.slice(0, 3).forEach((op, index) => {
                            log(\`\${index + 1}. \${op.id} - \${op.operationType} (\${op.status}) - \${op.fuelType || 'N/A'}\`, 'info');
                        });
                    }
                } else {
                    log(\`‚ùå API –æ—à–∏–±–∫–∞: \${result.error}\`, 'error');
                    if (result.details) {
                        log(\`üìã –î–µ—Ç–∞–ª–∏: \${result.details}\`, 'error');
                    }
                }
                
            } catch (error) {
                log(\`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API: \${error.message}\`, 'error');
                log('üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ localhost:3001', 'warning');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ö–µ–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            log('üåü –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å—Ö–µ–º—ã operations!', 'info');
            checkCurrentSchema();
        });
    </script>
</body>
</html>