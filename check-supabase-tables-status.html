<!DOCTYPE html>
<html>
<head>
    <title>Supabase Tables Status Check</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test { margin: 15px 0; padding: 20px; border-radius: 10px; }
        .success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
        .error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
        .info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
        .warning { background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; }
        pre { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            margin: 10px 5px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .button:hover { background: #45a049; transform: translateY(-2px); }
        .button.secondary { background: #2196f3; }
        .button.secondary:hover { background: #1976d2; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.2); }
        th { background: rgba(255,255,255,0.1); font-weight: bold; }
        .status-exists { color: #4caf50; }
        .status-missing { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–∞–±–ª–∏—Ü –≤ Supabase</h1>
        
        <div class="test info">
            <h3>üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ç–∞–±–ª–∏—Ü</h3>
            <p>–ü—Ä–æ–≤–µ—Ä–∏–º –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –∞ –∫–∞–∫–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
            <button class="button" onclick="checkAllTables()">–ü–†–û–í–ï–†–ò–¢–¨ –í–°–ï –¢–ê–ë–õ–ò–¶–´</button>
            <button class="button secondary" onclick="checkSpecificTables()">–ü–†–û–í–ï–†–ò–¢–¨ –û–°–ù–û–í–ù–´–ï –¢–ê–ë–õ–ò–¶–´</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const config = {
            url: 'https://ssvazdgnmatbdynkhkqo.supabase.co',
            apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdmF6ZGdubWF0YmR5bmtoa3FvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzM0MzgzNCwiZXhwIjoyMDcyOTE5ODM0fQ.Gen-PI-vDkKjskpIvJNcQw0Uj3d0zGXB98zIxNK6di0'
        };

        // –¢–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
        const expectedTables = [
            'page_help',        // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ ‚úÖ
            'networks',         // –¢–æ—Ä–≥–æ–≤—ã–µ —Å–µ—Ç–∏ ‚ùå 
            'trading_points',   // –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ ‚ùå
            'operations',       // –û–ø–µ—Ä–∞—Ü–∏–∏
            'prices',           // –¶–µ–Ω—ã
            'tanks',            // –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã
            'equipment',        // –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
            'equipment_templates', // –®–∞–±–ª–æ–Ω—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            'users',            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            'roles',            // –†–æ–ª–∏
            'permissions',      // –†–∞–∑—Ä–µ—à–µ–Ω–∏—è
            'fuel_types',       // –í–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞
            'legal_documents'   // –ü—Ä–∞–≤–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
        ];

        function addResult(title, type, data) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        window.checkAllTables = async function() {
            addResult('üîç –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü...', 'info', '–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Supabase –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–∞–±–ª–∏—Ü');
            
            const tableStatus = {};
            const existingTables = [];
            const missingTables = [];

            for (const tableName of expectedTables) {
                try {
                    const response = await fetch(`${config.url}/rest/v1/${tableName}?select=count&limit=0`, {
                        method: 'GET',
                        headers: {
                            'apikey': config.apiKey,
                            'Authorization': `Bearer ${config.apiKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'count=exact'
                        }
                    });

                    if (response.ok) {
                        const count = response.headers.get('Content-Range')?.split('/')[1] || 'unknown';
                        tableStatus[tableName] = { exists: true, count: count, status: response.status };
                        existingTables.push(tableName);
                    } else if (response.status === 404) {
                        tableStatus[tableName] = { exists: false, error: 'Table not found', status: 404 };
                        missingTables.push(tableName);
                    } else {
                        tableStatus[tableName] = { exists: false, error: `HTTP ${response.status}`, status: response.status };
                        missingTables.push(tableName);
                    }
                } catch (error) {
                    tableStatus[tableName] = { exists: false, error: error.message, status: 'error' };
                    missingTables.push(tableName);
                }

                // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const resultsHtml = `
                <h4>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–±–ª–∏—Ü:</h4>
                <table>
                    <tr>
                        <th>–¢–∞–±–ª–∏—Ü–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π</th>
                        <th>–î–µ—Ç–∞–ª–∏</th>
                    </tr>
                    ${expectedTables.map(table => {
                        const status = tableStatus[table];
                        const statusText = status.exists ? 
                            `<span class="status-exists">‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç</span>` : 
                            `<span class="status-missing">‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span>`;
                        const countText = status.exists ? status.count : '-';
                        const details = status.exists ? `HTTP ${status.status}` : status.error;
                        
                        return `<tr>
                            <td><strong>${table}</strong></td>
                            <td>${statusText}</td>
                            <td>${countText}</td>
                            <td>${details}</td>
                        </tr>`;
                    }).join('')}
                </table>
            `;

            addResult('üìä –ü–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Ç–∞–±–ª–∏—Ü', existingTables.length === expectedTables.length ? 'success' : 'warning', {
                summary: {
                    total_tables: expectedTables.length,
                    existing_tables: existingTables.length,
                    missing_tables: missingTables.length,
                    success_rate: `${Math.round((existingTables.length / expectedTables.length) * 100)}%`
                },
                existing: existingTables,
                missing: missingTables,
                detailed_status: tableStatus
            });

            // –î–æ–±–∞–≤–ª—è–µ–º HTML —Ç–∞–±–ª–∏—Ü—É
            const htmlDiv = document.createElement('div');
            htmlDiv.className = 'test info';
            htmlDiv.innerHTML = `<h3>üìã –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç</h3>${resultsHtml}`;
            document.getElementById('results').appendChild(htmlDiv);

            if (missingTables.length > 0) {
                addResult('‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã', 'warning', {
                    message: '–°–ª–µ–¥—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏',
                    missing_tables: missingTables,
                    impact: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ 404 –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–∏–º —Ä–∞–∑–¥–µ–ª–∞–º',
                    solution: '–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã'
                });
            }
        };

        window.checkSpecificTables = async function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
            const criticalTables = ['page_help', 'users', 'roles', 'networks', 'trading_points'];
            
            addResult('üéØ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã', 'info', 
                `–ü—Ä–æ–≤–µ—Ä—è–µ–º: ${criticalTables.join(', ')}`);

            for (const table of criticalTables) {
                try {
                    const response = await fetch(`${config.url}/rest/v1/${table}?limit=3`, {
                        headers: {
                            'apikey': config.apiKey,
                            'Authorization': `Bearer ${config.apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        addResult(`‚úÖ ${table}`, 'success', {
                            status: 'EXISTS',
                            records: data.length,
                            sample_data: data[0] || 'No data',
                            table_accessible: true
                        });
                    } else {
                        addResult(`‚ùå ${table}`, 'error', {
                            status: 'MISSING OR INACCESSIBLE',
                            http_status: response.status,
                            error: await response.text()
                        });
                    }
                } catch (error) {
                    addResult(`‚ùå ${table}`, 'error', {
                        status: 'ERROR',
                        error: error.message
                    });
                }

                await new Promise(resolve => setTimeout(resolve, 200));
            }
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(checkSpecificTables, 1000);
    </script>
</body>
</html>