<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞–º–∏</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        pre { background: #262626; padding: 10px; border-radius: 4px; overflow-x: auto; }
        h2 { border-bottom: 2px solid #444; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞–º–∏</h1>
    <div id="results"></div>

    <script type="module">
        import { tradingNetworkConfigService } from './src/services/tradingNetworkConfigService.js';
        import { tradingPointsService } from './src/services/tradingPointsService.js';
        import { tanksUnifiedService } from './src/services/tanksUnifiedService.js';
        import { httpClient } from './src/services/universalHttpClient.js';

        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const className = type;
            results.innerHTML += `<div class="${className}">${message}</div>`;
            console.log(message);
        }

        async function diagnose() {
            log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...', 'info');
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Ç–∏
            log('\nüìã –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Ç–∏', 'info');
            try {
                const config = tradingNetworkConfigService.getConfigSync();
                log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
                
                if (!config.enabled) {
                    log('‚ùå –¢–æ—Ä–≥–æ–≤–∞—è —Å–µ—Ç—å –û–¢–ö–õ–Æ–ß–ï–ù–ê! –í–∫–ª—é—á–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö "–û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏"', 'error');
                    return;
                }
                log('‚úÖ –¢–æ—Ä–≥–æ–≤–∞—è —Å–µ—Ç—å –≤–∫–ª—é—á–µ–Ω–∞', 'success');
                
                if (!config.baseUrl) {
                    log('‚ùå URL –≤–Ω–µ—à–Ω–µ–≥–æ API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ "–û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏"', 'error');
                    return;
                }
                log(`‚úÖ –ë–∞–∑–æ–≤—ã–π URL: ${config.baseUrl}`, 'success');
                
                if (!config.endpoints?.tanks) {
                    log('‚ùå –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!', 'error');
                    return;
                }
                log(`‚úÖ –≠–Ω–¥–ø–æ–∏–Ω—Ç —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${config.endpoints.tanks}`, 'success');
                
                if (!config.apiKey && !config.username) {
                    log('‚ö†Ô∏è –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ (API –∫–ª—é—á –∏–ª–∏ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å)', 'warning');
                }
                
                results.innerHTML += '<pre>' + JSON.stringify(config, null, 2) + '</pre>';
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
                return;
            }
            
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É
            log('\nüìç –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏', 'info');
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∏–∑ localStorage –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–æ—á–∫—É
                const selectedPointId = localStorage.getItem('selectedTradingPointId');
                
                if (!selectedPointId || selectedPointId === 'all') {
                    log('‚ùå –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞! –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–æ—á–∫—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ', 'error');
                    return;
                }
                log(`‚úÖ –í—ã–±—Ä–∞–Ω–∞ —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞: ${selectedPointId}`, 'success');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
                const tradingPoint = await tradingPointsService.getById(selectedPointId);
                if (!tradingPoint) {
                    log(`‚ùå –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ ${selectedPointId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ!`, 'error');
                    return;
                }
                log(`‚úÖ –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞: ${tradingPoint.name}`, 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º external_id
                if (!tradingPoint.external_id) {
                    log('‚ùå –£ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ù–ï–¢ external_id! –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è API', 'error');
                    log('   –î–æ–±–∞–≤—å—Ç–µ external_id –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏', 'warning');
                    return;
                }
                log(`‚úÖ External ID: ${tradingPoint.external_id}`, 'success');
                
                results.innerHTML += '<pre>' + JSON.stringify(tradingPoint, null, 2) + '</pre>';
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏: ${error.message}`, 'error');
                return;
            }
            
            // 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º HTTP –∑–∞–ø—Ä–æ—Å –∫ API
            log('\nüåê –®–ê–ì 3: –¢–µ—Å—Ç HTTP –∑–∞–ø—Ä–æ—Å–∞ –∫ –≤–Ω–µ—à–Ω–µ–º—É API', 'info');
            try {
                const config = tradingNetworkConfigService.getConfigSync();
                const selectedPointId = localStorage.getItem('selectedTradingPointId');
                const tradingPoint = await tradingPointsService.getById(selectedPointId);
                
                const testUrl = config.endpoints.tanks;
                const testParams = {
                    system: tradingPoint.external_id,
                    station: tradingPoint.external_id
                };
                
                log(`üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å: ${config.baseUrl}${testUrl}`, 'info');
                log(`üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ${JSON.stringify(testParams)}`, 'info');
                
                const response = await httpClient.get(testUrl, {
                    destination: 'external-api',
                    queryParams: testParams
                });
                
                if (response.success) {
                    log('‚úÖ API –æ—Ç–≤–µ—Ç–∏–ª —É—Å–ø–µ—à–Ω–æ!', 'success');
                    log(`üì¶ –ü–æ–ª—É—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö: ${JSON.stringify(response.data).length} –±–∞–π—Ç`, 'info');
                    
                    if (Array.isArray(response.data)) {
                        log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${response.data.length}`, 'success');
                        if (response.data.length > 0) {
                            results.innerHTML += '<pre>' + JSON.stringify(response.data[0], null, 2) + '</pre>';
                        }
                    } else {
                        log('‚ö†Ô∏è API –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤ –≤–∏–¥–µ –º–∞—Å—Å–∏–≤–∞', 'warning');
                        results.innerHTML += '<pre>' + JSON.stringify(response.data, null, 2) + '</pre>';
                    }
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ API: ${response.error}`, 'error');
                    log(`   HTTP —Å—Ç–∞—Ç—É—Å: ${response.status}`, 'error');
                    if (response.data) {
                        results.innerHTML += '<pre>' + JSON.stringify(response.data, null, 2) + '</pre>';
                    }
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
            }
            
            // 4. –¢–µ—Å—Ç–∏—Ä—É–µ–º —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
            log('\nüîß –®–ê–ì 4: –¢–µ—Å—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤', 'info');
            try {
                const selectedPointId = localStorage.getItem('selectedTradingPointId');
                
                const result = await tanksUnifiedService.getTanksForTradingPoint(selectedPointId);
                
                log(`üìä –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: ${result.source}`, 'info');
                log(`üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ${result.synchronized}`, 'info');
                
                if (result.error) {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
                } else if (result.tanks.length > 0) {
                    log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${result.tanks.length}`, 'success');
                    results.innerHTML += '<pre>' + JSON.stringify(result.tanks[0], null, 2) + '</pre>';
                } else {
                    log('‚ö†Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞: ${error.message}`, 'error');
            }
            
            log('\n‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
        diagnose();
    </script>
</body>
</html>