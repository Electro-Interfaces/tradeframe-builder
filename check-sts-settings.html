<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ STS API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #4CAF50;
            color: white;
        }
        .status.error {
            background: #f44336;
            color: white;
        }
        .status.warning {
            background: #ff9800;
            color: white;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #555;
            white-space: pre-wrap;
        }
        input, select {
            background: #3a3a3a;
            color: white;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            width: 200px;
            margin: 5px;
        }
        label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîß –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ STS API</h1>

    <div class="section">
        <h2>1. –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div id="current-settings"></div>
        <button onclick="loadSettings()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div class="section">
        <h2>2. –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫</h2>
        <div>
            <label>URL API:</label>
            <input type="text" id="url" placeholder="https://pos.autooplata.ru/tms" value="https://pos.autooplata.ru/tms">
            
            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
            <input type="text" id="username" placeholder="–≤–∞—à –ª–æ–≥–∏–Ω">
            
            <label>–ü–∞—Ä–æ–ª—å:</label>
            <input type="password" id="password" placeholder="–≤–∞—à –ø–∞—Ä–æ–ª—å">
            
            <label>–ù–æ–º–µ—Ä —Å–µ—Ç–∏ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):</label>
            <input type="text" id="networkId" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 123" style="background: #4a2a2a;">
            
            <label>–ù–æ–º–µ—Ä —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):</label>
            <input type="text" id="tradingPointId" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 456">
            
            <div style="margin-top: 20px;">
                <input type="checkbox" id="enabled" checked>
                <label for="enabled" style="display: inline; margin-left: 5px;">–í–∫–ª—é—á–∏—Ç—å API</label>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button onclick="testConnection()">üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
            </div>
        </div>
        <div id="save-result"></div>
    </div>

    <div class="section">
        <h2>3. –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
        <div id="test-result"></div>
        <button onclick="testTanks()">üóÉÔ∏è –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤</button>
    </div>

    <script>
        function loadSettings() {
            const config = localStorage.getItem('sts-api-config');
            const resultDiv = document.getElementById('current-settings');
            
            if (!config) {
                resultDiv.innerHTML = '<div class="status error">‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage</div>';
                return;
            }

            try {
                const parsedConfig = JSON.parse(config);
                const isComplete = parsedConfig.url && parsedConfig.username && parsedConfig.password && parsedConfig.networkId;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                document.getElementById('url').value = parsedConfig.url || '';
                document.getElementById('username').value = parsedConfig.username || '';
                document.getElementById('password').value = parsedConfig.password || '';
                document.getElementById('networkId').value = parsedConfig.networkId || '';
                document.getElementById('tradingPointId').value = parsedConfig.tradingPointId || '';
                document.getElementById('enabled').checked = parsedConfig.enabled || false;
                
                resultDiv.innerHTML = `
                    <div class="status ${isComplete ? 'success' : 'warning'}">
                        ${isComplete ? '‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã' : '‚ö†Ô∏è –ù–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã'}
                    </div>
                    <pre>${JSON.stringify(parsedConfig, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        function saveSettings() {
            const resultDiv = document.getElementById('save-result');
            
            try {
                const config = {
                    url: document.getElementById('url').value.trim(),
                    username: document.getElementById('username').value.trim(),
                    password: document.getElementById('password').value.trim(),
                    networkId: document.getElementById('networkId').value.trim(),
                    tradingPointId: document.getElementById('tradingPointId').value.trim(),
                    enabled: document.getElementById('enabled').checked,
                    timeout: 30000,
                    retryAttempts: 3,
                    refreshInterval: 30
                };

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                const errors = [];
                if (!config.url) errors.push('URL');
                if (!config.username) errors.push('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                if (!config.password) errors.push('–ü–∞—Ä–æ–ª—å');
                if (!config.networkId) errors.push('–ù–æ–º–µ—Ä —Å–µ—Ç–∏');

                if (errors.length > 0) {
                    resultDiv.innerHTML = `<div class="status error">‚ùå –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: ${errors.join(', ')}</div>`;
                    return;
                }

                localStorage.setItem('sts-api-config', JSON.stringify(config));
                
                resultDiv.innerHTML = `
                    <div class="status success">‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div>
                    <div class="status">üîÑ –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}</div>`;
            }
        }

        async function testConnection() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = '<div class="status">‚è≥ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>';
            
            try {
                const config = JSON.parse(localStorage.getItem('sts-api-config') || '{}');
                
                if (!config.url || !config.username || !config.password) {
                    resultDiv.innerHTML = '<div class="status error">‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>';
                    return;
                }

                // –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                const response = await fetch(`${config.url}/v1/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: config.username,
                        password: config.password
                    })
                });

                if (response.ok) {
                    const token = await response.text();
                    resultDiv.innerHTML = `
                        <div class="status success">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</div>
                        <div class="status">üîë –ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω: ${token.substring(0, 30)}...</div>
                    `;
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <div class="status error">‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${response.status}</div>
                        <pre>${errorText}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;
            }
        }

        async function testTanks() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = '<div class="status">‚è≥ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤...</div>';
            
            try {
                const config = JSON.parse(localStorage.getItem('sts-api-config') || '{}');
                
                if (!config.networkId) {
                    resultDiv.innerHTML = '<div class="status error">‚ùå –ù–µ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä —Å–µ—Ç–∏! –≠—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä.</div>';
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
                const loginResponse = await fetch(`${config.url}/v1/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: config.username,
                        password: config.password
                    })
                });

                if (!loginResponse.ok) {
                    throw new Error(`–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: ${loginResponse.status}`);
                }

                const token = (await loginResponse.text()).replace(/"/g, '');

                // –ó–∞–ø—Ä–æ—Å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤
                const url = new URL(`${config.url}/v1/tanks`);
                if (config.networkId) url.searchParams.set('system', config.networkId);
                if (config.tradingPointId) url.searchParams.set('station', config.tradingPointId);

                const tanksResponse = await fetch(url.toString(), {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (tanksResponse.ok) {
                    const tanksData = await tanksResponse.json();
                    const tanksCount = Array.isArray(tanksData) ? tanksData.length : (tanksData.tanks ? tanksData.tanks.length : 0);
                    
                    resultDiv.innerHTML = `
                        <div class="status success">‚úÖ –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!</div>
                        <div class="status">üìä –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${tanksCount}</div>
                        <div class="status">üîó URL –∑–∞–ø—Ä–æ—Å–∞: ${url.toString()}</div>
                        <pre>${JSON.stringify(tanksData, null, 2).substring(0, 1000)}${JSON.stringify(tanksData, null, 2).length > 1000 ? '...' : ''}</pre>
                    `;
                } else {
                    const errorText = await tanksResponse.text();
                    resultDiv.innerHTML = `
                        <div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${tanksResponse.status}</div>
                        <div class="status">üîó URL –∑–∞–ø—Ä–æ—Å–∞: ${url.toString()}</div>
                        <pre>${errorText}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            loadSettings();
        };
    </script>
</body>
</html>