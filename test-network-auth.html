<!DOCTYPE html>
<html>
<head>
    <title>Test Network API Authentication</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .section { background: #fff; padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid #ddd; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 5px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 5px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 4px; margin: 5px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 5px 0; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        label { display: inline-block; width: 150px; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .form-row { margin: 10px 0; }
        .token-info { font-family: monospace; background: #f8f9fa; padding: 5px; border-radius: 4px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>üîê Test Network API Authentication</h1>
    
    <div class="section">
        <h3>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h3>
        <div class="form-row">
            <label>Base URL:</label>
            <input type="url" id="baseUrl" value="https://pos.autooplata.ru/tms/v1" />
        </div>
        <div class="form-row">
            <label>System ID:</label>
            <input type="text" id="systemId" value="15" />
        </div>
        <div class="form-row">
            <label>Username:</label>
            <input type="text" id="username" placeholder="–í–∞—à –ª–æ–≥–∏–Ω" />
        </div>
        <div class="form-row">
            <label>Password:</label>
            <input type="password" id="password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" />
        </div>
        <div class="form-row">
            <button onclick="saveAuthConfig()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button onclick="clearAuthConfig()">–û—á–∏—Å—Ç–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
        <div id="config-status"></div>
    </div>

    <div class="section">
        <h3>2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h3>
        <button onclick="testAuthentication()" id="authBtn">–¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</button>
        <button onclick="testTokenRefresh()" id="refreshBtn">–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞</button>
        <div id="auth-status"></div>
    </div>

    <div class="section">
        <h3>3. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–∫–µ–Ω–µ</h3>
        <button onclick="showTokenInfo()">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω</button>
        <div id="token-info"></div>
    </div>

    <div class="section">
        <h3>4. –¢–µ—Å—Ç API —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π</h3>
        <button onclick="testApiWithAuth()" id="apiBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ü–µ–Ω—ã —Å —Ç–æ–∫–µ–Ω–æ–º</button>
        <div id="api-status"></div>
    </div>

    <div class="section">
        <h3>5. –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ü–µ–Ω</h3>
        <button onclick="openPricesPageWithAuth()">–û—Ç–∫—Ä—ã—Ç—å /point/prices</button>
        <p><em>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π</em></p>
    </div>

    <div class="section">
        <h3>6. –ñ—É—Ä–Ω–∞–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h3>
        <div id="auth-log" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;"></div>
        <button onclick="clearAuthLog()">–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
    </div>

    <script>
        let authLog = [];
        
        function addAuthLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            authLog.push(`[${timestamp}] ${message}`);
            updateAuthLogDisplay();
            console.log(`[AUTH TEST] ${message}`);
        }
        
        function updateAuthLogDisplay() {
            const logDiv = document.getElementById('auth-log');
            logDiv.innerHTML = authLog.map(entry => `<div>${entry}</div>`).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearAuthLog() {
            authLog = [];
            updateAuthLogDisplay();
        }

        function saveAuthConfig() {
            const baseUrl = document.getElementById('baseUrl').value;
            const systemId = document.getElementById('systemId').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!baseUrl || !systemId) {
                document.getElementById('config-status').innerHTML = 
                    '<div class="error">‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (Base URL, System ID)</div>';
                return;
            }

            const config = {
                baseUrl: baseUrl,
                systemId: systemId,
                login: username || undefined,
                password: password || undefined
            };

            localStorage.setItem('networkPricesApi', JSON.stringify(config));
            window.dispatchEvent(new CustomEvent('localStorageChanged'));

            document.getElementById('config-status').innerHTML = 
                '<div class="success">‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</div>';
            
            addAuthLog(`üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ${username ? '—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π' : '–±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏'}`);
        }

        function clearAuthConfig() {
            localStorage.removeItem('networkPricesApi');
            window.dispatchEvent(new CustomEvent('localStorageChanged'));
            
            document.getElementById('config-status').innerHTML = 
                '<div class="info">‚ÑπÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—á–∏—â–µ–Ω—ã</div>';
            
            addAuthLog('üóëÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—á–∏—â–µ–Ω—ã');
        }

        async function testAuthentication() {
            const statusDiv = document.getElementById('auth-status');
            const authBtn = document.getElementById('authBtn');
            
            authBtn.disabled = true;
            statusDiv.innerHTML = '<div class="info">üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...</div>';
            addAuthLog('üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
            
            try {
                const config = JSON.parse(localStorage.getItem('networkPricesApi') || '{}');
                
                if (!config.login || !config.password) {
                    statusDiv.innerHTML = '<div class="warning">‚ö†Ô∏è –õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω—ã</div>';
                    addAuthLog('‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
                    return;
                }

                // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
                addAuthLog(`üîë –ü–æ–ø—ã—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${config.login}`);
                
                const authResponse = await fetch(`${config.baseUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: config.login,
                        password: config.password,
                    }),
                });

                if (authResponse.ok) {
                    const authData = await authResponse.json();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                    const now = Date.now();
                    const expiresIn = authData.expires_in * 1000;
                    const updatedConfig = {
                        ...config,
                        accessToken: authData.access_token,
                        refreshToken: authData.refresh_token,
                        tokenExpireAt: now + expiresIn,
                        tokenType: 'Bearer'
                    };
                    
                    localStorage.setItem('networkPricesApi', JSON.stringify(updatedConfig));
                    
                    statusDiv.innerHTML = `
                        <div class="success">‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</div>
                        <div><strong>Access Token:</strong> ${authData.access_token.substring(0, 20)}...</div>
                        <div><strong>Expires in:</strong> ${authData.expires_in} —Å–µ–∫—É–Ω–¥</div>
                        <div><strong>Token Type:</strong> ${authData.token_type}</div>
                    `;
                    
                    addAuthLog(`‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω (–∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ${authData.expires_in}—Å)`);
                } else {
                    const errorText = await authResponse.text();
                    statusDiv.innerHTML = `
                        <div class="error">‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${authResponse.status} ${authResponse.statusText}</div>
                        <pre>${errorText}</pre>
                    `;
                    addAuthLog(`‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${authResponse.status} ${authResponse.statusText}`);
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;
                addAuthLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
            } finally {
                authBtn.disabled = false;
            }
        }

        async function testTokenRefresh() {
            const statusDiv = document.getElementById('auth-status');
            const refreshBtn = document.getElementById('refreshBtn');
            
            refreshBtn.disabled = true;
            addAuthLog('üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞');
            
            try {
                const config = JSON.parse(localStorage.getItem('networkPricesApi') || '{}');
                
                if (!config.refreshToken) {
                    statusDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Refresh token –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                    addAuthLog('‚ö†Ô∏è Refresh token –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
                    return;
                }

                const refreshResponse = await fetch(`${config.baseUrl}/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        refresh_token: config.refreshToken,
                    }),
                });

                if (refreshResponse.ok) {
                    const refreshData = await refreshResponse.json();
                    
                    const now = Date.now();
                    const expiresIn = refreshData.expires_in * 1000;
                    const updatedConfig = {
                        ...config,
                        accessToken: refreshData.access_token,
                        refreshToken: refreshData.refresh_token || config.refreshToken,
                        tokenExpireAt: now + expiresIn,
                    };
                    
                    localStorage.setItem('networkPricesApi', JSON.stringify(updatedConfig));
                    
                    statusDiv.innerHTML = `
                        <div class="success">‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!</div>
                        <div><strong>New Access Token:</strong> ${refreshData.access_token.substring(0, 20)}...</div>
                    `;
                    
                    addAuthLog('‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
                } else {
                    statusDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ${refreshResponse.status}</div>`;
                    addAuthLog(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ${refreshResponse.status}`);
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
                addAuthLog(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ${error.message}`);
            } finally {
                refreshBtn.disabled = false;
            }
        }

        function showTokenInfo() {
            const tokenDiv = document.getElementById('token-info');
            
            try {
                const config = JSON.parse(localStorage.getItem('networkPricesApi') || '{}');
                
                if (!config.accessToken) {
                    tokenDiv.innerHTML = '<div class="info">‚ÑπÔ∏è –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>';
                    return;
                }

                const now = Date.now();
                const expiresAt = new Date(config.tokenExpireAt);
                const isExpired = now > config.tokenExpireAt;
                const timeLeft = Math.max(0, Math.floor((config.tokenExpireAt - now) / 1000));

                tokenDiv.innerHTML = `
                    <div class="token-info">
                        <div><strong>Access Token:</strong> ${config.accessToken.substring(0, 50)}...</div>
                        <div><strong>Token Type:</strong> ${config.tokenType || 'Bearer'}</div>
                        <div><strong>Expires At:</strong> ${expiresAt.toLocaleString()}</div>
                        <div><strong>Status:</strong> ${isExpired ? '‚ùå –ò—Å—Ç–µ–∫' : `‚úÖ –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (${timeLeft}—Å)`}</div>
                        ${config.refreshToken ? `<div><strong>Refresh Token:</strong> ${config.refreshToken.substring(0, 30)}...</div>` : ''}
                    </div>
                `;
                
                addAuthLog(`üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–∫–µ–Ω–µ: ${isExpired ? '–∏—Å—Ç–µ–∫' : `–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω ${timeLeft}—Å`}`);
            } catch (error) {
                tokenDiv.innerHTML = '<div class="error">‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</div>';
                addAuthLog('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞');
            }
        }

        async function testApiWithAuth() {
            const statusDiv = document.getElementById('api-status');
            const apiBtn = document.getElementById('apiBtn');
            
            apiBtn.disabled = true;
            statusDiv.innerHTML = '<div class="info">üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π...</div>';
            addAuthLog('üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º API —Å —Ç–æ–∫–µ–Ω–æ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
            
            try {
                const config = JSON.parse(localStorage.getItem('networkPricesApi') || '{}');
                
                if (!config.accessToken) {
                    statusDiv.innerHTML = '<div class="warning">‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é</div>';
                    addAuthLog('‚ö†Ô∏è –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è');
                    return;
                }

                const response = await fetch(`${config.baseUrl}/prices?system=${config.systemId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `${config.tokenType || 'Bearer'} ${config.accessToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = `
                        <div class="success">‚úÖ API –∑–∞–ø—Ä–æ—Å —Å —Ç–æ–∫–µ–Ω–æ–º —É—Å–ø–µ—à–µ–Ω!</div>
                        <div>–ü–æ–ª—É—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö: ${data.length} —Å—Ç–∞–Ω—Ü–∏–π</div>
                        <pre>${JSON.stringify(data[0] || {}, null, 2)}</pre>
                    `;
                    addAuthLog(`‚úÖ API –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω: –ø–æ–ª—É—á–µ–Ω–æ ${data.length} —Å—Ç–∞–Ω—Ü–∏–π`);
                } else {
                    statusDiv.innerHTML = `<div class="error">‚ùå API –æ—à–∏–±–∫–∞: ${response.status} ${response.statusText}</div>`;
                    addAuthLog(`‚ùå API –æ—à–∏–±–∫–∞: ${response.status} - –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫`);
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
                addAuthLog(`‚ùå –û—à–∏–±–∫–∞ API –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
            } finally {
                apiBtn.disabled = false;
            }
        }

        function openPricesPageWithAuth() {
            addAuthLog('üåê –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ü–µ–Ω —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π');
            window.open('http://localhost:3004/point/prices', '_blank');
        }

        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            addAuthLog('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            
            try {
                const config = JSON.parse(localStorage.getItem('networkPricesApi') || '{}');
                if (config.baseUrl) {
                    document.getElementById('baseUrl').value = config.baseUrl;
                    document.getElementById('systemId').value = config.systemId || '';
                    document.getElementById('username').value = config.login || '';
                    
                    addAuthLog('üìã –ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è');
                }
            } catch (error) {
                addAuthLog('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
            }
        };
    </script>
</body>
</html>