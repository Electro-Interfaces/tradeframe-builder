<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ SQL</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            color: white;
            font-weight: bold;
            margin-left: 10px;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .warning { background: #ff9800; }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a8b;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        .log {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .quick-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .quick-queries button {
            padding: 8px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è –ü—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Supabase</h1>

        <div class="section">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
            <button onclick="loadSettings()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage</button>
            <div id="settings-status"></div>
        </div>

        <div class="section">
            <h3>–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h3>
            <div class="quick-queries">
                <button onclick="runQuery('SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema = \\'public\\'')">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–±–ª–∏—Ü</button>
                <button onclick="runQuery('SELECT table_name FROM information_schema.tables WHERE table_schema = \\'public\\' ORDER BY table_name')">–°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü</button>
                <button onclick="runQuery('SELECT COUNT(*) as roles_count FROM roles;')">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–æ–ª–µ–π</button>
                <button onclick="runQuery('SELECT id, code, name, scope, is_active FROM roles ORDER BY created_at;')">–í—Å–µ —Ä–æ–ª–∏</button>
                <button onclick="runQuery('SELECT COUNT(*) as users_count FROM users;')">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
                <button onclick="runQuery('SELECT id, email, name, status FROM users LIMIT 10;')">–ü–µ—Ä–≤—ã–µ 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
            </div>
        </div>

        <div class="section">
            <h3>–í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å</h3>
            <textarea id="sql-query" placeholder="–í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å...">SELECT * FROM roles ORDER BY created_at DESC LIMIT 10;</textarea>
            <br>
            <button onclick="runCustomQuery()">–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>

        <div class="section">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
            <div id="log" class="log">–ì–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤...\n</div>
        </div>
    </div>

    <script>
        let supabaseUrl = '';
        let supabaseKey = '';

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '–õ–æ–≥ –æ—á–∏—â–µ–Ω...\n';
        }

        function loadSettings() {
            const statusEl = document.getElementById('settings-status');
            
            try {
                const savedSettings = localStorage.getItem('externalDatabase');
                if (!savedSettings) {
                    statusEl.innerHTML = '<span class="status error">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</span>';
                    log('ERROR: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ externalDatabase –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage');
                    return;
                }

                const parsed = JSON.parse(savedSettings);
                if (!parsed.url || !parsed.apiKey) {
                    statusEl.innerHTML = '<span class="status warning">–ù–µ–ø–æ–ª–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>';
                    log('WARNING: URL –∏–ª–∏ apiKey –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç');
                    return;
                }

                supabaseUrl = parsed.url;
                supabaseKey = parsed.apiKey;
                statusEl.innerHTML = '<span class="status success">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</span>';
                log(`SUCCESS: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. URL: ${supabaseUrl}`);
            } catch (error) {
                statusEl.innerHTML = '<span class="status error">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞</span>';
                log(`ERROR: ${error.message}`);
            }
        }

        async function runQuery(query) {
            if (!supabaseUrl || !supabaseKey) {
                log('ERROR: –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                return;
            }

            log(`–í—ã–ø–æ–ª–Ω—è—é –∑–∞–ø—Ä–æ—Å: ${query}`);
            
            try {
                // –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö SELECT –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º REST API
                if (query.toLowerCase().trim().startsWith('select')) {
                    await runSelectQuery(query);
                } else {
                    log('WARN: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ SELECT –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ REST API');
                }
            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function runSelectQuery(query) {
            try {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º SQL –≤ REST API –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤
                if (query.includes('COUNT(*) as table_count FROM information_schema.tables')) {
                    // –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –Ω–µ–ª—å–∑—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ REST API
                    log('INFO: –ó–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ö–µ–º—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ REST API');
                    return;
                }
                
                if (query.includes('SELECT table_name FROM information_schema.tables')) {
                    log('INFO: –ó–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ö–µ–º—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ REST API');
                    return;
                }

                if (query.includes('FROM roles')) {
                    let endpoint = 'roles';
                    
                    if (query.includes('COUNT(*)')) {
                        endpoint += '?select=count';
                    } else {
                        endpoint += '?order=created_at.desc';
                        if (query.includes('LIMIT')) {
                            const limitMatch = query.match(/LIMIT (\\d+)/i);
                            if (limitMatch) {
                                endpoint += `&limit=${limitMatch[1]}`;
                            }
                        }
                    }

                    const response = await fetch(`${supabaseUrl}/rest/v1/${endpoint}`, {
                        method: 'GET',
                        headers: {
                            'apikey': supabaseKey,
                            'Authorization': `Bearer ${supabaseKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        log(`SUCCESS: –ü–æ–ª—É—á–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${Array.isArray(data) ? data.length : 1}`);
                        log(`–î–ê–ù–ù–´–ï: ${JSON.stringify(data, null, 2)}`);
                    } else {
                        const errorText = await response.text();
                        log(`ERROR: ${response.status} - ${errorText}`);
                    }
                } else if (query.includes('FROM users')) {
                    let endpoint = 'users';
                    
                    if (query.includes('COUNT(*)')) {
                        endpoint += '?select=count';
                    } else {
                        endpoint += '?order=created_at.desc';
                        if (query.includes('LIMIT')) {
                            const limitMatch = query.match(/LIMIT (\\d+)/i);
                            if (limitMatch) {
                                endpoint += `&limit=${limitMatch[1]}`;
                            }
                        }
                    }

                    const response = await fetch(`${supabaseUrl}/rest/v1/${endpoint}`, {
                        method: 'GET',
                        headers: {
                            'apikey': supabaseKey,
                            'Authorization': `Bearer ${supabaseKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        log(`SUCCESS: –ü–æ–ª—É—á–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${Array.isArray(data) ? data.length : 1}`);
                        log(`–î–ê–ù–ù–´–ï: ${JSON.stringify(data, null, 2)}`);
                    } else {
                        const errorText = await response.text();
                        log(`ERROR: ${response.status} - ${errorText}`);
                    }
                } else {
                    log('WARN: –°–ª–æ–∂–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ SELECT –¥–ª—è —Ç–∞–±–ª–∏—Ü roles, users –∏ —Ç.–¥.');
                }
            } catch (error) {
                log(`ERROR: Network error: ${error.message}`);
            }
        }

        function runCustomQuery() {
            const query = document.getElementById('sql-query').value.trim();
            if (!query) {
                log('ERROR: –í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å');
                return;
            }
            runQuery(query);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            loadSettings();
        };
    </script>
</body>
</html>