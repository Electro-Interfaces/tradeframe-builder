<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã equipment_templates</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        .result {
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .success { border-left-color: #48bb78; background: #f0fff4; }
        .error { border-left-color: #f56565; background: #fff5f5; }
        .warning { border-left-color: #ed8936; background: #fffaf0; }
        .info { border-left-color: #4299e1; background: #ebf8ff; }
        pre { 
            background: #2d3748; 
            color: #e2e8f0; 
            padding: 15px; 
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
        }
        .actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .primary-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .success-btn { background: linear-gradient(135deg, #48bb78, #38a169); color: white; }
        .danger-btn { background: linear-gradient(135deg, #f56565, #e53e3e); color: white; }
        .warning-btn { background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background: #f7fafc;
        }
        .missing {
            background: #fff5f5;
            color: #c53030;
        }
        .exists {
            background: #f0fff4;
            color: #22543d;
        }
        .sql-container {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .sql-container h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }
        .copy-btn {
            background: #4299e1;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã equipment_templates</h1>
        
        <div class="actions">
            <button onclick="checkCurrentStructure()" class="primary-btn">üìã –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É</button>
            <button onclick="showRequiredStructure()" class="warning-btn">üìä –ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–±—É–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É</button>
            <button onclick="generateFixSQL()" class="success-btn">üî® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å SQL –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</button>
            <button onclick="testTableOperations()" class="primary-btn">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏</button>
            <button onclick="clearResults()" class="danger-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        // –¢—Ä–µ–±—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã
        const requiredColumns = [
            { name: 'id', type: 'uuid', nullable: false, default: 'gen_random_uuid()' },
            { name: 'name', type: 'varchar(255)', nullable: false, default: null },
            { name: 'technical_code', type: 'varchar(100)', nullable: true, default: null },
            { name: 'system_type', type: 'varchar(100)', nullable: true, default: null },
            { name: 'description', type: 'text', nullable: true, default: null },
            { name: 'default_params', type: 'jsonb', nullable: true, default: '{}' },
            { name: 'allow_component_template_ids', type: 'uuid[]', nullable: true, default: null },
            { name: 'created_at', type: 'timestamptz', nullable: true, default: 'CURRENT_TIMESTAMP' },
            { name: 'updated_at', type: 'timestamptz', nullable: true, default: 'CURRENT_TIMESTAMP' }
        ]
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const resultDiv = document.createElement('div')
            resultDiv.className = `result ${type}`
            
            const timestamp = new Date().toLocaleTimeString()
            let content = `<strong>[${timestamp}] ${message}</strong>`
            
            if (data !== null) {
                if (typeof data === 'object') {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                } else {
                    content += `<pre>${data}</pre>`
                }
            }
            
            resultDiv.innerHTML = content
            resultsDiv.insertBefore(resultDiv, resultsDiv.firstChild)
        }
        
        window.clearResults = function() {
            document.getElementById('results').innerHTML = ''
            logResult('‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã', 'info')
        }
        
        window.checkCurrentStructure = async function() {
            logResult('üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã...', 'info')
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                const { data, error } = await supabase
                    .from('equipment_templates')
                    .select('*')
                    .limit(1)
                
                let currentColumns = []
                
                if (!error && data && data.length > 0) {
                    currentColumns = Object.keys(data[0])
                } else {
                    // –ü—ã—Ç–∞–µ–º—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å –∏ –ø–æ–π–º–∞—Ç—å –æ—à–∏–±–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                    const testData = {}
                    requiredColumns.forEach(col => {
                        if (col.name !== 'id' && col.name !== 'created_at' && col.name !== 'updated_at') {
                            testData[col.name] = null
                        }
                    })
                    
                    const { error: insertError } = await supabase
                        .from('equipment_templates')
                        .insert([testData])
                    
                    if (insertError && insertError.message) {
                        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                        const missingColumnMatch = insertError.message.match(/Could not find the '(\w+)' column/)
                        if (missingColumnMatch) {
                            logResult(`‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∞: ${missingColumnMatch[1]}`, 'error')
                        }
                    }
                }
                
                // –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                let tableHtml = '<table><thead><tr><th>–ö–æ–ª–æ–Ω–∫–∞</th><th>–¢—Ä–µ–±—É–µ–º—ã–π —Ç–∏–ø</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>'
                
                const missingColumns = []
                requiredColumns.forEach(reqCol => {
                    const exists = currentColumns.includes(reqCol.name)
                    const statusClass = exists ? 'exists' : 'missing'
                    const statusText = exists ? '‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç' : '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'
                    
                    if (!exists) {
                        missingColumns.push(reqCol)
                    }
                    
                    tableHtml += `
                        <tr class="${statusClass}">
                            <td><strong>${reqCol.name}</strong></td>
                            <td>${reqCol.type}</td>
                            <td>${statusText}</td>
                        </tr>
                    `
                })
                
                tableHtml += '</tbody></table>'
                
                const resultDiv = document.createElement('div')
                resultDiv.className = 'result info'
                resultDiv.innerHTML = `<strong>üìä –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã:</strong>${tableHtml}`
                document.getElementById('results').insertBefore(resultDiv, document.getElementById('results').firstChild)
                
                if (missingColumns.length > 0) {
                    logResult(`‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–æ–Ω–æ–∫: ${missingColumns.length}`, 'warning', missingColumns.map(c => c.name))
                } else if (currentColumns.length > 0) {
                    logResult('‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç!', 'success')
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
                const { count } = await supabase
                    .from('equipment_templates')
                    .select('*', { count: 'exact', head: true })
                
                logResult(`üìà –ó–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ: ${count || 0}`, 'info')
                
            } catch (err) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã', 'error', err)
            }
        }
        
        window.showRequiredStructure = function() {
            let tableHtml = '<table><thead><tr><th>–ö–æ–ª–æ–Ω–∫–∞</th><th>–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö</th><th>Nullable</th><th>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</th></tr></thead><tbody>'
            
            requiredColumns.forEach(col => {
                tableHtml += `
                    <tr>
                        <td><strong>${col.name}</strong></td>
                        <td>${col.type}</td>
                        <td>${col.nullable ? 'YES' : 'NO'}</td>
                        <td>${col.default || '-'}</td>
                    </tr>
                `
            })
            
            tableHtml += '</tbody></table>'
            
            const resultDiv = document.createElement('div')
            resultDiv.className = 'result info'
            resultDiv.innerHTML = `<strong>üìã –¢—Ä–µ–±—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã equipment_templates:</strong>${tableHtml}`
            document.getElementById('results').insertBefore(resultDiv, document.getElementById('results').firstChild)
        }
        
        window.generateFixSQL = async function() {
            logResult('üî® –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SQL –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã...', 'info')
            
            const sql = `-- ============================================================
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—É equipment_templates
-- ============================================================

-- –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
ALTER TABLE equipment_templates 
ADD COLUMN IF NOT EXISTS name VARCHAR(255);

ALTER TABLE equipment_templates 
ADD COLUMN IF NOT EXISTS technical_code VARCHAR(100);

ALTER TABLE equipment_templates 
ADD COLUMN IF NOT EXISTS system_type VARCHAR(100);

ALTER TABLE equipment_templates 
ADD COLUMN IF NOT EXISTS description TEXT;

ALTER TABLE equipment_templates 
ADD COLUMN IF NOT EXISTS default_params JSONB DEFAULT '{}';

ALTER TABLE equipment_templates 
ADD COLUMN IF NOT EXISTS allow_component_template_ids UUID[] DEFAULT NULL;

-- –í—Ä–µ–º–µ–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º NOT NULL constraints –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
ALTER TABLE equipment_templates 
ALTER COLUMN name DROP NOT NULL;

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
SELECT column_name, data_type, is_nullable
FROM information_schema.columns 
WHERE table_name = 'equipment_templates'
ORDER BY ordinal_position;`
            
            const sqlContainer = document.createElement('div')
            sqlContainer.className = 'sql-container'
            sqlContainer.innerHTML = `
                <h3>üìù SQL –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:</h3>
                <button onclick="copySQL()" class="copy-btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL</button>
                <pre id="sqlCode">${sql}</pre>
                <div class="result warning">
                    <strong>‚ö†Ô∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
                    1. <a href="https://supabase.com/dashboard/project/tohtryzyffcebtyvkxwh/sql/new" target="_blank">–û—Ç–∫—Ä–æ–π—Ç–µ SQL —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤ Supabase</a><br>
                    2. –í—Å—Ç–∞–≤—å—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å<br>
                    3. –í–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–Ω–æ–≤–∞
                </div>
            `
            document.getElementById('results').insertBefore(sqlContainer, document.getElementById('results').firstChild)
        }
        
        window.copySQL = function() {
            const sqlCode = document.getElementById('sqlCode').textContent
            navigator.clipboard.writeText(sqlCode).then(() => {
                logResult('‚úÖ SQL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success')
            }).catch(err => {
                logResult('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error', err)
            })
        }
        
        window.testTableOperations = async function() {
            logResult('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–∞–±–ª–∏—Ü–µ–π...', 'info')
            
            // –¢–µ—Å—Ç SELECT
            try {
                const { data: selectData, error: selectError } = await supabase
                    .from('equipment_templates')
                    .select('*')
                    .limit(1)
                
                if (selectError) {
                    logResult('‚ùå SELECT –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'error', selectError)
                } else {
                    logResult('‚úÖ SELECT —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success')
                }
            } catch (err) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ SELECT', 'error', err)
            }
            
            // –¢–µ—Å—Ç INSERT (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
            try {
                const testData = {
                    name: `–¢–µ—Å—Ç ${Date.now()}`
                }
                
                const { data: insertData, error: insertError } = await supabase
                    .from('equipment_templates')
                    .insert([testData])
                    .select()
                
                if (insertError) {
                    logResult('‚ùå INSERT –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'error', insertError)
                    
                    // –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–∫–∏
                    if (insertError.message.includes('column')) {
                        const match = insertError.message.match(/Could not find the '(\w+)' column/)
                        if (match) {
                            logResult(`üí° –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∞: ${match[1]}`, 'warning')
                        }
                    }
                } else {
                    logResult('‚úÖ INSERT —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success', insertData)
                    
                    // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
                    if (insertData && insertData[0]) {
                        await supabase
                            .from('equipment_templates')
                            .delete()
                            .eq('id', insertData[0].id)
                        logResult('üóëÔ∏è –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'info')
                    }
                }
            } catch (err) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ INSERT', 'error', err)
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            checkCurrentStructure()
        })
    </script>
</body>
</html>