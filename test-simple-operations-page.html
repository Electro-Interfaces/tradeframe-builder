<!DOCTYPE html>
<html>
<head>
    <title>Simple Operations Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1e293b; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .stats { background: #0f172a; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .loading { color: #fbbf24; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        .operations-list { background: #0f172a; padding: 15px; border-radius: 8px; margin: 10px 0; max-height: 400px; overflow-y: auto; }
        .operation-item { background: #374151; margin: 5px 0; padding: 10px; border-radius: 4px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Simple Operations Test</h1>
        
        <button onclick="testApiDirectly()">1. –¢–µ—Å—Ç API –Ω–∞–ø—Ä—è–º—É—é</button>
        <button onclick="testWithConfig()">2. –¢–µ—Å—Ç —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π</button>
        <button onclick="loadOperationsSimple()">3. –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏</button>
        <button onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        
        <div class="stats" id="stats">
            <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        </div>
        
        <div class="operations-list" id="operations">
            <strong>–û–ø–µ—Ä–∞—Ü–∏–∏:</strong> –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        </div>
    </div>

    <script>
        let loadedOperations = [];
        
        function updateStats() {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `
                <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> 
                ${loadedOperations.length} –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                ${loadedOperations.length > 0 ? `
                <br>üìä –°—Ç–∞—Ç—É—Å—ã: ${[...new Set(loadedOperations.map(op => op.status))].join(', ')}
                <br>üèóÔ∏è –¢–æ–ø–ª–∏–≤–æ: ${[...new Set(loadedOperations.map(op => op.fuel_type || op.fuelType))].filter(f => f).join(', ')}
                ` : ''}
            `;
        }
        
        function updateOperationsList() {
            const operationsDiv = document.getElementById('operations');
            if (loadedOperations.length === 0) {
                operationsDiv.innerHTML = '<strong>–û–ø–µ—Ä–∞—Ü–∏–∏:</strong> –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                return;
            }
            
            const operationsHtml = loadedOperations.slice(0, 10).map(op => `
                <div class="operation-item">
                    <strong>ID:</strong> ${op.id}<br>
                    <strong>–¢–∏–ø:</strong> ${op.operation_type || op.operationType}<br>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> ${op.status}<br>
                    <strong>–ê–ó–°:</strong> ${op.trading_point_name || op.tradingPointName}<br>
                    <strong>–¢–æ–ø–ª–∏–≤–æ:</strong> ${op.fuel_type || op.fuelType}<br>
                    <strong>–°—É–º–º–∞:</strong> ${op.total_cost || op.totalCost} ‚ÇΩ
                </div>
            `).join('');
            
            operationsDiv.innerHTML = `
                <strong>–û–ø–µ—Ä–∞—Ü–∏–∏ (–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 10 –∏–∑ ${loadedOperations.length}):</strong>
                ${operationsHtml}
            `;
        }
        
        async function testApiDirectly() {
            console.log('üß™ Testing API directly...');
            try {
                const response = await fetch('http://localhost:3001/api/v1/operations?limit=10');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();
                loadedOperations = data.data || [];
                console.log('‚úÖ API test success:', loadedOperations.length, 'operations');
                updateStats();
                updateOperationsList();
            } catch (error) {
                console.error('‚ùå API test failed:', error);
                document.getElementById('stats').innerHTML = `<span class="error">‚ùå API –æ—à–∏–±–∫–∞: ${error.message}</span>`;
            }
        }
        
        async function testWithConfig() {
            console.log('üß™ Testing with config simulation...');
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º apiConfigService
            const mockConfig = {
                currentConnectionId: 'local-db',
                availableConnections: [
                    {
                        id: 'local-db',
                        name: '–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î',
                        url: 'http://localhost:3001/api/v1',
                        type: 'postgresql',
                        isActive: true
                    }
                ]
            };
            
            const currentConnection = mockConfig.availableConnections.find(
                conn => conn.id === mockConfig.currentConnectionId
            );
            const isMockMode = currentConnection?.type === 'mock' || !currentConnection;
            
            console.log('Config debug:', {
                isMockMode,
                connectionType: currentConnection?.type,
                apiUrl: currentConnection?.url
            });
            
            if (isMockMode) {
                document.getElementById('stats').innerHTML = '<span class="error">‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ mock —Ä–µ–∂–∏–º–µ!</span>';
                return;
            }
            
            // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫–∞–∫ –¥–µ–ª–∞–ª –±—ã operationsService
            try {
                const response = await fetch(`${currentConnection.url}/operations?limit=10000`);
                if (!response.ok) {
                    throw new Error(`Service API error: ${response.status}`);
                }
                const apiResponse = await response.json();
                
                // –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –≤ operationsService
                loadedOperations = apiResponse.data.map(item => ({
                    id: item.id,
                    operationType: item.operation_type,
                    status: item.status,
                    startTime: item.start_time,
                    endTime: item.end_time,
                    tradingPointName: item.trading_point_name,
                    fuelType: item.fuel_type,
                    quantity: item.quantity,
                    price: item.price,
                    totalCost: item.total_cost,
                    paymentMethod: item.payment_method,
                    details: item.details
                }));
                
                console.log('‚úÖ Service simulation success:', loadedOperations.length, 'operations');
                updateStats();
                updateOperationsList();
                
            } catch (error) {
                console.error('‚ùå Service simulation failed:', error);
                document.getElementById('stats').innerHTML = `<span class="error">‚ùå Service –æ—à–∏–±–∫–∞: ${error.message}</span>`;
            }
        }
        
        function loadOperationsSimple() {
            if (loadedOperations.length === 0) {
                document.getElementById('stats').innerHTML = '<span class="error">‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ (–∫–Ω–æ–ø–∫–∏ 1 –∏–ª–∏ 2)</span>';
                return;
            }
            
            console.log('üì¶ Simulating React component behavior...');
            console.log('Operations to display:', loadedOperations.length);
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∫–∞–∫ –≤ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
            const filteredOperations = loadedOperations.filter(record => {
                const excludedPaymentMethods = ['supplier_delivery', 'corporate_card', 'mobile_payment'];
                if (record.paymentMethod && excludedPaymentMethods.includes(record.paymentMethod)) {
                    return false;
                }
                return true;
            });
            
            console.log('Filtered operations:', filteredOperations.length);
            
            document.getElementById('stats').innerHTML = `
                <span class="success">‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é:</span><br>
                –í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π: ${loadedOperations.length}<br>
                –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: ${filteredOperations.length}<br>
                <span class="success">–î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ!</span>
            `;
            
            updateOperationsList();
        }
        
        function clearResults() {
            loadedOperations = [];
            document.getElementById('stats').innerHTML = '<strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã';
            document.getElementById('operations').innerHTML = '<strong>–û–ø–µ—Ä–∞—Ü–∏–∏:</strong> –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(testApiDirectly, 500);
    </script>
</body>
</html>