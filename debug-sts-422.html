<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug STS API 422 Error</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .error { background: #f44336; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { background: #2196F3; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #4CAF50; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .danger { background: #f44336; }
        pre {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        input, select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            margin: 5px;
        }
        .form-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group label {
            width: 150px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug STS API 422 Error</h1>
        
        <div class="info">
            –≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–º–æ–∂–µ—Ç –≤—ã—è—Å–Ω–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É –æ—à–∏–±–∫–∏ 422 —Å API –°–¢–°
        </div>
        
        <div class="form-group">
            <label>API URL:</label>
            <input type="text" id="apiUrl" value="https://pos.autooplata.ru/tms" placeholder="https://pos.autooplata.ru/tms">
        </div>
        
        <div class="form-group">
            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        </div>
        
        <div class="form-group">
            <label>–ü–∞—Ä–æ–ª—å:</label>
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
        </div>
        
        <div class="form-group">
            <label>–ù–æ–º–µ—Ä —Å–µ—Ç–∏:</label>
            <input type="text" id="systemId" placeholder="1" value="1">
        </div>
        
        <div class="form-group">
            <label>–ù–æ–º–µ—Ä —Å—Ç–∞–Ω—Ü–∏–∏:</label>
            <input type="text" id="stationId" placeholder="1" value="1">
        </div>

        <div style="margin: 20px 0;">
            <button onclick="loadFromLocalStorage()">üìã –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫</button>
            <button onclick="testLogin()">üîë –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
            <button onclick="testTanksNoParams()">‚õΩ –¢–µ—Å—Ç /v1/tanks –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</button>
            <button onclick="testTanksWithParams()">‚õΩ –¢–µ—Å—Ç /v1/tanks —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏</button>
            <button onclick="testAllMethods()">üß™ –¢–µ—Å—Ç –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤</button>
            <button onclick="clearLogs()" class="danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let token = null;
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({
                time: timestamp,
                message: message,
                type: type
            });
            updateDisplay();
            console.log(`[${timestamp}] ${message}`);
        }

        function updateDisplay() {
            const resultsDiv = document.getElementById('results');
            
            let html = '';
            
            if (logs.length > 0) {
                html += '<h2>üìù –õ–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:</h2>';
                logs.slice(-20).forEach(logEntry => {
                    const className = logEntry.type === 'error' ? 'error' : logEntry.type === 'success' ? 'success' : 'info';
                    html += `<div class="${className}">
                        <strong>[${logEntry.time}]</strong> ${logEntry.message}
                    </div>`;
                });
            }
            
            resultsDiv.innerHTML = html;
        }

        function loadFromLocalStorage() {
            try {
                const config = localStorage.getItem('sts-api-config');
                if (config) {
                    const parsed = JSON.parse(config);
                    document.getElementById('apiUrl').value = parsed.url || 'https://pos.autooplata.ru/tms';
                    document.getElementById('username').value = parsed.username || '';
                    document.getElementById('password').value = parsed.password || '';
                    
                    if (parsed.token) {
                        token = parsed.token;
                        log('‚úÖ –¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ localStorage', 'success');
                        log(`–¢–æ–∫–µ–Ω: ${token.substring(0, 20)}...`, 'info');
                    }
                    
                    log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage', 'success');
                } else {
                    log('‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage', 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const apiUrl = document.getElementById('apiUrl').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }
            
            try {
                log('üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...', 'info');
                log(`URL: ${apiUrl}/v1/login`, 'info');
                log(`–î–∞–Ω–Ω—ã–µ: ${JSON.stringify({username, password: '***'})}`, 'info');
                
                const response = await fetch(`${apiUrl}/v1/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                log(`–û—Ç–≤–µ—Ç: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const tokenData = await response.text();
                    token = tokenData.replace(/"/g, '');
                    log(`‚úÖ –ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω: ${token.substring(0, 30)}...`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }

        async function testTanksNoParams() {
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error');
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value;
            
            try {
                log('üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º /v1/tanks –ë–ï–ó –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤...', 'info');
                const url = `${apiUrl}/v1/tanks`;
                log(`URL: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`–û—Ç–≤–µ—Ç: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log(`–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞: ${responseText.substring(0, 500)}${responseText.length > 500 ? '...' : ''}`, response.ok ? 'success' : 'error');
                
                if (response.status === 422) {
                    try {
                        const errorData = JSON.parse(responseText);
                        log(`–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ 422:`, 'error');
                        log(`<pre>${JSON.stringify(errorData, null, 2)}</pre>`, 'error');
                    } catch (e) {
                        log(`–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—à–∏–±–∫—É 422 –∫–∞–∫ JSON`, 'error');
                    }
                }
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${error.message}`, 'error');
            }
        }

        async function testTanksWithParams() {
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error');
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value;
            const systemId = document.getElementById('systemId').value;
            const stationId = document.getElementById('stationId').value;
            
            try {
                log('üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º /v1/tanks –° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏...', 'info');
                const url = new URL(`${apiUrl}/v1/tanks`);
                
                if (systemId) {
                    url.searchParams.set('system', systemId);
                    log(`–î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä system=${systemId}`, 'info');
                }
                
                if (stationId) {
                    url.searchParams.set('station', stationId);
                    log(`–î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä station=${stationId}`, 'info');
                }
                
                log(`–§–∏–Ω–∞–ª—å–Ω—ã–π URL: ${url.toString()}`, 'info');
                
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`–û—Ç–≤–µ—Ç: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log(`–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞: ${responseText.substring(0, 500)}${responseText.length > 500 ? '...' : ''}`, response.ok ? 'success' : 'error');
                
                if (response.status === 422) {
                    try {
                        const errorData = JSON.parse(responseText);
                        log(`–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ 422:`, 'error');
                        log(`<pre>${JSON.stringify(errorData, null, 2)}</pre>`, 'error');
                        
                        if (errorData.detail && Array.isArray(errorData.detail)) {
                            errorData.detail.forEach(detail => {
                                log(`- –ü–æ–ª–µ: ${detail.loc?.join('.')} | –¢–∏–ø: ${detail.type} | –°–æ–æ–±—â–µ–Ω–∏–µ: ${detail.msg}`, 'error');
                            });
                        }
                    } catch (e) {
                        log(`–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—à–∏–±–∫—É 422 –∫–∞–∫ JSON`, 'error');
                    }
                }
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–æ ${Array.isArray(data) ? data.length : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤`, 'success');
                        if (Array.isArray(data) && data.length > 0) {
                            log(`–ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞:`, 'info');
                            log(`<pre>${JSON.stringify(data[0], null, 2)}</pre>`, 'info');
                        }
                    } catch (e) {
                        log(`–û—Ç–≤–µ—Ç –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –Ω–æ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω`, 'success');
                    }
                }
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${error.message}`, 'error');
            }
        }

        async function testAllMethods() {
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω', 'error');
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value;
            const systemId = document.getElementById('systemId').value;
            const stationId = document.getElementById('stationId').value;
            
            const methods = [
                '/v1/tanks',
                '/v1/pumps', 
                '/v1/sales',
                '/v1/prices'
            ];
            
            for (const method of methods) {
                try {
                    log(`üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º ${method}...`, 'info');
                    const url = new URL(`${apiUrl}${method}`);
                    
                    if (systemId) url.searchParams.set('system', systemId);
                    if (stationId) url.searchParams.set('station', stationId);
                    
                    log(`URL: ${url.toString()}`, 'info');
                    
                    const response = await fetch(url.toString(), {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    log(`${method}: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        if (response.status === 422) {
                            try {
                                const errorData = JSON.parse(errorText);
                                log(`–û—à–∏–±–∫–∞ 422 –¥–ª—è ${method}:`, 'error');
                                log(`<pre>${JSON.stringify(errorData, null, 2)}</pre>`, 'error');
                            } catch (e) {
                                log(`–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—à–∏–±–∫—É 422 –¥–ª—è ${method}`, 'error');
                            }
                        } else {
                            log(`–û—à–∏–±–∫–∞ ${method}: ${errorText.substring(0, 200)}`, 'error');
                        }
                    } else {
                        const responseText = await response.text();
                        log(`${method}: —É—Å–ø–µ—à–Ω–æ, —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ ${responseText.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'success');
                    }
                    
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è ${method}: ${error.message}`, 'error');
                }
            }
        }

        function clearLogs() {
            logs.length = 0;
            updateDisplay();
        }

        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = function() {
            loadFromLocalStorage();
        };
    </script>
</body>
</html>