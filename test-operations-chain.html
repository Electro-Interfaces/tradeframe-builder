<!DOCTYPE html>
<html>
<head>
    <title>Debug Operations Chain</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1e293b; color: #fff; }
        #results { background: #0f172a; padding: 20px; border-radius: 8px; max-height: 600px; overflow-y: auto; }
        pre { background: #374151; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .loading { color: #fbbf24; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warn { color: #f59e0b; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0; }
        button:hover { background: #2563eb; }
    </style>
</head>
<body>
    <h1>üîç Debug Operations Chain</h1>
    <button onclick="checkApiConfigService()">1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ApiConfigService</button>
    <button onclick="testDirectApiCall()">2. –¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ API</button>
    <button onclick="simulateOperationsService()">3. –°–∏–º—É–ª—è—Ü–∏—è OperationsService</button>
    <button onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å</button>
    
    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'loading' ? 'loading' : type === 'warn' ? 'warn' : '';
            resultsDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        function checkApiConfigService() {
            log('üîç Checking ApiConfigService configuration...', 'loading');
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É apiConfigService
            const initialConfig = {
                currentConnectionId: 'local-db',
                availableConnections: [
                    {
                        id: 'mock',
                        name: 'Mock Data (–î–µ–º–æ)',
                        url: 'localStorage',
                        type: 'mock',
                        isActive: false
                    },
                    {
                        id: 'local-db',
                        name: '–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î',
                        url: 'http://localhost:3001/api/v1',
                        type: 'postgresql',
                        isActive: true,
                        isDefault: true
                    }
                ]
            };
            
            const currentConnection = initialConfig.availableConnections.find(
                conn => conn.id === initialConfig.currentConnectionId
            );
            
            const isMockMode = currentConnection?.type === 'mock' || !currentConnection;
            const currentApiUrl = currentConnection?.url || 'mock';
            
            log(`‚úÖ ApiConfigService —Å–æ—Å—Ç–æ—è–Ω–∏–µ:`, 'success');
            log(`   - currentConnectionId: ${initialConfig.currentConnectionId}`);
            log(`   - currentConnection: ${currentConnection?.name} (${currentConnection?.type})`);
            log(`   - isMockMode: ${isMockMode}`);
            log(`   - currentApiUrl: ${currentApiUrl}`);
            
            if (isMockMode) {
                log('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: ApiConfigService –≤ MOCK —Ä–µ–∂–∏–º–µ!', 'warn');
            } else {
                log('‚úÖ ApiConfigService –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ API —Ä–µ–∂–∏–º', 'success');
            }
        }

        async function testDirectApiCall() {
            log('üß™ Testing direct API call...', 'loading');
            
            try {
                const response = await fetch('http://localhost:3001/api/v1/operations?limit=3');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                log(`‚úÖ Direct API call success! Got ${data.data?.length || 0} operations`, 'success');
                log(`   - success: ${data.success}`);
                log(`   - total in DB: ${data.pagination?.total || 'unknown'}`);
                log(`   - sample operation ID: ${data.data?.[0]?.id || 'none'}`);
                
            } catch (error) {
                log(`‚ùå Direct API call failed: ${error.message}`, 'error');
                log('   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001', 'warn');
            }
        }

        async function simulateOperationsService() {
            log('üß™ Simulating OperationsService.getAll()...', 'loading');
            
            try {
                // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                const isMockMode = false; // –∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ
                log(`1. isMockMode: ${isMockMode}`);
                
                if (isMockMode) {
                    log('   ‚ùå –°–µ—Ä–≤–∏—Å –ø–æ—à—ë–ª –±—ã –≤ getMockOperations()', 'warn');
                    return;
                }
                
                // –®–∞–≥ 2: API –∑–∞–ø—Ä–æ—Å
                log('2. –î–µ–ª–∞–µ–º API –∑–∞–ø—Ä–æ—Å...');
                const response = await fetch('http://localhost:3001/api/v1/operations?limit=10000');
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const apiResponse = await response.json();
                log(`   ‚úÖ API –æ—Ç–≤–µ—Ç–∏–ª —Å ${apiResponse.data?.length || 0} –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏`);
                
                // –®–∞–≥ 3: –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                log('3. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...');
                const transformedData = {
                    data: apiResponse.data.map(item => ({
                        id: item.id,
                        operationType: item.operation_type,
                        status: item.status,
                        startTime: item.start_time,
                        endTime: item.end_time,
                        duration: item.duration,
                        tradingPointId: item.trading_point_id,
                        tradingPointName: item.trading_point_name,
                        deviceId: item.device_id,
                        transactionId: item.transaction_id,
                        fuelType: item.fuel_type,
                        quantity: item.quantity,
                        price: item.price,
                        totalCost: item.total_cost,
                        paymentMethod: item.payment_method,
                        details: item.details,
                        progress: item.progress,
                        operatorName: item.operator_name,
                        customerId: item.customer_id,
                        vehicleNumber: item.vehicle_number
                    })),
                    pagination: apiResponse.pagination,
                    summary: apiResponse.summary
                };
                
                log(`   ‚úÖ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ ${transformedData.data.length} –æ–ø–µ—Ä–∞—Ü–∏–π`);
                
                // –®–∞–≥ 4: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ data –¥–ª—è getAll()
                const finalData = transformedData.data;
                log(`4. getAll() –≤–µ—Ä–Ω—É–ª –±—ã ${finalData.length} –æ–ø–µ—Ä–∞—Ü–∏–π`);
                
                log(`‚úÖ –í—Å—è —Ü–µ–ø–æ—á–∫–∞ OperationsService —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!`, 'success');
                log(`   –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤–∏–¥–Ω—ã –≤ UI, –ø—Ä–æ–±–ª–µ–º–∞ –≤ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ`, 'warn');
                
            } catch (error) {
                log(`‚ùå OperationsService simulation failed: ${error.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(() => {
            checkApiConfigService();
            setTimeout(testDirectApiCall, 1000);
        }, 500);
    </script>
</body>
</html>