<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —Ä–æ–ª–µ–π</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            color: white;
            font-weight: bold;
            margin-left: 10px;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .warning { background: #ff9800; }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a8b;
        }
        .log {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —Ä–æ–ª–µ–π –≤ Supabase</h1>

        <div class="section">
            <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
            <button onclick="checkSettings()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <div id="settings-result"></div>
        </div>

        <div class="section">
            <h3>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã roles</h3>
            <button onclick="checkRolesTable()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É roles</button>
            <div id="roles-result"></div>
        </div>

        <div class="section">
            <h3>3. –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–æ–ª–µ–π</h3>
            <button onclick="listRoles()">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–æ–ª–∏</button>
            <div id="roles-list"></div>
        </div>

        <div class="section">
            <h3>4. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Ä–æ–ª—å</h3>
            <button onclick="createTestRole()">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Ä–æ–ª—å</button>
            <div id="create-result"></div>
        </div>

        <div class="section">
            <h3>5. –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <div id="log" class="log">–ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–æ–ª–µ–π...\n</div>
        </div>
    </div>

    <script>
        let supabaseUrl = '';
        let supabaseKey = '';

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '–õ–æ–≥ –æ—á–∏—â–µ–Ω...\n';
        }

        function checkSettings() {
            log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
            const resultEl = document.getElementById('settings-result');
            
            try {
                const savedSettings = localStorage.getItem('externalDatabase');
                if (!savedSettings) {
                    resultEl.innerHTML = '<span class="status error">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</span>';
                    log('ERROR: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ externalDatabase –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage');
                    return;
                }

                const parsed = JSON.parse(savedSettings);
                log(`–ù–∞–π–¥–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: URL=${parsed.url}, hasApiKey=${!!parsed.apiKey}`);
                
                if (!parsed.url || !parsed.apiKey) {
                    resultEl.innerHTML = '<span class="status warning">–ù–µ–ø–æ–ª–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>';
                    log('WARNING: URL –∏–ª–∏ apiKey –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç');
                } else {
                    resultEl.innerHTML = '<span class="status success">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–π–¥–µ–Ω—ã</span>';
                    supabaseUrl = parsed.url;
                    supabaseKey = parsed.apiKey;
                    log('SUCCESS: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã');
                }
            } catch (error) {
                resultEl.innerHTML = '<span class="status error">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞</span>';
                log(`ERROR: –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${error.message}`);
            }
        }

        async function checkRolesTable() {
            const resultEl = document.getElementById('roles-result');
            
            if (!supabaseUrl || !supabaseKey) {
                resultEl.innerHTML = '<span class="status error">–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>';
                return;
            }

            log('–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã roles...');
            resultEl.innerHTML = '<span class="status warning">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>';

            try {
                const response = await fetch(`${supabaseUrl}/rest/v1/roles?limit=0`, {
                    method: 'GET',
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    resultEl.innerHTML = '<span class="status success">–¢–∞–±–ª–∏—Ü–∞ roles —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</span>';
                    log('SUCCESS: –¢–∞–±–ª–∏—Ü–∞ roles –¥–æ—Å—Ç—É–ø–Ω–∞');
                } else {
                    const errorText = await response.text();
                    resultEl.innerHTML = '<span class="status error">–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</span>';
                    log(`ERROR: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                resultEl.innerHTML = '<span class="status error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</span>';
                log(`ERROR: Network error: ${error.message}`);
            }
        }

        async function listRoles() {
            const resultEl = document.getElementById('roles-list');
            
            if (!supabaseUrl || !supabaseKey) {
                resultEl.innerHTML = '<span class="status error">–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>';
                return;
            }

            log('–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π...');
            resultEl.innerHTML = '<span class="status warning">–ó–∞–≥—Ä—É–∑–∫–∞...</span>';

            try {
                const response = await fetch(`${supabaseUrl}/rest/v1/roles?order=created_at.desc`, {
                    method: 'GET',
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const roles = await response.json();
                    resultEl.innerHTML = `<span class="status success">–ù–∞–π–¥–µ–Ω–æ —Ä–æ–ª–µ–π: ${roles.length}</span>`;
                    log(`SUCCESS: –ü–æ–ª—É—á–µ–Ω–æ ${roles.length} —Ä–æ–ª–µ–π:`);
                    
                    if (roles.length === 0) {
                        log('- –†–æ–ª–µ–π –Ω–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                    } else {
                        roles.forEach(role => {
                            log(`- ${role.name} (${role.code}) - ${role.scope} - ${role.is_active ? '–∞–∫—Ç–∏–≤–Ω–∞' : '–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞'}`);
                        });
                    }
                } else {
                    const errorText = await response.text();
                    resultEl.innerHTML = '<span class="status error">–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞</span>';
                    log(`ERROR: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                resultEl.innerHTML = '<span class="status error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</span>';
                log(`ERROR: Network error: ${error.message}`);
            }
        }

        async function createTestRole() {
            const resultEl = document.getElementById('create-result');
            
            if (!supabaseUrl || !supabaseKey) {
                resultEl.innerHTML = '<span class="status error">–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>';
                return;
            }

            log('–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Ä–æ–ª—å...');
            resultEl.innerHTML = '<span class="status warning">–°–æ–∑–¥–∞–Ω–∏–µ...</span>';

            const testRole = {
                code: 'test_role',
                name: '–¢–µ—Å—Ç–æ–≤–∞—è —Ä–æ–ª—å',
                description: '–†–æ–ª—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è',
                scope: 'global',
                permissions: [{ section: 'test', resource: 'test', actions: ['read'] }],
                is_system: false,
                is_active: true
            };

            try {
                const response = await fetch(`${supabaseUrl}/rest/v1/roles`, {
                    method: 'POST',
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(testRole)
                });

                if (response.ok) {
                    const createdRole = await response.json();
                    resultEl.innerHTML = '<span class="status success">–¢–µ—Å—Ç–æ–≤–∞—è —Ä–æ–ª—å —Å–æ–∑–¥–∞–Ω–∞</span>';
                    log(`SUCCESS: –°–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è —Ä–æ–ª—å: ${JSON.stringify(createdRole[0], null, 2)}`);
                } else {
                    const errorText = await response.text();
                    resultEl.innerHTML = '<span class="status error">–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è</span>';
                    log(`ERROR: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                resultEl.innerHTML = '<span class="status error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</span>';
                log(`ERROR: Network error: ${error.message}`);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...');
            checkSettings();
        };
    </script>
</body>
</html>