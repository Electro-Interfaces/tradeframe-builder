<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>üöÄ Supabase Integration Test</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff; margin: 0; padding: 20px; min-height: 100vh;
        }
        .container { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
            padding: 25px; 
            margin: 15px 0; 
            border-radius: 15px; 
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 { 
            text-align: center; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        h3 { 
            color: #ffd700; 
            border-bottom: 2px solid rgba(255,215,0,0.3); 
            padding-bottom: 8px;
            margin-bottom: 20px;
        }
        button { 
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white; border: none; 
            padding: 12px 24px; border-radius: 8px; 
            cursor: pointer; margin: 8px; font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        button.primary { background: linear-gradient(45deg, #2196F3, #0b7dda); }
        button.success { background: linear-gradient(45deg, #4CAF50, #45a049); }
        button.warning { background: linear-gradient(45deg, #FF9800, #f57c00); }
        button.danger { background: linear-gradient(45deg, #f44336, #d32f2f); }
        .log { 
            background: rgba(0,0,0,0.6); 
            padding: 20px; border-radius: 10px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            white-space: pre-wrap; margin-top: 15px;
            max-height: 400px; overflow-y: auto;
            border-left: 4px solid #4CAF50;
        }
        .success { color: #4CAF50; font-weight: 600; }
        .error { color: #f44336; font-weight: 600; }
        .warning { color: #FF9800; font-weight: 600; }
        .info { color: #2196F3; }
        .highlight { color: #ffd700; font-weight: 600; }
        pre { 
            background: rgba(0,0,0,0.4); 
            padding: 15px; border-radius: 8px; 
            overflow-x: auto; margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üöÄ Supabase Integration Test</h1>
    <p style="text-align: center; font-size: 1.1em; margin-bottom: 30px;">
        –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Service Role Key
    </p>

    <div class="container">
        <h3>üîß 1. Connection Test</h3>
        <button class="primary" onclick="testConnection()">Test Connection</button>
        <div id="connection-result" class="log"></div>
    </div>

    <div class="container">
        <h3>üìã 2. Equipment Templates Test</h3>
        <button class="success" onclick="testEquipmentTemplates()">List Templates</button>
        <button class="warning" onclick="testCreateTemplate()">Create Template</button>
        <div id="templates-result" class="log"></div>
    </div>

    <div class="container">
        <h3>‚öôÔ∏è 3. Equipment CRUD Test</h3>
        <button class="success" onclick="testEquipmentList()">List Equipment</button>
        <button class="warning" onclick="testCreateEquipment()">Create Equipment</button>
        <div id="equipment-result" class="log"></div>
    </div>

    <div class="container">
        <h3>üéØ 4. Full Integration Test</h3>
        <button class="primary" onclick="runFullTest()" style="font-size: 1.1em; padding: 15px 30px;">
            üöÄ RUN COMPLETE TEST
        </button>
        <div id="full-result" class="log"></div>
    </div>

    <script>
        const SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';
        const URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';

        function log(containerId, msg, type = 'info') {
            const div = document.getElementById(containerId);
            const time = new Date().toLocaleTimeString();
            const className = type;
            div.innerHTML += `<span class="${className}">[${time}] ${msg}</span>\n`;
            div.scrollTop = div.scrollHeight;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function testConnection() {
            const containerId = 'connection-result';
            document.getElementById(containerId).innerHTML = '';
            log(containerId, 'üîç Testing Supabase connection...', 'info');

            try {
                const response = await fetch(`${URL}/rest/v1/`, {
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`
                    }
                });

                if (response.ok) {
                    log(containerId, '‚úÖ Connection successful!', 'success');
                    log(containerId, `Status: ${response.status} ${response.statusText}`, 'info');
                    
                    // Test table access
                    const tablesResponse = await fetch(`${URL}/rest/v1/equipment_templates?limit=1`, {
                        headers: { 'apikey': SERVICE_KEY, 'Authorization': `Bearer ${SERVICE_KEY}` }
                    });
                    
                    if (tablesResponse.ok) {
                        log(containerId, '‚úÖ Table access confirmed!', 'success');
                        const data = await tablesResponse.json();
                        log(containerId, `Sample data: ${data.length} records`, 'info');
                    } else {
                        log(containerId, '‚ùå Table access failed', 'error');
                    }
                    
                } else {
                    log(containerId, `‚ùå Connection failed: ${response.status}`, 'error');
                }
            } catch (error) {
                log(containerId, `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testEquipmentTemplates() {
            const containerId = 'templates-result';
            document.getElementById(containerId).innerHTML = '';
            log(containerId, 'üìã Testing equipment templates...', 'info');

            try {
                const response = await fetch(`${URL}/rest/v1/equipment_templates?limit=5`, {
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`
                    }
                });

                if (response.ok) {
                    const templates = await response.json();
                    log(containerId, `‚úÖ Found ${templates.length} equipment templates`, 'success');
                    
                    templates.forEach((template, index) => {
                        log(containerId, `  ${index + 1}. ${template.name} (${template.system_type})`, 'info');
                        log(containerId, `     ID: ${template.id}`, 'info');
                        log(containerId, `     Active: ${template.is_active}`, 'info');
                    });
                    
                    log(containerId, '\nüìä Schema validation:', 'highlight');
                    const firstTemplate = templates[0];
                    if (firstTemplate) {
                        const hasIsActive = firstTemplate.hasOwnProperty('is_active');
                        const hasStatus = firstTemplate.hasOwnProperty('status');
                        log(containerId, `  ‚úì has is_active: ${hasIsActive}`, hasIsActive ? 'success' : 'error');
                        log(containerId, `  ‚úì has status: ${hasStatus}`, !hasStatus ? 'success' : 'warning');
                        log(containerId, `  ‚úì Schema is correct!`, 'success');
                    }
                } else {
                    log(containerId, `‚ùå Failed: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log(containerId, `Error: ${errorText}`, 'error');
                }
            } catch (error) {
                log(containerId, `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testCreateTemplate() {
            const containerId = 'templates-result';
            log(containerId, '\nüîß Testing CREATE template...', 'warning');

            const templateId = generateUUID();
            const payload = {
                id: templateId,
                name: 'Integration Test Template',
                technical_code: 'INT_TEST_' + Date.now(),
                system_type: 'test',
                is_active: true, // ‚úÖ Correct field name!
                description: 'Created by integration test',
                default_params: {
                    test: true,
                    created_at: new Date().toISOString()
                }
            };

            try {
                log(containerId, 'Payload:', 'info');
                log(containerId, JSON.stringify(payload, null, 2), 'info');

                const response = await fetch(`${URL}/rest/v1/equipment_templates`, {
                    method: 'POST',
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    log(containerId, 'üéâ CREATE SUCCESS!', 'success');
                    log(containerId, `Created: ${result[0]?.name}`, 'success');
                    log(containerId, `ID: ${result[0]?.id}`, 'success');
                    
                    // Cleanup after success
                    setTimeout(async () => {
                        try {
                            await fetch(`${URL}/rest/v1/equipment_templates?id=eq.${templateId}`, {
                                method: 'DELETE',
                                headers: { 'apikey': SERVICE_KEY, 'Authorization': `Bearer ${SERVICE_KEY}` }
                            });
                            log(containerId, 'üßπ Test template cleaned up', 'info');
                        } catch (e) {
                            log(containerId, '‚ö†Ô∏è Cleanup failed (not critical)', 'warning');
                        }
                    }, 2000);
                    
                } else {
                    log(containerId, `‚ùå CREATE failed: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log(containerId, `Error: ${errorText}`, 'error');
                }
            } catch (error) {
                log(containerId, `‚ùå CREATE error: ${error.message}`, 'error');
            }
        }

        async function testEquipmentList() {
            const containerId = 'equipment-result';
            document.getElementById(containerId).innerHTML = '';
            log(containerId, '‚öôÔ∏è Testing equipment list...', 'info');

            try {
                const response = await fetch(`${URL}/rest/v1/equipment?limit=5`, {
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`
                    }
                });

                if (response.ok) {
                    const equipment = await response.json();
                    log(containerId, `‚úÖ Found ${equipment.length} equipment items`, 'success');
                    
                    equipment.forEach((item, index) => {
                        log(containerId, `  ${index + 1}. ${item.name}`, 'info');
                        log(containerId, `     Active: ${item.is_active}`, 'info');
                    });
                    
                    if (equipment.length === 0) {
                        log(containerId, 'üìã Equipment table is empty (expected for new setup)', 'warning');
                    }
                } else {
                    log(containerId, `‚ùå Failed: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log(containerId, `Error: ${errorText}`, 'error');
                }
            } catch (error) {
                log(containerId, `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testCreateEquipment() {
            const containerId = 'equipment-result';
            log(containerId, '\nüîß Testing CREATE equipment...', 'warning');

            // First, get a template ID
            try {
                const templatesResponse = await fetch(`${URL}/rest/v1/equipment_templates?limit=1`, {
                    headers: { 'apikey': SERVICE_KEY, 'Authorization': `Bearer ${SERVICE_KEY}` }
                });

                if (!templatesResponse.ok) {
                    log(containerId, '‚ùå No templates available for equipment creation', 'error');
                    return;
                }

                const templates = await templatesResponse.json();
                if (templates.length === 0) {
                    log(containerId, '‚ùå No templates found - cannot create equipment', 'error');
                    return;
                }

                const templateId = templates[0].id;
                log(containerId, `Using template: ${templates[0].name}`, 'info');

                const equipmentId = generateUUID();
                const payload = {
                    id: equipmentId,
                    name: 'Integration Test Equipment',
                    template_id: templateId,
                    trading_point_id: generateUUID(), // Mock trading point ID
                    is_active: true, // ‚úÖ Correct field name!
                    config: {
                        test: true,
                        integration_test: true
                    },
                    description: 'Created by integration test'
                };

                log(containerId, 'Equipment payload:', 'info');
                log(containerId, JSON.stringify(payload, null, 2), 'info');

                const response = await fetch(`${URL}/rest/v1/equipment`, {
                    method: 'POST',
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    log(containerId, 'üéâ EQUIPMENT CREATE SUCCESS!', 'success');
                    log(containerId, `Created: ${result[0]?.name}`, 'success');
                    
                    // Cleanup
                    setTimeout(async () => {
                        try {
                            await fetch(`${URL}/rest/v1/equipment?id=eq.${equipmentId}`, {
                                method: 'DELETE',
                                headers: { 'apikey': SERVICE_KEY, 'Authorization': `Bearer ${SERVICE_KEY}` }
                            });
                            log(containerId, 'üßπ Test equipment cleaned up', 'info');
                        } catch (e) {
                            log(containerId, '‚ö†Ô∏è Cleanup failed (not critical)', 'warning');
                        }
                    }, 2000);
                    
                } else {
                    log(containerId, `‚ùå Equipment CREATE failed: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log(containerId, `Error: ${errorText}`, 'error');
                }

            } catch (error) {
                log(containerId, `‚ùå Equipment CREATE error: ${error.message}`, 'error');
            }
        }

        async function runFullTest() {
            const containerId = 'full-result';
            document.getElementById(containerId).innerHTML = '';
            log(containerId, 'üöÄ Running complete integration test...', 'highlight');
            
            let successCount = 0;
            const tests = [
                { name: 'Connection', func: testConnection },
                { name: 'Templates List', func: testEquipmentTemplates },
                { name: 'Template CREATE', func: testCreateTemplate },
                { name: 'Equipment List', func: testEquipmentList }
            ];

            for (const test of tests) {
                try {
                    log(containerId, `\nüîç Running: ${test.name}...`, 'info');
                    await test.func();
                    log(containerId, `‚úÖ ${test.name}: PASSED`, 'success');
                    successCount++;
                } catch (error) {
                    log(containerId, `‚ùå ${test.name}: FAILED`, 'error');
                    log(containerId, `Error: ${error.message}`, 'error');
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            const successRate = (successCount / tests.length) * 100;
            
            log(containerId, `\nüéØ FINAL RESULT:`, 'highlight');
            log(containerId, `Success Rate: ${successRate.toFixed(1)}% (${successCount}/${tests.length})`, 
                successRate >= 75 ? 'success' : 'warning');
            
            if (successRate >= 75) {
                log(containerId, '\nüéâ INTEGRATION SUCCESS!', 'success');
                log(containerId, '‚úÖ Supabase integration is working properly', 'success');
                log(containerId, '‚úÖ Service Role Key provides full access', 'success');
                log(containerId, '‚úÖ Schema corrections applied successfully', 'success');
                log(containerId, '‚úÖ Ready for production deployment!', 'success');
                
                log(containerId, '\nüìã Next Steps:', 'highlight');
                log(containerId, '1. Update project services to use Supabase', 'info');
                log(containerId, '2. Configure production environment variables', 'info');
                log(containerId, '3. Run full application tests', 'info');
            } else {
                log(containerId, '\n‚ö†Ô∏è Integration has issues - review logs above', 'warning');
            }
        }

        // Auto-run basic test
        setTimeout(() => {
            testConnection();
        }, 1000);
    </script>
</body>
</html>