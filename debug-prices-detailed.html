<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ API —Ü–µ–Ω</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1e1e1e; 
            color: #fff; 
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .success { color: #4ade80; background: #166534; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { color: #f87171; background: #991b1b; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { color: #60a5fa; background: #1e3a8a; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .warning { color: #fbbf24; background: #713f12; padding: 10px; border-radius: 5px; margin: 10px 0; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 5px; 
        }
        button:hover { background: #2563eb; }
        pre { 
            background: #2d2d2d; 
            padding: 10px; 
            border-radius: 5px; 
            overflow-x: auto; 
            font-size: 12px;
            line-height: 1.4;
        }
        .fuel-card { 
            background: #2d2d2d; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid #3b82f6; 
        }
        .comparison { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin: 20px 0; 
        }
        .json-viewer {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        .json-header {
            background: #333;
            padding: 10px;
            border-bottom: 1px solid #444;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ API —Ü–µ–Ω</h1>
        
        <div class="info">
            <h3>–°–∏—Å—Ç–µ–º–∞: 15, –°—Ç–∞–Ω—Ü–∏—è: 4 (–ê–ó–° ‚Ññ4)</h3>
            <p>–û–∂–∏–¥–∞–µ–º: –ê–ò-92, –ê–ò-95, –î–¢ (3 –≤–∏–¥–∞ —Ç–æ–ø–ª–∏–≤–∞)</p>
        </div>

        <div style="margin: 20px 0;">
            <button onclick="testAllEndpoints()">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ endpoints</button>
            <button onclick="testSpecificFormat()">üî¨ –ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑</button>
            <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div id="results"></div>
    </div>

    <script type="module">
        function getConfig() {
            try {
                const stored = localStorage.getItem('tradingNetworkConfig');
                if (stored) {
                    const config = JSON.parse(stored);
                    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ localStorage:', config);
                    return config;
                }
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ localStorage:', e);
            }
            
            return {
                baseUrl: 'https://pos.autooplata.ru/tms',
                username: 'UserApi',
                password: 'lHQfLZHzB3tn',
                authType: 'basic'
            };
        }
        
        async function getAuthToken() {
            const config = getConfig();
            
            if (config.authType === 'basic' && config.username && config.password) {
                const authResponse = await fetch(`${config.baseUrl}/v1/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: config.username,
                        password: config.password
                    })
                });
                
                if (authResponse.ok) {
                    const authData = await authResponse.json();
                    return authData.token || authData.access_token;
                }
            }
            
            return config.apiKey || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2dpbiI6eyJpZCI6IjYxODkwODMxLUQxNEYtNDY0MC05OUFDLUUxMTIzQTZFNDQzOCIsIm5hbWUiOiJVc2VyQXBpIiwicm9sZSI6MH0sInVzZXIiOnsiaWQiOiI2MTg5MDgzMS1EMTRGLTQ2NDAtOTlBQy1FMTEyM0E2RTQ0MzgiLCJuYW1lIjoiVXNlckFwaSJ9LCJleHAiOjE3NTczMTc5NTR9.fXqRyv-d7cotjD_YcDwSMB5Y9SXVCQB2LN1LXbCzsB8';
        }
        
        async function makeAPIRequest(endpoint, params = {}) {
            const config = getConfig();
            const token = await getAuthToken();
            
            const url = new URL(`${config.baseUrl}${endpoint}`);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            console.log('üåê –ó–∞–ø—Ä–æ—Å –∫:', url.toString());
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });
            
            const responseText = await response.text();
            let data;
            
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                data = responseText;
            }
            
            return {
                status: response.status,
                ok: response.ok,
                data: data,
                headers: Object.fromEntries(response.headers.entries()),
                url: url.toString()
            };
        }

        window.testAllEndpoints = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ endpoints...</div>';
            
            const endpoints = [
                { path: '/v1/prices', name: '–û—Å–Ω–æ–≤–Ω–æ–π prices endpoint' },
                { path: '/v1/fuel-prices', name: '–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π fuel-prices' },
                { path: '/v1/fuels', name: '–í–æ–∑–º–æ–∂–Ω—ã–π fuels endpoint' },
                { path: '/v1/stations/4/prices', name: '–ü—Ä—è–º–æ–π –ø—É—Ç—å –∫ —Å—Ç–∞–Ω—Ü–∏–∏' },
                { path: '/v1/systems/15/stations/4/prices', name: '–ü–æ–ª–Ω—ã–π –ø—É—Ç—å' }
            ];

            let html = '<div class="success"><h3>üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è endpoints</h3></div>';

            for (const endpoint of endpoints) {
                try {
                    console.log(`üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º: ${endpoint.path}`);
                    const response = await makeAPIRequest(endpoint.path, {
                        system: '15',
                        station: '4'
                    });

                    html += `
                        <div class="json-viewer">
                            <div class="json-header">
                                üìç ${endpoint.name}: ${endpoint.path}
                                <span style="float: right; color: ${response.ok ? '#4ade80' : '#f87171'}">
                                    ${response.status}
                                </span>
                            </div>
                            <div style="padding: 15px;">
                                <p><strong>URL:</strong> ${response.url}</p>
                                ${response.ok ? `
                                    <p><strong>–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:</strong> ${Array.isArray(response.data) ? '–ú–∞—Å—Å–∏–≤' : typeof response.data}</p>
                                    ${Array.isArray(response.data) ? `<p><strong>–≠–ª–µ–º–µ–Ω—Ç–æ–≤:</strong> ${response.data.length}</p>` : ''}
                                    <details>
                                        <summary style="cursor: pointer; color: #60a5fa;">üìã –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç</summary>
                                        <pre>${JSON.stringify(response.data, null, 2)}</pre>
                                    </details>
                                    ${analyzeFuelData(response.data)}
                                ` : `
                                    <div class="error">‚ùå –û—à–∏–±–∫–∞: ${JSON.stringify(response.data)}</div>
                                `}
                            </div>
                        </div>
                    `;

                } catch (error) {
                    html += `
                        <div class="json-viewer">
                            <div class="json-header" style="background: #991b1b;">
                                ‚ùå ${endpoint.name}: ${endpoint.path}
                            </div>
                            <div style="padding: 15px;">
                                <div class="error">–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}</div>
                            </div>
                        </div>
                    `;
                }
            }

            results.innerHTML = html;
        };

        window.testSpecificFormat = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">üî¨ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';

            try {
                const response = await makeAPIRequest('/v1/prices', {
                    system: '15',
                    station: '4'
                });

                if (response.ok) {
                    const analysis = analyzeDataStructure(response.data);
                    const fuelInfo = simulateParsing(response.data);

                    results.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –æ—Ç API</h3>
                        </div>
                        
                        <div class="comparison">
                            <div class="json-viewer">
                                <div class="json-header">üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                                <div style="padding: 15px;">
                                    ${analysis}
                                </div>
                            </div>
                            
                            <div class="json-viewer">
                                <div class="json-header">‚öôÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞</div>
                                <div style="padding: 15px;">
                                    ${fuelInfo}
                                </div>
                            </div>
                        </div>

                        <div class="json-viewer">
                            <div class="json-header">üîç –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç API</div>
                            <div style="padding: 15px;">
                                <pre>${JSON.stringify(response.data, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                } else {
                    results.innerHTML = `<div class="error">‚ùå API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${response.status}</div>`;
                }
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ${error.message}</div>`;
            }
        };

        function analyzeFuelData(data) {
            let analysis = '<div style="margin-top: 15px; padding: 10px; background: #2d2d2d; border-radius: 5px;">';
            analysis += '<h4 style="color: #fbbf24; margin: 0 0 10px 0;">üîç –ê–Ω–∞–ª–∏–∑ —Ç–æ–ø–ª–∏–≤–∞:</h4>';

            const fuelTypes = extractAllPossibleFuelTypes(data);
            analysis += `<p><strong>–ù–∞–π–¥–µ–Ω–æ –≤–∏–¥–æ–≤ —Ç–æ–ø–ª–∏–≤–∞:</strong> ${fuelTypes.length}</p>`;
            
            if (fuelTypes.length > 0) {
                analysis += '<ul style="margin: 10px 0; padding-left: 20px;">';
                fuelTypes.forEach(fuel => {
                    analysis += `<li style="color: #4ade80;">${fuel}</li>`;
                });
                analysis += '</ul>';
            }

            analysis += '</div>';
            return analysis;
        }

        function extractAllPossibleFuelTypes(data) {
            const fuelTypes = new Set();

            if (Array.isArray(data)) {
                data.forEach(item => {
                    // –ò—â–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–ª—è —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Ç–æ–ø–ª–∏–≤–∞
                    const possibleNames = [
                        item.fuel_name, item.fuel_type, item.name, item.type,
                        item.product_name, item.product, item.fuel, item.title
                    ];
                    possibleNames.forEach(name => {
                        if (name && typeof name === 'string') {
                            fuelTypes.add(name);
                        }
                    });
                });
            } else if (typeof data === 'object' && data) {
                // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                if (data.fuels && Array.isArray(data.fuels)) {
                    data.fuels.forEach(fuel => {
                        const name = fuel.name || fuel.fuel_name || fuel.type;
                        if (name) fuelTypes.add(name);
                    });
                } else if (data.prices && Array.isArray(data.prices)) {
                    data.prices.forEach(price => {
                        const name = price.fuel_name || price.fuel_type || price.name;
                        if (name) fuelTypes.add(name);
                    });
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–∞–º–∏ –∫–∞–∫ –≤–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞
                    Object.keys(data).forEach(key => {
                        if (typeof data[key] === 'object' || typeof data[key] === 'number') {
                            fuelTypes.add(key);
                        }
                    });
                }
            }

            return Array.from(fuelTypes);
        }

        function analyzeDataStructure(data) {
            let html = '';
            
            html += `<p><strong>–¢–∏–ø:</strong> ${Array.isArray(data) ? '–ú–∞—Å—Å–∏–≤' : typeof data}</p>`;
            
            if (Array.isArray(data)) {
                html += `<p><strong>–î–ª–∏–Ω–∞:</strong> ${data.length}</p>`;
                if (data.length > 0) {
                    html += `<p><strong>–ö–ª—é—á–∏ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞:</strong></p>`;
                    html += `<ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">`;
                    Object.keys(data[0]).forEach(key => {
                        html += `<li>${key}: ${typeof data[0][key]}</li>`;
                    });
                    html += `</ul>`;
                }
            } else if (typeof data === 'object' && data) {
                html += `<p><strong>–ö–ª—é—á–∏ –æ–±—ä–µ–∫—Ç–∞:</strong></p>`;
                html += `<ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">`;
                Object.keys(data).forEach(key => {
                    html += `<li>${key}: ${Array.isArray(data[key]) ? `–º–∞—Å—Å–∏–≤(${data[key].length})` : typeof data[key]}</li>`;
                });
                html += `</ul>`;
            }

            return html;
        }

        function simulateParsing(data) {
            // –°–∏–º—É–ª—è—Ü–∏—è –ª–æ–≥–∏–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏–∑ pricesSupabaseService.ts
            const fuelTypesInfo = [];
            
            let html = '<div style="font-size: 14px;">';

            if (Array.isArray(data)) {
                html += '<p><strong>üîÑ –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞–∫ –º–∞—Å—Å–∏–≤:</strong></p>';
                data.forEach((item, index) => {
                    const fuel_name = item.fuel_name || item.fuel_type || `–¢–æ–ø–ª–∏–≤–æ ${item.fuel_id || item.id}`;
                    html += `<p style="color: #4ade80; margin: 5px 0;">–≠–ª–µ–º–µ–Ω—Ç ${index + 1}: ${fuel_name}</p>`;
                    fuelTypesInfo.push(fuel_name);
                });
            } else if (typeof data === 'object' && data && data.fuels) {
                html += '<p><strong>üîÑ –ü–∞—Ä—Å–∏–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ —Å fuels:</strong></p>';
                if (Array.isArray(data.fuels)) {
                    data.fuels.forEach((fuel, index) => {
                        const name = fuel.name || fuel.fuel_name || fuel.type;
                        html += `<p style="color: #4ade80; margin: 5px 0;">–¢–æ–ø–ª–∏–≤–æ ${index + 1}: ${name}</p>`;
                        fuelTypesInfo.push(name);
                    });
                }
            } else if (typeof data === 'object' && data) {
                html += '<p><strong>üîÑ –ü–∞—Ä—Å–∏–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –∫–ª—é—á–∞–º:</strong></p>';
                Object.entries(data).forEach(([key, value]) => {
                    if (typeof value === 'number' || (value && typeof value.price === 'number')) {
                        html += `<p style="color: #4ade80; margin: 5px 0;">–ö–ª—é—á: ${key}</p>`;
                        fuelTypesInfo.push(key);
                    }
                });
            }

            html += `<p style="margin-top: 15px;"><strong>–ò—Ç–æ–≥–æ –Ω–∞–π–¥–µ–Ω–æ:</strong> ${fuelTypesInfo.length} –≤–∏–¥–æ–≤</p>`;
            html += '</div>';

            return html;
        }

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        window.addEventListener('load', () => {
            testAllEndpoints();
        });
    </script>
</body>
</html>