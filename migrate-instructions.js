/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä—è–º–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏–∑ localStorage –≤ Supabase
 */

import { createClient } from '@supabase/supabase-js';
import { randomUUID } from 'crypto';

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
const supabaseUrl = 'https://ssvazdgnmatbdynkhkqo.supabase.co';
const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdmF6ZGdubWF0YmR5bmtoa3FvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzM0MzgzNCwiZXhwIjoyMDcyOTE5ODM0fQ.Gen-PI-vDkKjskpIvJNcQw0Uj3d0zGXB98zIxNK6di0';

const supabase = createClient(supabaseUrl, serviceRoleKey);

// Mock –¥–∞–Ω–Ω—ã–µ (–±–µ—Ä–µ–º –∏–∑ instructionsService.ts)
const mockTopics = [
  {
    id: 'topic_1',
    key: 'dashboard',
    route: '/dashboard',
    title: '–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å',
    description: '–û–±–∑–æ—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã',
    is_active: true,
    views_total: 156,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-01-20T16:20:00Z'
  },
  {
    id: 'topic_2',
    key: 'users',
    route: '/admin/users',
    title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏',
    description: '–°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å–∏—Å—Ç–µ–º—ã',
    is_active: true,
    views_total: 89,
    created_at: '2024-01-16T11:30:00Z',
    updated_at: '2024-01-25T09:15:00Z'
  },
  {
    id: 'topic_3',
    key: 'roles',
    route: '/admin/roles',
    title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏',
    description: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π –∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
    is_active: true,
    views_total: 67,
    created_at: '2024-01-17T14:45:00Z',
    updated_at: '2024-01-26T12:30:00Z'
  }
];

const mockVersions = [
  {
    id: 'version_1',
    topic_id: 'topic_1',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: '–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    content_md: `## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—â–∏–π –æ–±–∑–æ—Ä –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∏ –º–µ—Ç—Ä–∏–∫ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏. –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –±—ã—Å—Ç—Ä–æ –æ—Ü–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ –∏ –ø—Ä–∏–Ω—è—Ç—å –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã

**–°–≤–æ–¥–∫–∞ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º**
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–±—ä–µ–º —Ç–æ—Ä–≥–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥  
- –°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å —Å–¥–µ–ª–æ–∫
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –∏ —É–±—ã—Ç–æ—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∏—Å–∫–æ–≤**
- –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞
- –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º

**–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏**
- –û–±—â–∏–π –±–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞
- –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–ª—è —Ç–æ—Ä–≥–æ–≤
- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ –ø–æ–∑–∏—Ü–∏—è—Ö
- P&L –∑–∞ –ø–µ—Ä–∏–æ–¥ (–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü)`,
    content_html: '',
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-01-20T16:20:00Z'
  },
  {
    id: 'version_2',
    topic_id: 'topic_2',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ',
    content_md: `## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å–∏—Å—Ç–µ–º—ã

–†–∞–∑–¥–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. **–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è**
   - –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" 
   - –û—Ç–∫—Ä–æ–µ—Ç—Å—è –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ñ–æ—Ä–º–æ–π

2. **–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏**
   - \`–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞
   - \`–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞\` - –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
   - \`–ü–æ–ª–Ω–æ–µ –∏–º—è\` - –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
   - \`–¢–µ–ª–µ—Ñ–æ–Ω\` - –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞**
   - \`–†–æ–ª—å\` - –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é —Ä–æ–ª—å –∏–∑ —Å–ø–∏—Å–∫–∞
   - \`–°—Ç–∞—Ç—É—Å\` - –∞–∫—Ç–∏–≤–Ω—ã–π/–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
   - \`–í—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å\` - –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email`,
    content_html: '',
    created_at: '2024-01-16T11:30:00Z',
    updated_at: '2024-01-25T09:15:00Z'
  },
  {
    id: 'version_3',
    topic_id: 'topic_3',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞',
    content_md: `## –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –∏ –ø—Ä–∞–≤

–†–∞–∑–¥–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª—è–º–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–∏–±–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º —Å–∏—Å—Ç–µ–º—ã.

### –¢–∏–ø—ã —Ä–æ–ª–µ–π

**–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä**
- –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º —Å–∏—Å—Ç–µ–º—ã
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ä–æ–ª—è–º–∏
- –î–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
- –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∏ –∞—É–¥–∏—Ç–∞

**–¢—Ä–µ–π–¥–µ—Ä**
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –ø–æ–∑–∏—Ü–∏–π –∏ –∏—Å—Ç–æ—Ä–∏–∏
- –î–æ—Å—Ç—É–ø –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –ø–æ —Å–≤–æ–∏–º —Å–¥–µ–ª–∫–∞–º
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ê–Ω–∞–ª–∏—Ç–∏–∫**  
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –î–æ—Å—Ç—É–ø –∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º
- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö`,
    content_html: '',
    created_at: '2024-01-17T14:45:00Z',
    updated_at: '2024-01-26T12:30:00Z'
  }
];

// –§—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Supabase
function convertTopicForDatabase(topic) {
  return {
    id: randomUUID(),
    tenant_id: '00000000-0000-0000-0000-000000000001', // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π tenant
    route: topic.route,
    title: topic.title,
    content: topic.description,
    content_type: 'markdown',
    help_type: 'modal',
    is_active: topic.is_active,
    sort_order: 0,
    created_at: new Date(topic.created_at).toISOString(),
    updated_at: new Date(topic.updated_at).toISOString()
  };
}

function convertVersionForDatabase(version) {
  return {
    id: randomUUID(),
    tenant_id: '00000000-0000-0000-0000-000000000001',
    route: `/instructions/${version.topic_id}`,
    title: version.title,
    content: version.content_md,
    content_type: 'markdown',
    help_type: 'sidebar',
    is_active: version.status === 'published',
    sort_order: version.version,
    created_at: new Date(version.created_at).toISOString(),
    updated_at: new Date(version.updated_at).toISOString()
  };
}

async function migrateInstructions() {
  try {
    console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π...');
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
    const topicsForDB = mockTopics.map(convertTopicForDatabase);
    const versionsForDB = mockVersions.map(convertVersionForDatabase);
    
    console.log(`üìä –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ ${topicsForDB.length} —Ç–µ–º –∏ ${versionsForDB.length} –≤–µ—Ä—Å–∏–π`);
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–º—ã
    console.log('üìù –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–º—ã...');
    const { data: topicsData, error: topicsError } = await supabase
      .from('page_help')
      .upsert(topicsForDB, { onConflict: 'id' });
    
    if (topicsError) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —Ç–µ–º:', topicsError);
      throw topicsError;
    }
    
    console.log('‚úÖ –¢–µ–º—ã —É—Å–ø–µ—à–Ω–æ –≤—Å—Ç–∞–≤–ª–µ–Ω—ã');
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏–∏
    console.log('üìñ –í—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏–∏...');
    const { data: versionsData, error: versionsError } = await supabase
      .from('page_help')
      .upsert(versionsForDB, { onConflict: 'id' });
    
    if (versionsError) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –≤–µ—Ä—Å–∏–π:', versionsError);
      throw versionsError;
    }
    
    console.log('‚úÖ –í–µ—Ä—Å–∏–∏ —É—Å–ø–µ—à–Ω–æ –≤—Å—Ç–∞–≤–ª–µ–Ω—ã');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const { data: finalData, error: checkError, count } = await supabase
      .from('page_help')
      .select('*', { count: 'exact' });
    
    if (checkError) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ:', checkError);
      throw checkError;
    }
    
    console.log(`üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö ${count} –∑–∞–ø–∏—Å–µ–π`);
    console.log('üìã –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–∏—Å–µ–π:');
    finalData.slice(0, 3).forEach(item => {
      console.log(`  - ${item.title} (${item.route})`);
    });
    
  } catch (error) {
    console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:', error);
    process.exit(1);
  }
}

// –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏
migrateInstructions();