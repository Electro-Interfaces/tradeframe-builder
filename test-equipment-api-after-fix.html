<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Test Equipment API After RLS Fix</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #1a1a1a; 
            color: #fff; 
            padding: 20px; 
            max-width: 1000px; 
            margin: 0 auto;
        }
        .container { 
            background: #2d3748; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 10px 0; 
        }
        button { 
            background: #4299e1; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #3182ce; }
        button.success { background: #48bb78; }
        button.error { background: #f56565; }
        .log { 
            background: #000; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: monospace; 
            white-space: pre-wrap; 
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #48bb78; }
        .error { color: #f56565; }
        .warning { color: #ed8936; }
        .info { color: #63b3ed; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #4a5568;
            padding: 8px;
            text-align: left;
        }
        th { background: #2d3748; }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-ok { background: #48bb78; }
        .status-error { background: #f56565; }
    </style>
</head>
<body>
    <h1>üîß Equipment API Test (After RLS Fix)</h1>
    <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º API –¥–æ—Å—Ç—É–ø –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è RLS –ø–æ–ª–∏—Ç–∏–∫</p>

    <div class="container">
        <h3>Step 1: Test Direct Supabase Access</h3>
        <p>–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è RLS</p>
        <button onclick="testSupabaseAccess()">Test Supabase Access</button>
        <div id="supabase-result" class="log"></div>
    </div>

    <div class="container">
        <h3>Step 2: Test Equipment Templates API</h3>
        <button onclick="testTemplatesAPI()">Test Templates</button>
        <div id="templates-result" class="log"></div>
        <div id="templates-table"></div>
    </div>

    <div class="container">
        <h3>Step 3: Test Equipment API</h3>
        <button onclick="testEquipmentAPI()">Test Equipment</button>
        <div id="equipment-result" class="log"></div>
        <div id="equipment-table"></div>
    </div>

    <div class="container">
        <h3>Step 4: Test Frontend Service Integration</h3>
        <button onclick="testFrontendServices()">Test Frontend Services</button>
        <div id="frontend-result" class="log"></div>
    </div>

    <div class="container">
        <h3>Step 5: Production Readiness Check</h3>
        <button onclick="checkProductionReadiness()">Check Production Readiness</button>
        <div id="production-result" class="log"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMwNjAzNDcsImV4cCI6MjA0ODYzNjM0N30.0R0hKfITlTOlQHYgP4JVfFQi_7xz3kW5nC7VZq6K3k0';

        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            container.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            container.scrollTop = container.scrollHeight;
        }

        async function testSupabaseAccess() {
            const container = document.getElementById('supabase-result');
            container.innerHTML = '';
            
            log('supabase-result', 'Testing Supabase connection after RLS fix...', 'info');

            try {
                // Test basic endpoint
                const response = await fetch(`${SUPABASE_URL}/rest/v1/equipment_templates?limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                log('supabase-result', `Response status: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log('supabase-result', '‚úÖ Supabase access working!', 'success');
                    log('supabase-result', `Found ${data.length} equipment templates`, 'success');
                    
                    // Update button style
                    const button = document.querySelector('button[onclick="testSupabaseAccess()"]');
                    button.className = 'success';
                    button.textContent = '‚úÖ Supabase OK';
                    
                } else {
                    const errorText = await response.text();
                    log('supabase-result', `‚ùå Still getting error: ${errorText}`, 'error');
                    log('supabase-result', 'üí° Make sure you executed the RLS fix SQL script', 'warning');
                }

            } catch (error) {
                log('supabase-result', `‚ùå Connection error: ${error.message}`, 'error');
            }
        }

        async function testTemplatesAPI() {
            const container = document.getElementById('templates-result');
            const tableContainer = document.getElementById('templates-table');
            container.innerHTML = '';
            tableContainer.innerHTML = '';

            log('templates-result', 'Testing equipment templates API...', 'info');

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/equipment_templates?order=name`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const templates = await response.json();
                    log('templates-result', `‚úÖ Found ${templates.length} equipment templates`, 'success');
                    
                    // Create table
                    let tableHTML = `
                        <h4>Equipment Templates</h4>
                        <table>
                            <tr>
                                <th>Status</th>
                                <th>Name</th>
                                <th>System Type</th>
                                <th>Technical Code</th>
                                <th>Active</th>
                            </tr>
                    `;

                    templates.forEach(template => {
                        const statusClass = template.status ? 'status-ok' : 'status-error';
                        const statusText = template.status ? 'Active' : 'Inactive';
                        
                        tableHTML += `
                            <tr>
                                <td><span class="status-indicator ${statusClass}"></span></td>
                                <td>${template.name}</td>
                                <td>${template.system_type}</td>
                                <td>${template.technical_code}</td>
                                <td>${statusText}</td>
                            </tr>
                        `;
                    });

                    tableHTML += '</table>';
                    tableContainer.innerHTML = tableHTML;

                    // Check for required system types
                    const systemTypes = templates.map(t => t.system_type);
                    const requiredTypes = ['fuel_tank', 'fuel_dispenser', 'control_system'];
                    
                    log('templates-result', '\nChecking required system types:', 'info');
                    requiredTypes.forEach(type => {
                        if (systemTypes.includes(type)) {
                            log('templates-result', `‚úÖ ${type} - found`, 'success');
                        } else {
                            log('templates-result', `‚ùå ${type} - missing`, 'error');
                        }
                    });

                    const button = document.querySelector('button[onclick="testTemplatesAPI()"]');
                    button.className = 'success';
                    button.textContent = '‚úÖ Templates OK';

                } else {
                    const errorText = await response.text();
                    log('templates-result', `‚ùå Templates API error: ${response.status} ${errorText}`, 'error');
                }

            } catch (error) {
                log('templates-result', `‚ùå Templates API error: ${error.message}`, 'error');
            }
        }

        async function testEquipmentAPI() {
            const container = document.getElementById('equipment-result');
            const tableContainer = document.getElementById('equipment-table');
            container.innerHTML = '';
            tableContainer.innerHTML = '';

            log('equipment-result', 'Testing equipment instances API...', 'info');

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/equipment?order=display_name&limit=10`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const equipment = await response.json();
                    log('equipment-result', `‚úÖ Found ${equipment.length} equipment instances`, 'success');
                    
                    if (equipment.length > 0) {
                        // Create table
                        let tableHTML = `
                            <h4>Equipment Instances</h4>
                            <table>
                                <tr>
                                    <th>Status</th>
                                    <th>Display Name</th>
                                    <th>System Type</th>
                                    <th>Serial Number</th>
                                    <th>Status</th>
                                </tr>
                        `;

                        equipment.forEach(item => {
                            const statusClass = item.status === 'online' ? 'status-ok' : 'status-error';
                            
                            tableHTML += `
                                <tr>
                                    <td><span class="status-indicator ${statusClass}"></span></td>
                                    <td>${item.display_name}</td>
                                    <td>${item.system_type}</td>
                                    <td>${item.serial_number || 'N/A'}</td>
                                    <td>${item.status}</td>
                                </tr>
                            `;
                        });

                        tableHTML += '</table>';
                        tableContainer.innerHTML = tableHTML;
                    } else {
                        log('equipment-result', '‚ÑπÔ∏è No equipment instances found - this is normal for fresh install', 'info');
                    }

                    const button = document.querySelector('button[onclick="testEquipmentAPI()"]');
                    button.className = 'success';
                    button.textContent = '‚úÖ Equipment OK';

                } else {
                    const errorText = await response.text();
                    log('equipment-result', `‚ùå Equipment API error: ${response.status} ${errorText}`, 'error');
                }

            } catch (error) {
                log('equipment-result', `‚ùå Equipment API error: ${error.message}`, 'error');
            }
        }

        async function testFrontendServices() {
            const container = document.getElementById('frontend-result');
            container.innerHTML = '';

            log('frontend-result', 'Testing frontend service integration...', 'info');

            // Simulate frontend service calls
            try {
                // Test 1: Equipment templates service
                log('frontend-result', '1. Testing equipment templates service...', 'info');
                
                const templatesResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment_templates?status=eq.true`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (templatesResponse.ok) {
                    const templates = await templatesResponse.json();
                    log('frontend-result', `‚úÖ Templates service: ${templates.length} active templates`, 'success');
                } else {
                    log('frontend-result', `‚ùå Templates service failed: ${templatesResponse.status}`, 'error');
                    return;
                }

                // Test 2: Equipment by trading point (simulated)
                log('frontend-result', '2. Testing equipment by trading point...', 'info');
                
                const equipmentResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment?trading_point_id=eq.point1&limit=5`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (equipmentResponse.ok) {
                    const equipment = await equipmentResponse.json();
                    log('frontend-result', `‚úÖ Equipment by trading point: ${equipment.length} items`, 'success');
                } else {
                    log('frontend-result', `‚ÑπÔ∏è Equipment by trading point: ${equipmentResponse.status} (expected for empty data)`, 'info');
                }

                // Test 3: Check API endpoints match frontend expectations
                log('frontend-result', '3. Checking API endpoint compatibility...', 'info');
                
                // Test the structure matches what frontend expects
                if (templates.length > 0) {
                    const template = templates[0];
                    const expectedFields = ['id', 'name', 'system_type', 'status', 'default_params'];
                    
                    const missingFields = expectedFields.filter(field => !(field in template));
                    if (missingFields.length === 0) {
                        log('frontend-result', '‚úÖ API response structure matches frontend expectations', 'success');
                    } else {
                        log('frontend-result', `‚ö†Ô∏è Missing fields: ${missingFields.join(', ')}`, 'warning');
                    }
                }

                log('frontend-result', '\nüéâ Frontend integration test completed successfully!', 'success');

                const button = document.querySelector('button[onclick="testFrontendServices()"]');
                button.className = 'success';
                button.textContent = '‚úÖ Frontend OK';

            } catch (error) {
                log('frontend-result', `‚ùå Frontend integration error: ${error.message}`, 'error');
            }
        }

        async function checkProductionReadiness() {
            const container = document.getElementById('production-result');
            container.innerHTML = '';

            log('production-result', 'Checking production readiness...', 'info');

            const checks = [
                { name: 'Database Connection', status: false },
                { name: 'Equipment Templates', status: false },
                { name: 'Equipment API', status: false },
                { name: 'Frontend Compatibility', status: false }
            ];

            try {
                // Check 1: Database
                const dbResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment_templates?limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                checks[0].status = dbResponse.ok;

                // Check 2: Templates
                if (dbResponse.ok) {
                    const templates = await dbResponse.json();
                    checks[1].status = templates.length >= 3; // Need at least 3 basic templates
                }

                // Check 3: Equipment API
                const equipmentResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment?limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                checks[2].status = equipmentResponse.ok;

                // Check 4: Frontend compatibility (structure check)
                checks[3].status = checks[0].status && checks[1].status && checks[2].status;

                // Display results
                log('production-result', 'üìä Production Readiness Report:', 'info');
                log('production-result', '================================', 'info');
                
                checks.forEach(check => {
                    const status = check.status ? '‚úÖ' : '‚ùå';
                    const statusText = check.status ? 'PASS' : 'FAIL';
                    log('production-result', `${status} ${check.name}: ${statusText}`, 
                        check.status ? 'success' : 'error');
                });

                const allPassed = checks.every(check => check.status);
                
                log('production-result', '\n================================', 'info');
                if (allPassed) {
                    log('production-result', 'üéâ ALL CHECKS PASSED - READY FOR PRODUCTION!', 'success');
                    log('production-result', 'üöÄ Equipment section can be deployed to production', 'success');
                    
                    const button = document.querySelector('button[onclick="checkProductionReadiness()"]');
                    button.className = 'success';
                    button.textContent = '‚úÖ Production Ready';
                } else {
                    log('production-result', '‚ö†Ô∏è Some checks failed - need fixes before production', 'warning');
                }

            } catch (error) {
                log('production-result', `‚ùå Production readiness check error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>