<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1e1e1e; 
            color: #fff; 
            padding: 20px; 
            line-height: 1.4;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .code { 
            background: #0d1117; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #444;
            overflow-x: auto;
        }
        .highlight { 
            background: #2d4a22; 
            padding: 10px; 
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #000; }
    </style>
</head>
<body>
    <h1>üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï API –ü–ê–†–ê–ú–ï–¢–†–û–í</h1>
    <p>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö external_id –¥–ª—è System ID: "15" –∏ Station ID: "4"</p>
    
    <div>
        <button onclick="fixApiParameters()">üöÄ –ò—Å–ø—Ä–∞–≤–∏—Ç—å API –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
        <button onclick="testApiParameters()">üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
        <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
    </div>
    
    <div id="log"></div>

    <script type="module">
        const TARGET_TP_ID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
        const log = document.getElementById('log');
        
        function addLog(message, type = 'normal') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            log.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        window.clearLog = function() {
            log.innerHTML = '';
        }
        
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        window.fixApiParameters = async function() {
            addLog('üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï API –ü–ê–†–ê–ú–ï–¢–†–û–í', 'info');
            addLog('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: System ID = "15", Station ID = "4"', 'info');
            
            try {
                const { httpClient } = await import('/src/services/universalHttpClient.ts');
                
                // –®–∞–≥ 1: –ò—â–µ–º —Å–µ—Ç—å "–ù–æ—Ä–¥ –õ–∞–π–Ω" –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º external_id = "15"
                addLog('üîç –ò—â–µ–º —Å–µ—Ç—å "–ù–æ—Ä–¥ –õ–∞–π–Ω"...', 'info');
                
                const networksResponse = await httpClient.get('/rest/v1/networks', {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id'
                    }
                });
                
                if (networksResponse.success && networksResponse.data) {
                    const nordLineNetwork = networksResponse.data.find(n => 
                        n.name.toLowerCase().includes('–Ω–æ—Ä–¥') || 
                        n.name.toLowerCase().includes('nord')
                    );
                    
                    if (nordLineNetwork) {
                        addLog(`‚úÖ –ù–∞–π–¥–µ–Ω–∞ —Å–µ—Ç—å: "${nordLineNetwork.name}" (ID: ${nordLineNetwork.id})`, 'success');
                        addLog(`–¢–µ–∫—É—â–∏–π external_id: "${nordLineNetwork.external_id || '–ù–ï–¢'}"`, 'info');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º external_id —Å–µ—Ç–∏ –Ω–∞ "15"
                        const updateNetworkResponse = await httpClient.patch(`/rest/v1/networks?id=eq.${nordLineNetwork.id}`, {
                            destination: 'supabase',
                            body: {
                                external_id: "15"
                            }
                        });
                        
                        if (updateNetworkResponse.success) {
                            addLog(`‚úÖ –°–µ—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞: external_id = "15"`, 'success');
                        } else {
                            addLog(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ç–∏: ${updateNetworkResponse.error}`, 'error');
                            return;
                        }
                    } else {
                        addLog('‚ùå –°–µ—Ç—å "–ù–æ—Ä–¥ –õ–∞–π–Ω" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                        return;
                    }
                }
                
                // –®–∞–≥ 2: –ò—â–µ–º —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É –ê–ó–° ‚Ññ4 –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º external_id = "4"
                addLog('üîç –ò—â–µ–º —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É "–ê–ó–° ‚Ññ4"...', 'info');
                
                const tpResponse = await httpClient.get(`/rest/v1/trading_points?id=eq.${TARGET_TP_ID}`, {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id'
                    }
                });
                
                if (tpResponse.success && tpResponse.data && tpResponse.data.length > 0) {
                    const azs4 = tpResponse.data[0];
                    addLog(`‚úÖ –ù–∞–π–¥–µ–Ω–∞ —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞: "${azs4.name}" (ID: ${azs4.id})`, 'success');
                    addLog(`–¢–µ–∫—É—â–∏–π external_id: "${azs4.external_id || '–ù–ï–¢'}"`, 'info');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º external_id —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –Ω–∞ "4"
                    const updateTpResponse = await httpClient.patch(`/rest/v1/trading_points?id=eq.${TARGET_TP_ID}`, {
                        destination: 'supabase',
                        body: {
                            external_id: "4"
                        }
                    });
                    
                    if (updateTpResponse.success) {
                        addLog(`‚úÖ –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: external_id = "4"`, 'success');
                    } else {
                        addLog(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏: ${updateTpResponse.error}`, 'error');
                        return;
                    }
                } else {
                    addLog('‚ùå –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –ê–ó–° ‚Ññ4 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    return;
                }
                
                addLog('<div class="highlight">‚úÖ –í–°–ï –ü–ê–†–ê–ú–ï–¢–†–´ –£–°–ü–ï–®–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–´!</div>', 'success');
                addLog('System ID: "15" (–æ—Ç —Å–µ—Ç–∏ –ù–æ—Ä–¥ –õ–∞–π–Ω)', 'success');
                addLog('Station ID: "4" (–æ—Ç —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ê–ó–° ‚Ññ4)', 'success');
                
            } catch (error) {
                addLog(`üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        window.testApiParameters = async function() {
            addLog('üß™ –ü–†–û–í–ï–†–ö–ê API –ü–ê–†–ê–ú–ï–¢–†–û–í', 'info');
            
            try {
                const { httpClient } = await import('/src/services/universalHttpClient.ts');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ getAllTradingPointsWithNetworks
                const response = await httpClient.getAllTradingPointsWithNetworks();
                
                if (response.success && response.data) {
                    const azs4 = response.data.find(tp => tp.id === TARGET_TP_ID);
                    
                    if (azs4) {
                        addLog(`<div class="highlight">
                            –ü–†–û–í–ï–†–ö–ê –ê–ó–° ‚Ññ4:<br>
                            ‚ûú –ù–∞–∑–≤–∞–Ω–∏–µ: ${azs4.name}<br>
                            ‚ûú –°–µ—Ç—å: ${azs4.networkInfo.name}<br>
                            ‚ûú System ID: "${azs4.systemId}"<br>
                            ‚ûú Station ID: "${azs4.stationId}"<br>
                            ‚ûú API –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${azs4.apiReady ? '‚úÖ –ì–û–¢–û–í–ê' : '‚ùå –ù–ï –ì–û–¢–û–í–ê'}<br>
                            ‚ûú –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: ${azs4.systemId === '15' && azs4.stationId === '4' ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}
                        </div>`, azs4.systemId === '15' && azs4.stationId === '4' ? 'success' : 'error');
                        
                        if (azs4.systemId === '15' && azs4.stationId === '4') {
                            addLog(`üéØ API URL: https://pos.autooplata.ru/tms/tanks?system=${azs4.systemId}&station=${azs4.stationId}`, 'success');
                        }
                    } else {
                        addLog('‚ùå –ê–ó–° ‚Ññ4 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    }
                } else {
                    addLog('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏', 'error');
                }
                
            } catch (error) {
                addLog(`üí• –û–®–ò–ë–ö–ê –ü–†–û–í–ï–†–ö–ò: ${error.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        addLog('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ì–æ—Ç–æ–≤ –∏—Å–ø—Ä–∞–≤–∏—Ç—å API –ø–∞—Ä–∞–º–µ—Ç—Ä—ã!', 'info');
    </script>
</body>
</html>