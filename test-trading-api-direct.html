<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üåê –ü—Ä—è–º–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API</h1>
    
    <div>
        <button onclick="testTradingConfig()">1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API</button>
        <button onclick="testDirectAPICall()">2Ô∏è‚É£ –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ API —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</button>
        <button onclick="testSyncService()">3Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</button>
    </div>
    
    <div id="logs"></div>

    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            logsDiv.appendChild(logEntry);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function testTradingConfig() {
            log('üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API –∏–∑ –ë–î...');
            
            try {
                const response = await fetch('/supabase-proxy/rest/v1/system_config?key=eq.trading_network_config', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const config = data[0].value;
                    log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API –Ω–∞–π–¥–µ–Ω–∞:', 'success');
                    log(`üìç Base URL: ${config.baseUrl}`, 'info');
                    log(`üîê Username: ${config.username}`, 'info');
                    log(`üì° Endpoints: ${JSON.stringify(config.endpoints)}`, 'info');
                    log(`üü¢ Enabled: ${config.enabled}`, 'info');
                } else {
                    log('‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }

        async function testDirectAPICall() {
            log('üåê –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ —Ç–æ—Ä–≥–æ–≤–æ–º—É API...');
            
            try {
                // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API
                const params = new URLSearchParams({
                    system: '15',
                    station: '4'
                });
                
                const url = `/supabase-proxy/rest/v1/system_config?key=eq.trading_network_config`;
                log(`üì° –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑: ${url}`, 'info');
                
                const configResponse = await fetch(url, {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY'
                    }
                });
                
                if (!configResponse.ok) {
                    throw new Error(`Config fetch failed: ${configResponse.status}`);
                }
                
                const configData = await configResponse.json();
                const config = configData[0]?.value;
                
                if (!config) {
                    throw new Error('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
                
                log(`‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞, –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫: ${config.baseUrl}${config.endpoints.transactions}`, 'success');
                log(`üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ${params.toString()}`, 'info');
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                const authString = `${config.username}:${config.password}`;
                const authHeader = `Basic ${btoa(authString)}`;
                
                log(`üîê –ò—Å–ø–æ–ª—å–∑—É–µ–º Basic Auth –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${config.username}`, 'info');
                
                // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Ç–æ—Ä–≥–æ–≤–æ–º—É API
                const apiUrl = `${config.baseUrl}${config.endpoints.transactions}?${params.toString()}`;
                log(`üåê –í—ã–ø–æ–ª–Ω—è–µ–º GET –∑–∞–ø—Ä–æ—Å: ${apiUrl}`, 'info');
                
                const apiResponse = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': authHeader,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ API: ${apiResponse.status} ${apiResponse.statusText}`, 
                    apiResponse.ok ? 'success' : 'error');
                
                if (!apiResponse.ok) {
                    const errorText = await apiResponse.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API: ${errorText}`, 'error');
                    return;
                }
                
                const apiData = await apiResponse.json();
                
                if (Array.isArray(apiData)) {
                    log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–∑ API: ${apiData.length}`, 'success');
                    if (apiData.length > 0) {
                        log(`üìã –ü–µ—Ä–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: ${JSON.stringify(apiData[0], null, 2)}`, 'info');
                    }
                } else {
                    log(`üìÑ –û—Ç–≤–µ—Ç API: ${JSON.stringify(apiData, null, 2)}`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API: ${error.message}`, 'error');
                console.error('API Error Details:', error);
            }
        }

        async function testSyncService() {
            log('üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ window –æ–±—ä–µ–∫—Ç...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                if (window.tradingTransactionsSyncService) {
                    log('‚úÖ –°–µ—Ä–≤–∏—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω –≤ window', 'success');
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å
                    const status = window.tradingTransactionsSyncService.getSyncStatus();
                    log(`üìä –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: isRunning=${status.isRunning}, lastSyncTime=${status.lastSyncTime}`, 'info');
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ 4
                    log('üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ 4...', 'info');
                    
                    const result = await window.tradingTransactionsSyncService.syncStationTransactions(4, 1);
                    
                    log(`‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:`, 'success');
                    log(`üìä –£—Å–ø–µ—à–Ω–æ: ${result.success}`, result.success ? 'success' : 'error');
                    log(`üì• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${result.syncedTransactions}`, 'info');
                    log(`‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${result.skippedTransactions}`, 'info');
                    log(`‚ùå –û—à–∏–±–æ–∫: ${result.errors.length}`, result.errors.length > 0 ? 'error' : 'success');
                    
                    if (result.errors.length > 0) {
                        result.errors.forEach(error => log(`‚ùå –û—à–∏–±–∫–∞: ${error}`, 'error'));
                    }
                    
                } else {
                    log('‚ùå –°–µ—Ä–≤–∏—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ window –æ–±—ä–µ–∫—Ç–µ', 'error');
                    log('üí° –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é', 'info');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                console.error('Sync Service Error:', error);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            log('üöÄ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            testTradingConfig();
        };
    </script>
</body>
</html>