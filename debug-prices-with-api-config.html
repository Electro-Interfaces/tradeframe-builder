<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ —Ü–µ–Ω —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π API</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">üîç –û—Ç–ª–∞–¥–∫–∞ —Ü–µ–Ω —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API</h1>
        
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:</h2>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <strong>–ë–∞–∑–æ–≤—ã–π URL API:</strong> https://pos.autooplata.ru/tms<br>
                    <strong>ID —Å–∏—Å—Ç–µ–º—ã —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Ç–∏:</strong> 15<br>
                    <strong>ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:</strong> 4<br>
                    <strong>Timeout (–º—Å):</strong> 30000
                </div>
                <div>
                    <strong>–¢–∏–ø –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:</strong> Bearer Token<br>
                    <strong>API –∫–ª—é—á:</strong> eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...<br>
                    <em>(—Ç–æ–∫–µ–Ω –æ–±—Ä–µ–∑–∞–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)</em>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Trading Point ID:</label>
                    <input type="text" id="tradingPointId" value="4"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">System ID:</label>
                    <input type="text" id="systemId" value="15"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Date:</label>
                    <input type="text" id="testDate" 
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                           placeholder="YYYY-MM-DD">
                </div>
            </div>
            <div class="mt-4 space-x-2">
                <button onclick="testSupabaseTanks()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                    üè™ –¢–µ—Å—Ç —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ Supabase
                </button>
                <button onclick="testTradingAPI()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                    üîó –¢–µ—Å—Ç —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API
                </button>
                <button onclick="testFullPipeline()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
                    üöÄ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ø–∞–π–ø–ª–∞–π–Ω–∞
                </button>
                <button onclick="clearResults()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    üßπ –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
        </div>

        <div id="results" class="space-y-4"></div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
        const TRADING_API_CONFIG = {
            baseUrl: 'https://pos.autooplata.ru/tms',
            systemId: '15',
            defaultTradingPointId: '4',
            timeout: 30000,
            authType: 'Bearer Token',
            apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vamJodXdnZHhucGNyemxqemttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyMjUzNzksImV4cCI6MjA0OTgwMTM3OX0.KXF1gEiAXWv-HVLCZFoHuIKVcjQIBSUPcROkfVMNHDY' // –≠—Ç–æ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è Supabase
        };

        // Supabase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const SUPABASE_URL = 'https://oojbhuwgdxnpcrzljzkm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vamJodXdnZHhucGNyemxqemttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyMjUzNzksImV4cCI6MjA0OTgwMTM3OX0.KXF1gEiAXWv-HVLCZFoHuIKVcjQIBSUPcROkfVMNHDY';

        // –ê–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('testDate').value = today;
        });

        async function testSupabaseTanks() {
            const tradingPointId = document.getElementById('tradingPointId').value.trim();
            if (!tradingPointId) {
                addResult('error', '–í–≤–µ–¥–∏—Ç–µ Trading Point ID');
                return;
            }

            try {
                addResult('info', `üè™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ Supabase –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏: ${tradingPointId}`);
                
                // –ó–∞–ø—Ä–æ—Å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –∫–∞–∫ –≤ pricesSupabaseService
                const equipmentUrl = `${SUPABASE_URL}/rest/v1/equipment?trading_point_id=eq.${tradingPointId}&system_type=eq.fuel_tank&limit=100`;
                
                addResult('debug', `üì° URL –∑–∞–ø—Ä–æ—Å–∞: ${equipmentUrl}`);
                
                const response = await fetch(equipmentUrl, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const tanks = await response.json();
                addResult('success', `‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${tanks.length} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –∏–∑ Supabase`);

                if (tanks.length === 0) {
                    addResult('warning', '‚ö†Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã! –í–æ–∑–º–æ–∂–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π trading_point_id –∏–ª–∏ –æ–Ω–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã');
                    return;
                }

                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –≤ pricesSupabaseService.getFuelTypesInfo
                const validTanks = tanks.filter(tank => tank.status !== 'deleted' && tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞']);
                addResult('info', `üîç –í–∞–ª–∏–¥–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ (–Ω–µ deleted + –µ—Å—Ç—å —Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞): ${validTanks.length} –∏–∑ ${tanks.length}`);

                if (validTanks.length === 0) {
                    addResult('error', '‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —Ç–∏–ø–æ–º —Ç–æ–ø–ª–∏–≤–∞!');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    tanks.slice(0, 3).forEach((tank, i) => {
                        const fuelType = tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'];
                        const paramKeys = Object.keys(tank.params || {});
                        addResult('debug', 
                            `–†–µ–∑–µ—Ä–≤—É–∞—Ä ${i+1}: status="${tank.status}", 
                             –¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞="${fuelType}", 
                             params=[${paramKeys.join(', ')}]`
                        );
                    });
                    return;
                }

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≤–∏–¥–∞–º —Ç–æ–ø–ª–∏–≤–∞
                const fuelTypesMap = new Map();
                validTanks.forEach(tank => {
                    const fuelType = tank.params['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'];
                    const capacity = parseFloat(tank.params['–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–ª)']) || 0;
                    const level = parseFloat(tank.params['–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å (–ª)']) || 0;

                    if (!fuelTypesMap.has(fuelType)) {
                        fuelTypesMap.set(fuelType, {
                            tanks: [],
                            totalVolume: 0,
                            currentLevel: 0
                        });
                    }

                    const fuelData = fuelTypesMap.get(fuelType);
                    fuelData.tanks.push(tank);
                    fuelData.totalVolume += capacity;
                    fuelData.currentLevel += level;
                });

                addResult('success', `üî• –ù–∞–π–¥–µ–Ω–æ ${fuelTypesMap.size} –≤–∏–¥–æ–≤ —Ç–æ–ø–ª–∏–≤–∞:`);
                
                fuelTypesMap.forEach((data, fuelType) => {
                    addResult('info', 
                        `${fuelType}: ${data.tanks.length} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤, 
                         –æ–±—ä—ë–º ${data.totalVolume} –ª, 
                         —É—Ä–æ–≤–µ–Ω—å ${data.currentLevel} –ª`
                    );
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–Ω—ã
                await checkCurrentPrices(tradingPointId);

            } catch (error) {
                addResult('error', `‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Supabase: ${error.message}`);
                console.error('Supabase test error:', error);
            }
        }

        async function checkCurrentPrices(tradingPointId) {
            try {
                addResult('info', `üí∞ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã –¥–ª—è ${tradingPointId}...`);
                
                const pricesUrl = `${SUPABASE_URL}/rest/v1/prices?trading_point_id=eq.${tradingPointId}&is_active=eq.true&order=valid_from.desc`;
                
                const response = await fetch(pricesUrl, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 404 || response.status === 406) {
                        addResult('warning', '‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ prices –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const prices = await response.json();
                addResult('success', `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${prices.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–Ω`);
                
                prices.forEach(price => {
                    addResult('info', 
                        `üí∞ ${price.fuel_type}: ${(price.price_gross / 100).toFixed(2)} ‚ÇΩ/–ª 
                         (–ù–î–° ${price.vat_rate}%)`
                    );
                });

            } catch (error) {
                addResult('warning', `‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–Ω: ${error.message}`);
            }
        }

        async function testTradingAPI() {
            const tradingPointId = document.getElementById('tradingPointId').value.trim();
            const systemId = document.getElementById('systemId').value.trim();
            const testDate = document.getElementById('testDate').value.trim();

            if (!tradingPointId || !systemId) {
                addResult('error', '–í–≤–µ–¥–∏—Ç–µ Trading Point ID –∏ System ID');
                return;
            }

            try {
                addResult('info', `üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API...`);
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ vite.config.ts
                const proxyUrl = `/api/trading-network/v1/pos/prices/${tradingPointId}?system=${systemId}&date=${encodeURIComponent(testDate)}`;
                
                addResult('debug', `üì° –ü—Ä–æ–∫—Å–∏ URL: ${proxyUrl}`);
                addResult('debug', `üì° –ü—Ä–æ–∫—Å–∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞: ${TRADING_API_CONFIG.baseUrl}/v1/pos/prices/${tradingPointId}?system=${systemId}&date=${testDate}`);
                
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                addResult('info', `üìä HTTP —Å—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    addResult('error', `‚ùå –û—à–∏–±–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API: ${errorText}`);
                    return;
                }

                const data = await response.json();
                addResult('success', `‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API`);
                addResult('debug', `üìã –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(data, null, 2)}`);

            } catch (error) {
                addResult('error', `‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ API: ${error.message}`);
                console.error('Trading API test error:', error);
            }
        }

        async function testFullPipeline() {
            addResult('info', 'üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ü–µ–Ω...');
            
            // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã
            await testSupabaseTanks();
            await new Promise(resolve => setTimeout(resolve, 1000)); // –ø–∞—É–∑–∞
            await testTradingAPI();
            
            addResult('success', 'üèÅ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ø–∞–π–ø–ª–∞–π–Ω–∞ –∑–∞–≤–µ—Ä—à—ë–Ω');
        }

        function addResult(type, message) {
            const results = document.getElementById('results');
            const colors = {
                'info': 'bg-blue-900 border-blue-600 text-blue-200',
                'success': 'bg-green-900 border-green-600 text-green-200',
                'warning': 'bg-yellow-900 border-yellow-600 text-yellow-200',
                'error': 'bg-red-900 border-red-600 text-red-200',
                'debug': 'bg-gray-800 border-gray-600 text-gray-300'
            };
            
            const div = document.createElement('div');
            div.className = `border-l-4 p-4 rounded ${colors[type] || colors.info}`;
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="whitespace-pre-wrap font-mono text-sm">${message}</div>
                    <span class="text-xs opacity-70">${new Date().toLocaleTimeString()}</span>
                </div>
            `;
            
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>