<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button.danger { background: #dc3545; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 11px; max-height: 300px; }
        .equipment-card { border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px; background: #f8f9fa; }
        .active { border-left: 4px solid #28a745; }
        .inactive { border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <h1>üîß –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏–∑ localStorage –≤ Supabase</h1>
    
    <div class="section info">
        <h3>üìã –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ equipment_types:</h3>
        <ol>
            <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ localStorage</li>
            <li>–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É equipment_types –≤ Supabase</li>
            <li>–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –ø–æ–ª—è–º–∏</li>
            <li>–û–±–Ω–æ–≤–∏—Ç—å equipmentTypes.ts –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase</li>
        </ol>
        <p><strong>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</strong> –¢–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è - –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è —Å–ø—Ä–∞–≤–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, –Ω—É–∂–Ω–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã equipment</p>
    </div>
    
    <div class="section">
        <button onclick="checkLocalStorageEquipmentTypes()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã –≤ localStorage</button>
        <button onclick="checkSupabaseTable()">üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É equipment_types</button>
        <button onclick="createEquipmentTypesTable()">üîß –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É equipment_types</button>
        <button onclick="migrateEquipmentTypes()" class="success">‚¨ÜÔ∏è –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (typeof data === 'string') {
                    content += `<pre>${data}</pre>`
                } else if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                    let tableContent = '<div>'
                    data.forEach(item => {
                        const cardClass = item.isActive || item.is_active ? 'equipment-card active' : 'equipment-card inactive'
                        tableContent += `
                        <div class="${cardClass}">
                            <strong>${item.name || item.technical_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong> 
                            <code>${item.code || item.technical_code || '–ë–µ–∑ –∫–æ–¥–∞'}</code><br>
                            <small>${item.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</small><br>
                            <em>–°–∏—Å—Ç–µ–º–∞: ${item.systemType || item.system_type || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</em>
                            ${item.availableCommandIds ? `<br><small>–ö–æ–º–∞–Ω–¥—ã: ${item.availableCommandIds.join(', ')}</small>` : ''}
                        </div>`
                    })
                    tableContent += '</div>'
                    content += tableContent
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
        }

        window.checkLocalStorageEquipmentTypes = async function() {
            logResult('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ localStorage...', 'info')
            
            try {
                const equipmentTypesData = localStorage.getItem('equipmentTypes')
                
                if (!equipmentTypesData) {
                    logResult('‚ùå –¢–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage', 'error')
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–ª—é—á–∏
                    const allKeys = []
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i)
                        if (key.toLowerCase().includes('equipment')) {
                            allKeys.push(key)
                        }
                    }
                    
                    if (allKeys.length > 0) {
                        logResult(`üîç –ù–∞–π–¥–µ–Ω—ã –∫–ª—é—á–∏ —Å "equipment": ${allKeys.join(', ')}`, 'warning')
                    }
                    return
                }
                
                let parsed = JSON.parse(equipmentTypesData)
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö
                if (parsed && parsed.data && Array.isArray(parsed.data)) {
                    parsed = parsed.data
                }
                
                if (!Array.isArray(parsed)) {
                    logResult('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', 'error', parsed)
                    return
                }
                
                logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${parsed.length} —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è`, 'success')
                logResult('üìä –¢–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', 'info', parsed)
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ localStorage', 'error', error)
            }
        }

        window.checkSupabaseTable = async function() {
            logResult('üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É equipment_types –≤ Supabase...', 'info')
            
            try {
                const { data, error } = await supabase
                    .from('equipment_types')
                    .select('*')
                    .order('name')
                
                if (error) {
                    logResult('‚ùå –¢–∞–±–ª–∏—Ü–∞ equipment_types –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error', error)
                    return
                }
                
                logResult(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ equipment_types —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ù–∞–π–¥–µ–Ω–æ ${data?.length || 0} –∑–∞–ø–∏—Å–µ–π`, 'success')
                
                if (data && data.length > 0) {
                    logResult('üìä –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', 'info', data)
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–±–ª–∏—Ü—ã equipment_types', 'error', error)
            }
        }

        window.createEquipmentTypesTable = async function() {
            logResult('üîß SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã equipment_types...', 'warning')
            
            const createTableSQL = `
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã equipment_types –¥–ª—è —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
CREATE TABLE IF NOT EXISTS equipment_types (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    system_type VARCHAR(50) NOT NULL,
    is_active BOOLEAN DEFAULT true,
    available_command_ids TEXT[], -- –º–∞—Å—Å–∏–≤ ID –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
    default_params JSONB DEFAULT '{}'::jsonb, -- –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    external_id VARCHAR(50), -- –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π ID –∏–∑ localStorage
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX IF NOT EXISTS idx_equipment_types_code ON equipment_types(code);
CREATE INDEX IF NOT EXISTS idx_equipment_types_system_type ON equipment_types(system_type);
CREATE INDEX IF NOT EXISTS idx_equipment_types_is_active ON equipment_types(is_active);
CREATE INDEX IF NOT EXISTS idx_equipment_types_external_id ON equipment_types(external_id);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç–∞–±–ª–∏—Ü–µ
COMMENT ON TABLE equipment_types IS '–¢–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫';
COMMENT ON COLUMN equipment_types.name IS '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
COMMENT ON COLUMN equipment_types.code IS '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ —Ç–∏–ø–∞';
COMMENT ON COLUMN equipment_types.system_type IS '–°–∏—Å—Ç–µ–º–Ω—ã–π —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
COMMENT ON COLUMN equipment_types.available_command_ids IS '–ú–∞—Å—Å–∏–≤ ID –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥';
COMMENT ON COLUMN equipment_types.default_params IS '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON';
COMMENT ON COLUMN equipment_types.external_id IS '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π ID –∏–∑ localStorage';

-- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ RLS –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
ALTER TABLE equipment_types DISABLE ROW LEVEL SECURITY;
            `
            
            logResult('üìù SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã equipment_types:', 'info', createTableSQL)
            logResult('‚ö†Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL –≤ Supabase SQL Editor –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã', 'warning')
        }

        window.migrateEquipmentTypes = async function() {
            logResult('‚¨ÜÔ∏è –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...', 'info')
            
            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
                const equipmentTypesData = localStorage.getItem('equipmentTypes')
                if (!equipmentTypesData) {
                    logResult('‚ùå –¢–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage', 'error')
                    return
                }
                
                let localStorageData = JSON.parse(equipmentTypesData)
                if (localStorageData && localStorageData.data && Array.isArray(localStorageData.data)) {
                    localStorageData = localStorageData.data
                }
                
                if (!Array.isArray(localStorageData)) {
                    logResult('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö', 'error', localStorageData)
                    return
                }
                
                logResult(`üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ ${localStorageData.length} —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...`, 'info')
                
                let migratedCount = 0
                const errors = []
                
                // 2. –ú–∏–≥—Ä–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                for (const equipmentType of localStorageData) {
                    try {
                        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
                        const equipmentTypeRecord = {
                            name: equipmentType.name,
                            code: equipmentType.code,
                            description: equipmentType.description || null,
                            system_type: equipmentType.systemType,
                            is_active: equipmentType.isActive !== false, // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true
                            available_command_ids: equipmentType.availableCommandIds || null,
                            default_params: equipmentType.defaultParams || {},
                            external_id: equipmentType.id // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π ID
                        }
                        
                        // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                        const { data: insertedType, error: equipmentTypeError } = await supabase
                            .from('equipment_types')
                            .insert([equipmentTypeRecord])
                            .select()
                        
                        if (equipmentTypeError) {
                            errors.push(`–û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —Ç–∏–ø–∞ ${equipmentType.name}: ${equipmentTypeError.message}`)
                            continue
                        }
                        
                        logResult(`‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω —Ç–∏–ø: ${equipmentType.name} (${equipmentType.code})`, 'success')
                        migratedCount++
                        
                    } catch (itemError) {
                        errors.push(`–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–∏–ø–∞ ${equipmentType.name}: ${itemError.message}`)
                    }
                }
                
                // –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
                logResult(`üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —Ç–∏–ø–æ–≤: ${migratedCount}`, 'success')
                
                if (errors.length > 0) {
                    logResult(`‚ö†Ô∏è –û—à–∏–±–∫–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (${errors.length}):`, 'warning', errors)
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const { data: finalData, error: checkError } = await supabase
                    .from('equipment_types')
                    .select('*')
                    .order('name')
                
                if (!checkError) {
                    logResult(`üìä –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã equipment_types (${finalData.length} –∑–∞–ø–∏—Å–µ–π):`, 'info', finalData)
                }
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏', 'error', error)
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 500))
            await checkLocalStorageEquipmentTypes()
        })
    </script>
</body>
</html>