<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Equipment Migration State</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2d3748;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .success { background-color: #2d5a27; }
        .error { background-color: #742a2a; }
        .info { background-color: #2c5aa0; }
        .warning { background-color: #b7791f; }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #3182ce; }
        .log {
            background: #1a202c;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #4a5568;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #2d3748;
        }
    </style>
</head>
<body>
    <h1>üîç Equipment Migration State Checker</h1>
    <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä–∞–∑–¥–µ–ª–∞ "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"</p>

    <div class="container">
        <h2>1. Database Connection Test</h2>
        <button onclick="testConnection()">Test Supabase Connection</button>
        <div id="connection-result" class="log" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>2. Existing Tables Check</h2>
        <button onclick="checkTables()">Check Equipment Tables</button>
        <div id="tables-result" class="log" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>3. Equipment Templates Analysis</h2>
        <button onclick="checkTemplates()">Analyze Templates</button>
        <div id="templates-result" class="log" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>4. Equipment Data Check</h2>
        <button onclick="checkEquipment()">Check Equipment Data</button>
        <div id="equipment-result" class="log" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>5. Migration Recommendations</h2>
        <div id="recommendations" class="info">
            <p>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã—à–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMwNjAzNDcsImV4cCI6MjA0ODYzNjM0N30.0R0hKfITlTOlQHYgP4JVfFQi_7xz3kW5nC7VZq6K3k0';

        let migrationState = {
            connection: false,
            tables: {},
            templates: [],
            equipment: [],
            recommendations: []
        };

        function log(containerId, message, isError = false, isWarning = false) {
            const container = document.getElementById(containerId);
            if (container) {
                container.style.display = 'block';
                const prefix = isError ? '‚ùå ' : isWarning ? '‚ö†Ô∏è ' : '‚úÖ ';
                container.textContent += prefix + message + '\n';
                container.scrollTop = container.scrollHeight;
            }
        }

        async function testConnection() {
            const container = document.getElementById('connection-result');
            container.innerHTML = '';
            
            log('connection-result', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...');

            try {
                // Test basic connectivity
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    log('connection-result', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Supabase —É—Å–ø–µ—à–Ω–æ');
                    migrationState.connection = true;
                    
                    // Test auth
                    const healthResponse = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });

                    if (healthResponse.ok) {
                        log('connection-result', 'API –¥–æ—Å—Ç—É–ø —Ä–∞–±–æ—Ç–∞–µ—Ç');
                    } else {
                        log('connection-result', `API access issue: ${healthResponse.status}`, false, true);
                    }
                } else {
                    throw new Error(`Connection failed: ${response.status} ${response.statusText}`);
                }

            } catch (error) {
                log('connection-result', `–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`, true);
                migrationState.connection = false;
            }
        }

        async function checkTables() {
            const container = document.getElementById('tables-result');
            container.innerHTML = '';
            
            if (!migrationState.connection) {
                log('tables-result', '–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î', true);
                return;
            }

            log('tables-result', '–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...');

            const expectedTables = [
                'equipment_templates',
                'equipment', 
                'equipment_events',
                'equipment_components'
            ];

            try {
                // Check each table
                for (const tableName of expectedTables) {
                    try {
                        const response = await fetch(
                            `${SUPABASE_URL}/rest/v1/${tableName}?select=count&limit=1`, 
                            {
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Range': '0-0'
                                }
                            }
                        );

                        if (response.ok) {
                            const contentRange = response.headers.get('content-range');
                            const totalCount = contentRange ? contentRange.split('/')[1] : '0';
                            
                            log('tables-result', `‚úì ${tableName} exists (${totalCount} –∑–∞–ø–∏—Å–µ–π)`);
                            migrationState.tables[tableName] = {
                                exists: true,
                                count: parseInt(totalCount) || 0
                            };
                        } else if (response.status === 404) {
                            log('tables-result', `‚úó ${tableName} NOT FOUND`, false, true);
                            migrationState.tables[tableName] = {
                                exists: false,
                                count: 0
                            };
                        } else {
                            log('tables-result', `? ${tableName} access error: ${response.status}`, false, true);
                            migrationState.tables[tableName] = {
                                exists: 'unknown',
                                count: 0
                            };
                        }
                    } catch (error) {
                        log('tables-result', `‚úó ${tableName} check failed: ${error.message}`, false, true);
                        migrationState.tables[tableName] = {
                            exists: false,
                            count: 0,
                            error: error.message
                        };
                    }
                }

                // Summary
                const existingTables = Object.entries(migrationState.tables)
                    .filter(([name, info]) => info.exists === true);
                
                log('tables-result', `\nüìä Summary: ${existingTables.length}/${expectedTables.length} tables found`);
                
                if (existingTables.length === expectedTables.length) {
                    log('tables-result', 'üéâ All equipment tables exist!');
                } else {
                    log('tables-result', '‚ö†Ô∏è Some tables are missing - partial migration detected', false, true);
                }

            } catch (error) {
                log('tables-result', `–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–±–ª–∏—Ü: ${error.message}`, true);
            }
        }

        async function checkTemplates() {
            const container = document.getElementById('templates-result');
            container.innerHTML = '';
            
            log('templates-result', '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...');

            try {
                // First, try to access equipment_templates
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/equipment_templates?select=*&order=name`, 
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const templates = await response.json();
                    migrationState.templates = templates;
                    
                    log('templates-result', `–ù–∞–π–¥–µ–Ω–æ ${templates.length} —à–∞–±–ª–æ–Ω–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:`);
                    
                    templates.forEach((template, index) => {
                        const statusText = template.status ? 'Active' : 'Inactive';
                        log('templates-result', `  ${index + 1}. ${template.name} (${template.system_type}) - ${statusText}`);
                    });

                    // Check for required system types
                    const systemTypes = templates.map(t => t.system_type);
                    const requiredTypes = ['fuel_tank', 'fuel_dispenser', 'control_system'];
                    
                    log('templates-result', '\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–∏–ø–æ–≤:');
                    requiredTypes.forEach(type => {
                        if (systemTypes.includes(type)) {
                            log('templates-result', `  ‚úì ${type} - –µ—Å—Ç—å`);
                        } else {
                            log('templates-result', `  ‚úó ${type} - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç`, false, true);
                        }
                    });

                    // Check table structure
                    if (templates.length > 0) {
                        const firstTemplate = templates[0];
                        const hasStatusColumn = firstTemplate.hasOwnProperty('status');
                        
                        if (hasStatusColumn) {
                            log('templates-result', '\n‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ (–µ—Å—Ç—å –ø–æ–ª–µ status)');
                        } else {
                            log('templates-result', '\n‚ùå –ü–†–û–ë–õ–ï–ú–ê: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ status –≤ —Ç–∞–±–ª–∏—Ü–µ!', true);
                        }
                    }

                } else if (response.status === 404) {
                    log('templates-result', '–¢–∞–±–ª–∏—Ü–∞ equipment_templates –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', true);
                    migrationState.templates = [];
                } else {
                    throw new Error(`Templates query failed: ${response.status} ${response.statusText}`);
                }

            } catch (error) {
                log('templates-result', `–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —à–∞–±–ª–æ–Ω–æ–≤: ${error.message}`, true);
                migrationState.templates = [];
            }
        }

        async function checkEquipment() {
            const container = document.getElementById('equipment-result');
            container.innerHTML = '';
            
            log('equipment-result', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/equipment?select=id,display_name,system_type,status,trading_point_id&order=display_name&limit=20`, 
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const equipment = await response.json();
                    migrationState.equipment = equipment;
                    
                    log('equipment-result', `–ù–∞–π–¥–µ–Ω–æ ${equipment.length} –µ–¥–∏–Ω–∏—Ü –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:`);
                    
                    equipment.slice(0, 10).forEach((item, index) => {
                        log('equipment-result', `  ${index + 1}. ${item.display_name} (${item.system_type}) - ${item.status}`);
                    });

                    if (equipment.length > 10) {
                        log('equipment-result', `  ... –∏ –µ—â–µ ${equipment.length - 10} –µ–¥–∏–Ω–∏—Ü`);
                    }

                    // Status distribution
                    const statusCounts = equipment.reduce((acc, item) => {
                        acc[item.status] = (acc[item.status] || 0) + 1;
                        return acc;
                    }, {});

                    log('equipment-result', '\n–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º:');
                    Object.entries(statusCounts).forEach(([status, count]) => {
                        log('equipment-result', `  ${status}: ${count}`);
                    });

                } else if (response.status === 404) {
                    log('equipment-result', '–¢–∞–±–ª–∏—Ü–∞ equipment –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', true);
                    migrationState.equipment = [];
                } else {
                    throw new Error(`Equipment query failed: ${response.status} ${response.statusText}`);
                }

            } catch (error) {
                log('equipment-result', `–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: ${error.message}`, true);
                migrationState.equipment = [];
            }

            generateRecommendations();
        }

        function generateRecommendations() {
            const container = document.getElementById('recommendations');
            
            const tablesExist = Object.values(migrationState.tables).filter(t => t.exists === true).length;
            const templatesCount = migrationState.templates.length;
            const equipmentCount = migrationState.equipment.length;
            
            let recommendations = [];
            let status = 'info';

            if (!migrationState.connection) {
                recommendations.push('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ Supabase');
                status = 'error';
            } else if (tablesExist === 0) {
                recommendations.push('üöÄ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞ - –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é');
                recommendations.push('üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é equipment-migration-manual.sql');
                status = 'warning';
            } else if (tablesExist < 4) {
                recommendations.push('‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞');
                recommendations.push('üîß –ù—É–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü');
                status = 'warning';
            } else if (templatesCount === 0) {
                recommendations.push('‚úÖ –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã, –Ω–æ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
                recommendations.push('üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ seed data –º–∏–≥—Ä–∞—Ü–∏—é');
                status = 'warning';
            } else if (templatesCount < 5) {
                recommendations.push('‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã —à–∞–±–ª–æ–Ω—ã, –Ω–æ –∏—Ö –º–∞–ª–æ');
                recommendations.push('üîß –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã');
                status = 'warning';
            } else {
                recommendations.push('üéâ –ú–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!');
                recommendations.push(`‚úÖ –¢–∞–±–ª–∏—Ü: ${tablesExist}/4`);
                recommendations.push(`‚úÖ –®–∞–±–ª–æ–Ω–æ–≤: ${templatesCount}`);
                recommendations.push(`‚úÖ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: ${equipmentCount}`);
                recommendations.push('üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
                status = 'success';
            }

            container.className = `container ${status}`;
            container.innerHTML = `
                <h2>5. Migration Recommendations</h2>
                ${recommendations.map(rec => `<p>${rec}</p>`).join('')}
            `;
        }
    </script>
</body>
</html>