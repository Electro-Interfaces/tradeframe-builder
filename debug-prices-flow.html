<!DOCTYPE html>
<html>
<head>
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ü–µ–Ω</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <h1 class="text-xl font-bold mb-4">üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ü–µ–Ω</h1>
    
    <div class="bg-yellow-900 border border-yellow-600 rounded-lg p-4 mb-4">
        <h3 class="font-bold">üìã –ü–ª–∞–Ω –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</h3>
        <p>1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SelectionContext –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ID</p>
        <p>2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É pricesSupabaseService</p>
        <p>3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É equipmentSupabase</p>
        <p>4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>
    </div>
    
    <button onclick="runFullDiagnostic()" class="bg-purple-600 px-4 py-2 rounded mb-4">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
    <div id="results" class="mt-4 space-y-2"></div>

    <script>
        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI';
        const SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type === 'error' ? 'text-red-400 bg-red-900 p-3 rounded border border-red-600' : 
                             type === 'success' ? 'text-green-400 bg-green-900 p-3 rounded border border-green-600' : 
                             type === 'warning' ? 'text-yellow-400 bg-yellow-900 p-3 rounded border border-yellow-600' :
                             'text-blue-400 bg-blue-900 p-3 rounded border border-blue-600';
            div.innerHTML = message;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        async function runFullDiagnostic() {
            const results = document.getElementById('results');
            results.innerHTML = '';
            
            log('üöÄ <strong>–ù–ê–ß–ò–ù–ê–ï–ú –ü–û–õ–ù–£–Æ –î–ò–ê–ì–ù–û–°–¢–ò–ö–£ –ü–û–¢–û–ö–ê –î–ê–ù–ù–´–• –¶–ï–ù</strong>');
            
            // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SelectionContext –∏–∑ localStorage
            await step1_checkSelection();
            
            // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏
            await step2_checkTradingPoints();
            
            // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
            await step3_checkTanksWithKeys();
            
            // –®–∞–≥ 4: –≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É pricesSupabaseService
            await step4_emulatePricesService();
        }
        
        async function step1_checkSelection() {
            log('<br>üìç <strong>–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ SelectionContext</strong>');
            
            const selectedNetworkId = localStorage.getItem('selectedNetworkId');
            const selectedTradingPoint = localStorage.getItem('selectedTradingPoint');
            
            log(`üè¢ –í—ã–±—Ä–∞–Ω–Ω–∞—è —Å–µ—Ç—å: ${selectedNetworkId || '–ù–ï –í–´–ë–†–ê–ù–ê'}`);
            log(`üè™ –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞: ${selectedTradingPoint || '–ù–ï –í–´–ë–†–ê–ù–ê'}`);
            
            if (!selectedTradingPoint || selectedTradingPoint === 'all') {
                log('‚ö†Ô∏è <strong>–ü–†–û–ë–õ–ï–ú–ê:</strong> –ù–µ –≤—ã–±—Ä–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞', 'warning');
                log('üí° –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ü–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–æ–π, –Ω–µ —Å "all"', 'warning');
                return false;
            }
            
            log(`‚úÖ –ë—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É: ${selectedTradingPoint}`, 'success');
            return selectedTradingPoint;
        }
        
        async function step2_checkTradingPoints() {
            log('<br>üè™ <strong>–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤ –±–∞–∑–µ</strong>');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å anon key
                const response = await fetch(`${SUPABASE_URL}/rest/v1/trading_points?limit=10`, {
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const points = await response.json();
                    log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ (anon key): ${points.length}`, 'success');
                    
                    points.forEach((tp, i) => {
                        log(`  ${i+1}. ${tp.name} (ID: ${tp.id})`);
                    });
                    
                    return points;
                } else {
                    log(`‚ùå Anon key –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è trading_points: ${response.status}`, 'error');
                    
                    // –ü—Ä–æ–±—É–µ–º —Å service key
                    const serviceResponse = await fetch(`${SUPABASE_URL}/rest/v1/trading_points?limit=10`, {
                        headers: {
                            'apikey': SERVICE_KEY,
                            'Authorization': `Bearer ${SERVICE_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (serviceResponse.ok) {
                        const points = await serviceResponse.json();
                        log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ (service key): ${points.length}`, 'success');
                        log(`‚ö†Ô∏è <strong>–ü–†–û–ë–õ–ï–ú–ê:</strong> Anon key –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω—É–∂–µ–Ω service key`, 'warning');
                        return points;
                    }
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${error.message}`, 'error');
                return [];
            }
        }
        
        async function step3_checkTanksWithKeys() {
            log('<br>üõ¢Ô∏è <strong>–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏</strong>');
            
            const tradingPointId = localStorage.getItem('selectedTradingPoint');
            
            if (!tradingPointId || tradingPointId === 'all') {
                log('‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º - –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏', 'warning');
                return;
            }
            
            // –¢–µ—Å—Ç 1: –° anon key
            log('<br>üîë <strong>–¢–µ—Å—Ç 1: Anon Key</strong>');
            await testTanksWithKey('ANON', ANON_KEY, tradingPointId);
            
            // –¢–µ—Å—Ç 2: –° service key  
            log('<br>üîß <strong>–¢–µ—Å—Ç 2: Service Key</strong>');
            await testTanksWithKey('SERVICE', SERVICE_KEY, tradingPointId);
        }
        
        async function testTanksWithKey(keyType, key, tradingPointId) {
            try {
                const url = `${SUPABASE_URL}/rest/v1/equipment?trading_point_id=eq.${tradingPointId}&system_type=eq.fuel_tank`;
                
                const response = await fetch(url, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üìä ${keyType} Key - Status: ${response.status}`);
                
                if (response.ok) {
                    const tanks = await response.json();
                    log(`‚úÖ ${keyType} Key - –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${tanks.length}`, 'success');
                    
                    if (tanks.length > 0) {
                        log(`<strong>–†–µ–∑–µ—Ä–≤—É–∞—Ä—ã (${keyType}):</strong>`);
                        tanks.forEach((tank, i) => {
                            const fuelType = tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'] || '–ù–ï–¢ –¢–ò–ü–ê';
                            const status = tank.status || 'unknown';
                            const isValid = status !== 'deleted' && tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'];
                            
                            log(`  ${i+1}. ${tank.name} | –¢–æ–ø–ª–∏–≤–æ: ${fuelType} | –°—Ç–∞—Ç—É—Å: ${status} | –í–∞–ª–∏–¥–Ω—ã–π: ${isValid ? '–î–ê' : '–ù–ï–¢'}`);
                        });
                        
                        const validTanks = tanks.filter(t => t.status !== 'deleted' && t.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞']);
                        const fuelTypes = [...new Set(validTanks.map(t => t.params['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞']))];
                        
                        log(`üî• <strong>–ò–¢–û–ì–û –≤–∞–ª–∏–¥–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ (${keyType}): ${validTanks.length}</strong>`, 
                            validTanks.length > 0 ? 'success' : 'error');
                        log(`üî• <strong>–í–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞ (${keyType}): [${fuelTypes.join(', ')}]</strong>`, 
                            fuelTypes.length > 0 ? 'success' : 'error');
                            
                        return { tanks, validTanks, fuelTypes };
                    } else {
                        log(`‚ùå ${keyType} Key - –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`, 'error');
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå ${keyType} Key - –û—à–∏–±–∫–∞: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå ${keyType} Key - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, 'error');
            }
        }
        
        async function step4_emulatePricesService() {
            log('<br>üí∞ <strong>–®–∞–≥ 4: –≠–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç—ã pricesSupabaseService</strong>');
            
            const tradingPointId = localStorage.getItem('selectedTradingPoint');
            
            if (!tradingPointId || tradingPointId === 'all') {
                log('‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º - –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏', 'warning');
                return;
            }
            
            log(`üéØ –≠–º—É–ª–∏—Ä—É–µ–º getFuelTypesInfo –¥–ª—è ${tradingPointId}`);
            
            try {
                // –ü—Ä–æ–±—É–µ–º –æ–±–∞ –∫–ª—é—á–∞
                for (const [keyName, key] of [['ANON', ANON_KEY], ['SERVICE', SERVICE_KEY]]) {
                    log(`<br>üîë <strong>–¢–µ—Å—Ç —Å ${keyName} –∫–ª—é—á–æ–º:</strong>`);
                    
                    // 1. –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã (–∫–∞–∫ –≤ equipmentSupabase.list)
                    const equipmentResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment?trading_point_id=eq.${tradingPointId}&system_type=eq.fuel_tank&limit=100`, {
                        headers: {
                            'apikey': key,
                            'Authorization': `Bearer ${key}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!equipmentResponse.ok) {
                        log(`‚ùå ${keyName}: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å equipment (${equipmentResponse.status})`, 'error');
                        continue;
                    }
                    
                    const allTanks = await equipmentResponse.json();
                    log(`üìä ${keyName}: –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${allTanks.length}`);
                    
                    // 2. –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∞–ª–∏–¥–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã (–∫–∞–∫ –≤ pricesSupabaseService)
                    const validTanks = allTanks.filter(tank => tank.status !== 'deleted' && tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞']);
                    log(`‚úÖ ${keyName}: –í–∞–ª–∏–¥–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${validTanks.length}`, validTanks.length > 0 ? 'success' : 'error');
                    
                    if (validTanks.length > 0) {
                        // 3. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≤–∏–¥–∞–º —Ç–æ–ø–ª–∏–≤–∞
                        const fuelTypesMap = new Map();
                        
                        validTanks.forEach(tank => {
                            const fuelType = tank.params['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'];
                            const capacity = tank.params['–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–ª)'] || 0;
                            const currentLevel = tank.params['–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å (–ª)'] || 0;
                            
                            if (!fuelTypesMap.has(fuelType)) {
                                fuelTypesMap.set(fuelType, {
                                    tanks: [],
                                    totalVolume: 0,
                                    currentLevel: 0
                                });
                            }
                            
                            const fuelData = fuelTypesMap.get(fuelType);
                            fuelData.tanks.push(tank);
                            fuelData.totalVolume += capacity;
                            fuelData.currentLevel += currentLevel;
                        });
                        
                        // 4. –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        const fuelTypesInfo = Array.from(fuelTypesMap.entries()).map(([fuelType, data]) => ({
                            fuel_type: fuelType,
                            tanks_count: data.tanks.length,
                            total_volume: data.totalVolume,
                            current_level: data.currentLevel,
                            has_price: false,
                            current_price: null
                        }));
                        
                        log(`üî• <strong>${keyName}: –ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢ getFuelTypesInfo:</strong>`, 'success');
                        log(`üî• <strong>–ù–∞–π–¥–µ–Ω–æ –≤–∏–¥–æ–≤ —Ç–æ–ø–ª–∏–≤–∞: ${fuelTypesInfo.length}</strong>`, 'success');
                        
                        fuelTypesInfo.forEach((fuel, i) => {
                            log(`  ${i+1}. ${fuel.fuel_type} (${fuel.tanks_count} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤, ${fuel.total_volume}–ª)`);
                        });
                        
                        if (fuelTypesInfo.length > 0) {
                            log(`<br>‚úÖ <strong>–í–´–í–û–î –¥–ª—è ${keyName}:</strong> –î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å, pricesSupabaseService –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å!`, 'success');
                        }
                    } else {
                        log(`‚ùå ${keyName}: –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ü–µ–Ω –±—É–¥–µ—Ç –ø—É—Å—Ç–æ–π`, 'error');
                    }
                }
                
                log('<br>üí° <strong>–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:</strong>');
                log('1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ http://localhost:3000/point/prices');
                log('2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ (–Ω–µ "all")'); 
                log('3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫–æ–π –∫–ª—é—á –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å anon –∏–∑ .env)');
                log('4. –ï—Å–ª–∏ anon key –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö Supabase');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —ç–º—É–ª—è—Ü–∏–∏: ${error.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        runFullDiagnostic();
    </script>
</body>
</html>