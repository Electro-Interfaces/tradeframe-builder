<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1e1e1e; 
            color: #fff; 
            padding: 20px; 
            line-height: 1.4;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .code { 
            background: #0d1117; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #444;
            overflow-x: auto;
        }
        .highlight { 
            background: #2d4a22; 
            padding: 10px; 
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üîç –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –¢–û–†–ì–û–í–´–• –¢–û–ß–ï–ö</h1>
    <p>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —Ç–∞–±–ª–∏—Ü—ã trading_points (–±–µ–∑ –ø–æ–ª—è code)</p>
    
    <button onclick="debugTradingPointsFixed()">üöÄ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)</button>
    <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
    
    <div id="log"></div>

    <script type="module">
        const TARGET_ID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
        const log = document.getElementById('log');
        
        function addLog(message, type = 'normal') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            log.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        window.clearLog = function() {
            log.innerHTML = '';
        }
        
        window.debugTradingPointsFixed = async function() {
            addLog('üîç –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –¢–û–†–ì–û–í–´–• –¢–û–ß–ï–ö', 'info');
            addLog('‚ö†Ô∏è –£–±—Ä–∞–ª–∏ –ø–æ–ª–µ "code" –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (–µ–≥–æ –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ)', 'warning');
            
            try {
                const { httpClient } = await import('/src/services/universalHttpClient.ts');
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–µ—Ç–∏ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏
                addLog('üåê –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ç–µ–π...', 'info');
                const networksResponse = await httpClient.get('/rest/v1/networks', {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id,code',
                        order: 'name'
                    }
                });
                
                let networksMap = {};
                if (networksResponse.success && networksResponse.data) {
                    networksResponse.data.forEach(network => {
                        networksMap[network.id] = network;
                        addLog(`–°–µ—Ç—å: "${network.name}" (ID: ${network.id}, External: ${network.external_id || '–ù–ï–¢'})`, 'info');
                    });
                }
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –∑–∞–ø—Ä–æ—Å - –ë–ï–ó –ø–æ–ª—è code
                addLog('üìç –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ (–ë–ï–ó –ø–æ–ª—è code)...', 'info');
                
                const allTpResponse = await httpClient.get('/rest/v1/trading_points', {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id,network_id',  // —É–±—Ä–∞–ª–∏ code
                        order: 'name'
                    }
                });
                
                if (!allTpResponse.success) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫', 'error');
                    addLog(`–û—à–∏–±–∫–∞: ${allTpResponse.error}`, 'error');
                    return;
                }
                
                if (!allTpResponse.data || allTpResponse.data.length === 0) {
                    addLog('‚ùå –í —Ç–∞–±–ª–∏—Ü–µ trading_points –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π!', 'error');
                    return;
                }
                
                addLog(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤ –ë–î: ${allTpResponse.data.length}`, 'success');
                
                // –ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
                let foundTarget = null;
                let networkIdsCount = {};
                
                addLog('üìã –°–ü–ò–°–û–ö –í–°–ï–• –¢–û–†–ì–û–í–´–• –¢–û–ß–ï–ö:', 'info');
                
                allTpResponse.data.forEach((tp, index) => {
                    const isTarget = tp.id === TARGET_ID;
                    const networkInfo = networksMap[tp.network_id];
                    
                    if (isTarget) {
                        foundTarget = tp;
                    }
                    
                    // –ü–æ–¥—Å—á–µ—Ç network_id
                    if (tp.network_id) {
                        networkIdsCount[tp.network_id] = (networkIdsCount[tp.network_id] || 0) + 1;
                    }
                    
                    addLog(`<div class="code" style="background: ${isTarget ? '#2d4a22' : '#0d1117'};">
                        –¢–ü ${index + 1}: ${tp.name} ${isTarget ? 'üéØ –ò–°–ö–û–ú–ê–Ø' : ''}<br>
                        - ID: ${tp.id}<br>
                        - External ID: ${tp.external_id || '‚ùå –ù–ï–¢'}<br>
                        - Network ID: ${tp.network_id || '‚ùå –ù–ï–¢'}<br>
                        - –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è —Å–µ—Ç—å: ${networkInfo ? `"${networkInfo.name}"` : '‚ùå –°–ï–¢–¨ –ù–ï –ù–ê–ô–î–ï–ù–ê'}
                    </div>`, isTarget ? 'success' : 'info');
                });
                
                // –ê–Ω–∞–ª–∏–∑ —Å–≤—è–∑–µ–π network_id
                addLog('üîó –ê–ù–ê–õ–ò–ó –°–í–Ø–ó–ï–ô –¢–û–†–ì–û–í–´–• –¢–û–ß–ï–ö –° –°–ï–¢–Ø–ú–ò:', 'info');
                Object.keys(networkIdsCount).forEach(networkId => {
                    const count = networkIdsCount[networkId];
                    const networkInfo = networksMap[networkId];
                    
                    addLog(`<div class="code">
                        Network ID: ${networkId}<br>
                        –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ç–∏: ${networkInfo ? `"${networkInfo.name}"` : '‚ùå –°–ï–¢–¨ –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢'}<br>
                        –¢–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤ —ç—Ç–æ–π —Å–µ—Ç–∏: ${count}<br>
                        –°—Ç–∞—Ç—É—Å —Å–≤—è–∑–∏: ${networkInfo ? '‚úÖ –ö–û–†–†–ï–ö–¢–ù–û' : '‚ùå –ü–†–û–ë–õ–ï–ú–ê'}
                    </div>`, networkInfo ? 'success' : 'error');
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–∫–æ–º–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
                if (foundTarget) {
                    addLog('üéØ –ê–ù–ê–õ–ò–ó –ò–°–ö–û–ú–û–ô –¢–û–†–ì–û–í–û–ô –¢–û–ß–ö–ò:', 'success');
                    const networkInfo = networksMap[foundTarget.network_id];
                    
                    addLog(`<div class="highlight">
                        –ò–°–ö–û–ú–ê–Ø –¢–û–†–ì–û–í–ê–Ø –¢–û–ß–ö–ê –ù–ê–ô–î–ï–ù–ê!<br>
                        ‚ûú ID: ${foundTarget.id}<br>
                        ‚ûú –ù–∞–∑–≤–∞–Ω–∏–µ: ${foundTarget.name}<br>
                        ‚ûú External ID: ${foundTarget.external_id || '‚ùå –ù–ï–¢'}<br>
                        ‚ûú Network ID: ${foundTarget.network_id}<br>
                        ‚ûú –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è —Å–µ—Ç—å: ${networkInfo ? `"${networkInfo.name}"` : '‚ùå –°–ï–¢–¨ –ù–ï –ù–ê–ô–î–ï–ù–ê'}
                    </div>`, 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                    const systemId = networkInfo?.external_id || networkInfo?.code || '';
                    const stationId = foundTarget.external_id || '';  // —É–±—Ä–∞–ª–∏ code
                    
                    addLog(`<div class="highlight">
                        API –ü–ê–†–ê–ú–ï–¢–†–´ –î–õ–Ø –ò–°–ö–û–ú–û–ô –¢–û–†–ì–û–í–û–ô –¢–û–ß–ö–ò:<br>
                        ‚ûú System ID (–æ—Ç —Å–µ—Ç–∏): "${systemId}" ${systemId ? '‚úÖ' : '‚ùå'}<br>
                        ‚ûú Station ID (–æ—Ç –¢–ü): "${stationId}" ${stationId ? '‚úÖ' : '‚ùå'}<br>
                        ‚ûú –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –¥–ª—è API: ${systemId && stationId ? '‚úÖ –ì–û–¢–û–í–ê' : '‚ùå –ù–ï –ì–û–¢–û–í–ê'}<br>
                        ${systemId && stationId ? `‚ûú URL: https://pos.autooplata.ru/tms/tanks?system=${systemId}&station=${stationId}` : '‚ûú –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å external_id'}
                    </div>`, systemId && stationId ? 'success' : 'error');
                    
                    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ø–æ network_id
                    addLog('üß™ –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –ø–æ network_id –∏—Å–∫–æ–º–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏...', 'info');
                    const testSearchResponse = await httpClient.get('/rest/v1/trading_points', {
                        destination: 'supabase',
                        queryParams: {
                            select: 'id,name,network_id',
                            network_id: `eq.${foundTarget.network_id}`
                        }
                    });
                    
                    if (testSearchResponse.success && testSearchResponse.data && testSearchResponse.data.length > 0) {
                        addLog(`‚úÖ –ü–æ–∏—Å–∫ –ø–æ network_id —Ä–∞–±–æ—Ç–∞–µ—Ç! –ù–∞–π–¥–µ–Ω–æ –≤ —Å–µ—Ç–∏: ${testSearchResponse.data.length}`, 'success');
                        testSearchResponse.data.forEach((tp, i) => {
                            addLog(`${i + 1}. ${tp.name} (ID: ${tp.id.substring(0, 8)}...)`, 'success');
                        });
                    } else {
                        addLog('‚ùå –ü–æ–∏—Å–∫ –ø–æ network_id –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'error');
                    }
                    
                } else {
                    addLog(`‚ùå –ò—Å–∫–æ–º–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ ${TARGET_ID} –ù–ï –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö`, 'error');
                }
                
                // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–ª—è API
                addLog('üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ì–û–¢–û–í–ù–û–°–¢–ò –î–õ–Ø API:', 'info');
                let readyCount = 0;
                
                allTpResponse.data.forEach(tp => {
                    const networkInfo = networksMap[tp.network_id];
                    const systemId = networkInfo?.external_id || networkInfo?.code || '';
                    const stationId = tp.external_id || '';  // —É–±—Ä–∞–ª–∏ code
                    const ready = !!(systemId && stationId);
                    
                    if (ready) readyCount++;
                });
                
                addLog(`<div class="highlight">
                    –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:<br>
                    ‚ûú –í—Å–µ–≥–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${allTpResponse.data.length}<br>
                    ‚ûú –ì–æ—Ç–æ–≤—ã—Ö –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API: ${readyCount}<br>
                    ‚ûú –ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: ${Math.round(readyCount / allTpResponse.data.length * 100)}%<br>
                    ‚ûú –°—Ç–∞—Ç—É—Å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞: ${readyCount > 0 ? '‚úÖ –ú–û–ñ–ï–¢ –†–ê–ë–û–¢–ê–¢–¨ –° API' : '‚ùå –ù–£–ñ–ù–û –ù–ê–°–¢–†–û–ò–¢–¨ EXTERNAL_ID'}
                </div>`, readyCount > 0 ? 'success' : 'warning');
                
            } catch (error) {
                addLog(`üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
                addLog(`<div class="code">${error.stack}</div>`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        addLog('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');
        setTimeout(debugTradingPointsFixed, 1000);
    </script>
</body>
</html>