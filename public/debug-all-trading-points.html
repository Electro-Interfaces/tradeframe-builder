<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –í—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –≤ –ë–î</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1e1e1e; 
            color: #fff; 
            padding: 20px; 
            line-height: 1.4;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .code { 
            background: #0d1117; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #444;
            overflow-x: auto;
        }
        .highlight { 
            background: #2d4a22; 
            padding: 10px; 
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üîç –í–°–ï –¢–û–†–ì–û–í–´–ï –¢–û–ß–ö–ò –í –ë–ê–ó–ï –î–ê–ù–ù–´–•</h1>
    <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –∏—Ö —Ä–µ–∞–ª—å–Ω—ã–µ network_id</p>
    
    <button onclick="debugAllTradingPoints()">üöÄ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏</button>
    <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
    
    <div id="log"></div>

    <script type="module">
        const TARGET_ID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
        const log = document.getElementById('log');
        
        function addLog(message, type = 'normal') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            log.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        window.clearLog = function() {
            log.innerHTML = '';
        }
        
        window.debugAllTradingPoints = async function() {
            addLog('üîç –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –í–°–ï–• –¢–û–†–ì–û–í–´–• –¢–û–ß–ï–ö', 'info');
            
            try {
                const { httpClient } = await import('/src/services/universalHttpClient.ts');
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–µ—Ç–∏ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏
                addLog('üåê –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ç–µ–π –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏...', 'info');
                const networksResponse = await httpClient.get('/rest/v1/networks', {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id,code',
                        order: 'name'
                    }
                });
                
                let networksMap = {};
                if (networksResponse.success && networksResponse.data) {
                    networksResponse.data.forEach(network => {
                        networksMap[network.id] = network;
                        addLog(`–°–µ—Ç—å: "${network.name}" (ID: ${network.id}, External: ${network.external_id || '–ù–ï–¢'})`, 'info');
                    });
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
                addLog('üìç –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å–µ—Ç–∏...', 'info');
                
                const allTpResponse = await httpClient.get('/rest/v1/trading_points', {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id,code,network_id',
                        order: 'name'
                    }
                });
                
                if (!allTpResponse.success) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫', 'error');
                    addLog(`–û—à–∏–±–∫–∞: ${allTpResponse.error}`, 'error');
                    return;
                }
                
                if (!allTpResponse.data || allTpResponse.data.length === 0) {
                    addLog('‚ùå –í —Ç–∞–±–ª–∏—Ü–µ trading_points –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π!', 'error');
                    return;
                }
                
                addLog(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤ –ë–î: ${allTpResponse.data.length}`, 'success');
                
                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É
                addLog('üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ö–ê–ñ–î–û–ô –¢–û–†–ì–û–í–û–ô –¢–û–ß–ö–ò:', 'info');
                
                let foundTarget = null;
                let networkIdsCount = {};
                
                allTpResponse.data.forEach((tp, index) => {
                    const isTarget = tp.id === TARGET_ID;
                    const networkInfo = networksMap[tp.network_id];
                    
                    if (isTarget) {
                        foundTarget = tp;
                    }
                    
                    // –ü–æ–¥—Å—á–µ—Ç network_id
                    if (tp.network_id) {
                        networkIdsCount[tp.network_id] = (networkIdsCount[tp.network_id] || 0) + 1;
                    }
                    
                    addLog(`<div class="code" style="background: ${isTarget ? '#2d4a22' : '#0d1117'};">
                        –¢–ü ${index + 1}: ${tp.name} ${isTarget ? 'üéØ –ò–°–ö–û–ú–ê–Ø' : ''}<br>
                        - ID: ${tp.id}<br>
                        - External ID: ${tp.external_id || '‚ùå –ù–ï–¢'}<br>
                        - Code: ${tp.code || '‚ùå –ù–ï–¢'}<br>
                        - Network ID: ${tp.network_id || '‚ùå –ù–ï–¢'}<br>
                        - –°–µ—Ç—å: ${networkInfo ? networkInfo.name : '‚ùå –°–ï–¢–¨ –ù–ï –ù–ê–ô–î–ï–ù–ê'}<br>
                        - –°–µ—Ç—å External ID: ${networkInfo?.external_id || '‚ùå –ù–ï–¢'}
                    </div>`, isTarget ? 'success' : 'info');
                });
                
                // –ê–Ω–∞–ª–∏–∑ network_id
                addLog('üìä –ê–ù–ê–õ–ò–ó NETWORK_ID –í –¢–û–†–ì–û–í–´–• –¢–û–ß–ö–ê–•:', 'info');
                Object.keys(networkIdsCount).forEach(networkId => {
                    const count = networkIdsCount[networkId];
                    const networkInfo = networksMap[networkId];
                    addLog(`<div class="code">
                        Network ID: ${networkId}<br>
                        –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ç–∏: ${networkInfo ? networkInfo.name : '‚ùå –ù–ï –ù–ê–ô–î–ï–ù–ê'}<br>
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${count}<br>
                        –°—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ networks: ${networkInfo ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}
                    </div>`, networkInfo ? 'success' : 'error');
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–∫–æ–º–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
                if (foundTarget) {
                    addLog('üéØ –ù–ê–ô–î–ï–ù–ê –ò–°–ö–û–ú–ê–Ø –¢–û–†–ì–û–í–ê–Ø –¢–û–ß–ö–ê!', 'success');
                    const networkInfo = networksMap[foundTarget.network_id];
                    
                    addLog(`<div class="highlight">
                        –ò–°–ö–û–ú–ê–Ø –¢–û–†–ì–û–í–ê–Ø –¢–û–ß–ö–ê:<br>
                        ‚ûú ID: ${foundTarget.id}<br>
                        ‚ûú –ù–∞–∑–≤–∞–Ω–∏–µ: ${foundTarget.name}<br>
                        ‚ûú External ID: ${foundTarget.external_id || '‚ùå –ù–ï–¢'}<br>
                        ‚ûú Code: ${foundTarget.code || '‚ùå –ù–ï–¢'}<br>
                        ‚ûú Network ID: ${foundTarget.network_id}<br>
                        ‚ûú –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è —Å–µ—Ç—å: ${networkInfo ? networkInfo.name : '‚ùå –ù–ï –ù–ê–ô–î–ï–ù–ê'}<br>
                        ‚ûú System ID (–æ—Ç —Å–µ—Ç–∏): ${networkInfo?.external_id || networkInfo?.code || '‚ùå –ù–ï–¢'}<br>
                        ‚ûú Station ID (–æ—Ç –¢–ü): ${foundTarget.external_id || foundTarget.code || '‚ùå –ù–ï–¢'}
                    </div>`, 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä–∏–º –ø–æ—á–µ–º—É –ø–æ–∏—Å–∫ –ø–æ network_id –Ω–µ —Ä–∞–±–æ—Ç–∞–ª
                    addLog('üîß –ü–†–û–í–ï–†–ö–ê –ü–û–ò–°–ö–ê –ü–û NETWORK_ID...', 'info');
                    const testSearchResponse = await httpClient.get('/rest/v1/trading_points', {
                        destination: 'supabase',
                        queryParams: {
                            select: 'id,name,network_id',
                            network_id: `eq.${foundTarget.network_id}`
                        }
                    });
                    
                    if (testSearchResponse.success && testSearchResponse.data && testSearchResponse.data.length > 0) {
                        addLog(`‚úÖ –ü–æ–∏—Å–∫ –ø–æ network_id —Ä–∞–±–æ—Ç–∞–µ—Ç! –ù–∞–π–¥–µ–Ω–æ: ${testSearchResponse.data.length}`, 'success');
                        testSearchResponse.data.forEach(tp => {
                            addLog(`- ${tp.name} (ID: ${tp.id})`, 'success');
                        });
                    } else {
                        addLog('‚ùå –ü–æ–∏—Å–∫ –ø–æ network_id –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'error');
                        addLog(`–û—à–∏–±–∫–∞: ${testSearchResponse.error}`, 'error');
                    }
                    
                } else {
                    addLog(`‚ùå –ò—Å–∫–æ–º–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ ${TARGET_ID} –ù–ï –Ω–∞–π–¥–µ–Ω–∞`, 'error');
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ API –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                addLog('üîß –ü–†–û–í–ï–†–ö–ê –ì–û–¢–û–í–ù–û–°–¢–ò –î–õ–Ø API:', 'info');
                let readyCount = 0;
                
                allTpResponse.data.forEach(tp => {
                    const networkInfo = networksMap[tp.network_id];
                    const systemId = networkInfo?.external_id || networkInfo?.code || '';
                    const stationId = tp.external_id || tp.code || '';
                    const ready = !!(systemId && stationId);
                    
                    if (ready) readyCount++;
                    
                    addLog(`${tp.name}: ${ready ? '‚úÖ –ì–û–¢–û–í–ê' : '‚ùå –ù–ï –ì–û–¢–û–í–ê'} (System: "${systemId}", Station: "${stationId}")`, ready ? 'success' : 'warning');
                });
                
                addLog(`<div class="highlight">
                    –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:<br>
                    ‚ûú –í—Å–µ–≥–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${allTpResponse.data.length}<br>
                    ‚ûú –ì–æ—Ç–æ–≤—ã—Ö –¥–ª—è API: ${readyCount}<br>
                    ‚ûú –ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: ${Math.round(readyCount / allTpResponse.data.length * 100)}%
                </div>`, readyCount > 0 ? 'success' : 'warning');
                
            } catch (error) {
                addLog(`üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
                addLog(`<div class="code">${error.stack}</div>`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        addLog('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');
        setTimeout(debugAllTradingPoints, 1000);
    </script>
</body>
</html>