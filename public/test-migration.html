<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–µ—Ç–µ–π –≤ Supabase</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            padding: 20px; 
            background: #0f0f0f; 
            color: #e5e5e5; 
            line-height: 1.5;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
        }
        .button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #1d4ed8; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .button:hover { 
            background: #1e40af; 
        }
        .button:disabled {
            background: #4b5563;
            cursor: not-allowed;
        }
        .result { 
            margin: 16px 0; 
            padding: 16px; 
            background: #1f2937; 
            border-radius: 6px; 
            font-family: 'Courier New', monospace; 
            font-size: 13px;
            white-space: pre-wrap; 
            overflow-x: auto;
        }
        .success { 
            border-left: 4px solid #10b981; 
        }
        .error { 
            border-left: 4px solid #ef4444; 
        }
        .warning {
            border-left: 4px solid #f59e0b;
        }
        .info {
            border-left: 4px solid #3b82f6;
        }
        .network-list { 
            margin: 16px 0; 
        }
        .network-item { 
            padding: 12px; 
            margin: 8px 0; 
            background: #374151; 
            border-radius: 6px; 
            border-left: 3px solid #10b981;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }
        .status-supabase {
            background: #10b981;
            color: white;
        }
        .status-mock {
            background: #f59e0b;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–µ—Ç–µ–π</h1>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö Supabase</p>
        
        <div>
            <button class="button" onclick="checkStatus()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            <button class="button" onclick="testSupabaseConnection()">üîå –¢–µ—Å—Ç Supabase</button>
            <button class="button" onclick="checkRLS()">üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RLS</button>
            <button class="button" onclick="fixRLS()">üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å RLS</button>
            <button class="button" onclick="disableAllRLS()">üõ°Ô∏è –û—Ç–∫–ª—é—á–∏—Ç—å RLS –≤–µ–∑–¥–µ</button>
            <button class="button" onclick="setupNetworksTable()">üèóÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
            <button class="button" onclick="loadNetworks()">üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ç–∏</button>
            <button class="button" onclick="runMigration()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é</button>
            <button class="button" onclick="createTestNetwork()">‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å–µ—Ç—å</button>
            <button class="button" onclick="clearResults()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div id="results"></div>
    </div>

    <script type="module">
        let networksService, apiConfigService, supabase;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
        async function initServices() {
            try {
                const networksModule = await import('/src/services/networksService.ts');
                const apiModule = await import('/src/services/apiConfigService.ts');
                const supabaseModule = await import('/src/api/database/supabase.ts');
                
                networksService = networksModule.networksService;
                apiConfigService = apiModule.apiConfigService;
                supabase = supabaseModule.supabase;
                
                console.log('‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤:', error);
                addResult('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤: ' + error.message, 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function addResult(text, type = 'info') {
            const result = document.createElement('div');
            result.className = `result ${type}`;
            result.textContent = text;
            document.getElementById('results').appendChild(result);
            result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        window.checkStatus = async function() {
            if (!apiConfigService) await initServices();
            
            try {
                const config = apiConfigService.getCurrentConfig();
                const connection = apiConfigService.getCurrentConnection();
                const apiMode = apiConfigService.getApiMode();
                
                const statusText = `üìä –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´:

üîß –†–µ–∂–∏–º API: ${apiMode}
üîó –ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${connection?.name || '–ù–ï –ù–ê–ô–î–ï–ù–û'}
üìç URL: ${connection?.url || '–ù–ï –ù–ê–ô–î–ï–ù–û'}
üìã –í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: ${config.availableConnections.length}

üåê –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   VITE_SUPABASE_URL: ${import.meta.env.VITE_SUPABASE_URL || '–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–ê'}
   VITE_SUPABASE_ANON_KEY: ${import.meta.env.VITE_SUPABASE_ANON_KEY ? '–£–°–¢–ê–ù–û–í–õ–ï–ù–ê' : '–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–ê'}`;
                
                addResult(statusText, apiMode === 'supabase' ? 'success' : 'warning');
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message, 'error');
            }
        };
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ç–µ–π
        window.loadNetworks = async function() {
            if (!networksService) await initServices();
            
            addResult('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–µ—Ç–∏...', 'info');
            
            try {
                const networks = await networksService.getAll();
                
                let resultText = `‚úÖ –ó–ê–ì–†–£–ñ–ï–ù–û –°–ï–¢–ï–ô: ${networks.length}\n\n`;
                
                if (networks.length === 0) {
                    resultText += 'üì≠ –°–ø–∏—Å–æ–∫ —Å–µ—Ç–µ–π –ø—É—Å—Ç';
                } else {
                    resultText += 'üìã –°–ü–ò–°–û–ö –°–ï–¢–ï–ô:\n';
                    networks.forEach((network, index) => {
                        resultText += `${index + 1}. üè™ ${network.name} (ID: ${network.id})\n`;
                        resultText += `   üìù ${network.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}\n`;
                        resultText += `   üìä –¢–æ—á–µ–∫: ${network.pointsCount}\n`;
                        if (network.created_at) {
                            resultText += `   ‚è∞ –°–æ–∑–¥–∞–Ω–∞: ${new Date(network.created_at).toLocaleString()}\n`;
                        }
                        resultText += '\n';
                    });
                }
                
                addResult(resultText, networks.length > 0 ? 'success' : 'warning');
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ç–µ–π: ' + error.message + '\nStack: ' + error.stack, 'error');
            }
        };
        
        // –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏
        window.runMigration = async function() {
            if (!networksService) await initServices();
            
            addResult('üöÄ –ó–ê–ü–£–°–ö –ú–ò–ì–†–ê–¶–ò–ò –î–ê–ù–ù–´–• –í SUPABASE...', 'info');
            
            try {
                const result = await networksService.migrateToSupabase();
                
                let resultText = '';
                if (result.success) {
                    resultText = `‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!

üìà –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ —Å–µ—Ç–µ–π: ${result.migrated || 0}
‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç): ${result.skipped || 0}
üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: ${result.message}`;
                    addResult(resultText, 'success');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    setTimeout(() => window.loadNetworks(), 1000);
                } else {
                    resultText = `‚ùå –ú–ò–ì–†–ê–¶–ò–Ø –ù–ï –£–î–ê–õ–ê–°–¨: ${result.message}`;
                    addResult(resultText, 'error');
                }
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: ' + error.message + '\nStack: ' + error.stack, 'error');
            }
        };
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏
        window.createTestNetwork = async function() {
            if (!networksService) await initServices();
            
            const testData = {
                name: `–¢–µ—Å—Ç–æ–≤–∞—è —Å–µ—Ç—å ${new Date().toLocaleTimeString()}`,
                description: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω–∞—è —Å–µ—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Supabase',
                type: '–ê–ó–°'
            };
            
            addResult('üèóÔ∏è –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Å–µ—Ç—å: ' + testData.name, 'info');
            
            try {
                const newNetwork = await networksService.create(testData);
                
                const resultText = `‚úÖ –°–ï–¢–¨ –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù–ê!

üè™ –ù–∞–∑–≤–∞–Ω–∏–µ: ${newNetwork.name}
üÜî ID: ${newNetwork.id}
üìù –û–ø–∏—Å–∞–Ω–∏–µ: ${newNetwork.description}
üè∑Ô∏è –¢–∏–ø: ${newNetwork.type}
‚è∞ –°–æ–∑–¥–∞–Ω–∞: ${newNetwork.created_at ? new Date(newNetwork.created_at).toLocaleString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
                
                addResult(resultText, 'success');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                setTimeout(() => window.loadNetworks(), 500);
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏: ' + error.message + '\nStack: ' + error.stack, 'error');
            }
        };
        
        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase
        window.testSupabaseConnection = async function() {
            if (!supabase) await initServices();
            
            addResult('üîå –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...', 'info');
            
            try {
                // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ networks
                const { data, error, count } = await supabase
                    .from('networks')
                    .select('*', { count: 'exact' })
                    .limit(5);
                
                if (error) {
                    addResult(`‚ùå –û—à–∏–±–∫–∞ Supabase: ${error.message}\n–ö–æ–¥: ${error.code}\n–î–µ—Ç–∞–ª–∏: ${error.details}`, 'error');
                    return;
                }
                
                let resultText = `‚úÖ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö SUPABASE –£–°–ü–ï–®–ù–û!

üìä –ó–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ networks: ${count || 0}\n`;
                
                if (data && data.length > 0) {
                    resultText += '\nüìã –ü–µ—Ä–≤—ã–µ –∑–∞–ø–∏—Å–∏:\n';
                    data.forEach((record, index) => {
                        resultText += `${index + 1}. ${record.name} (${record.code})\n`;
                    });
                } else {
                    resultText += '\nüì≠ –¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π';
                }
                
                addResult(resultText, 'success');
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase: ' + error.message, 'error');
            }
        };
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS –ø–æ–ª–∏—Ç–∏–∫
        window.checkRLS = async function() {
            if (!supabase) await initServices();
            
            addResult('üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã networks...', 'info');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                const { data: session } = await supabase.auth.getSession();
                const isAuthorized = !!session?.session?.user;
                
                addResult(`üë§ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: ${isAuthorized ? '–ï—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '–ê–Ω–æ–Ω–∏–º–Ω—ã–π –¥–æ—Å—Ç—É–ø'}`, 'info');
                
                // –ü—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ
                const { data: directData, error: directError, count } = await supabase
                    .from('networks')
                    .select('*', { count: 'exact' });
                
                let resultText = `üìä –†–ï–ó–£–õ–¨–¢–ê–¢ –ü–†–û–í–ï–†–ö–ò RLS:

üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: ${count || 0}
‚ùì –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${directError ? '–î–∞' : '–ù–µ—Ç'}`;

                if (directError) {
                    resultText += `\n‚ùå –û—à–∏–±–∫–∞: ${directError.message}`;
                    resultText += `\nüîç –ö–æ–¥ –æ—à–∏–±–∫–∏: ${directError.code}`;
                    resultText += `\nüí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: ${directError.hint || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}`;
                }
                
                if (directData && directData.length > 0) {
                    resultText += '\n\nüìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏:';
                    directData.forEach((record, index) => {
                        resultText += `\n${index + 1}. ${record.name} (ID: ${record.id})`;
                    });
                    addResult(resultText, 'success');
                } else if (!directError) {
                    resultText += '\n\nüì≠ –ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (–Ω–æ –æ—à–∏–±–∫–∏ –Ω–µ—Ç)';
                    addResult(resultText, 'warning');
                } else {
                    resultText += '\n\nüö® –ü–†–û–ë–õ–ï–ú–ê: –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø';
                    resultText += '\nüí° –†–µ—à–µ–Ω–∏–µ: –ù—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å RLS –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É';
                    addResult(resultText, 'error');
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –ø–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å
                if (!directError) {
                    addResult('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏...', 'info');
                    
                    const testNetwork = {
                        name: `RLS Test ${Date.now()}`,
                        code: `rls_test_${Date.now()}`,
                        description: '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ RLS',
                        status: 'active'
                    };
                    
                    const { data: insertData, error: insertError } = await supabase
                        .from('networks')
                        .insert(testNetwork)
                        .select()
                        .single();
                    
                    if (insertError) {
                        addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${insertError.message}`, 'error');
                    } else {
                        addResult(`‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞: ${insertData.name}`, 'success');
                        
                        // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
                        await supabase
                            .from('networks')
                            .delete()
                            .eq('id', insertData.id);
                        addResult('üóëÔ∏è –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'info');
                    }
                }
                
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ RLS: ' + error.message, 'error');
            }
        };
        
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫
        window.fixRLS = async function() {
            if (!supabase) await initServices();
            
            addResult('üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã networks...', 'info');
            
            try {
                // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è —á—Ç–µ–Ω–∏—è
                addResult('üìù –°–æ–∑–¥–∞–µ–º –ø—É–±–ª–∏—á–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è SELECT...', 'info');
                
                const selectPolicy = `
                CREATE POLICY "Enable read access for all users" ON "public"."networks"
                AS PERMISSIVE FOR SELECT
                TO public
                USING (true)
                `;
                
                const { error: selectError } = await supabase.rpc('exec_sql', {
                    sql: selectPolicy
                });
                
                if (selectError && !selectError.message.includes('already exists')) {
                    addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è SELECT –ø–æ–ª–∏—Ç–∏–∫–∏: ${selectError.message}`, 'error');
                } else {
                    addResult('‚úÖ SELECT –ø–æ–ª–∏—Ç–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'success');
                }
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
                addResult('üìù –°–æ–∑–¥–∞–µ–º –ø—É–±–ª–∏—á–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è INSERT...', 'info');
                
                const insertPolicy = `
                CREATE POLICY "Enable insert access for all users" ON "public"."networks"
                AS PERMISSIVE FOR INSERT
                TO public
                WITH CHECK (true)
                `;
                
                const { error: insertError } = await supabase.rpc('exec_sql', {
                    sql: insertPolicy
                });
                
                if (insertError && !insertError.message.includes('already exists')) {
                    addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è INSERT –ø–æ–ª–∏—Ç–∏–∫–∏: ${insertError.message}`, 'error');
                } else {
                    addResult('‚úÖ INSERT –ø–æ–ª–∏—Ç–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'success');
                }
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                addResult('üìù –°–æ–∑–¥–∞–µ–º –ø—É–±–ª–∏—á–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è UPDATE...', 'info');
                
                const updatePolicy = `
                CREATE POLICY "Enable update access for all users" ON "public"."networks"
                AS PERMISSIVE FOR UPDATE
                TO public
                USING (true)
                WITH CHECK (true)
                `;
                
                const { error: updateError } = await supabase.rpc('exec_sql', {
                    sql: updatePolicy
                });
                
                if (updateError && !updateError.message.includes('already exists')) {
                    addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è UPDATE –ø–æ–ª–∏—Ç–∏–∫–∏: ${updateError.message}`, 'error');
                } else {
                    addResult('‚úÖ UPDATE –ø–æ–ª–∏—Ç–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'success');
                }
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                addResult('üìù –°–æ–∑–¥–∞–µ–º –ø—É–±–ª–∏—á–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è DELETE...', 'info');
                
                const deletePolicy = `
                CREATE POLICY "Enable delete access for all users" ON "public"."networks"
                AS PERMISSIVE FOR DELETE
                TO public
                USING (true)
                `;
                
                const { error: deleteError } = await supabase.rpc('exec_sql', {
                    sql: deletePolicy
                });
                
                if (deleteError && !deleteError.message.includes('already exists')) {
                    addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è DELETE –ø–æ–ª–∏—Ç–∏–∫–∏: ${deleteError.message}`, 'error');
                } else {
                    addResult('‚úÖ DELETE –ø–æ–ª–∏—Ç–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'success');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                addResult('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫...', 'info');
                
                const { data: testData, error: testError } = await supabase
                    .from('networks')
                    .select('*', { count: 'exact' });
                
                if (testError) {
                    addResult(`‚ùå –í—Å—ë –µ—â–µ –µ—Å—Ç—å –æ—à–∏–±–∫–∞: ${testError.message}`, 'error');
                    addResult('üí° –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å RLS –≤ –∞–¥–º–∏–Ω–∫–µ Supabase', 'warning');
                } else {
                    addResult(`‚úÖ –£–°–ü–ï–•! –¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ ${testData?.length || 0} –∑–∞–ø–∏—Å–µ–π`, 'success');
                    
                    if (testData && testData.length > 0) {
                        addResult('üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏:', 'info');
                        testData.forEach((record, index) => {
                            addResult(`${index + 1}. ${record.name} (ID: ${record.id})`, 'info');
                        });
                    }
                }
                
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è RLS: ' + error.message, 'error');
                addResult('üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:', 'warning');
                addResult('1. –û—Ç–∫–ª—é—á–∏—Ç—å RLS –≤ –∞–¥–º–∏–Ω–∫–µ Supabase –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã networks', 'warning');
                addResult('2. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –≤—Ä—É—á–Ω—É—é –≤ SQL Editor', 'warning');
                addResult('3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å service_role –∫–ª—é—á –≤–º–µ—Å—Ç–æ anon –∫–ª—é—á–∞', 'warning');
            }
        };
        
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ RLS –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
        window.disableAllRLS = async function() {
            if (!supabase) await initServices();
            
            addResult('üõ°Ô∏è –û—Ç–∫–ª—é—á–∞–µ–º RLS –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü...', 'info');
            
            try {
                // –°–ø–∏—Å–æ–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –ø—Ä–æ–µ–∫—Ç–∞
                const tables = [
                    'networks',
                    'users', 
                    'user_document_acceptances',
                    'fuel_types',
                    'points',
                    'equipment',
                    'tanks',
                    'prices',
                    'operations',
                    'shift_reports',
                    'messages',
                    'nomenclature'
                ];
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const table of tables) {
                    try {
                        addResult(`üîß –û—Ç–∫–ª—é—á–∞–µ–º RLS –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã: ${table}`, 'info');
                        
                        // –û—Ç–∫–ª—é—á–∞–µ–º RLS –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
                        const disableSQL = `ALTER TABLE "public"."${table}" DISABLE ROW LEVEL SECURITY;`;
                        
                        const { error } = await supabase.rpc('exec_sql', {
                            sql: disableSQL
                        });
                        
                        if (error) {
                            if (error.message.includes('does not exist')) {
                                addResult(`‚è≠Ô∏è –¢–∞–±–ª–∏—Ü–∞ ${table} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`, 'warning');
                            } else {
                                addResult(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è RLS –¥–ª—è ${table}: ${error.message}`, 'error');
                                errorCount++;
                            }
                        } else {
                            addResult(`‚úÖ RLS –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã: ${table}`, 'success');
                            successCount++;
                        }
                        
                        // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (err) {
                        addResult(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è ${table}: ${err.message}`, 'error');
                        errorCount++;
                    }
                }
                
                // –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const resultText = `üéâ –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï RLS –ó–ê–í–ï–†–®–ï–ù–û!

‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${successCount} —Ç–∞–±–ª–∏—Ü
‚ùå –û—à–∏–±–æ–∫: ${errorCount}
üìä –í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫: ${tables.length}

üí° –¢–µ–ø–µ—Ä—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`;
                
                addResult(resultText, successCount > errorCount ? 'success' : 'warning');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ networks
                addResult('üß™ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ networks...', 'info');
                
                const { data: testData, error: testError } = await supabase
                    .from('networks')
                    .select('*');
                
                if (testError) {
                    addResult(`‚ùå –í—Å—ë –µ—â–µ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã: ${testError.message}`, 'error');
                } else {
                    addResult(`‚úÖ –û—Ç–ª–∏—á–Ω–æ! –î–æ—Å—Ç—É–ø–Ω–æ ${testData?.length || 0} –∑–∞–ø–∏—Å–µ–π –≤ networks`, 'success');
                }
                
            } catch (error) {
                addResult(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è RLS: ${error.message}`, 'error');
                addResult('üí° –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ service_role –∫–ª—é—á', 'warning');
            }
        };
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ networks
        window.setupNetworksTable = async function() {
            if (!supabase) await initServices();
            
            addResult('üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–±–ª–∏—Ü—ã networks...', 'info');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
                const { data: existing, error: selectError } = await supabase
                    .from('networks')
                    .select('*');
                
                if (selectError) {
                    addResult(`‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã: ${selectError.message}`, 'error');
                    return;
                }
                
                addResult(`üìä –ù–∞–π–¥–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π: ${existing?.length || 0}`, 'info');
                
                // –ó–∞–ø–∏—Å–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
                const networksToCreate = [
                    {
                        name: '–î–µ–º–æ —Å–µ—Ç—å –ê–ó–°',
                        code: 'demo_azs',
                        description: '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ—Ç—å –∑–∞–ø—Ä–∞–≤–æ—á–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π',
                        status: 'active'
                    },
                    {
                        name: '–ù–æ—Ä–¥ –õ–∞–π–Ω',
                        code: 'nord_line', 
                        description: '–°–µ—Ç—å –ê–ó–° –ù–æ—Ä–¥ –õ–∞–π–Ω',
                        status: 'active'
                    }
                ];
                
                let created = 0;
                let skipped = 0;
                
                for (const networkData of networksToCreate) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
                    const exists = existing?.some(n => 
                        n.code === networkData.code || n.name === networkData.name
                    );
                    
                    if (exists) {
                        skipped++;
                        continue;
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
                    const { data: newNetwork, error: insertError } = await supabase
                        .from('networks')
                        .insert(networkData)
                        .select()
                        .single();
                    
                    if (insertError) {
                        addResult(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è "${networkData.name}": ${insertError.message}`, 'error');
                    } else {
                        created++;
                        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å–µ—Ç—å: ${newNetwork.name} (ID: ${newNetwork.id})`);
                    }
                }
                
                const resultText = `‚úÖ –ù–ê–°–¢–†–û–ô–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!

üìà –°–æ–∑–¥–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${created}
‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç): ${skipped}
üìä –í—Å–µ–≥–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: ${(existing?.length || 0) + created}`;
                
                addResult(resultText, 'success');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                setTimeout(() => window.loadNetworks(), 1000);
                
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–±–ª–∏—Ü—ã: ' + error.message, 'error');
            }
        };
        
        // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            setTimeout(() => {
                window.checkStatus();
            }, 1000);
        });
    </script>
</body>
</html>