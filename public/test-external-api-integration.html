<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåê –¢–µ—Å—Ç –≤–Ω–µ—à–Ω–µ–≥–æ API</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1e1e1e; 
            color: #fff; 
            padding: 20px; 
            line-height: 1.4;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .code { 
            background: #0d1117; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #444;
            overflow-x: auto;
        }
        .highlight { 
            background: #2d4a22; 
            padding: 10px; 
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        .api-call {
            background: #1a2332;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }
        .section {
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #2d2d2d;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #000; }
        select, input {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üåê –¢–ï–°–¢ –í–ù–ï–®–ù–ï–ì–û API</h1>
    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞ —Å –≤–Ω–µ—à–Ω–∏–º —Ç–æ—Ä–≥–æ–≤—ã–º API</p>
    
    <div class="section">
        <h3>üéØ –í—ã–±–æ—Ä —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏</h3>
        <select id="tradingPointSelect" onchange="updateSelectedTradingPoint()">
            <option value="">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏...</option>
        </select>
        <button onclick="loadTradingPoints()">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—á–∫–∏</button>
        
        <div id="selectedTpInfo" style="margin-top: 10px;"></div>
    </div>
    
    <div class="section">
        <h3>üß™ API —Ç–µ—Å—Ç—ã</h3>
        <button onclick="testExternalApiConnection()">üîó –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API</button>
        <button onclick="testGetTanksData()">üõ¢Ô∏è –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤</button>
        <button onclick="testGetTransactionsData()">üìã –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</button>
        <button onclick="testFullApiWorkflow()">üöÄ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç API</button>
    </div>
    
    <div class="section">
        <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
        <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        <button onclick="showApiConfig()">üîß –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é API</button>
    </div>
    
    <div id="log"></div>

    <script type="module">
        let selectedTradingPoint = null;
        let httpClient = null;
        let tradingNetworkConfigService = null;
        
        const log = document.getElementById('log');
        
        function addLog(message, type = 'normal') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            log.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        function addSection(title) {
            const div = document.createElement('div');
            div.className = 'section';
            div.innerHTML = `<h3>${title}</h3>`;
            log.appendChild(div);
            return div;
        }
        
        window.clearLog = function() {
            log.innerHTML = '';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function initialize() {
            try {
                addLog('üì¶ –ò–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤...', 'info');
                const imports = await import('/src/services/universalHttpClient.ts');
                httpClient = imports.httpClient;
                
                const configImports = await import('/src/services/tradingNetworkConfigService.ts');
                tradingNetworkConfigService = configImports.tradingNetworkConfigService;
                
                addLog('‚úÖ –°–µ—Ä–≤–∏—Å—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                
                await loadTradingPoints();
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫
        window.loadTradingPoints = async function() {
            try {
                addLog('üìç –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏...', 'info');
                const response = await httpClient.getAllTradingPointsWithNetworks();
                
                const select = document.getElementById('tradingPointSelect');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É...</option>';
                
                if (response.success && response.data) {
                    addLog(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${response.data.length}`, 'success');
                    
                    response.data.forEach(tp => {
                        const option = document.createElement('option');
                        option.value = tp.id;
                        option.textContent = `${tp.name} (${tp.networkInfo.name}) ${tp.apiReady ? '‚úÖ' : '‚ùå'}`;
                        option.dataset.tpData = JSON.stringify(tp);
                        select.appendChild(option);
                    });
                    
                    // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–π –≥–æ—Ç–æ–≤–æ–π —Ç–æ—á–∫–∏
                    const readyTp = response.data.find(tp => tp.apiReady);
                    if (readyTp) {
                        select.value = readyTp.id;
                        updateSelectedTradingPoint();
                    }
                } else {
                    addLog('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏', 'error');
                }
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, 'error');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
        window.updateSelectedTradingPoint = function() {
            const select = document.getElementById('tradingPointSelect');
            const infoDiv = document.getElementById('selectedTpInfo');
            
            if (select.value) {
                const option = select.options[select.selectedIndex];
                selectedTradingPoint = JSON.parse(option.dataset.tpData);
                
                infoDiv.innerHTML = `<div class="highlight">
                    –í–´–ë–†–ê–ù–ù–ê–Ø –¢–û–†–ì–û–í–ê–Ø –¢–û–ß–ö–ê:<br>
                    ‚ûú –ù–∞–∑–≤–∞–Ω–∏–µ: ${selectedTradingPoint.name}<br>
                    ‚ûú –°–µ—Ç—å: ${selectedTradingPoint.networkInfo.name}<br>
                    ‚ûú System ID: "${selectedTradingPoint.systemId}"<br>
                    ‚ûú Station ID: "${selectedTradingPoint.stationId}"<br>
                    ‚ûú API –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${selectedTradingPoint.apiReady ? '‚úÖ –ì–û–¢–û–í–ê' : '‚ùå –ù–ï –ì–û–¢–û–í–ê'}
                </div>`;
            } else {
                selectedTradingPoint = null;
                infoDiv.innerHTML = '';
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é API
        window.showApiConfig = async function() {
            addSection('üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –í–ù–ï–®–ù–ï–ì–û API');
            
            try {
                const config = await tradingNetworkConfigService.getConfig();
                
                addLog(`<div class="code">
                    –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –¢–û–†–ì–û–í–û–ô –°–ï–¢–ò:<br>
                    ‚ûú –í–∫–ª—é—á–µ–Ω–∞: ${config.enabled ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}<br>
                    ‚ûú Base URL: ${config.baseUrl}<br>
                    ‚ûú Auth Type: ${config.authType}<br>
                    ‚ûú Username: ${config.username}<br>
                    ‚ûú Password: ${config.password ? '***' : '–ù–ï–¢'}<br>
                    ‚ûú Timeout: ${config.timeout}ms<br>
                    ‚ûú Endpoints:<br>
                    &nbsp;&nbsp;- Tanks: ${config.endpoints.tanks}<br>
                    &nbsp;&nbsp;- Transactions: ${config.endpoints.transactions}
                </div>`, 'info');
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }
        
        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–Ω–µ—à–Ω–µ–º—É API
        window.testExternalApiConnection = async function() {
            addSection('üîó –¢–ï–°–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –í–ù–ï–®–ù–ï–ú–£ API');
            
            if (!selectedTradingPoint) {
                addLog('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É!', 'error');
                return;
            }
            
            if (!selectedTradingPoint.apiReady) {
                addLog('‚ùå –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è API!', 'error');
                return;
            }
            
            try {
                addLog('üîó –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–Ω–µ—à–Ω–µ–º—É API...', 'info');
                
                const startTime = Date.now();
                const response = await httpClient.get('/tanks', {
                    destination: 'external-api',
                    queryParams: {
                        system: selectedTradingPoint.systemId,
                        station: selectedTradingPoint.stationId
                    },
                    timeout: 15000
                });
                const responseTime = Date.now() - startTime;
                
                addLog(`<div class="api-call">
                    API –í–´–ó–û–í:<br>
                    ‚ûú URL: https://pos.autooplata.ru/tms/tanks<br>
                    ‚ûú –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: system=${selectedTradingPoint.systemId}, station=${selectedTradingPoint.stationId}<br>
                    ‚ûú –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${responseTime}ms
                </div>`, 'info');
                
                addLog(`<div class="code">
                    –†–ï–ó–£–õ–¨–¢–ê–¢:<br>
                    ‚ûú Success: ${response.success}<br>
                    ‚ûú Status: ${response.status}<br>
                    ‚ûú Error: ${response.error || '–Ω–µ—Ç'}<br>
                    ‚ûú Data Type: ${typeof response.data}<br>
                    ‚ûú Data Length: ${Array.isArray(response.data) ? response.data.length : '–Ω–µ –º–∞—Å—Å–∏–≤'}
                </div>`, response.success ? 'success' : 'error');
                
                if (response.success) {
                    addLog('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–Ω–µ—à–Ω–µ–º—É API —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success');
                } else {
                    addLog('‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –≤–Ω–µ—à–Ω–µ–º—É API', 'error');
                    if (response.status === 401 || response.status === 403) {
                        addLog('üîê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', 'warning');
                    }
                }
                
            } catch (error) {
                addLog(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        // –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤
        window.testGetTanksData = async function() {
            addSection('üõ¢Ô∏è –¢–ï–°–¢ –ü–û–õ–£–ß–ï–ù–ò–Ø –î–ê–ù–ù–´–• –†–ï–ó–ï–†–í–£–ê–†–û–í');
            
            if (!selectedTradingPoint) {
                addLog('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É!', 'error');
                return;
            }
            
            try {
                addLog('üõ¢Ô∏è –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ tradingNetworkConfigService...', 'info');
                
                const tanksData = await tradingNetworkConfigService.getTanksData(selectedTradingPoint.id);
                
                addLog(`<div class="code">
                    –†–ï–ó–£–õ–¨–¢–ê–¢ getTanksData():<br>
                    ‚ûú –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: ${typeof tanksData}<br>
                    ‚ûú –Ø–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º: ${Array.isArray(tanksData)}<br>
                    ‚ûú –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: ${Array.isArray(tanksData) ? tanksData.length : 'N/A'}
                </div>`, 'success');
                
                if (Array.isArray(tanksData) && tanksData.length > 0) {
                    addLog('‚úÖ –î–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –ø–æ–ª—É—á–µ–Ω—ã!', 'success');
                    
                    tanksData.slice(0, 3).forEach((tank, index) => {
                        addLog(`<div class="code">
                            –†–µ–∑–µ—Ä–≤—É–∞—Ä ${index + 1}:<br>
                            ${JSON.stringify(tank, null, 2)}
                        </div>`, 'info');
                    });
                    
                    if (tanksData.length > 3) {
                        addLog(`... –∏ –µ—â–µ ${tanksData.length - 3} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤`, 'info');
                    }
                } else {
                    addLog('‚ö†Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç', 'warning');
                }
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${error.message}`, 'error');
            }
        }
        
        // –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        window.testGetTransactionsData = async function() {
            addSection('üìã –¢–ï–°–¢ –ü–û–õ–£–ß–ï–ù–ò–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–ô');
            
            if (!selectedTradingPoint) {
                addLog('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É!', 'error');
                return;
            }
            
            try {
                addLog('üìã –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ tradingNetworkConfigService...', 'info');
                
                const transactionsData = await tradingNetworkConfigService.getTransactionsData({
                    tradingPointId: selectedTradingPoint.id,
                    limit: 10
                });
                
                addLog(`<div class="code">
                    –†–ï–ó–£–õ–¨–¢–ê–¢ getTransactionsData():<br>
                    ‚ûú –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: ${typeof transactionsData}<br>
                    ‚ûú –Ø–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º: ${Array.isArray(transactionsData)}<br>
                    ‚ûú –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: ${Array.isArray(transactionsData) ? transactionsData.length : 'N/A'}
                </div>`, 'success');
                
                if (Array.isArray(transactionsData) && transactionsData.length > 0) {
                    addLog('‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω—ã!', 'success');
                    
                    transactionsData.slice(0, 2).forEach((transaction, index) => {
                        addLog(`<div class="code">
                            –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è ${index + 1}:<br>
                            ${JSON.stringify(transaction, null, 2)}
                        </div>`, 'info');
                    });
                    
                    if (transactionsData.length > 2) {
                        addLog(`... –∏ –µ—â–µ ${transactionsData.length - 2} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π`, 'info');
                    }
                } else {
                    addLog('‚ö†Ô∏è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç', 'warning');
                }
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${error.message}`, 'error');
            }
        }
        
        // –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç API
        window.testFullApiWorkflow = async function() {
            addSection('üöÄ –ü–û–õ–ù–´–ô –¢–ï–°–¢ API WORKFLOW');
            
            if (!selectedTradingPoint) {
                addLog('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É!', 'error');
                return;
            }
            
            addLog('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ API...', 'info');
            
            // –®–∞–≥ 1: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
            await showApiConfig();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // –®–∞–≥ 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            await testExternalApiConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // –®–∞–≥ 3: –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã
            await testGetTanksData();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // –®–∞–≥ 4: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            await testGetTransactionsData();
            
            addLog('üèÅ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç API –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        addLog('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...', 'info');
        initialize();
    </script>
</body>
</html>