<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1e1e1e; 
            color: #fff; 
            padding: 20px; 
            line-height: 1.4;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .code { 
            background: #0d1117; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #444;
            overflow-x: auto;
        }
        .highlight { 
            background: #2d4a22; 
            padding: 10px; 
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üéØ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–ò–°–ö –¢–û–†–ì–û–í–´–• –¢–û–ß–ï–ö</h1>
    <p>–ü–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—É —Å–µ—Ç–∏, –∞ –Ω–µ –ø–æ –ø—Ä—è–º–æ–º—É ID</p>
    
    <button onclick="testCorrectSearch()">üöÄ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</button>
    <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
    
    <div id="log"></div>

    <script type="module">
        const log = document.getElementById('log');
        
        function addLog(message, type = 'normal') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            log.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        window.clearLog = function() {
            log.innerHTML = '';
        }
        
        window.testCorrectSearch = async function() {
            addLog('üéØ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ê–õ–ì–û–†–ò–¢–ú –ü–û–ò–°–ö–ê –¢–û–†–ì–û–í–´–• –¢–û–ß–ï–ö', 'info');
            
            try {
                const { httpClient } = await import('/src/services/universalHttpClient.ts');
                
                // –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–µ—Ç–∏
                addLog('üåê –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ç–∏...', 'info');
                
                const networksResponse = await httpClient.get('/rest/v1/networks', {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id,code',
                        order: 'name'
                    }
                });
                
                if (!networksResponse.success || !networksResponse.data) {
                    addLog('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ç–µ–π', 'error');
                    return;
                }
                
                addLog(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å–µ—Ç–µ–π: ${networksResponse.data.length}`, 'success');
                networksResponse.data.forEach((network, index) => {
                    addLog(`<div class="code">
                        –°–µ—Ç—å ${index + 1}: ${network.name}<br>
                        - ID: ${network.id}<br>
                        - External ID: ${network.external_id || '–ù–ï–¢'}<br>
                        - Code: ${network.code || '–ù–ï–¢'}
                    </div>`, 'info');
                });
                
                // –®–ê–ì 2: –î–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Ç–∏ –ø–æ–ª—É—á–∞–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏
                addLog('üìç –®–ê–ì 2: –ü–æ–ª—É—á–∞–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Ç–∏...', 'info');
                
                let allTradingPoints = [];
                
                for (const network of networksResponse.data) {
                    addLog(`üîç –ü–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è —Å–µ—Ç–∏ "${network.name}" (ID: ${network.id})...`, 'info');
                    
                    const tpResponse = await httpClient.get('/rest/v1/trading_points', {
                        destination: 'supabase',
                        queryParams: {
                            select: 'id,name,external_id,code,network_id',
                            network_id: `eq.${network.id}`,
                            order: 'name'
                        }
                    });
                    
                    if (tpResponse.success && tpResponse.data) {
                        addLog(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤ —Å–µ—Ç–∏ "${network.name}": ${tpResponse.data.length}`, 'success');
                        
                        tpResponse.data.forEach((tp, tpIndex) => {
                            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å–µ—Ç–∏
                            tp.networkInfo = network;
                            allTradingPoints.push(tp);
                            
                            addLog(`<div class="code">
                                –¢–ü ${tpIndex + 1}: ${tp.name}<br>
                                - ID: ${tp.id}<br>
                                - External ID: ${tp.external_id || '–ù–ï–¢'}<br>
                                - Code: ${tp.code || '–ù–ï–¢'}<br>
                                - –°–µ—Ç—å: ${network.name}
                            </div>`, 'info');
                        });
                    } else {
                        addLog(`‚ö†Ô∏è –¢–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤ —Å–µ—Ç–∏ "${network.name}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`, 'warning');
                    }
                }
                
                // –®–ê–ì 3: –ê–Ω–∞–ª–∏–∑ API –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                addLog('üîß –®–ê–ì 3: –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API...', 'info');
                
                let readyTradingPoints = [];
                
                allTradingPoints.forEach(tp => {
                    const systemId = tp.networkInfo.external_id || tp.networkInfo.code || '';
                    const stationId = tp.external_id || tp.code || '';
                    const ready = !!(systemId && stationId);
                    
                    if (ready) {
                        readyTradingPoints.push({
                            ...tp,
                            systemId,
                            stationId
                        });
                    }
                    
                    addLog(`<div class="code" style="background: ${ready ? '#2d4a22' : '#4a2d2d'};">
                        ${tp.name} ${ready ? '‚úÖ –ì–û–¢–û–í–ê' : '‚ùå –ù–ï –ì–û–¢–û–í–ê'}<br>
                        - System ID: "${systemId}"<br>
                        - Station ID: "${stationId}"<br>
                        - ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏: ${tp.id}
                    </div>`, ready ? 'success' : 'error');
                });
                
                // –®–ê–ì 4: –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                addLog('üìä –®–ê–ì 4: –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞...', 'info');
                
                addLog(`<div class="highlight">
                    –°–¢–ê–¢–ò–°–¢–ò–ö–ê:<br>
                    ‚ûú –í—Å–µ–≥–æ —Å–µ—Ç–µ–π: ${networksResponse.data.length}<br>
                    ‚ûú –í—Å–µ–≥–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${allTradingPoints.length}<br>
                    ‚ûú –ì–æ—Ç–æ–≤—ã—Ö –¥–ª—è API: ${readyTradingPoints.length}<br>
                    ‚ûú –ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: ${allTradingPoints.length > 0 ? Math.round(readyTradingPoints.length / allTradingPoints.length * 100) : 0}%
                </div>`, readyTradingPoints.length > 0 ? 'success' : 'warning');
                
                // –®–ê–ì 5: –ü–æ–∫–∞–∑–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ –¥–ª—è API —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏
                if (readyTradingPoints.length > 0) {
                    addLog('üéâ –®–ê–ì 5: –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –≥–æ—Ç–æ–≤—ã–µ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API:', 'success');
                    
                    readyTradingPoints.forEach((tp, index) => {
                        const apiUrl = `https://pos.autooplata.ru/tms/tanks?system=${tp.systemId}&station=${tp.stationId}`;
                        addLog(`<div class="highlight">
                            ${index + 1}. ${tp.name}<br>
                            ‚ûú ID: ${tp.id}<br>
                            ‚ûú System: "${tp.systemId}" (–æ—Ç —Å–µ—Ç–∏: ${tp.networkInfo.name})<br>
                            ‚ûú Station: "${tp.stationId}"<br>
                            ‚ûú API URL: ${apiUrl}
                        </div>`, 'success');
                    });
                    
                    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
                    const firstReady = readyTradingPoints[0];
                    addLog(`üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É "${firstReady.name}" (ID: ${firstReady.id}) –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ API`, 'success');
                } else {
                    addLog('‚ö†Ô∏è –ù–∏ –æ–¥–Ω–∞ —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API', 'warning');
                    addLog('üí° –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å external_id –≤ —Ç–∞–±–ª–∏—Ü—ã networks –∏ trading_points', 'warning');
                }
                
                // –®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ ID (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ)
                const TARGET_ID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
                const targetTp = allTradingPoints.find(tp => tp.id === TARGET_ID);
                
                if (targetTp) {
                    addLog(`üéØ –ù–ê–ô–î–ï–ù–ê –ò–°–ö–û–ú–ê–Ø –¢–û–†–ì–û–í–ê–Ø –¢–û–ß–ö–ê: ${targetTp.name}`, 'success');
                    const systemId = targetTp.networkInfo.external_id || targetTp.networkInfo.code || '';
                    const stationId = targetTp.external_id || targetTp.code || '';
                    
                    addLog(`<div class="highlight">
                        –†–ï–ö–í–ò–ó–ò–¢–´ –ò–°–ö–û–ú–û–ô –¢–û–†–ì–û–í–û–ô –¢–û–ß–ö–ò:<br>
                        ‚ûú –ù–∞–∑–≤–∞–Ω–∏–µ: ${targetTp.name}<br>
                        ‚ûú ID: ${targetTp.id}<br>
                        ‚ûú –°–µ—Ç—å: ${targetTp.networkInfo.name}<br>
                        ‚ûú System ID: "${systemId}"<br>
                        ‚ûú Station ID: "${stationId}"<br>
                        ‚ûú –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${systemId && stationId ? '‚úÖ –ì–û–¢–û–í–ê' : '‚ùå –ù–ï –ì–û–¢–û–í–ê'}
                    </div>`, systemId && stationId ? 'success' : 'error');
                } else {
                    addLog(`‚ùå –ò—Å–∫–æ–º–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ ${TARGET_ID} –ù–ï –Ω–∞–π–¥–µ–Ω–∞ —Å—Ä–µ–¥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö`, 'error');
                }
                
            } catch (error) {
                addLog(`üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
                addLog(`<div class="code">${error.stack}</div>`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        addLog('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞...', 'info');
        setTimeout(testCorrectSearch, 1000);
    </script>
</body>
</html>