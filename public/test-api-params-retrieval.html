<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1e1e1e; 
            color: #fff; 
            padding: 20px; 
            line-height: 1.4;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .code { 
            background: #0d1117; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #444;
            overflow-x: auto;
        }
        .highlight { 
            background: #2d4a22; 
            padding: 10px; 
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üéØ –¢–ï–°–¢ –ü–û–õ–£–ß–ï–ù–ò–Ø API –ü–ê–†–ê–ú–ï–¢–†–û–í</h1>
    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π —Å–µ—Ç–∏ –∏ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏: <strong>6969b08d-1cbe-45c2-ae9c-8002c7022b59</strong></p>
    
    <button onclick="testApiParamsRetrieval()">üöÄ –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</button>
    <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
    
    <div id="log"></div>

    <script type="module">
        const TRADING_POINT_ID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
        const log = document.getElementById('log');
        
        function addLog(message, type = 'normal') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            log.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        window.clearLog = function() {
            log.innerHTML = '';
        }
        
        window.testApiParamsRetrieval = async function() {
            addLog('üéØ –¢–ï–°–¢ –ü–û–õ–£–ß–ï–ù–ò–Ø API –ü–ê–†–ê–ú–ï–¢–†–û–í –î–õ–Ø –í–ù–ï–®–ù–ï–ì–û API', 'info');
            addLog(`Target ID: ${TRADING_POINT_ID}`, 'info');
            
            try {
                // –ò–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤
                addLog('üì¶ –ò–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤...', 'info');
                const { httpClient } = await import('/src/services/universalHttpClient.ts');
                const { tradingNetworkConfigService } = await import('/src/services/tradingNetworkConfigService.ts');
                addLog('‚úÖ –°–µ—Ä–≤–∏—Å—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                
                // –®–ê–ì 1: –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î —á–µ—Ä–µ–∑ HTTP –∫–ª–∏–µ–Ω—Ç
                addLog('üîç –®–ê–ì 1: –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –≤ –ë–î...', 'info');
                
                const tpResponse = await httpClient.get('/rest/v1/trading_points', {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id,code,network_id',
                        id: `eq.${TRADING_POINT_ID}`
                    }
                });
                
                if (!tpResponse.success || !tpResponse.data || tpResponse.data.length === 0) {
                    addLog('‚ùå –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î!', 'error');
                    return;
                }
                
                const tradingPoint = tpResponse.data[0];
                addLog('‚úÖ –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î', 'success');
                addLog(`<div class="code">
                    ID: ${tradingPoint.id}<br>
                    –ù–∞–∑–≤–∞–Ω–∏–µ: ${tradingPoint.name}<br>
                    External ID: ${tradingPoint.external_id || '‚ùå –ù–ï–¢'}<br>
                    Code: ${tradingPoint.code || '‚ùå –ù–ï–¢'}<br>
                    Network ID: ${tradingPoint.network_id}
                </div>`, 'info');
                
                // –®–ê–ì 2: –ü–æ–∏—Å–∫ —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å–µ—Ç–∏
                addLog('üåê –®–ê–ì 2: –ü–æ–∏—Å–∫ —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å–µ—Ç–∏...', 'info');
                
                const networkResponse = await httpClient.get('/rest/v1/networks', {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id,code',
                        id: `eq.${tradingPoint.network_id}`
                    }
                });
                
                if (!networkResponse.success || !networkResponse.data || networkResponse.data.length === 0) {
                    addLog('‚ùå –°–≤—è–∑–∞–Ω–Ω–∞—è —Å–µ—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', 'error');
                    return;
                }
                
                const network = networkResponse.data[0];
                addLog('‚úÖ –°–≤—è–∑–∞–Ω–Ω–∞—è —Å–µ—Ç—å –Ω–∞–π–¥–µ–Ω–∞', 'success');
                addLog(`<div class="code">
                    ID: ${network.id}<br>
                    –ù–∞–∑–≤–∞–Ω–∏–µ: ${network.name}<br>
                    External ID: ${network.external_id || '‚ùå –ù–ï–¢'}<br>
                    Code: ${network.code || '‚ùå –ù–ï–¢'}
                </div>`, 'info');
                
                // –®–ê–ì 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤—Ä—É—á–Ω—É—é
                addLog('üîß –®–ê–ì 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤...', 'info');
                
                const systemId = network.external_id || network.code || '';
                const stationId = tradingPoint.external_id || tradingPoint.code || '';
                
                addLog(`<div class="highlight">
                    –í–´–ß–ò–°–õ–ï–ù–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´:<br>
                    System ID (–æ—Ç —Å–µ—Ç–∏): "${systemId}"<br>
                    Station ID (–æ—Ç —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏): "${stationId}"<br>
                    –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${systemId && stationId ? '‚úÖ –ì–û–¢–û–í–û' : '‚ùå –ù–ï –ì–û–¢–û–í–û'}
                </div>`, systemId && stationId ? 'success' : 'error');
                
                // –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ tradingNetworkConfigService
                addLog('‚öôÔ∏è –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ tradingNetworkConfigService.getApiParamsFromDB()...', 'info');
                
                const serviceParams = await tradingNetworkConfigService.getApiParamsFromDB(TRADING_POINT_ID);
                
                if (serviceParams) {
                    addLog('‚úÖ –°–µ—Ä–≤–∏—Å –≤–µ—Ä–Ω—É–ª –ø–∞—Ä–∞–º–µ—Ç—Ä—ã', 'success');
                    addLog(`<div class="highlight">
                        –ü–ê–†–ê–ú–ï–¢–†–´ –û–¢ –°–ï–†–í–ò–°–ê:<br>
                        System ID: "${serviceParams.systemId}"<br>
                        Station ID: "${serviceParams.stationId}"
                    </div>`, 'success');
                    
                    // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    const match = serviceParams.systemId === systemId && serviceParams.stationId === stationId;
                    addLog(`<div class="code">
                        –°–†–ê–í–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:<br>
                        –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ ‚ûú System: "${systemId}", Station: "${stationId}"<br>
                        –°–µ—Ä–≤–∏—Å ‚ûú System: "${serviceParams.systemId}", Station: "${serviceParams.stationId}"<br>
                        –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: ${match ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}
                    </div>`, match ? 'success' : 'error');
                    
                } else {
                    addLog('‚ùå –°–µ—Ä–≤–∏—Å –ù–ï —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã', 'error');
                }
                
                // –®–ê–ì 5: –¢–µ—Å—Ç —Å tradingNetworkConfigService.getTanksData()
                if (systemId && stationId) {
                    addLog('üõ¢Ô∏è –®–ê–ì 5: –¢–µ—Å—Ç –º–µ—Ç–æ–¥–∞ getTanksData() —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏...', 'info');
                    
                    try {
                        const tanksData = await tradingNetworkConfigService.getTanksData(TRADING_POINT_ID);
                        addLog('‚úÖ getTanksData() —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!', 'success');
                        addLog(`<div class="code">
                            –ü–æ–ª—É—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö: ${Array.isArray(tanksData) ? tanksData.length : '–Ω–µ –º–∞—Å—Å–∏–≤'}<br>
                            –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: ${typeof tanksData}<br>
                            –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(tanksData).substring(0, 200)}...
                        </div>`, 'success');
                    } catch (tanksError) {
                        addLog('‚ùå –û—à–∏–±–∫–∞ getTanksData()', 'error');
                        addLog(`–û—à–∏–±–∫–∞: ${tanksError.message}`, 'error');
                    }
                } else {
                    addLog('‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ getTanksData() - –Ω–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–π–¥–µ–Ω—ã', 'warning');
                }
                
                // –ò–¢–û–ì–û–í–´–ô –í–ï–†–î–ò–ö–¢
                addLog('üèÅ –ò–¢–û–ì–û–í–´–ô –í–ï–†–î–ò–ö–¢:', 'info');
                
                const verdict = !!(systemId && stationId && serviceParams);
                addLog(`<div class="highlight">
                    –°–¢–ê–¢–£–° –ü–û–õ–£–ß–ï–ù–ò–Ø –ü–ê–†–ê–ú–ï–¢–†–û–í: ${verdict ? '‚úÖ –£–°–ü–ï–•' : '‚ùå –û–®–ò–ë–ö–ê'}<br>
                    ‚ûú –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞: ‚úÖ<br>
                    ‚ûú –°–µ—Ç—å –Ω–∞–π–¥–µ–Ω–∞: ‚úÖ<br>
                    ‚ûú System ID –ø–æ–ª—É—á–µ–Ω: ${systemId ? '‚úÖ' : '‚ùå'}<br>
                    ‚ûú Station ID –ø–æ–ª—É—á–µ–Ω: ${stationId ? '‚úÖ' : '‚ùå'}<br>
                    ‚ûú –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç: ${serviceParams ? '‚úÖ' : '‚ùå'}<br>
                    ‚ûú –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API: ${verdict ? '‚úÖ –ì–û–¢–û–í–û' : '‚ùå –ù–ï –ì–û–¢–û–í–û'}
                </div>`, verdict ? 'success' : 'error');
                
                if (verdict) {
                    addLog('üéâ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π HTTP –∫–ª–∏–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è —Å–µ—Ç–∏ –∏ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏!', 'success');
                    addLog(`üí° –í–Ω–µ—à–Ω–∏–π API –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å URL: https://pos.autooplata.ru/tms/tanks?system=${systemId}&station=${stationId}`, 'success');
                } else {
                    addLog('‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å external_id –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î', 'warning');
                }
                
            } catch (error) {
                addLog('üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –¢–ï–°–¢–ê', 'error');
                addLog(`<div class="code">
                    –û—à–∏–±–∫–∞: ${error.message}<br>
                    Stack: ${error.stack}
                </div>`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        addLog('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É...', 'info');
        setTimeout(testApiParamsRetrieval, 1000);
    </script>
</body>
</html>