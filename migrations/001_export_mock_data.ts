/**
 * –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö mock –¥–∞–Ω–Ω—ã—Ö –≤ JSON —Ñ–∞–π–ª—ã
 * –î–ª—è –ê–ì–ï–ù–¢–ê 2: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
 */

import fs from 'fs';
import path from 'path';

// Import mock services
import { networksService } from '../src/services/networksService';
import { nomenclatureService } from '../src/services/nomenclatureService';
import { usersService } from '../src/services/usersService';
import { pricesService } from '../src/services/pricesService';

/**
 * –°–æ–∑–¥–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
 */
function ensureDataDirectory() {
  const dataDir = path.join(process.cwd(), 'data');
  if (!fs.existsSync(dataDir)) {
    fs.mkdirSync(dataDir, { recursive: true });
  }
  return dataDir;
}

/**
 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON —Ñ–∞–π–ª
 */
function saveToJson(filename: string, data: any) {
  const dataDir = ensureDataDirectory();
  const filePath = path.join(dataDir, filename);
  
  try {
    fs.writeFileSync(filePath, JSON.stringify(data, null, 2), 'utf-8');
    console.log(`‚úÖ Exported ${Array.isArray(data) ? data.length : 'data'} records to ${filename}`);
    return true;
  } catch (error) {
    console.error(`‚ùå Failed to export ${filename}:`, error);
    return false;
  }
}

/**
 * –≠–∫—Å–ø–æ—Ä—Ç —Å–µ—Ç–µ–π –∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫
 */
async function exportNetworks() {
  try {
    console.log('üìä Exporting networks...');
    const networks = await networksService.getNetworks();
    
    // –≠–∫—Å–ø–æ—Ä—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ç–µ–π
    const networksData = networks.map(network => ({
      id: network.id,
      name: network.name,
      code: network.code,
      description: network.description || '',
      status: network.status || 'active',
      settings: network.settings || {},
      tradingPointsCount: network.tradingPoints ? network.tradingPoints.length : 0,
      created_at: network.createdAt || new Date().toISOString(),
      updated_at: network.updatedAt || new Date().toISOString()
    }));
    
    saveToJson('networks.json', networksData);
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –æ—Ç–¥–µ–ª—å–Ω–æ
    const allTradingPoints: any[] = [];
    networks.forEach(network => {
      if (network.tradingPoints) {
        network.tradingPoints.forEach(tp => {
          allTradingPoints.push({
            id: tp.id,
            network_id: network.id,
            name: tp.name,
            code: tp.code,
            address: tp.address || '',
            location: tp.location || {},
            type: tp.type || 'station',
            status: tp.status || 'active',
            settings: tp.settings || {},
            metadata: tp.metadata || {},
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          });
        });
      }
    });
    
    saveToJson('trading_points.json', allTradingPoints);
    
    return { networks: networksData.length, tradingPoints: allTradingPoints.length };
  } catch (error) {
    console.error('‚ùå Failed to export networks:', error);
    return { networks: 0, tradingPoints: 0 };
  }
}

/**
 * –≠–∫—Å–ø–æ—Ä—Ç —Ç–∏–ø–æ–≤ —Ç–æ–ø–ª–∏–≤–∞
 */
async function exportFuelTypes() {
  try {
    console.log('‚õΩ Exporting fuel types...');
    const fuelTypes = await nomenclatureService.getFuelTypes();
    
    const fuelTypesData = fuelTypes.map(ft => ({
      id: ft.id,
      name: ft.name,
      code: ft.code,
      category: ft.category || 'other',
      octane_number: ft.octaneNumber || null,
      density: ft.density || null,
      unit: ft.unit || 'L',
      is_active: ft.isActive !== false,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    }));
    
    saveToJson('fuel_types.json', fuelTypesData);
    return fuelTypesData.length;
  } catch (error) {
    console.error('‚ùå Failed to export fuel types:', error);
    return 0;
  }
}

/**
 * –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–±–µ–∑ –ø–∞—Ä–æ–ª–µ–π)
 */
async function exportUsers() {
  try {
    console.log('üë• Exporting users...');
    const users = await usersService.getUsers();
    
    const usersData = users.map(user => ({
      id: user.id,
      email: user.email,
      username: user.username,
      // –ü–∞—Ä–æ–ª—å –ù–ï —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      first_name: user.firstName || '',
      last_name: user.lastName || '',
      phone: user.phone || '',
      status: user.status || 'active',
      email_verified: user.emailVerified || false,
      last_login: user.lastLogin || null,
      settings: user.settings || {},
      metadata: user.metadata || {},
      roles: user.roles || [],
      networks: user.networks || [],
      trading_points: user.tradingPoints || [],
      created_at: user.createdAt || new Date().toISOString(),
      updated_at: user.updatedAt || new Date().toISOString()
    }));
    
    saveToJson('users.json', usersData);
    
    // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –ø–∞—Ä–æ–ª–µ–π –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    const defaultPasswords = users.map(user => ({
      username: user.username,
      email: user.email,
      defaultPassword: 'password123' // –í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ
    }));
    
    saveToJson('users_default_passwords.json', defaultPasswords);
    console.log('‚ÑπÔ∏è  Default passwords saved for development use');
    
    return usersData.length;
  } catch (error) {
    console.error('‚ùå Failed to export users:', error);
    return 0;
  }
}

/**
 * –≠–∫—Å–ø–æ—Ä—Ç —Ü–µ–Ω (–±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)
 */
async function exportPrices() {
  try {
    console.log('üí∞ Exporting prices...');
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã
    const currentPrices = await pricesService.getCurrentPrices();
    
    const pricesData = currentPrices.map(price => ({
      id: price.id || `price_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      trading_point_id: price.tradingPointId,
      fuel_type_id: price.fuelTypeId || price.fuelCode,
      price_net: price.priceNet,
      vat_rate: price.vatRate || 20,
      price_gross: price.priceGross,
      source: 'migration',
      valid_from: new Date().toISOString(),
      valid_to: null,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    }));
    
    saveToJson('prices.json', pricesData);
    return pricesData.length;
  } catch (error) {
    console.error('‚ùå Failed to export prices:', error);
    return 0;
  }
}

/**
 * –≠–∫—Å–ø–æ—Ä—Ç –æ–ø–µ—Ä–∞—Ü–∏–π (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ - —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100)
 */
async function exportOperations() {
  try {
    console.log('üîÑ Exporting operations (sample)...');
    
    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º operationsService –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –±–æ–ª—å—à–æ–π
    const { operationsService } = await import('../src/services/operationsService');
    const allOperations = await operationsService.getOperations();
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const sampleOperations = allOperations.slice(0, 100).map(op => ({
      id: op.id,
      trading_point_id: op.tradingPointId,
      operation_type: op.operationType,
      status: op.status,
      start_time: op.startTime,
      end_time: op.endTime,
      duration: op.duration,
      device_id: op.deviceId,
      details: op.details,
      metadata: op.metadata || {},
      created_at: op.startTime,
      updated_at: op.lastUpdated || op.startTime
    }));
    
    saveToJson('operations_sample.json', sampleOperations);
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    const transactions = allOperations
      .filter(op => op.transactionId && op.operationType === 'sale')
      .slice(0, 50)
      .map(op => ({
        id: op.transactionId,
        operation_id: op.id,
        transaction_number: op.transactionId,
        fuel_type_id: op.fuelType,
        quantity: op.quantity || 0,
        price_per_unit: op.price || 0,
        total_amount: op.totalCost || 0,
        payment_method: op.paymentMethod,
        customer_id: null,
        vehicle_number: op.vehicleNumber,
        created_at: op.startTime
      }));
    
    saveToJson('transactions_sample.json', transactions);
    
    console.log(`‚ÑπÔ∏è  Exported sample data: ${sampleOperations.length} operations, ${transactions.length} transactions`);
    console.log(`‚ÑπÔ∏è  Total operations in system: ${allOperations.length} (export limited for migration testing)`);
    
    return { operations: sampleOperations.length, transactions: transactions.length };
  } catch (error) {
    console.error('‚ùå Failed to export operations:', error);
    return { operations: 0, transactions: 0 };
  }
}

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞
 */
export async function exportAllMockData() {
  const startTime = Date.now();
  console.log('üöÄ Starting mock data export...\n');
  
  try {
    const results = {
      networks: 0,
      tradingPoints: 0,
      fuelTypes: 0,
      users: 0,
      prices: 0,
      operations: 0,
      transactions: 0
    };
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Å–µ—Ç–µ–π –∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫
    const networkResults = await exportNetworks();
    results.networks = networkResults.networks;
    results.tradingPoints = networkResults.tradingPoints;
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Ç–∏–ø–æ–≤ —Ç–æ–ø–ª–∏–≤–∞
    results.fuelTypes = await exportFuelTypes();
    
    // –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    results.users = await exportUsers();
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Ü–µ–Ω
    results.prices = await exportPrices();
    
    // –≠–∫—Å–ø–æ—Ä—Ç –æ–ø–µ—Ä–∞—Ü–∏–π (–æ–±—Ä–∞–∑–µ—Ü)
    const operationResults = await exportOperations();
    results.operations = operationResults.operations;
    results.transactions = operationResults.transactions;
    
    // –°–≤–æ–¥–∫–∞
    console.log('\nüìã Export Summary:');
    console.log(`  Networks: ${results.networks}`);
    console.log(`  Trading Points: ${results.tradingPoints}`);
    console.log(`  Fuel Types: ${results.fuelTypes}`);
    console.log(`  Users: ${results.users}`);
    console.log(`  Prices: ${results.prices}`);
    console.log(`  Operations (sample): ${results.operations}`);
    console.log(`  Transactions (sample): ${results.transactions}`);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤–æ–¥–∫—É
    saveToJson('export_summary.json', {
      exportDate: new Date().toISOString(),
      results,
      duration: Date.now() - startTime,
      status: 'completed'
    });
    
    console.log(`\n‚úÖ Export completed successfully in ${Date.now() - startTime}ms`);
    console.log(`üìÅ All files saved to ./data/ directory`);
    
    return results;
  } catch (error) {
    console.error('\n‚ùå Export failed:', error);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
    saveToJson('export_error.json', {
      exportDate: new Date().toISOString(),
      error: error instanceof Error ? error.message : 'Unknown error',
      stack: error instanceof Error ? error.stack : undefined,
      duration: Date.now() - startTime,
      status: 'failed'
    });
    
    throw error;
  }
}

// –ó–∞–ø—É—Å–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞, –µ—Å–ª–∏ —Ñ–∞–π–ª –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é
if (require.main === module) {
  exportAllMockData()
    .then(() => {
      console.log('üéâ Mock data export completed');
      process.exit(0);
    })
    .catch((error) => {
      console.error('üí• Export failed:', error);
      process.exit(1);
    });
}