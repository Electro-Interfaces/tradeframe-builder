<!DOCTYPE html>
<html>
<head>
    <title>Fix Users and Roles Visibility</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test { margin: 15px 0; padding: 20px; border-radius: 10px; }
        .success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
        .error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
        .info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
        .warning { background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; }
        pre { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            margin: 10px 5px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .button:hover { background: #45a049; transform: translateY(-2px); }
        .button.secondary { background: #2196f3; }
        .button.secondary:hover { background: #1976d2; }
        .button.danger { background: #f44336; }
        .button.danger:hover { background: #da190b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë• –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–µ–π</h1>
        
        <div class="test info">
            <h3>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º</h3>
            <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—á–µ–º—É –Ω–µ –≤–∏–¥–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ —Ä–æ–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</p>
            <button class="button" onclick="checkLocalStorage()">1Ô∏è‚É£ –ü–†–û–í–ï–†–ò–¢–¨ LOCALSTORAGE</button>
            <button class="button" onclick="testDatabaseConnection()">2Ô∏è‚É£ –¢–ï–°–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ë–î</button>
            <button class="button" onclick="fixLocalStorageSettings()">3Ô∏è‚É£ –ò–°–ü–†–ê–í–ò–¢–¨ –ù–ê–°–¢–†–û–ô–ö–ò</button>
            <button class="button secondary" onclick="testUsersPage()">4Ô∏è‚É£ –¢–ï–°–¢ –°–¢–†–ê–ù–ò–¶–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const config = {
            url: 'https://ssvazdgnmatbdynkhkqo.supabase.co',
            apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdmF6ZGdubWF0YmR5bmtoa3FvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzM0MzgzNCwiZXhwIjoyMDcyOTE5ODM0fQ.Gen-PI-vDkKjskpIvJNcQw0Uj3d0zGXB98zIxNK6di0'
        };

        function addResult(title, type, data) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = \`test \${type}\`;
            div.innerHTML = \`
                <h3>\${title}</h3>
                <pre>\${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            \`;
            results.appendChild(div);
        }

        window.checkLocalStorage = async function() {
            addResult('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ localStorage...', 'info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∫–ª—é—á–∏ localStorage
            const relevantKeys = [
                'externalDatabase',
                'supabaseSettings', 
                'dataSourceConfig',
                'authConfig',
                'userSettings'
            ];
            
            const localStorageStatus = {};
            
            relevantKeys.forEach(key => {
                const value = localStorage.getItem(key);
                localStorageStatus[key] = {
                    exists: !!value,
                    value: value ? (value.length > 200 ? value.substring(0, 200) + '...' : value) : null
                };
                
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        localStorageStatus[key].parsed = parsed;
                        localStorageStatus[key].valid_json = true;
                        
                        // –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è externalDatabase
                        if (key === 'externalDatabase') {
                            localStorageStatus[key].has_url = !!parsed.url;
                            localStorageStatus[key].has_api_key = !!parsed.apiKey;
                            localStorageStatus[key].url_correct = parsed.url === config.url;
                        }
                    } catch (e) {
                        localStorageStatus[key].valid_json = false;
                        localStorageStatus[key].parse_error = e.message;
                    }
                }
            });
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            const externalDbOk = localStorageStatus.externalDatabase?.has_url && 
                               localStorageStatus.externalDatabase?.has_api_key && 
                               localStorageStatus.externalDatabase?.url_correct;
            
            addResult(externalDbOk ? '‚úÖ LocalStorage –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ' : '‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ localStorage', 
                     externalDbOk ? 'success' : 'error', 
                     localStorageStatus);
            
            return externalDbOk;
        };

        window.testDatabaseConnection = async function() {
            addResult('üåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...', 'info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–µ–π');
            
            try {
                // –¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const usersResponse = await fetch(\`\${config.url}/rest/v1/users?limit=3\`, {
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': \`Bearer \${config.apiKey}\`,
                        'Content-Type': 'application/json'
                    }
                });

                if (usersResponse.ok) {
                    const users = await usersResponse.json();
                    addResult('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ë–î', 'success', {
                        status: 'CONNECTED',
                        users_count: users.length,
                        sample_users: users.map(u => ({ id: u.id, email: u.email, name: u.name, status: u.status })),
                        database_table: 'users'
                    });
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º', 'error', {
                        status: usersResponse.status,
                        error: await usersResponse.text()
                    });
                }

                // –¢–µ—Å—Ç —Ä–æ–ª–µ–π  
                const rolesResponse = await fetch(\`\${config.url}/rest/v1/roles?limit=3\`, {
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': \`Bearer \${config.apiKey}\`,
                        'Content-Type': 'application/json'
                    }
                });

                if (rolesResponse.ok) {
                    const roles = await rolesResponse.json();
                    addResult('‚úÖ –†–æ–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ë–î', 'success', {
                        status: 'CONNECTED',
                        roles_count: roles.length,
                        sample_roles: roles.map(r => ({ id: r.id, code: r.code, name: r.name, scope: r.scope })),
                        database_table: 'roles'
                    });
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–æ–ª—è–º', 'error', {
                        status: rolesResponse.status,
                        error: await rolesResponse.text()
                    });
                }

                // –¢–µ—Å—Ç —Å–≤—è–∑–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Ä–æ–ª–∏
                const userRolesResponse = await fetch(\`\${config.url}/rest/v1/user_roles?limit=3\`, {
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': \`Bearer \${config.apiKey}\`,
                        'Content-Type': 'application/json'
                    }
                });

                if (userRolesResponse.ok) {
                    const userRoles = await userRolesResponse.json();
                    addResult('‚úÖ –°–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Ä–æ–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã', 'success', {
                        status: 'CONNECTED',
                        user_roles_count: userRoles.length,
                        sample_assignments: userRoles.map(ur => ({ user_id: ur.user_id, role_id: ur.role_id })),
                        database_table: 'user_roles'
                    });
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–≤—è–∑—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Ä–æ–ª–∏', 'error', {
                        status: userRolesResponse.status,
                        error: await userRolesResponse.text()
                    });
                }
                
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î', 'error', {
                    error: error.message,
                    note: '–í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π'
                });
            }
        };

        window.fixLocalStorageSettings = async function() {
            addResult('üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ localStorage...', 'info', '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ —Ä–æ–ª—è–º');
            
            // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ externalDatabase (–≥–ª–∞–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤)
            const externalDbConfig = {
                url: config.url,
                apiKey: config.apiKey,
                status: 'connected',
                lastUpdated: new Date().toISOString(),
                description: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–Ω–µ—à–Ω–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–µ–π'
            };
            localStorage.setItem('externalDatabase', JSON.stringify(externalDbConfig));
            
            // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ supabaseSettings (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
            const supabaseConfig = {
                url: config.url,
                apiKey: config.apiKey,
                status: 'connected',
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('supabaseSettings', JSON.stringify(supabaseConfig));
            
            // 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ dataSourceConfig (–¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤)
            const dataSourceConfig = {
                useDatabase: true,
                databaseConnected: true,
                supabaseUrl: config.url,
                apiKey: config.apiKey,
                lastCheck: new Date().toISOString(),
                status: 'connected'
            };
            localStorage.setItem('dataSourceConfig', JSON.stringify(dataSourceConfig));

            // 4. –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
            window.dispatchEvent(new Event('storage'));
            window.dispatchEvent(new CustomEvent('localStorageChanged'));

            addResult('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ localStorage –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã', 'success', {
                message: '–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ä–æ–ª—è–º–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã',
                configs_applied: {
                    externalDatabase: 'CONFIGURED',
                    supabaseSettings: 'CONFIGURED', 
                    dataSourceConfig: 'CONFIGURED'
                },
                database_url: config.url,
                next_step: '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –µ—ë'
            });
        };

        window.testUsersPage = async function() {
            addResult('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...', 'info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ —Ä–∞–±–æ—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const usersPageResponse = await fetch('http://localhost:3005/admin/users', {
                    method: 'GET',
                    headers: { 'Accept': 'text/html' }
                });

                if (usersPageResponse.ok) {
                    addResult('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–æ—Å—Ç—É–ø–Ω–∞', 'success', {
                        url: 'http://localhost:3005/admin/users',
                        status: usersPageResponse.status,
                        accessible: true
                    });
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                    window.open('http://localhost:3005/admin/users', '_blank');
                    
                } else {
                    // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π URL
                    const usersPageResponse2 = await fetch('http://localhost:3005/admin/users-and-roles', {
                        method: 'GET',
                        headers: { 'Accept': 'text/html' }
                    });

                    if (usersPageResponse2.ok) {
                        addResult('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞–π–¥–µ–Ω–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π URL)', 'success', {
                            url: 'http://localhost:3005/admin/users-and-roles',
                            status: usersPageResponse2.status
                        });
                        window.open('http://localhost:3005/admin/users-and-roles', '_blank');
                    } else {
                        addResult('‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error', {
                            tried_urls: [
                                'http://localhost:3005/admin/users',
                                'http://localhost:3005/admin/users-and-roles'
                            ],
                            note: '–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ dev server –∑–∞–ø—É—â–µ–Ω'
                        });
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ localStorage
                const finalCheck = {
                    externalDatabase: localStorage.getItem('externalDatabase') ? 'SET' : 'MISSING',
                    supabaseSettings: localStorage.getItem('supabaseSettings') ? 'SET' : 'MISSING',
                    dataSourceConfig: localStorage.getItem('dataSourceConfig') ? 'SET' : 'MISSING'
                };

                const allConfigured = Object.values(finalCheck).every(v => v === 'SET');

                addResult('üìã –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', allConfigured ? 'success' : 'warning', {
                    configuration_status: finalCheck,
                    all_configured: allConfigured,
                    users_should_be_visible: allConfigured ? 'YES' : 'NO',
                    roles_should_be_visible: allConfigured ? 'YES' : 'NO',
                    message: allConfigured ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ —Ä–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è' : '–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'
                });
                
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'error', {
                    error: error.message,
                    note: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ'
                });
            }
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(checkLocalStorage, 1000);
        setTimeout(testDatabaseConnection, 2000);
    </script>
</body>
</html>