<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pull-to-Refresh Auth Debug</title>
    <style>
        body {
            font-family: system-ui;
            margin: 0;
            padding: 20px;
            background: #1e293b;
            color: white;
            min-height: 200vh;
        }
        
        /* –¢–µ –∂–µ CSS –ø—Ä–∞–≤–∏–ª–∞ —á—Ç–æ –∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ */
        @media (hover: none) and (pointer: coarse) {
            html, body { 
                overscroll-behavior: none !important;
                overscroll-behavior-y: none !important;
                -webkit-overscroll-behavior: none !important;
                -webkit-overscroll-behavior-y: none !important;
                touch-action: pan-x pan-y !important;
                -webkit-overflow-scrolling: auto !important;
            }
        }
        
        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: #334155;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .content {
            margin-top: 300px;
            background: linear-gradient(to bottom, #334155, #1e293b);
            padding: 20px;
            min-height: 150vh;
        }
        
        .debug-info {
            background: #0f172a;
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 12px;
        }
        
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 5px;
            cursor: pointer;
        }
        
        .button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="status">
        <h2>üîç Pull-to-Refresh Auth Debug</h2>
        <p><strong>–í—Ä–µ–º—è:</strong> <span id="time"></span></p>
        
        <div style="margin: 10px 0;">
            <button class="button" onclick="setAuthData()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Auth Data</button>
            <button class="button" onclick="clearAuthData()">–û—á–∏—Å—Ç–∏—Ç—å Auth Data</button>
            <button class="button" onclick="checkAuthData()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Auth Data</button>
        </div>
        
        <div class="debug-info">
            <strong>localStorage:</strong><br>
            currentUser: <span id="localStorage-currentUser"></span><br>
            auth_token: <span id="localStorage-auth_token"></span><br>
            tradeframe_user: <span id="localStorage-tradeframe_user"></span><br>
            authToken: <span id="localStorage-authToken"></span>
        </div>
        
        <div class="debug-info">
            <strong>sessionStorage:</strong><br>
            currentUser: <span id="sessionStorage-currentUser"></span><br>
            auth_token: <span id="sessionStorage-auth_token"></span>
        </div>
        
        <div class="debug-info">
            <strong>–°–æ–±—ã—Ç–∏—è:</strong><br>
            <div id="events"></div>
        </div>
    </div>

    <div class="content">
        <h2>Auth Debug Test</h2>
        <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong></p>
        <ol>
            <li>–ù–∞–∂–º–∏—Ç–µ "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Auth Data" —á—Ç–æ–±—ã —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</li>
            <li>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ—Ç—è–Ω—É—Ç—å –≤–Ω–∏–∑ –æ—Ç —Å–∞–º–æ–≥–æ –≤–µ—Ä—Ö–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</li>
            <li>–ù–∞–±–ª—é–¥–∞–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ localStorage/sessionStorage</li>
            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–∏ –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ pull-to-refresh</li>
        </ol>
        
        <div style="height: 100px; background: #475569; margin: 20px 0; display: flex; align-items: center; justify-content: center;">
            –¢–µ—Å—Ç –∫–æ–Ω—Ç–µ–Ω—Ç 1 - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ auth –¥–∞–Ω–Ω—ã—Ö
        </div>
        
        <div style="height: 100px; background: #64748b; margin: 20px 0; display: flex; align-items: center; justify-content: center;">
            –¢–µ—Å—Ç –∫–æ–Ω—Ç–µ–Ω—Ç 2 - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ localStorage
        </div>
        
        <div style="height: 100px; background: #475569; margin: 20px 0; display: flex; align-items: center; justify-content: center;">
            –¢–µ—Å—Ç –∫–æ–Ω—Ç–µ–Ω—Ç 3 - –ø—Ä–æ–≤–µ—Ä–∫–∞ sessionStorage
        </div>
    </div>

    <script>
        let eventCount = 0;
        
        function updateTime() {
            document.getElementById('time').textContent = new Date().toLocaleTimeString();
        }
        
        function logEvent(message) {
            const eventsDiv = document.getElementById('events');
            const eventEl = document.createElement('div');
            eventEl.style.fontSize = '11px';
            eventEl.style.marginBottom = '2px';
            eventEl.textContent = `${++eventCount}. ${new Date().toLocaleTimeString()}: ${message}`;
            eventsDiv.appendChild(eventEl);
            if (eventsDiv.children.length > 15) {
                eventsDiv.removeChild(eventsDiv.firstChild);
            }
            eventsDiv.scrollTop = eventsDiv.scrollHeight;
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è auth –¥–∞–Ω–Ω—ã–º–∏
        function setAuthData() {
            const mockUser = {
                id: "test-user-id",
                email: "test@example.com",
                name: "Test User",
                role: "admin",
                permissions: ["all"],
                status: "active",
                lastLogin: new Date().toISOString()
            };
            
            localStorage.setItem('currentUser', JSON.stringify(mockUser));
            localStorage.setItem('auth_token', 'test-token-123');
            localStorage.setItem('tradeframe_user', JSON.stringify(mockUser));
            localStorage.setItem('authToken', 'supabase_session');
            
            sessionStorage.setItem('currentUser', JSON.stringify(mockUser));
            sessionStorage.setItem('auth_token', 'test-session-token-123');
            
            logEvent('Auth data —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ localStorage –∏ sessionStorage');
            checkAuthData();
        }
        
        function clearAuthData() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('auth_token');
            localStorage.removeItem('tradeframe_user');
            localStorage.removeItem('authToken');
            
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('auth_token');
            
            logEvent('Auth data –æ—á–∏—â–µ–Ω—ã –∏–∑ localStorage –∏ sessionStorage');
            checkAuthData();
        }
        
        function checkAuthData() {
            // localStorage check
            document.getElementById('localStorage-currentUser').textContent = 
                localStorage.getItem('currentUser') ? '–µ—Å—Ç—å' : '–Ω–µ—Ç';
            document.getElementById('localStorage-auth_token').textContent = 
                localStorage.getItem('auth_token') ? '–µ—Å—Ç—å' : '–Ω–µ—Ç';
            document.getElementById('localStorage-tradeframe_user').textContent = 
                localStorage.getItem('tradeframe_user') ? '–µ—Å—Ç—å' : '–Ω–µ—Ç';
            document.getElementById('localStorage-authToken').textContent = 
                localStorage.getItem('authToken') ? '–µ—Å—Ç—å' : '–Ω–µ—Ç';
                
            // sessionStorage check
            document.getElementById('sessionStorage-currentUser').textContent = 
                sessionStorage.getItem('currentUser') ? '–µ—Å—Ç—å' : '–Ω–µ—Ç';
            document.getElementById('sessionStorage-auth_token').textContent = 
                sessionStorage.getItem('auth_token') ? '–µ—Å—Ç—å' : '–Ω–µ—Ç';
        }
        
        // –°–æ–±—ã—Ç–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        window.addEventListener('storage', (e) => {
            logEvent(`Storage change: ${e.key} = ${e.newValue ? 'set' : 'removed'}`);
            checkAuthData();
        });
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ pull-to-refresh
        let isAtTop = true;
        let startY = 0;
        
        document.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            isAtTop = window.scrollY === 0;
            checkAuthData(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∫–∞—Å–∞–Ω–∏—è
        }, { passive: true });
        
        document.addEventListener('touchmove', (e) => {
            if (isAtTop && window.scrollY === 0) {
                const currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;
                if (deltaY > 50) {
                    logEvent(`‚ö†Ô∏è PULL detected: ${Math.round(deltaY)}px - checking auth data...`);
                    setTimeout(checkAuthData, 100); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                }
            }
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            logEvent('Touch end - final auth check');
            setTimeout(checkAuthData, 200); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É
        }, { passive: true });
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º beforeunload –∏ reload
        window.addEventListener('beforeunload', (e) => {
            logEvent('‚ö†Ô∏è beforeunload triggered - page about to reload!');
        });
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('visibilitychange', (e) => {
            logEvent(`Visibility: ${document.visibilityState}`);
            if (document.visibilityState === 'visible') {
                setTimeout(checkAuthData, 100);
            }
        });
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º focus/blur –æ–∫–Ω–∞
        window.addEventListener('focus', (e) => {
            logEvent('Window focus');
            checkAuthData();
        });
        
        window.addEventListener('blur', (e) => {
            logEvent('Window blur');
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateTime();
        checkAuthData();
        setInterval(updateTime, 1000);
        setInterval(checkAuthData, 2000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        
        logEvent('Auth debug —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    </script>
</body>
</html>