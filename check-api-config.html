<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeFrame API Configuration Checker</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 20px; }
        .status-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .status-success { border-left: 4px solid #28a745; }
        .status-warning { border-left: 4px solid #ffc107; }
        .status-error { border-left: 4px solid #dc3545; }
        .config-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .config-table th, .config-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .config-table th { background-color: #f2f2f2; font-weight: bold; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-mock { background: #ffeaa7; color: #2d3436; }
        .badge-db { background: #55a3ff; color: white; }
        .code { background: #f4f4f4; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.danger { background: #dc3545; }
        .json-output { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .connections-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
        .connection-card { border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; background: white; }
        .connection-active { border-color: #28a745; background: #f8fff9; }
        .test-result { margin: 10px 0; padding: 8px; border-radius: 4px; }
        .test-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .test-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è TradeFrame API Configuration Status</h1>
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>
        </div>

        <div class="status-card status-warning">
            <h3>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ</h3>
            <p>–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∑–∞–ø—É—â–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ TradeFrame Builder –Ω–∞ <strong>localhost:3000</strong></p>
            <p>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –ª–æ–≥–æ–≤</p>
        </div>

        <div class="status-card">
            <h3>üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å API</h3>
            <div id="current-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="status-card">
            <h3>üîó –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
            <div id="connections-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="status-card">
            <h3>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</h3>
            <button onclick="testAllConnections()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
            <button onclick="testCurrentConnection()" class="secondary">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ</button>
            <div id="test-results"></div>
        </div>

        <div class="status-card">
            <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <button onclick="exportConfig()">–≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</button>
            <button onclick="showDebugInfo()" class="secondary">Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
            <button onclick="resetToDefault()" class="danger">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div class="status-card">
            <h3>üìù JSON –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h3>
            <div id="json-config" class="json-output">–ù–∞–∂–º–∏—Ç–µ "Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let apiConfigService = null;
        let currentConfig = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', async () => {
            await checkApiService();
            await loadCurrentStatus();
        });

        async function checkApiService() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å window.apiConfigService
                if (window.apiConfigService) {
                    apiConfigService = window.apiConfigService;
                    console.log('‚úÖ API Config Service –Ω–∞–π–¥–µ–Ω –≤ window');
                } else {
                    console.warn('‚ö†Ô∏è window.apiConfigService –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ –∏–ª–∏ –Ω–µ –≤ dev —Ä–µ–∂–∏–º–µ.');
                    document.getElementById('current-status').innerHTML = `
                        <div class="status-error">
                            <strong>‚ùå API Config Service –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</strong><br>
                            –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ localhost:3000 –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
                        </div>
                    `;
                    return;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        async function loadCurrentStatus() {
            if (!apiConfigService) {
                showManualInstructions();
                return;
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                currentConfig = apiConfigService.getCurrentConfig();
                const currentConnection = apiConfigService.getCurrentConnection();
                const stats = apiConfigService.getUsageStats();

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
                document.getElementById('current-status').innerHTML = `
                    <table class="config-table">
                        <tr>
                            <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                            <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                        </tr>
                        <tr>
                            <td>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</td>
                            <td><span class="badge ${stats.mockMode ? 'badge-mock' : 'badge-db'}">${stats.mockMode ? 'MOCK (localStorage)' : 'DATABASE'}</span></td>
                        </tr>
                        <tr>
                            <td>–ê–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</td>
                            <td><strong>${currentConnection?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong></td>
                        </tr>
                        <tr>
                            <td>URL API</td>
                            <td><code class="code">${currentConnection?.url || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}</code></td>
                        </tr>
                        <tr>
                            <td>–¢–∏–ø –ë–î</td>
                            <td>${currentConnection?.type?.toUpperCase() || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</td>
                        </tr>
                        <tr>
                            <td>–í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</td>
                            <td>${stats.totalConnections}</td>
                        </tr>
                        <tr>
                            <td>–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏</td>
                            <td>${stats.debugMode ? 'üü¢ –í–∫–ª—é—á–µ–Ω' : 'üî¥ –í—ã–∫–ª—é—á–µ–Ω'}</td>
                        </tr>
                        <tr>
                            <td>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</td>
                            <td>${new Date(stats.lastUpdated).toLocaleString('ru-RU')}</td>
                        </tr>
                    </table>
                `;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                await loadConnections();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                document.getElementById('current-status').innerHTML = `
                    <div class="status-error">
                        <strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        async function loadConnections() {
            if (!apiConfigService) return;

            try {
                const connections = apiConfigService.getAllConnections();
                const currentId = currentConfig.currentConnectionId;

                const connectionsHtml = connections.map(conn => `
                    <div class="connection-card ${conn.id === currentId ? 'connection-active' : ''}">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <h4>${conn.name} ${conn.id === currentId ? '‚úÖ' : ''}</h4>
                                <small>${conn.description || ''}</small>
                            </div>
                            <div>
                                <span class="badge ${conn.type === 'mock' ? 'badge-mock' : 'badge-db'}">${conn.type.toUpperCase()}</span>
                                ${conn.isDefault ? '<span class="badge" style="background: #6c757d; color: white;">DEFAULT</span>' : ''}
                            </div>
                        </div>
                        <div><strong>URL:</strong> <code class="code">${conn.url}</code></div>
                        <div><strong>ID:</strong> <code class="code">${conn.id}</code></div>
                        ${conn.settings ? `<div><strong>Timeout:</strong> ${conn.settings.timeout}ms</div>` : ''}
                        <div style="margin-top: 10px;">
                            <button onclick="switchConnection('${conn.id}')" ${conn.id === currentId ? 'disabled' : ''}>
                                ${conn.id === currentId ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è'}
                            </button>
                            <button onclick="testConnection('${conn.id}')" class="secondary">–¢–µ—Å—Ç</button>
                        </div>
                        <div id="test-result-${conn.id}"></div>
                    </div>
                `).join('');

                document.getElementById('connections-list').innerHTML = `
                    <div class="connections-grid">
                        ${connectionsHtml}
                    </div>
                `;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:', error);
            }
        }

        async function testConnection(connectionId) {
            if (!apiConfigService) return;

            const resultDiv = document.getElementById(`test-result-${connectionId}`);
            resultDiv.innerHTML = 'üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';

            try {
                const result = await apiConfigService.testConnection(connectionId);
                
                resultDiv.innerHTML = `
                    <div class="test-result ${result.success ? 'test-success' : 'test-error'}">
                        ${result.success ? '‚úÖ' : '‚ùå'} ${result.success ? '–£—Å–ø–µ—à–Ω–æ' : '–û—à–∏–±–∫–∞'}
                        ${result.responseTime ? ` (${result.responseTime}–º—Å)` : ''}
                        ${result.error ? `<br><small>${result.error}</small>` : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result test-error">
                        ‚ùå –û—à–∏–±–∫–∞: ${error.message}
                    </div>
                `;
            }
        }

        async function testCurrentConnection() {
            if (!apiConfigService) return;

            const currentConnection = apiConfigService.getCurrentConnection();
            if (currentConnection) {
                await testConnection(currentConnection.id);
            }
        }

        async function testAllConnections() {
            if (!apiConfigService) return;

            document.getElementById('test-results').innerHTML = 'üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...';

            try {
                const results = await apiConfigService.testAllConnections();
                
                let resultsHtml = '<h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h4>';
                for (const [id, result] of Object.entries(results)) {
                    resultsHtml += `
                        <div class="test-result ${result.success ? 'test-success' : 'test-error'}">
                            <strong>${id}:</strong> ${result.success ? '‚úÖ –£—Å–ø–µ—à–Ω–æ' : '‚ùå –û—à–∏–±–∫–∞'}
                            ${result.responseTime ? ` (${result.responseTime}–º—Å)` : ''}
                            ${result.error ? `<br><small>${result.error}</small>` : ''}
                        </div>
                    `;
                }

                document.getElementById('test-results').innerHTML = resultsHtml;

            } catch (error) {
                document.getElementById('test-results').innerHTML = `
                    <div class="test-result test-error">
                        ‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}
                    </div>
                `;
            }
        }

        async function switchConnection(connectionId) {
            if (!apiConfigService) return;

            try {
                const result = await apiConfigService.switchConnection(connectionId);
                if (result.success) {
                    alert(`‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞: ${result.connection?.name}\n\n–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.`);
                    location.reload();
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        async function exportConfig() {
            if (!apiConfigService) return;

            try {
                const config = apiConfigService.exportConfig();
                const blob = new Blob([config], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tradeframe-api-config-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞');
            } catch (error) {
                alert(`‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`);
            }
        }

        async function showDebugInfo() {
            if (!apiConfigService) return;

            try {
                const config = apiConfigService.getCurrentConfig();
                const stats = apiConfigService.getUsageStats();
                const debugInfo = {
                    timestamp: new Date().toISOString(),
                    currentConfig: config,
                    usageStats: stats,
                    environment: {
                        userAgent: navigator.userAgent,
                        url: location.href,
                        localStorage: !!window.localStorage
                    }
                };

                document.getElementById('json-config').textContent = JSON.stringify(debugInfo, null, 2);
            } catch (error) {
                document.getElementById('json-config').textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        async function resetToDefault() {
            if (!apiConfigService) return;

            if (confirm('‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                try {
                    apiConfigService.resetToDefault();
                    alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                    location.reload();
                } catch (error) {
                    alert(`‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞: ${error.message}`);
                }
            }
        }

        function showManualInstructions() {
            document.getElementById('current-status').innerHTML = `
                <div class="status-warning">
                    <h4>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ</h4>
                    <p>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ TradeFrame Builder –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:</p>
                    <div class="code" style="display: block; margin: 10px 0; padding: 10px;">
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏<br>
window.apiConfigService.getCurrentConnection()<br>
window.apiConfigService.getCurrentApiUrl()<br>
window.apiConfigService.isMockMode()<br><br>

// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É<br>
window.apiConfigService.getUsageStats()<br><br>

// –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è<br>
await window.apiConfigService.testAllConnections()<br><br>

// –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è<br>
window.apiConfigService.getAllConnections()
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>