<!DOCTYPE html>
<html>
<head>
    <title>–ü—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ equipment –¥–ª—è –ê–ó–° 4</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <h1 class="text-xl font-bold mb-4">üîç –ü—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ equipment –¥–ª—è –ê–ó–° 4</h1>
    
    <div class="bg-blue-900 border border-blue-600 rounded-lg p-4 mb-4">
        <p><strong>–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –∑–∞–ø—Ä–æ—Å–∞ –∫ equipment</strong></p>
    </div>
    
    <button onclick="runTests()" class="bg-green-600 px-4 py-2 rounded mb-4">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
    <div id="results" class="mt-4 space-y-2"></div>

    <script>
        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI';
        const SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZkeHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type === 'error' ? 'text-red-400 bg-red-900 p-3 rounded' : 
                             type === 'success' ? 'text-green-400 bg-green-900 p-3 rounded' : 
                             type === 'warning' ? 'text-yellow-400 bg-yellow-900 p-3 rounded' :
                             'text-blue-400 bg-blue-900 p-3 rounded';
            div.innerHTML = message;
            results.appendChild(div);
        }

        async function runTests() {
            const results = document.getElementById('results');
            results.innerHTML = '';
            
            log('<strong>üîç –ù–ê–ß–ò–ù–ê–ï–ú –ü–†–û–í–ï–†–ö–£ EQUIPMENT</strong>');
            
            // –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–∞–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –∏ –Ω–∞–π–¥–µ–º –ê–ó–° 4
            log('<br><strong>–¢–µ—Å—Ç 1: –ü–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ê–ó–° 4</strong>');
            
            try {
                const tpResponse = await fetch(`${SUPABASE_URL}/rest/v1/trading_points`, {
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`
                    }
                });
                
                const tradingPoints = await tpResponse.json();
                log(`–ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${tradingPoints.length}`);
                
                // –ò—â–µ–º –ê–ó–° 4
                const azs4Variants = tradingPoints.filter(tp => 
                    tp.name?.includes('4') || 
                    tp.name?.includes('–ê–ó–° 4') || 
                    tp.external_id === '4'
                );
                
                if (azs4Variants.length > 0) {
                    log(`‚úÖ –ù–∞–π–¥–µ–Ω—ã –≤–∞—Ä–∏–∞–Ω—Ç—ã –ê–ó–° 4:`, 'success');
                    for (const tp of azs4Variants) {
                        log(`  ‚Ä¢ ${tp.name} (ID: ${tp.id}, external_id: ${tp.external_id})`);
                        
                        // –î–ª—è –∫–∞–∂–¥–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π –ê–ó–° 4 –ø—Ä–æ–≤–µ—Ä—è–µ–º equipment
                        await checkEquipmentForTP(tp.id, tp.name);
                    }
                } else {
                    log('‚ùå –ê–ó–° 4 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ä–µ–¥–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫', 'error');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
            
            // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï equipment –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            log('<br><strong>–¢–µ—Å—Ç 2: –í—Å–µ equipment –≤ –±–∞–∑–µ (–ø–µ—Ä–≤—ã–µ 20)</strong>');
            
            try {
                const allEquipResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment?limit=20`, {
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`
                    }
                });
                
                const allEquipment = await allEquipResponse.json();
                log(`–í—Å–µ–≥–æ equipment –≤ –±–∞–∑–µ: ${allEquipment.length}`);
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ trading_point_id
                const byTP = {};
                allEquipment.forEach(eq => {
                    const tpId = eq.trading_point_id || 'NO_TP';
                    if (!byTP[tpId]) byTP[tpId] = [];
                    byTP[tpId].push(eq);
                });
                
                log('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ equipment –ø–æ —Ç–æ—Ä–≥–æ–≤—ã–º —Ç–æ—á–∫–∞–º:');
                Object.entries(byTP).forEach(([tpId, items]) => {
                    const tanks = items.filter(e => e.system_type === 'fuel_tank');
                    log(`  ‚Ä¢ TP ${tpId}: ${items.length} –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (${tanks.length} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤)`);
                });
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
            
            // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
            log('<br><strong>–¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å Service Key</strong>');
            
            try {
                const serviceResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment?system_type=eq.fuel_tank&limit=10`, {
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`
                    }
                });
                
                if (serviceResponse.ok) {
                    const tanks = await serviceResponse.json();
                    log(`‚úÖ Service Key: –ù–∞–π–¥–µ–Ω–æ ${tanks.length} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤`, 'success');
                    
                    if (tanks.length > 0) {
                        log('–ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤:');
                        tanks.slice(0, 3).forEach(tank => {
                            log(`  ‚Ä¢ ${tank.name} (TP: ${tank.trading_point_id}, –¢–æ–ø–ª–∏–≤–æ: ${tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'] || '–ù–ï–¢'})`);
                        });
                    }
                } else {
                    log(`‚ùå Service Key –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${serviceResponse.status}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å Service Key: ${error.message}`, 'error');
            }
        }
        
        async function checkEquipmentForTP(tpId, tpName) {
            log(`<br>üîç <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ equipment –¥–ª—è ${tpName} (${tpId})</strong>`);
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –í–°–ï equipment –¥–ª—è —ç—Ç–æ–π –¢–ü
                const allResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment?trading_point_id=eq.${tpId}`, {
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`
                    }
                });
                
                const allEquipment = await allResponse.json();
                log(`  –í—Å–µ–≥–æ equipment: ${allEquipment.length}`);
                
                if (allEquipment.length > 0) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏–ø—ã
                    const types = {};
                    allEquipment.forEach(eq => {
                        const type = eq.system_type || 'NO_TYPE';
                        types[type] = (types[type] || 0) + 1;
                    });
                    
                    log('  –¢–∏–ø—ã equipment:');
                    Object.entries(types).forEach(([type, count]) => {
                        log(`    ‚Ä¢ ${type}: ${count}`);
                    });
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã
                    const tanks = allEquipment.filter(eq => eq.system_type === 'fuel_tank');
                    log(`  üõ¢Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ (fuel_tank): ${tanks.length}`, tanks.length > 0 ? 'success' : 'error');
                    
                    if (tanks.length > 0) {
                        log('  –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã:');
                        tanks.forEach(tank => {
                            const fuel = tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'] || '–ù–ï–¢ –¢–ò–ü–ê';
                            const status = tank.status || 'NO_STATUS';
                            log(`    ‚Ä¢ ${tank.name} | –¢–æ–ø–ª–∏–≤–æ: ${fuel} | –°—Ç–∞—Ç—É—Å: ${status}`);
                        });
                    }
                } else {
                    log(`  ‚ùå –ù–µ—Ç equipment –¥–ª—è —ç—Ç–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏`, 'error');
                }
                
            } catch (error) {
                log(`  ‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        runTests();
    </script>
</body>
</html>