<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Operations STS API Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .error { background: #f44336; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { background: #2196F3; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #4CAF50; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .danger { background: #f44336; }
        .primary { background: #2196F3; }
        pre {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .badge-sts { background: #4CAF50; color: white; }
        .badge-supabase { background: #2196F3; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Operations STS API Integration</h1>
        
        <div class="info">
            <strong>–ú–æ–¥–µ—Ä–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–µ—Ä–∞—Ü–∏–π:</strong><br>
            ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ getTransactions –≤ STS API —Å–µ—Ä–≤–∏—Å<br>
            ‚úÖ –°–æ–∑–¥–∞–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Transaction –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ API<br>
            ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–∑ STS API<br>
            ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö<br>
            ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ STS API"<br>
            üîÑ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="openOperationsPage()">üîÑ –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–µ—Ä–∞—Ü–∏–π</button>
            <button onclick="openOperationsPageWithAPI()" class="primary">‚õΩ –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–µ—Ä–∞—Ü–∏–π —Å STS API</button>
            <button onclick="testDirectTransactionsAPI()" class="primary">üß™ –¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ API /v1/transactions</button>
            <button onclick="clearLogs()" class="danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let logs = [];
        let testWindow = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({
                time: timestamp,
                message: message,
                type: type
            });
            updateDisplay();
            console.log(`[${timestamp}] ${message}`);
        }

        function updateDisplay() {
            const resultsDiv = document.getElementById('results');
            
            let html = '';
            
            if (logs.length > 0) {
                html += '<h2>üìù –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h2>';
                logs.slice(-20).forEach(logEntry => {
                    const className = logEntry.type === 'error' ? 'error' : logEntry.type === 'success' ? 'success' : 'info';
                    html += `<div class="${className}">
                        <strong>[${logEntry.time}]</strong> ${logEntry.message}
                    </div>`;
                });
            }
            
            resultsDiv.innerHTML = html;
        }

        function openOperationsPage() {
            log('üîÑ –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–µ—Ä–∞—Ü–∏–π...', 'info');
            
            if (testWindow && !testWindow.closed) {
                testWindow.close();
            }
            
            testWindow = window.open('http://localhost:3006/network/operations-transactions', 'operationsTest', 'width=1600,height=1000');
            
            log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –æ—Ç–∫—Ä—ã—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å!', 'success');
            log('üìã –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:', 'info');
            log('1. –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ Supabase', 'info');
            log('2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫ –æ–ø–µ—Ä–∞—Ü–∏–π', 'info');
            log('3. KPI –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º', 'info');
        }

        function openOperationsPageWithAPI() {
            log('‚õΩ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è STS API...', 'info');
            
            if (testWindow && !testWindow.closed) {
                testWindow.close();
            }
            
            testWindow = window.open('http://localhost:3006/network/operations-transactions', 'operationsApiTest', 'width=1600,height=1000');
            
            log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –æ—Ç–∫—Ä—ã—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π STS API!', 'success');
            log('üìã –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:', 'info');
            log('1. –ï—Å–ª–∏ STS API –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ STS API"', 'info');
            log('2. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ API –°–¢–°', 'info');
            log('3. –û–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ STS API –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–º–µ—á–µ–Ω—ã –∑–µ–ª–µ–Ω—ã–º –±–µ–π–¥–∂–µ–º "STS API"', 'info');
            log('4. –í –∑–∞–≥–æ–ª–æ–≤–∫–µ —Ç–∞–±–ª–∏—Ü—ã –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è —Å—á–µ—Ç—á–∏–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ STS API', 'info');
            log('5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è', 'info');
            
            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –æ–∫–Ω–æ
            const checkInterval = setInterval(() => {
                if (testWindow.closed) {
                    clearInterval(checkInterval);
                    log('üîÑ –û–∫–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–æ', 'info');
                }
            }, 1000);
            
            // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
            setTimeout(() => {
                if (testWindow && !testWindow.closed) {
                    testWindow.close();
                    log('üîÑ –û–∫–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç', 'info');
                }
                clearInterval(checkInterval);
            }, 300000);
        }

        async function testDirectTransactionsAPI() {
            log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ /v1/transactions API...', 'info');
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ localStorage
                const configStr = localStorage.getItem('sts-api-config');
                if (!configStr) {
                    log('‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è STS API –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage', 'error');
                    log('üí° –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API –≤ —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ -> API CTC"', 'info');
                    return;
                }
                
                const config = JSON.parse(configStr);
                
                if (!config.enabled) {
                    log('‚ö†Ô∏è STS API –æ—Ç–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'error');
                    return;
                }
                
                if (!config.token) {
                    log('‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è API', 'error');
                    log('üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö API', 'info');
                    return;
                }
                
                log(`üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ ${config.url}/v1/transactions...`, 'info');
                
                // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
                const testUrl = new URL(`${config.url}/v1/transactions`);
                testUrl.searchParams.set('system', '1'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                testUrl.searchParams.set('date_from', '2024-12-01');
                testUrl.searchParams.set('date_to', '2024-12-31');
                testUrl.searchParams.set('limit', '50');
                
                log(`üì° URL –∑–∞–ø—Ä–æ—Å–∞: ${testUrl.toString()}`, 'info');
                
                const response = await fetch(testUrl.toString(), {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${config.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log(`‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã! –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${Array.isArray(data) ? data.length : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`, 'success');
                        
                        if (Array.isArray(data) && data.length > 0) {
                            log('üîç –ü—Ä–∏–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ API:', 'info');
                            log(`<pre>${JSON.stringify(data[0], null, 2)}</pre>`, 'info');
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
                            const completedCount = data.filter(t => t.status === 'completed' || t.status === 'success').length;
                            const totalAmount = data.reduce((sum, t) => sum + (parseFloat(t.total || t.amount || 0)), 0);
                            
                            log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:`, 'success');
                            log(`‚Ä¢ –í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${data.length}`, 'info');
                            log(`‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö: ${completedCount}`, 'info');
                            log(`‚Ä¢ –û–±—â–∞—è —Å—É–º–º–∞: ${totalAmount.toFixed(2)} ‚ÇΩ`, 'info');
                            
                        } else {
                            log(`<pre>${JSON.stringify(data, null, 2).substring(0, 1000)}${responseText.length > 1000 ? '\n...(–æ–±—Ä–µ–∑–∞–Ω–æ)' : ''}</pre>`, 'info');
                        }
                    } catch (e) {
                        log(`‚úÖ –ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, –Ω–æ –æ—Ç–≤–µ—Ç –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:`, 'success');
                        log(`<pre>${responseText.substring(0, 500)}</pre>`, 'info');
                    }
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ API:`, 'error');
                    log(`<pre>${responseText}</pre>`, 'error');
                    
                    if (response.status === 422) {
                        try {
                            const errorData = JSON.parse(responseText);
                            log(`üîç –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ 422:`, 'error');
                            if (errorData.detail) {
                                errorData.detail.forEach((detail, index) => {
                                    log(`${index + 1}. –ü–æ–ª–µ: ${detail.loc?.join('.')} | –¢–∏–ø: ${detail.type} | –°–æ–æ–±—â–µ–Ω–∏–µ: ${detail.msg}`, 'error');
                                });
                            }
                        } catch (e) {
                            log(`–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ 422`, 'error');
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            logs.length = 0;
            updateDisplay();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            log('üöÄ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
            log('üéØ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å STS API –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π', 'info');
            log('üìã –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:', 'info');
            log('‚Ä¢ –ú–µ—Ç–æ–¥ getTransactions –≤ STS API —Å–µ—Ä–≤–∏—Å–µ', 'info');
            log('‚Ä¢ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å Transaction –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ API', 'info');
            log('‚Ä¢ –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π STS', 'info');
            log('‚Ä¢ –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö (STS API vs Supabase)', 'info');
            log('‚Ä¢ –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ STS API', 'info');
        };
    </script>
</body>
</html>