<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ –ü–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ø–æ ID</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1e1e1e; 
            color: #fff; 
            padding: 20px; 
            line-height: 1.4;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .code { 
            background: #0d1117; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #444;
            overflow-x: auto;
        }
        .section {
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #2d2d2d;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üéØ –ü–û–ò–°–ö –¢–û–†–ì–û–í–û–ô –¢–û–ß–ö–ò –ü–û ID</h1>
    <p>–ü–æ–∏—Å–∫ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏: <strong>6969b08d-1cbe-45c2-ae9c-8002c7022b59</strong></p>
    
    <div class="section">
        <h3>üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        <button onclick="findTradingPointById()">üéØ –ù–∞–π—Ç–∏ —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É</button>
        <button onclick="testDbConnection()">üîó –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î</button>
        <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    
    <div id="log"></div>

    <script type="module">
        const TRADING_POINT_ID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
        const log = document.getElementById('log');
        
        function addLog(message, type = 'normal') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            log.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        function addSection(title) {
            const div = document.createElement('div');
            div.className = 'section';
            div.innerHTML = `<h3>${title}</h3>`;
            log.appendChild(div);
            return div;
        }
        
        window.clearLog = function() {
            log.innerHTML = '';
        }
        
        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
        window.testDbConnection = async function() {
            const section = addSection('üîó –¢–ï–°–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –ë–ê–ó–ï –î–ê–ù–ù–´–•');
            
            try {
                addLog('üì¶ –ò–º–ø–æ—Ä—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞...', 'info');
                const { httpClient } = await import('./src/services/universalHttpClient.js');
                addLog('‚úÖ HTTP –∫–ª–∏–µ–Ω—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
                
                // –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                addLog('üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'info');
                const healthResponse = await httpClient.get('/rest/v1/', {
                    destination: 'supabase',
                    timeout: 10000
                });
                
                addLog(`<div class="code">
                    Success: ${healthResponse.success}<br>
                    Status: ${healthResponse.status}<br>
                    Response Time: ${healthResponse.responseTime}ms<br>
                    Error: ${healthResponse.error || '–Ω–µ—Ç'}
                </div>`, healthResponse.success ? 'success' : 'error');
                
                if (healthResponse.success) {
                    addLog('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success');
                    addLog('üîß –ü—Ä—è–º—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –≤ universalHttpClient.ts —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'success');
                } else {
                    addLog('‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'error');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ trading_points
                addLog('üìç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ trading_points...', 'info');
                const tableResponse = await httpClient.get('/rest/v1/trading_points', {
                    destination: 'supabase',
                    queryParams: { 
                        select: 'count',
                        head: 'true'
                    }
                });
                
                if (tableResponse.success) {
                    addLog('‚úÖ –î–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ trading_points –ø–æ–ª—É—á–µ–Ω', 'success');
                } else {
                    addLog('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ trading_points', 'error');
                    addLog(`–û—à–∏–±–∫–∞: ${tableResponse.error}`, 'error');
                }
                
            } catch (error) {
                addLog(`üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
                addLog(`<div class="code">${error.stack}</div>`, 'error');
            }
        }
        
        // –ü–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ø–æ ID
        window.findTradingPointById = async function() {
            const section = addSection(`üéØ –ü–û–ò–°–ö –¢–û–†–ì–û–í–û–ô –¢–û–ß–ö–ò: ${TRADING_POINT_ID}`);
            
            try {
                addLog('üì¶ –ò–º–ø–æ—Ä—Ç HTTP –∫–ª–∏–µ–Ω—Ç–∞...', 'info');
                const { httpClient } = await import('./src/services/universalHttpClient.js');
                
                // –®–∞–≥ 1: –ü–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ø–æ ID
                addLog(`üìç –ü–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ —Å ID: ${TRADING_POINT_ID}`, 'info');
                
                const tradingPointResponse = await httpClient.get('/rest/v1/trading_points', {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id,code,network_id',
                        id: `eq.${TRADING_POINT_ID}`
                    }
                });
                
                if (!tradingPointResponse.success) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏', 'error');
                    addLog(`–û—à–∏–±–∫–∞: ${tradingPointResponse.error}`, 'error');
                    return;
                }
                
                if (!tradingPointResponse.data || tradingPointResponse.data.length === 0) {
                    addLog('‚ùå –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ —Å –¥–∞–Ω–Ω—ã–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    addLog('üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å ID –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö', 'warning');
                    return;
                }
                
                const tradingPoint = tradingPointResponse.data[0];
                addLog('‚úÖ –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞!', 'success');
                addLog(`<div class="code">
                    ID: ${tradingPoint.id}<br>
                    –ù–∞–∑–≤–∞–Ω–∏–µ: ${tradingPoint.name}<br>
                    External ID: ${tradingPoint.external_id || '‚ùå –ù–ï–¢'}<br>
                    Code: ${tradingPoint.code || '‚ùå –ù–ï–¢'}<br>
                    Network ID: ${tradingPoint.network_id || '‚ùå –ù–ï–¢'}
                </div>`, 'success');
                
                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Station ID –¥–ª—è API
                const stationId = tradingPoint.external_id || tradingPoint.code || '';
                addLog(`üìã Station ID –¥–ª—è API: "${stationId}"`, stationId ? 'success' : 'error');
                
                if (!stationId) {
                    addLog('‚ùå –£ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –Ω–µ—Ç external_id –∏–ª–∏ code –¥–ª—è Station ID!', 'error');
                    addLog('üí° –î–æ–±–∞–≤—å—Ç–µ external_id –≤ —Ç–∞–±–ª–∏—Ü—É trading_points –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏', 'warning');
                    addLog(`<div class="code">UPDATE trading_points SET external_id = '4' WHERE id = '${TRADING_POINT_ID}';</div>`, 'warning');
                }
                
                // –®–∞–≥ 2: –ü–æ–∏—Å–∫ —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å–µ—Ç–∏
                if (!tradingPoint.network_id) {
                    addLog('‚ùå –£ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –Ω–µ—Ç network_id!', 'error');
                    return;
                }
                
                addLog(`üåê –ü–æ–∏—Å–∫ —Å–µ—Ç–∏ —Å ID: ${tradingPoint.network_id}`, 'info');
                
                const networkResponse = await httpClient.get('/rest/v1/networks', {
                    destination: 'supabase',
                    queryParams: {
                        select: 'id,name,external_id,code,status',
                        id: `eq.${tradingPoint.network_id}`
                    }
                });
                
                if (!networkResponse.success || !networkResponse.data || networkResponse.data.length === 0) {
                    addLog('‚ùå –°–≤—è–∑–∞–Ω–Ω–∞—è —Å–µ—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', 'error');
                    return;
                }
                
                const network = networkResponse.data[0];
                addLog('‚úÖ –°–≤—è–∑–∞–Ω–Ω–∞—è —Å–µ—Ç—å –Ω–∞–π–¥–µ–Ω–∞!', 'success');
                addLog(`<div class="code">
                    ID: ${network.id}<br>
                    –ù–∞–∑–≤–∞–Ω–∏–µ: ${network.name}<br>
                    External ID: ${network.external_id || '‚ùå –ù–ï–¢'}<br>
                    Code: ${network.code || '‚ùå –ù–ï–¢'}<br>
                    Status: ${network.status || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}
                </div>`, 'success');
                
                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ System ID –¥–ª—è API
                const systemId = network.external_id || network.code || '';
                addLog(`üìã System ID –¥–ª—è API: "${systemId}"`, systemId ? 'success' : 'error');
                
                if (!systemId) {
                    addLog('‚ùå –£ —Å–µ—Ç–∏ –Ω–µ—Ç external_id –∏–ª–∏ code –¥–ª—è System ID!', 'error');
                    addLog('üí° –î–æ–±–∞–≤—å—Ç–µ external_id –≤ —Ç–∞–±–ª–∏—Ü—É networks –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏', 'warning');
                    addLog(`<div class="code">UPDATE networks SET external_id = '15' WHERE id = '${network.id}';</div>`, 'warning');
                }
                
                // –®–∞–≥ 3: –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–ª—è API
                addLog('üéØ –ò–¢–û–ì–û–í–´–ï –†–ï–ö–í–ò–ó–ò–¢–´ –î–õ–Ø –í–ù–ï–®–ù–ï–ì–û API:', 'info');
                
                const ready = !!(systemId && stationId);
                
                addLog(`<div class="code">
                    System ID (–æ—Ç —Å–µ—Ç–∏): "${systemId}" ${systemId ? '‚úÖ' : '‚ùå'}<br>
                    Station ID (–æ—Ç —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏): "${stationId}" ${stationId ? '‚úÖ' : '‚ùå'}<br>
                    –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –¥–ª—è API: ${ready ? '‚úÖ –ì–û–¢–û–í–û' : '‚ùå –ù–ï –ì–û–¢–û–í–û'}<br>
                    ${ready ? '–ü–æ–ª–Ω—ã–π URL –¥–ª—è API:' : '–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–î'}
                </div>`, ready ? 'success' : 'error');
                
                if (ready) {
                    const apiUrl = `https://pos.autooplata.ru/tms/tanks?system=${systemId}&station=${stationId}`;
                    addLog(`<div class="code">
                        GET ${apiUrl}<br>
                        Authorization: Basic UserApi:PasswordApi
                    </div>`, 'success');
                    addLog('üéâ –í—Å–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–∞–π–¥–µ–Ω—ã! –í–Ω–µ—à–Ω–∏–π API –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å.', 'success');
                    addLog('üí° –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã" —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'success');
                } else {
                    addLog('‚ö†Ô∏è –ù–µ –≤—Å–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–∞–π–¥–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ external_id –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã.', 'warning');
                }
                
                // –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ tradingNetworkConfigService (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
                addLog('üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ tradingNetworkConfigService...', 'info');
                try {
                    const { tradingNetworkConfigService } = await import('./src/services/tradingNetworkConfigService.js');
                    const apiParams = await tradingNetworkConfigService.getApiParamsFromDB(TRADING_POINT_ID);
                    
                    if (apiParams) {
                        addLog('‚úÖ API –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å', 'success');
                        addLog(`<div class="code">
                            System ID –∏–∑ —Å–µ—Ä–≤–∏—Å–∞: "${apiParams.systemId}"<br>
                            Station ID –∏–∑ —Å–µ—Ä–≤–∏—Å–∞: "${apiParams.stationId}"<br>
                            –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä—è–º–æ–º—É –ø–æ–∏—Å–∫—É: ${apiParams.systemId === systemId && apiParams.stationId === stationId ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}
                        </div>`, 'success');
                    } else {
                        addLog('‚ùå API –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ù–ï –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å', 'error');
                    }
                } catch (serviceError) {
                    addLog(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ä–≤–∏—Å–æ–º: ${serviceError.message}`, 'warning');
                }
                
            } catch (error) {
                addLog(`üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}`, 'error');
                addLog(`<div class="code">${error.stack}</div>`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞
        addLog('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏...', 'info');
        setTimeout(() => {
            findTradingPointById();
        }, 1000);
    </script>
</body>
</html>