<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–≤—è–∑–∫–∏ Networks ‚Üî Trading Points</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1400px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button.success { background: #28a745; }
        button.danger { background: #dc3545; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 11px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        th { background: #f2f2f2; }
        pre { background: #f8f9fa; padding: 8px; overflow-x: auto; font-size: 10px; max-height: 200px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <h1>üîó –¢–µ—Å—Ç —Å–≤—è–∑–∫–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–µ—Ç–µ–π –∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫</h1>
    
    <div class="section info">
        <h3>–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏:</h3>
        <ol>
            <li>üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ Supabase</li>
            <li>üîó –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏</li>
            <li>üì± –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</li>
            <li>‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ localStorage –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è</li>
        </ol>
    </div>

    <div class="section">
        <button onclick="runFullTest()" class="success">üöÄ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
        <button onclick="testApplicationComponents()">üì± –¢–µ—Å—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
        <button onclick="clearLocalStorage()" class="danger">üßπ –û—á–∏—Å—Ç–∏—Ç—å localStorage</button>
        <button onclick="openApp()">üåê –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
    </div>

    <div class="grid">
        <div id="results-left"></div>
        <div id="results-right"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function logResult(message, type = 'info', data = null, side = 'left') {
            const resultsDiv = document.getElementById(`results-${side}`)
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
                    const keys = Object.keys(data[0]).slice(0, 6) // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 6 –∫–æ–ª–æ–Ω–æ–∫
                    content += `
                        <table>
                            <thead><tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr></thead>
                            <tbody>
                                ${data.slice(0, 5).map(row => 
                                    `<tr>${keys.map(k => {
                                        let value = row[k]
                                        if (typeof value === 'object') value = JSON.stringify(value).substring(0, 30) + '...'
                                        if (typeof value === 'string' && value.length > 30) value = value.substring(0, 27) + '...'
                                        return `<td>${value || '‚Äî'}</td>`
                                    }).join('')}</tr>`
                                ).join('')}
                            </tbody>
                        </table>
                        ${data.length > 5 ? `<p><em>–ü–æ–∫–∞–∑–∞–Ω–æ –ø–µ—Ä–≤—ã—Ö 5 –∏–∑ ${data.length} –∑–∞–ø–∏—Å–µ–π</em></p>` : ''}
                    `
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2).substring(0, 500)}${JSON.stringify(data, null, 2).length > 500 ? '...' : ''}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
            console.log(message, data)
        }

        window.runFullTest = async function() {
            document.getElementById('results-left').innerHTML = ''
            document.getElementById('results-right').innerHTML = ''
            
            logResult('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏...', 'info', null, 'left')
            
            // 1. –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–µ—Ç–∏
            logResult('üåê –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–µ—Ç–µ–π', 'info', null, 'left')
            
            try {
                const { data: networks, error: networksError } = await supabase
                    .from('networks')
                    .select('id, name, external_id, status')
                    .order('name')
                
                if (networksError) throw networksError
                
                if (networks.length > 0) {
                    logResult(`‚úÖ –¢–æ—Ä–≥–æ–≤—ã–µ —Å–µ—Ç–∏: ${networks.length}`, 'success', networks, 'left')
                } else {
                    logResult('‚ùå –¢–æ—Ä–≥–æ–≤—ã–µ —Å–µ—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!', 'error', null, 'left')
                    return
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–µ—Ç–µ–π', 'error', error, 'left')
                return
            }
            
            // 2. –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏
            logResult('üè™ –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫', 'info', null, 'right')
            
            try {
                const { data: tradingPoints, error: pointsError } = await supabase
                    .from('trading_points')
                    .select('id, name, network_id, external_id, geolocation')
                    .order('name')
                
                if (pointsError) throw pointsError
                
                if (tradingPoints.length > 0) {
                    logResult(`‚úÖ –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏: ${tradingPoints.length}`, 'success', tradingPoints, 'right')
                } else {
                    logResult('‚ö†Ô∏è –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning', '–í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è', 'right')
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫', 'error', error, 'right')
            }
            
            // 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–≤—è–∑–∏ (JOIN)
            logResult('üîó –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–µ–π (JOIN)', 'info', null, 'left')
            
            try {
                const { data: joinedData, error: joinError } = await supabase
                    .from('trading_points')
                    .select(`
                        id,
                        name,
                        external_id,
                        geolocation,
                        networks!inner (
                            id,
                            name,
                            external_id
                        )
                    `)
                    .order('name')
                
                if (joinError) throw joinError
                
                if (joinedData.length > 0) {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const displayData = joinedData.map(item => ({
                        —Ç–æ—á–∫–∞: item.name,
                        —Ç–æ—á–∫–∞_id: item.external_id || item.id.substring(0, 8),
                        —Å–µ—Ç—å: item.networks?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                        —Å–µ—Ç—å_id: item.networks?.external_id || '–ù–µ—Ç',
                        –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: item.geolocation?.city || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
                    }))
                    
                    logResult(`‚úÖ –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${joinedData.length}`, 'success', displayData, 'left')
                } else {
                    logResult('‚ùå –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!', 'error', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ foreign keys', 'left')
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–µ–π', 'error', error, 'left')
            }
            
            // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
            logResult('üîç –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage', 'info', null, 'right')
            
            const storageKeys = Object.keys(localStorage)
            const relevantKeys = storageKeys.filter(key => 
                key.includes('network') || 
                key.includes('trading') || 
                key.includes('point') ||
                key.includes('azs')
            )
            
            if (relevantKeys.length > 0) {
                logResult(`‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –æ—Å—Ç–∞—Ç–∫–∏ –≤ localStorage: ${relevantKeys.length}`, 'warning', relevantKeys, 'right')
            } else {
                logResult('‚úÖ localStorage —á–∏—Å—Ç –æ—Ç –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ç–µ–π/—Ç–æ—á–µ–∫', 'success', null, 'right')
            }
            
            // 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–∏—Å–æ–≤
            logResult('‚öôÔ∏è –®–∞–≥ 5: –¢–µ—Å—Ç —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', 'info', null, 'right')
            
            try {
                // –ò–º–∏—Ç–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É networksService
                const { data: networksServiceTest, error: networksServiceError } = await supabase
                    .from('networks')
                    .select('id, name, external_id')
                    .limit(3)
                
                if (networksServiceError) throw networksServiceError
                
                logResult('‚úÖ networksService —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success', networksServiceTest, 'right')
                
                // –ò–º–∏—Ç–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É tradingPointsService
                const { data: pointsServiceTest, error: pointsServiceError } = await supabase
                    .from('trading_points')
                    .select('id, name, network_id')
                    .limit(3)
                
                if (pointsServiceError) throw pointsServiceError
                
                logResult('‚úÖ tradingPointsService —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success', pointsServiceTest, 'right')
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤', 'error', error, 'right')
            }
            
            // 6. –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
            logResult('üìä –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢', 'success', {
                —Å—Ç–∞—Ç—É—Å: '–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!',
                —Å–µ—Ç–∏: '–ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Supabase ‚úÖ',
                —Ç–æ—Ä–≥–æ–≤—ã–µ_—Ç–æ—á–∫–∏: '–ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Supabase ‚úÖ',
                —Å–≤—è–∑–∏: '–†–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ foreign keys ‚úÖ',
                localStorage: '–û—á–∏—â–µ–Ω –æ—Ç –¥–∞–Ω–Ω—ã—Ö ‚úÖ',
                –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: '100%'
            }, 'left')
        }

        window.testApplicationComponents = async function() {
            logResult('üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...', 'info', null, 'left')
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            try {
                const appUrls = [
                    'http://localhost:3002/admin/networks',
                    'http://localhost:3002/',
                    'http://localhost:3002/equipment'
                ]
                
                for (const url of appUrls) {
                    try {
                        const response = await fetch(url, { method: 'HEAD' })
                        if (response.ok) {
                            logResult(`‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ: ${url}`, 'success', null, 'left')
                        } else {
                            logResult(`‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ: ${url}`, 'warning', response.status, 'left')
                        }
                    } catch (e) {
                        logResult(`‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ ${url}`, 'error', e.message, 'left')
                    }
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', 'error', error, 'left')
            }
        }

        window.clearLocalStorage = function() {
            const before = Object.keys(localStorage).length
            localStorage.clear()
            const after = Object.keys(localStorage).length
            
            logResult(`üßπ localStorage –æ—á–∏—â–µ–Ω: –±—ã–ª–æ ${before}, —Å—Ç–∞–ª–æ ${after}`, 'success', null, 'right')
            
            setTimeout(() => {
                location.reload()
            }, 1500)
        }

        window.openApp = function() {
            window.open('http://localhost:3002/admin/networks', '_blank')
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runFullTest, 1000)
        })
    </script>
</body>
</html>