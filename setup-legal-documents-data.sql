-- ============================================
-- SQL скрипт для заполнения демо-данными
-- Система управления правовыми документами TradeFrame
-- ============================================

-- ============================================
-- 1. ДОБАВЛЕНИЕ ТИПОВ ДОКУМЕНТОВ
-- ============================================

INSERT INTO document_types (id, code, title, description, is_active) VALUES
('550e8400-e29b-41d4-a716-446655440001', 'tos', 'Пользовательское соглашение', 'Условия использования платформы TradeControl', true),
('550e8400-e29b-41d4-a716-446655440002', 'privacy', 'Политика конфиденциальности', 'Политика обработки персональных данных', true),
('550e8400-e29b-41d4-a716-446655440003', 'pdn', 'Политика в области защиты персональных данных', 'Подробная политика защиты персональных данных', true)
ON CONFLICT (code) DO UPDATE SET
    title = EXCLUDED.title,
    description = EXCLUDED.description,
    updated_at = NOW();

-- ============================================
-- 2. ДОБАВЛЕНИЕ ВЕРСИЙ ДОКУМЕНТОВ
-- ============================================

-- Пользовательское соглашение v1.0.0
INSERT INTO document_versions (
    id, doc_type_id, doc_type_code, version, status, title,
    content_html, content_md, checksum, changelog, locale, is_current,
    editor_id, editor_name, published_at
) VALUES (
    '550e8400-e29b-41d4-a716-446655440101',
    '550e8400-e29b-41d4-a716-446655440001',
    'tos',
    '1.0.0',
    'published',
    'Пользовательское соглашение',
    '<h1>Пользовательское соглашение</h1>
<p><strong>Дата вступления в силу:</strong> 1 января 2024 года</p>

<h2>1. Общие положения</h2>
<p>Настоящее Пользовательское соглашение ("Соглашение") регулирует отношения между ООО "ТрейдКонтрол" ("Компания") и пользователем ("Пользователь") платформы TradeControl.</p>

<h2>2. Предмет соглашения</h2>
<p>Компания предоставляет Пользователю доступ к программному обеспечению для управления торговыми сетями АЗС.</p>

<h2>3. Права и обязанности сторон</h2>
<p>Пользователь обязуется:</p>
<ul>
  <li>Использовать платформу в соответствии с назначением</li>
  <li>Не нарушать права третьих лиц</li>
  <li>Обеспечивать безопасность своих учетных данных</li>
</ul>

<h2>4. Ответственность</h2>
<p>Компания не несет ответственности за косвенные убытки, возникшие в результате использования платформы.</p>

<h2>5. Заключительные положения</h2>
<p>Соглашение может быть изменено Компанией в одностороннем порядке с уведомлением Пользователей.</p>',
    '# Пользовательское соглашение

**Дата вступления в силу:** 1 января 2024 года

## 1. Общие положения

Настоящее Пользовательское соглашение ("Соглашение") регулирует отношения между ООО "ТрейдКонтрол" ("Компания") и пользователем ("Пользователь") платформы TradeControl.

## 2. Предмет соглашения

Компания предоставляет Пользователю доступ к программному обеспечению для управления торговыми сетями АЗС.

## 3. Права и обязанности сторон

Пользователь обязуется:
- Использовать платформу в соответствии с назначением
- Не нарушать права третьих лиц
- Обеспечивать безопасность своих учетных данных

## 4. Ответственность

Компания не несет ответственности за косвенные убытки, возникшие в результате использования платформы.

## 5. Заключительные положения

Соглашение может быть изменено Компанией в одностороннем порядке с уведомлением Пользователей.',
    'sha256:abc123tos100',
    'Первоначальная версия пользовательского соглашения',
    'ru',
    true,
    '550e8400-e29b-41d4-a716-446655440000',
    'Системный администратор',
    '2024-01-01 00:00:00+00'
) ON CONFLICT (id) DO UPDATE SET
    content_html = EXCLUDED.content_html,
    content_md = EXCLUDED.content_md,
    updated_at = NOW();

-- Политика конфиденциальности v1.0.0
INSERT INTO document_versions (
    id, doc_type_id, doc_type_code, version, status, title,
    content_html, content_md, checksum, changelog, locale, is_current,
    editor_id, editor_name, published_at
) VALUES (
    '550e8400-e29b-41d4-a716-446655440102',
    '550e8400-e29b-41d4-a716-446655440002',
    'privacy',
    '1.0.0',
    'published',
    'Политика конфиденциальности',
    '<h1>Политика конфиденциальности</h1>
<p><strong>Дата вступления в силу:</strong> 1 января 2024 года</p>

<h2>1. Общие сведения</h2>
<p>ООО "ТрейдКонтрол" обрабатывает персональные данные пользователей в соответствии с требованиями ФЗ-152 "О персональных данных".</p>

<h2>2. Какие данные мы собираем</h2>
<ul>
  <li>Контактная информация (email, телефон)</li>
  <li>Данные об использовании сервиса</li>
  <li>Техническая информация (IP-адрес, браузер)</li>
</ul>

<h2>3. Цели обработки данных</h2>
<p>Персональные данные обрабатываются для:</p>
<ul>
  <li>Предоставления доступа к платформе</li>
  <li>Технической поддержки пользователей</li>
  <li>Улучшения качества сервиса</li>
</ul>

<h2>4. Передача данных третьим лицам</h2>
<p>Мы не передаем персональные данные третьим лицам без согласия пользователя, за исключением случаев, предусмотренных законодательством.</p>

<h2>5. Права субъектов персональных данных</h2>
<p>Вы имеете право на доступ к своим персональным данным, их изменение или удаление.</p>',
    '# Политика конфиденциальности

**Дата вступления в силу:** 1 января 2024 года

## 1. Общие сведения

ООО "ТрейдКонтрол" обрабатывает персональные данные пользователей в соответствии с требованиями ФЗ-152 "О персональных данных".

## 2. Какие данные мы собираем

- Контактная информация (email, телефон)
- Данные об использовании сервиса
- Техническая информация (IP-адрес, браузер)

## 3. Цели обработки данных

Персональные данные обрабатываются для:
- Предоставления доступа к платформе
- Технической поддержки пользователей
- Улучшения качества сервиса

## 4. Передача данных третьим лицам

Мы не передаем персональные данные третьим лицам без согласия пользователя, за исключением случаев, предусмотренных законодательством.

## 5. Права субъектов персональных данных

Вы имеете право на доступ к своим персональным данным, их изменение или удаление.',
    'sha256:def456privacy100',
    'Первоначальная версия политики конфиденциальности',
    'ru',
    true,
    '550e8400-e29b-41d4-a716-446655440000',
    'Системный администратор',
    '2024-01-01 00:00:00+00'
) ON CONFLICT (id) DO UPDATE SET
    content_html = EXCLUDED.content_html,
    content_md = EXCLUDED.content_md,
    updated_at = NOW();

-- Политика защиты персональных данных v1.0.0
INSERT INTO document_versions (
    id, doc_type_id, doc_type_code, version, status, title,
    content_html, content_md, checksum, changelog, locale, is_current,
    editor_id, editor_name, published_at
) VALUES (
    '550e8400-e29b-41d4-a716-446655440103',
    '550e8400-e29b-41d4-a716-446655440003',
    'pdn',
    '1.0.0',
    'published',
    'Политика в области защиты персональных данных',
    '<h1>Политика в области защиты персональных данных</h1>
<p><strong>Дата вступления в силу:</strong> 1 января 2024 года</p>

<h2>1. Назначение и область применения</h2>
<p>Настоящая Политика определяет подходы ООО "ТрейдКонтрол" к защите персональных данных и обеспечению их безопасности.</p>

<h2>2. Правовые основания обработки</h2>
<p>Обработка персональных данных осуществляется на основании:</p>
<ul>
  <li>Согласия субъекта персональных данных</li>
  <li>Исполнения договорных обязательств</li>
  <li>Требований законодательства РФ</li>
</ul>

<h2>3. Принципы обработки персональных данных</h2>
<ul>
  <li>Законность и справедливость</li>
  <li>Ограничение конкретными целями</li>
  <li>Соответствие целям обработки</li>
  <li>Точность и актуальность</li>
  <li>Безопасность</li>
</ul>

<h2>4. Организационно-технические меры защиты</h2>
<p>Для защиты персональных данных применяются:</p>
<ul>
  <li>Шифрование данных</li>
  <li>Контроль доступа</li>
  <li>Резервное копирование</li>
  <li>Мониторинг безопасности</li>
</ul>

<h2>5. Порядок реагирования на инциденты</h2>
<p>При выявлении нарушений безопасности персональных данных незамедлительно принимаются меры по их устранению и уведомлению регулятора.</p>',
    '# Политика в области защиты персональных данных

**Дата вступления в силу:** 1 января 2024 года

## 1. Назначение и область применения

Настоящая Политика определяет подходы ООО "ТрейдКонтрол" к защите персональных данных и обеспечению их безопасности.

## 2. Правовые основания обработки

Обработка персональных данных осуществляется на основании:
- Согласия субъекта персональных данных
- Исполнения договорных обязательств
- Требований законодательства РФ

## 3. Принципы обработки персональных данных

- Законность и справедливость
- Ограничение конкретными целями
- Соответствие целям обработки
- Точность и актуальность
- Безопасность

## 4. Организационно-технические меры защиты

Для защиты персональных данных применяются:
- Шифрование данных
- Контроль доступа
- Резервное копирование
- Мониторинг безопасности

## 5. Порядок реагирования на инциденты

При выявлении нарушений безопасности персональных данных незамедлительно принимаются меры по их устранению и уведомлению регулятора.',
    'sha256:ghi789pdn100',
    'Первоначальная версия политики защиты персональных данных',
    'ru',
    true,
    '550e8400-e29b-41d4-a716-446655440000',
    'Системный администратор',
    '2024-01-01 00:00:00+00'
) ON CONFLICT (id) DO UPDATE SET
    content_html = EXCLUDED.content_html,
    content_md = EXCLUDED.content_md,
    updated_at = NOW();

-- ============================================
-- 3. ДОБАВЛЕНИЕ ДЕМО СОГЛАСИЙ АДМИНИСТРАТОРА
-- ============================================

-- Проверяем, есть ли администратор в таблице users
DO $$
DECLARE
    admin_user_id UUID;
BEGIN
    -- Попытка найти администратора
    SELECT id INTO admin_user_id 
    FROM users 
    WHERE email = 'admin@demo-azs.ru' OR email = 'admin@tradecontrol.ru'
    LIMIT 1;
    
    -- Если администратор найден, добавляем его согласия
    IF admin_user_id IS NOT NULL THEN
        -- Согласие на пользовательское соглашение
        INSERT INTO user_document_acceptances (
            id, user_id, user_email, doc_version_id, doc_type_code, doc_version,
            accepted_at, ip_address, user_agent, source
        ) VALUES (
            '550e8400-e29b-41d4-a716-446655440201',
            admin_user_id,
            'admin@demo-azs.ru',
            '550e8400-e29b-41d4-a716-446655440101',
            'tos',
            '1.0.0',
            '2024-01-01 10:00:00+00',
            '192.168.1.100',
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'web'
        ) ON CONFLICT (user_id, doc_version_id) DO NOTHING;

        -- Согласие на политику конфиденциальности
        INSERT INTO user_document_acceptances (
            id, user_id, user_email, doc_version_id, doc_type_code, doc_version,
            accepted_at, ip_address, user_agent, source
        ) VALUES (
            '550e8400-e29b-41d4-a716-446655440202',
            admin_user_id,
            'admin@demo-azs.ru',
            '550e8400-e29b-41d4-a716-446655440102',
            'privacy',
            '1.0.0',
            '2024-01-01 10:01:00+00',
            '192.168.1.100',
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'web'
        ) ON CONFLICT (user_id, doc_version_id) DO NOTHING;

        -- Согласие на политику защиты ПД
        INSERT INTO user_document_acceptances (
            id, user_id, user_email, doc_version_id, doc_type_code, doc_version,
            accepted_at, ip_address, user_agent, source
        ) VALUES (
            '550e8400-e29b-41d4-a716-446655440203',
            admin_user_id,
            'admin@demo-azs.ru',
            '550e8400-e29b-41d4-a716-446655440103',
            'pdn',
            '1.0.0',
            '2024-01-01 10:02:00+00',
            '192.168.1.100',
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'web'
        ) ON CONFLICT (user_id, doc_version_id) DO NOTHING;

        -- Обновляем статус согласий администратора
        INSERT INTO user_legal_statuses (
            user_id, 
            tos_version_id, privacy_version_id, pdn_version_id,
            tos_accepted_at, privacy_accepted_at, pdn_accepted_at,
            requires_consent
        ) VALUES (
            admin_user_id,
            '550e8400-e29b-41d4-a716-446655440101',
            '550e8400-e29b-41d4-a716-446655440102',
            '550e8400-e29b-41d4-a716-446655440103',
            '2024-01-01 10:00:00+00',
            '2024-01-01 10:01:00+00',
            '2024-01-01 10:02:00+00',
            false
        ) ON CONFLICT (user_id) DO UPDATE SET
            tos_version_id = EXCLUDED.tos_version_id,
            privacy_version_id = EXCLUDED.privacy_version_id,
            pdn_version_id = EXCLUDED.pdn_version_id,
            tos_accepted_at = EXCLUDED.tos_accepted_at,
            privacy_accepted_at = EXCLUDED.privacy_accepted_at,
            pdn_accepted_at = EXCLUDED.pdn_accepted_at,
            requires_consent = false,
            updated_at = NOW();

        RAISE NOTICE 'Демо-согласия добавлены для администратора (ID: %)', admin_user_id;
    ELSE
        RAISE NOTICE 'Администратор не найден, демо-согласия не добавлены';
    END IF;
END $$;

-- ============================================
-- 4. ДОБАВЛЕНИЕ ЗАПИСЕЙ АУДИТА
-- ============================================

-- Запись о создании типов документов
INSERT INTO legal_document_audit_log (
    id, actor_id, actor_name, actor_role, action, resource_type, resource_id,
    after_state, comment, ip_address, user_agent
) VALUES (
    '550e8400-e29b-41d4-a716-446655440301',
    '550e8400-e29b-41d4-a716-446655440000',
    'Системный администратор',
    'superadmin',
    'create_document_types',
    'document_types',
    '550e8400-e29b-41d4-a716-446655440001',
    '{"code": "tos", "title": "Пользовательское соглашение"}',
    'Инициализация системы правовых документов',
    '127.0.0.1',
    'System'
);

-- ============================================
-- ГОТОВО! Демо-данные правовых документов добавлены.
-- ============================================

-- Проверочные запросы:
SELECT 'Проверка созданных типов документов:' as info;
SELECT code, title, is_active FROM document_types ORDER BY code;

SELECT 'Проверка текущих версий документов:' as info;
SELECT doc_type_code, version, status, is_current, published_at 
FROM document_versions 
WHERE is_current = true 
ORDER BY doc_type_code;

SELECT 'Проверка согласий пользователей:' as info;
SELECT user_email, doc_type_code, doc_version, accepted_at 
FROM user_document_acceptances 
ORDER BY accepted_at;