<!DOCTYPE html>
<html>
<head>
    <title>Test Supabase Connection Status</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #fde8e8; border-color: #f44336; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; font-size: 12px; }
        .button { 
            background: #2196f3; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer;
        }
        .button:hover { background: #1976d2; }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase</h1>
    
    <div class="test info">
        <h3>üìã –ü—Ä–æ–±–ª–µ–º–∞</h3>
        <p>–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.</p>
        <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏—â—É—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ö–∞—Ä–¥–∫–æ–¥–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</p>
    </div>
    
    <div class="test">
        <h3>üß™ –¢–µ—Å—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <button class="button" onclick="testSupabaseConnection()">Test Supabase Connection</button>
        <button class="button" onclick="checkLocalStorageSettings()">Check localStorage</button>
        <button class="button" onclick="testDirectConnection()">Test Direct Connection</button>
        <button class="button" onclick="fixIndicators()">Fix Indicators</button>
    </div>

    <div id="results"></div>

    <script type="module">
        const results = document.getElementById('results');
        
        function addResult(title, type, data) {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        window.testSupabaseConnection = async function() {
            try {
                // Import Supabase client
                const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
                
                const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
                const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

                const supabase = createClient(supabaseUrl, serviceRoleKey);

                // Test basic connection
                const { data, error } = await supabase
                    .from('networks')
                    .select('count')
                    .limit(1);

                if (error) {
                    addResult('‚ùå Supabase Connection Failed', 'error', {
                        error: error.message,
                        code: error.code,
                        details: error.details
                    });
                } else {
                    addResult('‚úÖ Supabase Connection Success', 'success', {
                        message: 'Connected to Supabase successfully',
                        url: supabaseUrl,
                        hasServiceKey: 'Yes'
                    });
                }
            } catch (error) {
                addResult('‚ùå Connection Test Error', 'error', error.message);
            }
        };

        window.checkLocalStorageSettings = function() {
            const externalDb = localStorage.getItem('externalDatabase');
            const supabaseConfig = localStorage.getItem('supabaseConfig');
            
            if (!externalDb && !supabaseConfig) {
                addResult('‚ö†Ô∏è No Database Settings in localStorage', 'warning', {
                    message: 'No database configuration found in localStorage',
                    externalDatabase: null,
                    supabaseConfig: null,
                    explanation: 'This is why indicators show disconnected - they look for these settings'
                });
            } else {
                addResult('üìã localStorage Database Settings', 'info', {
                    externalDatabase: externalDb ? JSON.parse(externalDb) : null,
                    supabaseConfig: supabaseConfig ? JSON.parse(supabaseConfig) : null
                });
            }
        };

        window.testDirectConnection = async function() {
            try {
                const response = await fetch('https://tohtryzyffcebtyvkxwh.supabase.co/rest/v1/', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY'
                    }
                });
                
                if (response.ok) {
                    addResult('‚úÖ Direct HTTP Connection Success', 'success', {
                        status: response.status,
                        statusText: response.statusText,
                        url: response.url
                    });
                } else {
                    addResult('‚ùå Direct HTTP Connection Failed', 'error', {
                        status: response.status,
                        statusText: response.statusText
                    });
                }
            } catch (error) {
                addResult('‚ùå Direct Connection Error', 'error', error.message);
            }
        };

        window.fixIndicators = function() {
            // Create localStorage settings that indicators expect
            const supabaseSettings = {
                url: 'https://tohtryzyffcebtyvkxwh.supabase.co',
                apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY',
                connected: true
            };
            
            localStorage.setItem('externalDatabase', JSON.stringify(supabaseSettings));
            
            addResult('üîß Fixed Indicators', 'success', {
                message: 'Added Supabase settings to localStorage',
                action: 'Refresh the instructions page to see green indicators',
                settings: supabaseSettings
            });
        };

        // Auto-run basic checks
        checkLocalStorageSettings();
    </script>
</body>
</html>