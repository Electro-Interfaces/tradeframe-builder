<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è u@me.com</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>üîç –û—Ç–ª–∞–¥–∫–∞ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è u@me.com</h1>

    <div class="container">
        <h2>üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <button onclick="checkUser()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è u@me.com</button>
        <button onclick="checkAllAdmins()">–ù–∞–π—Ç–∏ –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤</button>
        <div id="userInfo"></div>
    </div>

    <div class="container">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
        <div id="results"></div>
    </div>

    <script>
        const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

        async function supabaseRequest(endpoint, options = {}) {
            const response = await fetch(`${supabaseUrl}/rest/v1/${endpoint}`, {
                ...options,
                headers: {
                    'apikey': supabaseServiceKey,
                    'Authorization': `Bearer ${supabaseServiceKey}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }

            return response.json();
        }

        async function checkUser() {
            const userInfoDiv = document.getElementById('userInfo');
            const resultsDiv = document.getElementById('results');

            try {
                userInfoDiv.innerHTML = '<p class="info">üîç –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è u@me.com...</p>';

                // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const users = await supabaseRequest('users?email=eq.u@me.com');

                if (users.length === 0) {
                    userInfoDiv.innerHTML = '<p class="error">‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å u@me.com –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>';
                    return;
                }

                const user = users[0];

                userInfoDiv.innerHTML = `
                    <h3 class="success">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω</h3>
                    <pre>
ID: ${user.id}
Email: ${user.email}
Name: ${user.name}
Status: ${user.status}
Tenant ID: ${user.tenant_id}
Created: ${user.created_at}
Preferences: ${JSON.stringify(user.preferences, null, 2)}
                    </pre>
                `;

                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–æ–ª—å –∏–∑ preferences
                const userRole = user.preferences?.role || 'no_role';
                console.log('üé≠ User role from preferences:', userRole);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ user_roles
                const userRoles = await supabaseRequest(`user_roles?user_id=eq.${user.id}&select=*,role:roles(*)`);

                console.log('üé≠ User roles from user_roles table:', userRoles);

                // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ä–æ–ª–∏ (–∫–∞–∫ –≤ supabaseAuthService)
                const permissions = getRolePermissions(userRole);

                resultsDiv.innerHTML = `
                    <h3>üìä –ê–Ω–∞–ª–∏–∑ —Ä–æ–ª–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π</h3>
                    <div style="background-color: #e9ecef; padding: 15px; border-radius: 4px; margin: 10px 0;">
                        <strong>–†–æ–ª—å –∏–∑ preferences:</strong> <span class="info">${userRole}</span><br>
                        <strong>–Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–º:</strong>
                        <span class="${userRole === 'system_admin' || userRole === 'super_admin' ? 'success' : 'error'}">
                            ${userRole === 'system_admin' || userRole === 'super_admin' ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}
                        </span><br>
                        <strong>–î–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –≤—Å–µ –º–µ–Ω—é:</strong>
                        <span class="${userRole === 'system_admin' || userRole === 'super_admin' ? 'success' : 'error'}">
                            ${userRole === 'system_admin' || userRole === 'super_admin' ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}
                        </span>
                    </div>

                    <h4>üîë –†–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ä–æ–ª–∏:</h4>
                    <pre>${JSON.stringify(permissions, null, 2)}</pre>

                    <h4>üé≠ –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Ä–æ–ª–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:</h4>
                    <pre>${JSON.stringify(userRoles, null, 2)}</pre>
                `;

            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `<p class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }

        // –ö–æ–ø–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ supabaseAuthService.ts
        function getRolePermissions(role) {
            const rolePermissions = {
                'system_admin': [
                    'users.read', 'users.create', 'users.update', 'users.delete',
                    'networks.read', 'networks.create', 'networks.update', 'networks.delete',
                    'trading_points.read', 'trading_points.create', 'trading_points.update', 'trading_points.delete',
                    'equipment.read', 'equipment.create', 'equipment.update', 'equipment.delete',
                    'operations.read', 'operations.create', 'operations.update', 'operations.delete',
                    'reports.read', 'reports.create', 'reports.export',
                    'settings.read', 'settings.update'
                ],
                'network_admin': [
                    'users.read', 'users.create', 'users.update',
                    'trading_points.read', 'trading_points.update',
                    'equipment.read', 'equipment.update',
                    'operations.read', 'operations.create', 'operations.update',
                    'reports.read', 'reports.create', 'reports.export'
                ],
                'manager': [
                    'operations.read', 'operations.create', 'operations.update',
                    'equipment.read', 'equipment.update',
                    'fuel_stocks.read', 'fuel_stocks.update',
                    'reports.read', 'reports.create'
                ],
                'operator': [
                    'operations.read', 'operations.create',
                    'equipment.read',
                    'fuel_stocks.read',
                    'reports.read'
                ],
                'bto_manager': [
                    'networks.read', 'trading_points.read', 'networks.view_bto', 'points.view_bto'
                ]
            };

            return rolePermissions[role] || ['basic.read'];
        }

        async function checkAllAdmins() {
            const resultsDiv = document.getElementById('results');

            try {
                resultsDiv.innerHTML = '<p class="info">üîç –ò—â–µ–º –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤...</p>';

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const users = await supabaseRequest('users');

                const admins = users.filter(user => {
                    const role = user.preferences?.role;
                    return role === 'system_admin' || role === 'super_admin' || role === 'network_admin';
                });

                resultsDiv.innerHTML = `
                    <h3>üõ°Ô∏è –ù–∞–π–¥–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: ${admins.length}</h3>
                    <div>
                        ${admins.map(user => `
                            <div style="border: 1px solid #ccc; margin: 10px 0; padding: 10px; border-radius: 4px;">
                                <strong>${user.email}</strong> (${user.name})<br>
                                <span class="info">–†–æ–ª—å: ${user.preferences?.role || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</span><br>
                                <span class="warning">–°—Ç–∞—Ç—É—Å: ${user.status}</span>
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `<p class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>