<!DOCTYPE html>
<html>
<head>
    <title>Test Profile Section - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test { margin: 15px 0; padding: 20px; border-radius: 10px; }
        .success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
        .error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
        .info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
        .warning { background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; }
        pre { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            margin: 10px 5px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .button:hover { background: #45a049; transform: translateY(-2px); }
        .button.secondary { background: #2196f3; }
        .button.secondary:hover { background: #1976d2; }
        .button.warning { background: #ff9800; }
        .button.warning:hover { background: #f57c00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–æ—Ñ–∏–ª—è –∫–ª–∏–µ–Ω—Ç–∞</h1>
        
        <div class="test info">
            <h3>üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞</h3>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞–∑–¥–µ–ª–æ–º –ø—Ä–æ—Ñ–∏–ª—è –≤ —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å—è—Ö</p>
            <button class="button" onclick="checkProfileSection()">–ü–†–û–í–ï–†–ò–¢–¨ –†–ê–ó–î–ï–õ –ü–†–û–§–ò–õ–Ø</button>
            <button class="button secondary" onclick="testExternalServices()">–¢–ï–°–¢ –í–ù–ï–®–ù–ò–• –°–ï–†–í–ò–°–û–í</button>
            <button class="button warning" onclick="checkUsersTable()">–ü–†–û–í–ï–†–ò–¢–¨ –¢–ê–ë–õ–ò–¶–£ USERS</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const config = {
            url: 'https://ssvazdgnmatbdynkhkqo.supabase.co',
            apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdmF6ZGdubWF0YmR5bmtoa3FvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzM0MzgzNCwiZXhwIjoyMDcyOTE5ODM0fQ.Gen-PI-vDkKjskpIvJNcQw0Uj3d0zGXB98zIxNK6di0'
        };

        function addResult(title, type, data) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        window.checkProfileSection = async function() {
            addResult('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª—è...', 'info', '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞');
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Ñ–∏–ª—è
            try {
                const response = await fetch('http://localhost:3005/profile', {
                    method: 'GET',
                    headers: { 'Accept': 'text/html' }
                });

                if (response.ok) {
                    addResult('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è –¥–æ—Å—Ç—É–ø–Ω–∞', 'success', {
                        url: 'http://localhost:3005/profile',
                        status: response.status,
                        statusText: response.statusText,
                        accessible: true
                    });
                } else {
                    addResult('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'error', {
                        url: 'http://localhost:3005/profile',
                        status: response.status,
                        statusText: response.statusText,
                        error: 'Page not accessible'
                    });
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é', 'error', {
                    error: error.message,
                    note: '–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ dev server –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3005'
                });
            }

            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const externalDB = localStorage.getItem('externalDatabase');
            const currentUser = localStorage.getItem('currentUser');
            
            addResult('üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage', 'info', {
                externalDatabase: externalDB ? JSON.parse(externalDB) : 'NOT FOUND',
                currentUser: currentUser ? JSON.parse(currentUser) : 'NOT FOUND',
                note: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è'
            });
        };

        window.testExternalServices = async function() {
            addResult('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã...', 'info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º externalProfileService –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã');
            
            try {
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–∞–±–ª–∏—Ü–µ users
                const usersResponse = await fetch(`${config.url}/rest/v1/users?limit=3`, {
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (usersResponse.ok) {
                    const usersData = await usersResponse.json();
                    addResult('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–∞–±–ª–∏—Ü–µ users', 'success', {
                        status: 'CONNECTED',
                        users_found: usersData.length,
                        sample_users: usersData,
                        note: 'externalProfileService —Å–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü–µ–π'
                    });

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å admin@system.local
                    const adminResponse = await fetch(`${config.url}/rest/v1/users?email=eq.admin@system.local&limit=1`, {
                        headers: {
                            'apikey': config.apiKey,
                            'Authorization': `Bearer ${config.apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (adminResponse.ok) {
                        const adminData = await adminResponse.json();
                        if (adminData.length > 0) {
                            addResult('‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–π–¥–µ–Ω', 'success', {
                                admin_user: adminData[0],
                                note: 'externalProfileService —Å–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'
                            });
                        } else {
                            addResult('‚ö†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning', {
                                searched_email: 'admin@system.local',
                                note: '–ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                                suggestion: '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è admin@system.local –≤ —Ç–∞–±–ª–∏—Ü—É users'
                            });
                        }
                    }
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ç–∞–±–ª–∏—Ü–µ users', 'error', {
                        status: usersResponse.status,
                        error: await usersResponse.text(),
                        impact: 'externalProfileService –Ω–µ —Å–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å'
                    });
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤', 'error', {
                    error: error.message,
                    impact: '–°–µ—Ä–≤–∏—Å—ã –ø—Ä–æ—Ñ–∏–ª—è –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å'
                });
            }
        };

        window.checkUsersTable = async function() {
            addResult('üóÉÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã users...', 'info', '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã users');
            
            try {
                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–∞–±–ª–∏—Ü—ã
                const response = await fetch(`${config.url}/rest/v1/users?select=*&limit=1`, {
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const sampleRecord = data[0];
                    
                    if (sampleRecord) {
                        const fields = Object.keys(sampleRecord);
                        const requiredFields = ['id', 'email', 'name', 'status', 'created_at'];
                        const missingFields = requiredFields.filter(field => !fields.includes(field));
                        
                        addResult('üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã users', sampleRecord && missingFields.length === 0 ? 'success' : 'warning', {
                            total_fields: fields.length,
                            available_fields: fields,
                            required_fields: requiredFields,
                            missing_fields: missingFields,
                            sample_record: sampleRecord,
                            assessment: missingFields.length === 0 ? '–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç' : '–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'
                        });
                    } else {
                        addResult('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ users –ø—É—Å—Ç–∞', 'warning', {
                            message: '–¢–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö',
                            recommendation: '–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è'
                        });
                    }
                } else if (response.status === 404) {
                    addResult('‚ùå –¢–∞–±–ª–∏—Ü–∞ users –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error', {
                        status: 404,
                        error: 'Table not found',
                        impact: '–†–∞–∑–¥–µ–ª –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ —Å–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ —Ç–∞–±–ª–∏—Ü—ã users',
                        solution: '–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É users –≤ Supabase'
                    });
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ users', 'error', {
                        status: response.status,
                        error: await response.text(),
                        impact: '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π'
                    });
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–±–ª–∏—Ü—ã', 'error', {
                    error: error.message,
                    note: '–í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç–µ–≤—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º'
                });
            }
        };

        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        window.createTestUser = async function() {
            try {
                const testUser = {
                    id: '00000000-0000-0000-0000-000000000001',
                    tenant_id: '00000000-0000-0000-0000-000000000001',
                    email: 'admin@system.local',
                    name: '–°–∏—Å—Ç–µ–º–Ω—ã–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                    first_name: '–°–∏—Å—Ç–µ–º–Ω—ã–π',
                    last_name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                    status: 'active',
                    pwd_salt: 'demo_salt',
                    pwd_hash: 'demo_hash',
                    preferences: {},
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                const response = await fetch(`${config.url}/rest/v1/users`, {
                    method: 'POST',
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(testUser)
                });

                if (response.ok) {
                    const createdUser = await response.json();
                    addResult('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω', 'success', {
                        user: createdUser[0],
                        message: '–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö'
                    });
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error', {
                        status: response.status,
                        error: await response.text()
                    });
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error', error.message);
            }
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
        setTimeout(checkProfileSection, 1000);
    </script>
</body>
</html>