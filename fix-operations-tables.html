<!DOCTYPE html>
<html>
<head>
    <title>Fix Operations Tables</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test { margin: 15px 0; padding: 20px; border-radius: 10px; }
        .success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
        .error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
        .info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
        .warning { background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; }
        pre { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            margin: 10px 5px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .button:hover { background: #45a049; transform: translateY(-2px); }
        .button.secondary { background: #2196f3; }
        .button.secondary:hover { background: #1976d2; }
        .button.danger { background: #f44336; }
        .button.danger:hover { background: #da190b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π</h1>
        
        <div class="test info">
            <h3>üéØ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü operations –∏ trading_points</h3>
            <p>–°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –æ–ø–µ—Ä–∞—Ü–∏–π</p>
            <button class="button" onclick="checkTablesExist()">1Ô∏è‚É£ –ü–†–û–í–ï–†–ò–¢–¨ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –¢–ê–ë–õ–ò–¶–´</button>
            <button class="button" onclick="createOperationsTable()">2Ô∏è‚É£ –°–û–ó–î–ê–¢–¨ –¢–ê–ë–õ–ò–¶–£ OPERATIONS</button>
            <button class="button" onclick="createTradingPointsTable()">3Ô∏è‚É£ –°–û–ó–î–ê–¢–¨ –¢–ê–ë–õ–ò–¶–£ TRADING_POINTS</button>
            <button class="button secondary" onclick="testNewTables()">4Ô∏è‚É£ –¢–ï–°–¢ –ù–û–í–´–• –¢–ê–ë–õ–ò–¶</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const config = {
            url: 'https://ssvazdgnmatbdynkhkqo.supabase.co',
            apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdmF6ZGdubWF0YmR5bmtoa3FvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzM0MzgzNCwiZXhwIjoyMDcyOTE5ODM0fQ.Gen-PI-vDkKjskpIvJNcQw0Uj3d0zGXB98zIxNK6di0'
        };

        function addResult(title, type, data) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = \`test \${type}\`;
            div.innerHTML = \`
                <h3>\${title}</h3>
                <pre>\${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            \`;
            results.appendChild(div);
        }

        async function supabaseRequest(method, endpoint, body = null) {
            const headers = {
                'apikey': config.apiKey,
                'Authorization': \`Bearer \${config.apiKey}\`,
                'Content-Type': 'application/json'
            };

            const options = {
                method,
                headers,
                ...(body && { body: JSON.stringify(body) })
            };

            const response = await fetch(\`\${config.url}/rest/v1\${endpoint}\`, options);
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(\`\${response.status}: \${error}\`);
            }

            const text = await response.text();
            return text ? JSON.parse(text) : null;
        }

        window.checkTablesExist = async function() {
            addResult('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü...', 'info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º operations
                try {
                    await supabaseRequest('GET', '/operations?limit=1');
                    addResult('‚úÖ –¢–∞–±–ª–∏—Ü–∞ operations —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'success', '–¢–∞–±–ª–∏—Ü–∞ operations —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞');
                } catch (error) {
                    addResult('‚ùå –¢–∞–±–ª–∏—Ü–∞ operations –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error', {
                        error: error.message,
                        note: '–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É operations'
                    });
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º trading_points
                try {
                    await supabaseRequest('GET', '/trading_points?limit=1');
                    addResult('‚úÖ –¢–∞–±–ª–∏—Ü–∞ trading_points —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'success', '–¢–∞–±–ª–∏—Ü–∞ trading_points —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞');
                } catch (error) {
                    addResult('‚ùå –¢–∞–±–ª–∏—Ü–∞ trading_points –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error', {
                        error: error.message,
                        note: '–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É trading_points'
                    });
                }
                
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–∞–±–ª–∏—Ü', 'error', error.message);
            }
        };

        window.createOperationsTable = async function() {
            addResult('üîß –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã operations...', 'info', '–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–ø—Ä–∞–≤–∫–∏ –∏ —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è');
            
            const createOperationsSQL = \`
CREATE TABLE IF NOT EXISTS operations (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  operation_type VARCHAR(50) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  start_time TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  end_time TIMESTAMP WITH TIME ZONE,
  duration INTEGER,
  trading_point_id uuid,
  trading_point_name VARCHAR(200),
  device_id VARCHAR(100),
  transaction_id VARCHAR(100),
  fuel_type VARCHAR(50),
  quantity DECIMAL(10,3),
  price DECIMAL(10,2),
  total_cost DECIMAL(12,2),
  payment_method VARCHAR(30),
  details TEXT NOT NULL DEFAULT '',
  progress INTEGER DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),
  operator_name VARCHAR(200),
  customer_id VARCHAR(100),
  vehicle_number VARCHAR(20),
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_operations_operation_type ON operations(operation_type);
CREATE INDEX IF NOT EXISTS idx_operations_status ON operations(status);
CREATE INDEX IF NOT EXISTS idx_operations_start_time ON operations(start_time DESC);
CREATE INDEX IF NOT EXISTS idx_operations_trading_point_id ON operations(trading_point_id);
CREATE INDEX IF NOT EXISTS idx_operations_fuel_type ON operations(fuel_type);
CREATE INDEX IF NOT EXISTS idx_operations_payment_method ON operations(payment_method);

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_operations_updated_at 
    BEFORE UPDATE ON operations 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
            \`.trim();

            try {
                // –í—ã–ø–æ–ª–Ω—è–µ–º SQL —á–µ—Ä–µ–∑ RPC
                const response = await fetch(\`\${config.url}/rest/v1/rpc/exec_sql\`, {
                    method: 'POST',
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': \`Bearer \${config.apiKey}\`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sql_query: createOperationsSQL })
                });

                if (!response.ok) {
                    // –ï—Å–ª–∏ RPC –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ INSERT
                    throw new Error('RPC –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ SQL Editor –≤ Supabase');
                }

                addResult('‚úÖ SQL —Å–∫—Ä–∏–ø—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è', 'success', {
                    message: '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL –≤ Supabase SQL Editor',
                    sql_script: createOperationsSQL,
                    instructions: [
                        '1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard',
                        '2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ SQL Editor',
                        '3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –≤—ã—à–µ',
                        '4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç'
                    ]
                });

            } catch (error) {
                addResult('‚ö†Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –≤—Ä—É—á–Ω—É—é', 'warning', {
                    error: error.message,
                    sql_to_execute: createOperationsSQL,
                    instructions: '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ SQL –≤—ã—à–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor'
                });
            }
        };

        window.createTradingPointsTable = async function() {
            addResult('üîß –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã trading_points...', 'info', '–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ (–ê–ó–°)');
            
            const createTradingPointsSQL = \`
CREATE TABLE IF NOT EXISTS trading_points (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  code VARCHAR(50) UNIQUE,
  address TEXT,
  region VARCHAR(100),
  city VARCHAR(100),
  coordinates JSONB,
  phone VARCHAR(30),
  email VARCHAR(100),
  manager_name VARCHAR(200),
  network_id uuid,
  network_name VARCHAR(200),
  station_type VARCHAR(50) DEFAULT 'fuel_station',
  fuel_types TEXT[] DEFAULT ARRAY['–ê–ò-92', '–ê–ò-95', '–ê–ò-98', '–î–¢'],
  services TEXT[] DEFAULT ARRAY['fuel', 'shop'],
  working_hours JSONB DEFAULT '{"open": "06:00", "close": "23:00", "24h": false}',
  payment_methods TEXT[] DEFAULT ARRAY['cash', 'card', 'fuel_card'],
  equipment_count INTEGER DEFAULT 0,
  tanks_count INTEGER DEFAULT 0,
  daily_volume DECIMAL(12,3),
  monthly_volume DECIMAL(12,3),
  status VARCHAR(20) DEFAULT 'active',
  is_active BOOLEAN DEFAULT true,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_trading_points_name ON trading_points(name);
CREATE INDEX IF NOT EXISTS idx_trading_points_code ON trading_points(code);
CREATE INDEX IF NOT EXISTS idx_trading_points_network_id ON trading_points(network_id);
CREATE INDEX IF NOT EXISTS idx_trading_points_city ON trading_points(city);
CREATE INDEX IF NOT EXISTS idx_trading_points_status ON trading_points(status);
CREATE INDEX IF NOT EXISTS idx_trading_points_is_active ON trading_points(is_active);

CREATE TRIGGER update_trading_points_updated_at 
    BEFORE UPDATE ON trading_points 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
            \`.trim();

            addResult('‚úÖ SQL —Å–∫—Ä–∏–ø—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è', 'success', {
                message: '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL –≤ Supabase SQL Editor',
                sql_script: createTradingPointsSQL,
                instructions: [
                    '1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard',
                    '2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ SQL Editor', 
                    '3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –≤—ã—à–µ',
                    '4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç'
                ]
            });
        };

        window.testNewTables = async function() {
            addResult('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü...', 'info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –¥–æ—Å—Ç—É–ø–Ω—ã');
            
            try {
                // –¢–µ—Å—Ç operations
                const operations = await supabaseRequest('GET', '/operations?limit=3');
                addResult('‚úÖ –¢–∞–±–ª–∏—Ü–∞ operations —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success', {
                    message: '–¢–∞–±–ª–∏—Ü–∞ operations –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è',
                    records_found: operations?.length || 0,
                    sample_data: operations || []
                });
                
                // –¢–µ—Å—Ç trading_points
                const tradingPoints = await supabaseRequest('GET', '/trading_points?limit=3');
                addResult('‚úÖ –¢–∞–±–ª–∏—Ü–∞ trading_points —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success', {
                    message: '–¢–∞–±–ª–∏—Ü–∞ trading_points –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è',
                    records_found: tradingPoints?.length || 0,
                    sample_data: tradingPoints || []
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–µ—Ä–∞—Ü–∏–π
                addResult('üöÄ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'success', {
                    message: '–¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã, –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–µ—Ä–∞—Ü–∏–π',
                    next_steps: [
                        '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É /network/operations-transactions',
                        '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫',
                        '–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π'
                    ]
                });

            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü', 'error', {
                    error: error.message,
                    note: '–í–æ–∑–º–æ–∂–Ω–æ —Ç–∞–±–ª–∏—Ü—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç—ã –≤ Supabase'
                });
            }
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(checkTablesExist, 1000);
    </script>
</body>
</html>