<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 4px; overflow: auto; }
        button { padding: 10px 20px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .danger { background-color: #dc3545; }
        .danger:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è u@me.com –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</h1>

    <div>
        <button onclick="checkCurrentData()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ</button>
        <button onclick="fixUserRole()" class="danger">üõ†Ô∏è –ò–°–ü–†–ê–í–ò–¢–¨ —Ä–æ–ª—å –Ω–∞ –°—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
        <button onclick="testApp()">üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
    </div>

    <div id="result"></div>

    <script>
        const supabaseUrl = 'https://ssvazdgnmatbdynkhkqo.supabase.co';
        const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdmF6ZGdubWF0YmR5bmtoa3FvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzM0MzgzNCwiZXhwIjoyMDcyOTE5ODM0fQ.Gen-PI-vDkKjskpIvJNcQw0Uj3d0zGXB98zIxNK6di0';

        async function checkCurrentData() {
            const resultDiv = document.getElementById('result');

            try {
                console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è u@me.com...');

                const response = await fetch(`${supabaseUrl}/rest/v1/users?email=eq.u@me.com`, {
                    headers: {
                        'apikey': supabaseServiceKey,
                        'Authorization': `Bearer ${supabaseServiceKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                const users = await response.json();

                if (users.length === 0) {
                    resultDiv.innerHTML = '<div class="result error">‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å u@me.com –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</div>';
                    return;
                }

                const user = users[0];

                resultDiv.innerHTML = `
                    <div class="result info">
                        <h3>üìä –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</h3>
                        <p><strong>ID:</strong> ${user.id}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Name:</strong> ${user.name}</p>
                        <p><strong>Status:</strong> ${user.status}</p>
                        <p><strong>Preferences:</strong></p>
                        <pre>${JSON.stringify(user.preferences, null, 2)}</pre>

                        <div class="result warning">
                            <h4>‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê:</h4>
                            <p>–ü–æ–ª–µ <code>preferences</code> ${JSON.stringify(user.preferences) === '{}' ? '–ü–£–°–¢–û–ï' : '–Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–æ–ª—å'}!</p>
                            <p>–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: <code>{"role": "–°—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"}</code></p>
                        </div>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        async function fixUserRole() {
            const resultDiv = document.getElementById('result');

            try {
                console.log('üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è u@me.com...');

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ preferences —Å —Ä–æ–ª—å—é –°—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                const correctPreferences = {
                    role: "–°—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
                    role_id: 1,
                    permissions: ["all"]
                };

                const response = await fetch(`${supabaseUrl}/rest/v1/users?email=eq.u@me.com`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': supabaseServiceKey,
                        'Authorization': `Bearer ${supabaseServiceKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        preferences: correctPreferences
                    })
                });

                if (response.ok) {
                    const updatedUsers = await response.json();
                    const user = updatedUsers[0];

                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h3>‚úÖ –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ò–°–ü–†–ê–í–õ–ï–ù–ê!</h3>
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>–ù–æ–≤—ã–µ preferences:</strong></p>
                            <pre>${JSON.stringify(user.preferences, null, 2)}</pre>

                            <div class="result info">
                                <h4>üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
                                <p>–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:</p>
                                <ul>
                                    <li>–†–æ–ª—å –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–∞–∫ "–°—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"</li>
                                    <li>–°—Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥: "–°—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" ‚Üí "super_admin"</li>
                                    <li>–ë—É–¥—É—Ç –≤–∏–¥–Ω—ã –í–°–ï 10 —Ä–∞–∑–¥–µ–ª–æ–≤ –º–µ–Ω—é</li>
                                </ul>
                                <p><strong>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∏ –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ!</strong></p>
                            </div>
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<div class="result error">‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${JSON.stringify(error)}</div>`;
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        function testApp() {
            window.open('http://localhost:3001', '_blank');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = checkCurrentData;
    </script>
</body>
</html>