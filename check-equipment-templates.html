<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ equipment_templates</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 11px; max-height: 400px; }
        .equipment-card { border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px; background: #f8f9fa; }
        .active { border-left: 4px solid #28a745; }
        .inactive { border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã equipment_templates</h1>
    
    <div class="section info">
        <h3>üí° –°–∏—Ç—É–∞—Ü–∏—è:</h3>
        <p>–í Supabase —É–∂–µ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ <code>equipment_templates</code>. –í–æ–∑–º–æ–∂–Ω–æ, —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —É–∂–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –¥—Ä—É–≥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º.</p>
    </div>
    
    <div class="section">
        <button onclick="checkEquipmentTemplates()">üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å equipment_templates</button>
        <button onclick="checkEquipmentTemplatesStructure()">üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã</button>
        <button onclick="initializeDefaultTypes()">üöÄ –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (typeof data === 'string') {
                    content += `<pre>${data}</pre>`
                } else if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                    let tableContent = '<div>'
                    data.forEach(item => {
                        const cardClass = item.status ? 'equipment-card active' : 'equipment-card inactive'
                        tableContent += `
                        <div class="${cardClass}">
                            <strong>${item.name}</strong> 
                            <code>${item.technical_code}</code><br>
                            <small>${item.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</small><br>
                            <em>–°–∏—Å—Ç–µ–º–∞: ${item.system_type}</em><br>
                            <small>–°–æ–∑–¥–∞–Ω: ${new Date(item.created_at).toLocaleString()}</small>
                            ${item.allow_component_template_ids ? `<br><small>–®–∞–±–ª–æ–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: ${item.allow_component_template_ids.length}</small>` : ''}
                        </div>`
                    })
                    tableContent += '</div>'
                    content += tableContent
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
        }

        window.checkEquipmentTemplates = async function() {
            logResult('üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É equipment_templates...', 'info')
            
            try {
                const { data, error } = await supabase
                    .from('equipment_templates')
                    .select('*')
                    .order('name')
                
                if (error) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ equipment_templates', 'error', error)
                    return
                }
                
                logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data?.length || 0} —à–∞–±–ª–æ–Ω–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è`, 'success')
                
                if (data && data.length > 0) {
                    logResult('üìä –®–∞–±–ª–æ–Ω—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', 'info', data)
                    
                    // –ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–æ–≤
                    const systemTypes = [...new Set(data.map(item => item.system_type))]
                    logResult(`üîç –ù–∞–π–¥–µ–Ω—ã —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–∏–ø—ã: ${systemTypes.join(', ')}`, 'info')
                }
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏', 'error', error)
            }
        }

        window.checkEquipmentTemplatesStructure = async function() {
            logResult('üìã –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É equipment_templates...', 'info')
            
            try {
                const { data, error } = await supabase
                    .from('equipment_templates')
                    .select('*')
                    .limit(1)
                
                if (error) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã', 'error', error)
                    return
                }
                
                if (data && data.length > 0) {
                    const sample = data[0]
                    const structure = {}
                    
                    Object.keys(sample).forEach(key => {
                        const value = sample[key]
                        structure[key] = {
                            type: typeof value,
                            example: value,
                            isNull: value === null
                        }
                    })
                    
                    logResult('üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã equipment_templates:', 'info', structure)
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –Ω–∞—à–∏–º–∏ —Ç–∏–ø–∞–º–∏
                    const requiredFields = ['name', 'technical_code', 'system_type', 'status', 'description']
                    const availableFields = Object.keys(sample)
                    
                    const compatibility = requiredFields.map(field => ({
                        field,
                        available: availableFields.includes(field),
                        mapping: field === 'technical_code' ? 'code' : field
                    }))
                    
                    logResult('üîç –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ–ª–µ–π:', 'info', compatibility)
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã', 'error', error)
            }
        }

        window.initializeDefaultTypes = async function() {
            logResult('üöÄ –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...', 'info')
            
            const defaultTypes = [
                {
                    name: "–†–µ–∑–µ—Ä–≤—É–∞—Ä",
                    technical_code: "EQP_RESERVOIR",
                    system_type: "fuel_tank",
                    status: true,
                    description: "–¢–æ–ø–ª–∏–≤–Ω—ã–π —Ä–µ–∑–µ—Ä–≤—É–∞—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–¥—É–∫—Ç–æ–≤",
                    default_params: {
                        capacity: 0,
                        fuel_type: "",
                        level_sensor: true
                    },
                    allow_component_template_ids: []
                },
                {
                    name: "–¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
                    technical_code: "EQP_TSO",
                    system_type: "self_service_terminal",
                    status: true,
                    description: "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –Ω–∞ –ê–ó–°",
                    default_params: {
                        payment_methods: ["card", "cash", "mobile"],
                        max_fuel_amount: 100,
                        receipt_printer: true
                    },
                    allow_component_template_ids: []
                },
                {
                    name: "–î–∞—Ç—á–∏–∫ —É—Ä–æ–≤–Ω—è —Ç–æ–ø–ª–∏–≤–∞",
                    technical_code: "EQP_FUEL_SENSOR",
                    system_type: "sensor",
                    status: true,
                    description: "–î–∞—Ç—á–∏–∫ –∫–æ–Ω—Ç—Ä–æ–ª—è —É—Ä–æ–≤–Ω—è —Ç–æ–ø–ª–∏–≤–∞ –≤ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–µ",
                    default_params: {
                        sensor_type: "ultrasonic",
                        measurement_range: "0-5000",
                        accuracy: "¬±1mm"
                    },
                    allow_component_template_ids: []
                },
                {
                    name: "–ö–∞—Å—Å–æ–≤—ã–π –∞–ø–ø–∞—Ä–∞—Ç",
                    technical_code: "EQP_CASH_REGISTER",
                    system_type: "cash_register",
                    status: true,
                    description: "–ö–∞—Å—Å–æ–≤—ã–π –∞–ø–ø–∞—Ä–∞—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂",
                    default_params: {
                        fiscal_mode: true,
                        receipt_printer: true,
                        barcode_scanner: true
                    },
                    allow_component_template_ids: []
                },
                {
                    name: "–°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è",
                    technical_code: "EQP_SURVEILLANCE",
                    system_type: "security_camera",
                    status: true,
                    description: "–°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏",
                    default_params: {
                        camera_count: 4,
                        recording_quality: "1080p",
                        storage_days: 30
                    },
                    allow_component_template_ids: []
                }
            ]
            
            try {
                let insertedCount = 0
                const errors = []
                
                for (const equipmentType of defaultTypes) {
                    try {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ç–∏–ø
                        const { data: existing } = await supabase
                            .from('equipment_templates')
                            .select('id')
                            .eq('technical_code', equipmentType.technical_code)
                            .single()
                        
                        if (existing) {
                            logResult(`‚ö†Ô∏è –¢–∏–ø ${equipmentType.name} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`, 'warning')
                            continue
                        }
                        
                        // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–∏–ø
                        const { error } = await supabase
                            .from('equipment_templates')
                            .insert([equipmentType])
                        
                        if (error) {
                            errors.push(`${equipmentType.name}: ${error.message}`)
                        } else {
                            logResult(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ç–∏–ø: ${equipmentType.name}`, 'success')
                            insertedCount++
                        }
                        
                    } catch (itemError) {
                        errors.push(`${equipmentType.name}: ${itemError.message}`)
                    }
                }
                
                logResult(`üéâ –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: ${insertedCount}`, 'success')
                
                if (errors.length > 0) {
                    logResult(`‚ö†Ô∏è –û—à–∏–±–∫–∏ (${errors.length}):`, 'warning', errors)
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                await checkEquipmentTemplates()
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤', 'error', error)
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 500))
            await checkEquipmentTemplates()
        })
    </script>
</body>
</html>