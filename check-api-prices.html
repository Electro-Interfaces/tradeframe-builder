<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ API —Ü–µ–Ω</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1e1e1e; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .success { color: #4ade80; background: #166534; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { color: #f87171; background: #991b1b; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { color: #60a5fa; background: #1e3a8a; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .warning { color: #fbbf24; background: #713f12; padding: 10px; border-radius: 5px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; background: #3b82f6; color: white; border: none; cursor: pointer; border-radius: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #2d2d2d; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .fuel-card { background: #2d2d2d; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ¢Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ API —Ü–µ–Ω —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Ç–∏</h1>
        
        <div class="info">
            <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:</h3>
            <p>System: 15, Station: 4 (–ê–ó–° ‚Ññ4)</p>
        </div>

        <button onclick="checkPricesAPI()">üí∞ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å endpoint /v1/prices</button>
        <button onclick="checkFuelPricesAPI()">‚õΩ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å endpoint /v1/fuel-prices</button>
        <button onclick="checkTanksAPI()">üõ¢Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã /v1/tanks</button>
        <button onclick="getTokenStatus()">üîê –°—Ç–∞—Ç—É—Å —Ç–æ–∫–µ–Ω–∞</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ localStorage –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é
        function getConfig() {
            try {
                const stored = localStorage.getItem('tradingNetworkConfig');
                if (stored) {
                    const config = JSON.parse(stored);
                    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ localStorage:', config);
                    return config;
                }
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ localStorage:', e);
            }
            
            // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
            return {
                baseUrl: 'https://pos.autooplata.ru/tms',
                username: 'UserApi',
                password: 'lHQfLZHzB3tn',
                authType: 'basic'
            };
        }
        
        async function getAuthToken() {
            const config = getConfig();
            
            if (config.authType === 'basic' && config.username && config.password) {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ Basic Auth
                const authResponse = await fetch(`${config.baseUrl}/v1/auth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: config.username,
                        password: config.password
                    })
                });
                
                if (authResponse.ok) {
                    const authData = await authResponse.json();
                    console.log('–ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ Basic Auth');
                    return authData.token || authData.access_token;
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π
            return config.apiKey || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2dpbiI6eyJpZCI6IjYxODkwODMxLUQxNEYtNDY0MC05OUFDLUUxMTIzQTZFNDQzOCIsIm5hbWUiOiJVc2VyQXBpIiwicm9sZSI6MH0sInVzZXIiOnsiaWQiOiI2MTg5MDgzMS1EMTRGLTQ2NDAtOTlBQy1FMTEyM0E2RTQ0MzgiLCJuYW1lIjoiVXNlckFwaSJ9LCJleHAiOjE3NTczMTc5NTR9.fXqRyv-d7cotjD_YcDwSMB5Y9SXVCQB2LN1LXbCzsB8';
        }
        
        async function makeAPIRequest(endpoint, params = {}) {
            const config = getConfig();
            const token = await getAuthToken();
            
            const url = new URL(`${config.baseUrl}${endpoint}`);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            console.log('–ó–∞–ø—Ä–æ—Å –∫:', url.toString());
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });
            
            const responseText = await response.text();
            let data;
            
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                data = responseText;
            }
            
            return {
                status: response.status,
                ok: response.ok,
                data: data,
                headers: Object.fromEntries(response.headers.entries())
            };
        }
        
        window.checkPricesAPI = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ /v1/prices...</div>';
            
            try {
                const response = await makeAPIRequest('/v1/prices', {
                    system: '15',
                    station: '4'
                });
                
                if (response.ok) {
                    results.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Endpoint /v1/prices —Ä–∞–±–æ—Ç–∞–µ—Ç</h3>
                            <p>–°—Ç–∞—Ç—É—Å: ${response.status}</p>
                        </div>
                        <div class="info">
                            <h3>–û—Ç–≤–µ—Ç API:</h3>
                            <pre>${JSON.stringify(response.data, null, 2)}</pre>
                        </div>
                    `;
                    
                    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
                    analyzeData(response.data);
                } else {
                    results.innerHTML = `
                        <div class="error">
                            <h3>‚ùå –û—à–∏–±–∫–∞ API</h3>
                            <p>–°—Ç–∞—Ç—É—Å: ${response.status}</p>
                            <pre>${JSON.stringify(response.data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}</div>`;
            }
        };
        
        window.checkFuelPricesAPI = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ /v1/fuel-prices...</div>';
            
            try {
                const response = await makeAPIRequest('/v1/fuel-prices', {
                    system: '15',
                    station: '4'
                });
                
                if (response.ok) {
                    results.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Endpoint /v1/fuel-prices —Ä–∞–±–æ—Ç–∞–µ—Ç</h3>
                            <p>–°—Ç–∞—Ç—É—Å: ${response.status}</p>
                        </div>
                        <div class="info">
                            <h3>–û—Ç–≤–µ—Ç API:</h3>
                            <pre>${JSON.stringify(response.data, null, 2)}</pre>
                        </div>
                    `;
                    
                    analyzeData(response.data);
                } else {
                    results.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Endpoint –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞</h3>
                            <p>–°—Ç–∞—Ç—É—Å: ${response.status}</p>
                            <pre>${JSON.stringify(response.data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}</div>`;
            }
        };
        
        window.checkTanksAPI = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã —á–µ—Ä–µ–∑ /v1/tanks...</div>';
            
            try {
                const response = await makeAPIRequest('/v1/tanks', {
                    system: '15',
                    station: '4'
                });
                
                if (response.ok && response.data) {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞ –∏–∑ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤
                    const fuelTypes = new Set();
                    
                    if (Array.isArray(response.data)) {
                        response.data.forEach(tank => {
                            if (tank.fuel_name) {
                                fuelTypes.add(tank.fuel_name);
                            }
                        });
                    }
                    
                    results.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Endpoint /v1/tanks —Ä–∞–±–æ—Ç–∞–µ—Ç</h3>
                            <p>–ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${response.data.length}</p>
                            <p>–í–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞: ${Array.from(fuelTypes).join(', ')}</p>
                        </div>
                        <div class="info">
                            <h3>–î–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤:</h3>
                            <pre>${JSON.stringify(response.data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <div class="error">
                            <h3>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤</h3>
                            <p>–°—Ç–∞—Ç—É—Å: ${response.status}</p>
                        </div>
                    `;
                }
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}</div>`;
            }
        };
        
        window.getTokenStatus = async function() {
            const config = getConfig();
            const token = await getAuthToken();
            
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω
            try {
                const parts = token.split('.');
                const payload = JSON.parse(atob(parts[1]));
                const exp = new Date(payload.exp * 1000);
                const now = new Date();
                const isExpired = exp < now;
                
                document.getElementById('results').innerHTML = `
                    <div class="${isExpired ? 'error' : 'success'}">
                        <h3>üîê –°—Ç–∞—Ç—É—Å —Ç–æ–∫–µ–Ω–∞</h3>
                        <p>–¢–æ–∫–µ–Ω ${isExpired ? '‚ùå –∏—Å—Ç–µ–∫' : '‚úÖ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω'}</p>
                        <p>–ò—Å—Ç–µ–∫–∞–µ—Ç: ${exp.toLocaleString()}</p>
                        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${payload.user?.name || 'Unknown'}</p>
                    </div>
                `;
            } catch (e) {
                document.getElementById('results').innerHTML = `
                    <div class="warning">
                        <h3>‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω</h3>
                    </div>
                `;
            }
        };
        
        function analyzeData(data) {
            const resultsDiv = document.getElementById('results');
            let analysis = '<div class="warning"><h3>üìä –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö:</h3>';
            
            if (Array.isArray(data)) {
                analysis += `<p>–¢–∏–ø: –ú–∞—Å—Å–∏–≤ (${data.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)</p>`;
                if (data.length > 0) {
                    analysis += '<p>–ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç:</p>';
                    analysis += `<pre>${JSON.stringify(data[0], null, 2)}</pre>`;
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞
                    const fuelTypes = data.map(item => 
                        item.fuel_name || item.fuel_type || item.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                    );
                    analysis += `<p>–í–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞: ${fuelTypes.join(', ')}</p>`;
                }
            } else if (typeof data === 'object' && data !== null) {
                analysis += '<p>–¢–∏–ø: –û–±—ä–µ–∫—Ç</p>';
                analysis += `<p>–ö–ª—é—á–∏: ${Object.keys(data).join(', ')}</p>`;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                if (data.fuels) {
                    analysis += '<p>–ù–∞–π–¥–µ–Ω –º–∞—Å—Å–∏–≤ fuels</p>';
                    analysis += `<pre>${JSON.stringify(data.fuels, null, 2)}</pre>`;
                } else if (data.prices) {
                    analysis += '<p>–ù–∞–π–¥–µ–Ω –º–∞—Å—Å–∏–≤ prices</p>';
                    analysis += `<pre>${JSON.stringify(data.prices, null, 2)}</pre>`;
                } else if (data.data) {
                    analysis += '<p>–ù–∞–π–¥–µ–Ω –≤–ª–æ–∂–µ–Ω–Ω—ã–π data</p>';
                    analysis += `<pre>${JSON.stringify(data.data, null, 2)}</pre>`;
                }
            }
            
            analysis += '</div>';
            resultsDiv.innerHTML += analysis;
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            checkPricesAPI();
        });
    </script>
</body>
</html>