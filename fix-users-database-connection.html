<!DOCTYPE html>
<html>
<head>
    <title>Fix Users Database Connection</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test { margin: 15px 0; padding: 20px; border-radius: 10px; }
        .success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
        .error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
        .info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
        .warning { background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; }
        pre { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            margin: 10px 5px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .button:hover { background: #45a049; transform: translateY(-2px); }
        .button.secondary { background: #2196f3; }
        .button.secondary:hover { background: #1976d2; }
        .button.danger { background: #f44336; }
        .button.danger:hover { background: #da190b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"</h1>
        
        <div class="test info">
            <h3>üéØ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã</h3>
            <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"</p>
            <button class="button" onclick="diagnoseConnection()">1Ô∏è‚É£ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê</button>
            <button class="button" onclick="fixConnection()">2Ô∏è‚É£ –ò–°–ü–†–ê–í–ò–¢–¨ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï</button>
            <button class="button secondary" onclick="testUsersPage()">3Ô∏è‚É£ –¢–ï–°–¢ –°–¢–†–ê–ù–ò–¶–´</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const config = {
            url: 'https://ssvazdgnmatbdynkhkqo.supabase.co',
            apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdmF6ZGdubWF0YmR5bmtoa3FvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzM0MzgzNCwiZXhwIjoyMDcyOTE5ODM0fQ.Gen-PI-vDkKjskpIvJNcQw0Uj3d0zGXB98zIxNK6di0'
        };

        function addResult(title, type, data) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        window.diagnoseConnection = async function() {
            addResult('üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î...', 'info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase');
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const externalDatabase = localStorage.getItem('externalDatabase');
            const supabaseSettings = localStorage.getItem('supabaseSettings');
            const dataSourceConfig = localStorage.getItem('dataSourceConfig');

            const localStorageStatus = {
                externalDatabase: externalDatabase ? 'EXISTS' : 'MISSING',
                supabaseSettings: supabaseSettings ? 'EXISTS' : 'MISSING',
                dataSourceConfig: dataSourceConfig ? 'EXISTS' : 'MISSING'
            };

            if (externalDatabase) {
                try {
                    const parsed = JSON.parse(externalDatabase);
                    localStorageStatus.externalDatabase_details = {
                        hasUrl: !!parsed.url,
                        hasApiKey: !!parsed.apiKey,
                        url: parsed.url,
                        apiKey_length: parsed.apiKey ? parsed.apiKey.length : 0
                    };
                } catch (e) {
                    localStorageStatus.externalDatabase_error = 'Invalid JSON';
                }
            }

            if (supabaseSettings) {
                try {
                    const parsed = JSON.parse(supabaseSettings);
                    localStorageStatus.supabaseSettings_details = {
                        hasUrl: !!parsed.url,
                        hasApiKey: !!parsed.apiKey,
                        url: parsed.url
                    };
                } catch (e) {
                    localStorageStatus.supabaseSettings_error = 'Invalid JSON';
                }
            }

            addResult('üìä LocalStorage Status', 'info', localStorageStatus);

            // 2. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–∞–±–ª–∏—Ü–µ users
            try {
                const response = await fetch(`${config.url}/rest/v1/users?limit=3`, {
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const users = await response.json();
                    addResult('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–∞–±–ª–∏—Ü–µ users —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success', {
                        status: 'CONNECTED',
                        users_count: users.length,
                        sample_users: users.map(u => ({ id: u.id, email: u.email, name: u.name })),
                        database_accessible: true
                    });
                } else {
                    addResult('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ç–∞–±–ª–∏—Ü–µ users', 'error', {
                        status: response.status,
                        statusText: response.statusText,
                        error: await response.text()
                    });
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î', 'error', {
                    error: error.message,
                    note: '–í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π'
                });
            }
        };

        window.fixConnection = async function() {
            addResult('üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'info', '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage');
            
            // 1. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º externalDatabase (–æ—Å–Ω–æ–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
            const externalDbConfig = {
                url: config.url,
                apiKey: config.apiKey,
                status: 'connected',
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('externalDatabase', JSON.stringify(externalDbConfig));
            
            // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º supabaseSettings (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
            const supabaseConfig = {
                url: config.url,
                apiKey: config.apiKey,  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º apiKey –≤–º–µ—Å—Ç–æ key
                status: 'connected',
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('supabaseSettings', JSON.stringify(supabaseConfig));
            
            // 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º dataSourceConfig (–¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤)
            const dataSourceConfig = {
                useDatabase: true,
                databaseConnected: true,
                supabaseUrl: config.url,
                apiKey: config.apiKey,
                lastCheck: new Date().toISOString(),
                status: 'connected'
            };
            localStorage.setItem('dataSourceConfig', JSON.stringify(dataSourceConfig));

            // 4. –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
            window.dispatchEvent(new Event('storage'));
            window.dispatchEvent(new CustomEvent('localStorageChanged'));

            addResult('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã', 'success', {
                message: '–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã',
                configs_set: {
                    externalDatabase: 'CONFIGURED',
                    supabaseSettings: 'CONFIGURED',
                    dataSourceConfig: 'CONFIGURED'
                },
                database_url: config.url,
                next_step: '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'
            });
        };

        window.testUsersPage = async function() {
            addResult('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...', 'info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ —Ä–∞–±–æ—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const usersResponse = await fetch('http://localhost:3005/admin/users-and-roles', {
                    method: 'GET',
                    headers: { 'Accept': 'text/html' }
                });

                if (usersResponse.ok) {
                    addResult('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–æ—Å—Ç—É–ø–Ω–∞', 'success', {
                        url: 'http://localhost:3005/admin/users-and-roles',
                        status: usersResponse.status,
                        accessible: true
                    });
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                    window.open('http://localhost:3005/admin/users-and-roles', '_blank');
                    
                } else {
                    // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π URL
                    const usersResponse2 = await fetch('http://localhost:3005/admin/users', {
                        method: 'GET',
                        headers: { 'Accept': 'text/html' }
                    });

                    if (usersResponse2.ok) {
                        addResult('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞–π–¥–µ–Ω–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π URL)', 'success', {
                            url: 'http://localhost:3005/admin/users',
                            status: usersResponse2.status
                        });
                        window.open('http://localhost:3005/admin/users', '_blank');
                    } else {
                        addResult('‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error', {
                            tried_urls: [
                                'http://localhost:3005/admin/users-and-roles',
                                'http://localhost:3005/admin/users'
                            ],
                            note: '–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ dev server –∑–∞–ø—É—â–µ–Ω'
                        });
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ localStorage
                const finalCheck = {
                    externalDatabase: localStorage.getItem('externalDatabase') ? 'SET' : 'MISSING',
                    supabaseSettings: localStorage.getItem('supabaseSettings') ? 'SET' : 'MISSING',
                    dataSourceConfig: localStorage.getItem('dataSourceConfig') ? 'SET' : 'MISSING'
                };

                const allConfigured = Object.values(finalCheck).every(v => v === 'SET');

                addResult('üìã –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', allConfigured ? 'success' : 'warning', {
                    configuration_status: finalCheck,
                    all_configured: allConfigured,
                    indicator_should_show: allConfigured ? 'GREEN (–ø–æ–¥–∫–ª—é—á–µ–Ω–æ)' : 'RED (–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ)',
                    message: allConfigured ? '–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –º–µ—Å—Ç–µ' : '–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'
                });
                
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'error', {
                    error: error.message,
                    note: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 3005'
                });
            }
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(diagnoseConnection, 1000);
    </script>
</body>
</html>