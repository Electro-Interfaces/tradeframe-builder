<!DOCTYPE html>
<html>
<head>
    <title>Debug page_help Table Access</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #fde8e8; border-color: #f44336; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; font-size: 12px; max-height: 400px; }
        .button { 
            background: #2196f3; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer;
        }
        .button:hover { background: #1976d2; }
    </style>
</head>
<body>
    <h1>üîç Debug page_help Table Access</h1>
    
    <div class="test info">
        <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <p>–¢–∞–±–ª–∏—Ü–∞ page_help —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç 3 –∑–∞–ø–∏—Å–∏.</p>
        <p>–ü—Ä–æ–±–ª–µ–º–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.</p>
        <p><strong>–ü—Ä–æ–≤–µ—Ä–∏–º:</strong> –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º, —Ñ–∏–ª—å—Ç—Ä—ã, –∫—ç—à —Å—Ö–µ–º—ã</p>
    </div>
    
    <div class="test">
        <h3>üß™ –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
        <button class="button" onclick="testBasicAccess()">1. Basic Table Access</button>
        <button class="button" onclick="testWithFilters()">2. Test with Active Filters</button>
        <button class="button" onclick="testServiceLogic()">3. Test Service Logic</button>
        <button class="button" onclick="refreshSchema()">4. Refresh Schema Cache</button>
    </div>

    <div id="results"></div>

    <script type="module">
        const results = document.getElementById('results');
        
        function addResult(title, type, data) {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        window.testBasicAccess = async function() {
            try {
                const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
                
                const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
                const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

                const supabase = createClient(supabaseUrl, serviceRoleKey);

                // Basic select all
                const { data, error, count } = await supabase
                    .from('page_help')
                    .select('*', { count: 'exact' });

                if (error) {
                    addResult('‚ùå Basic Access Failed', 'error', {
                        error: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                } else {
                    addResult('‚úÖ Basic Access Success', 'success', {
                        total_records: count,
                        records: data,
                        first_record_structure: data[0] ? Object.keys(data[0]) : 'No records'
                    });
                }
            } catch (error) {
                addResult('‚ùå Connection Error', 'error', error.message);
            }
        };

        window.testWithFilters = async function() {
            try {
                const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
                
                const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
                const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

                const supabase = createClient(supabaseUrl, serviceRoleKey);

                // Test the exact query from InstructionsService
                const { data, error } = await supabase
                    .from('page_help')
                    .select('*')
                    .is('deleted_at', null)
                    .eq('is_active', true)
                    .order('route');

                if (error) {
                    addResult('‚ùå Filtered Query Failed', 'error', error);
                } else {
                    addResult('‚úÖ Filtered Query Success', 'success', {
                        filtered_records: data.length,
                        records: data,
                        note: 'This is the exact query from InstructionsService.getTopics()'
                    });
                    
                    // Test grouping logic
                    const topicsMap = new Map();
                    data.forEach(record => {
                        const existing = topicsMap.get(record.route);
                        if (!existing || record.version > existing.version) {
                            topicsMap.set(record.route, record);
                        }
                    });
                    
                    const topics = Array.from(topicsMap.values());
                    
                    addResult('üìä Grouping Logic Result', 'info', {
                        unique_routes: topics.length,
                        grouped_topics: topics.map(t => ({
                            route: t.route,
                            title: t.title,
                            version: t.version,
                            is_active: t.is_active
                        }))
                    });
                }
            } catch (error) {
                addResult('‚ùå Filtered Query Error', 'error', error.message);
            }
        };

        window.testServiceLogic = function() {
            const code = \`
// –û—Ç–∫—Ä–æ–π—Ç–µ DevTools Console (F12) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

// 1. –¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ —Å–µ—Ä–≤–∏—Å–∞
try {
  const module = await import('/src/services/instructionsServiceDatabase.ts');
  console.log('‚úÖ Service imported:', module.InstructionsService);
  
  // 2. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º
  const topics = await module.InstructionsService.getTopics();
  console.log('üìã Topics result:', topics);
  
  // 3. –¢–µ—Å—Ç getAllTopics (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤)
  const allTopics = await module.InstructionsService.getAllTopics();
  console.log('üìã All topics result:', allTopics);
  
} catch (error) {
  console.error('‚ùå Service test failed:', error);
}
\`;

            addResult('üõ†Ô∏è Service Test Code', 'info', code);
        };

        window.refreshSchema = async function() {
            try {
                // Try to refresh schema cache by making a request with cache reset headers
                const response = await fetch('https://tohtryzyffcebtyvkxwh.supabase.co/rest/v1/?select=*', {
                    method: 'GET',
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY',
                        'Prefer': 'return=minimal',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                addResult('üîÑ Schema Refresh Attempt', 'info', {
                    status: response.status,
                    statusText: response.statusText,
                    message: 'Try running the Basic Access test again'
                });
                
            } catch (error) {
                addResult('‚ùå Schema Refresh Error', 'error', error.message);
            }
        };

        // Auto-run basic test
        setTimeout(testBasicAccess, 1000);
    </script>
</body>
</html>