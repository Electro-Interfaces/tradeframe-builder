# üîí Security Guide

## –ü–æ–ª–∏—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ TradeFrame Builder v1.5.16

### üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

#### –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: Supabase PostgreSQL
- **–¢–∞–±–ª–∏—Ü—ã**: `users`, `roles`, `user_roles` (**–†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ**, –Ω–µ –¥–µ–º–æ)
- **–°—Ö–µ–º–∞ —Ä–æ–ª–µ–π**: –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç—É–ø–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
- **–í–∞–∂–Ω–æ**: –¢–æ—Ä–≥–æ–≤—ã–µ —Å–µ—Ç–∏, —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ —Ä–æ–ª–∏ –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç mock –¥–∞–Ω–Ω—ã–µ

#### –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
```typescript
// –ê–ª–≥–æ—Ä–∏—Ç–º: SHA-256 + —Å–æ–ª—å
const passwordHash = SHA-256(password + salt)
```

- **–°–æ–ª—å**: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **Fallback**: Base64 –µ—Å–ª–∏ SHA-256 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: `pwd_hash` –∏ `pwd_salt` –≤ —Ç–∞–±–ª–∏—Ü–µ `users`

### üé´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏

#### –§–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–æ–≤
```typescript
const token = `token_${btoa(JSON.stringify(payload))}_${timestamp}`
```

#### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª
1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è**: –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
2. **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è**: 1 —á–∞—Å
3. **–•—Ä–∞–Ω–µ–Ω–∏–µ**: localStorage/sessionStorage
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ
5. **–£–¥–∞–ª–µ–Ω–∏–µ**: –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

#### Payload —Ç–æ–∫–µ–Ω–∞
```json
{
  "userId": "user-uuid",
  "email": "user@example.com",
  "role": "network_admin",
  "exp": 1234567890
}
```

### üåê API –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API (Supabase)
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: Service Role Key
- **HTTPS**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
- **Row Level Security**: –ù–∞—Å—Ç—Ä–æ–µ–Ω –≤ Supabase
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: –ü–æ —Ä–æ–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### –í–Ω–µ—à–Ω–∏–π API (STS)
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: HTTP Basic Auth
- **–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –í –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- **Timeout**: 10 —Å–µ–∫—É–Ω–¥
- **Retry**: –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫

### üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# Supabase (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–¥–µ)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_KEY=your-service-key

# –í–Ω–µ—à–Ω–∏–π API STS
VITE_STS_API_URL=https://pos.autooplata.ru/tms/
VITE_STS_API_USERNAME=your-username
VITE_STS_API_PASSWORD=your-password
```

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- **‚ùå –ù–ï –∫–æ–º–∏—Ç–∏—Ç—å** —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ Git
- **‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** `.env.local` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å** –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- **‚úÖ –†–æ—Ç–∞—Ü–∏—è** –ø–∞—Ä–æ–ª–µ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫

#### CSRF Protection
- **Idempotency-Key**: –î–ª—è –º—É—Ç–∏—Ä—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **SameSite cookies**: –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- **Origin validation**: –í –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

#### XSS Protection
- **Sanitization**: –í—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **Content Security Policy**: –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å
- **HTTPOnly cookies**: –î–ª—è —Å–µ—Å—Å–∏–π

#### Rate Limiting
- **Retry logic**: –° —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **Connection timeout**: 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API
- **Max attempts**: 3 –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

### üìä –ê—É–¥–∏—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –õ–æ–≥–∏—Ä—É–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è
- ‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- ‚ùå –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞
- üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- üåê API –∑–∞–ø—Ä–æ—Å—ã (–≤ dev —Ä–µ–∂–∏–º–µ)
- ‚ö†Ô∏è –û—à–∏–±–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```typescript
console.log('üîç Search:', searchQuery);    // –ü–æ–∏—Å–∫
console.log('‚úÖ Success:', result);         // –£—Å–ø–µ—Ö
console.error('‚ùå Error:', error);          // –û—à–∏–±–∫–∞
console.log('üîÑ Refresh:', tokenInfo);     // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
```

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### –ü—Ä–∏–Ω—Ü–∏–ø—ã
1. **Defense in Depth**: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞
2. **Least Privilege**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
3. **Zero Trust**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
4. **Fail Secure**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
```
Frontend (React) ‚Üí httpClients.ts ‚Üí API Services
                ‚Üì
            localStorage/sessionStorage (—Ç–æ–∫–µ–Ω—ã)
                ‚Üì
            Supabase (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
                ‚Üì
            External APIs (–¥–∞–Ω–Ω—ã–µ)
```

### üö® –†–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã

#### –ü—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
1. –û—á–∏—Å—Ç–∏—Ç—å localStorage/sessionStorage
2. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π re-login –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. –†–æ—Ç–∞—Ü–∏—è API –∫–ª—é—á–µ–π
4. –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –¥–æ—Å—Ç—É–ø–∞

#### –ü—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ API –∫–ª—é—á–µ–π
1. –û–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–ª—é—á–∏ –≤ Supabase
3. –£–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏

### ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### Development
- [ ] –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ `.env.local`
- [ ] HTTPS –¥–ª—è –≤—Å–µ—Ö API
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

#### Production
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã
- [ ] Row Level Security –∞–∫—Ç–∏–≤–µ–Ω
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î
- [ ] –ü–ª–∞–Ω —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã

### üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
```javascript
// –í dev –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
const token = localStorage.getItem('auth_token');
const payload = JSON.parse(atob(token.split('_')[1]));
console.log('Token payload:', payload);
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö API –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
window.apiConfigService.testAllConnections();
```

#### –ê—É–¥–∏—Ç —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```javascript
// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
const user = JSON.parse(localStorage.getItem('auth_user'));
console.log('User roles:', user);
```