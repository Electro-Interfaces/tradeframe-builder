<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –≤ –ë–î</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1e1e1e; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .success { color: #4ade80; background: #166534; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { color: #f87171; background: #991b1b; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { color: #60a5fa; background: #1e3a8a; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .warning { color: #fbbf24; background: #713f12; padding: 10px; border-radius: 5px; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #444; padding: 10px; text-align: left; }
        th { background: #2d2d2d; }
        tr:hover { background: #2a2a2a; }
        button { padding: 10px 20px; margin: 5px; background: #3b82f6; color: white; border: none; cursor: pointer; border-radius: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #2d2d2d; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .tank-card { background: #2d2d2d; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ¢Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</h1>
        
        <div class="info">
            <h3>–¢–µ—Å—Ç–æ–≤–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞: –ê–ó–° ‚Ññ4</h3>
            <p>ID: 6969b08d-1cbe-45c2-ae9c-8002c7022b59</p>
        </div>

        <button onclick="checkEquipmentTable()">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É equipment</button>
        <button onclick="checkTanksForTradingPoint()">üõ¢Ô∏è –ù–∞–π—Ç–∏ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã –ê–ó–° ‚Ññ4</button>
        <button onclick="checkAllTanks()">üîç –ü–æ–∫–∞–∑–∞—Ç—å –í–°–ï —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã</button>
        <button onclick="checkFuelTypes()">‚õΩ –ê–Ω–∞–ª–∏–∑ –≤–∏–¥–æ–≤ —Ç–æ–ø–ª–∏–≤–∞</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π SERVICE ROLE –∫–ª—é—á
        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';
        
        const tradingPointId = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
        
        async function makeRequest(endpoint, params = {}) {
            const url = new URL(`${SUPABASE_URL}/rest/v1/${endpoint}`);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            const response = await fetch(url, {
                headers: {
                    'apikey': SUPABASE_SERVICE_KEY,
                    'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                }
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(`HTTP ${response.status}: ${error}`);
            }
            
            return response.json();
        }
        
        window.checkEquipmentTable = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã equipment...</div>';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                const data = await makeRequest('equipment', {
                    'select': '*',
                    'limit': '1'
                });
                
                if (data.length > 0) {
                    const fields = Object.keys(data[0]);
                    results.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ –¢–∞–±–ª–∏—Ü–∞ equipment –¥–æ—Å—Ç—É–ø–Ω–∞</h3>
                            <p>–ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ã:</p>
                            <pre>${fields.join('\n')}</pre>
                        </div>
                        <div class="info">
                            <h3>–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏:</h3>
                            <pre>${JSON.stringify(data[0], null, 2)}</pre>
                        </div>
                    `;
                } else {
                    results.innerHTML = '<div class="warning">‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ equipment –ø—É—Å—Ç–∞</div>';
                }
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        };
        
        window.checkTanksForTradingPoint = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">–ò—â–µ–º —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã –¥–ª—è –ê–ó–° ‚Ññ4...</div>';
            
            try {
                // –ó–∞–ø—Ä–æ—Å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
                const tanks = await makeRequest('equipment', {
                    'select': '*',
                    'trading_point_id': `eq.${tradingPointId}`,
                    'system_type': 'eq.fuel_tank'
                });
                
                if (tanks.length > 0) {
                    let html = `<div class="success"><h3>‚úÖ –ù–∞–π–¥–µ–Ω–æ ${tanks.length} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤</h3></div>`;
                    
                    tanks.forEach(tank => {
                        const fuelType = tank.fuel_type || tank.configuration?.fuel_type || '–ù–ï –£–ö–ê–ó–ê–ù';
                        const capacity = tank.capacity || tank.configuration?.capacity || '–ù–ï –£–ö–ê–ó–ê–ù–ê';
                        
                        html += `
                            <div class="tank-card">
                                <h4>üìç ${tank.name}</h4>
                                <p><strong>ID:</strong> ${tank.id}</p>
                                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${tank.status}</p>
                                <p><strong>–í–∏–¥ —Ç–æ–ø–ª–∏–≤–∞:</strong> ${fuelType}</p>
                                <p><strong>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:</strong> ${capacity} –ª</p>
                                <p><strong>system_type:</strong> ${tank.system_type}</p>
                                <details>
                                    <summary>–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</summary>
                                    <pre>${JSON.stringify(tank, null, 2)}</pre>
                                </details>
                            </div>
                        `;
                    });
                    
                    results.innerHTML = html;
                } else {
                    // –ü—Ä–æ–≤–µ—Ä–∏–º –≤—Å–µ equipment –¥–ª—è —ç—Ç–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
                    const allEquipment = await makeRequest('equipment', {
                        'select': '*',
                        'trading_point_id': `eq.${tradingPointId}`
                    });
                    
                    results.innerHTML = `
                        <div class="warning">
                            <h3>‚ö†Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –ê–ó–° ‚Ññ4</h3>
                            <p>–í—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏: ${allEquipment.length}</p>
                            ${allEquipment.length > 0 ? `
                                <p>–¢–∏–ø—ã –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:</p>
                                <pre>${[...new Set(allEquipment.map(e => e.system_type))].join('\n')}</pre>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        };
        
        window.checkAllTanks = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">–ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã –∏–∑ –ë–î...</div>';
            
            try {
                const allTanks = await makeRequest('equipment', {
                    'select': '*',
                    'system_type': 'eq.fuel_tank',
                    'order': 'trading_point_id,name'
                });
                
                if (allTanks.length > 0) {
                    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–æ—Ä–≥–æ–≤—ã–º —Ç–æ—á–∫–∞–º
                    const grouped = {};
                    allTanks.forEach(tank => {
                        const tpId = tank.trading_point_id || '–ë–ï–ó –¢–û–†–ì–û–í–û–ô –¢–û–ß–ö–ò';
                        if (!grouped[tpId]) grouped[tpId] = [];
                        grouped[tpId].push(tank);
                    });
                    
                    let html = `<div class="success"><h3>‚úÖ –í—Å–µ–≥–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –≤ –ë–î: ${allTanks.length}</h3></div>`;
                    
                    Object.keys(grouped).forEach(tpId => {
                        html += `
                            <div class="info">
                                <h4>–¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞: ${tpId}</h4>
                                <p>–†–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${grouped[tpId].length}</p>
                                <ul>
                                    ${grouped[tpId].map(t => `
                                        <li>${t.name} - ${t.fuel_type || t.configuration?.fuel_type || '–ë–ï–ó –¢–û–ü–õ–ò–í–ê'}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                    });
                    
                    results.innerHTML = html;
                } else {
                    results.innerHTML = '<div class="error">‚ùå –í –ë–î –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞ (system_type = fuel_tank)</div>';
                }
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        };
        
        window.checkFuelTypes = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞...</div>';
            
            try {
                const tanks = await makeRequest('equipment', {
                    'select': '*',
                    'trading_point_id': `eq.${tradingPointId}`,
                    'status': 'neq.deleted'
                });
                
                const fuelTypes = new Map();
                
                tanks.forEach(tank => {
                    // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ø–ª–∏–≤–∞
                    const fuel = tank.fuel_type || 
                                tank.configuration?.fuel_type || 
                                tank.params?.fuel_type ||
                                tank.metadata?.fuel_type;
                    
                    if (fuel) {
                        if (!fuelTypes.has(fuel)) {
                            fuelTypes.set(fuel, { count: 0, tanks: [] });
                        }
                        fuelTypes.get(fuel).count++;
                        fuelTypes.get(fuel).tanks.push(tank.name);
                    }
                });
                
                if (fuelTypes.size > 0) {
                    let html = `<div class="success"><h3>‚úÖ –ù–∞–π–¥–µ–Ω–æ ${fuelTypes.size} –≤–∏–¥–æ–≤ —Ç–æ–ø–ª–∏–≤–∞</h3></div>`;
                    
                    fuelTypes.forEach((data, fuel) => {
                        html += `
                            <div class="tank-card">
                                <h4>‚õΩ ${fuel}</h4>
                                <p>–†–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${data.count}</p>
                                <p>–†–µ–∑–µ—Ä–≤—É–∞—Ä—ã: ${data.tanks.join(', ')}</p>
                            </div>
                        `;
                    });
                    
                    results.innerHTML = html;
                } else {
                    results.innerHTML = `
                        <div class="warning">
                            <h3>‚ö†Ô∏è –í–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                            <p>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ ${tanks.length} –µ–¥–∏–Ω–∏—Ü –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</p>
                            <p>–í–æ–∑–º–æ–∂–Ω–æ, —Ç–æ–ø–ª–∏–≤–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—è—Ö –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</p>
                        </div>
                    `;
                }
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        };
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            checkTanksForTradingPoint();
        });
    </script>
</body>
</html>