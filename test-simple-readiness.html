<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1e1e1e; 
            color: #fff; 
            padding: 20px; 
            line-height: 1.4;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .code { 
            background: #0d1117; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #444;
            overflow-x: auto;
        }
        .highlight { 
            background: #2d4a22; 
            padding: 10px; 
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
    </style>
</head>
<body>
    <h1>‚ö° –ë–´–°–¢–†–´–ô –¢–ï–°–¢ –ì–û–¢–û–í–ù–û–°–¢–ò –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ì–û HTTP –ö–õ–ò–ï–ù–¢–ê</h1>
    <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∑–∞–≤–∏—Å–∞–Ω–∏—è</p>
    
    <div>
        <button onclick="testQuickReadiness()">üöÄ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</button>
        <button onclick="testApiConfigSimple()">‚öôÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</button>
        <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    
    <div id="log"></div>

    <script type="module">
        const log = document.getElementById('log');
        let httpClient = null;
        let tradingNetworkConfigService = null;
        
        function addLog(message, type = 'normal') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            log.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, ''));
        }
        
        window.clearLog = function() {
            log.innerHTML = '';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function initialize() {
            try {
                const imports = await import('/src/services/universalHttpClient.ts');
                httpClient = imports.httpClient;
                
                const configImports = await import('/src/services/tradingNetworkConfigService.ts');
                tradingNetworkConfigService = configImports.tradingNetworkConfigService;
                
                addLog('‚úÖ HTTP –∫–ª–∏–µ–Ω—Ç –∏ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }
        
        // –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        window.testQuickReadiness = async function() {
            addLog('üöÄ –ë–´–°–¢–†–´–ô –¢–ï–°–¢ –ì–û–¢–û–í–ù–û–°–¢–ò –°–ò–°–¢–ï–ú–´', 'info');
            
            let results = [];
            
            try {
                // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP –∫–ª–∏–µ–Ω—Ç–∞
                addLog('üì° –¢–µ—Å—Ç 1: HTTP –∫–ª–∏–µ–Ω—Ç...', 'info');
                if (httpClient && typeof httpClient.get === 'function') {
                    results.push('‚úÖ HTTP –∫–ª–∏–µ–Ω—Ç: –≥–æ—Ç–æ–≤');
                } else {
                    results.push('‚ùå HTTP –∫–ª–∏–µ–Ω—Ç: –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                
                // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
                addLog('üîß –¢–µ—Å—Ç 2: —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã...', 'info');
                const methods = ['getNetworks', 'getTradingPointsByNetworkId', 'getAllTradingPointsWithNetworks', 'getApiParamsForTradingPoint'];
                let methodsOk = 0;
                methods.forEach(method => {
                    if (typeof httpClient[method] === 'function') {
                        methodsOk++;
                    }
                });
                results.push(`‚úÖ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã: ${methodsOk}/${methods.length}`);
                
                // 3. –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                addLog('üóÑÔ∏è –¢–µ—Å—Ç 3: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
                const networksResponse = await Promise.race([
                    httpClient.getNetworks(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 5000))
                ]);
                
                if (networksResponse.success && networksResponse.data) {
                    results.push(`‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${networksResponse.data.length} —Å–µ—Ç–µ–π –Ω–∞–π–¥–µ–Ω–æ`);
                } else {
                    results.push('‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                }
                
                // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤—ã—Ö –¥–ª—è API —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫
                addLog('üéØ –¢–µ—Å—Ç 4: —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ —Å API...', 'info');
                const allTpResponse = await Promise.race([
                    httpClient.getAllTradingPointsWithNetworks(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 5000))
                ]);
                
                if (allTpResponse.success && allTpResponse.data) {
                    const readyCount = allTpResponse.data.filter(tp => tp.apiReady).length;
                    results.push(`‚úÖ –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏: ${readyCount}/${allTpResponse.data.length} –≥–æ—Ç–æ–≤—ã –¥–ª—è API`);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–æ—Ç–æ–≤—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏
                    const readyTps = allTpResponse.data.filter(tp => tp.apiReady);
                    if (readyTps.length > 0) {
                        addLog('<div class="code">–ì–û–¢–û–í–´–ï –î–õ–Ø API –¢–û–†–ì–û–í–´–ï –¢–û–ß–ö–ò:<br>' + 
                            readyTps.map(tp => `‚Ä¢ ${tp.name}: system="${tp.systemId}", station="${tp.stationId}"`).join('<br>') + 
                            '</div>', 'success');
                    }
                } else {
                    results.push('‚ùå –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏: –æ—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è');
                }
                
                // –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const successCount = results.filter(r => r.startsWith('‚úÖ')).length;
                const totalTests = results.length;
                const readyPercent = Math.round((successCount / totalTests) * 100);
                
                addLog(`<div class="highlight">
                    üìä –ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢ –ë–´–°–¢–†–û–ì–û –¢–ï–°–¢–ê:<br><br>
                    ${results.join('<br>')}<br><br>
                    üéØ –ì–û–¢–û–í–ù–û–°–¢–¨ –°–ò–°–¢–ï–ú–´: ${readyPercent}%<br>
                    ${readyPercent >= 75 ? 
                        'üéâ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –†–ê–ë–û–¢–ï!' : 
                        readyPercent >= 50 ? 
                        '‚ö†Ô∏è –°–∏—Å—Ç–µ–º–∞ —á–∞—Å—Ç–∏—á–Ω–æ –≥–æ—Ç–æ–≤–∞' : 
                        '‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞'
                    }
                </div>`, readyPercent >= 75 ? 'success' : readyPercent >= 50 ? 'warning' : 'error');
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞: ${error.message}`, 'error');
            }
        }
        
        // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        window.testApiConfigSimple = async function() {
            addLog('‚öôÔ∏è –ü–†–û–°–¢–ê–Ø –ü–†–û–í–ï–†–ö–ê API –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò', 'info');
            
            try {
                addLog('üîß –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å —Ç–∞–π–º–∞—É—Ç–æ–º...', 'info');
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–Ω—É—Ç—å
                const config = await Promise.race([
                    tradingNetworkConfigService.getConfig(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('–¢–∞–π–º–∞—É—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (5 —Å–µ–∫)')), 5000))
                ]);
                
                addLog(`<div class="code">
                    ‚úÖ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –í–ù–ï–®–ù–ï–ì–û API:<br>
                    ‚ûú –í–∫–ª—é—á–µ–Ω–∞: ${config.enabled ? '–î–ê' : '–ù–ï–¢'}<br>
                    ‚ûú Base URL: ${config.baseUrl}<br>
                    ‚ûú Auth Type: ${config.authType}<br>
                    ‚ûú Endpoints:<br>
                    &nbsp;&nbsp;- Tanks: ${config.endpoints.tanks}<br>
                    &nbsp;&nbsp;- Transactions: ${config.endpoints.transactions}<br>
                    ‚ûú Timeout: ${config.timeout}ms
                </div>`, 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–∫
                const problems = [];
                if (config.authType !== 'basic') problems.push(`AuthType –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 'basic', –∞ –Ω–µ '${config.authType}'`);
                if (config.endpoints.tanks !== '/tanks') problems.push(`Tanks endpoint –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å '/tanks', –∞ –Ω–µ '${config.endpoints.tanks}'`);
                if (config.endpoints.transactions !== '/transactions') problems.push(`Transactions endpoint –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å '/transactions', –∞ –Ω–µ '${config.endpoints.transactions}'`);
                
                if (problems.length > 0) {
                    addLog(`<div class="highlight">
                        ‚ö†Ô∏è –ù–ê–ô–î–ï–ù–´ –ü–†–û–ë–õ–ï–ú–´:<br>
                        ${problems.map(p => `‚Ä¢ ${p}`).join('<br>')}<br><br>
                        üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–±—Ä–æ—Å–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    </div>`, 'warning');
                } else {
                    addLog('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è!', 'success');
                }
                
            } catch (error) {
                if (error.message.includes('–¢–∞–π–º–∞—É—Ç')) {
                    addLog(`‚ö†Ô∏è ${error.message} - –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å apiConfigServiceDB`, 'warning');
                } else {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
                }
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        addLog('‚úÖ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω', 'info');
        initialize();
    </script>
</body>
</html>