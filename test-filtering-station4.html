<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: –°—Ç–∞–Ω—Ü–∏—è 4, –°–µ—Ç—å 15</title>
    <style>
        body { font-family: Arial, sans-serif; background: #1e293b; color: white; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .info { background: #374151; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .debug { background: #0f172a; padding: 15px; border-radius: 8px; font-family: monospace; margin: 10px 0; }
        button { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        .result { background: #374151; padding: 15px; border-radius: 8px; margin: 10px 0; white-space: pre-wrap; }
        .error { background: #dc2626; color: white; padding: 10px; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ —Å—Ç–∞–Ω—Ü–∏–∏ 4 —Å–µ—Ç–∏ 15</h1>
        
        <div class="info">
            <h3>üìä –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
            <ul>
                <li><strong>–°–µ—Ç—å 15 "–ù–æ—Ä–¥ –õ–∞–π–Ω":</strong> UUID: b5e25b51-a950-481e-a09d-ac25e6b5d6ab</li>
                <li><strong>–°—Ç–∞–Ω—Ü–∏—è 4:</strong> UUID: 6969b08d-1cbe-45c2-ae9c-8002c7022b59</li>
                <li><strong>–û–ø–µ—Ä–∞—Ü–∏–π —É —Å—Ç–∞–Ω—Ü–∏–∏ 4:</strong> –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ~15 –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –∞–≤–≥—É—Å—Ç 2025</li>
            </ul>
        </div>

        <button onclick="testDirectSupabaseFiltering()">üéØ –¢–µ—Å—Ç 1: –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ Supabase —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ UUID</button>
        <button onclick="testOperationsServiceFiltering()">üîç –¢–µ—Å—Ç 2: –ß–µ—Ä–µ–∑ operationsSupabaseService —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏</button>
        <button onclick="testSalesAnalysisFiltering()">üìà –¢–µ—Å—Ç 3: –ß–µ—Ä–µ–∑ SalesAnalysisSimple (–ø–æ–ª–Ω—ã–π —Å—Ç–µ–∫)</button>
        <button onclick="clearResults()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>

        <div id="results"></div>
    </div>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        import { operationsSupabaseService } from './src/services/operationsSupabaseService.ts';
        import { supabaseClient } from './src/services/supabaseClientBrowser.ts';

        window.testDirectSupabaseFiltering = async function() {
            console.log('üéØ –¢–ï–°–¢ 1: –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ Supabase');
            
            try {
                const station4UUID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
                
                // –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ Supabase
                const { data, error } = await supabaseClient
                    .from('operations')
                    .select('*')
                    .eq('trading_point_id', station4UUID)
                    .eq('status', 'completed');

                const result = {
                    method: '–ü—Ä—è–º–æ–π Supabase –∑–∞–ø—Ä–æ—Å',
                    query: `operations.select(*).eq('trading_point_id', '${station4UUID}').eq('status', 'completed')`,
                    operationsCount: data?.length || 0,
                    error: error?.message || null,
                    sampleOperations: data?.slice(0, 3)?.map(op => ({
                        id: op.id,
                        trading_point_id: op.trading_point_id,
                        total_cost: op.total_cost,
                        quantity: op.quantity,
                        payment_method: op.payment_method,
                        created_at: op.created_at
                    })) || []
                };

                displayResult('test1', result);
                console.log('üéØ –†–ï–ó–£–õ–¨–¢–ê–¢ –¢–ï–°–¢–ê 1:', result);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ 1:', error);
                displayResult('test1', { error: error.message });
            }
        }

        window.testOperationsServiceFiltering = async function() {
            console.log('üîç –¢–ï–°–¢ 2: –ß–µ—Ä–µ–∑ operationsSupabaseService');
            
            try {
                const station4UUID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
                
                const filters = {
                    tradingPointId: station4UUID,
                    status: 'completed',
                    startDate: '2025-08-01',
                    endDate: '2025-08-31'
                };

                console.log('üîç –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã:', filters);
                
                const operations = await operationsSupabaseService.getOperations(filters);

                const result = {
                    method: 'operationsSupabaseService.getOperations()',
                    filters: filters,
                    operationsCount: operations?.length || 0,
                    totalRevenue: operations?.reduce((sum, op) => sum + (op.totalCost || 0), 0) || 0,
                    sampleOperations: operations?.slice(0, 3)?.map(op => ({
                        id: op.id,
                        tradingPointId: op.tradingPointId,
                        totalCost: op.totalCost,
                        quantity: op.quantity,
                        paymentMethod: op.paymentMethod
                    })) || []
                };

                displayResult('test2', result);
                console.log('üîç –†–ï–ó–£–õ–¨–¢–ê–¢ –¢–ï–°–¢–ê 2:', result);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ 2:', error);
                displayResult('test2', { error: error.message });
            }
        }

        window.testSalesAnalysisFiltering = async function() {
            console.log('üìà –¢–ï–°–¢ 3: –ß–µ—Ä–µ–∑ SalesAnalysisSimple');
            
            // –≠—Ç–æ—Ç —Ç–µ—Å—Ç –∏–º–∏—Ç–∏—Ä—É–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ SalesAnalysisSimple –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
            try {
                const station4UUID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
                
                // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–∫ –≤ SalesAnalysisSimple
                const filters = {
                    tradingPointId: station4UUID,
                    status: 'completed',
                    startDate: '2025-08-01',
                    endDate: '2025-08-31'
                };

                console.log('üìà SalesAnalysisSimple —Ñ–∏–ª—å—Ç—Ä—ã:', filters);
                
                const operations = await operationsSupabaseService.getOperations(filters);
                
                // –í—ã—á–∏—Å–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∫ –≤ SalesAnalysisSimple
                const totalRevenue = operations.reduce((sum, op) => sum + (op.totalCost || 0), 0);
                const totalTransactions = operations.length;
                const totalFuelLiters = operations.reduce((sum, op) => sum + (op.quantity || 0), 0);
                const averageTicket = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;
                
                const cashlessOperations = operations.filter(op => 
                    op.paymentMethod === 'bank_card' || 
                    op.paymentMethod === 'corporate_card'
                ).length;
                const cashlessPercentage = totalTransactions > 0 ? (cashlessOperations / totalTransactions) * 100 : 0;

                const result = {
                    method: 'SalesAnalysisSimple –ø–æ–ª–Ω—ã–π —Å—Ç–µ–∫',
                    filters: filters,
                    metrics: {
                        totalRevenue: totalRevenue.toLocaleString('ru-RU') + ' ‚ÇΩ',
                        totalTransactions,
                        totalFuelLiters: totalFuelLiters.toLocaleString('ru-RU') + ' –ª',
                        averageTicket: averageTicket.toLocaleString('ru-RU') + ' ‚ÇΩ',
                        cashlessPercentage: cashlessPercentage.toFixed(1) + '%'
                    },
                    operationsCount: operations.length,
                    uniqueTradingPoints: [...new Set(operations.map(op => op.tradingPointId).filter(Boolean))]
                };

                displayResult('test3', result);
                console.log('üìà –†–ï–ó–£–õ–¨–¢–ê–¢ –¢–ï–°–¢–ê 3:', result);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ 3:', error);
                displayResult('test3', { error: error.message });
            }
        }

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        }

        function displayResult(testId, result) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = `
                <h3>${testId.toUpperCase()}: ${result.method || '–¢–µ—Å—Ç'}</h3>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
            resultsDiv.appendChild(resultDiv);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        window.addEventListener('load', function() {
            console.log('üîß –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            console.log('üéØ UUID —Å—Ç–∞–Ω—Ü–∏–∏ 4:', '6969b08d-1cbe-45c2-ae9c-8002c7022b59');
            console.log('üè™ UUID —Å–µ—Ç–∏ 15:', 'b5e25b51-a950-481e-a09d-ac25e6b5d6ab');
        });
    </script>
</body>
</html>