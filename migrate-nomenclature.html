<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∑Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã —Ç–æ–ø–ª–∏–≤–∞</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button.danger { background: #dc3545; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 11px; max-height: 300px; }
        .fuel-type { color: #28a745; font-weight: bold; }
        .external-code { color: #dc3545; font-family: monospace; }
        .network-name { color: #007bff; font-style: italic; }
    </style>
</head>
<body>
    <h1>üè∑Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã —Ç–æ–ø–ª–∏–≤–∞ –∏–∑ localStorage –≤ Supabase</h1>
    
    <div class="section info">
        <h3>üìã –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏:</h3>
        <ol>
            <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –≤ localStorage</li>
            <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã nomenclature –≤ Supabase</li>
            <li>–°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å network_id —Å UUID –∏–∑ —Ç–∞–±–ª–∏—Ü—ã networks</li>
            <li>–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º</li>
            <li>–û–±–Ω–æ–≤–∏—Ç—å nomenclatureService.ts –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase</li>
        </ol>
    </div>
    
    <div class="section">
        <button onclick="checkLocalStorageData()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ localStorage</button>
        <button onclick="checkSupabaseTable()">üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É nomenclature</button>
        <button onclick="checkNetworkMappings()">üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ç–µ–π</button>
        <button onclick="migrateNomenclature()" class="success">‚¨ÜÔ∏è –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (typeof data === 'string') {
                    content += `<pre>${data}</pre>`
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
        }

        // –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è network_id —Å UUID
        let networkMappings = {}

        window.checkLocalStorageData = async function() {
            logResult('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –≤ localStorage...', 'info')
            
            try {
                const nomenclatureData = localStorage.getItem('nomenclature')
                
                if (!nomenclatureData) {
                    logResult('‚ùå –î–∞–Ω–Ω—ã–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage', 'error')
                    return
                }
                
                let parsed = JSON.parse(nomenclatureData)
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã {data: [...]}
                if (parsed && parsed.data && Array.isArray(parsed.data)) {
                    parsed = parsed.data
                }
                
                if (!Array.isArray(parsed)) {
                    logResult('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã', 'error', parsed)
                    return
                }
                
                logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${parsed.length} –∑–∞–ø–∏—Å–µ–π –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã`, 'success')
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
                const summary = parsed.map(item => ({
                    id: item.id,
                    name: item.name,
                    internalCode: item.internalCode,
                    networkId: item.networkId,
                    networkName: item.networkName,
                    externalCodes: item.externalCodes?.length || 0,
                    status: item.status,
                    networkApiCode: item.networkApiCode
                }))
                
                logResult('üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã:', 'info', summary)
                
                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–Ω–µ—à–Ω–∏–µ –∫–æ–¥—ã
                const allExternalCodes = []
                parsed.forEach(item => {
                    if (item.externalCodes && Array.isArray(item.externalCodes)) {
                        item.externalCodes.forEach(code => {
                            allExternalCodes.push({
                                nomenclatureId: item.id,
                                fuelName: item.name,
                                systemType: code.systemType,
                                externalCode: code.externalCode,
                                description: code.description
                            })
                        })
                    }
                })
                
                if (allExternalCodes.length > 0) {
                    logResult(`üîó –ù–∞–π–¥–µ–Ω–æ ${allExternalCodes.length} –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–¥–æ–≤:`, 'info', allExternalCodes)
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ localStorage', 'error', error)
            }
        }

        window.checkSupabaseTable = async function() {
            logResult('üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É nomenclature –≤ Supabase...', 'info')
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã nomenclature
                const { data, error } = await supabase
                    .from('nomenclature')
                    .select('*')
                    .limit(5)
                
                if (error) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ nomenclature', 'error', error)
                    return
                }
                
                logResult(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ nomenclature —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ù–∞–π–¥–µ–Ω–æ ${data.length} –∑–∞–ø–∏—Å–µ–π`, 'success', data)
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–±–ª–∏—Ü—ã Supabase', 'error', error)
            }
        }

        window.checkNetworkMappings = async function() {
            logResult('üîó –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è network_id...', 'info')
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–µ—Ç–∏ –∏–∑ Supabase
                const { data: networks, error: networksError } = await supabase
                    .from('networks')
                    .select('id, name, external_id')
                    .order('name')
                
                if (networksError) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ç–µ–π', 'error', networksError)
                    return
                }
                
                logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${networks.length} —Å–µ—Ç–µ–π –≤ –±–∞–∑–µ:`, 'success', networks)
                
                // –°–æ–∑–¥–∞–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è external_id -> UUID
                networkMappings = {}
                networks.forEach(network => {
                    if (network.external_id) {
                        networkMappings[network.external_id] = network.id
                    }
                })
                
                logResult('üó∫Ô∏è –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è network_id:', 'info', networkMappings)
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ localStorage –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
                const nomenclatureData = localStorage.getItem('nomenclature')
                if (nomenclatureData) {
                    let parsed = JSON.parse(nomenclatureData)
                    if (parsed && parsed.data && Array.isArray(parsed.data)) {
                        parsed = parsed.data
                    }
                    
                    const networkCheck = {}
                    parsed.forEach(item => {
                        if (!networkCheck[item.networkId]) {
                            networkCheck[item.networkId] = []
                        }
                        networkCheck[item.networkId].push(item.name)
                    })
                    
                    logResult('üìä –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã —Å —Å–µ—Ç—è–º–∏:', 'info', networkCheck)
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π', 'error', error)
            }
        }

        window.migrateNomenclature = async function() {
            logResult('‚¨ÜÔ∏è –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã...', 'info')
            
            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
                const nomenclatureData = localStorage.getItem('nomenclature')
                if (!nomenclatureData) {
                    logResult('‚ùå –î–∞–Ω–Ω—ã–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage', 'error')
                    return
                }
                
                let localStorageData = JSON.parse(nomenclatureData)
                if (localStorageData && localStorageData.data && Array.isArray(localStorageData.data)) {
                    localStorageData = localStorageData.data
                }
                
                logResult(`üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ ${localStorageData.length} –∑–∞–ø–∏—Å–µ–π...`, 'info')
                
                // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ç–µ–π
                await checkNetworkMappings()
                
                let migratedCount = 0
                const errors = []
                
                // 3. –ú–∏–≥—Ä–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∑–∞–ø–∏—Å—å
                for (const item of localStorageData) {
                    try {
                        const networkUuid = networkMappings[item.networkId]
                        if (!networkUuid) {
                            errors.push(`–ù–µ –Ω–∞–π–¥–µ–Ω UUID –¥–ª—è network_id ${item.networkId} (${item.networkName})`)
                            continue
                        }
                        
                        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
                        const nomenclatureRecord = {
                            id: crypto.randomUUID(),
                            network_id: networkUuid,
                            name: item.name,
                            internal_code: item.internalCode,
                            network_api_code: item.networkApiCode || null,
                            network_api_settings: item.networkApiSettings || null,
                            description: item.description || null,
                            status: item.status || 'active',
                            external_id: item.id, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π ID –∫–∞–∫ external_id
                            created_at: item.createdAt ? new Date(item.createdAt) : new Date(),
                            updated_at: item.updatedAt ? new Date(item.updatedAt) : new Date(),
                            created_by: item.createdBy || 'migration',
                            updated_by: item.updatedBy || 'migration'
                        }
                        
                        // –í—Å—Ç–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∑–∞–ø–∏—Å—å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
                        const { data: insertedNomenclature, error: nomenclatureError } = await supabase
                            .from('nomenclature')
                            .insert([nomenclatureRecord])
                            .select()
                        
                        if (nomenclatureError) {
                            errors.push(`–û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ ${item.name}: ${nomenclatureError.message}`)
                            continue
                        }
                        
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∫–æ–¥—ã, –≤—Å—Ç–∞–≤–ª—è–µ–º –∏—Ö
                        if (item.externalCodes && Array.isArray(item.externalCodes) && item.externalCodes.length > 0) {
                            const externalCodesRecords = item.externalCodes.map(code => ({
                                id: crypto.randomUUID(),
                                nomenclature_id: insertedNomenclature[0].id,
                                system_type: code.systemType,
                                external_code: code.externalCode,
                                description: code.description || null,
                                created_at: code.createdAt ? new Date(code.createdAt) : new Date(),
                                updated_at: code.updatedAt ? new Date(code.updatedAt) : new Date()
                            }))
                            
                            const { error: codesError } = await supabase
                                .from('nomenclature_external_codes')
                                .insert(externalCodesRecords)
                            
                            if (codesError) {
                                logResult(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–¥–æ–≤ –¥–ª—è ${item.name}`, 'warning', codesError)
                            } else {
                                logResult(`‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ ${item.name} —Å ${externalCodesRecords.length} –≤–Ω–µ—à–Ω–∏–º–∏ –∫–æ–¥–∞–º–∏`, 'success')
                            }
                        } else {
                            logResult(`‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ ${item.name} (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–¥–æ–≤)`, 'success')
                        }
                        
                        migratedCount++
                        
                    } catch (itemError) {
                        errors.push(`–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ ${item.name}: ${itemError.message}`)
                    }
                }
                
                // –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
                logResult(`üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${migratedCount} –∑–∞–ø–∏—Å–µ–π`, 'success')
                
                if (errors.length > 0) {
                    logResult(`‚ö†Ô∏è –û—à–∏–±–∫–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (${errors.length}):`, 'warning', errors)
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const { data: finalData, error: checkError } = await supabase
                    .from('nomenclature')
                    .select('id, name, internal_code, network_id, status, external_id')
                    .order('name')
                
                if (!checkError) {
                    logResult(`üìä –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã nomenclature (${finalData.length} –∑–∞–ø–∏—Å–µ–π):`, 'info', finalData)
                }
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏', 'error', error)
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 500))
            await checkLocalStorageData()
            await checkSupabaseTable()
        })
    </script>
</body>
</html>