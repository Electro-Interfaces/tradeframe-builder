<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ü–µ–Ω - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .step { background: #f5f5f5; padding: 15px; margin: 10px 0; border-left: 4px solid #007acc; }
        .sql { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .copy-btn { background: #007acc; color: white; border: none; padding: 8px 12px; cursor: pointer; margin: 10px 0; }
        .copy-btn:hover { background: #005a9e; }
    </style>
</head>
<body>
    <h1>üèóÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ü–µ–Ω –≤ Supabase</h1>
    
    <div class="step">
        <h2>–®–∞–≥ 1: –û—Ç–∫—Ä—ã—Ç—å Supabase SQL Editor</h2>
        <p>1. –ü–µ—Ä–µ–π—Ç–∏ –≤ Supabase Dashboard</p>
        <p>2. –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç <strong>tradeframe-builder</strong></p>
        <p>3. –û—Ç–∫—Ä—ã—Ç—å —Ä–∞–∑–¥–µ–ª <strong>SQL Editor</strong></p>
        <p>4. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
    </div>

    <div class="step">
        <h2>–®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É prices</h2>
        <button class="copy-btn" onclick="copySQL('createTable')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL</button>
        <pre class="sql" id="createTable">-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ü–µ–Ω –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ —Ü–µ–Ω
-- –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ Supabase SQL Editor

CREATE TABLE IF NOT EXISTS prices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    trading_point_id UUID NOT NULL,
    fuel_type_id UUID NOT NULL,
    
    -- –¶–µ–Ω—ã –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    price_net INTEGER NOT NULL CHECK (price_net >= 0),
    vat_rate DECIMAL(5,2) NOT NULL DEFAULT 20.00,
    price_gross INTEGER NOT NULL CHECK (price_gross >= 0),
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    source VARCHAR(20) NOT NULL DEFAULT 'manual',
    unit VARCHAR(10) NOT NULL DEFAULT 'L',
    
    -- –ü–µ—Ä–∏–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è
    valid_from TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    is_active BOOLEAN NOT NULL DEFAULT true,
    
    -- –ê—É–¥–∏—Ç
    created_by TEXT,
    reason TEXT,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞
ALTER TABLE prices ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "prices_public_policy" ON prices;
CREATE POLICY "prices_public_policy" ON prices FOR ALL USING (true);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_prices_trading_point_id ON prices(trading_point_id);
CREATE INDEX IF NOT EXISTS idx_prices_fuel_type_id ON prices(fuel_type_id);
CREATE INDEX IF NOT EXISTS idx_prices_active ON prices(is_active) WHERE is_active = true;</pre>
    </div>

    <div class="step">
        <h2>–®–∞–≥ 3: –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–º–∏</h2>
        <button class="copy-btn" onclick="copySQL('insertDemo')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL</button>
        <pre class="sql" id="insertDemo">-- –í—Å—Ç–∞–≤–∫–∞ –¥–µ–º–æ-—Ü–µ–Ω –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ê–ó–°
-- –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã prices

INSERT INTO prices (trading_point_id, fuel_type_id, price_net, vat_rate, price_gross, source, reason, created_by) 
SELECT 
    tp.id as trading_point_id,
    ft.id as fuel_type_id,
    
    -- –ë–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏ –ø–æ –ê–ó–°
    CASE 
        WHEN tp.name LIKE '%–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è%' THEN
            CASE 
                WHEN ft.code = 'AI95' THEN 5300
                WHEN ft.code = 'AI92' THEN 5000  
                WHEN ft.code = 'DT_SUMMER' THEN 5200
                WHEN ft.code = 'PROPANE' THEN 2800
                ELSE 5100
            END
        WHEN tp.name LIKE '%–°–µ–≤–µ—Ä–Ω–∞—è%' THEN
            CASE 
                WHEN ft.code = 'AI95' THEN 5194  -- 98% –æ—Ç –±–∞–∑–æ–≤–æ–π
                WHEN ft.code = 'AI92' THEN 4900
                WHEN ft.code = 'DT_SUMMER' THEN 5096
                WHEN ft.code = 'PROPANE' THEN 2744
                ELSE 4998
            END
        WHEN tp.name LIKE '%–Æ–∂–Ω–∞—è%' THEN
            CASE 
                WHEN ft.code = 'AI95' THEN 5406  -- 102% –æ—Ç –±–∞–∑–æ–≤–æ–π
                WHEN ft.code = 'AI92' THEN 5100
                WHEN ft.code = 'DT_SUMMER' THEN 5304
                WHEN ft.code = 'PROPANE' THEN 2856
                ELSE 5202
            END
        WHEN tp.name LIKE '%–ü—Ä–æ–º–∑–æ–Ω–∞%' THEN
            CASE 
                WHEN ft.code = 'AI95' THEN 5035  -- 95% –æ—Ç –±–∞–∑–æ–≤–æ–π
                WHEN ft.code = 'AI92' THEN 4750
                WHEN ft.code = 'DT_SUMMER' THEN 4940
                WHEN ft.code = 'PROPANE' THEN 2660
                ELSE 4845
            END
        WHEN tp.name LIKE '%–û–∫—Ä—É–∂–Ω–∞—è%' THEN
            CASE 
                WHEN ft.code = 'AI95' THEN 5565  -- 105% –æ—Ç –±–∞–∑–æ–≤–æ–π
                WHEN ft.code = 'AI92' THEN 5250
                WHEN ft.code = 'DT_SUMMER' THEN 5460
                WHEN ft.code = 'PROPANE' THEN 2940
                ELSE 5355
            END
        ELSE 5100
    END as price_net,
    
    20.00 as vat_rate,
    
    -- –¶–µ–Ω–∞ —Å –ù–î–° (+20%)
    CASE 
        WHEN tp.name LIKE '%–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è%' THEN
            CASE 
                WHEN ft.code = 'AI95' THEN 6360
                WHEN ft.code = 'AI92' THEN 6000  
                WHEN ft.code = 'DT_SUMMER' THEN 6240
                WHEN ft.code = 'PROPANE' THEN 3360
                ELSE 6120
            END
        WHEN tp.name LIKE '%–°–µ–≤–µ—Ä–Ω–∞—è%' THEN
            CASE 
                WHEN ft.code = 'AI95' THEN 6233
                WHEN ft.code = 'AI92' THEN 5880
                WHEN ft.code = 'DT_SUMMER' THEN 6115
                WHEN ft.code = 'PROPANE' THEN 3293
                ELSE 5998
            END
        WHEN tp.name LIKE '%–Æ–∂–Ω–∞—è%' THEN
            CASE 
                WHEN ft.code = 'AI95' THEN 6487
                WHEN ft.code = 'AI92' THEN 6120
                WHEN ft.code = 'DT_SUMMER' THEN 6365
                WHEN ft.code = 'PROPANE' THEN 3427
                ELSE 6242
            END
        WHEN tp.name LIKE '%–ü—Ä–æ–º–∑–æ–Ω–∞%' THEN
            CASE 
                WHEN ft.code = 'AI95' THEN 6042
                WHEN ft.code = 'AI92' THEN 5700
                WHEN ft.code = 'DT_SUMMER' THEN 5928
                WHEN ft.code = 'PROPANE' THEN 3192
                ELSE 5814
            END
        WHEN tp.name LIKE '%–û–∫—Ä—É–∂–Ω–∞—è%' THEN
            CASE 
                WHEN ft.code = 'AI95' THEN 6678
                WHEN ft.code = 'AI92' THEN 6300
                WHEN ft.code = 'DT_SUMMER' THEN 6552
                WHEN ft.code = 'PROPANE' THEN 3528
                ELSE 6426
            END
        ELSE 6120
    END as price_gross,
    
    'manual' as source,
    '–î–µ–º–æ-—Ü–µ–Ω–∞ –Ω–∞ ' || ft.name || ' –¥–ª—è ' || tp.name as reason,
    'demo-user' as created_by
FROM 
    -- –ë–µ—Ä–µ–º –ê–ó–° –∏–∑ –¥–µ–º–æ —Å–µ—Ç–∏
    (SELECT id, name FROM trading_points 
     WHERE network_id = 'f5f5961a-4ae0-409f-b4ba-1f630a329434' 
     ORDER BY name) tp
CROSS JOIN 
    -- –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 4 –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∏–¥–∞ —Ç–æ–ø–ª–∏–≤–∞
    (SELECT id, name, code FROM fuel_types 
     WHERE is_active = true 
     ORDER BY name 
     LIMIT 4) ft
ON CONFLICT DO NOTHING;</pre>
    </div>

    <div class="step">
        <h2>–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h2>
        <button class="copy-btn" onclick="copySQL('checkResult')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL</button>
        <pre class="sql" id="checkResult">-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ü–µ–Ω
SELECT 
    p.id,
    tp.name as trading_point,
    ft.name as fuel_type,
    p.price_net,
    p.price_gross,
    (p.price_gross::float / 100)::numeric(10,2) as price_rub,
    p.reason
FROM prices p
JOIN trading_points tp ON p.trading_point_id = tp.id
JOIN fuel_types ft ON p.fuel_type_id = ft.id
WHERE p.created_by = 'demo-user'
ORDER BY tp.name, ft.name;</pre>
    </div>

    <div class="step">
        <h2>‚úÖ –ì–æ—Ç–æ–≤–æ!</h2>
        <p>–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤:</p>
        <ul>
            <li>–¢–∞–±–ª–∏—Ü–∞ <code>prices</code> –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞</li>
            <li>–î–µ–º–æ-—Ü–µ–Ω—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –ê–ó–° –¥–µ–º–æ —Å–µ—Ç–∏</li>
            <li>–†–∞–∑–¥–µ–ª —Ü–µ–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</li>
        </ul>
    </div>

    <script>
        function copySQL(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('SQL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('SQL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
            }
            document.body.removeChild(textArea);
        }
    </script>
</body>
</html>