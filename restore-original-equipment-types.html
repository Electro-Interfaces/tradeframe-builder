<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button.danger { background: #dc3545; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 11px; max-height: 400px; }
        .template-card { border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px; background: #f8f9fa; }
        .current { border-left: 4px solid #ffc107; }
        .original { border-left: 4px solid #28a745; }
    </style>
</head>
<body>
    <h1>üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h1>
    
    <div class="section warning">
        <h3>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</h3>
        <p>–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ–π—á–∞—Å –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ù–ï –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è!</p>
        <p>–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–∑–≤–æ–ª–∏—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã.</p>
    </div>
    
    <div class="section">
        <button onclick="showCurrentTypes()">üìã –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ —Ç–∏–ø—ã</button>
        <button onclick="showOriginalTypes()">‚úÖ –ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã</button>
        <button class="danger" onclick="restoreOriginalTypes()">üîÑ –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        // –ò–ó–ù–ê–ß–ê–õ–¨–ù–´–ï —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const originalTemplates = [
            {
                name: "–†–µ–∑–µ—Ä–≤—É–∞—Ä",
                technical_code: "EQP_RESERVOIR", 
                system_type: "fuel_tank",
                description: "–¢–æ–ø–ª–∏–≤–Ω—ã–π —Ä–µ–∑–µ—Ä–≤—É–∞—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–¥—É–∫—Ç–æ–≤",
                default_params: {
                    capacityLiters: 50000,
                    minLevelPercent: 20,
                    criticalLevelPercent: 10,
                    material: "steel"
                },
                allow_component_template_ids: ["1", "4"]
            },
            {
                name: "–¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
                technical_code: "EQP_TSO",
                system_type: "self_service_terminal", 
                description: "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –Ω–∞ –ê–ó–°",
                default_params: {
                    touch_screen: true,
                    payment_methods: ["card", "cash"]
                },
                allow_component_template_ids: ["1", "2", "3", "4", "5"]
            },
            {
                name: "–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
                technical_code: "EQP_CONTROL_SYSTEM",
                system_type: "control_system",
                description: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ê–ó–°",
                default_params: {
                    server_type: "industrial",
                    redundancy: true
                },
                allow_component_template_ids: ["1", "2", "3", "4"]
            },
            {
                name: "–¢–∞–±–ª–æ —Ü–µ–Ω",
                technical_code: "EQP_PRICE_BOARD",
                system_type: "price_display",
                description: "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ —Ç–∞–±–ª–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω –Ω–∞ —Ç–æ–ø–ª–∏–≤–æ",
                default_params: {
                    display_type: "LED",
                    brightness: 5000
                },
                allow_component_template_ids: ["1", "2", "4"]
            },
            {
                name: "–í–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ",
                technical_code: "EQP_CCTV",
                system_type: "surveillance",
                description: "–°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ê–ó–°",
                default_params: {
                    resolution: "4K",
                    night_vision: true,
                    storage_days: 30
                },
                allow_component_template_ids: ["1", "4"]
            },
            {
                name: "–ó–≤—É–∫–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ",
                technical_code: "EQP_AUDIO", 
                system_type: "audio_system",
                description: "–°–∏—Å—Ç–µ–º–∞ –∑–≤—É–∫–æ–≤–æ–≥–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è",
                default_params: {
                    speakers: 6,
                    volume_max: 80,
                    zones: 3
                },
                allow_component_template_ids: ["1", "4"]
            }
        ]
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (typeof data === 'string') {
                    content += `<pre>${data}</pre>`
                } else if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                    let tableContent = '<div>'
                    data.forEach(item => {
                        const cardClass = item._type === 'current' ? 'template-card current' : 
                                         item._type === 'original' ? 'template-card original' : 'template-card'
                        tableContent += `
                        <div class="${cardClass}">
                            <strong>${item.name}</strong> 
                            <code>${item.technical_code}</code><br>
                            <small>${item.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</small><br>
                            <em>–¢–∏–ø: ${item.system_type}</em>
                        </div>`
                    })
                    tableContent += '</div>'
                    content += tableContent
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
        }

        window.showCurrentTypes = async function() {
            logResult('üìã –¢–µ–∫—É—â–∏–µ —Ç–∏–ø—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...', 'info')
            
            try {
                const { data, error } = await supabase
                    .from('equipment_templates')
                    .select('*')
                    .order('name')
                
                if (error) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö —Ç–∏–ø–æ–≤', 'error', error)
                    return
                }
                
                const dataWithType = data.map(d => ({...d, _type: 'current'}))
                logResult(`‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ ${data?.length || 0} —Ç–µ–∫—É—â–∏—Ö —Ç–∏–ø–æ–≤ (–ù–ï –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ!)`, 'warning', dataWithType)
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', 'error', error)
            }
        }

        window.showOriginalTypes = function() {
            const dataWithType = originalTemplates.map(d => ({...d, _type: 'original'}))
            logResult('‚úÖ –ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ):', 'success', dataWithType)
        }

        window.restoreOriginalTypes = async function() {
            if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏ –∑–∞–º–µ–Ω–∏—Ç –∏—Ö –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–º–∏. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return
            }
            
            logResult('üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...', 'info')
            
            try {
                // –®–∞–≥ 1: –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –∑–∞–ø–∏—Å–∏
                logResult('üóëÔ∏è –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–∞–ø–∏—Å–∏...', 'warning')
                const { error: deleteError } = await supabase
                    .from('equipment_templates')
                    .delete()
                    .gte('created_at', '1900-01-01') // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
                
                if (deleteError) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error', deleteError)
                    return
                }
                
                // –®–∞–≥ 2: –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã
                logResult('‚ûï –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã...', 'info')
                let addedCount = 0
                const errors = []
                
                for (const template of originalTemplates) {
                    try {
                        // –°–æ–∑–¥–∞—ë–º –∫–æ–ø–∏—é —à–∞–±–ª–æ–Ω–∞ –±–µ–∑ allow_component_template_ids
                        const { allow_component_template_ids, ...templateWithoutIds } = template
                        
                        const { error } = await supabase
                            .from('equipment_templates')
                            .insert([templateWithoutIds])
                        
                        if (error) {
                            errors.push(`${template.name}: ${error.message}`)
                        } else {
                            addedCount++
                            logResult(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω: ${template.name}`, 'success')
                        }
                        
                    } catch (itemError) {
                        errors.push(`${template.name}: ${itemError.message}`)
                    }
                }
                
                logResult(`üéâ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ç–∏–ø–æ–≤: ${addedCount} –∏–∑ ${originalTemplates.length}`, 'success')
                
                if (errors.length > 0) {
                    logResult(`‚ö†Ô∏è –û—à–∏–±–∫–∏ (${errors.length}):`, 'warning', errors)
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                await showCurrentTypes()
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è', 'error', error)
            }
        }

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ —Å–ø–∏—Å–∫–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 500))
            await showCurrentTypes()
            showOriginalTypes()
        })
    </script>
</body>
</html>