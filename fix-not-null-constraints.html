<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ NOT NULL constraints</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #f5576c;
        }
        .sql-container {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .sql-container pre {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }
        .instruction {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .instruction h3 {
            margin-top: 0;
            color: #856404;
        }
        button {
            background: linear-gradient(135deg, #f5576c, #f093fb);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .error {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .error h3 {
            color: #c53030;
            margin-top: 0;
        }
        .success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .success h3 {
            color: #22543d;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å NOT NULL constraints</h1>
        
        <div class="error">
            <h3>‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞:</h3>
            <p><strong>–û—à–∏–±–∫–∞:</strong> <code>null value in column "system_type" violates not-null constraint</code></p>
            <p>–ö–æ–ª–æ–Ω–∫–∞ <code>system_type</code> –∏–º–µ–µ—Ç NOT NULL constraint, –Ω–æ –º—ã –ø—ã—Ç–∞–µ–º—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å NULL –∑–Ω–∞—á–µ–Ω–∏–µ.</p>
        </div>
        
        <div class="instruction">
            <h3>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é:</h3>
            <ol>
                <li><a href="https://supabase.com/dashboard/project/tohtryzyffcebtyvkxwh/sql/new" target="_blank">–û—Ç–∫—Ä–æ–π—Ç–µ SQL —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤ Supabase</a></li>
                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ SQL –∑–∞–ø—Ä–æ—Å –Ω–∏–∂–µ</li>
                <li>–í—ã–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ</li>
                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å"</li>
            </ol>
        </div>
        
        <div class="sql-container">
            <pre id="sqlCode">-- –£–±–∏—Ä–∞–µ–º NOT NULL constraint —Å system_type
ALTER TABLE equipment_templates 
ALTER COLUMN system_type DROP NOT NULL;

-- –£–±–∏—Ä–∞–µ–º NOT NULL —Å –¥—Ä—É–≥–∏—Ö –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫  
ALTER TABLE equipment_templates 
ALTER COLUMN technical_code DROP NOT NULL;

ALTER TABLE equipment_templates 
ALTER COLUMN description DROP NOT NULL;

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
SELECT 
    column_name, 
    data_type, 
    is_nullable
FROM information_schema.columns 
WHERE table_name = 'equipment_templates'
ORDER BY ordinal_position;</pre>
        </div>
        
        <button onclick="copySQL()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL</button>
        <button onclick="testInsert()">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å INSERT</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        window.copySQL = function() {
            const sqlCode = document.getElementById('sqlCode').textContent
            navigator.clipboard.writeText(sqlCode).then(() => {
                showResult('‚úÖ SQL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success')
            }).catch(err => {
                showResult('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err.message, 'error')
            })
        }
        
        window.testInsert = async function() {
            const testData = {
                name: `–¢–µ—Å—Ç ${Date.now()}`,
                // system_type –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ–º, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å NULL
            }
            
            try {
                const { data, error } = await supabase
                    .from('equipment_templates')
                    .insert([testData])
                    .select()
                
                if (error) {
                    showResult('‚ùå INSERT –≤—Å—ë –µ—â—ë –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ' + error.message, 'error')
                    
                    if (error.code === '23502') {
                        showResult('üí° NOT NULL constraint –≤—Å—ë –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å –≤—ã—à–µ.', 'error')
                    }
                } else {
                    showResult('‚úÖ INSERT —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞.', 'success')
                    showResult('–í—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', 'success', JSON.stringify(data[0], null, 2))
                    
                    // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
                    if (data && data[0]) {
                        await supabase
                            .from('equipment_templates')
                            .delete()
                            .eq('id', data[0].id)
                        showResult('üóëÔ∏è –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'success')
                    }
                }
            } catch (err) {
                showResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + err.message, 'error')
            }
        }
        
        function showResult(message, type, data = null) {
            const resultsDiv = document.getElementById('results')
            const resultDiv = document.createElement('div')
            resultDiv.className = type
            
            const timestamp = new Date().toLocaleTimeString()
            let content = `<h3>[${timestamp}] ${message}</h3>`
            
            if (data) {
                content += `<pre>${data}</pre>`
            }
            
            resultDiv.innerHTML = content
            resultsDiv.insertBefore(resultDiv, resultsDiv.firstChild)
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            setTimeout(testInsert, 1000)
        })
    </script>
</body>
</html>