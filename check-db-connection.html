<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1b23;
            color: white;
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #333; 
            border-radius: 8px;
            background: #2a2b35;
        }
        button { 
            background: #3b82f6; 
            color: white; 
            padding: 8px 16px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        .status { 
            display: inline-block; 
            padding: 6px 12px; 
            border-radius: 4px; 
            font-size: 14px;
            font-weight: 500;
            margin: 5px 0;
        }
        .connected { background: #059669; color: white; }
        .disconnected { background: #dc2626; color: white; }
        .warning { background: #f59e0b; color: white; }
        pre { 
            background: #1e293b; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: #1e293b;
            border: 1px solid #475569;
            color: white;
            border-radius: 4px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</h1>
    
    <div class="section">
        <h2>üìã –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage</h2>
        <div id="current-settings"></div>
        <button onclick="loadSettings()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button onclick="clearSettings()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div class="section">
        <h2>‚öôÔ∏è –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</h2>
        <div>
            <label>URL Supabase:</label>
            <input type="text" id="db-url" placeholder="https://your-project.supabase.co">
            
            <label>API Key (anon –∏–ª–∏ service role):</label>
            <input type="text" id="db-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            
            <button onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button onclick="loadExampleSettings()">üìù –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
        </div>
    </div>

    <div class="section">
        <h2>üß™ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
        <button onclick="testConnection()">üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        <button onclick="testSupabaseAuth()">üîê –¢–µ—Å—Ç Supabase Auth</button>
        <button onclick="testDatabaseTables()">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã</button>
        <div id="test-results"></div>
    </div>

    <div class="section">
        <h2>üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>
        <div id="diagnostic-results"></div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function loadSettings() {
            const settingsDiv = document.getElementById('current-settings');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–ª—é—á–∏
            const keys = ['externalDatabase', 'supabaseSettings', 'supabaseConfig'];
            let hasSettings = false;
            
            let html = '';
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    hasSettings = true;
                    try {
                        const parsed = JSON.parse(value);
                        html += `<h3>${key}:</h3><pre>${JSON.stringify(parsed, null, 2)}</pre>`;
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã –µ—Å–ª–∏ —ç—Ç–æ –≤–Ω–µ—à–Ω—è—è –ë–î
                        if (key === 'externalDatabase' && parsed.url && parsed.apiKey) {
                            document.getElementById('db-url').value = parsed.url;
                            document.getElementById('db-key').value = parsed.apiKey;
                        }
                    } catch (e) {
                        html += `<h3>${key}:</h3><pre class="error">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${value}</pre>`;
                    }
                } else {
                    html += `<p class="info">${key}: <span class="error">–Ω–µ –Ω–∞–π–¥–µ–Ω</span></p>`;
                }
            });
            
            if (!hasSettings) {
                html = '<p class="error">‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage!</p>';
                html += '<p class="info">–ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –Ω–∏–∂–µ –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫.</p>';
            }
            
            settingsDiv.innerHTML = html;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function saveSettings() {
            const url = document.getElementById('db-url').value;
            const key = document.getElementById('db-key').value;
            
            if (!url || !key) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }
            
            const settings = {
                url: url.trim(),
                apiKey: key.trim()
            };
            
            localStorage.setItem('externalDatabase', JSON.stringify(settings));
            
            // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∫–ª—é—á –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            localStorage.setItem('supabaseSettings', JSON.stringify({
                url: settings.url,
                key: settings.apiKey
            }));
            
            alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            loadSettings();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function loadExampleSettings() {
            document.getElementById('db-url').value = 'https://xruhwjidoccdxsgvllgh.supabase.co';
            document.getElementById('db-key').value = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhydWh3amlkb2NjZHhzZ3ZsbGdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczMzQ5NzU5OSwiZXhwIjoyMDQ5MDczNTk5fQ.vdW70KROozrrh5zHie3wH7xjR0xnqHyOa4U6h1GQOEY';
        }

        // –û—á–∏—Å—Ç–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function clearSettings() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?')) {
                localStorage.removeItem('externalDatabase');
                localStorage.removeItem('supabaseSettings');
                localStorage.removeItem('supabaseConfig');
                loadSettings();
            }
        }

        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function testConnection() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p class="info">üîÑ –¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>';
            
            const settings = localStorage.getItem('externalDatabase');
            if (!settings) {
                resultsDiv.innerHTML = '<p class="error">‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã! –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</p>';
                return;
            }
            
            try {
                const parsed = JSON.parse(settings);
                const startTime = Date.now();
                
                // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ Supabase
                const response = await fetch(`${parsed.url}/rest/v1/`, {
                    method: 'GET',
                    headers: {
                        'apikey': parsed.apiKey,
                        'Authorization': `Bearer ${parsed.apiKey}`
                    }
                });
                
                const latency = Date.now() - startTime;
                
                if (response.ok) {
                    resultsDiv.innerHTML = `
                        <div class="status connected">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!</div>
                        <p>–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞: ${latency}ms</p>
                        <p>–°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}</p>
                    `;
                } else {
                    const errorText = await response.text();
                    resultsDiv.innerHTML = `
                        <div class="status disconnected">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                        <p>–°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}</p>
                        <pre class="error">${errorText}</pre>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="status disconnected">‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</div>
                    <pre class="error">${error.message}</pre>
                    <p class="info">–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</p>
                    <ul>
                        <li>–ù–µ–≤–µ—Ä–Ω—ã–π URL –∏–ª–∏ API –∫–ª—é—á</li>
                        <li>CORS –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–Ω—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω)</li>
                        <li>–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é</li>
                    </ul>
                `;
            }
        }

        // –¢–µ—Å—Ç Supabase Auth
        async function testSupabaseAuth() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p class="info">üîÑ –ü—Ä–æ–≤–µ—Ä—è—é Supabase Auth...</p>';
            
            const settings = localStorage.getItem('externalDatabase');
            if (!settings) {
                resultsDiv.innerHTML = '<p class="error">‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!</p>';
                return;
            }
            
            try {
                const parsed = JSON.parse(settings);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–ª—é—á–∞
                const keyParts = parsed.apiKey.split('.');
                if (keyParts.length === 3) {
                    const payload = JSON.parse(atob(keyParts[1]));
                    resultsDiv.innerHTML = `
                        <div class="status connected">üîê JWT –∫–ª—é—á –≤–∞–ª–∏–¥–µ–Ω</div>
                        <p>–†–æ–ª—å: ${payload.role}</p>
                        <p>–ü—Ä–æ–µ–∫—Ç: ${payload.ref}</p>
                        <p>–í—ã–¥–∞–Ω: ${new Date(payload.iat * 1000).toLocaleString()}</p>
                        <p>–ò—Å—Ç–µ–∫–∞–µ—Ç: ${new Date(payload.exp * 1000).toLocaleString()}</p>
                    `;
                } else {
                    resultsDiv.innerHTML = '<p class="error">‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç API –∫–ª—é—á–∞</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–ª—é—á–∞: ${error.message}</p>`;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü
        async function testDatabaseTables() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p class="info">üîÑ –ü—Ä–æ–≤–µ—Ä—è—é —Ç–∞–±–ª–∏—Ü—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...</p>';
            
            const settings = localStorage.getItem('externalDatabase');
            if (!settings) {
                resultsDiv.innerHTML = '<p class="error">‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!</p>';
                return;
            }
            
            try {
                const parsed = JSON.parse(settings);
                const tables = ['users', 'roles', 'user_roles', 'permissions', 'role_permissions'];
                let html = '<h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü:</h3>';
                
                for (const table of tables) {
                    try {
                        const response = await fetch(`${parsed.url}/rest/v1/${table}?limit=1`, {
                            method: 'GET',
                            headers: {
                                'apikey': parsed.apiKey,
                                'Authorization': `Bearer ${parsed.apiKey}`,
                                'Prefer': 'count=exact'
                            }
                        });
                        
                        if (response.ok) {
                            const count = response.headers.get('content-range');
                            html += `<p class="success">‚úÖ ${table}: –¥–æ—Å—Ç—É–ø–Ω–∞ ${count ? `(${count})` : ''}</p>`;
                        } else {
                            html += `<p class="error">‚ùå ${table}: ${response.status} ${response.statusText}</p>`;
                        }
                    } catch (error) {
                        html += `<p class="error">‚ùå ${table}: ${error.message}</p>`;
                    }
                }
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }

        // –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        async function runDiagnostics() {
            const diagDiv = document.getElementById('diagnostic-results');
            let html = '<h3>–î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:</h3>';
            
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage
            html += '<h4>1. LocalStorage:</h4>';
            const hasExternalDb = localStorage.getItem('externalDatabase') !== null;
            const hasSupabaseSettings = localStorage.getItem('supabaseSettings') !== null;
            
            html += `<p>externalDatabase: ${hasExternalDb ? '‚úÖ' : '‚ùå'}</p>`;
            html += `<p>supabaseSettings: ${hasSupabaseSettings ? '‚úÖ' : '‚ùå'}</p>`;
            
            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            if (hasExternalDb) {
                try {
                    const settings = JSON.parse(localStorage.getItem('externalDatabase'));
                    html += '<h4>2. –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:</h4>';
                    html += `<p>URL: ${settings.url ? '‚úÖ' : '‚ùå'} ${settings.url || '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>`;
                    html += `<p>API Key: ${settings.apiKey ? '‚úÖ' : '‚ùå'} ${settings.apiKey ? '(—Å–∫—Ä—ã—Ç)' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>`;
                    
                    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ URL
                    if (settings.url) {
                        const urlValid = settings.url.startsWith('https://') && settings.url.includes('supabase.co');
                        html += `<p>–§–æ—Ä–º–∞—Ç URL: ${urlValid ? '‚úÖ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π' : '‚ö†Ô∏è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç'}</p>`;
                    }
                } catch (e) {
                    html += `<p class="error">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${e.message}</p>`;
                }
            }
            
            // 4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            html += '<h4>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h4>';
            if (!hasExternalDb) {
                html += '<p class="warning">‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—ã—à–µ</p>';
            }
            
            diagDiv.innerHTML = html;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadSettings();
        runDiagnostics();
    </script>
</body>
</html>