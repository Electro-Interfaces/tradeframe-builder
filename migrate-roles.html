<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë• –ú–∏–≥—Ä–∞—Ü–∏—è —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button.danger { background: #dc3545; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 11px; max-height: 300px; }
        .role-card { border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px; }
        .permission { background: #e9ecef; margin: 2px; padding: 3px 8px; border-radius: 3px; display: inline-block; font-size: 11px; }
    </style>
</head>
<body>
    <h1>üë• –ú–∏–≥—Ä–∞—Ü–∏—è —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ localStorage –≤ Supabase</h1>
    
    <div class="section info">
        <h3>üìã –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä–æ–ª–µ–π:</h3>
        <ol>
            <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–æ–ª–µ–π –≤ localStorage</li>
            <li>–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É roles –≤ Supabase (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)</li>
            <li>–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª–∏ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö</li>
            <li>–û–±–Ω–æ–≤–∏—Ç—å roleService.ts –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase</li>
        </ol>
    </div>
    
    <div class="section">
        <button onclick="checkLocalStorageRoles()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª–∏ –≤ localStorage</button>
        <button onclick="checkSupabaseRolesTable()">üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É roles</button>
        <button onclick="createRolesTable()">üîß –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É roles</button>
        <button onclick="migrateRoles()" class="success">‚¨ÜÔ∏è –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª–∏</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (typeof data === 'string') {
                    content += `<pre>${data}</pre>`
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
        }

        window.checkLocalStorageRoles = async function() {
            logResult('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª–∏ –≤ localStorage...', 'info')
            
            try {
                const rolesData = localStorage.getItem('tradeframe_roles')
                
                if (!rolesData) {
                    logResult('‚ùå –†–æ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage', 'error')
                    return
                }
                
                let parsed = JSON.parse(rolesData)
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã {data: [...]}
                if (parsed && parsed.data && Array.isArray(parsed.data)) {
                    parsed = parsed.data
                }
                
                if (!Array.isArray(parsed)) {
                    logResult('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π', 'error', parsed)
                    return
                }
                
                logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${parsed.length} —Ä–æ–ª–µ–π`, 'success')
                
                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–æ–ª–µ–π
                const rolesAnalysis = parsed.map(role => ({
                    id: role.id,
                    code: role.code,
                    name: role.name,
                    description: role.description,
                    permissions_count: role.permissions?.length || 0,
                    scope: role.scope,
                    scope_values: role.scope_values?.length || 0,
                    is_system: role.is_system,
                    is_active: role.is_active
                }))
                
                logResult('üìä –ê–Ω–∞–ª–∏–∑ —Ä–æ–ª–µ–π:', 'info', rolesAnalysis)
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–µ—Ä–≤–æ–π —Ä–æ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                if (parsed.length > 0) {
                    logResult('üîç –ü—Ä–∏–º–µ—Ä —Ä–æ–ª–∏ (–ø–µ—Ä–≤–∞—è):', 'info', parsed[0])
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ localStorage', 'error', error)
            }
        }

        window.checkSupabaseRolesTable = async function() {
            logResult('üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É roles –≤ Supabase...', 'info')
            
            try {
                const { data, error } = await supabase
                    .from('roles')
                    .select('*')
                    .limit(5)
                
                if (error) {
                    logResult('‚ùå –¢–∞–±–ª–∏—Ü–∞ roles –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error', error)
                    return
                }
                
                logResult(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ roles —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ù–∞–π–¥–µ–Ω–æ ${data?.length || 0} –∑–∞–ø–∏—Å–µ–π`, 'success', data)
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–±–ª–∏—Ü—ã roles', 'error', error)
            }
        }

        window.createRolesTable = async function() {
            logResult('üîß –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã roles –≤ Supabase...', 'warning')
            
            const createTableSQL = `
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã roles –¥–ª—è —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE IF NOT EXISTS roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id VARCHAR(100) DEFAULT 'default',
    code VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    permissions JSONB DEFAULT '[]'::jsonb,
    scope VARCHAR(20) DEFAULT 'global' CHECK (scope IN ('global', 'network', 'point')),
    scope_values TEXT[], -- –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π –æ–±–ª–∞—Å—Ç–∏ (ID —Å–µ—Ç–µ–π/—Ç–æ—á–µ–∫)
    is_system BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    deleted_at TIMESTAMPTZ,
    version INTEGER DEFAULT 1
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX IF NOT EXISTS idx_roles_code ON roles(code);
CREATE INDEX IF NOT EXISTS idx_roles_tenant_id ON roles(tenant_id);
CREATE INDEX IF NOT EXISTS idx_roles_is_active ON roles(is_active);
CREATE INDEX IF NOT EXISTS idx_roles_scope ON roles(scope);
CREATE INDEX IF NOT EXISTS idx_roles_deleted_at ON roles(deleted_at);

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç–∞–±–ª–∏—Ü–µ
COMMENT ON TABLE roles IS '–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≥—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏';
COMMENT ON COLUMN roles.code IS '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ —Ä–æ–ª–∏';
COMMENT ON COLUMN roles.name IS '–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è —Ä–æ–ª–∏';
COMMENT ON COLUMN roles.permissions IS '–ú–∞—Å—Å–∏–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON';
COMMENT ON COLUMN roles.scope IS '–û–±–ª–∞—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—è —Ä–æ–ª–∏ (global, network, point)';
COMMENT ON COLUMN roles.scope_values IS '–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏ (ID —Å–µ—Ç–µ–π/—Ç–æ—á–µ–∫)';
COMMENT ON COLUMN roles.is_system IS '–°–∏—Å—Ç–µ–º–Ω–∞—è —Ä–æ–ª—å (–Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å)';
COMMENT ON COLUMN roles.version IS '–í–µ—Ä—Å–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏';

-- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ RLS –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
ALTER TABLE roles DISABLE ROW LEVEL SECURITY;
            `
            
            logResult('üìù SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã roles:', 'info', createTableSQL)
            logResult('‚ö†Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL –≤ Supabase SQL Editor –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã', 'warning')
        }

        window.migrateRoles = async function() {
            logResult('‚¨ÜÔ∏è –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Ä–æ–ª–µ–π...', 'info')
            
            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
                const rolesData = localStorage.getItem('tradeframe_roles')
                if (!rolesData) {
                    logResult('‚ùå –†–æ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage', 'error')
                    return
                }
                
                let localStorageData = JSON.parse(rolesData)
                if (localStorageData && localStorageData.data && Array.isArray(localStorageData.data)) {
                    localStorageData = localStorageData.data
                }
                
                logResult(`üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ ${localStorageData.length} —Ä–æ–ª–µ–π...`, 'info')
                
                let migratedCount = 0
                const errors = []
                
                // 2. –ú–∏–≥—Ä–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Ä–æ–ª—å
                for (const role of localStorageData) {
                    try {
                        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
                        const roleRecord = {
                            id: crypto.randomUUID(), // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π UUID
                            tenant_id: role.tenant_id || 'default',
                            code: role.code,
                            name: role.name,
                            description: role.description || null,
                            permissions: role.permissions || [],
                            scope: role.scope || 'global',
                            scope_values: role.scope_values || null,
                            is_system: role.is_system || false,
                            is_active: role.is_active !== false, // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true
                            created_at: role.created_at ? new Date(role.created_at) : new Date(),
                            updated_at: role.updated_at ? new Date(role.updated_at) : new Date(),
                            deleted_at: role.deleted_at ? new Date(role.deleted_at) : null,
                            version: role.version || 1
                        }
                        
                        // –í—Å—Ç–∞–≤–ª—è–µ–º —Ä–æ–ª—å
                        const { data: insertedRole, error: roleError } = await supabase
                            .from('roles')
                            .insert([roleRecord])
                            .select()
                        
                        if (roleError) {
                            errors.push(`–û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —Ä–æ–ª–∏ ${role.name}: ${roleError.message}`)
                            continue
                        }
                        
                        logResult(`‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Ä–æ–ª—å: ${role.name} (${role.code})`, 'success')
                        migratedCount++
                        
                    } catch (itemError) {
                        errors.push(`–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä–æ–ª–∏ ${role.name}: ${itemError.message}`)
                    }
                }
                
                // –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
                logResult(`üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —Ä–æ–ª–µ–π: ${migratedCount}`, 'success')
                
                if (errors.length > 0) {
                    logResult(`‚ö†Ô∏è –û—à–∏–±–∫–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (${errors.length}):`, 'warning', errors)
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const { data: finalData, error: checkError } = await supabase
                    .from('roles')
                    .select('id, code, name, scope, is_system, is_active')
                    .order('name')
                
                if (!checkError) {
                    logResult(`üìä –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã roles (${finalData.length} –∑–∞–ø–∏—Å–µ–π):`, 'info', finalData)
                }
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏', 'error', error)
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 500))
            await checkLocalStorageRoles()
        })
    </script>
</body>
</html>