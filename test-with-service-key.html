<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Test with Service Role Key</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff; 
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { 
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px; 
            border-radius: 15px; 
            margin: 15px 0; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .warning-container { 
            background: rgba(183, 121, 31, 0.3);
            border: 2px solid #ed8936;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #ed8936, #f6ad55);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        button { 
            background: linear-gradient(45deg, #ed8936, #f6ad55);
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(237, 137, 54, 0.4);
        }
        button.success { background: linear-gradient(45deg, #48bb78, #68d391); }
        button.error { background: linear-gradient(45deg, #f56565, #fc8181); }
        .log { 
            background: rgba(0, 0, 0, 0.8);
            padding: 20px; 
            border-radius: 10px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            white-space: pre-wrap; 
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            border-left: 4px solid #ed8936;
        }
        .success { color: #68d391; font-weight: 600; }
        .error { color: #fc8181; font-weight: 600; }
        .warning { color: #f6ad55; font-weight: 600; }
        .info { color: #90cdf4; }
        .key-input {
            width: 100%;
            padding: 15px;
            background: #4a5568;
            border: 2px solid #ed8936;
            border-radius: 8px;
            color: #fff;
            margin: 10px 0;
            font-family: monospace;
        }
        .warning-box {
            background: rgba(237, 137, 54, 0.2);
            border: 1px solid #ed8936;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê Test with Service Role Key</h1>
        <p>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ - –æ–±—Ö–æ–¥–∏—Ç –≤—Å–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏</p>
    </div>

    <div class="container warning-container">
        <h3>‚ö†Ô∏è –í–ê–ñ–ù–û: Service Role Key</h3>
        <div class="warning-box">
            <strong>üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:</strong><br>
            ‚Ä¢ Service Role Key –æ–±—Ö–æ–¥–∏—Ç –í–°–ï –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏<br>
            ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–õ–¨–ö–û –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ<br>
            ‚Ä¢ –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ –≤ production –∫–æ–¥<br>
            ‚Ä¢ –ù–µ –¥–µ–ª–∏—Ç–µ—Å—å –∫–ª—é—á–æ–º –ø—É–±–ª–∏—á–Ω–æ<br>
        </div>
        
        <label><strong>–í—Å—Ç–∞–≤—å—Ç–µ Service Role Key:</strong></label>
        <input type="password" id="service-key" class="key-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à service_role key...">
        <button onclick="saveServiceKey()">üíæ Save Key</button>
    </div>

    <div class="container">
        <h3>üß™ Basic Test</h3>
        <button onclick="testServiceConnection()">Test Service Connection</button>
        <div id="connection-result" class="log"></div>
    </div>

    <div class="container">
        <h3>üîß Full CRUD Test</h3>
        <button onclick="testFullCRUD()">Test Complete CRUD</button>
        <div id="crud-result" class="log"></div>
    </div>

    <div class="container">
        <h3>üöÄ All APIs Test</h3>
        <button onclick="testAllAPIs()">Test All Database APIs</button>
        <div id="all-result" class="log"></div>
    </div>

    <div class="container">
        <h3>‚ö° Performance Test</h3>
        <button onclick="testPerformance()">Test API Performance</button>
        <div id="performance-result" class="log"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        let SERVICE_KEY = '';
        
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            container.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            container.scrollTop = container.scrollHeight;
        }

        function saveServiceKey() {
            const key = document.getElementById('service-key').value.trim();
            if (!key) {
                alert('Please enter a service key');
                return;
            }
            
            SERVICE_KEY = key;
            alert('‚úÖ Service key saved! Now you can run tests.');
        }

        async function testServiceConnection() {
            const container = document.getElementById('connection-result');
            container.innerHTML = '';
            
            if (!SERVICE_KEY) {
                log('connection-result', '‚ùå Please enter service key first!', 'error');
                return;
            }
            
            log('connection-result', 'üîê Testing with Service Role Key...', 'info');
            log('connection-result', '‚ö†Ô∏è Service key bypasses ALL security!', 'warning');

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`
                    }
                });

                log('connection-result', `Response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    log('connection-result', 'üéâ SUCCESS! Service key working perfectly!', 'success');
                    log('connection-result', 'üîì Full database access granted!', 'success');
                } else {
                    const errorText = await response.text();
                    log('connection-result', `‚ùå Error: ${errorText}`, 'error');
                }

            } catch (error) {
                log('connection-result', `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function testFullCRUD() {
            const container = document.getElementById('crud-result');
            container.innerHTML = '';
            
            if (!SERVICE_KEY) {
                log('crud-result', '‚ùå Please enter service key first!', 'error');
                return;
            }

            const testId = 'service-test-' + Date.now();
            
            log('crud-result', 'üîß Testing COMPLETE CRUD with Service Key...', 'info');
            log('crud-result', 'üîì No RLS restrictions - full access!', 'warning');

            try {
                // CREATE
                log('crud-result', '1. Testing CREATE...', 'info');
                const createResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment_templates`, {
                    method: 'POST',
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        id: testId,
                        name: 'Service Key Test Template',
                        technical_code: 'SERVICE_TEST_' + Date.now(),
                        system_type: 'test',
                        status: true,
                        description: 'Created with unrestricted service key access!'
                    })
                });

                if (createResponse.ok) {
                    const data = await createResponse.json();
                    log('crud-result', '‚úÖ CREATE: Success!', 'success');
                } else {
                    const errorText = await createResponse.text();
                    log('crud-result', `‚ùå CREATE failed: ${createResponse.status} - ${errorText}`, 'error');
                }

                // READ
                log('crud-result', '2. Testing READ...', 'info');
                const readResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment_templates?id=eq.${testId}`, {
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`
                    }
                });

                if (readResponse.ok) {
                    const data = await readResponse.json();
                    log('crud-result', `‚úÖ READ: Found ${data.length} record(s)`, 'success');
                } else {
                    log('crud-result', `‚ùå READ failed: ${readResponse.status}`, 'error');
                }

                // UPDATE  
                log('crud-result', '3. Testing UPDATE...', 'info');
                const updateResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment_templates?id=eq.${testId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: 'Updated with service key - unrestricted access!'
                    })
                });

                if (updateResponse.ok) {
                    log('crud-result', '‚úÖ UPDATE: Success!', 'success');
                } else {
                    log('crud-result', `‚ùå UPDATE failed: ${updateResponse.status}`, 'error');
                }

                // DELETE
                log('crud-result', '4. Testing DELETE...', 'info');
                const deleteResponse = await fetch(`${SUPABASE_URL}/rest/v1/equipment_templates?id=eq.${testId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`
                    }
                });

                if (deleteResponse.ok) {
                    log('crud-result', '‚úÖ DELETE: Success!', 'success');
                } else {
                    log('crud-result', `‚ùå DELETE failed: ${deleteResponse.status}`, 'error');
                }

                log('crud-result', '\nüéâ CRUD TEST COMPLETE!', 'success');
                log('crud-result', 'üîì Service key provides unrestricted access!', 'warning');

            } catch (error) {
                log('crud-result', `‚ùå CRUD Error: ${error.message}`, 'error');
            }
        }

        async function testAllAPIs() {
            const container = document.getElementById('all-result');
            container.innerHTML = '';
            
            if (!SERVICE_KEY) {
                log('all-result', '‚ùå Please enter service key first!', 'error');
                return;
            }

            log('all-result', 'üöÄ Testing ALL database APIs with Service Key...', 'info');

            const endpoints = [
                { name: 'Equipment Templates', url: '/rest/v1/equipment_templates?limit=5' },
                { name: 'Equipment', url: '/rest/v1/equipment?limit=5' },
                { name: 'Equipment Events', url: '/rest/v1/equipment_events?limit=5' },
                { name: 'Equipment Log', url: '/rest/v1/equipment_log?limit=5' },
                { name: 'Networks', url: '/rest/v1/networks?limit=5' },
                { name: 'Trading Points', url: '/rest/v1/trading_points?limit=5' },
                { name: 'Operations', url: '/rest/v1/operations?limit=5' },
                { name: 'Nomenclature', url: '/rest/v1/nomenclature?limit=5' },
                { name: 'Users', url: '/rest/v1/users?limit=5' },
                { name: 'Roles', url: '/rest/v1/roles?limit=5' },
                { name: 'Fuel Types', url: '/rest/v1/fuel_types?limit=5' },
                { name: 'Fuel Stocks', url: '/rest/v1/fuel_stocks?limit=5' },
                { name: 'Tanks', url: '/rest/v1/tanks?limit=5' },
                { name: 'Components', url: '/rest/v1/components?limit=5' },
                { name: 'Document Types', url: '/rest/v1/document_types?limit=5' }
            ];

            let successCount = 0;
            let totalTime = 0;

            for (const endpoint of endpoints) {
                try {
                    const startTime = Date.now();
                    
                    const response = await fetch(`${SUPABASE_URL}${endpoint.url}`, {
                        headers: {
                            'apikey': SERVICE_KEY,
                            'Authorization': `Bearer ${SERVICE_KEY}`
                        }
                    });

                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    totalTime += duration;

                    if (response.ok) {
                        const data = await response.json();
                        log('all-result', `‚úÖ ${endpoint.name}: ${Array.isArray(data) ? data.length : 'N/A'} records (${duration}ms)`, 'success');
                        successCount++;
                    } else {
                        log('all-result', `‚ùå ${endpoint.name}: ${response.status} (${duration}ms)`, 'error');
                    }

                } catch (error) {
                    log('all-result', `‚ùå ${endpoint.name}: ${error.message}`, 'error');
                }
            }

            const successRate = (successCount / endpoints.length) * 100;
            const avgTime = totalTime / endpoints.length;
            
            log('all-result', `\nüéØ FINAL RESULT: ${successRate.toFixed(1)}% (${successCount}/${endpoints.length})`, 
                successRate >= 80 ? 'success' : 'warning');
            log('all-result', `‚ö° Average response time: ${avgTime.toFixed(0)}ms`, 'info');

            if (successRate >= 90) {
                log('all-result', 'üéâ EXCELLENT! Service key provides full access!', 'success');
                log('all-result', 'üîì All tables accessible without restrictions!', 'success');
            }
        }

        async function testPerformance() {
            const container = document.getElementById('performance-result');
            container.innerHTML = '';
            
            if (!SERVICE_KEY) {
                log('performance-result', '‚ùå Please enter service key first!', 'error');
                return;
            }

            log('performance-result', '‚ö° Testing API performance with Service Key...', 'info');

            const tests = [
                { name: 'Small query (limit 1)', url: '/rest/v1/equipment_templates?limit=1' },
                { name: 'Medium query (limit 10)', url: '/rest/v1/operations?limit=10' },
                { name: 'Large query (limit 100)', url: '/rest/v1/nomenclature?limit=100' },
                { name: 'Complex query', url: '/rest/v1/equipment_templates?select=*,system_type&order=name' },
                { name: 'Filtered query', url: '/rest/v1/operations?fuel_type=eq.–ê–ò-95&limit=10' }
            ];

            let totalTime = 0;
            let successCount = 0;

            for (const test of tests) {
                try {
                    const startTime = Date.now();
                    
                    const response = await fetch(`${SUPABASE_URL}${test.url}`, {
                        headers: {
                            'apikey': SERVICE_KEY,
                            'Authorization': `Bearer ${SERVICE_KEY}`
                        }
                    });

                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    totalTime += duration;

                    if (response.ok) {
                        const data = await response.json();
                        const size = Array.isArray(data) ? data.length : 1;
                        log('performance-result', `‚úÖ ${test.name}: ${duration}ms (${size} records)`, 'success');
                        successCount++;
                    } else {
                        log('performance-result', `‚ùå ${test.name}: ${response.status} (${duration}ms)`, 'error');
                    }

                } catch (error) {
                    log('performance-result', `‚ùå ${test.name}: ${error.message}`, 'error');
                }
            }

            const avgTime = totalTime / tests.length;
            log('performance-result', `\nüìä Performance Summary:`, 'info');
            log('performance-result', `‚ö° Total time: ${totalTime}ms`, 'info');
            log('performance-result', `üìà Average time: ${avgTime.toFixed(0)}ms per query`, 'info');
            log('performance-result', `‚úÖ Success rate: ${successCount}/${tests.length}`, successCount === tests.length ? 'success' : 'warning');

            if (avgTime < 500) {
                log('performance-result', 'üöÄ EXCELLENT performance!', 'success');
            } else if (avgTime < 1000) {
                log('performance-result', '‚úÖ Good performance', 'success');
            } else {
                log('performance-result', '‚ö†Ô∏è Slow performance - check network', 'warning');
            }
        }
    </script>
</body>
</html>