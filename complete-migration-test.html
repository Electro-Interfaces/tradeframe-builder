<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <h1>üîß –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Supabase</h1>
    
    <div class="section info">
        <h3>–ü–ª–∞–Ω –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:</h3>
        <ol>
            <li>‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase</li>
            <li>üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ networks</li>
            <li>üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å localStorage</li>
            <li>üîÑ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ç–æ–ª—å–∫–æ –∏–∑ Supabase</li>
            <li>üéØ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ external_id –≤ UI</li>
        </ol>
    </div>

    <div class="section">
        <button onclick="runFullDiagnostic()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
        <button onclick="clearAllLocalStorage()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å localStorage</button>
        <button onclick="testSupabaseOnly()">üîÑ –¢–µ—Å—Ç —Ç–æ–ª—å–∫–æ Supabase</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏–∑ .env)
        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (typeof data === 'object' && Array.isArray(data)) {
                    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –º–∞—Å—Å–∏–≤–æ–≤
                    if (data.length > 0) {
                        const keys = Object.keys(data[0])
                        content += `
                            <table>
                                <thead><tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr></thead>
                                <tbody>
                                    ${data.map(row => `<tr>${keys.map(k => `<td>${row[k] || '‚Äî'}</td>`).join('')}</tr>`).join('')}
                                </tbody>
                            </table>
                        `
                    }
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
            console.log(message, data)
        }

        window.runFullDiagnostic = async function() {
            document.getElementById('results').innerHTML = ''
            
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            logResult('üîå –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase...', 'info')
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
                const { data: testConnection, error: connError } = await supabase
                    .from('networks')
                    .select('id')
                    .limit(1)
                
                if (connError) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase', 'error', connError)
                    return
                } else {
                    logResult('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success', { message: 'Connection successful' })
                }
            } catch (error) {
                logResult('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error', error)
                return
            }

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            logResult('üìä –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ networks...', 'info')
            
            try {
                const { data: networks, error } = await supabase
                    .from('networks')
                    .select('*')
                    .order('name')
                
                if (error) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ networks', 'error', error)
                } else if (!networks || networks.length === 0) {
                    logResult('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ networks –ø—É—Å—Ç–∞!', 'warning', '–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ')
                } else {
                    logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${networks.length} —Å–µ—Ç–µ–π –≤ Supabase`, 'success', networks)
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º external_id
                    const withExternalId = networks.filter(n => n.external_id)
                    const withoutExternalId = networks.filter(n => !n.external_id)
                    
                    if (withExternalId.length > 0) {
                        logResult(`‚úÖ –°–µ—Ç–∏ —Å external_id: ${withExternalId.length}`, 'success', withExternalId.map(n => ({name: n.name, external_id: n.external_id})))
                    }
                    
                    if (withoutExternalId.length > 0) {
                        logResult(`‚ö†Ô∏è –°–µ—Ç–∏ –ë–ï–ó external_id: ${withoutExternalId.length}`, 'warning', withoutExternalId.map(n => ({name: n.name, external_id: '–ü–£–°–¢–û'})))
                    }
                }
            } catch (error) {
                logResult('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error', error)
            }

            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage
            logResult('üîç –®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑ localStorage...', 'info')
            
            const storageKeys = Object.keys(localStorage)
            const networkKeys = storageKeys.filter(k => k.includes('network') || k.includes('Network'))
            
            if (networkKeys.length > 0) {
                logResult(`‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –æ—Å—Ç–∞—Ç–∫–∏ networks –≤ localStorage: ${networkKeys.length}`, 'warning', networkKeys)
                networkKeys.forEach(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key))
                        logResult(`üì¶ ${key}:`, 'info', data)
                    } catch (e) {
                        logResult(`üì¶ ${key}: ${localStorage.getItem(key)}`, 'info')
                    }
                })
            } else {
                logResult('‚úÖ localStorage —á–∏—Å—Ç –æ—Ç networks –¥–∞–Ω–Ω—ã—Ö', 'success')
            }

            // 4. –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            logResult('üìã –®–∞–≥ 4: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏', 'info')
            
            const recommendations = []
            
            if (!networks || networks.length === 0) {
                recommendations.push('‚ùå –ö–†–ò–¢–ò–ß–ù–û: –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É networks')
            }
            
            if (networks && networks.some(n => !n.external_id)) {
                recommendations.push('‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å external_id –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ç–µ–π')
            }
            
            if (networkKeys.length > 0) {
                recommendations.push('üßπ –û—á–∏—Å—Ç–∏—Ç—å localStorage –æ—Ç —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö')
            }
            
            if (recommendations.length === 0) {
                logResult('üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞! –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã', 'success')
            } else {
                logResult('üìù –¢—Ä–µ–±—É—é—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—è:', 'warning', recommendations)
            }
        }

        window.clearAllLocalStorage = function() {
            const before = Object.keys(localStorage).length
            localStorage.clear()
            const after = Object.keys(localStorage).length
            
            logResult(`üßπ localStorage –æ—á–∏—â–µ–Ω: –±—ã–ª–æ ${before} –∫–ª—é—á–µ–π, —Å—Ç–∞–ª–æ ${after}`, 'success')
            
            setTimeout(() => {
                location.reload()
            }, 2000)
        }

        window.testSupabaseOnly = async function() {
            logResult('üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¢–û–õ–¨–ö–û –∏–∑ Supabase...', 'info')
            
            try {
                // –ò–º–∏—Ç–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É networksService
                const { data, error } = await supabase
                    .from('networks')
                    .select('id, name, description, code, status, external_id, settings, created_at, updated_at')
                    .order('name')
                
                if (error) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ Supabase', 'error', error)
                    return
                }

                if (!data || data.length === 0) {
                    logResult('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Supabase', 'warning')
                    return
                }

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–∞–∫ –≤ networksService
                const networks = data.map(row => ({
                    id: row.id,
                    external_id: row.external_id,
                    name: row.name,
                    description: row.description || '',
                    type: '–ê–ó–°',
                    pointsCount: 0,
                    code: row.code,
                    status: row.status,
                    settings: row.settings,
                    created_at: row.created_at,
                    updated_at: row.updated_at
                }))

                logResult(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${networks.length} —Å–µ—Ç–µ–π –∏–∑ Supabase`, 'success', networks)
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ
                const tableData = networks.map(n => ({
                    '–ù–∞–∑–≤–∞–Ω–∏–µ': n.name,
                    'API ID': n.external_id || '‚Äî',
                    'UUID': n.id.substring(0, 8) + '...',
                    '–°—Ç–∞—Ç—É—Å': n.status,
                    '–ö–æ–¥': n.code
                }))
                
                logResult('üìä –ö–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ:', 'info', tableData)
                
            } catch (error) {
                logResult('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error', error)
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runFullDiagnostic, 1000)
        })
    </script>
</body>
</html>