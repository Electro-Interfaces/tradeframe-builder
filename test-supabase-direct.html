<!DOCTYPE html>
<html>
<head>
    <title>Test Supabase Direct Connection</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1e293b; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .stats { background: #0f172a; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #fbbf24; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        .operations-list { background: #0f172a; padding: 15px; border-radius: 8px; margin: 10px 0; max-height: 400px; overflow-y: auto; }
        .operation-item { background: #374151; margin: 5px 0; padding: 10px; border-radius: 4px; font-size: 14px; }
        pre { background: #1e293b; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Supabase Direct Connection</h1>
        
        <button onclick="testConnection()">1. –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
        <button onclick="testOperationsQuery()">2. –¢–µ—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –æ–ø–µ—Ä–∞—Ü–∏–π</button>
        <button onclick="testApiConfig()">3. –¢–µ—Å—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ API</button>
        <button onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        
        <div class="stats" id="stats">
            <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∞
        </div>
        
        <div class="operations-list" id="operations">
            <strong>–î–µ—Ç–∞–ª–∏:</strong> –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            },
            db: {
                schema: 'public'
            }
        });
        
        function logResult(status, title, message, details = null) {
            const statusDiv = document.getElementById('stats');
            const detailsDiv = document.getElementById('operations');
            
            statusDiv.innerHTML = `<span class="${status}">${title}</span><br>${message}`;
            
            if (details) {
                detailsDiv.innerHTML = `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
        }
        
        async function testConnection() {
            console.log('üß™ Testing Supabase connection...');
            logResult('warning', '‚è≥ –¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase');
            
            try {
                const { data, error, count } = await supabaseClient
                    .from('operations')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                logResult('success', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!', `–ù–∞–π–¥–µ–Ω–æ ${count} –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö`, {
                    count,
                    connectionUrl: SUPABASE_URL,
                    timestamp: new Date().toISOString()
                });
                
            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
                logResult('error', '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', error.message, {
                    error: error,
                    url: SUPABASE_URL
                });
            }
        }
        
        async function testOperationsQuery() {
            console.log('üß™ Testing operations query...');
            logResult('warning', '‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –æ–ø–µ—Ä–∞—Ü–∏–∏...', '–ó–∞–ø—Ä–æ—Å –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ Supabase');
            
            try {
                const { data, error } = await supabaseClient
                    .from('operations')
                    .select('*')
                    .limit(5);
                
                if (error) {
                    throw error;
                }
                
                logResult('success', '‚úÖ –û–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', `–ü–æ–ª—É—á–µ–Ω–æ ${data.length} –æ–ø–µ—Ä–∞—Ü–∏–π`, {
                    count: data.length,
                    operations: data.map(op => ({
                        id: op.id,
                        operation_type: op.operation_type,
                        status: op.status,
                        trading_point_name: op.trading_point_name,
                        fuel_type: op.fuel_type,
                        total_cost: op.total_cost
                    }))
                });
                
            } catch (error) {
                console.error('‚ùå Operations query failed:', error);
                logResult('error', '‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–ø–µ—Ä–∞—Ü–∏–π', error.message, {
                    error: error
                });
            }
        }
        
        async function testApiConfig() {
            console.log('üß™ Testing API config simulation...');
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ apiConfigService
            const apiConfig = localStorage.getItem('api_config');
            
            logResult('warning', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...', '–ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ API');
            
            let config = null;
            if (apiConfig) {
                try {
                    config = JSON.parse(apiConfig);
                } catch (e) {
                    console.error('Error parsing config:', e);
                }
            }
            
            const currentConnection = config?.availableConnections?.find(
                conn => conn.id === config.currentConnectionId
            );
            
            const isMockMode = currentConnection?.type === 'mock' || !currentConnection;
            const isSupabaseMode = currentConnection?.type === 'supabase';
            
            if (isMockMode) {
                logResult('warning', '‚ö†Ô∏è Mock —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω', 'API —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏', {
                    currentConnectionId: config?.currentConnectionId,
                    mockMode: true,
                    configuration: config
                });
                return;
            }
            
            if (isSupabaseMode) {
                logResult('success', '‚úÖ Supabase —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω', `–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${currentConnection.name}`, {
                    connectionId: currentConnection.id,
                    connectionUrl: currentConnection.url,
                    connectionType: currentConnection.type,
                    settings: currentConnection.settings
                });
            } else {
                logResult('warning', '‚ö†Ô∏è –î—Ä—É–≥–æ–π —Ä–µ–∂–∏–º API', `–¢–∏–ø: ${currentConnection?.type || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}`, {
                    connectionId: currentConnection?.id,
                    connectionUrl: currentConnection?.url,
                    connectionType: currentConnection?.type
                });
            }
        }
        
        function clearResults() {
            document.getElementById('stats').innerHTML = '<strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –û—á–∏—â–µ–Ω–æ';
            document.getElementById('operations').innerHTML = '<strong>–î–µ—Ç–∞–ª–∏:</strong> –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(() => {
            console.log('üöÄ Auto-testing Supabase connection...');
            testConnection();
        }, 1000);
    </script>
</body>
</html>