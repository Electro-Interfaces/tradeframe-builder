<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Flexible Paths Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 { color: #333; }
        .status { padding: 8px 12px; border-radius: 4px; margin: 8px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .test-scenario {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üß™ PWA Flexible Paths Test</h1>
    <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ PWA —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ –±–∞–∑–æ–≤—ã–º–∏ –ø—É—Ç—è–º–∏</p>

    <div class="container">
        <h2>üîç –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h2>
        <div id="currentConfig"></div>
    </div>

    <div class="container">
        <h2>üìã –¢–µ—Å—Ç Manifest</h2>
        <button onclick="testManifest()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Manifest</button>
        <div id="manifestResults"></div>
    </div>

    <div class="container">
        <h2>‚öôÔ∏è –¢–µ—Å—Ç Service Worker</h2>
        <button onclick="testServiceWorker()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SW —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</button>
        <div id="swResults"></div>
    </div>

    <div class="container">
        <h2>üéØ –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–∑–Ω—ã—Ö –ø—É—Ç–µ–π</h2>
        <div class="test-scenario">
            <h3>–°—Ü–µ–Ω–∞—Ä–∏–π 1: GitHub Pages Project (/tradeframe-builder/)</h3>
            <button onclick="simulatePath('/tradeframe-builder/')">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="scenario1"></div>
        </div>

        <div class="test-scenario">
            <h3>–°—Ü–µ–Ω–∞—Ä–∏–π 2: Custom Domain (/)</h3>
            <button onclick="simulatePath('/')">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="scenario2"></div>
        </div>

        <div class="test-scenario">
            <h3>–°—Ü–µ–Ω–∞—Ä–∏–π 3: Subfolder (/my-app/)</h3>
            <button onclick="simulatePath('/my-app/')">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="scenario3"></div>
        </div>
    </div>

    <div class="container">
        <h2>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div id="testSummary"></div>
    </div>

    <script>
        let testResults = {
            manifest: false,
            serviceWorker: false,
            scenarios: {}
        };

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        function showCurrentConfig() {
            const config = {
                'URL': location.href,
                'Pathname': location.pathname,
                'Hostname': location.hostname,
                'Protocol': location.protocol,
                'Base detected': detectBasePath(),
                'Manifest link': document.querySelector('link[rel="manifest"]')?.href || 'Not found',
                'SW supported': 'serviceWorker' in navigator
            };

            let html = '<pre>';
            Object.entries(config).forEach(([key, value]) => {
                html += `${key}: ${value}\n`;
            });
            html += '</pre>';

            document.getElementById('currentConfig').innerHTML = html;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å (–∫–æ–ø–∏—è –ª–æ–≥–∏–∫–∏ –∏–∑ index.html)
        function detectBasePath() {
            let basePath = '/';

            const baseTag = document.querySelector('base');
            if (baseTag) {
                basePath = baseTag.getAttribute('href') || '/';
            } else if (location.pathname.includes('/tradeframe-builder/')) {
                basePath = '/tradeframe-builder/';
            }

            return basePath.endsWith('/') ? basePath : basePath + '/';
        }

        // –¢–µ—Å—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
        async function testManifest() {
            const output = document.getElementById('manifestResults');
            output.innerHTML = '<div class="info">–¢–µ—Å—Ç–∏—Ä—É–µ–º manifest...</div>';

            try {
                // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç
                const response = await fetch('manifest.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const manifest = await response.json();

                let html = '<div class="success">‚úÖ Manifest –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ</div>';
                html += '<h3>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:</h3>';
                html += `<pre>${JSON.stringify({
                    scope: manifest.scope,
                    start_url: manifest.start_url,
                    id: manifest.id,
                    icons_count: manifest.icons?.length || 0,
                    first_icon_src: manifest.icons?.[0]?.src || 'none'
                }, null, 2)}</pre>`;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—É—Ç–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ
                const isRelative = manifest.scope.startsWith('./') &&
                                 manifest.start_url.startsWith('./') &&
                                 manifest.icons?.every(icon => !icon.src.startsWith('/'));

                if (isRelative) {
                    html += '<div class="success">‚úÖ –í—Å–µ –ø—É—Ç–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ - –æ—Ç–ª–∏—á–Ω–æ!</div>';
                    testResults.manifest = true;
                } else {
                    html += '<div class="warning">‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—É—Ç–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º–∏</div>';
                }

                output.innerHTML = html;
            } catch (error) {
                output.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
                testResults.manifest = false;
            }
        }

        // –¢–µ—Å—Ç Service Worker
        async function testServiceWorker() {
            const output = document.getElementById('swResults');
            output.innerHTML = '<div class="info">–¢–µ—Å—Ç–∏—Ä—É–µ–º Service Worker...</div>';

            if (!('serviceWorker' in navigator)) {
                output.innerHTML = '<div class="error">‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</div>';
                testResults.serviceWorker = false;
                return;
            }

            try {
                const basePath = detectBasePath();
                console.log('üîß Test SW: Detected base path:', basePath);

                // –ü—Ä–æ–±—É–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å SW —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –ø—É—Ç–µ–º
                const registration = await navigator.serviceWorker.register(`${basePath}sw.js`, {
                    scope: basePath
                });

                let html = '<div class="success">‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</div>';
                html += `<div class="info">Scope: ${registration.scope}</div>`;
                html += `<div class="info">Base path: ${basePath}</div>`;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ scope —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—É—Ç–∏
                const expectedScope = new URL(basePath, location.origin).href;
                if (registration.scope === expectedScope) {
                    html += '<div class="success">‚úÖ Scope –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π</div>';
                    testResults.serviceWorker = true;
                } else {
                    html += '<div class="warning">‚ö†Ô∏è Scope –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º</div>';
                }

                output.innerHTML = html;
            } catch (error) {
                output.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW: ${error.message}</div>`;
                testResults.serviceWorker = false;
            }
        }

        // –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–∑–Ω—ã—Ö –ø—É—Ç–µ–π
        function simulatePath(testPath) {
            const scenario = testPath === '/tradeframe-builder/' ? 'scenario1' :
                           testPath === '/' ? 'scenario2' : 'scenario3';
            const output = document.getElementById(scenario);

            // –°–∏–º—É–ª–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –∏–∑ index.html
            let basePath = '/';
            const baseTag = document.querySelector('base');
            if (baseTag) {
                basePath = baseTag.getAttribute('href') || '/';
            } else if (testPath.includes('/tradeframe-builder/')) {
                basePath = '/tradeframe-builder/';
            } else if (testPath !== '/') {
                basePath = testPath;
            }

            const normalizedBase = basePath.endsWith('/') ? basePath : basePath + '/';

            let html = `<div class="info">–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—É—Ç—å: ${testPath}</div>`;
            html += `<div>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π base: ${normalizedBase}</div>`;
            html += `<div>SW URL: ${normalizedBase}sw.js</div>`;
            html += `<div>Manifest URL: ${normalizedBase}manifest.json</div>`;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏–∫—É
            const isCorrect = (testPath === '/tradeframe-builder/' && normalizedBase === '/tradeframe-builder/') ||
                             (testPath === '/' && normalizedBase === '/') ||
                             (testPath !== '/' && testPath !== '/tradeframe-builder/' && normalizedBase === testPath);

            if (isCorrect) {
                html += '<div class="success">‚úÖ –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—É—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ</div>';
                testResults.scenarios[testPath] = true;
            } else {
                html += '<div class="error">‚ùå –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—É—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</div>';
                testResults.scenarios[testPath] = false;
            }

            output.innerHTML = html;
            updateSummary();
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ–¥–∫—É
        function updateSummary() {
            const totalScenarios = Object.keys(testResults.scenarios).length;
            const passedScenarios = Object.values(testResults.scenarios).filter(Boolean).length;

            let html = '<h3>–°–≤–æ–¥–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>';
            html += `<div>Manifest: ${testResults.manifest ? '‚úÖ' : '‚ùå'}</div>`;
            html += `<div>Service Worker: ${testResults.serviceWorker ? '‚úÖ' : '‚ùå'}</div>`;
            html += `<div>–°—Ü–µ–Ω–∞—Ä–∏–∏ –ø—É—Ç–µ–π: ${passedScenarios}/${totalScenarios} ‚úÖ</div>`;

            const allPassed = testResults.manifest && testResults.serviceWorker &&
                            (totalScenarios === 0 || passedScenarios === totalScenarios);

            if (allPassed && totalScenarios > 0) {
                html += '<div class="success"><strong>üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! PWA –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø—É—Ç—è—Ö.</strong></div>';
            } else if (totalScenarios === 0) {
                html += '<div class="warning">‚ö†Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏</div>';
            } else {
                html += '<div class="warning">‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏, —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞</div>';
            }

            document.getElementById('testSummary').innerHTML = html;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            showCurrentConfig();
            updateSummary();

            // –ê–≤—Ç–æ—Ç–µ—Å—Ç —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                console.log('üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤...');
                testManifest();
                setTimeout(testServiceWorker, 1000);
            }, 1000);
        });
    </script>
</body>
</html>