<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #334155;
        }
        .status-card h3 {
            margin-top: 0;
            color: #3b82f6;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
        .status-unknown { background: #6b7280; }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #2563eb; }
        .danger { background: #ef4444; }
        .danger:hover { background: #dc2626; }

        .log {
            background: #0f172a;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #334155;
        }
        .timing-info {
            background: #164e63;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç –ú–æ–Ω–∏—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è TradeFrame</h1>

    <div style="margin: 20px 0;">
        <button onclick="startMonitoring()">‚ñ∂ –ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
        <button onclick="stopMonitoring()">‚è∏ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button onclick="testFullCycle()">üîÑ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Ü–∏–∫–ª–∞</button>
        <button onclick="clearLogs()" class="danger">üóë –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
    </div>

    <div class="status-grid">
        <div class="status-card">
            <h3>üåê –°–µ—Ä–≤–µ—Ä —Å—Ç–∞—Ç—É—Å</h3>
            <div id="server-status">
                <span class="status-indicator status-unknown"></span>
                –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...
            </div>
            <div class="timing-info" id="server-timing">
                –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
            </div>
        </div>

        <div class="status-card">
            <h3>üì± –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
            <div id="app-status">
                <span class="status-indicator status-unknown"></span>
                –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å
            </div>
            <div class="timing-info" id="app-timing">
                –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
            </div>
        </div>

        <div class="status-card">
            <h3>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
            <div id="auth-status">
                <span class="status-indicator status-unknown"></span>
                –ù–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–æ—Å—å
            </div>
            <div class="timing-info" id="auth-timing">
                –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
            </div>
        </div>

        <div class="status-card">
            <h3>üíæ localStorage</h3>
            <div id="storage-status">
                <span class="status-indicator status-unknown"></span>
                –ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å
            </div>
            <div id="storage-details" style="font-size: 12px; margin-top: 10px;">
                –î–µ—Ç–∞–ª–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
            </div>
        </div>
    </div>

    <div class="status-card">
        <h3>üìä –õ–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h3>
        <div class="log" id="monitor-log">–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤...</div>
    </div>

    <script>
        let monitoringInterval;
        let isMonitoring = false;
        const APP_URL = 'http://localhost:3004';

        function log(message, type = 'info') {
            const logContainer = document.getElementById('monitor-log');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : 'üìù';
            logContainer.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(elementId, status, text, timing = null) {
            const element = document.getElementById(elementId);
            const indicator = element.querySelector('.status-indicator');
            indicator.className = `status-indicator status-${status}`;
            element.innerHTML = indicator.outerHTML + ' ' + text;

            if (timing && elementId.includes('-status')) {
                const timingElement = document.getElementById(elementId.replace('-status', '-timing'));
                if (timingElement) {
                    timingElement.textContent = timing;
                }
            }
        }

        async function checkServerStatus() {
            const startTime = Date.now();
            try {
                const response = await fetch(APP_URL, {
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                const responseTime = Date.now() - startTime;

                if (response.ok) {
                    updateStatus('server-status', 'ok', `–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω (${response.status})`, `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${responseTime}–º—Å`);
                    return true;
                } else {
                    updateStatus('server-status', 'warning', `–°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π (${response.status})`, `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${responseTime}–º—Å`);
                    return false;
                }
            } catch (error) {
                const responseTime = Date.now() - startTime;
                updateStatus('server-status', 'error', `–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (${error.message})`, `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${responseTime}–º—Å`);
                return false;
            }
        }

        async function checkAppLoading() {
            const startTime = Date.now();
            try {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ iframe –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const response = await fetch(APP_URL);
                const html = await response.text();
                const loadTime = Date.now() - startTime;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ HTML
                const hasInitialLoading = html.includes('initial-loading');
                const hasReactRoot = html.includes('id="root"');
                const hasManifest = html.includes('manifest.json');

                if (hasInitialLoading && hasReactRoot) {
                    updateStatus('app-status', 'ok', 'HTML –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', `–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: ${loadTime}–º—Å`);
                    log(`‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: HTML —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (${loadTime}–º—Å)`, 'success');
                    return true;
                } else {
                    updateStatus('app-status', 'warning', 'HTML –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –º–æ–≥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã', `–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: ${loadTime}–º—Å`);
                    log(`‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —ç–ª–µ–º–µ–Ω—Ç—ã - loading: ${hasInitialLoading}, root: ${hasReactRoot}`, 'warning');
                    return false;
                }
            } catch (error) {
                const loadTime = Date.now() - startTime;
                updateStatus('app-status', 'error', `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (${error.message})`, `–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: ${loadTime}–º—Å`);
                log(`‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ - ${error.message}`, 'error');
                return false;
            }
        }

        async function checkAuthAPI() {
            const startTime = Date.now();
            try {
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–æ–∂–∏–¥–∞–µ–º 404 –∏–ª–∏ –º–µ—Ç–æ–¥—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è)
                const response = await fetch(APP_URL + '/api/auth/status', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const responseTime = Date.now() - startTime;

                // –î–ª—è SPA –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ–∂–∏–¥–∞–µ–º 404 –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ index.html
                if (response.status === 404 || response.status === 200) {
                    updateStatus('auth-status', 'ok', 'API –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç', `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${responseTime}–º—Å`);
                    log(`‚úÖ API: –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (${response.status})`, 'success');
                    return true;
                } else {
                    updateStatus('auth-status', 'warning', `–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç API (${response.status})`, `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${responseTime}–º—Å`);
                    log(`‚ö†Ô∏è API: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å ${response.status}`, 'warning');
                    return false;
                }
            } catch (error) {
                const responseTime = Date.now() - startTime;
                updateStatus('auth-status', 'error', `API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (${error.message})`, `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${responseTime}–º—Å`);
                log(`‚ùå API: –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ - ${error.message}`, 'error');
                return false;
            }
        }

        function checkLocalStorage() {
            const keys = ['tradeframe_user', 'authToken', 'rememberedEmail', 'currentUser', 'auth_token'];
            const storage = {};
            let hasData = false;

            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    storage[key] = value.length > 50 ? `${value.substring(0, 50)}...` : value;
                    hasData = true;
                }
            });

            if (hasData) {
                updateStatus('storage-status', 'warning', '–ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                document.getElementById('storage-details').innerHTML = Object.keys(storage).map(key =>
                    `<div><strong>${key}:</strong> ${storage[key]}</div>`
                ).join('');
                log(`‚ö†Ô∏è localStorage: –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ - ${Object.keys(storage).join(', ')}`, 'warning');
            } else {
                updateStatus('storage-status', 'ok', 'localStorage —á–∏—Å—Ç');
                document.getElementById('storage-details').innerHTML = '<div>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</div>';
                log('‚úÖ localStorage: –ß–∏—Å—Ç—ã–π, –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'success');
            }
        }

        async function runFullCheck() {
            log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å–∏—Å—Ç–µ–º—ã...', 'info');

            const serverOk = await checkServerStatus();
            if (!serverOk) {
                log('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É', 'error');
                return;
            }

            const appOk = await checkAppLoading();
            await checkAuthAPI();
            checkLocalStorage();

            log('üéØ –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
        }

        function startMonitoring() {
            if (isMonitoring) return;

            isMonitoring = true;
            log('‚ñ∂ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω', 'success');

            // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            runFullCheck();

            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            monitoringInterval = setInterval(() => {
                checkServerStatus();
                checkLocalStorage();
            }, 10000);
        }

        function stopMonitoring() {
            if (!isMonitoring) return;

            isMonitoring = false;
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            log('‚è∏ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
        }

        async function testFullCycle() {
            log('üîÑ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞...', 'info');

            // 1. –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            localStorage.clear();
            sessionStorage.clear();
            log('üßπ –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'info');

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
            await checkServerStatus();

            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
            await checkAppLoading();

            // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ API
            await checkAuthAPI();

            // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage
            checkLocalStorage();

            // 6. –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            log('üåê –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...', 'info');
            window.open(APP_URL, '_blank');

            log('üéØ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ü–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
        }

        function clearLogs() {
            document.getElementById('monitor-log').innerHTML = '';
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            log('üöÄ –ú–æ–Ω–∏—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
            runFullCheck();
        };
    </script>
</body>
</html>