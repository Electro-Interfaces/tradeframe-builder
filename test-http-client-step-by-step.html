<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ—à–∞–≥–æ–≤—ã–π —Ç–µ—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞</title>
    <style>
        body { font-family: 'Courier New', monospace; margin: 20px; background: #1e1e1e; color: #fff; }
        .step { margin: 20px 0; padding: 15px; border-left: 3px solid #007acc; background: #2d2d30; }
        .success { border-left-color: #28a745; background: #1a3d1a; }
        .error { border-left-color: #dc3545; background: #3d1a1a; }
        .warning { border-left-color: #ffc107; background: #3d3d1a; }
        .code { background: #0d1117; padding: 10px; margin: 10px 0; border-radius: 5px; white-space: pre-wrap; }
        .highlight { color: #79c0ff; }
        .param { color: #7ee787; }
        button { padding: 10px 20px; margin: 10px; background: #238636; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2ea043; }
        button:disabled { background: #656d76; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>üß™ –ü–æ—à–∞–≥–æ–≤—ã–π —Ç–µ—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞</h1>
    <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–π —à–∞–≥ —Ä–∞–±–æ—Ç—ã —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –ê–ó–° 4</p>
    
    <button onclick="runFullTest()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
    <button onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    
    <div id="log"></div>

    <script type="module">
        const log = document.getElementById('log');
        
        function addLog(title, content, type = 'step') {
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <div>${content}</div>
            `;
            log.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        function addCode(code) {
            return `<div class="code">${code}</div>`;
        }
        
        window.clearLog = function() {
            log.innerHTML = '';
        }
        
        window.runFullTest = async function() {
            clearLog();
            addLog('üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –ü–û–®–ê–ì–û–í–´–ô –¢–ï–°–¢', '–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ê–ó–° 4');
            
            const TARGET_TP_ID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
            
            try {
                // –®–ê–ì 1: –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π
                addLog('üì¶ –®–ê–ì 1: –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π', '–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã...');
                
                const { httpClient } = await import('./src/services/universalHttpClient.js');
                const { tradingNetworkConfigService } = await import('./src/services/tradingNetworkConfigService.js');
                const { tanksApiIntegrationService } = await import('./src/services/tanksApiIntegrationService.js');
                
                addLog('‚úÖ –ò–ú–ü–û–†–¢ –ó–ê–í–ï–†–®–ï–ù', '–í—Å–µ –º–æ–¥—É–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                
                // –®–ê–ì 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                addLog('üîß –®–ê–ì 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Ç–∏', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏"...');
                
                let config;
                try {
                    config = await tradingNetworkConfigService.getConfig();
                    
                    addLog('‚úÖ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–û–õ–£–ß–ï–ù–ê (ASYNC)', 
                        addCode(`Enabled: <span class="param">${config.enabled}</span>
Base URL: <span class="param">${config.baseUrl}</span>
Auth Type: <span class="param">${config.authType}</span>
Username: <span class="param">${config.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
Password: <span class="param">${config.password ? '***' : '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
Endpoints: <span class="param">${JSON.stringify(config.endpoints, null, 2)}</span>`), 'success');
                        
                } catch (asyncError) {
                    addLog('‚ùå –û–®–ò–ë–ö–ê ASYNC –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò', 
                        `–û—à–∏–±–∫–∞: ${asyncError.message}`, 'error');
                    
                    // –ü—Ä–æ–±—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
                    try {
                        config = tradingNetworkConfigService.getConfigSync();
                        addLog('‚ö†Ô∏è –ò–°–ü–û–õ–¨–ó–£–ï–ú SYNC –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Æ', 
                            addCode(`Enabled: <span class="param">${config.enabled}</span>
Base URL: <span class="param">${config.baseUrl}</span>
Auth Type: <span class="param">${config.authType}</span>
Username: <span class="param">${config.username}</span>`), 'warning');
                    } catch (syncError) {
                        addLog('üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò', 
                            `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: ${syncError.message}`, 'error');
                        return;
                    }
                }
                
                // –®–ê–ì 3: –ü–æ–ª—É—á–µ–Ω–∏–µ API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                addLog('üÜî –®–ê–ì 3: –ü–æ–ª—É—á–µ–Ω–∏–µ API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –ê–ó–° 4', 
                    `–ü–æ–ª—É—á–∞–µ–º system –∏ station ID –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏: ${TARGET_TP_ID}`);
                
                // –ò–º–∏—Ç–∏—Ä—É–µ–º getApiParams –∏–∑ tanksApiIntegrationService
                const { tradingPointsService } = await import('./src/services/tradingPointsService.js');
                const { networksService } = await import('./src/services/networksService.js');
                
                const tradingPoint = await tradingPointsService.getById(TARGET_TP_ID);
                if (!tradingPoint) {
                    addLog('‚ùå –¢–û–†–ì–û–í–ê–Ø –¢–û–ß–ö–ê –ù–ï –ù–ê–ô–î–ï–ù–ê', `ID: ${TARGET_TP_ID}`, 'error');
                    return;
                }
                
                const stationId = tradingPoint.external_id || tradingPoint.code || '';
                let systemId = '';
                
                if (tradingPoint.network_id) {
                    const network = await networksService.getById(tradingPoint.network_id);
                    if (network) {
                        systemId = network.external_id || network.name || '';
                    }
                }
                
                addLog('‚úÖ API –ü–ê–†–ê–ú–ï–¢–†–´ –ü–û–õ–£–ß–ï–ù–´', 
                    addCode(`–¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞: <span class="highlight">${tradingPoint.name}</span>
Station ID: <span class="param">"${stationId}"</span>
–°–µ—Ç—å: <span class="highlight">${tradingPoint.network_id ? '–Ω–∞–π–¥–µ–Ω–∞' : '–Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}</span>
System ID: <span class="param">"${systemId}"</span>

–ò—Ç–æ–≥–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è API:
- system: <span class="param">${systemId}</span>
- station: <span class="param">${stationId}</span>`), 'success');
                
                if (!systemId || !stationId) {
                    addLog('‚ùå –û–¢–°–£–¢–°–¢–í–£–Æ–¢ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´', 
                        '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç system –∏–ª–∏ station ID –¥–ª—è API –∑–∞–ø—Ä–æ—Å–∞', 'error');
                    return;
                }
                
                // –®–ê–ì 4: –¢–µ—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞
                addLog('üåê –®–ê–ì 4: –¢–µ—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞', 
                    '–î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ httpClient.get()...');
                
                const endpoint = config.endpoints.tanks || '/tanks';
                const queryParams = {
                    system: systemId,
                    station: stationId
                };
                
                const fullTestUrl = `${config.baseUrl}${endpoint}?system=${systemId}&station=${stationId}`;
                
                addLog('üìã –ü–ê–†–ê–ú–ï–¢–†–´ –ó–ê–ü–†–û–°–ê', 
                    addCode(`Endpoint: <span class="param">${endpoint}</span>
Destination: <span class="param">external-api</span>
Query Params: <span class="param">${JSON.stringify(queryParams, null, 2)}</span>
–ü–æ–ª–Ω—ã–π URL: <span class="highlight">${fullTestUrl}</span>`));
                
                const startTime = Date.now();
                
                const response = await httpClient.get(endpoint, {
                    destination: 'external-api',
                    queryParams: queryParams,
                    timeout: 15000,
                    retryAttempts: 1
                });
                
                const responseTime = Date.now() - startTime;
                
                // –®–ê–ì 5: –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–∞
                addLog('üìä –®–ê–ì 5: –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–∞ –æ—Ç API', 
                    `–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${responseTime}ms`);
                
                addLog('üìã –î–ï–¢–ê–õ–ò –û–¢–í–ï–¢–ê', 
                    addCode(`Success: <span class="param">${response.success}</span>
Status: <span class="param">${response.status || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
Error: <span class="param">${response.error || '–Ω–µ—Ç'}</span>
Response Time: <span class="param">${response.responseTime || responseTime}ms</span>
Data Type: <span class="param">${response.data ? typeof response.data : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</span>`));
                
                if (response.success && response.data) {
                    if (Array.isArray(response.data)) {
                        addLog('‚úÖ –î–ê–ù–ù–´–ï –ü–û–õ–£–ß–ï–ù–´ –£–°–ü–ï–®–ù–û', 
                            addCode(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: <span class="highlight">${response.data.length}</span>

${response.data.length > 0 ? 
    `–ü–µ—Ä–≤—ã–π —Ä–µ–∑–µ—Ä–≤—É–∞—Ä:\n<span class="param">${JSON.stringify(response.data[0], null, 2)}</span>` : 
    '–ú–∞—Å—Å–∏–≤ –ø—É—Å—Ç–æ–π'
                }`), 'success');
                    } else {
                        addLog('‚ö†Ô∏è –ù–ï–û–ñ–ò–î–ê–ù–ù–´–ô –§–û–†–ú–ê–¢ –î–ê–ù–ù–´–•', 
                            addCode(`–î–∞–Ω–Ω—ã–µ: <span class="param">${JSON.stringify(response.data, null, 2)}</span>`), 'warning');
                    }
                } else {
                    addLog('‚ùå –û–®–ò–ë–ö–ê –ü–û–õ–£–ß–ï–ù–ò–Ø –î–ê–ù–ù–´–•', 
                        addCode(`HTTP Status: <span class="param">${response.status}</span>
Error: <span class="param">${response.error}</span>
Headers: <span class="param">${response.headers ? JSON.stringify(response.headers, null, 2) : '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}</span>
Raw Data: <span class="param">${response.data ? JSON.stringify(response.data, null, 2) : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</span>`), 'error');
                }
                
                // –®–ê–ì 6: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä—è–º—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
                addLog('üîÑ –®–ê–ì 6: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä—è–º—ã–º –∑–∞–ø—Ä–æ—Å–æ–º', 
                    '–î–µ–ª–∞–µ–º —Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ fetch()...');
                
                try {
                    const directStartTime = Date.now();
                    const authString = btoa(`${config.username}:${config.password}`);
                    
                    const directResponse = await fetch(fullTestUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Basic ${authString}`,
                            'Accept': 'application/json',
                            'User-Agent': 'tradeframe-builder/1.0'
                        },
                        timeout: 10000
                    });
                    
                    const directResponseTime = Date.now() - directStartTime;
                    
                    addLog('üìä –†–ï–ó–£–õ–¨–¢–ê–¢ –ü–†–Ø–ú–û–ì–û –ó–ê–ü–†–û–°–ê', 
                        addCode(`Status: <span class="param">${directResponse.status} ${directResponse.statusText}</span>
Time: <span class="param">${directResponseTime}ms</span>
Headers: <span class="param">${JSON.stringify(Object.fromEntries(directResponse.headers.entries()), null, 2)}</span>`));
                    
                    if (directResponse.ok) {
                        const directData = await directResponse.json();
                        addLog('‚úÖ –ü–†–Ø–ú–û–ô –ó–ê–ü–†–û–° –£–°–ü–ï–®–ï–ù', 
                            addCode(`–†–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: <span class="highlight">${Array.isArray(directData) ? directData.length : '–Ω–µ –º–∞—Å—Å–∏–≤'}</span>
                            
${Array.isArray(directData) && directData.length > 0 ? 
    `–ü–µ—Ä–≤—ã–π —Ä–µ–∑–µ—Ä–≤—É–∞—Ä:\n<span class="param">${JSON.stringify(directData[0], null, 2)}</span>` : 
    `–î–∞–Ω–Ω—ã–µ: <span class="param">${JSON.stringify(directData, null, 2)}</span>`
                            }`), 'success');
                        
                        // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                        const httpClientWorks = response.success && Array.isArray(response.data) && response.data.length > 0;
                        const directWorks = Array.isArray(directData) && directData.length > 0;
                        
                        if (httpClientWorks && directWorks) {
                            addLog('üéâ –û–ë–ê –ú–ï–¢–û–î–ê –†–ê–ë–û–¢–ê–Æ–¢', 
                                'HTTP –∫–ª–∏–µ–Ω—Ç –∏ –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –¥–∞–Ω–Ω—ã–µ', 'success');
                        } else if (directWorks && !httpClientWorks) {
                            addLog('‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê –í HTTP –ö–õ–ò–ï–ù–¢–ï', 
                                '–ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ HTTP –∫–ª–∏–µ–Ω—Ç –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ', 'warning');
                        } else {
                            addLog('‚ùå –ü–†–û–ë–õ–ï–ú–ê –í API –ò–õ–ò –ü–ê–†–ê–ú–ï–¢–†–ê–•', 
                                '–ù–∏ –æ–¥–∏–Ω –∏–∑ –º–µ—Ç–æ–¥–æ–≤ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ', 'error');
                        }
                        
                    } else {
                        const directError = await directResponse.text();
                        addLog('‚ùå –ü–†–Ø–ú–û–ô –ó–ê–ü–†–û–° –ù–ï–£–î–ê–ß–ï–ù', 
                            addCode(`Error: <span class="param">${directResponse.status} - ${directError}</span>`), 'error');
                    }
                    
                } catch (directError) {
                    addLog('üí• –û–®–ò–ë–ö–ê –ü–†–Ø–ú–û–ì–û –ó–ê–ü–†–û–°–ê', 
                        `Fetch error: ${directError.message}`, 'error');
                }
                
                addLog('üèÅ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù', 
                    '–í—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—à–µ.', 'success');
                
            } catch (error) {
                addLog('üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –¢–ï–°–¢–ê', 
                    addCode(`Error: <span class="param">${error.message}</span>
Stack: <span class="param">${error.stack}</span>`), 'error');
            }
        }
    </script>
</body>
</html>