<!DOCTYPE html>
<html>
<head>
    <title>Test Network Prices API</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .test { background: #fff; padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid #ddd; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 5px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 5px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 4px; margin: 5px 0; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .station { border: 1px solid #ddd; margin: 5px 0; padding: 10px; border-radius: 4px; }
        .service { background: #f8f9fa; margin: 2px 0; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üîó Test Network Prices API</h1>
    
    <div class="test">
        <h3>1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Ü–µ–Ω –∏–∑ —Å–µ—Ç–∏</h3>
        <p>API: <code>https://pos.autooplata.ru/tms/v1/prices?system=15</code></p>
        <button onclick="testNetworkAPI()" id="testBtn">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Network API</button>
        <div id="network-status"></div>
    </div>

    <div class="test">
        <h3>2. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h3>
        <div id="prices-visualization"></div>
    </div>

    <div class="test">
        <h3>3. –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ü–µ–Ω —Å –Ω–æ–≤—ã–º API</h3>
        <button onclick="openPricesPageWithNetworkAPI()">–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ü–µ–Ω</button>
        <p><em>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º Network API</em></p>
    </div>

    <div class="test">
        <h3>4. –ñ—É—Ä–Ω–∞–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <div id="test-log" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;"></div>
        <button onclick="clearTestLog()">–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
    </div>

    <script>
        let testLog = [];
        
        function addTestLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push(`[${timestamp}] ${message}`);
            updateTestLogDisplay();
            console.log(`[NETWORK API TEST] ${message}`);
        }
        
        function updateTestLogDisplay() {
            const logDiv = document.getElementById('test-log');
            logDiv.innerHTML = testLog.map(entry => `<div>${entry}</div>`).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearTestLog() {
            testLog = [];
            updateTestLogDisplay();
        }

        async function testNetworkAPI() {
            const statusDiv = document.getElementById('network-status');
            const testBtn = document.getElementById('testBtn');
            const vizDiv = document.getElementById('prices-visualization');
            
            testBtn.disabled = true;
            statusDiv.innerHTML = '<div class="info">üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Network API...</div>';
            addTestLog('üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Network API');
            
            try {
                const response = await fetch('https://pos.autooplata.ru/tms/v1/prices?system=15', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                addTestLog(`üì° HTTP –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: GET /prices?system=15`);
                
                if (response.ok) {
                    const data = await response.json();
                    addTestLog(`‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç: —Å—Ç–∞—Ç—É—Å ${response.status}, ${data.length} —Å—Ç–∞–Ω—Ü–∏–π`);
                    
                    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    let totalServices = 0;
                    const fuelTypes = new Set();
                    const avgPrices = {};
                    
                    data.forEach(station => {
                        totalServices += station.services.length;
                        station.services.forEach(service => {
                            fuelTypes.add(service.service_name);
                            if (!avgPrices[service.service_name]) {
                                avgPrices[service.service_name] = [];
                            }
                            avgPrices[service.service_name].push(service.price);
                        });
                    });
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã
                    const avgPricesCalculated = {};
                    Object.keys(avgPrices).forEach(fuelType => {
                        const prices = avgPrices[fuelType];
                        avgPricesCalculated[fuelType] = (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(1);
                    });
                    
                    statusDiv.innerHTML = `
                        <div class="success">‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!</div>
                        <div><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong></div>
                        <div>‚Ä¢ –°—Ç–∞–Ω—Ü–∏–π: ${data.length}</div>
                        <div>‚Ä¢ –í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π —Ü–µ–Ω: ${totalServices}</div>
                        <div>‚Ä¢ –¢–∏–ø–æ–≤ —Ç–æ–ø–ª–∏–≤–∞: ${fuelTypes.size}</div>
                        <div>‚Ä¢ –°—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã: ${Object.entries(avgPricesCalculated).map(([fuel, price]) => `${fuel}: ${price} —Ä—É–±.`).join(', ')}</div>
                    `;
                    
                    // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                    let visualizationHTML = '<h4>üìä –î–∞–Ω–Ω—ã–µ –ø–æ —Å—Ç–∞–Ω—Ü–∏—è–º:</h4>';
                    data.forEach(station => {
                        visualizationHTML += `
                            <div class="station">
                                <strong>üè™ –°—Ç–∞–Ω—Ü–∏—è ${station.station}</strong>
                                ${station.services.map(service => `
                                    <div class="service">‚õΩ ${service.service_name}: <strong>${service.price} —Ä—É–±.</strong> (–∫–æ–¥: ${service.service_code})</div>
                                `).join('')}
                            </div>
                        `;
                    });
                    vizDiv.innerHTML = visualizationHTML;
                    
                    addTestLog(`üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–∞–Ω–Ω—ã—Ö: ${data.length} —Å—Ç–∞–Ω—Ü–∏–π, ${totalServices} –ø–æ–∑–∏—Ü–∏–π —Ü–µ–Ω`);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
                    const networkConfig = {
                        baseUrl: 'https://pos.autooplata.ru/tms/v1',
                        systemId: '15'
                    };
                    localStorage.setItem('networkPricesApi', JSON.stringify(networkConfig));
                    addTestLog('üíæ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Network API —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage');
                    
                } else {
                    const errorText = await response.text();
                    statusDiv.innerHTML = `
                        <div class="error">‚ùå –û—à–∏–±–∫–∞ API: ${response.status} ${response.statusText}</div>
                        <pre>${errorText}</pre>
                    `;
                    addTestLog(`‚ùå –û—à–∏–±–∫–∞ API: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</div>`;
                addTestLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
            } finally {
                testBtn.disabled = false;
            }
        }
        
        function openPricesPageWithNetworkAPI() {
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Network API —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
            const networkConfig = {
                baseUrl: 'https://pos.autooplata.ru/tms/v1',
                systemId: '15'
            };
            localStorage.setItem('networkPricesApi', JSON.stringify(networkConfig));
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ localStorage
            window.dispatchEvent(new CustomEvent('localStorageChanged'));
            
            addTestLog('üåê –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ü–µ–Ω —Å Network API');
            window.open('http://localhost:3004/point/prices', '_blank');
            addTestLog('üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ü–µ–Ω –æ—Ç–∫—Ä—ã—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö!');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        window.onload = function() {
            addTestLog('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Network API –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        };
    </script>
</body>
</html>