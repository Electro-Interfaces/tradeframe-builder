<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 11px; max-height: 400px; }
        .template-card { border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px; background: #f8f9fa; }
        .active { border-left: 4px solid #28a745; }
    </style>
</head>
<body>
    <h1>‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h1>
    
    <div class="section info">
        <h3>üìã –¶–µ–ª—å:</h3>
        <p>–î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü—É <code>equipment_templates</code>, —á—Ç–æ–±—ã –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</p>
    </div>
    
    <div class="section">
        <button onclick="checkCurrentTemplates()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —à–∞–±–ª–æ–Ω—ã</button>
        <button onclick="addDefaultTemplates()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã</button>
        <button onclick="clearAllTemplates()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —à–∞–±–ª–æ–Ω—ã</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (typeof data === 'string') {
                    content += `<pre>${data}</pre>`
                } else if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                    let tableContent = '<div>'
                    data.forEach(item => {
                        const cardClass = item.status ? 'template-card active' : 'template-card'
                        tableContent += `
                        <div class="${cardClass}">
                            <strong>${item.name}</strong> 
                            <code>${item.technical_code}</code><br>
                            <small>${item.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</small><br>
                            <em>–¢–∏–ø: ${item.system_type}</em>
                        </div>`
                    })
                    tableContent += '</div>'
                    content += tableContent
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
        }

        // –ë–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–∏–∑ —Å—Ç–∞—Ä–æ–≥–æ equipmentTypes.ts)
        const defaultTemplates = [
            {
                name: "–†–µ–∑–µ—Ä–≤—É–∞—Ä",
                technical_code: "EQP_RESERVOIR", 
                system_type: "fuel_tank",
                status: true,
                description: "–¢–æ–ø–ª–∏–≤–Ω—ã–π —Ä–µ–∑–µ—Ä–≤—É–∞—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–¥—É–∫—Ç–æ–≤",
                default_params: {
                    capacityLiters: 50000,
                    minLevelPercent: 20,
                    criticalLevelPercent: 10,
                    material: "steel"
                },
                allow_component_template_ids: ["1", "4"]
            },
            {
                name: "–¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
                technical_code: "EQP_TSO",
                system_type: "self_service_terminal", 
                status: true,
                description: "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –Ω–∞ –ê–ó–°",
                default_params: {
                    touch_screen: true,
                    payment_methods: ["card", "cash"]
                },
                allow_component_template_ids: ["1", "2", "3", "4", "5"]
            },
            {
                name: "–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
                technical_code: "EQP_CONTROL_SYSTEM",
                system_type: "control_system",
                status: true, 
                description: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ê–ó–°",
                default_params: {
                    server_type: "industrial",
                    redundancy: true
                },
                allow_component_template_ids: ["1", "2", "3", "4"]
            },
            {
                name: "–¢–∞–±–ª–æ —Ü–µ–Ω",
                technical_code: "EQP_PRICE_BOARD",
                system_type: "price_display",
                status: true,
                description: "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ —Ç–∞–±–ª–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω –Ω–∞ —Ç–æ–ø–ª–∏–≤–æ", 
                default_params: {
                    display_type: "LED",
                    brightness: 5000
                },
                allow_component_template_ids: ["1", "2", "4"]
            },
            {
                name: "–í–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ", 
                technical_code: "EQP_CCTV",
                system_type: "surveillance",
                status: true,
                description: "–°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ê–ó–°",
                default_params: {
                    resolution: "4K",
                    night_vision: true,
                    storage_days: 30
                },
                allow_component_template_ids: ["1", "4"]
            },
            {
                name: "–ó–≤—É–∫–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ",
                technical_code: "EQP_AUDIO", 
                system_type: "audio_system",
                status: true,
                description: "–°–∏—Å—Ç–µ–º–∞ –∑–≤—É–∫–æ–≤–æ–≥–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è",
                default_params: {
                    speakers: 6,
                    volume_max: 80,
                    zones: 3
                },
                allow_component_template_ids: ["1", "4"]
            }
        ]

        window.checkCurrentTemplates = async function() {
            logResult('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —à–∞–±–ª–æ–Ω—ã...', 'info')
            
            try {
                const { data, error } = await supabase
                    .from('equipment_templates')
                    .select('*')
                    .order('name')
                
                if (error) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ equipment_templates', 'error', error)
                    return
                }
                
                logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data?.length || 0} —à–∞–±–ª–æ–Ω–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è`, 'success')
                
                if (data && data.length > 0) {
                    logResult('üìä –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —à–∞–±–ª–æ–Ω—ã:', 'info', data)
                } else {
                    logResult('üí° –¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è - –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã', 'warning')
                }
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏', 'error', error)
            }
        }

        window.addDefaultTemplates = async function() {
            logResult('‚ûï –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...', 'info')
            
            try {
                let insertedCount = 0
                const errors = []
                
                for (const template of defaultTemplates) {
                    try {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —à–∞–±–ª–æ–Ω
                        const { data: existing } = await supabase
                            .from('equipment_templates')
                            .select('id')
                            .eq('technical_code', template.technical_code)
                            .single()
                        
                        if (existing) {
                            logResult(`‚ö†Ô∏è –®–∞–±–ª–æ–Ω ${template.name} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`, 'warning')
                            continue
                        }
                        
                        // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω
                        const { error } = await supabase
                            .from('equipment_templates')
                            .insert([template])
                        
                        if (error) {
                            errors.push(`${template.name}: ${error.message}`)
                        } else {
                            logResult(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —à–∞–±–ª–æ–Ω: ${template.name}`, 'success')
                            insertedCount++
                        }
                        
                    } catch (itemError) {
                        errors.push(`${template.name}: ${itemError.message}`)
                    }
                }
                
                logResult(`üéâ –î–æ–±–∞–≤–ª–µ–Ω–æ —à–∞–±–ª–æ–Ω–æ–≤: ${insertedCount}`, 'success')
                
                if (errors.length > 0) {
                    logResult(`‚ö†Ô∏è –û—à–∏–±–∫–∏ (${errors.length}):`, 'warning', errors)
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                await checkCurrentTemplates()
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–æ–≤', 'error', error)
            }
        }

        window.clearAllTemplates = async function() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —à–∞–±–ª–æ–Ω—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è?')) {
                return
            }
            
            logResult('üóëÔ∏è –£–¥–∞–ª—è–µ–º –≤—Å–µ —à–∞–±–ª–æ–Ω—ã...', 'warning')
            
            try {
                const { error } = await supabase
                    .from('equipment_templates')
                    .delete()
                    .gte('created_at', '1900-01-01') // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
                
                if (error) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error', error)
                    return
                }
                
                logResult('‚úÖ –í—Å–µ —à–∞–±–ª–æ–Ω—ã —É–¥–∞–ª–µ–Ω—ã', 'success')
                await checkCurrentTemplates()
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error', error)
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 500))
            await checkCurrentTemplates()
        })
    </script>
</body>
</html>