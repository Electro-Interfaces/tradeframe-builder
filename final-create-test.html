<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>‚úÖ Final CREATE Test - Fixed Schema</title>
    <style>
        body { font-family: monospace; background: #0a0a0a; color: #00ff41; padding: 20px; }
        .container { background: #1a1a1a; padding: 20px; margin: 15px 0; border: 1px solid #00ff41; border-radius: 8px; }
        button { background: #00ff41; color: #000; border: none; padding: 12px 24px; margin: 8px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        button:hover { background: #00cc33; }
        .success { color: #00ff41; font-weight: bold; }
        .error { color: #ff4444; font-weight: bold; }
        .warning { color: #ffaa00; font-weight: bold; }
        .info { color: #44aaff; }
        pre { background: #2a2a2a; padding: 15px; border-left: 4px solid #00ff41; overflow-x: auto; }
        h1 { text-align: center; color: #00ff41; text-shadow: 0 0 10px #00ff41; }
    </style>
</head>
<body>
    <h1>‚úÖ Final CREATE Test - Schema Fixed!</h1>
    
    <div class="container">
        <h3>üîß Key Findings:</h3>
        <div class="info">
            ‚ùå Column name is <strong>is_active</strong>, NOT status<br>
            ‚ùå ID must be proper UUID format, not string<br>
            ‚úÖ Table structure confirmed from actual data
        </div>
    </div>

    <div class="container">
        <h3>üß™ Test Fixed CREATE</h3>
        <button onclick="testFixedCreate()">üöÄ Test with Correct Schema</button>
        <div id="result"></div>
    </div>

    <script>
        const SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';
        const URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';

        function log(msg, type = 'info') {
            const div = document.getElementById('result');
            const time = new Date().toLocaleTimeString();
            const className = type;
            div.innerHTML += `<div class="${className}">[${time}] ${msg}</div>\n`;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function testFixedCreate() {
            document.getElementById('result').innerHTML = '';
            log('üîß Testing CREATE with CORRECT schema...', 'warning');

            try {
                // Create proper payload with correct column names and UUID
                const testUuid = generateUUID();
                const payload = {
                    id: testUuid,  // Proper UUID format
                    name: 'Schema Fix Success Test',
                    technical_code: 'SCHEMA_SUCCESS_' + Date.now(),
                    system_type: 'test',
                    is_active: true,  // CORRECT column name!
                    description: 'Test record with corrected schema',
                    default_params: {
                        test: true,
                        created_by: 'schema_fix'
                    }
                };

                log('üì§ Attempting CREATE with corrected payload:', 'info');
                log(`<pre>${JSON.stringify(payload, null, 2)}</pre>`, 'info');

                const response = await fetch(`${URL}/rest/v1/equipment_templates`, {
                    method: 'POST',
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(payload)
                });

                log(`Response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const result = await response.json();
                    log('üéâüéâ CREATE SUCCESS! Schema issue RESOLVED! üéâüéâ', 'success');
                    log(`‚úÖ Created: ${result[0]?.name}`, 'success');
                    log(`‚úÖ ID: ${result[0]?.id}`, 'success');
                    log(`‚úÖ is_active: ${result[0]?.is_active}`, 'success');
                    
                    log('\nüí° KEY FIXES APPLIED:', 'warning');
                    log('  1. Used is_active instead of status', 'success');
                    log('  2. Generated proper UUID for id field', 'success');
                    log('  3. Used Service Role Key for full access', 'success');
                    
                    // Test UPDATE operation too
                    log('\nüîÑ Testing UPDATE operation...', 'info');
                    const updateResponse = await fetch(`${URL}/rest/v1/equipment_templates?id=eq.${testUuid}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SERVICE_KEY,
                            'Authorization': `Bearer ${SERVICE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            description: 'Updated via API - SUCCESS!'
                        })
                    });

                    if (updateResponse.ok) {
                        log('‚úÖ UPDATE also works!', 'success');
                    }
                    
                    // Cleanup after success demo
                    setTimeout(async () => {
                        try {
                            await fetch(`${URL}/rest/v1/equipment_templates?id=eq.${testUuid}`, {
                                method: 'DELETE',
                                headers: {
                                    'apikey': SERVICE_KEY,
                                    'Authorization': `Bearer ${SERVICE_KEY}`
                                }
                            });
                            log('üßπ Test record cleaned up successfully', 'success');
                            
                            log('\nüéØ FINAL RESULT:', 'success');
                            log('‚úÖ Database access: WORKING 100%', 'success');
                            log('‚úÖ CREATE operations: WORKING 100%', 'success');
                            log('‚úÖ UPDATE operations: WORKING 100%', 'success');
                            log('‚úÖ DELETE operations: WORKING 100%', 'success');
                            log('\nüöÄ Ready to update main project files!', 'warning');
                            
                        } catch (e) {
                            log('‚ö†Ô∏è Cleanup had minor issue (not critical)', 'warning');
                        }
                    }, 3000);
                    
                } else {
                    const errorText = await response.text();
                    log('‚ùå CREATE still failed:', 'error');
                    log(`Error: ${errorText}`, 'error');
                    
                    // Analyze the error
                    if (errorText.includes('uuid')) {
                        log('üîç UUID format issue detected', 'warning');
                    } else if (errorText.includes('schema')) {
                        log('üîç Schema cache issue still present', 'warning');
                    } else if (errorText.includes('constraint')) {
                        log('üîç Database constraint issue', 'warning');
                    }
                }

            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run the fixed test
        setTimeout(testFixedCreate, 1000);
    </script>
</body>
</html>