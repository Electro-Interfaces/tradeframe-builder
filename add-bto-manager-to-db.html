<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–¢–û –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
        }
        .container {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid #334155;
        }
        h1 {
            color: #3b82f6;
            margin-bottom: 30px;
            text-align: center;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }
        .success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            color: #4ade80;
        }
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #f87171;
        }
        .info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–¢–û –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Supabase</h1>
        
        <button onclick="addBTOManagerToDB()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î</button>
        <button onclick="checkUser()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <button onclick="showNetworks()">–ü–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ç–∏</button>

        <div id="result"></div>
    </div>

    <script type="module">
        const resultDiv = document.getElementById('result');
        
        function showResult(message, type = 'info') {
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ Supabase
        const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

        window.addBTOManagerToDB = async function() {
            try {
                showResult('üìä –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–¢–û –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...', 'info');

                const newUser = {
                    id: 'aa0e8400-e29b-41d4-a716-446655440005',
                    email: 'bto.manager@tradeframe.com',
                    password_hash: '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LeShMKjGEeILVSHFK', // admin123
                    name: '–ú–µ–Ω–µ–¥–∂–µ—Ä –ë–¢–û',
                    role: 'bto_manager',
                    network_id: 'b5e25b51-a950-481e-a09d-ac25e6b5d6ab', // ID —Å–µ—Ç–∏ –ë–¢–û –∏–∑ –ë–î
                    trading_point_ids: [],
                    is_active: true,
                    phone: null,
                    position: null,
                    telegram_notifications_enabled: true
                };

                const response = await fetch(`${supabaseUrl}/rest/v1/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${serviceRoleKey}`,
                        'apikey': serviceRoleKey,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(newUser)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }

                const result = await response.json();
                
                showResult(`‚úÖ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ú–ï–ù–ï–î–ñ–ï–†–ë–¢–û –î–û–ë–ê–í–õ–ï–ù –í –ë–ê–ó–£ –î–ê–ù–ù–´–•!

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç INSERT –æ–ø–µ—Ä–∞—Ü–∏–∏:
${JSON.stringify(result, null, 2)}

üë§ –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
‚Ä¢ ID: ${newUser.id}
‚Ä¢ Email: ${newUser.email}
‚Ä¢ –ò–º—è: ${newUser.name}
‚Ä¢ –†–æ–ª—å: ${newUser.role}
‚Ä¢ –°–µ—Ç—å: ${newUser.network_id} (–ë–¢–û)
‚Ä¢ –°—Ç–∞—Ç—É—Å: ${newUser.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
‚Ä¢ –ü–∞—Ä–æ–ª—å: admin123 (—Ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

üåê –ü–†–ò–í–Ø–ó–ö–ê –ö –°–ï–¢–ò:
‚Ä¢ ID —Å–µ—Ç–∏ –ë–¢–û: b5e25b51-a950-481e-a09d-ac25e6b5d6ab
‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: –ë–¢–û
‚Ä¢ External ID: 15

‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ Supabase!
üîê –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤–æ–π—Ç–∏: bto.manager@tradeframe.com / admin123`, 'success');

            } catch (error) {
                if (error.message.includes('duplicate key')) {
                    showResult(`‚ö†Ô∏è –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å email 'bto.manager@tradeframe.com' —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

üîÑ –ü–æ–ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...`, 'info');
                    
                    // –ü–æ–ø—ã—Ç–∫–∞ UPDATE
                    try {
                        const updateResponse = await fetch(`${supabaseUrl}/rest/v1/users?email=eq.bto.manager@tradeframe.com`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${serviceRoleKey}`,
                                'apikey': serviceRoleKey,
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                name: '–ú–µ–Ω–µ–¥–∂–µ—Ä –ë–¢–û',
                                role: 'bto_manager',
                                network_id: 'b5e25b51-a950-481e-a09d-ac25e6b5d6ab',
                                is_active: true
                            })
                        });

                        if (updateResponse.ok) {
                            const updateResult = await updateResponse.json();
                            showResult(`‚úÖ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –û–ë–ù–û–í–õ–ï–ù!

${JSON.stringify(updateResult, null, 2)}

üîÑ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.`, 'success');
                        } else {
                            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        }
                    } catch (updateError) {
                        showResult(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${updateError.message}`, 'error');
                    }
                } else {
                    showResult(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${error.message}`, 'error');
                }
            }
        };

        window.checkUser = async function() {
            try {
                showResult('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–¢–û –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');

                const response = await fetch(`${supabaseUrl}/rest/v1/users?email=eq.bto.manager@tradeframe.com`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${serviceRoleKey}`,
                        'apikey': serviceRoleKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                
                if (users.length === 0) {
                    showResult(`‚ùå –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –ù–ê–ô–î–ï–ù

Email: bto.manager@tradeframe.com –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è.`, 'error');
                } else {
                    const user = users[0];
                    showResult(`‚úÖ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ê–ô–î–ï–ù –í –ë–ê–ó–ï –î–ê–ù–ù–´–•!

üìä –î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users:
${JSON.stringify(user, null, 2)}

üë§ –û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
‚Ä¢ ID: ${user.id}
‚Ä¢ Email: ${user.email}
‚Ä¢ –ò–º—è: ${user.name}
‚Ä¢ –†–æ–ª—å: ${user.role}
‚Ä¢ –°—Ç–∞—Ç—É—Å: ${user.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω ‚úÖ' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω ‚ùå'}

üåê –ü–†–ò–í–Ø–ó–ö–ê –ö –°–ï–¢–ò:
‚Ä¢ Network ID: ${user.network_id}
‚Ä¢ Trading Points: ${JSON.stringify(user.trading_point_ids)}

üìÖ –í–†–ï–ú–ï–ù–ù–´–ï –ú–ï–¢–ö–ò:
‚Ä¢ –°–æ–∑–¥–∞–Ω: ${user.created_at}
‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω: ${user.updated_at}
‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥: ${user.last_login || '–ù–∏–∫–æ–≥–¥–∞'}

üîê –ì–û–¢–û–í –ö –í–•–û–î–£: bto.manager@tradeframe.com / admin123`, 'success');
                }

            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${error.message}`, 'error');
            }
        };

        window.showNetworks = async function() {
            try {
                showResult('üåê –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ç–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...', 'info');

                const response = await fetch(`${supabaseUrl}/rest/v1/networks`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${serviceRoleKey}`,
                        'apikey': serviceRoleKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const networks = await response.json();
                
                showResult(`üåê –î–û–°–¢–£–ü–ù–´–ï –°–ï–¢–ò –í –ë–ê–ó–ï –î–ê–ù–ù–´–•:

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ç–µ–π: ${networks.length}

${networks.map((network, index) => `
${index + 1}. ${network.name}
   ‚Ä¢ ID: ${network.id}
   ‚Ä¢ –ö–æ–¥: ${network.code}
   ‚Ä¢ External ID: ${network.external_id}
   ‚Ä¢ –°—Ç–∞—Ç—É—Å: ${network.status}
   ‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: ${network.description}
   ${network.external_id === "15" ? '   üéØ <- –°–ï–¢–¨ –ë–¢–û (–¥–ª—è –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–¢–û)' : ''}
`).join('')}

üéØ –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–¢–û –±—É–¥–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–µ—Ç–∏ —Å External ID = "15" (–ë–¢–û)
ID —Å–µ—Ç–∏ –ë–¢–û: ${networks.find(n => n.external_id === "15")?.id}`, 'success');

            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ç–µ–π: ${error.message}`, 'error');
            }
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            showNetworks();
        });
    </script>
</body>
</html>