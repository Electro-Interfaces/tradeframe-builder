<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ –≤–∏–¥–æ–≤ —Ç–æ–ø–ª–∏–≤–∞ - TradeFrame</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">üîç –û—Ç–ª–∞–¥–∫–∞ –≤–∏–¥–æ–≤ —Ç–æ–ø–ª–∏–≤–∞ –¥–ª—è —Ü–µ–Ω</h1>
        
        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Trading Point ID:</label>
                    <input type="text" id="tradingPointId" 
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">System Type:</label>
                    <input type="text" id="systemType" value="fuel_tank"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Limit:</label>
                    <input type="number" id="limit" value="100"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                </div>
            </div>
            <div class="mt-4">
                <button onclick="debugFuelTypes()" 
                        class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded mr-2">
                    üîç –û—Ç–ª–∞–¥–∏—Ç—å –≤–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞
                </button>
                <button onclick="checkTanksDirectly()" 
                        class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded mr-2">
                    üè™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã –Ω–∞–ø—Ä—è–º—É—é
                </button>
                <button onclick="clearResults()" 
                        class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    üßπ –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="results" class="space-y-4"></div>
    </div>

    <script>
        // Supabase connection
        const SUPABASE_URL = 'https://oojbhuwgdxnpcrzljzkm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vamJodXdnZHhucGNyemxqemttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyMjUzNzksImV4cCI6MjA0OTgwMTM3OX0.KXF1gEiAXWv-HVLCZFoHuIKVcjQIBSUPcROkfVMNHDY';

        async function debugFuelTypes() {
            const tradingPointId = document.getElementById('tradingPointId').value.trim();
            if (!tradingPointId) {
                addResult('error', '–í–≤–µ–¥–∏—Ç–µ Trading Point ID');
                return;
            }

            addResult('info', `üî• –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ª–∞–¥–∫—É –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏: ${tradingPointId}`);
            
            try {
                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã
                addResult('info', 'üìã –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤...');
                const tanks = await getTanksFromAPI(tradingPointId);
                
                if (!tanks || tanks.length === 0) {
                    addResult('error', '‚ùå –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –æ—à–∏–±–∫–∞ API');
                    return;
                }
                
                addResult('success', `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${tanks.length} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤`);
                
                // 2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤
                addResult('info', 'üîç –®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤...');
                
                tanks.forEach((tank, index) => {
                    const fuelType = tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'];
                    const capacity = tank.params?.['–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–ª)'];
                    const level = tank.params?.['–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å (–ª)'];
                    
                    const logData = {
                        index: index + 1,
                        id: tank.id,
                        name: tank.name,
                        status: tank.status,
                        fuelType: fuelType || '–ù–ï –£–ö–ê–ó–ê–ù',
                        capacity: capacity || '–ù–ï –£–ö–ê–ó–ê–ù',
                        level: level || '–ù–ï –£–ö–ê–ó–ê–ù',
                        allParams: Object.keys(tank.params || {})
                    };
                    
                    const statusClass = tank.status !== 'deleted' && fuelType ? 'info' : 'warning';
                    addResult(statusClass, 
                        `–†–µ–∑–µ—Ä–≤—É–∞—Ä ${index + 1}: ${tank.name} | 
                         –°—Ç–∞—Ç—É—Å: ${tank.status} | 
                         –¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞: ${fuelType || '–ù–ï –£–ö–ê–ó–ê–ù'} | 
                         –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${capacity || '–ù–ï –£–ö–ê–ó–ê–ù'} –ª | 
                         –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: [${Object.keys(tank.params || {}).join(', ')}]`
                    );
                });
                
                // 3. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ç–æ–ø–ª–∏–≤–∞
                addResult('info', 'üìä –®–∞–≥ 3: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ç–æ–ø–ª–∏–≤–∞...');
                
                const fuelTypesMap = new Map();
                const validTanks = tanks.filter(tank => tank.status !== 'deleted' && tank.params?.['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞']);
                
                addResult('info', `–í–∞–ª–∏–¥–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${validTanks.length} –∏–∑ ${tanks.length}`);
                
                validTanks.forEach(tank => {
                    const fuelType = tank.params['–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞'];
                    const capacity = parseFloat(tank.params['–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–ª)']) || 0;
                    const level = parseFloat(tank.params['–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å (–ª)']) || 0;
                    
                    if (!fuelTypesMap.has(fuelType)) {
                        fuelTypesMap.set(fuelType, {
                            tanks: [],
                            totalVolume: 0,
                            currentLevel: 0
                        });
                    }
                    
                    const fuelData = fuelTypesMap.get(fuelType);
                    fuelData.tanks.push(tank);
                    fuelData.totalVolume += capacity;
                    fuelData.currentLevel += level;
                });
                
                // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                addResult('info', `üèÅ –ò—Ç–æ–≥–æ –Ω–∞–π–¥–µ–Ω–æ ${fuelTypesMap.size} –≤–∏–¥–æ–≤ —Ç–æ–ø–ª–∏–≤–∞:`);
                
                fuelTypesMap.forEach((data, fuelType) => {
                    addResult('success', 
                        `${fuelType}: ${data.tanks.length} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤, 
                         –æ–±—â–∏–π –æ–±—ä—ë–º ${data.totalVolume} –ª, 
                         —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å ${data.currentLevel} –ª`
                    );
                });
                
                if (fuelTypesMap.size === 0) {
                    addResult('error', '‚ùå –í–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤.');
                }
                
            } catch (error) {
                addResult('error', `‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ª–∞–¥–∫–∏: ${error.message}`);
                console.error('Debug error:', error);
            }
        }

        async function checkTanksDirectly() {
            const tradingPointId = document.getElementById('tradingPointId').value.trim();
            if (!tradingPointId) {
                addResult('error', '–í–≤–µ–¥–∏—Ç–µ Trading Point ID');
                return;
            }

            try {
                addResult('info', `üè™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Supabase API...`);
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/equipment?trading_point_id=eq.${tradingPointId}&system_type=eq.fuel_tank&limit=100`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const tanks = await response.json();
                addResult('success', `‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${tanks.length} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π API`);
                
                tanks.forEach((tank, index) => {
                    addResult('info', 
                        `–†–µ–∑–µ—Ä–≤—É–∞—Ä ${index + 1}: ${tank.name} | 
                         ID: ${tank.id} | 
                         –°—Ç–∞—Ç—É—Å: ${tank.status} | 
                         Trading Point: ${tank.trading_point_id} | 
                         Params: ${JSON.stringify(tank.params, null, 2).substring(0, 200)}...`
                    );
                });
                
            } catch (error) {
                addResult('error', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
                console.error('Direct API error:', error);
            }
        }

        async function getTanksFromAPI(tradingPointId) {
            // –ò–º–∏—Ç–∞—Ü–∏—è –≤—ã–∑–æ–≤–∞ equipmentSupabase API
            const response = await fetch(`${SUPABASE_URL}/rest/v1/equipment?trading_point_id=eq.${tradingPointId}&system_type=eq.fuel_tank&limit=100`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }

        function addResult(type, message) {
            const results = document.getElementById('results');
            const colors = {
                'info': 'bg-blue-900 border-blue-600 text-blue-200',
                'success': 'bg-green-900 border-green-600 text-green-200', 
                'warning': 'bg-yellow-900 border-yellow-600 text-yellow-200',
                'error': 'bg-red-900 border-red-600 text-red-200'
            };
            
            const div = document.createElement('div');
            div.className = `border-l-4 p-4 rounded ${colors[type] || colors.info}`;
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="whitespace-pre-wrap font-mono text-sm">${message}</div>
                    <span class="text-xs opacity-70">${new Date().toLocaleTimeString()}</span>
                </div>
            `;
            
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º ID –µ—Å–ª–∏ –µ—Å—Ç—å –≤ URL
        const urlParams = new URLSearchParams(window.location.search);
        const autoId = urlParams.get('id');
        if (autoId) {
            document.getElementById('tradingPointId').value = autoId;
        }
    </script>
</body>
</html>