/**
 * Сервис для работы с инструкциями
 * Содержит mock-данные для всех страниц системы
 */

import { PersistentStorage } from '@/utils/persistentStorage';
import type {
  InstructionTopic,
  InstructionVersion,
  InstructionView,
  CreateInstructionTopicRequest,
  CreateInstructionVersionRequest,
  UpdateInstructionVersionRequest,
  InstructionForUser,
  InstructionStats,
  InstructionAnalytics,
  InstructionFilters,
  InstructionSearchResult,
  InstructionStatus,
  InstructionLocale
} from '@/types/instructions';

// Утилита для преобразования Markdown в HTML с поддержкой расширенных элементов
const markdownToHtml = (markdown: string): string => {
  return markdown
    // Заголовки
    .replace(/^### (.+)$/gm, '<h3 class="text-xl font-semibold text-slate-200 mb-3 mt-6 flex items-center gap-2">$1</h3>')
    .replace(/^## (.+)$/gm, '<h2 class="text-2xl font-bold text-blue-300 mb-5 mt-8 flex items-center gap-2 relative pl-6 before:absolute before:left-0 before:top-0 before:h-full before:w-1 before:bg-blue-500 before:rounded-full">$1</h2>')
    .replace(/^# (.+)$/gm, '<h1 class="text-3xl font-bold text-white mb-6 pb-3 border-b border-slate-600">$1</h1>')
    
    // Блоки кода с подсветкой
    .replace(/```([^`]+)```/gs, '<div class="bg-slate-900/80 border border-slate-700 rounded-lg p-4 my-4 font-mono text-sm overflow-x-auto"><pre class="text-green-300 whitespace-pre">$1</pre></div>')
    
    // Инлайн код
    .replace(/`([^`]+)`/g, '<code class="bg-slate-900/70 text-blue-300 px-2 py-1 rounded border border-slate-600 font-mono text-sm">$1</code>')
    
    // Цитаты
    .replace(/^> (.+)$/gm, '<blockquote class="border-l-4 border-blue-500 bg-blue-900/20 pl-4 py-2 my-4 italic text-slate-200 rounded-r-lg">$1</blockquote>')
    
    // Горизонтальные линии  
    .replace(/^---$/gm, '<hr class="border-slate-600 my-8 border-t-2">')
    
    // Жирный текст с подсветкой
    .replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-white bg-blue-900/30 px-1.5 py-0.5 rounded">$1</strong>')
    
    // Курсив
    .replace(/\*(.+?)\*/g, '<em class="italic text-slate-300">$1</em>')
    
    // Нумерованные списки
    .replace(/^(\d+)\. (.+)$/gm, '<li class="text-slate-200 mb-2 pl-2 relative"><span class="font-bold text-blue-400 mr-2">$1.</span>$2</li>')
    
    // Обычные списки с эмодзи
    .replace(/^- (.+)$/gm, '<li class="text-slate-200 mb-2 pl-6 relative before:absolute before:left-0 before:top-2 before:w-1.5 before:h-1.5 before:bg-blue-400 before:rounded-full">$1</li>')
    
    // Обертка списков
    .replace(/(<li[^>]*>.*<\/li>)/gs, '<ul class="space-y-2 my-4 ml-4">$1</ul>')
    
    // Параграфы
    .replace(/\n\n/g, '</p><p class="text-slate-200 leading-relaxed mb-4">')
    .replace(/^(?!<[h|u|l|b|d|p])/gm, '<p class="text-slate-200 leading-relaxed mb-4">')
    .replace(/$/gm, '</p>')
    
    // Очистка пустых параграфов
    .replace(/<p[^>]*><\/p>/g, '')
    .replace(/<p[^>]*>\s*<\/p>/g, '');
};

// Начальные темы инструкций для всех страниц
const initialTopics: InstructionTopic[] = [
  // Основные страницы
  {
    id: 'topic_1',
    key: 'dashboard',
    route: '/dashboard',
    title: 'Главная панель',
    description: 'Обзор основных показателей системы',
    is_active: true,
    views_total: 156,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_2',
    key: 'equipment',
    route: '/equipment',
    title: 'Оборудование',
    description: 'Управление оборудованием АЗС',
    is_active: true,
    views_total: 89,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_3',
    key: 'fuel-stocks',
    route: '/network/fuel-stocks',
    title: 'Остатки топлива',
    description: 'Мониторинг остатков топлива в резервуарах',
    is_active: true,
    views_total: 234,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Администрирование
  {
    id: 'topic_4',
    key: 'admin-users',
    route: '/admin/users',
    title: 'Пользователи',
    description: 'Управление пользователями системы',
    is_active: true,
    views_total: 67,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_5',
    key: 'admin-roles',
    route: '/admin/roles',
    title: 'Роли и права',
    description: 'Управление ролями и правами доступа',
    is_active: true,
    views_total: 45,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Настройки
  {
    id: 'topic_6',
    key: 'settings-templates',
    route: '/settings/templates',
    title: 'Шаблоны команд',
    description: 'Управление шаблонами команд для оборудования',
    is_active: true,
    views_total: 78,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_7',
    key: 'settings-connections',
    route: '/settings/connections',
    title: 'Подключения',
    description: 'Настройка подключений к внешним системам',
    is_active: true,
    views_total: 92,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Точки сети
  {
    id: 'topic_8',
    key: 'point-equipment',
    route: '/point/equipment',
    title: 'Оборудование точки',
    description: 'Управление оборудованием конкретной торговой точки',
    is_active: true,
    views_total: 123,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_9',
    key: 'point-tanks',
    route: '/point/tanks',
    title: 'Резервуары точки',
    description: 'Мониторинг резервуаров торговой точки',
    is_active: true,
    views_total: 167,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Системные страницы
  {
    id: 'topic_10',
    key: 'profile',
    route: '/profile',
    title: 'Профиль',
    description: 'Настройка профиля пользователя',
    is_active: true,
    views_total: 98,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Сетевые разделы
  {
    id: 'topic_11',
    key: 'operations-transactions',
    route: '/network/operations-transactions',
    title: 'Операции',
    description: 'Журнал операций и транзакций по сети АЗС',
    is_active: true,
    views_total: 132,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_12',
    key: 'price-history',
    route: '/network/price-history',
    title: 'История цен',
    description: 'Отслеживание изменений цен на топливо',
    is_active: true,
    views_total: 98,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_13',
    key: 'equipment-log',
    route: '/network/equipment-log',
    title: 'Журнал оборудования',
    description: 'История событий и операций с оборудованием',
    is_active: true,
    views_total: 87,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_14',
    key: 'notification-rules',
    route: '/network/notifications',
    title: 'Оповещения сети',
    description: 'Настройка правил уведомлений по сети',
    is_active: true,
    views_total: 76,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_15',
    key: 'messages',
    route: '/network/messages',
    title: 'Сообщения',
    description: 'Центр сообщений и уведомлений системы',
    is_active: true,
    views_total: 145,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Торговая точка
  {
    id: 'topic_16',
    key: 'point-prices',
    route: '/point/prices',
    title: 'Цены точки',
    description: 'Управление ценами конкретной торговой точки',
    is_active: true,
    views_total: 89,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_17',
    key: 'tanks',
    route: '/point/tanks',
    title: 'Резервуары',
    description: 'Мониторинг резервуаров торговой точки',
    is_active: true,
    views_total: 167,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_18',
    key: 'shift-reports',
    route: '/point/shift-reports',
    title: 'Сменные отчеты',
    description: 'Отчеты по сменам операторов АЗС',
    is_active: true,
    views_total: 134,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Администрирование (дополнительные разделы)
  {
    id: 'topic_19',
    key: 'admin-networks',
    route: '/admin/networks',
    title: 'Сети и ТТ',
    description: 'Управление торговыми сетями и точками',
    is_active: true,
    views_total: 78,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_20',
    key: 'admin-instructions',
    route: '/admin/instructions',
    title: 'Управление инструкциями',
    description: 'Создание и редактирование инструкций системы',
    is_active: true,
    views_total: 45,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_21',
    key: 'legal-documents',
    route: '/admin/legal-documents',
    title: 'Правовые документы',
    description: 'Управление правовыми документами и согласиями',
    is_active: true,
    views_total: 56,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  {
    id: 'topic_22',
    key: 'audit-log',
    route: '/admin/audit',
    title: 'Журнал аудита',
    description: 'Журнал действий пользователей в системе',
    is_active: true,
    views_total: 67,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  }
];

// Начальные версии инструкций с готовым контентом
const initialVersions: InstructionVersion[] = [
  // Главная панель
  {
    id: 'version_1',
    topic_id: 'topic_1',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Главная панель - руководство пользователя',
    content_md: `## Назначение страницы

Главная панель предоставляет общий обзор состояния системы и ключевые показатели работы сети АЗС.

## Основные разделы

**Виджеты статистики:**
- Количество активных АЗС
- Общий объем топлива в системе  
- Количество активного оборудования
- Статус подключений к внешним системам

**Быстрые действия:**
- Переход к мониторингу оборудования
- Просмотр остатков топлива
- Управление пользователями (для администраторов)

## Доступные действия

- **Обновить данные** - кнопка обновления в правом верхнем углу
- **Фильтр по сети** - выбор конкретной торговой сети для анализа
- **Переход к детальной информации** - клик по виджетам для перехода к соответствующим разделам`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 156,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Оборудование
  {
    id: 'version_2',
    topic_id: 'topic_2',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление оборудованием',
    content_md: `## Назначение страницы

Страница предназначена для мониторинга и управления всем оборудованием в сети АЗС.

## Основные элементы

**Таблица оборудования:**
- Название и тип устройства
- Статус работы (активно, обслуживание, ошибка)
- Торговая точка размещения
- Дата последнего обновления данных

**Панель фильтров:**
- Фильтр по типу оборудования
- Фильтр по статусу
- Поиск по названию

## Доступные действия

- **Просмотр деталей** - клик по строке оборудования
- **Редактирование** - кнопка "Редактировать" в строке
- **Добавление нового** - кнопка "Добавить оборудование"
- **Экспорт данных** - кнопка экспорта в правом верхнем углу`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 89,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Остатки топлива
  {
    id: 'version_3',
    topic_id: 'topic_3',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Мониторинг остатков топлива',
    content_md: `# ⛽ Мониторинг остатков топлива

> **Краткое описание:** Система реального времени для отслеживания остатков топлива по всей сети АЗС с интерактивной аналитикой и прогнозированием.

---

## 🎯 Назначение системы

Данная страница обеспечивает **централизованный мониторинг топливных остатков** по всей торговой сети, позволяя:

- 📊 **Контролировать уровни** во всех резервуарах сети
- 📈 **Анализировать динамику** расхода и поступления топлива  
- ⚠️ **Получать предупреждения** о критических уровнях
- 📋 **Планировать поставки** на основе прогнозов

---

## 📊 KPI-панель по видам топлива

\`\`\`
┌─ ТЕКУЩИЕ ОСТАТКИ ─────────────────────┐
│ 🟢 АИ-92   │ 2,847 т  │ ↗️ +127 т    │
│ 🔵 АИ-95   │ 1,923 т  │ ↘️ -54 т     │
│ 🟡 АИ-98   │ 486 т    │ → +12 т      │
│ ⚫ ДТ       │ 3,294 т  │ ↗️ +203 т    │
│ 🔴 АИ-100  │ 156 т    │ ↘️ -23 т     │
└────────────────────────────────────────┘
\`\`\`

**Каждый блок показывает:**
- 📦 **Общий объем** по всей сети (в тоннах)
- 📈 **Изменение за сутки** (зеленый ↗️ рост, красный ↘️ снижение)
- ⚡ **Статус критичности** (цветовая индикация)
- 🏪 **Количество АЗС** с данным видом топлива

---

## 📈 Интерактивный график аналитики

### Возможности графика:
- **📅 Гибкие периоды:** 7 дней → 30 дней → 3 месяца → 1 год
- **🔍 Детализация:** клик по точке = подробная информация
- **📊 Мультивыбор:** сравнение нескольких видов топлива одновременно
- **💹 Тренды:** автоматическое выделение тенденций и аномалий

### Типы отображения:
1️⃣ **Линейный график** - динамика остатков по времени  
2️⃣ **Столбчатая диаграмма** - сравнение объемов по АЗС  
3️⃣ **Тепловая карта** - распределение остатков по регионам

---

## 🏪 Детализация по АЗС

**Таблица резервуаров включает:**

| Параметр | Описание | Пример |
|----------|----------|---------|
| 🏢 **АЗС** | Название и адрес станции | "АЗС №24 - ул. Ленина, 15" |
| ⛽ **Тип топлива** | Марка с цветовой кодировкой | 🟢 АИ-92 |
| 📊 **Уровень** | Текущий объем / максимальная емкость | 15.2т / 20.0т |
| 📈 **Заполнение** | Процент заполнения резервуара | 76% |
| ⏰ **Последнее обновление** | Время получения данных | 2 мин назад |
| 🌡️ **Температура** | Температура продукта | +12.5°C |

---

## ⚙️ Интерактивные функции

### 1️⃣ Фильтрация данных

**По географии:**
- 🗺️ Выбор региона на интерактивной карте
- 🏪 Фильтр по конкретным АЗС (мультиселект)
- 📍 Поиск по адресу или названию станции

**По параметрам:**
- ⛽ Тип топлива (множественный выбор)
- 📊 Уровень заполнения (от-до в процентах)  
- ⚠️ Статус критичности (норма/низкий/критический)

### 2️⃣ Система уведомлений

\`Настройка алертов:\`
> **Пример:** Отправлять SMS при снижении АИ-92 на АЗС №15 ниже 3 тонн

- 📱 **Каналы:** Email, SMS, Push-уведомления, Telegram
- ⏰ **Расписание:** рабочее время, 24/7, выходные
- 👥 **Получатели:** операторы, менеджеры, руководство
- 🔔 **Приоритеты:** информация, предупреждение, критично

### 3️⃣ Экспорт и отчеты

**Быстрый экспорт:**
- 📊 **Excel** - таблица с текущими остатками
- 📈 **PDF** - графики и аналитические сводки
- 📋 **CSV** - данные для внешних систем

**Автоматические отчеты:**
- **📅 Ежедневные** - сводка по критическим уровням
- **📊 Недельные** - динамика расхода и поставок  
- **📈 Ежемесячные** - аналитика эффективности поставок

---

## 🚨 Система предупреждений

### Уровни критичности:

- 🟢 **НОРМА** (>50%) - стабильное состояние
- 🟡 **ВНИМАНИЕ** (20-50%) - планировать поставку
- 🟠 **НИЗКИЙ** (10-20%) - срочная поставка требуется  
- 🔴 **КРИТИЧНО** (<10%) - немедленные действия!

### Автоматические действия:
- **📧 Уведомления** отправляются автоматически
- **📋 Заявки на поставку** создаются в системе снабжения
- **📊 Отчеты для руководства** генерируются по критическим ситуациям

---

## 💡 Практические советы

> **💰 Оптимизация затрат:** Используйте прогнозы расхода для заказа оптимальных объемов поставок

**Рекомендации по использованию:**
- 🕐 **Проверяйте остатки** утром перед началом рабочего дня
- 📈 **Анализируйте тренды** для выявления аномального расхода  
- ⚠️ **Настройте уведомления** на критические уровни топлива
- 📊 **Используйте отчеты** для планирования закупок на месяц вперед
- 🗺️ **Мониторьте карту** для выявления региональных особенностей потребления

**Частые сценарии:**
- **Праздничные дни:** увеличенный расход, планировать дополнительные поставки
- **Технические работы:** временное отключение резервуаров
- **Сезонность:** летом больше АИ-95/98, зимой больше ДТ`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 234,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Пользователи
  {
    id: 'version_4',
    topic_id: 'topic_4',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление пользователями',
    content_md: `## Назначение страницы

Управление учетными записями пользователей системы, назначение ролей и контроль доступа.

## Основные элементы

**Таблица пользователей:**
- ФИО и email пользователя
- Назначенные роли
- Статус аккаунта (активен, заблокирован)
- Дата последнего входа

**Панель управления:**
- Кнопка добавления пользователя
- Фильтры по ролям и статусу
- Поиск по имени или email

## Доступные действия

- **Создать пользователя** - кнопка "Добавить пользователя"
- **Редактировать данные** - клик по строке пользователя
- **Изменить роли** - кнопка "Роли" в строке
- **Заблокировать/разблокировать** - переключатель статуса
- **Сбросить пароль** - опция в меню действий`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 67,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Роли и права
  {
    id: 'version_5',
    topic_id: 'topic_5',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление ролями и правами',
    content_md: `## Назначение страницы

Настройка ролей пользователей и управление правами доступа к различным разделам системы.

## Основные элементы

**Список ролей:**
- Название и описание роли
- Количество пользователей с данной ролью
- Статус роли (активна, неактивна)

**Конструктор прав:**
- Модули системы (Оборудование, Топливо, Администрирование)
- Действия для каждого модуля (просмотр, создание, редактирование, удаление)
- Специальные права (экспорт данных, просмотр аналитики)

## Доступные действия

- **Создать роль** - кнопка "Добавить роль"
- **Редактировать права** - клик по роли для открытия конструктора
- **Копировать роль** - создание роли на основе существующей
- **Удалить роль** - только для неиспользуемых ролей`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 45,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Профиль
  {
    id: 'version_6',
    topic_id: 'topic_10',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Настройка профиля пользователя',
    content_md: `## Назначение страницы

Страница профиля позволяет пользователям управлять личной информацией, настройками безопасности и просматривать свои права доступа.

## Основные разделы

**Вкладка "Профиль":**
- Редактирование имени и фамилии
- Изменение номера телефона
- Просмотр информации об учетной записи

**Вкладка "Безопасность":**
- Смена email адреса
- Изменение пароля
- Настройки двухфакторной аутентификации

**Вкладка "Доступ":**
- Просмотр назначенных ролей
- Список прав доступа к разделам системы
- История активности

## Доступные действия

- **Сохранить изменения профиля** - кнопка "Сохранить" в форме профиля
- **Изменить email** - форма смены электронной почты с подтверждением
- **Сменить пароль** - форма с текущим и новым паролем
- **Просмотр прав** - детализация доступных функций системы`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 98,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Резервуары точки
  {
    id: 'version_7',
    topic_id: 'topic_11',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Мониторинг резервуаров торговой точки',
    content_md: `## Назначение страницы

Детальный мониторинг состояния резервуаров конкретной торговой точки с возможностью управления и настройки оборудования.

## Основные элементы

**Карточки резервуаров:**
- Текущий уровень топлива в литрах и процентах
- Температура и плотность топлива
- Статус резервуара и датчиков
- Уровень воды в резервуаре

**Панель управления:**
- Фильтры по типу топлива и статусу
- Кнопки массовых операций
- Настройки уведомлений

**Детальная информация:**
- История операций наполнения/слива
- График изменения уровня топлива
- Калибровочные данные резервуара

## Доступные действия

- **Настройка резервуара** - клик по карточке резервуара
- **Планирование слива** - кнопка "Запланировать слив"
- **Калибровка резервуара** - загрузка новых калибровочных данных
- **Настройка уведомлений** - пороговые значения для оповещений`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 145,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Цены на топливо
  {
    id: 'version_8',
    topic_id: 'topic_12',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление ценами на топливо',
    content_md: `## Назначение страницы

Централизованное управление ценами на различные виды топлива по всей торговой сети с возможностью массового обновления.

## Основные функции

**Таблица цен:**
- Текущие цены по всем АЗС и видам топлива
- История изменения цен
- Статус синхронизации с оборудованием

**Массовые операции:**
- Обновление цен по всей сети
- Применение наценок и скидок
- Планирование изменения цен

**Аналитика цен:**
- Сравнение с конкурентами
- Анализ влияния на продажи
- Рекомендации по ценообразованию

## Доступные действия

- **Изменить цену** - клик по ячейке с ценой для редактирования
- **Массовое обновление** - выбор АЗС и применение новых цен
- **Планирование изменений** - установка даты и времени изменения цен
- **Экспорт отчета** - выгрузка данных по ценам в Excel`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 87,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Операции
  {
    id: 'version_9',
    topic_id: 'topic_11',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Журнал операций и транзакций',
    content_md: `## Назначение страницы

Отслеживание всех операций и транзакций, происходящих в торговой сети АЗС в режиме реального времени.

## Основные элементы

**Список операций:**
- Тип операции (продажа, поступление, инвентаризация)
- Торговая точка и оборудование
- Объем и сумма операции
- Дата и время выполнения

**Фильтры и поиск:**
- Фильтр по типу операций
- Выбор временного диапазона
- Поиск по номеру операции или оборудованию

## Доступные действия

- **Просмотр деталей** - клик по строке операции для подробной информации
- **Экспорт данных** - выгрузка операций в Excel
- **Фильтрация** - настройка отображаемых операций`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 132,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // История цен
  {
    id: 'version_10',
    topic_id: 'topic_12',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Отслеживание истории цен',
    content_md: `## Назначение страницы

Анализ изменений цен на топливо во времени с возможностью построения графиков и отчетов.

## Основные функции

**График изменений:**
- Визуализация изменения цен по видам топлива
- Сравнение цен между АЗС
- Выбор временного периода

**Таблица изменений:**
- История всех изменений цен
- Дата, время и инициатор изменения
- Старая и новая цена

## Доступные действия

- **Выбор периода** - настройка диапазона дат для анализа
- **Фильтр по топливу** - отображение конкретного вида топлива
- **Сравнение АЗС** - выбор станций для сравнения цен
- **Экспорт отчета** - сохранение данных в различных форматах`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 98,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Журнал оборудования
  {
    id: 'version_11',
    topic_id: 'topic_13',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'История событий оборудования',
    content_md: `## Назначение страницы

Централизованный журнал всех событий и операций с оборудованием по всей сети АЗС.

## Типы событий

**Операционные события:**
- Запуск и остановка оборудования
- Смена режимов работы
- Плановые и внеплановые операции

**Диагностические события:**
- Ошибки и предупреждения
- Результаты диагностики
- Статус датчиков и систем

## Доступные действия

- **Фильтрация по оборудованию** - выбор конкретного устройства
- **Фильтр по типу события** - отображение определенных типов
- **Временные рамки** - выбор периода для анализа
- **Детальный просмотр** - подробная информация о событии`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 87,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Сменные отчеты
  {
    id: 'version_12',
    topic_id: 'topic_18',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Отчеты по сменам операторов',
    content_md: `## Назначение страницы

Ведение и анализ сменных отчетов операторов АЗС с контролем показателей работы.

## Структура отчета

**Информация о смене:**
- Дата, время начала и окончания смены
- ФИО оператора и его роль
- Переданное и принятое оборудование

**Показатели смены:**
- Объем продаж по видам топлива
- Количество операций и средний чек
- Состояние оборудования на начало/конец смены

## Доступные действия

- **Создать отчет** - формирование нового сменного отчета
- **Просмотр архива** - история сменных отчетов
- **Анализ показателей** - сравнение эффективности смен
- **Печать отчета** - вывод на печать для подписания`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 134,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },
  
  // Недостающие версии для всех остальных тем
  
  // Пользователи (topic_4)
  {
    id: 'version_13',
    topic_id: 'topic_4',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление пользователями системы',
    content_md: `## Назначение страницы

Управление учетными записями пользователей системы, назначение ролей и контроль доступа к функционалу.

## Основные элементы

**Таблица пользователей:**
- ФИО и контактные данные пользователя
- Назначенные роли и уровень доступа
- Статус учетной записи (активен, заблокирован)
- История входов и активности

**Панель управления:**
- Создание новых пользователей
- Фильтры по ролям и статусу
- Поиск по имени или email
- Групповые операции

## Доступные действия

- **Создать пользователя** - форма регистрации нового пользователя с назначением ролей
- **Редактировать профиль** - изменение данных существующего пользователя
- **Управление ролями** - назначение и отзыв прав доступа
- **Блокировка аккаунта** - временное или постоянное ограничение доступа
- **Сброс пароля** - принудительная смена пароля пользователя`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Шаблоны команд (topic_6)
  {
    id: 'version_14',
    topic_id: 'topic_6',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление шаблонами команд',
    content_md: `## Назначение страницы

Создание и управление шаблонами команд для автоматизации работы с оборудованием АЗС.

## Основные элементы

**Библиотека шаблонов:**
- Готовые шаблоны команд по типам оборудования
- Пользовательские шаблоны команд
- Статус шаблона (активен, архив, черновик)
- Параметры и переменные команд

**Редактор команд:**
- Синтаксис команд для оборудования
- Валидация корректности команд
- Предварительный просмотр результата
- Тестирование на оборудовании

## Доступные действия

- **Создать шаблон** - разработка новой команды с параметрами
- **Редактировать команду** - изменение существующих шаблонов
- **Тестировать команду** - проверка работы на реальном оборудовании
- **Дублировать шаблон** - создание копии для модификации
- **Экспорт/импорт** - обмен шаблонами между системами`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Подключения (topic_7)
  {
    id: 'version_15',
    topic_id: 'topic_7',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Настройка подключений к внешним системам',
    content_md: `## Назначение страницы

Конфигурация интеграций с внешними системами, настройка протоколов обмена данными и мониторинг соединений.

## Основные элементы

**Список подключений:**
- Внешние системы (ERP, банковские системы, поставщики)
- Тип протокола (REST API, SOAP, FTP, Database)
- Статус соединения (активно, ошибка, отключено)
- Частота синхронизации данных

**Параметры подключения:**
- URL-адреса и порты
- Аутентификация и сертификаты
- Настройки таймаутов и повторов
- Логирование операций

## Доступные действия

- **Добавить подключение** - настройка нового внешнего соединения
- **Тестировать связь** - проверка доступности внешней системы
- **Настройки безопасности** - управление ключами и сертификатами
- **Журнал операций** - просмотр истории обмена данными
- **Синхронизация** - принудительное обновление данных`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Оборудование точки (topic_8)
  {
    id: 'version_16',
    topic_id: 'topic_8',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление оборудованием торговой точки',
    content_md: `## Назначение страницы

Мониторинг и управление оборудованием конкретной торговой точки АЗС в режиме реального времени.

## Основные элементы

**Карта оборудования:**
- ТРК (топливораздаточные колонки)
- Резервуары и системы измерения
- Системы безопасности и контроля
- Кассовое и вспомогательное оборудование

**Панель состояния:**
- Статус каждого устройства
- Текущие показания и параметры
- Активные тревоги и предупреждения
- График работы оборудования

## Доступные действия

- **Просмотр состояния** - детальная информация по каждому устройству
- **Управление ТРК** - включение/отключение колонок
- **Настройка параметров** - конфигурация рабочих параметров
- **История событий** - журнал работы оборудования
- **Техобслуживание** - планирование и учет ремонтных работ`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Резервуары точки (topic_9)
  {
    id: 'version_17',
    topic_id: 'topic_9',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Мониторинг резервуаров торговой точки',
    content_md: `## Назначение страницы

Контроль состояния топливных резервуаров конкретной АЗС с отображением уровней, температуры и качества топлива.

## Основные элементы

**Схема резервуарного парка:**
- 3D-визуализация резервуаров с уровнями заполнения
- Цветовая индикация состояния (норма, низкий уровень, критический)
- Показания датчиков уровня и температуры
- Информация о типе и качестве топлива

**Таблица данных:**
- Объем и процент заполнения каждого резервуара
- Температура продукта и плотность
- Расход за период и прогноз остатков
- История поставок и отгрузок

## Доступные действия

- **Детальный просмотр** - расширенная информация по резервуару
- **История изменений** - график изменения уровней за период
- **Настройка уведомлений** - пороги критических уровней
- **Планирование поставок** - расчет потребности в топливе
- **Отчеты по остаткам** - генерация отчетности для учета`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Оповещения сети (topic_14)
  {
    id: 'version_18',
    topic_id: 'topic_14',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление правилами уведомлений',
    content_md: `## Назначение страницы

Настройка системы уведомлений и оповещений для оперативного информирования о событиях в сети АЗС.

## Основные элементы

**Правила уведомлений:**
- Условия срабатывания (низкий уровень топлива, поломка оборудования)
- Каналы доставки (email, SMS, push-уведомления)
- Получатели и группы рассылки
- Расписание и ограничения отправки

**Шаблоны сообщений:**
- Текст уведомлений для разных типов событий
- Персонализация с использованием данных системы
- Мультиязычная поддержка
- Форматирование для разных каналов

## Доступные действия

- **Создать правило** - настройка нового типа уведомлений
- **Тестирование** - проверка доставки сообщений
- **Управление подписками** - назначение получателей уведомлений
- **Статистика доставки** - отчеты об отправленных сообщениях
- **Блокировка спама** - ограничения на частоту отправки`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Сообщения (topic_15)
  {
    id: 'version_19',
    topic_id: 'topic_15',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Центр сообщений системы',
    content_md: `## Назначение страницы

Центральный hub для просмотра всех уведомлений, сообщений и оповещений системы с возможностью управления статусами.

## Основные элементы

**Входящие сообщения:**
- Системные уведомления о событиях
- Административные сообщения
- Тревоги и предупреждения от оборудования
- Отчеты о выполненных операциях

**Панель фильтров:**
- Тип сообщения (информация, предупреждение, ошибка)
- Источник (система, оборудование, пользователи)
- Статус прочтения (новое, прочитанное, архив)
- Временной диапазон

## Доступные действия

- **Просмотр сообщений** - детальное содержание уведомлений
- **Массовые операции** - отметка как прочитанное, архивирование
- **Поиск и фильтрация** - быстрый поиск нужных сообщений
- **Настройки уведомлений** - управление подпиской на типы сообщений
- **Экспорт журнала** - сохранение истории сообщений`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Цены точки (topic_16)
  {
    id: 'version_20',
    topic_id: 'topic_16',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление ценами торговой точки',
    content_md: `# 💰 Управление ценами на топливо

## Назначение страницы

Страница предназначена для управления текущими ценами на различные виды топлива конкретной торговой точки. Позволяет просматривать актуальные цены, создавать новые ценовые предложения и планировать их применение.

## Основные элементы интерфейса

**Панель управления:**
- Выбор торговой точки из выпадающего списка
- Кнопка "Новая цена" для создания нового ценового предложения
- Кнопка "Обновить из сети" для синхронизации цен с торговой сетью
- Кнопка "Журнал" для просмотра истории изменений

**Плитки с ценами на топливо:**
Каждая плитка содержит:
- Название и код вида топлива (АИ-92, АИ-95, ДТ и др.)
- Цену без НДС и размер НДС
- Итоговую цену с НДС
- Статус цены (активно, запланировано, истекло)
- Дату и время применения цены

## Создание новой цены

Для создания новой цены:

1. Нажмите кнопку **"Новая цена"**
2. В открывшемся диалоге заполните:
   - **Вид топлива** - выберите из списка доступных
   - **Цену без НДС** в рублях
   - **Ставку НДС** в процентах
   - **Единицу измерения** (литр или килограмм)
   - **Дату и время применения** цены
3. При необходимости добавьте **комментарий**
4. Нажмите **"Создать"**

Цена с НДС рассчитывается автоматически.

## Редактирование существующих цен

Для изменения цены:

1. Нажмите кнопку **"Редактировать"** на нужной плитке
2. Внесите необходимые изменения в диалоговом окне
3. Нажмите **"Обновить"**

## Статусы цен

- **Активно** - цена действует в настоящий момент
- **Запланировано** - цена вступит в силу в указанное время
- **Истекло** - цена больше не действует

## Синхронизация с торговой сетью

Кнопка **"Обновить из сети"** позволяет:
- Получить актуальные цены с торговой точки
- Синхронизировать данные в случае расхождений
- Обновить кэш цен в системе

## Журнал изменений

В журнале отображается:
- Все изменения цен с указанием времени
- Автор изменения
- Старые и новые значения
- Источник изменения (ручной ввод, импорт, API)
- Статус применения

## Работа с торговыми точками

Перед началом работы необходимо выбрать торговую точку в верхней части страницы. Система отобразит цены только для выбранной точки.

Если точка не выбрана, отобразится сообщение с просьбой выбрать торговую точку.`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Резервуары (topic_17)
  {
    id: 'version_21',
    topic_id: 'topic_17',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Система мониторинга резервуаров',
    content_md: `## Назначение страницы

Профессиональный мониторинг топливных резервуаров с расширенной аналитикой и системой предупреждений.

## Основные элементы

**Панель мониторинга:**
- Реальное состояние всех резервуаров сети
- Критические уровни и предупреждения
- Температурные показатели и качество топлива
- Прогнозы расхода и планы поставок

**Система аналитики:**
- Статистика потребления по дням/неделям/месяцам
- Сравнительный анализ между точками
- Эффективность использования емкостей
- Прогнозирование потребностей

## Доступные действия

- **Мониторинг в реальном времени** - текущее состояние всех резервуаров
- **Настройка тревог** - пороговые значения для автоматических уведомлений
- **Планирование поставок** - расчет оптимальных объемов заказа
- **Аналитические отчеты** - детальная статистика по потреблению
- **Контроль качества** - мониторинг параметров топлива`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Сети и ТП (topic_19)
  {
    id: 'version_22',
    topic_id: 'topic_19',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление торговыми сетями и точками',
    content_md: `## Назначение страницы

Административное управление структурой торговых сетей, конфигурация торговых точек и их иерархии.

## Основные элементы

**Иерархия сетей:**
- Организационная структура торговых сетей
- Торговые точки и их группировка
- Географическое распределение объектов
- Административные права по уровням

**Параметры точек:**
- Адреса и контактная информация
- Техническая конфигурация оборудования
- Режимы работы и график
- Ответственные лица и персонал

## Доступные действия

- **Создать сеть/точку** - добавление новых объектов в структуру
- **Редактировать параметры** - изменение настроек существующих объектов
- **Управление иерархией** - перемещение точек между сетями
- **Контроль доступа** - назначение прав администрирования
- **Отчеты по структуре** - аналитика по сетевой структуре`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Управление инструкциями (topic_20)
  {
    id: 'version_23',
    topic_id: 'topic_20',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Система управления инструкциями',
    content_md: `## Назначение страницы

Административная панель для создания, редактирования и публикации инструкций пользователей системы.

## Основные элементы

**Библиотека инструкций:**
- Список всех тем инструкций в системе
- Статус публикации и версии документов
- Статистика просмотров пользователями
- Система контроля версий

**Редактор контента:**
- Markdown-редактор для создания инструкций
- Предварительный просмотр HTML-вывода  
- Система тегов и категорий
- Планировщик публикаций

## Доступные действия

- **Создать инструкцию** - новая тема с контентом и настройками
- **Редактировать версии** - изменение существующих инструкций
- **Управление публикацией** - контроль видимости для пользователей
- **Аналитика использования** - статистика по просмотрам и популярности
- **Экспорт документации** - генерация справочных материалов`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Правовые документы (topic_21)
  {
    id: 'version_24',
    topic_id: 'topic_21',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Управление правовыми документами',
    content_md: `## Назначение страницы

Управление правовой базой системы, создание пользовательских соглашений и контроль получения согласий.

## Основные элементы

**Документооборот:**
- Пользовательские соглашения и политики
- Согласия на обработку персональных данных
- Условия использования системы
- Регламенты и процедуры

**Система версионности:**
- Контроль изменений в правовых документах
- История публикаций и редакций
- Уведомления об обновлениях пользователей
- Архив предыдущих версий

## Доступные действия

- **Создать документ** - новый правовой документ с версионированием
- **Редактировать контент** - изменение существующих документов
- **Контроль согласий** - отслеживание принятия пользователями
- **Публикация версий** - управление доступностью документов
- **Аудит соответствия** - проверка соблюдения требований`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  },

  // Журнал аудита (topic_22)
  {
    id: 'version_25',
    topic_id: 'topic_22',
    version: 1,
    status: 'published',
    locale: 'ru',
    title: 'Журнал аудита системы',
    content_md: `## Назначение страницы

Система аудита и логирования всех действий пользователей для обеспечения безопасности и соблюдения нормативов.

## Основные элементы

**Журнал событий:**
- Все действия пользователей с временными метками
- Изменения в критичных данных системы
- Попытки несанкционированного доступа
- Технические операции и обслуживание

**Система фильтрации:**
- Поиск по пользователям и временным интервалам
- Фильтрация по типам операций и модулям
- Группировка событий по критичности
- Экспорт отфильтрованных данных

## Доступные действия

- **Просмотр журнала** - детальная информация о событиях системы
- **Поиск событий** - быстрый поиск по критериям и параметрам
- **Анализ безопасности** - выявление подозрительных действий
- **Генерация отчетов** - создание аудиторских отчетов
- **Архивирование** - долгосрочное хранение журналов`,
    content_html: '',
    changelog: 'Первая версия инструкции',
    editor_id: 'admin',
    editor_name: 'Администратор',
    published_at: '2024-12-01T14:30:00Z',
    views_count: 0,
    created_at: '2024-12-01T14:30:00Z',
    updated_at: '2024-12-01T14:30:00Z'
  }
];

// Преобразуем Markdown в HTML для всех версий
initialVersions.forEach(version => {
  version.content_html = markdownToHtml(version.content_md);
});

// Начальные просмотры для статистики
const initialViews: InstructionView[] = [
  {
    id: 'view_1',
    topic_id: 'topic_3',
    version_id: 'version_3',
    user_id: 'user_1',
    user_name: 'Иван Петров',
    opened_at: '2024-12-07T10:15:00Z'
  },
  {
    id: 'view_2',
    topic_id: 'topic_1',
    version_id: 'version_1',
    user_id: 'user_2',
    user_name: 'Мария Сидорова',
    opened_at: '2024-12-07T11:30:00Z'
  },
  {
    id: 'view_3',
    topic_id: 'topic_2',
    version_id: 'version_2',
    user_id: 'user_1',
    user_name: 'Иван Петров',
    opened_at: '2024-12-07T14:45:00Z'
  }
];

// Загрузка данных из localStorage
let topics = PersistentStorage.load<InstructionTopic[]>('instruction_topics', initialTopics);
let versions = PersistentStorage.load<InstructionVersion[]>('instruction_versions', initialVersions);
let views = PersistentStorage.load<InstructionView[]>('instruction_views', initialViews);

// Функции сохранения
const saveTopics = () => PersistentStorage.save('instruction_topics', topics);
const saveVersions = () => PersistentStorage.save('instruction_versions', versions);
const saveViews = () => PersistentStorage.save('instruction_views', views);

// Обновляем данные при разработке
if (!PersistentStorage.load<InstructionTopic[]>('instruction_topics', null)) {
  topics = [...initialTopics];
  versions = [...initialVersions];
  views = [...initialViews];
  
  saveTopics();
  saveVersions();
  saveViews();
} else {
  // Обновляем HTML для всех версий при загрузке
  versions.forEach(version => {
    if (!version.content_html || version.content_html === '') {
      version.content_html = markdownToHtml(version.content_md);
    }
  });
  saveVersions();
}

console.log('🚀 Инициализация сервиса инструкций:');
console.log('📚 Тем загружено:', topics.length);
console.log('📄 Версий загружено:', versions.length);
console.log('👀 Просмотров загружено:', views.length);

// Тестовая функция для отладки
(window as any).testInstructions = async () => {
  console.log('🧪 Тест инструкций:');
  const fuelStocksInstruction = await instructionsService.getInstructionForUser('fuel-stocks');
  console.log('Инструкция для fuel-stocks:', fuelStocksInstruction);
  return fuelStocksInstruction;
};

// Сервис для работы с инструкциями
export const instructionsService = {
  // Получить все темы
  async getTopics(filters?: InstructionFilters): Promise<InstructionTopic[]> {
    await new Promise(resolve => setTimeout(resolve, 150));
    
    let filteredTopics = [...topics];
    
    if (filters?.route) {
      filteredTopics = filteredTopics.filter(t => t.route.includes(filters.route!));
    }
    
    if (filters?.search) {
      const search = filters.search.toLowerCase();
      filteredTopics = filteredTopics.filter(t => 
        t.title.toLowerCase().includes(search) ||
        t.description?.toLowerCase().includes(search)
      );
    }
    
    // Добавляем текущую версию к каждой теме
    filteredTopics.forEach(topic => {
      const currentVersion = versions
        .filter(v => v.topic_id === topic.id && v.status === 'published')
        .sort((a, b) => b.version - a.version)[0];
      
      topic.current_version = currentVersion;
    });
    
    return filteredTopics.sort((a, b) => a.title.localeCompare(b.title));
  },

  // Получить тему по ключу или маршруту
  async getTopicByKey(key: string): Promise<InstructionTopic | null> {
    await new Promise(resolve => setTimeout(resolve, 100));
    
    const topic = topics.find(t => t.key === key || t.route === key);
    if (!topic) return null;
    
    // Добавляем текущую версию
    const currentVersion = versions
      .filter(v => v.topic_id === topic.id && v.status === 'published')
      .sort((a, b) => b.version - a.version)[0];
    
    topic.current_version = currentVersion;
    
    return topic;
  },

  // Получить инструкцию для пользователя
  async getInstructionForUser(routeOrKey: string): Promise<InstructionForUser | null> {
    await new Promise(resolve => setTimeout(resolve, 120));
    
    console.log('🔍 Ищем инструкцию для:', routeOrKey);
    console.log('📚 Доступные темы:', topics.map(t => ({ key: t.key, route: t.route, title: t.title })));
    
    const topic = topics.find(t => 
      t.key === routeOrKey || 
      t.route === routeOrKey || 
      t.route.includes(routeOrKey)
    );
    
    console.log('✅ Найденная тема:', topic ? { key: topic.key, route: topic.route, title: topic.title } : 'не найдено');
    
    if (!topic || !topic.is_active) return null;
    
    const publishedVersion = versions
      .filter(v => v.topic_id === topic.id && v.status === 'published')
      .sort((a, b) => b.version - a.version)[0];
    
    console.log('📄 Найденная версия:', publishedVersion ? { id: publishedVersion.id, title: publishedVersion.title, content_length: publishedVersion.content_html.length } : 'не найдено');
    
    if (!publishedVersion) return null;
    
    const hasNewerVersion = versions.some(v => 
      v.topic_id === topic.id && 
      v.version > publishedVersion.version && 
      v.status === 'draft'
    );
    
    return {
      topic,
      version: publishedVersion,
      has_newer_version: hasNewerVersion
    };
  },

  // Создать тему
  async createTopic(request: CreateInstructionTopicRequest): Promise<InstructionTopic> {
    await new Promise(resolve => setTimeout(resolve, 300));
    
    const newTopic: InstructionTopic = {
      id: `topic_${Date.now()}`,
      key: request.key,
      route: request.route,
      title: request.title,
      description: request.description,
      is_active: request.is_active ?? true,
      views_total: 0,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    
    topics.push(newTopic);
    saveTopics();
    
    return newTopic;
  },

  // Получить версии темы
  async getVersions(topicId: string): Promise<InstructionVersion[]> {
    await new Promise(resolve => setTimeout(resolve, 100));
    
    return versions
      .filter(v => v.topic_id === topicId)
      .sort((a, b) => b.version - a.version);
  },

  // Создать версию
  async createVersion(request: CreateInstructionVersionRequest): Promise<InstructionVersion> {
    await new Promise(resolve => setTimeout(resolve, 400));
    
    const topicVersions = versions.filter(v => v.topic_id === request.topic_id);
    const maxVersion = Math.max(0, ...topicVersions.map(v => v.version));
    
    const newVersion: InstructionVersion = {
      id: `version_${Date.now()}`,
      topic_id: request.topic_id,
      version: maxVersion + 1,
      status: 'draft',
      locale: request.locale || 'ru',
      title: request.title,
      content_md: request.content_md,
      content_html: markdownToHtml(request.content_md),
      changelog: request.changelog,
      editor_id: 'current_user',
      editor_name: 'Текущий пользователь',
      views_count: 0,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    
    versions.push(newVersion);
    saveVersions();
    
    return newVersion;
  },

  // Обновить версию
  async updateVersion(versionId: string, request: UpdateInstructionVersionRequest): Promise<InstructionVersion> {
    await new Promise(resolve => setTimeout(resolve, 350));
    
    const index = versions.findIndex(v => v.id === versionId);
    if (index === -1) {
      throw new Error('Версия не найдена');
    }
    
    const updated = {
      ...versions[index],
      ...request,
      updated_at: new Date().toISOString()
    };
    
    if (request.content_md) {
      updated.content_html = markdownToHtml(request.content_md);
    }
    
    versions[index] = updated;
    saveVersions();
    
    return updated;
  },

  // Опубликовать версию
  async publishVersion(versionId: string): Promise<InstructionVersion> {
    await new Promise(resolve => setTimeout(resolve, 250));
    
    const version = versions.find(v => v.id === versionId);
    if (!version) {
      throw new Error('Версия не найдена');
    }
    
    // Архивируем предыдущую опубликованную версию
    versions.forEach(v => {
      if (v.topic_id === version.topic_id && v.status === 'published') {
        v.status = 'archived';
      }
    });
    
    // Публикуем новую версию
    version.status = 'published';
    version.published_at = new Date().toISOString();
    version.updated_at = new Date().toISOString();
    
    saveVersions();
    
    return version;
  },

  // Логирование просмотра
  async logView(topicId: string, versionId: string, userId: string = 'anonymous'): Promise<void> {
    await new Promise(resolve => setTimeout(resolve, 100));
    
    const view: InstructionView = {
      id: `view_${Date.now()}`,
      topic_id: topicId,
      version_id: versionId,
      user_id: userId,
      user_name: userId === 'anonymous' ? 'Анонимный пользователь' : 'Пользователь',
      opened_at: new Date().toISOString()
    };
    
    views.push(view);
    saveViews();
    
    // Увеличиваем счетчики
    const topic = topics.find(t => t.id === topicId);
    if (topic) {
      topic.views_total += 1;
      saveTopics();
    }
    
    const version = versions.find(v => v.id === versionId);
    if (version) {
      version.views_count += 1;
      saveVersions();
    }
  },

  // Получить статистику
  async getStats(): Promise<InstructionStats> {
    await new Promise(resolve => setTimeout(resolve, 200));
    
    const activeTopics = topics.filter(t => t.is_active);
    const publishedVersions = versions.filter(v => v.status === 'published');
    
    const mostViewedTopics = topics
      .sort((a, b) => b.views_total - a.views_total)
      .slice(0, 5)
      .map(topic => ({
        topic,
        views: topic.views_total
      }));
    
    const recentViews = views
      .sort((a, b) => new Date(b.opened_at).getTime() - new Date(a.opened_at).getTime())
      .slice(0, 10);
    
    return {
      total_topics: topics.length,
      total_versions: versions.length,
      total_views: views.length,
      active_topics: activeTopics.length,
      published_versions: publishedVersions.length,
      most_viewed_topics: mostViewedTopics,
      recent_views: recentViews
    };
  },

  // Поиск инструкций
  async search(filters: InstructionFilters, page: number = 1, perPage: number = 20): Promise<InstructionSearchResult> {
    await new Promise(resolve => setTimeout(resolve, 300));
    
    const filteredTopics = await this.getTopics(filters);
    let filteredVersions = [...versions];
    
    if (filters.status) {
      filteredVersions = filteredVersions.filter(v => filters.status!.includes(v.status));
    }
    
    if (filters.search) {
      const search = filters.search.toLowerCase();
      filteredVersions = filteredVersions.filter(v =>
        v.title.toLowerCase().includes(search) ||
        v.content_md.toLowerCase().includes(search)
      );
    }
    
    const total = filteredTopics.length + filteredVersions.length;
    const startIndex = (page - 1) * perPage;
    const endIndex = startIndex + perPage;
    
    const combinedResults = [...filteredTopics, ...filteredVersions];
    const paginatedResults = combinedResults.slice(startIndex, endIndex);
    
    return {
      topics: paginatedResults.filter((item): item is InstructionTopic => 'key' in item) as InstructionTopic[],
      versions: paginatedResults.filter((item): item is InstructionVersion => 'version' in item) as InstructionVersion[],
      total,
      page,
      per_page: perPage
    };
  }
};