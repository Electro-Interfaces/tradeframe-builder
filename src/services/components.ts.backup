import { 
  Component, 
  ComponentTemplate,
  CreateComponentRequest, 
  UpdateComponentRequest,
  ComponentFilters,
  ListComponentsParams,
  ListComponentsResponse,
  ComponentStatusAction,
  ComponentEvent
} from '@/types/component';
import { componentTemplatesStore } from '@/mock/componentTemplatesStore';
import { PersistentStorage } from '@/utils/persistentStorage';

// –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è API
const API_BASE_URL = import.meta.env.VITE_API_URL || '/api/v1';

// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ç—Ä–µ–π—Å–∏–Ω–≥–æ–º
class ApiClient {
  private async request<T>(
    endpoint: string, 
    options: RequestInit = {}
  ): Promise<T> {
    const url = `${API_BASE_URL}${endpoint}`;
    const headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/problem+json',
      'X-Trace-Id': this.generateTraceId(),
      ...options.headers,
    };

    // –î–æ–±–∞–≤–ª—è–µ–º Idempotency-Key –¥–ª—è –º—É—Ç–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    if (['POST', 'PUT', 'PATCH'].includes(options.method || 'GET')) {
      headers['Idempotency-Key'] = this.generateIdempotencyKey();
    }

    const response = await fetch(url, {
      ...options,
      headers,
    });

    if (!response.ok) {
      throw new ApiError(response.status, await response.text());
    }

    return response.json();
  }

  private generateTraceId(): string {
    return Math.random().toString(36).substring(2, 15) + 
           Math.random().toString(36).substring(2, 15);
  }

  private generateIdempotencyKey(): string {
    return `${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
  }

  async get<T>(endpoint: string): Promise<T> {
    return this.request<T>(endpoint, { method: 'GET' });
  }

  async post<T>(endpoint: string, data: any): Promise<T> {
    return this.request<T>(endpoint, {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async patch<T>(endpoint: string, data: any): Promise<T> {
    return this.request<T>(endpoint, {
      method: 'PATCH',
      body: JSON.stringify(data),
    });
  }

  async delete<T>(endpoint: string): Promise<T> {
    return this.request<T>(endpoint, { method: 'DELETE' });
  }
}

class ApiError extends Error {
  constructor(public status: number, public body: string) {
    super(`API Error ${status}: ${body}`);
    this.name = 'ApiError';
  }
}

const apiClient = new ApiClient();

// Mock –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è –¥–µ–º–æ (–≤ production –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ API)
// –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π –ê–ó–°
const initialComponents: Component[] = [
  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ê–ó–° ‚Ññ001 - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è (point1)
  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞ ‚Ññ1 (–ê–ò-95) - eq_1 ===
  {
    id: "comp_001",
    trading_point_id: "point1",
    equipment_id: "eq_1",
    template_id: "comp_sensor_level_1",
    display_name: "–î–∞—Ç—á–∏–∫ —É—Ä–æ–≤–Ω—è —Ç–æ–ø–ª–∏–≤–∞ –ü–ú–ü-201",
    serial_number: "DUT2024001",
    params: {
      accuracy: 2.0,
      range_min: 0,
      range_max: 50000,
      calibration_factor: 1.0,
      current_level: 32500
    },
    status: 'online',
    created_at: new Date('2024-01-15').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  {
    id: "comp_002",
    trading_point_id: "point1",
    equipment_id: "eq_1",
    template_id: "comp_sensor_temp_1",
    display_name: "–î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞",
    serial_number: "TEMP2024001",
    params: {
      accuracy: 0.5,
      range_min: -40,
      range_max: 80,
      alarm_threshold: 45,
      current_temp: 18.5
    },
    status: 'online',
    created_at: new Date('2024-01-15').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  {
    id: "comp_003",
    trading_point_id: "point1",
    equipment_id: "eq_1",
    template_id: "comp_sensor_water_1",
    display_name: "–î–∞—Ç—á–∏–∫ —Ç–æ–≤–∞—Ä–Ω–æ–π –≤–æ–¥—ã",
    serial_number: "WATER2024001",
    params: {
      threshold_mm: 15,
      current_level_mm: 0,
      alarm_enabled: true
    },
    status: 'online',
    created_at: new Date('2024-01-15').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  
  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞ ‚Ññ2 (–ê–ò-92) - eq_2 ===
  {
    id: "comp_004",
    trading_point_id: "point1",
    equipment_id: "eq_2",
    template_id: "comp_sensor_level_1",
    display_name: "–î–∞—Ç—á–∏–∫ —É—Ä–æ–≤–Ω—è —Ç–æ–ø–ª–∏–≤–∞ –ü–ú–ü-201",
    serial_number: "DUT2024002",
    params: {
      accuracy: 2.0,
      range_min: 0,
      range_max: 50000,
      calibration_factor: 1.0,
      current_level: 41200
    },
    status: 'online',
    created_at: new Date('2024-02-20').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  {
    id: "comp_005",
    trading_point_id: "point1",
    equipment_id: "eq_2",
    template_id: "comp_sensor_temp_1",
    display_name: "–î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞",
    serial_number: "TEMP2024002",
    params: {
      accuracy: 0.5,
      range_min: -40,
      range_max: 80,
      alarm_threshold: 45,
      current_temp: 19.2
    },
    status: 'online',
    created_at: new Date('2024-02-20').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  
  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞ ‚Ññ3 (–î–¢) - eq_3 ===
  {
    id: "comp_006",
    trading_point_id: "point1",
    equipment_id: "eq_3",
    template_id: "comp_sensor_level_1",
    display_name: "–î–∞—Ç—á–∏–∫ —É—Ä–æ–≤–Ω—è —Ç–æ–ø–ª–∏–≤–∞ –ü–ú–ü-201",
    serial_number: "DUT2024003",
    params: {
      accuracy: 2.0,
      range_min: 0,
      range_max: 25000,
      calibration_factor: 1.0,
      current_level: 18750
    },
    status: 'online',
    created_at: new Date('2024-01-20').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  {
    id: "comp_007",
    trading_point_id: "point1",
    equipment_id: "eq_3",
    template_id: "comp_sensor_temp_1",
    display_name: "–î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞",
    serial_number: "TEMP2024003",
    params: {
      accuracy: 0.5,
      range_min: -40,
      range_max: 80,
      alarm_threshold: 45,
      current_temp: 17.8
    },
    status: 'online',
    created_at: new Date('2024-01-20').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  
  // === –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¢–†–ö ‚Ññ1 - eq_4 ===
  {
    id: "comp_008",
    trading_point_id: "point1",
    equipment_id: "eq_4",
    template_id: "comp_tso_display_1",
    display_name: "–î–∏—Å–ø–ª–µ–π —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è",
    serial_number: "DISP001234",
    params: {
      resolution: "1920x1080",
      brightness: 75,
      touchscreen: true,
      size_inch: 21.5
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  {
    id: "comp_009",
    trading_point_id: "point1",
    equipment_id: "eq_4",
    template_id: "comp_printer_1",
    display_name: "–ü—Ä–∏–Ω—Ç–µ—Ä —á–µ–∫–æ–≤",
    serial_number: "PR58001234",
    params: {
      paper_width: 58,
      print_speed: 150,
      auto_cut: true,
      encoding: "UTF-8"
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  {
    id: "comp_010",
    trading_point_id: "point1",
    equipment_id: "eq_4",
    template_id: "comp_pinpad_1",
    display_name: "–ü–∏–Ω–ø–∞–¥ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç",
    serial_number: "VF2001567",
    params: {
      connection_type: "USB",
      encryption_level: "AES256",
      timeout_seconds: 60
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  {
    id: "comp_011",
    trading_point_id: "point1",
    equipment_id: "eq_4",
    template_id: "comp_fuel_cardreader_1",
    display_name: "–°—á–∏—Ç—ã–≤–∞—Ç–µ–ª—å —Ç–æ–ø–ª–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç",
    serial_number: "FCR001234",
    params: {
      card_types: ["fuel_card", "fleet_card"],
      read_distance_cm: 5,
      encryption: true
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-08-30').toISOString()
  },
  {
    id: "comp_006",
    trading_point_id: "1",
    equipment_id: "eq_3", // –¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
    template_id: "comp_pinpad_1",
    display_name: "–ü–∏–Ω–ø–∞–¥ VeriFone",
    serial_number: "VF2001567",
    params: {
      connection_type: "USB",
      encryption_level: "AES256",
      timeout_seconds: 60
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-01-10').toISOString()
  },
  {
    id: "comp_007",
    trading_point_id: "1",
    equipment_id: "eq_3", // –¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
    template_id: "comp_tso_display_1",
    display_name: "–î–∏—Å–ø–ª–µ–π —Ç–µ—Ä–º–∏–Ω–∞–ª–∞",
    serial_number: "DISP001234",
    params: {
      resolution: "1920x1080",
      brightness: 75,
      touchscreen: true,
      size_inch: 21.5
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-01-10').toISOString()
  },
  
  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  {
    id: "comp_008",
    trading_point_id: "1",
    equipment_id: "eq_4", // –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    template_id: "comp_server_1",
    display_name: "–ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä",
    serial_number: "SRV001",
    params: {
      cpu_cores: 8,
      ram_gb: 32,
      storage_gb: 1000,
      os: "Linux"
    },
    status: 'online',
    created_at: new Date('2024-01-05').toISOString(),
    updated_at: new Date('2024-01-05').toISOString()
  },
  {
    id: "comp_009",
    trading_point_id: "1",
    equipment_id: "eq_4", // –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    template_id: "comp_ups_1",
    display_name: "–ò–ë–ü –æ—Å–Ω–æ–≤–Ω–æ–π",
    serial_number: "UPS001",
    params: {
      power_va: 3000,
      battery_runtime_min: 30,
      input_voltage: 220
    },
    status: 'online',
    created_at: new Date('2024-01-05').toISOString(),
    updated_at: new Date('2024-01-05').toISOString()
  },
  
  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç–∞–±–ª–æ —Ü–µ–Ω
  {
    id: "comp_010",
    trading_point_id: "1",
    equipment_id: "eq_5", // –¢–∞–±–ª–æ —Ü–µ–Ω
    template_id: "comp_price_panel_1",
    display_name: "–ü–∞–Ω–µ–ª—å –ê–ò-95",
    serial_number: "PANEL001A",
    params: {
      brightness: 5000,
      digits: 4,
      color: "red"
    },
    status: 'error',
    created_at: new Date('2024-03-01').toISOString(),
    updated_at: new Date('2024-03-01').toISOString()
  },
  {
    id: "comp_011",
    trading_point_id: "1",
    equipment_id: "eq_5", // –¢–∞–±–ª–æ —Ü–µ–Ω
    template_id: "comp_price_panel_1",
    display_name: "–ü–∞–Ω–µ–ª—å –ê–ò-92",
    serial_number: "PANEL001B",
    params: {
      brightness: 5000,
      digits: 4,
      color: "red"
    },
    status: 'online',
    created_at: new Date('2024-03-01').toISOString(),
    updated_at: new Date('2024-03-01').toISOString()
  },
  {
    id: "comp_012",
    trading_point_id: "1",
    equipment_id: "eq_5", // –¢–∞–±–ª–æ —Ü–µ–Ω
    template_id: "comp_price_panel_1",
    display_name: "–ü–∞–Ω–µ–ª—å –î–¢",
    serial_number: "PANEL001C",
    params: {
      brightness: 5000,
      digits: 4,
      color: "red"
    },
    status: 'online',
    created_at: new Date('2024-03-01').toISOString(),
    updated_at: new Date('2024-03-01').toISOString()
  },
  
  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è
  {
    id: "comp_013",
    trading_point_id: "1",
    equipment_id: "eq_6", // –í–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ
    template_id: "comp_cam_camera_1",
    display_name: "–ö–∞–º–µ—Ä–∞ –ø–µ—Ä–∏–º–µ—Ç—Ä 1",
    serial_number: "CAM001",
    params: {
      resolution: "4K",
      fps: 30,
      night_vision: true,
      ptz: false
    },
    status: 'online',
    created_at: new Date('2024-02-15').toISOString(),
    updated_at: new Date('2024-02-15').toISOString()
  },
  {
    id: "comp_014",
    trading_point_id: "1",
    equipment_id: "eq_6", // –í–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ
    template_id: "comp_cam_camera_1",
    display_name: "–ö–∞–º–µ—Ä–∞ –ø–µ—Ä–∏–º–µ—Ç—Ä 2",
    serial_number: "CAM002",
    params: {
      resolution: "4K",
      fps: 30,
      night_vision: true,
      ptz: false
    },
    status: 'online',
    created_at: new Date('2024-02-15').toISOString(),
    updated_at: new Date('2024-02-15').toISOString()
  },
  {
    id: "comp_015",
    trading_point_id: "1",
    equipment_id: "eq_6", // –í–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ
    template_id: "comp_cam_camera_1",
    display_name: "–ö–∞–º–µ—Ä–∞ –∫–∞—Å—Å–æ–≤–∞—è –∑–æ–Ω–∞",
    serial_number: "CAM003",
    params: {
      resolution: "4K",
      fps: 30,
      night_vision: false,
      ptz: false
    },
    status: 'online',
    created_at: new Date('2024-02-15').toISOString(),
    updated_at: new Date('2024-02-15').toISOString()
  },
  {
    id: "comp_016",
    trading_point_id: "1",
    equipment_id: "eq_6", // –í–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ
    template_id: "comp_cam_ctrl_1",
    display_name: "–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è",
    serial_number: "CAMCTRL001",
    params: {
      channels: 16,
      storage_tb: 8,
      retention_days: 30
    },
    status: 'online',
    created_at: new Date('2024-02-15').toISOString(),
    updated_at: new Date('2024-02-15').toISOString()
  },
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¢–†–ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
  {
    id: "comp_017",
    trading_point_id: "1",
    equipment_id: "eq_1", // –£—Å–ª–æ–≤–Ω–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—É
    template_id: "comp_pump_1",
    display_name: "–ù–∞—Å–æ—Å –ø–æ–¥–∞—á–∏ –ê-95",
    serial_number: "PUMP001",
    params: {
      flow_rate: 50,
      pressure_bar: 3.5,
      power_kw: 2.2
    },
    status: 'online',
    created_at: new Date('2024-01-15').toISOString(),
    updated_at: new Date('2024-01-15').toISOString()
  },
  {
    id: "comp_018",
    trading_point_id: "1",
    equipment_id: "eq_2", // –£—Å–ª–æ–≤–Ω–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—É
    template_id: "comp_pump_1",
    display_name: "–ù–∞—Å–æ—Å –ø–æ–¥–∞—á–∏ –ê-92",
    serial_number: "PUMP002",
    params: {
      flow_rate: 45,
      pressure_bar: 3.2,
      power_kw: 2.0
    },
    status: 'maintenance',
    created_at: new Date('2024-02-20').toISOString(),
    updated_at: new Date('2024-02-20').toISOString()
  },
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤
  {
    id: "comp_019",
    trading_point_id: "1",
    equipment_id: "eq_1", // –†–µ–∑–µ—Ä–≤—É–∞—Ä ‚Ññ1
    template_id: "comp_sensor_water_1",
    display_name: "–î–∞—Ç—á–∏–∫ —Ç–æ–≤–∞—Ä–Ω–æ–π –≤–æ–¥—ã –ê-95",
    serial_number: "WATER001",
    params: {
      sensitivity: 1.0,
      detection_level_mm: 10,
      alarm_enabled: true
    },
    status: 'online',
    created_at: new Date('2024-01-15').toISOString(),
    updated_at: new Date('2024-01-15').toISOString()
  },
  {
    id: "comp_020",
    trading_point_id: "1",
    equipment_id: "eq_1", // –†–µ–∑–µ—Ä–≤—É–∞—Ä ‚Ññ1
    template_id: "comp_sensor_leak_1",
    display_name: "–î–∞—Ç—á–∏–∫ —É—Ç–µ—á–∫–∏ –ê-95",
    serial_number: "LEAK001",
    params: {
      sensitivity: 0.1,
      response_time: 5,
      auto_shutdown: true
    },
    status: 'online',
    created_at: new Date('2024-01-15').toISOString(),
    updated_at: new Date('2024-01-15').toISOString()
  },
  {
    id: "comp_021",
    trading_point_id: "1",
    equipment_id: "eq_2", // –†–µ–∑–µ—Ä–≤—É–∞—Ä ‚Ññ2
    template_id: "comp_sensor_water_1",
    display_name: "–î–∞—Ç—á–∏–∫ —Ç–æ–≤–∞—Ä–Ω–æ–π –≤–æ–¥—ã –ê-92",
    serial_number: "WATER002",
    params: {
      sensitivity: 1.0,
      detection_level_mm: 10,
      alarm_enabled: true
    },
    status: 'error',
    created_at: new Date('2024-02-20').toISOString(),
    updated_at: new Date('2024-02-20').toISOString()
  },
  {
    id: "comp_022",
    trading_point_id: "1",
    equipment_id: "eq_2", // –†–µ–∑–µ—Ä–≤—É–∞—Ä ‚Ññ2
    template_id: "comp_sensor_leak_1",
    display_name: "–î–∞—Ç—á–∏–∫ —É—Ç–µ—á–∫–∏ –ê-92",
    serial_number: "LEAK002",
    params: {
      sensitivity: 0.1,
      response_time: 5,
      auto_shutdown: true
    },
    status: 'offline',
    created_at: new Date('2024-02-20').toISOString(),
    updated_at: new Date('2024-02-20').toISOString()
  },
  
  // –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¢–°–û
  {
    id: "comp_023",
    trading_point_id: "1",
    equipment_id: "eq_3", // –¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
    template_id: "comp_tso_sw_1",
    display_name: "–ü–û —Ç–µ—Ä–º–∏–Ω–∞–ª–∞",
    serial_number: "TSOSW001",
    params: {
      version: "2.5.0",
      license_type: "commercial",
      modules: ["payment", "loyalty", "reporting"]
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-01-10').toISOString()
  },
  {
    id: "comp_024",
    trading_point_id: "1",
    equipment_id: "eq_3", // –¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
    template_id: "comp_tso_fuelcr_1",
    display_name: "–ö–∞—Ä—Ç—Ä–∏–¥–µ—Ä —Ç–æ–ø–ª–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç",
    serial_number: "FUELCR001",
    params: {
      card_types: ["mifare", "em-marine"],
      encryption: "AES256",
      connection_type: "USB"
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-01-10').toISOString()
  },
  {
    id: "comp_025",
    trading_point_id: "1",
    equipment_id: "eq_3", // –¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
    template_id: "comp_tso_bankcr_1",
    display_name: "–ö–∞—Ä—Ç—Ä–∏–¥–µ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç",
    serial_number: "BANKCR001",
    params: {
      card_types: ["visa", "mastercard", "mir"],
      contactless: true,
      pci_compliant: true
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-01-10').toISOString()
  },
  {
    id: "comp_026",
    trading_point_id: "1",
    equipment_id: "eq_3", // –¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
    template_id: "comp_tso_kkt_1",
    display_name: "–ö–ö–¢ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞",
    serial_number: "KKT001",
    params: {
      model: "–ê–¢–û–õ 91–§",
      fiscal_memory: true,
      ofd_connection: "ethernet"
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-01-10').toISOString()
  },
  {
    id: "comp_027",
    trading_point_id: "1",
    equipment_id: "eq_3", // –¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
    template_id: "comp_tso_cashin_1",
    display_name: "–ö—É–ø—é—Ä–æ–ø—Ä–∏—ë–º–Ω–∏–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞",
    serial_number: "CASHIN001",
    params: {
      currency: ["RUB"],
      capacity: 600,
      recycling: false
    },
    status: 'maintenance',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-01-10').toISOString()
  },
  {
    id: "comp_028",
    trading_point_id: "1",
    equipment_id: "eq_3", // –¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
    template_id: "comp_tso_butrk_1",
    display_name: "–ë–£–¢–†–ö —Ç–µ—Ä–º–∏–Ω–∞–ª–∞",
    serial_number: "BUTRK001",
    params: {
      channels: 8,
      protocol: "IFSF",
      max_flow_rate: 130
    },
    status: 'online',
    created_at: new Date('2024-01-10').toISOString(),
    updated_at: new Date('2024-01-10').toISOString()
  },
  
  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  {
    id: "comp_029",
    trading_point_id: "1",
    equipment_id: "eq_4", // –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    template_id: "comp_sys_display_1",
    display_name: "–î–∏—Å–ø–ª–µ–π —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
    serial_number: "SYSDISP001",
    params: {
      resolution: "1920x1080",
      multi_touch: true,
      size_inch: 24
    },
    status: 'online',
    created_at: new Date('2024-01-05').toISOString(),
    updated_at: new Date('2024-01-05').toISOString()
  },
  {
    id: "comp_030",
    trading_point_id: "1",
    equipment_id: "eq_4", // –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    template_id: "comp_sys_sw_1",
    display_name: "–ü–û —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
    serial_number: "SYSSW001",
    params: {
      version: "3.0.0",
      database: "PostgreSQL",
      max_users: 50
    },
    status: 'online',
    created_at: new Date('2024-01-05').toISOString(),
    updated_at: new Date('2024-01-05').toISOString()
  },
  
  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç–∞–±–ª–æ —Ü–µ–Ω
  {
    id: "comp_031",
    trading_point_id: "1",
    equipment_id: "eq_5", // –¢–∞–±–ª–æ —Ü–µ–Ω
    template_id: "comp_price_ctrl_1",
    display_name: "–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Ç–∞–±–ª–æ",
    serial_number: "PRICECTRL001",
    params: {
      channels: 4,
      protocol: "RS485",
      update_interval: 60
    },
    status: 'online',
    created_at: new Date('2024-03-01').toISOString(),
    updated_at: new Date('2024-03-01').toISOString()
  },
  
  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–≤—É–∫–æ–≤–æ–≥–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è
  {
    id: "comp_032",
    trading_point_id: "1",
    equipment_id: "eq_4", // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    template_id: "comp_sound_ctrl_1",
    display_name: "–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∑–≤—É–∫–∞",
    serial_number: "SOUND001",
    params: {
      channels: 4,
      power_watts: 100,
      zones: 3
    },
    status: 'online',
    created_at: new Date('2024-01-05').toISOString(),
    updated_at: new Date('2024-01-05').toISOString()
  }
];

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
let mockComponents: Component[] = PersistentStorage.load<Component>('components', initialComponents);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
const saveComponents = () => {
  PersistentStorage.save('components', mockComponents);
};

// Mock API –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
export const mockComponentsAPI = {
  async list(params: ListComponentsParams = {}): Promise<ListComponentsResponse> {
    await new Promise(resolve => setTimeout(resolve, 300));
    
    let filteredComponents = [...mockComponents];
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    if (params.equipment_id) {
      filteredComponents = filteredComponents.filter(comp => comp.equipment_id === params.equipment_id);
    }
    
    if (params.status) {
      filteredComponents = filteredComponents.filter(comp => comp.status === params.status);
    }
    
    if (params.template_id) {
      filteredComponents = filteredComponents.filter(comp => comp.template_id === params.template_id);
    }
    
    if (params.search) {
      const searchLower = params.search.toLowerCase();
      filteredComponents = filteredComponents.filter(comp =>
        comp.display_name.toLowerCase().includes(searchLower) ||
        comp.serial_number?.toLowerCase().includes(searchLower)
      );
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    if (params.sort_by) {
      const sortBy = params.sort_by;
      const sortOrder = params.sort_order || 'asc';
      
      filteredComponents.sort((a, b) => {
        let valueA, valueB;
        
        switch (sortBy) {
          case 'display_name':
            valueA = a.display_name;
            valueB = b.display_name;
            break;
          case 'status':
            valueA = a.status;
            valueB = b.status;
            break;
          case 'created_at':
            valueA = a.created_at;
            valueB = b.created_at;
            break;
          case 'updated_at':
            valueA = a.updated_at;
            valueB = b.updated_at;
            break;
          default:
            return 0;
        }
        
        if (valueA < valueB) return sortOrder === 'asc' ? -1 : 1;
        if (valueA > valueB) return sortOrder === 'asc' ? 1 : -1;
        return 0;
      });
    }
    
    // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    const page = params.page || 1;
    const limit = params.limit || 20;
    const total = filteredComponents.length;
    const total_pages = Math.ceil(total / limit);
    const startIndex = (page - 1) * limit;
    const endIndex = startIndex + limit;
    
    const pageComponents = filteredComponents.slice(startIndex, endIndex);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —à–∞–±–ª–æ–Ω–∞—Ö
    const componentsWithTemplates = pageComponents.map(comp => ({
      ...comp,
      template: componentTemplatesStore.getById(comp.template_id)
    }));
    
    return {
      data: componentsWithTemplates,
      total,
      page,
      limit,
      total_pages
    };
  },

  async get(id: string): Promise<Component> {
    await new Promise(resolve => setTimeout(resolve, 200));
    
    const component = mockComponents.find(comp => comp.id === id);
    if (!component) {
      throw new ApiError(404, 'Component not found');
    }
    
    return {
      ...component,
      template: componentTemplatesStore.getById(component.template_id)
    };
  },

  async create(data: CreateComponentRequest): Promise<Component> {
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –±—ã–ª–æ –±—ã –ø–æ–ª—É—á–∏—Ç—å equipment template_id)
    // –î–ª—è –¥–µ–º–æ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç
    
    const newComponent: Component = {
      id: `comp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      trading_point_id: data.trading_point_id,
      equipment_id: data.equipment_id,
      template_id: data.template_id,
      display_name: data.overrides.display_name,
      serial_number: data.overrides.serial_number,
      params: {
        // –ë–µ—Ä–µ–º defaults –∏–∑ —à–∞–±–ª–æ–Ω–∞
        ...(componentTemplatesStore.getById(data.template_id)?.defaults || {}),
        // –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        ...(data.overrides.params || {})
      },
      status: 'online',
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ localStorage
    mockComponents.push(newComponent);
    saveComponents();
    
    return {
      ...newComponent,
      template: componentTemplatesStore.getById(newComponent.template_id)
    };
  },

  async update(id: string, data: UpdateComponentRequest): Promise<Component> {
    await new Promise(resolve => setTimeout(resolve, 300));
    
    const componentIndex = mockComponents.findIndex(comp => comp.id === id);
    if (componentIndex === -1) {
      throw new ApiError(404, 'Component not found');
    }
    
    const updatedComponent = {
      ...mockComponents[componentIndex],
      ...data,
      updated_at: new Date().toISOString()
    };
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    mockComponents[componentIndex] = updatedComponent;
    saveComponents();
    
    return {
      ...updatedComponent,
      template: componentTemplatesStore.getById(updatedComponent.template_id)
    };
  },

  async updateStatus(id: string, action: ComponentStatusAction): Promise<Component> {
    await new Promise(resolve => setTimeout(resolve, 200));
    
    const componentIndex = mockComponents.findIndex(comp => comp.id === id);
    if (componentIndex === -1) {
      throw new ApiError(404, 'Component not found');
    }
    
    // –ò–∑–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    let newStatus;
    switch (action) {
      case 'enable':
        newStatus = 'online';
        break;
      case 'disable':
        newStatus = 'disabled';
        break;
      case 'archive':
        newStatus = 'archived';
        break;
      default:
        throw new ApiError(400, 'Invalid status action');
    }
    
    const updatedComponent = {
      ...mockComponents[componentIndex],
      status: newStatus,
      updated_at: new Date().toISOString()
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ localStorage
    mockComponents[componentIndex] = updatedComponent;
    saveComponents();
    
    return {
      ...updatedComponent,
      template: componentTemplatesStore.getById(updatedComponent.template_id)
    };
  }
};

// –≠–∫—Å–ø–æ—Ä—Ç API –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
export const currentComponentsAPI = mockComponentsAPI;

// üîÑ –î–õ–Ø PRODUCTION: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∏–º–ø–æ—Ä—Ç –∏–∑ apiSwitch.ts:
// import { currentComponentsAPI } from './apiSwitch';