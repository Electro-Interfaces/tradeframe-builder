/**
 * Trading Points API Routes
 * –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—ã–º–∏ —Ç–æ—á–∫–∞–º–∏
 */

import { Router, Request, Response } from 'express';
import { z } from 'zod';
import { requireRole } from '../middleware/auth';
import { tradingPointsRepository } from '../database/repositories';

const router = Router();
const tradingPointsRepo = tradingPointsRepository;

// ===============================================
// VALIDATION SCHEMAS
// ===============================================

const CreateTradingPointSchema = z.object({
  network_id: z.string().min(1, "Network ID is required"),
  name: z.string().min(1, "Name is required"),
  description: z.string().optional(),
  address: z.string().min(1, "Address is required"),
  latitude: z.number().min(-90).max(90),
  longitude: z.number().min(-180).max(180),
  phone: z.string().optional(),
  email: z.string().email().optional(),
  schedule: z.object({
    monday: z.string().optional(),
    tuesday: z.string().optional(),
    wednesday: z.string().optional(),
    thursday: z.string().optional(),
    friday: z.string().optional(),
    saturday: z.string().optional(),
    sunday: z.string().optional(),
    is_always_open: z.boolean().default(false)
  }).optional(),
  services: z.record(z.boolean()).optional(),
  external_codes: z.array(z.object({
    system: z.string(),
    code: z.string()
  })).optional(),
  is_blocked: z.boolean().default(false)
});

const UpdateTradingPointSchema = z.object({
  name: z.string().optional(),
  description: z.string().optional(),
  address: z.string().optional(),
  latitude: z.number().min(-90).max(90).optional(),
  longitude: z.number().min(-180).max(180).optional(),
  phone: z.string().optional(),
  email: z.string().email().optional(),
  schedule: z.object({
    monday: z.string().optional(),
    tuesday: z.string().optional(),
    wednesday: z.string().optional(),
    thursday: z.string().optional(),
    friday: z.string().optional(),
    saturday: z.string().optional(),
    sunday: z.string().optional(),
    is_always_open: z.boolean().optional()
  }).optional(),
  services: z.record(z.boolean()).optional(),
  external_codes: z.array(z.object({
    system: z.string(),
    code: z.string()
  })).optional(),
  is_blocked: z.boolean().optional()
});

const ListTradingPointsSchema = z.object({
  network_id: z.string().optional(),
  search: z.string().optional(),
  is_blocked: z.boolean().optional(),
  page: z.coerce.number().min(1).default(1),
  limit: z.coerce.number().min(1).max(100).default(50)
});

// ===============================================
// ROUTES
// ===============================================

/**
 * @swagger
 * /trading-points:
 *   get:
 *     summary: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫
 *     tags: [Trading Points]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: network_id
 *         schema:
 *           type: string
 *         description: –§–∏–ª—å—Ç—Ä –ø–æ —Å–µ—Ç–∏
 *       - in: query
 *         name: search
 *         schema:
 *           type: string
 *         description: –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–¥—Ä–µ—Å—É
 *       - in: query
 *         name: is_blocked
 *         schema:
 *           type: boolean
 *         description: –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *           minimum: 1
 *           default: 1
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           minimum: 1
 *           maximum: 100
 *           default: 50
 *     responses:
 *       200:
 *         description: –°–ø–∏—Å–æ–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫
 *       403:
 *         description: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
 */
router.get('/', async (req: Request, res: Response) => {
  try {
    console.log('GET /trading-points - Start', req.query);
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Supabase  
    const validatedParams = ListTradingPointsSchema.parse(req.query);
    const result = await tradingPointsRepo.list(validatedParams);
    console.log('üéØ Trading points from Supabase:', result.data.length);
    
    res.json({
      success: true,
      data: result.data,
      total: result.total,
      page: result.page,
      totalPages: result.totalPages,
      message: `Found ${result.data.length} trading points`
    });
  } catch (error: any) {
    if (error.name === 'ZodError') {
      return res.status(400).json({
        error: 'Validation Error',
        details: error.errors
      });
    }
    
    console.error('Trading points list error:', error);
    res.status(500).json({
      error: 'Failed to fetch trading points',
      message: error.message
    });
  }
});

/**
 * @swagger
 * /trading-points:
 *   post:
 *     summary: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É
 *     tags: [Trading Points]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - network_id
 *               - name
 *               - address
 *               - latitude
 *               - longitude
 *             properties:
 *               network_id:
 *                 type: string
 *                 description: ID —Å–µ—Ç–∏
 *               name:
 *                 type: string
 *                 description: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
 *               description:
 *                 type: string
 *                 description: –û–ø–∏—Å–∞–Ω–∏–µ
 *               address:
 *                 type: string
 *                 description: –ê–¥—Ä–µ—Å
 *               latitude:
 *                 type: number
 *                 minimum: -90
 *                 maximum: 90
 *                 description: –®–∏—Ä–æ—Ç–∞
 *               longitude:
 *                 type: number
 *                 minimum: -180
 *                 maximum: 180
 *                 description: –î–æ–ª–≥–æ—Ç–∞
 *               phone:
 *                 type: string
 *                 description: –¢–µ–ª–µ—Ñ–æ–Ω
 *               email:
 *                 type: string
 *                 format: email
 *                 description: Email
 *               schedule:
 *                 type: object
 *                 description: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
 *               services:
 *                 type: object
 *                 description: –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏
 *               external_codes:
 *                 type: array
 *                 description: –í–Ω–µ—à–Ω–∏–µ –∫–æ–¥—ã
 *               is_blocked:
 *                 type: boolean
 *                 description: –°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
 *     responses:
 *       201:
 *         description: –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∞
 *       400:
 *         description: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
 *       403:
 *         description: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
 */
router.post('/', requireRole(['manager', 'network_admin', 'system_admin']), async (req: Request, res: Response) => {
  try {
    const data = CreateTradingPointSchema.parse(req.body);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ç–∏
    if (req.user?.role !== 'system_admin' && req.user?.network_id !== data.network_id) {
      return res.status(403).json({
        error: 'Access denied',
        message: 'Cannot create trading point in different network'
      });
    }
    
    const tradingPoint = await tradingPointsRepo.create(data, req.user?.id);
    
    res.status(201).json(tradingPoint);
  } catch (error: any) {
    if (error.name === 'ZodError') {
      return res.status(400).json({
        error: 'Validation Error',
        details: error.errors
      });
    }
    
    console.error('Trading point creation error:', error);
    res.status(500).json({
      error: 'Failed to create trading point',
      message: error.message
    });
  }
});

/**
 * @swagger
 * /trading-points/{id}:
 *   get:
 *     summary: –ü–æ–ª—É—á–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É –ø–æ ID
 *     tags: [Trading Points]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *         description: ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
 *     responses:
 *       200:
 *         description: –î–∞–Ω–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
 *       404:
 *         description: –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
 *       403:
 *         description: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
 */
router.get('/:id', requireRole(['operator', 'manager', 'network_admin', 'system_admin']), async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const tradingPoint = await tradingPointsRepo.getById(id, req.user?.network_id);
    
    if (!tradingPoint) {
      return res.status(404).json({
        error: 'Trading point not found'
      });
    }
    
    res.json(tradingPoint);
  } catch (error: any) {
    console.error('Trading point get error:', error);
    res.status(500).json({
      error: 'Failed to fetch trading point',
      message: error.message
    });
  }
});

/**
 * @swagger
 * /trading-points/{id}:
 *   patch:
 *     summary: –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É
 *     tags: [Trading Points]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *         description: ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             properties:
 *               name:
 *                 type: string
 *               description:
 *                 type: string
 *               address:
 *                 type: string
 *               latitude:
 *                 type: number
 *               longitude:
 *                 type: number
 *               phone:
 *                 type: string
 *               email:
 *                 type: string
 *               schedule:
 *                 type: object
 *               services:
 *                 type: object
 *               external_codes:
 *                 type: array
 *               is_blocked:
 *                 type: boolean
 *     responses:
 *       200:
 *         description: –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞
 *       400:
 *         description: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
 *       404:
 *         description: –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
 *       403:
 *         description: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
 */
router.patch('/:id', requireRole(['manager', 'network_admin', 'system_admin']), async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const data = UpdateTradingPointSchema.parse(req.body);
    
    const tradingPoint = await tradingPointsRepo.update(id, data, req.user?.network_id, req.user?.id);
    
    if (!tradingPoint) {
      return res.status(404).json({
        error: 'Trading point not found'
      });
    }
    
    res.json(tradingPoint);
  } catch (error: any) {
    if (error.name === 'ZodError') {
      return res.status(400).json({
        error: 'Validation Error',
        details: error.errors
      });
    }
    
    console.error('Trading point update error:', error);
    res.status(500).json({
      error: 'Failed to update trading point',
      message: error.message
    });
  }
});

/**
 * @swagger
 * /trading-points/{id}:
 *   delete:
 *     summary: –£–¥–∞–ª–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É
 *     tags: [Trading Points]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *         description: ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
 *     responses:
 *       200:
 *         description: –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞
 *       404:
 *         description: –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
 *       403:
 *         description: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
 *       409:
 *         description: –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
 */
router.delete('/:id', requireRole(['network_admin', 'system_admin']), async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    
    const success = await tradingPointsRepo.delete(id, req.user?.network_id, req.user?.id);
    
    if (!success) {
      return res.status(404).json({
        error: 'Trading point not found'
      });
    }
    
    res.json({ message: 'Trading point deleted successfully' });
  } catch (error: any) {
    if (error.message.includes('equipment exists')) {
      return res.status(409).json({
        error: 'Cannot delete trading point with existing equipment',
        message: 'Remove all equipment first'
      });
    }
    
    console.error('Trading point delete error:', error);
    res.status(500).json({
      error: 'Failed to delete trading point',
      message: error.message
    });
  }
});

/**
 * @swagger
 * /trading-points/{id}/toggle-block:
 *   post:
 *     summary: –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É
 *     tags: [Trading Points]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *         description: ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
 *     responses:
 *       200:
 *         description: –°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω
 *       404:
 *         description: –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
 *       403:
 *         description: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
 */
router.post('/:id/toggle-block', requireRole(['manager', 'network_admin', 'system_admin']), async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    
    const tradingPoint = await tradingPointsRepo.toggleBlock(id, req.user?.network_id, req.user?.id);
    
    if (!tradingPoint) {
      return res.status(404).json({
        error: 'Trading point not found'
      });
    }
    
    res.json({
      message: tradingPoint.is_blocked ? 'Trading point blocked' : 'Trading point unblocked',
      is_blocked: tradingPoint.is_blocked
    });
  } catch (error: any) {
    console.error('Trading point toggle block error:', error);
    res.status(500).json({
      error: 'Failed to toggle trading point block status',
      message: error.message
    });
  }
});

/**
 * @swagger
 * /trading-points/{id}/equipment:
 *   get:
 *     summary: –ü–æ–ª—É—á–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
 *     tags: [Trading Points]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *         description: ID —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
 *     responses:
 *       200:
 *         description: –°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
 *       404:
 *         description: –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
 *       403:
 *         description: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
 */
router.get('/:id/equipment', requireRole(['operator', 'manager', 'network_admin', 'system_admin']), async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    
    const equipment = await tradingPointsRepo.getEquipment(id, req.user?.network_id);
    
    res.json(equipment);
  } catch (error: any) {
    console.error('Trading point equipment error:', error);
    res.status(500).json({
      error: 'Failed to fetch trading point equipment',
      message: error.message
    });
  }
});

// –¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç –±–µ–∑ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
router.get('/test', (req, res) => {
  res.json({ success: true, message: 'Test route works!' });
});

export { router as tradingPointsRouter };