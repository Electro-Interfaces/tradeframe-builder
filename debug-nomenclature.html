<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –û—Ç–ª–∞–¥–∫–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 11px; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <h1>üîç –û—Ç–ª–∞–¥–∫–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –≤ Supabase</h1>
    
    <div class="section info">
        <h3>üö® –ü—Ä–æ–±–ª–µ–º–∞:</h3>
        <p>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –ø—É—Å—Ç–æ–π –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, —Ö–æ—Ç—è –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ Supabase</p>
    </div>
    
    <div class="section">
        <button onclick="checkSupabaseData()">üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Supabase</button>
        <button onclick="testNomenclatureQuery()">üîç –¢–µ—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã</button>
        <button onclick="checkExternalCodes()">üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∫–æ–¥—ã</button>
        <button onclick="testDirectQuery()">‚ö° –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç API</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://tohtryzyffcebtyvkxwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzU0NDgsImV4cCI6MjA3MjQ1MTQ0OH0.NMpuTp08vLuxhRLxbI9lOAo6JI22-8eDcMRylE3MoqI'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function logResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `section ${type}`
            
            let content = `<h4>${message}</h4>`
            if (data) {
                if (typeof data === 'string') {
                    content += `<pre>${data}</pre>`
                } else {
                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            }
            div.innerHTML = content
            
            resultsDiv.appendChild(div)
        }

        window.checkSupabaseData = async function() {
            logResult('üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –≤ Supabase...', 'info')
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É nomenclature
                const { data: nomenclatureData, error: nomenclatureError } = await supabase
                    .from('nomenclature')
                    .select('*')
                    .order('name')
                
                if (nomenclatureError) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã:', 'error', nomenclatureError)
                    return
                }
                
                logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${nomenclatureData?.length || 0} –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ nomenclature:`, 'success', nomenclatureData)
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–¥–æ–≤
                const { data: codesData, error: codesError } = await supabase
                    .from('nomenclature_external_codes')
                    .select('*')
                    .order('nomenclature_id')
                
                if (codesError) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–¥–æ–≤:', 'error', codesError)
                } else {
                    logResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${codesData?.length || 0} –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ nomenclature_external_codes:`, 'info', codesData)
                }
                
            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Supabase:', 'error', error)
            }
        }

        window.testNomenclatureQuery = async function() {
            logResult('üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –∫–∞–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏...', 'info')
            
            try {
                // –ò–º–∏—Ç–∏—Ä—É–µ–º —Ç–æ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏–∑ nomenclatureService.ts
                const query = supabase
                    .from('nomenclature')
                    .select(`
                        id,
                        network_id,
                        name,
                        internal_code,
                        network_api_code,
                        network_api_settings,
                        description,
                        status,
                        external_id,
                        created_at,
                        updated_at,
                        created_by,
                        updated_by,
                        networks!inner(
                            id,
                            name
                        )
                    `)
                    .order('name')

                const { data: nomenclatureData, error: nomenclatureError } = await query

                if (nomenclatureError) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ JOIN –∑–∞–ø—Ä–æ—Å–∞ —Å networks:', 'error', nomenclatureError)
                    
                    // –ü–æ–ø—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å –±–µ–∑ JOIN
                    logResult('üîß –ü—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å –±–µ–∑ JOIN...', 'warning')
                    
                    const { data: simpleData, error: simpleError } = await supabase
                        .from('nomenclature')
                        .select('*')
                        .order('name')
                    
                    if (simpleError) {
                        logResult('‚ùå –î–∞–∂–µ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:', 'error', simpleError)
                    } else {
                        logResult('‚úÖ –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç:', 'success', simpleData)
                        logResult('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ –≤ JOIN —Å —Ç–∞–±–ª–∏—Ü–µ–π networks', 'warning')
                    }
                    
                    return
                }

                logResult('‚úÖ JOIN –∑–∞–ø—Ä–æ—Å —Å networks —Ä–∞–±–æ—Ç–∞–µ—Ç:', 'success', nomenclatureData)

                // –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∫–æ–¥—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
                if (nomenclatureData && nomenclatureData.length > 0) {
                    const nomenclatureIds = nomenclatureData.map(item => item.id)
                    const { data: externalCodes, error: codesError } = await supabase
                        .from('nomenclature_external_codes')
                        .select('*')
                        .in('nomenclature_id', nomenclatureIds)
                        .order('system_type')

                    if (codesError) {
                        logResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–¥–æ–≤:', 'error', codesError)
                    } else {
                        logResult(`‚úÖ –í–Ω–µ—à–Ω–∏–µ –∫–æ–¥—ã –ø–æ–ª—É—á–µ–Ω—ã (${externalCodes?.length || 0} –∑–∞–ø–∏—Å–µ–π):`, 'success', externalCodes)
                    }
                }

            } catch (error) {
                logResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞:', 'error', error)
            }
        }

        window.checkExternalCodes = async function() {
            logResult('üîó –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏...', 'info')
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ ID –≤ nomenclature
                const { data: nomenclatureIds, error: idsError } = await supabase
                    .from('nomenclature')
                    .select('id, name')
                    .order('name')
                
                if (idsError) {
                    logResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã:', 'error', idsError)
                    return
                }
                
                logResult(`üìã ID –∑–∞–ø–∏—Å–µ–π –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã:`, 'info', nomenclatureIds)
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤—è–∑–∏ –≤ external_codes
                for (const item of nomenclatureIds || []) {
                    const { data: codes, error: codesError } = await supabase
                        .from('nomenclature_external_codes')
                        .select('*')
                        .eq('nomenclature_id', item.id)
                    
                    if (codesError) {
                        logResult(`‚ùå –û—à–∏–±–∫–∞ –¥–ª—è ${item.name}:`, 'error', codesError)
                    } else {
                        logResult(`‚úÖ ${item.name}: –Ω–∞–π–¥–µ–Ω–æ ${codes?.length || 0} –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–¥–æ–≤`, codes?.length ? 'success' : 'warning', codes)
                    }
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–µ–π:', 'error', error)
            }
        }

        window.testDirectQuery = async function() {
            logResult('‚ö° –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç API –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...', 'info')
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—è–º–∏
                const { data: networks, error: networksError } = await supabase
                    .from('networks')
                    .select('*')
                    .order('name')
                
                if (networksError) {
                    logResult('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π networks:', 'error', networksError)
                } else {
                    logResult(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ networks —Ä–∞–±–æ—Ç–∞–µ—Ç (${networks?.length} –∑–∞–ø–∏—Å–µ–π):`, 'success', networks)
                }
                
                // –ü—Ä–æ–±—É–µ–º LEFT JOIN –≤–º–µ—Å—Ç–æ INNER JOIN
                logResult('üîß –ü—Ä–æ–±—É–µ–º LEFT JOIN –≤–º–µ—Å—Ç–æ INNER JOIN...', 'info')
                
                const { data: leftJoinData, error: leftJoinError } = await supabase
                    .from('nomenclature')
                    .select(`
                        id,
                        network_id,
                        name,
                        internal_code,
                        network_api_code,
                        network_api_settings,
                        description,
                        status,
                        external_id,
                        created_at,
                        updated_at,
                        created_by,
                        updated_by,
                        networks(
                            id,
                            name
                        )
                    `)
                    .order('name')

                if (leftJoinError) {
                    logResult('‚ùå LEFT JOIN —Ç–æ–∂–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:', 'error', leftJoinError)
                } else {
                    logResult('‚úÖ LEFT JOIN —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success', leftJoinData)
                }
                
            } catch (error) {
                logResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä—è–º–æ–≥–æ —Ç–µ—Å—Ç–∞ API:', 'error', error)
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 500))
            await checkSupabaseData()
        })
    </script>
</body>
</html>