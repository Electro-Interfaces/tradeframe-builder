<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>üîß Schema Structure Verification</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .log { background: #111; padding: 15px; margin: 10px 0; border: 1px solid #0f0; }
        button { background: #0f0; color: #000; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
        pre { background: #222; padding: 10px; border-left: 3px solid #0f0; }
    </style>
</head>
<body>
    <h1>üîß Schema Structure Verification</h1>
    <button onclick="verifySchema()">üîç Verify Table Schema</button>
    <button onclick="testCreateMinimal()">üß™ Test Minimal CREATE</button>
    <div id="result" class="log"></div>

    <script>
        const SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';
        const URL = 'https://tohtryzyffcebtyvkxwh.supabase.co';

        function log(msg, type = 'info') {
            const div = document.getElementById('result');
            const time = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            div.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
        }

        async function verifySchema() {
            document.getElementById('result').innerHTML = '';
            log('üîç Checking equipment_templates table schema...', 'warning');

            try {
                // Get table structure from information_schema
                const schemaQuery = `
                    SELECT 
                        column_name,
                        data_type,
                        is_nullable,
                        column_default
                    FROM information_schema.columns 
                    WHERE table_name = 'equipment_templates' 
                    AND table_schema = 'public'
                    ORDER BY ordinal_position
                `;

                const response = await fetch(`${URL}/rest/v1/rpc/get_table_schema`, {
                    method: 'POST',
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        table_name: 'equipment_templates' 
                    })
                });

                if (!response.ok) {
                    // Try direct query instead
                    log('‚ö†Ô∏è RPC not available, checking with direct SELECT...', 'warning');
                    
                    // Get first record to see actual columns
                    const directResponse = await fetch(`${URL}/rest/v1/equipment_templates?limit=1`, {
                        headers: {
                            'apikey': SERVICE_KEY,
                            'Authorization': `Bearer ${SERVICE_KEY}`
                        }
                    });

                    if (directResponse.ok) {
                        const data = await directResponse.json();
                        log('‚úÖ Table accessible, sample record structure:', 'success');
                        if (data.length > 0) {
                            const columns = Object.keys(data[0]);
                            log(`üìã Columns found: ${columns.join(', ')}`, 'info');
                            
                            if (columns.includes('status')) {
                                log('‚úÖ STATUS column EXISTS in actual data!', 'success');
                            } else {
                                log('‚ùå STATUS column MISSING from actual data!', 'error');
                            }
                            
                            log('üìä Sample record:', 'info');
                            log(`<pre>${JSON.stringify(data[0], null, 2)}</pre>`, 'info');
                        }
                    } else {
                        log(`‚ùå Table check failed: ${directResponse.status}`, 'error');
                    }
                } else {
                    const schemaData = await response.json();
                    log('‚úÖ Schema information retrieved:', 'success');
                    log(`<pre>${JSON.stringify(schemaData, null, 2)}</pre>`, 'info');
                }

                // Also check if we can get table metadata
                log('\nüîç Checking table metadata...', 'info');
                const metaResponse = await fetch(`${URL}/rest/v1/?select=*`, {
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`,
                        'Accept': 'application/vnd.pgrst.object+json'
                    }
                });

                if (metaResponse.ok) {
                    const metadata = await metaResponse.text();
                    log('üìã API Metadata available', 'success');
                    log('üí° This means PostgREST is working but may have schema cache issue', 'warning');
                }

            } catch (error) {
                log(`‚ùå Schema verification failed: ${error.message}`, 'error');
            }
        }

        async function testCreateMinimal() {
            log('\nüß™ Testing minimal CREATE without status column...', 'info');

            try {
                const testId = 'schema-test-' + Date.now();
                
                // Try CREATE without status field
                const minimalPayload = {
                    id: testId,
                    name: 'Schema Test Minimal',
                    technical_code: 'SCHEMA_MIN_' + Date.now(),
                    system_type: 'test'
                };

                log('üì§ Attempting CREATE without status field...', 'info');
                log(`Payload: ${JSON.stringify(minimalPayload, null, 2)}`, 'info');

                const response = await fetch(`${URL}/rest/v1/equipment_templates`, {
                    method: 'POST',
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(minimalPayload)
                });

                if (response.ok) {
                    log('‚úÖ Minimal CREATE succeeded!', 'success');
                    const result = await response.json();
                    log(`Created: ${JSON.stringify(result, null, 2)}`, 'success');
                    
                    // Clean up
                    setTimeout(async () => {
                        await fetch(`${URL}/rest/v1/equipment_templates?id=eq.${testId}`, {
                            method: 'DELETE',
                            headers: { 'apikey': SERVICE_KEY, 'Authorization': `Bearer ${SERVICE_KEY}` }
                        });
                        log('üßπ Test record cleaned up', 'info');
                    }, 1000);
                    
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Minimal CREATE failed: ${response.status}`, 'error');
                    log(`Error: ${errorText}`, 'error');
                    
                    // Try with status field as default true
                    log('\nüîÑ Trying with explicit status=true...', 'info');
                    const fullPayload = { ...minimalPayload, status: true };
                    
                    const retryResponse = await fetch(`${URL}/rest/v1/equipment_templates`, {
                        method: 'POST',
                        headers: {
                            'apikey': SERVICE_KEY,
                            'Authorization': `Bearer ${SERVICE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(fullPayload)
                    });

                    if (retryResponse.ok) {
                        log('‚úÖ CREATE with explicit status succeeded!', 'success');
                        const retryResult = await retryResponse.json();
                        log(`Created: ${JSON.stringify(retryResult, null, 2)}`, 'success');
                        
                        // Clean up
                        setTimeout(async () => {
                            await fetch(`${URL}/rest/v1/equipment_templates?id=eq.${testId}`, {
                                method: 'DELETE',
                                headers: { 'apikey': SERVICE_KEY, 'Authorization': `Bearer ${SERVICE_KEY}` }
                            });
                            log('üßπ Test record cleaned up', 'info');
                        }, 1000);
                    } else {
                        const retryError = await retryResponse.text();
                        log(`‚ùå Retry also failed: ${retryResponse.status}`, 'error');
                        log(`Retry Error: ${retryError}`, 'error');
                    }
                }

            } catch (error) {
                log(`‚ùå CREATE test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run verification
        setTimeout(verifySchema, 1000);
    </script>
</body>
</html>