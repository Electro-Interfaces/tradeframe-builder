<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Tanks Loading</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #555;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #4CAF50;
            color: white;
        }
        .status.error {
            background: #f44336;
            color: white;
        }
        .status.warning {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug: Tanks Loading from STS API</h1>

        <div class="section">
            <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ STS API</h2>
            <button onclick="checkSTSConfig()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</button>
            <div id="config-result"></div>
        </div>

        <div class="section">
            <h2>2. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤</h2>
            <button onclick="testLoadTanks()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã</button>
            <button onclick="testLoadTanksWithDebug()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å –æ—Ç–ª–∞–¥–∫–æ–π</button>
            <div id="tanks-result"></div>
        </div>

        <div class="section">
            <h2>3. –¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ API –≤—ã–∑–æ–≤–∞</h2>
            <button onclick="testDirectAPI()">–ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ /v1/tanks</button>
            <div id="direct-result"></div>
        </div>

        <div class="section">
            <h2>4. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage</h2>
            <button onclick="checkLocalStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage</button>
            <div id="storage-result"></div>
        </div>

        <div class="section">
            <h2>5. –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –ª–æ–≥–∏</h2>
            <div id="console-logs"></div>
            <button onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>
    </div>

    <script>
        const logs = [];
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.log, console.error, etc.
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            logs.push({ type: 'log', message: args.join(' '), time: new Date().toISOString() });
            updateConsoleDisplay();
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            logs.push({ type: 'error', message: args.join(' '), time: new Date().toISOString() });
            updateConsoleDisplay();
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            logs.push({ type: 'warn', message: args.join(' '), time: new Date().toISOString() });
            updateConsoleDisplay();
            originalWarn.apply(console, args);
        };

        function updateConsoleDisplay() {
            const logsDiv = document.getElementById('console-logs');
            const lastLogs = logs.slice(-20); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –ª–æ–≥–æ–≤
            logsDiv.innerHTML = lastLogs.map(log => 
                `<div class="status ${log.type}">[${log.time}] ${log.type.toUpperCase()}: ${log.message}</div>`
            ).join('');
        }

        function clearLogs() {
            logs.length = 0;
            updateConsoleDisplay();
        }

        async function checkSTSConfig() {
            const resultDiv = document.getElementById('config-result');
            try {
                const config = localStorage.getItem('sts-api-config');
                if (!config) {
                    resultDiv.innerHTML = '<div class="status error">‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è STS API –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage</div>';
                    return;
                }

                const parsedConfig = JSON.parse(config);
                console.log('STS API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:', parsedConfig);
                
                resultDiv.innerHTML = `
                    <div class="status ${parsedConfig.enabled ? 'success' : 'error'}">
                        ${parsedConfig.enabled ? '‚úÖ' : '‚ùå'} API ${parsedConfig.enabled ? '–≤–∫–ª—é—á–µ–Ω' : '–æ—Ç–∫–ª—é—á–µ–Ω'}
                    </div>
                    <pre>${JSON.stringify(parsedConfig, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', error);
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        async function testLoadTanks() {
            const resultDiv = document.getElementById('tanks-result');
            resultDiv.innerHTML = '<div class="status">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤...</div>';
            
            try {
                // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —á–µ—Ä–µ–∑ stsApiService
                const config = JSON.parse(localStorage.getItem('sts-api-config') || '{}');
                if (!config.enabled) {
                    throw new Error('STS API –æ—Ç–∫–ª—é—á–µ–Ω');
                }

                console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤...');
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                const loginResponse = await fetch(`${config.url}/v1/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: config.username,
                        password: config.password
                    }),
                    signal: AbortSignal.timeout(30000)
                });

                if (!loginResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${loginResponse.status} ${loginResponse.statusText}`);
                }

                const token = (await loginResponse.text()).replace(/"/g, '');
                console.log('–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω:', token.substring(0, 20) + '...');

                // –ó–∞–ø—Ä–æ—Å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤
                const url = new URL(`${config.url}/v1/tanks`);
                if (config.networkId) url.searchParams.set('system', config.networkId);
                if (config.tradingPointId) url.searchParams.set('station', config.tradingPointId);

                console.log('–ó–∞–ø—Ä–æ—Å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ —Å URL:', url.toString());

                const tanksResponse = await fetch(url.toString(), {
                    headers: { 'Authorization': `Bearer ${token}` },
                    signal: AbortSignal.timeout(30000)
                });

                if (!tanksResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${tanksResponse.status} ${tanksResponse.statusText}`);
                }

                const tanksData = await tanksResponse.json();
                console.log('–î–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤:', tanksData);

                resultDiv.innerHTML = `
                    <div class="status success">‚úÖ –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ (${Array.isArray(tanksData) ? tanksData.length : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} —à—Ç.)</div>
                    <pre>${JSON.stringify(tanksData, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤:', error);
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        async function testLoadTanksWithDebug() {
            const resultDiv = document.getElementById('tanks-result');
            resultDiv.innerHTML = '<div class="status">üîç –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ —Å –æ—Ç–ª–∞–¥–∫–æ–π...</div>';
            
            try {
                const config = JSON.parse(localStorage.getItem('sts-api-config') || '{}');
                console.log('–ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:', config);
                
                if (!config.enabled) {
                    resultDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è STS API –æ—Ç–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</div>';
                    return;
                }

                if (!config.url || !config.username || !config.password) {
                    resultDiv.innerHTML = '<div class="status error">‚ùå –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</div>';
                    return;
                }

                console.log('1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω...');
                let token = config.token;
                let tokenValid = false;

                if (token && config.tokenExpiry && config.tokenExpiry > Date.now()) {
                    console.log('–¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –∏ –Ω–µ –∏—Å—Ç–µ–∫');
                    tokenValid = true;
                } else {
                    console.log('2. –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω...');
                    const loginResponse = await fetch(`${config.url}/v1/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: config.username,
                            password: config.password
                        })
                    });

                    console.log('–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', loginResponse.status);
                    
                    if (loginResponse.ok) {
                        token = (await loginResponse.text()).replace(/"/g, '');
                        console.log('–ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω');
                        tokenValid = true;
                    } else {
                        throw new Error(`–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: ${loginResponse.status}`);
                    }
                }

                if (!tokenValid) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω');
                }

                console.log('3. –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤...');
                const url = new URL(`${config.url}/v1/tanks`);
                
                console.log('–ë–∞–∑–æ–≤—ã–π URL:', url.toString());
                
                if (config.networkId) {
                    url.searchParams.set('system', config.networkId);
                    console.log('–î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä system:', config.networkId);
                }
                if (config.tradingPointId) {
                    url.searchParams.set('station', config.tradingPointId);
                    console.log('–î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä station:', config.tradingPointId);
                }

                console.log('–ò—Ç–æ–≥–æ–≤—ã–π URL:', url.toString());

                console.log('4. –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤...');
                const tanksResponse = await fetch(url.toString(), {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', tanksResponse.status);
                console.log('–ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', [...tanksResponse.headers.entries()]);

                const responseText = await tanksResponse.text();
                console.log('–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ (—Ç–µ–∫—Å—Ç):', responseText);

                if (!tanksResponse.ok) {
                    throw new Error(`HTTP ${tanksResponse.status}: ${responseText}`);
                }

                let tanksData;
                try {
                    tanksData = JSON.parse(responseText);
                    console.log('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã –∫–∞–∫ JSON');
                } catch (e) {
                    throw new Error(`–û—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JSON: ${e.message}`);
                }

                console.log('5. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤...');
                console.log('–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:', typeof tanksData);
                console.log('–î–∞–Ω–Ω—ã–µ:', tanksData);

                let processedTanks = [];
                if (Array.isArray(tanksData)) {
                    processedTanks = tanksData;
                } else if (tanksData && typeof tanksData === 'object' && tanksData.tanks) {
                    processedTanks = tanksData.tanks;
                } else {
                    console.warn('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
                }

                resultDiv.innerHTML = `
                    <div class="status success">‚úÖ –£—Å–ø–µ—à–Ω–æ! –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${processedTanks.length}</div>
                    <div class="status">üìä URL –∑–∞–ø—Ä–æ—Å–∞: ${url.toString()}</div>
                    <div class="status">üîë –¢–æ–∫–µ–Ω: ${token.substring(0, 20)}...</div>
                    <pre>${JSON.stringify(tanksData, null, 2)}</pre>
                `;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å –æ—Ç–ª–∞–¥–∫–æ–π:', error);
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        async function testDirectAPI() {
            const resultDiv = document.getElementById('direct-result');
            resultDiv.innerHTML = '<div class="status">üîÑ –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ API...</div>';
            
            try {
                const config = JSON.parse(localStorage.getItem('sts-api-config') || '{}');
                
                if (!config.url) {
                    throw new Error('URL API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
                }

                const response = await fetch(`${config.url}/v1/tanks`, {
                    headers: {
                        'Authorization': `Bearer ${config.token || 'test-token'}`,
                        'Accept': 'application/json'
                    }
                });

                const responseText = await response.text();
                
                resultDiv.innerHTML = `
                    <div class="status ${response.ok ? 'success' : 'error'}">
                        ${response.ok ? '‚úÖ' : '‚ùå'} HTTP ${response.status}: ${response.statusText}
                    </div>
                    <pre>–û—Ç–≤–µ—Ç:\n${responseText}</pre>
                `;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞:', error);
                resultDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        async function checkLocalStorage() {
            const resultDiv = document.getElementById('storage-result');
            
            const stsConfig = localStorage.getItem('sts-api-config');
            const allKeys = Object.keys(localStorage).filter(key => key.includes('sts') || key.includes('api'));
            
            resultDiv.innerHTML = `
                <div class="status">üì¶ –ö–ª—é—á–∏ –≤ localStorage —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å API: ${allKeys.length}</div>
                <pre>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏:\n${allKeys.join('\n')}</pre>
                <pre>sts-api-config:\n${stsConfig ? JSON.stringify(JSON.parse(stsConfig), null, 2) : '–ù–µ –Ω–∞–π–¥–µ–Ω'}</pre>
            `;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            checkSTSConfig();
            checkLocalStorage();
        });
    </script>
</body>
</html>