<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ Supabase –∫–ª–∏–µ–Ω—Ç–∞</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1b23;
            color: white;
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #333; 
            border-radius: 8px;
            background: #2a2b35;
        }
        button { 
            background: #3b82f6; 
            color: white; 
            padding: 8px 16px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:disabled { 
            background: #6b7280; 
            cursor: not-allowed; 
        }
        .status { 
            display: inline-block; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px;
            font-weight: 500;
        }
        .connected { background: #059669; color: white; }
        .disconnected { background: #dc2626; color: white; }
        .testing { background: #f59e0b; color: white; }
        pre { 
            background: #1e293b; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .log {
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <h1>üîß –¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ Supabase –∫–ª–∏–µ–Ω—Ç–∞</h1>
    
    <div class="section">
        <h2>üìä –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
        <div id="connection-status">
            <span class="status disconnected">üî¥ –ù–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</span>
            <span id="latency"></span>
        </div>
        <div style="margin-top: 10px;">
            <button onclick="initializeClient()">üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç</button>
            <button onclick="testConnection()" disabled id="test-btn">üß™ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
            <button onclick="clearLogs()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>
    </div>

    <div class="section">
        <h2>üîÑ –¢–µ—Å—Ç Retry –ª–æ–≥–∏–∫–∏</h2>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ —Å–±–æ—è—Ö</p>
        <div>
            <button onclick="testRetryMechanism()" disabled id="retry-btn">‚è≥ –¢–µ—Å—Ç Retry</button>
            <button onclick="testBatchOperations()" disabled id="batch-btn">üì¶ –¢–µ—Å—Ç Batch –æ–ø–µ—Ä–∞—Ü–∏–π</button>
        </div>
        <div id="retry-results"></div>
    </div>

    <div class="section">
        <h2>‚ö° –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h2>
        <p>–ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞ –∏ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</p>
        <div>
            <button onclick="performanceTest()" disabled id="perf-btn">üèÉ –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</button>
            <button onclick="stressTest()" disabled id="stress-btn">üí™ –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç</button>
        </div>
        <div id="performance-results"></div>
    </div>

    <div class="section">
        <h2>üì° Real-time –ø–æ–¥–ø–∏—Å–∫–∏</h2>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</p>
        <div>
            <button onclick="testRealtimeSubscription()" disabled id="realtime-btn">üìª –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <button onclick="stopRealtimeSubscription()" disabled id="stop-realtime-btn">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
        </div>
        <div id="realtime-results"></div>
    </div>

    <div class="section">
        <h2>üìã –õ–æ–≥–∏ –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
        <div id="operation-logs" class="log">
            <div class="info">–û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...</div>
        </div>
    </div>

    <div class="section">
        <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div id="statistics">
            <div>–£—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π: <span id="success-count">0</span></div>
            <div>–û—à–∏–±–æ–∫: <span id="error-count">0</span></div>
            <div>–°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞: <span id="avg-latency">-</span></div>
            <div>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: <span id="uptime">0s</span></div>
        </div>
    </div>

    <script>
        let isInitialized = false;
        let startTime = Date.now();
        let stats = {
            successCount: 0,
            errorCount: 0,
            totalLatency: 0,
            operationCount: 0
        };
        let realtimeChannel = null;

        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('operation-logs');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStats() {
            document.getElementById('success-count').textContent = stats.successCount;
            document.getElementById('error-count').textContent = stats.errorCount;
            
            if (stats.operationCount > 0) {
                const avgLatency = Math.round(stats.totalLatency / stats.operationCount);
                document.getElementById('avg-latency').textContent = `${avgLatency}ms`;
            }
            
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('uptime').textContent = `${uptime}s`;
        }

        function updateConnectionStatus(connected, latency = null) {
            const statusElement = document.getElementById('connection-status');
            const latencyElement = document.getElementById('latency');
            
            if (connected) {
                statusElement.innerHTML = '<span class="status connected">üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>';
                if (latency !== null) {
                    latencyElement.textContent = `(${latency}ms)`;
                }
            } else {
                statusElement.innerHTML = '<span class="status disconnected">üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ</span>';
                latencyElement.textContent = '';
            }

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
            ['test-btn', 'retry-btn', 'batch-btn', 'perf-btn', 'stress-btn', 'realtime-btn'].forEach(id => {
                document.getElementById(id).disabled = !connected;
            });
        }

        // –≠–º—É–ª—è—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
        async function initializeClient() {
            log('info', '–ù–∞—á–∏–Ω–∞—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–ª–∏–µ–Ω—Ç–∞...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                const settings = localStorage.getItem('externalDatabase');
                if (!settings) {
                    throw new Error('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage');
                }

                const parsed = JSON.parse(settings);
                if (!parsed.url || !parsed.apiKey) {
                    throw new Error('–ù–µ–ø–æ–ª–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                }

                // –≠–º—É–ª–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                log('success', `–ö–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è ${parsed.url}`);
                isInitialized = true;

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                await testConnection();

            } catch (error) {
                log('error', `–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`);
                updateConnectionStatus(false);
            }
        }

        async function testConnection() {
            if (!isInitialized) {
                log('warning', '–ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }

            const startTime = Date.now();
            log('info', '–¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');

            try {
                // –≠–º—É–ª–∏—Ä—É–µ–º —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                await new Promise(resolve => setTimeout(resolve, Math.random() * 500 + 100));
                
                // 90% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞
                if (Math.random() < 0.9) {
                    const latency = Date.now() - startTime;
                    log('success', `–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ (${latency}ms)`);
                    updateConnectionStatus(true, latency);
                    
                    stats.successCount++;
                    stats.totalLatency += latency;
                    stats.operationCount++;
                } else {
                    throw new Error('–¢–µ—Å—Ç —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–∏');
                }
            } catch (error) {
                const latency = Date.now() - startTime;
                log('error', `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message} (${latency}ms)`);
                updateConnectionStatus(false);
                
                stats.errorCount++;
                stats.operationCount++;
            }
            
            updateStats();
        }

        async function testRetryMechanism() {
            log('info', '–¢–µ—Å—Ç–∏—Ä—É—é retry –º–µ—Ö–∞–Ω–∏–∑–º...');
            const resultsDiv = document.getElementById('retry-results');
            resultsDiv.innerHTML = '<div>–¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏...</div>';

            let attempts = 0;
            const maxAttempts = 3;

            for (let i = 0; i < maxAttempts; i++) {
                attempts++;
                const startTime = Date.now();
                
                try {
                    // 50% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–µ—É–¥–∞—á–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ retry
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    if (Math.random() < 0.5 && i < maxAttempts - 1) {
                        throw new Error(`–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ ${i + 1}`);
                    }
                    
                    const latency = Date.now() - startTime;
                    log('success', `Retry —É—Å–ø–µ—à–µ–Ω –ø–æ—Å–ª–µ ${attempts} –ø–æ–ø—ã—Ç–æ–∫ (${latency}ms)`);
                    resultsDiv.innerHTML = `<div class="success">‚úÖ –£—Å–ø–µ—Ö –ø–æ—Å–ª–µ ${attempts} –ø–æ–ø—ã—Ç–æ–∫</div>`;
                    
                    stats.successCount++;
                    stats.totalLatency += latency;
                    stats.operationCount++;
                    break;
                    
                } catch (error) {
                    const latency = Date.now() - startTime;
                    log('warning', `–ü–æ–ø—ã—Ç–∫–∞ ${attempts} –Ω–µ—É—Å–ø–µ—à–Ω–∞: ${error.message} (${latency}ms)`);
                    
                    if (i === maxAttempts - 1) {
                        resultsDiv.innerHTML = `<div class="error">‚ùå –í—Å–µ ${maxAttempts} –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—É—Å–ø–µ—à–Ω—ã</div>`;
                        stats.errorCount++;
                    }
                    
                    stats.totalLatency += latency;
                    stats.operationCount++;
                    
                    // Exponential backoff
                    if (i < maxAttempts - 1) {
                        const delay = 1000 * Math.pow(2, i);
                        log('info', `–û–∂–∏–¥–∞–Ω–∏–µ ${delay}ms –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            updateStats();
        }

        async function testBatchOperations() {
            log('info', '–¢–µ—Å—Ç–∏—Ä—É—é batch –æ–ø–µ—Ä–∞—Ü–∏–∏...');
            const startTime = Date.now();

            try {
                // –≠–º—É–ª–∏—Ä—É–µ–º 5 –æ–ø–µ—Ä–∞—Ü–∏–π –≤ batch
                const operations = Array.from({length: 5}, (_, i) => 
                    new Promise(resolve => setTimeout(resolve, Math.random() * 200 + 50))
                );

                await Promise.all(operations);
                
                const latency = Date.now() - startTime;
                log('success', `Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã (${latency}ms)`);
                
                stats.successCount += 5;
                stats.totalLatency += latency;
                stats.operationCount += 5;
                
            } catch (error) {
                log('error', `–û—à–∏–±–∫–∞ batch –æ–ø–µ—Ä–∞—Ü–∏–π: ${error.message}`);
                stats.errorCount++;
            }
            
            updateStats();
        }

        async function performanceTest() {
            log('info', '–ó–∞–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...');
            const resultsDiv = document.getElementById('performance-results');
            resultsDiv.innerHTML = '<div>–í—ã–ø–æ–ª–Ω—è—é 10 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤...</div>';

            const startTime = Date.now();
            const promises = [];

            for (let i = 0; i < 10; i++) {
                promises.push(
                    new Promise(resolve => 
                        setTimeout(() => resolve(i), Math.random() * 100 + 50)
                    )
                );
            }

            try {
                const results = await Promise.all(promises);
                const totalTime = Date.now() - startTime;
                const avgTime = totalTime / results.length;

                log('success', `–¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω: ${totalTime}ms –æ–±—â–µ–µ –≤—Ä–µ–º—è, ${avgTime.toFixed(1)}ms —Å—Ä–µ–¥–Ω–µ–µ`);
                resultsDiv.innerHTML = `
                    <div class="success">
                        üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:<br>
                        ‚Ä¢ –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: ${results.length}<br>
                        ‚Ä¢ –û–±—â–µ–µ –≤—Ä–µ–º—è: ${totalTime}ms<br>
                        ‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: ${avgTime.toFixed(1)}ms<br>
                        ‚Ä¢ RPS: ${(results.length / (totalTime / 1000)).toFixed(1)}
                    </div>
                `;

                stats.successCount += results.length;
                stats.totalLatency += totalTime;
                stats.operationCount += results.length;
                
            } catch (error) {
                log('error', `–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: ${error.message}`);
                resultsDiv.innerHTML = `<div class="error">‚ùå –¢–µ—Å—Ç –Ω–µ—É—Å–ø–µ—à–µ–Ω</div>`;
                stats.errorCount++;
            }
            
            updateStats();
        }

        async function stressTest() {
            log('info', '–ó–∞–ø—É—Å–∫–∞—é —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç...');
            const startTime = Date.now();
            let successCount = 0;
            let errorCount = 0;

            // 50 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            const promises = Array.from({length: 50}, async (_, i) => {
                try {
                    await new Promise(resolve => 
                        setTimeout(resolve, Math.random() * 200 + 10)
                    );
                    successCount++;
                    return true;
                } catch (error) {
                    errorCount++;
                    return false;
                }
            });

            await Promise.allSettled(promises);
            const totalTime = Date.now() - startTime;

            log('info', `–°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: ${successCount} —É—Å–ø–µ—Ö–æ–≤, ${errorCount} –æ—à–∏–±–æ–∫ –∑–∞ ${totalTime}ms`);
            
            stats.successCount += successCount;
            stats.errorCount += errorCount;
            stats.totalLatency += totalTime;
            stats.operationCount += promises.length;
            
            updateStats();
        }

        async function testRealtimeSubscription() {
            log('info', '–ü–æ–¥–ø–∏—Å—ã–≤–∞—é—Å—å –Ω–∞ real-time –∏–∑–º–µ–Ω–µ–Ω–∏—è...');
            const resultsDiv = document.getElementById('realtime-results');
            
            // –≠–º—É–ª–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É
            realtimeChannel = setInterval(() => {
                const events = ['INSERT', 'UPDATE', 'DELETE'];
                const event = events[Math.floor(Math.random() * events.length)];
                const record = { id: Math.floor(Math.random() * 1000), event };
                
                log('info', `Real-time —Å–æ–±—ã—Ç–∏–µ: ${event} –¥–ª—è –∑–∞–ø–∏—Å–∏ ${record.id}`);
            }, 3000);

            resultsDiv.innerHTML = '<div class="success">üì° –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞. –°–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –ª–æ–≥–∞—Ö.</div>';
            document.getElementById('stop-realtime-btn').disabled = false;
        }

        function stopRealtimeSubscription() {
            if (realtimeChannel) {
                clearInterval(realtimeChannel);
                realtimeChannel = null;
                log('info', 'Real-time –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                document.getElementById('realtime-results').innerHTML = '<div>–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</div>';
                document.getElementById('stop-realtime-btn').disabled = true;
            }
        }

        function clearLogs() {
            document.getElementById('operation-logs').innerHTML = '<div class="info">–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(updateStats, 1000);

        console.log('üîß –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ Supabase –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    </script>
</body>
</html>