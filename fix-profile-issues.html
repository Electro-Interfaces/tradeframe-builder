<!DOCTYPE html>
<html>
<head>
    <title>Fix Profile Section Issues</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test { margin: 15px 0; padding: 20px; border-radius: 10px; }
        .success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
        .error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
        .info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
        .warning { background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; }
        pre { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            margin: 10px 5px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .button:hover { background: #45a049; transform: translateY(-2px); }
        .button.secondary { background: #2196f3; }
        .button.secondary:hover { background: #1976d2; }
        .button.danger { background: #f44336; }
        .button.danger:hover { background: #da190b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–æ—Ñ–∏–ª—å</h1>
        
        <div class="test info">
            <h3>üéØ –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–æ—Ñ–∏–ª—å</h3>
            <p>–ü–æ—Å–∫–æ–ª—å–∫—É —Ç–∞–±–ª–∏—Ü–∞ users —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", 
               –ø—Ä–æ–±–ª–µ–º–∞ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö localStorage.</p>
            <button class="button" onclick="fixProfileServices()">1Ô∏è‚É£ –ò–°–ü–†–ê–í–ò–¢–¨ –°–ï–†–í–ò–°–´</button>
            <button class="button secondary" onclick="setupCurrentUser()">2Ô∏è‚É£ –ù–ê–°–¢–†–û–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø</button>
            <button class="button" onclick="testProfilePage()">3Ô∏è‚É£ –¢–ï–°–¢ –ü–†–û–§–ò–õ–Ø</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const config = {
            url: 'https://ssvazdgnmatbdynkhkqo.supabase.co',
            apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdmF6ZGdubWF0YmR5bmtoa3FvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzM0MzgzNCwiZXhwIjoyMDcyOTE5ODM0fQ.Gen-PI-vDkKjskpIvJNcQw0Uj3d0zGXB98zIxNK6di0'
        };

        function addResult(title, type, data) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        window.fixProfileServices = async function() {
            addResult('üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ—Ñ–∏–ª—è...', 'info', '–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º localStorage –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã');
            
            // 1. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º externalDatabase
            const externalDbConfig = {
                url: config.url,
                apiKey: config.apiKey,
                status: 'connected',
                lastUpdated: new Date().toISOString()
            };

            localStorage.setItem('externalDatabase', JSON.stringify(externalDbConfig));
            
            // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º supabaseSettings 
            localStorage.setItem('supabaseSettings', JSON.stringify(externalDbConfig));
            
            // 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º dataSourceConfig
            const dataSourceConfig = {
                useDatabase: true,
                databaseConnected: true,
                supabaseUrl: config.url,
                apiKey: config.apiKey,
                lastCheck: new Date().toISOString(),
                status: 'connected'
            };
            
            localStorage.setItem('dataSourceConfig', JSON.stringify(dataSourceConfig));

            addResult('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã', 'success', {
                externalDatabase: 'CONFIGURED',
                supabaseSettings: 'CONFIGURED', 
                dataSourceConfig: 'CONFIGURED',
                message: '–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ë–î'
            });
        };

        window.setupCurrentUser = async function() {
            addResult('üë§ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...', 'info', '–ó–∞–≥—Ä—É–∂–∞–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
                const response = await fetch(`${config.url}/rest/v1/users?status=eq.active&limit=1`, {
                    headers: {
                        'apikey': config.apiKey,
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const users = await response.json();
                    if (users.length > 0) {
                        const user = users[0];
                        
                        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç currentUser –¥–ª—è localStorage
                        const currentUser = {
                            id: user.id,
                            tenant_id: user.tenant_id,
                            email: user.email,
                            name: user.name,
                            firstName: user.first_name,
                            lastName: user.last_name,
                            phone: user.phone,
                            status: user.status,
                            roles: [],
                            permissions: [],
                            direct_permissions: [],
                            preferences: user.preferences || {},
                            lastLogin: user.last_login,
                            created_at: user.created_at,
                            updated_at: user.updated_at
                        };

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        
                        // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è AuthContext
                        const authUser = {
                            email: user.email,
                            name: user.name,
                            firstName: user.first_name,
                            lastName: user.last_name,
                            isAuthenticated: true
                        };
                        
                        localStorage.setItem('auth_user', JSON.stringify(authUser));

                        addResult('‚úÖ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω', 'success', {
                            user: currentUser,
                            message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ localStorage'
                        });
                    } else {
                        addResult('‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning', {
                            message: '–í —Ç–∞–±–ª–∏—Ü–µ users –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
                            recommendation: '–°–æ–∑–¥–∞–π—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î'
                        });
                    }
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error', {
                        status: response.status,
                        error: await response.text()
                    });
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error', error.message);
            }
        };

        window.testProfilePage = async function() {
            addResult('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª—è...', 'info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ —Ä–∞–±–æ—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
            
            try {
                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Ñ–∏–ª—è
                const profileResponse = await fetch('http://localhost:3006/profile', {
                    method: 'GET',
                    headers: { 'Accept': 'text/html' }
                });

                if (profileResponse.ok) {
                    addResult('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è –¥–æ—Å—Ç—É–ø–Ω–∞', 'success', {
                        url: 'http://localhost:3006/profile',
                        status: profileResponse.status,
                        accessible: true
                    });
                    
                    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    const localStorageCheck = {
                        externalDatabase: localStorage.getItem('externalDatabase') ? 'EXISTS' : 'MISSING',
                        currentUser: localStorage.getItem('currentUser') ? 'EXISTS' : 'MISSING',
                        auth_user: localStorage.getItem('auth_user') ? 'EXISTS' : 'MISSING',
                        dataSourceConfig: localStorage.getItem('dataSourceConfig') ? 'EXISTS' : 'MISSING'
                    };

                    addResult('üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage', 'info', {
                        localStorage_status: localStorageCheck,
                        all_ready: Object.values(localStorageCheck).every(v => v === 'EXISTS'),
                        message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è'
                    });

                } else if (profileResponse.status === 404) {
                    // –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç
                    const profileResponse2 = await fetch('http://localhost:3005/profile', {
                        method: 'GET',
                        headers: { 'Accept': 'text/html' }
                    });

                    if (profileResponse2.ok) {
                        addResult('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ –ø–æ—Ä—Ç—É 3005', 'success', {
                            correct_url: 'http://localhost:3005/profile',
                            status: profileResponse2.status
                        });
                    } else {
                        addResult('‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error', {
                            tried_ports: [3006, 3005],
                            note: '–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ dev server –∑–∞–ø—É—â–µ–Ω'
                        });
                    }
                } else {
                    addResult('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –ø—Ä–æ—Ñ–∏–ª—é', 'error', {
                        status: profileResponse.status,
                        statusText: profileResponse.statusText
                    });
                }

                // 3. –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                window.open('http://localhost:3005/profile', '_blank');
                
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error', {
                    error: error.message,
                    note: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ'
                });
            }
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        setTimeout(() => {
            fixProfileServices();
            setTimeout(setupCurrentUser, 1000);
        }, 500);
    </script>
</body>
</html>