<!DOCTYPE html>
<html>
<head>
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–æ–ª–µ–π</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #1a1a1a; 
            color: #fff; 
            padding: 20px; 
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid; 
        }
        .success { background: #2d5a2d; border-color: #4a9a4a; }
        .error { background: #5a2d2d; border-color: #9a4a4a; }
        .warning { background: #5a5a2d; border-color: #9a9a4a; }
        .info { background: #2d2d5a; border-color: #4a4a9a; }
        button {
            background: #4a9a4a;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #5aaa5a; }
        button:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
        .btn-primary { background: #4a9a4a; }
        .btn-secondary { background: #666; }
        .btn-danger { background: #9a4a4a; }
        pre { 
            background: #2a2a2a; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto; 
            white-space: pre-wrap; 
            font-size: 12px;
        }
        .section { 
            background: #2a2a2a; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border: 1px solid #444; 
        }
        .progress {
            background: #333;
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #4a9a4a;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ä–æ–ª—è–º</h1>
        <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–Ω–µ—à–Ω–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π</p>
        
        <div class="section">
            <h2>üöÄ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <button onclick="quickFix()" class="btn-primary">üîß –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
            <button onclick="manualDiagnostic()" class="btn-secondary">üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
            <button onclick="resetSettings()" class="btn-danger">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
        
        <div class="progress" id="progress-container" style="display: none;">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div id="results"></div>
        
        <div class="section" style="display: none;" id="manual-actions">
            <h3>üìã –†—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            <button onclick="forceInitSettings()">üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</button>
            <button onclick="testDirectConnection()">üåê –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
            <button onclick="checkDatabase()">üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
            <button onclick="reloadRolesPage()">üìÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–æ–ª–µ–π</button>
        </div>
    </div>

    <script>
        let progressInterval;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function showProgress(show = true) {
            const container = document.getElementById('progress-container');
            container.style.display = show ? 'block' : 'none';
            if (show) {
                let progress = 0;
                const bar = document.getElementById('progress-bar');
                progressInterval = setInterval(() => {
                    progress += Math.random() * 30;
                    if (progress > 90) progress = 90;
                    bar.style.width = progress + '%';
                }, 200);
            } else {
                clearInterval(progressInterval);
                document.getElementById('progress-bar').style.width = '100%';
                setTimeout(() => {
                    document.getElementById('progress-bar').style.width = '0%';
                }, 500);
            }
        }

        function completeProgress() {
            clearInterval(progressInterval);
            document.getElementById('progress-bar').style.width = '100%';
        }

        async function quickFix() {
            document.getElementById('results').innerHTML = '';
            showProgress();
            
            log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –±—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'info');
            
            try {
                // –®–∞–≥ 1: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
                log('1Ô∏è‚É£ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...', 'warning');
                await forceInitSettings();
                
                // –®–∞–≥ 2: –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                log('2Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'warning');
                const connectionResult = await testDirectConnection();
                
                if (!connectionResult) {
                    throw new Error('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                }
                
                // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–æ–ª—è–º
                log('3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ —Ä–æ–ª–µ–π...', 'warning');
                await checkDatabase();
                
                // –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                log('4Ô∏è‚É£ –ü—Ä–∏–º–µ–Ω—è–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...', 'warning');
                
                completeProgress();
                log('‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!', 'success');
                log('üîÑ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–æ–ª–µ–π –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π', 'info');
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ä–æ–ª—è–º
                const reloadBtn = document.createElement('button');
                reloadBtn.textContent = 'üîÑ –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–æ–ª–µ–π';
                reloadBtn.onclick = reloadRolesPage;
                reloadBtn.className = 'btn-primary';
                document.getElementById('results').appendChild(reloadBtn);
                
            } catch (error) {
                completeProgress();
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏: ${error.message}`, 'error');
                document.getElementById('manual-actions').style.display = 'block';
            }
            
            showProgress(false);
        }

        async function forceInitSettings() {
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const defaultSettings = {
                    url: "https://ssvazdgnmatbdynkhkqo.supabase.co",
                    apiKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdmF6ZGdubWF0YmR5bmtoa3FvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzM0MzgzNCwiZXhwIjoyMDcyOTE5ODM0fQ.Gen-PI-vDkKjskpIvJNcQw0Uj3d0zGXB98zIxNK6di0"
                };
                
                localStorage.setItem('externalDatabase', JSON.stringify(defaultSettings));
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
                window.dispatchEvent(new CustomEvent('localStorageChanged'));
                
                log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                log(`üìç URL: ${defaultSettings.url}`, 'info');
                log(`üîë API –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (${defaultSettings.apiKey.substring(0, 20)}...)`, 'info');
                
                return true;
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${error.message}`, 'error');
                return false;
            }
        }

        async function testDirectConnection() {
            try {
                const settings = JSON.parse(localStorage.getItem('externalDatabase') || '{}');
                
                if (!settings.url || !settings.apiKey) {
                    log('‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error');
                    return false;
                }
                
                log('üåê –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...', 'warning');
                
                const response = await fetch(`${settings.url}/rest/v1/`, {
                    headers: {
                        'apikey': settings.apiKey,
                        'Authorization': `Bearer ${settings.apiKey}`
                    }
                });
                
                if (response.ok) {
                    log(`‚úÖ –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ (—Å—Ç–∞—Ç—É—Å: ${response.status})`, 'success');
                    return true;
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: HTTP ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkDatabase() {
            try {
                const settings = JSON.parse(localStorage.getItem('externalDatabase') || '{}');
                
                log('üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ —Ä–æ–ª–µ–π...', 'warning');
                
                const response = await fetch(`${settings.url}/rest/v1/roles?deleted_at=is.null&limit=5`, {
                    headers: {
                        'apikey': settings.apiKey,
                        'Authorization': `Bearer ${settings.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const roles = await response.json();
                    log(`‚úÖ –î–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ —Ä–æ–ª–µ–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω (–Ω–∞–π–¥–µ–Ω–æ ${roles.length} —Ä–æ–ª–µ–π)`, 'success');
                    
                    if (roles.length > 0) {
                        log('üìã –ü—Ä–∏–º–µ—Ä—ã —Ä–æ–ª–µ–π:', 'info');
                        roles.forEach((role, index) => {
                            log(`   ${index + 1}. ${role.name} (${role.code})`, 'info');
                        });
                    } else {
                        log('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ —Ä–æ–ª–µ–π –ø—É—Å—Ç–∞ - –≤–æ–∑–º–æ–∂–Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–µ —Ä–æ–ª–∏', 'warning');
                    }
                    
                    return true;
                } else {
                    const errorText = await response.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–æ–ª—è–º: ${response.status} - ${errorText}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ë–î: ${error.message}`, 'error');
                return false;
            }
        }

        function resetSettings() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–Ω–µ—à–Ω–µ–π –ë–î?')) {
                localStorage.removeItem('externalDatabase');
                log('üóëÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ localStorage', 'warning');
                log('üîÑ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ', 'info');
            }
        }

        function reloadRolesPage() {
            log('üîÑ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–æ–ª–µ–π...', 'info');
            window.open('http://localhost:3001/admin/roles', '_blank');
        }

        async function manualDiagnostic() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('manual-actions').style.display = 'block';
            
            log('üîç –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const currentSettings = localStorage.getItem('externalDatabase');
            if (currentSettings) {
                try {
                    const parsed = JSON.parse(currentSettings);
                    log('‚úÖ –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–π–¥–µ–Ω—ã:', 'success');
                    log(`   URL: ${parsed.url}`, 'info');
                    log(`   API Key: ${parsed.apiKey ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}`, 'info');
                } catch (error) {
                    log('‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã', 'error');
                }
            } else {
                log('‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç', 'warning');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü
            log('üìÑ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', 'info');
            log('   - –†–æ–ª–∏: http://localhost:3001/admin/roles', 'info');
            log('   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î: http://localhost:3001/settings/external-database', 'info');
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            log('üîß –°–∏—Å—Ç–µ–º–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ', 'info');
            log('üí° –ù–∞–∂–º–∏—Ç–µ "–ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º', 'info');
        };
    </script>
</body>
</html>