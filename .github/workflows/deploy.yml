name: Deploy production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build
        run: npm run build
        
  deploy:
    runs-on: ubuntu-latest

    env:
        PROD_ADDRESS: ${{secrets.PROD_ADDRESS}}
        PROD_USER: ${{secrets.PROD_USER}}
        PROD_PASS: ${{secrets.PROD_PASS}}
        PROD_PORT: ${{secrets.PROD_PORT}}

    steps:
      - name: connect to server and deploy
        uses: appleboy/ssh-action@v1.1.0
        with:
            host: ${{env.PROD_ADDRESS}}
            username: ${{env.PROD_USER}}
            password: ${{env.PROD_PASS}}
            port: ${{env.PROD_PORT}}
            script: |
                  cd /var/www/www-root/data/www/prod.dataworker.ru
                  git pull
                  pm2 restart "npm run dev"
