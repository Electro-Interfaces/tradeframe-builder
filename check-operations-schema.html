<!DOCTYPE html>
<html>
<head>
    <title>Check Operations Table Schema</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 10px 0; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 4px; margin: 10px 0; max-height: 600px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .schema-table { font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –°—Ö–µ–º—ã –¢–∞–±–ª–∏—Ü—ã Operations</h1>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ä–µ–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã operations –≤ Supabase.</p>
        
        <button onclick="checkTableSchema()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –°—Ö–µ–º—É –¢–∞–±–ª–∏—Ü—ã</button>
        <button onclick="checkTableData()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –î–∞–Ω–Ω—ã–µ</button>
        <button onclick="createMissingColumns()">–°–æ–∑–¥–∞—Ç—å –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ö–æ–ª–æ–Ω–∫–∏</button>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –õ–æ–≥</button>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjUzNTk5NTIsImV4cCI6MjA0MDkzNTk1Mn0.Y_LhIvHnBbMAErYzBt2hHxd6xVtNJoOJ4xm0Y-nOQHY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function checkTableSchema() {
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã operations...', 'info');
            
            try {
                // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ö–µ–º–µ PostgreSQL
                const { data, error } = await supabase.rpc('exec_sql', {
                    query: `
                    SELECT 
                        column_name,
                        data_type,
                        is_nullable,
                        column_default,
                        character_maximum_length,
                        numeric_precision,
                        numeric_scale,
                        ordinal_position
                    FROM information_schema.columns 
                    WHERE table_name = 'operations' 
                    AND table_schema = 'public'
                    ORDER BY ordinal_position;
                    `
                });

                if (error) {
                    // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª—è
                    log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ö–µ–º—É —á–µ—Ä–µ–∑ information_schema. –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±...', 'error');
                    
                    const { data: sampleData, error: sampleError } = await supabase
                        .from('operations')
                        .select('*')
                        .limit(1);
                    
                    if (sampleError) {
                        log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ${sampleError.message}`, 'error');
                        
                        // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
                        if (sampleError.message.includes('relation "operations" does not exist')) {
                            log('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ operations –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É.', 'error');
                        }
                        return;
                    }
                    
                    if (sampleData && sampleData.length > 0) {
                        log('‚úÖ –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ operations:', 'success');
                        log('üìã –ü–æ–ª—è –≤ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏:', 'info');
                        Object.keys(sampleData[0]).forEach(key => {
                            log(`  - ${key}: ${typeof sampleData[0][key]} = ${sampleData[0][key]}`, 'info');
                        });
                    } else {
                        log('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ operations –ø—É—Å—Ç–∞', 'info');
                        
                        // –ü–æ–ø—Ä–æ–±—É–µ–º –æ–ø–∏—Å–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç–æ–π SELECT
                        try {
                            const { data: descData, error: descError } = await supabase
                                .from('operations')
                                .select('*')
                                .limit(0);
                            
                            if (descData !== null) {
                                log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ operations —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–æ –ø—É—Å—Ç–∞', 'success');
                            }
                        } catch (e) {
                            log(`‚ùå –¢–∞–±–ª–∏—Ü–∞ operations –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ${e.message}`, 'error');
                        }
                    }
                    return;
                }

                if (data && data.length > 0) {
                    log('‚úÖ –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã operations:', 'success');
                    log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
                    
                    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    let tableHtml = '<table class="schema-table"><tr><th>–ö–æ–ª–æ–Ω–∫–∞</th><th>–¢–∏–ø</th><th>Null?</th><th>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</th><th>–ü–æ–∑–∏—Ü–∏—è</th></tr>';
                    
                    data.forEach(col => {
                        tableHtml += `<tr>
                            <td><strong>${col.column_name}</strong></td>
                            <td>${col.data_type}${col.character_maximum_length ? `(${col.character_maximum_length})` : ''}</td>
                            <td>${col.is_nullable}</td>
                            <td>${col.column_default || ''}</td>
                            <td>${col.ordinal_position}</td>
                        </tr>`;
                        
                        log(`${col.ordinal_position.toString().padStart(2)}. ${col.column_name.padEnd(25)} ${col.data_type}${col.character_maximum_length ? `(${col.character_maximum_length})` : ''} ${col.is_nullable === 'YES' ? 'NULL' : 'NOT NULL'}`, 'info');
                    });
                    
                    tableHtml += '</table>';
                    document.getElementById('log').innerHTML += tableHtml + '\n';
                    
                    log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
                    const columnNames = data.map(col => col.column_name);
                    const requiredColumns = ['start_time', 'end_time', 'operation_type', 'status', 'trading_point_id'];
                    
                    log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫:', 'info');
                    requiredColumns.forEach(reqCol => {
                        if (columnNames.includes(reqCol)) {
                            log(`‚úÖ ${reqCol} - –Ω–∞–π–¥–µ–Ω–∞`, 'success');
                        } else {
                            log(`‚ùå ${reqCol} - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!`, 'error');
                        }
                    });
                    
                } else {
                    log('‚ö†Ô∏è –°—Ö–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –ø—É—Å—Ç–∞', 'info');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                console.error('Error:', error);
            }
        }
        
        async function checkTableData() {
            log('üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ operations...', 'info');
            
            try {
                const { data, error, count } = await supabase
                    .from('operations')
                    .select('*', { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
                    return;
                }

                log(`üìà –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –≤ operations: ${count || 0}`, 'info');
                
                if (data && data.length > 0) {
                    log('üîç –ü–µ—Ä–≤—ã–µ 5 –∑–∞–ø–∏—Å–µ–π:', 'info');
                    data.forEach((op, index) => {
                        log(`${index + 1}. ID: ${op.id} | Type: ${op.operation_type || 'N/A'} | Status: ${op.status || 'N/A'}`, 'info');
                        log(`   Created: ${op.created_at || 'N/A'} | Updated: ${op.updated_at || 'N/A'}`, 'info');
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–æ–ª—è
                        if ('start_time' in op) {
                            log(`   Start Time: ${op.start_time || 'NULL'}`, 'success');
                        } else {
                            log(`   ‚ùå –ü–æ–ª–µ start_time –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!`, 'error');
                        }
                    });
                } else {
                    log('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ operations –ø—É—Å—Ç–∞ - –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ', 'info');
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                console.error('Error:', error);
            }
        }

        async function createMissingColumns() {
            log('üîß –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏...', 'info');
            
            // –≠—Ç–æ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ç—Ä–µ–±—É–µ—Ç RLS permissions –∏–ª–∏ service role key
            log('‚ö†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ —Ç—Ä–µ–±—É–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤.', 'info');
            log('üìù SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∫–æ–ª–æ–Ω–æ–∫:', 'info');
            log(`
ALTER TABLE operations 
ADD COLUMN IF NOT EXISTS start_time TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS end_time TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS operation_type VARCHAR(50),
ADD COLUMN IF NOT EXISTS status VARCHAR(20),
ADD COLUMN IF NOT EXISTS trading_point_id VARCHAR(255),
ADD COLUMN IF NOT EXISTS trading_point_name VARCHAR(255),
ADD COLUMN IF NOT EXISTS device_id VARCHAR(255),
ADD COLUMN IF NOT EXISTS transaction_id VARCHAR(255),
ADD COLUMN IF NOT EXISTS fuel_type VARCHAR(100),
ADD COLUMN IF NOT EXISTS quantity DECIMAL(10,2),
ADD COLUMN IF NOT EXISTS price DECIMAL(10,2),
ADD COLUMN IF NOT EXISTS total_cost DECIMAL(10,2),
ADD COLUMN IF NOT EXISTS payment_method VARCHAR(50),
ADD COLUMN IF NOT EXISTS details TEXT,
ADD COLUMN IF NOT EXISTS progress INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS operator_name VARCHAR(255),
ADD COLUMN IF NOT EXISTS customer_id VARCHAR(255),
ADD COLUMN IF NOT EXISTS vehicle_number VARCHAR(50),
ADD COLUMN IF NOT EXISTS duration INTEGER,
ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}';
            `, 'info');
            
            log('üí° –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL –≤ Supabase Dashboard > SQL Editor', 'info');
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ö–µ–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            log('üåü –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã operations...', 'info');
            checkTableSchema();
        });
    </script>
</body>
</html>