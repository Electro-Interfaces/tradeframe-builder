<!DOCTYPE html>
<html>
<head>
    <title>Migrate Instructions to Database</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #fde8e8; border-color: #f44336; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; font-size: 12px; max-height: 400px; }
        .button { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            margin: 10px 5px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .button:hover { background: #45a049; }
        .button.secondary { background: #2196f3; }
        .button.secondary:hover { background: #1976d2; }
        .step { background: #f9f9f9; margin: 5px 0; padding: 10px; border-left: 3px solid #2196f3; }
    </style>
</head>
<body>
    <h1>üîÑ Migration: localStorage ‚Üí Supabase Database</h1>
    
    <div class="test warning">
        <h3>üéØ –ü—Ä–æ–±–ª–µ–º–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ</h3>
        <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ë–î</p>
        <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> –î–∞–Ω–Ω—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ localStorage, –∞ –Ω–µ –≤ —Ç–∞–±–ª–∏—Ü–µ page_help</p>
        <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –≤ Supabase</p>
    </div>
    
    <div class="test">
        <h3>üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h3>
        <button class="button" onclick="checkLocalStorageData()">1Ô∏è‚É£ –ü–†–û–í–ï–†–ò–¢–¨ –î–ê–ù–ù–´–ï –í LOCALSTORAGE</button>
        <button class="button" onclick="checkDatabaseState()">2Ô∏è‚É£ –ü–†–û–í–ï–†–ò–¢–¨ –°–û–°–¢–û–Ø–ù–ò–ï –ë–î</button>
        <button class="button" onclick="runMigration()">3Ô∏è‚É£ –ó–ê–ü–£–°–¢–ò–¢–¨ –ú–ò–ì–†–ê–¶–ò–Æ</button>
        <button class="button secondary" onclick="openInstructionsPage()">üìÑ –û–¢–ö–†–´–¢–¨ –ò–ù–°–¢–†–£–ö–¶–ò–ò</button>
    </div>

    <div id="results"></div>

    <script type="module">
        const results = document.getElementById('results');
        
        function addResult(title, type, data) {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        function addStep(stepNumber, title, status, data) {
            const div = document.createElement('div');
            div.className = 'step';
            const statusIcon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
            div.innerHTML = `
                <strong>–®–∞–≥ ${stepNumber}: ${statusIcon} ${title}</strong>
                <pre style="margin-top: 10px;">${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        window.checkLocalStorageData = function() {
            try {
                // Check for instructions data in localStorage
                const keys = Object.keys(localStorage).filter(key => 
                    key.includes('instruction') || 
                    key.includes('topic') || 
                    key.includes('version') ||
                    key.includes('mock')
                );
                
                let totalTopics = 0;
                let totalVersions = 0;
                let foundData = {};

                keys.forEach(key => {
                    const data = localStorage.getItem(key);
                    try {
                        const parsed = JSON.parse(data);
                        if (Array.isArray(parsed)) {
                            foundData[key] = {
                                count: parsed.length,
                                sample: parsed.slice(0, 2),
                                type: 'array'
                            };
                            
                            // Try to identify topics vs versions
                            if (parsed.some(item => item.route)) {
                                totalTopics += parsed.length;
                            }
                            if (parsed.some(item => item.topic_id)) {
                                totalVersions += parsed.length;
                            }
                        } else {
                            foundData[key] = { data: parsed, type: 'object' };
                        }
                    } catch (e) {
                        foundData[key] = { data: data.substring(0, 100) + '...', type: 'string' };
                    }
                });

                if (Object.keys(foundData).length > 0) {
                    addResult('‚úÖ LocalStorage Data Found', 'success', {
                        found_keys: keys,
                        estimated_topics: totalTopics,
                        estimated_versions: totalVersions,
                        detailed_data: foundData
                    });
                } else {
                    addResult('‚ö†Ô∏è No Instructions Data in LocalStorage', 'warning', {
                        all_localStorage_keys: Object.keys(localStorage),
                        note: 'No instruction-related data found. May need to check other keys or ensure data exists.'
                    });
                }
            } catch (error) {
                addResult('‚ùå Error Checking LocalStorage', 'error', error.message);
            }
        };

        window.checkDatabaseState = async function() {
            try {
                const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
                
                const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
                const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

                const supabase = createClient(supabaseUrl, serviceRoleKey);

                const { data, error, count } = await supabase
                    .from('page_help')
                    .select('*', { count: 'exact' });

                if (error) {
                    addResult('‚ùå Database Check Failed', 'error', error);
                } else {
                    addResult('üìä Database State', 'info', {
                        total_records: count,
                        records: data,
                        is_empty: count === 0,
                        migration_needed: count === 0 || count < 10
                    });
                }
            } catch (error) {
                addResult('‚ùå Database Check Error', 'error', error.message);
            }
        };

        window.runMigration = function() {
            const migrationCode = \`
// –ú–ò–ì–†–ê–¶–ò–Ø –î–ê–ù–ù–´–•
// –û—Ç–∫—Ä–æ–π—Ç–µ DevTools Console (F12) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

console.log('üîÑ Starting migration from localStorage to Supabase...');

try {
  // 1. Import the service
  const serviceModule = await import('/src/services/instructionsServiceDatabase.ts');
  const InstructionsService = serviceModule.InstructionsService;
  
  // 2. Import the old service to get localStorage data
  const oldServiceModule = await import('/src/services/instructionsService.ts');
  const oldService = oldServiceModule.instructionsService;
  
  // 3. Get data from localStorage
  console.log('üì¶ Getting data from localStorage...');
  const topics = await oldService.getTopics();
  const allVersions = [];
  
  for (const topic of topics) {
    const versions = await oldService.getVersions(topic.id);
    allVersions.push(...versions);
  }
  
  console.log(\`üìä Found \${topics.length} topics and \${allVersions.length} versions\`);
  
  // 4. Run migration
  console.log('üöÄ Starting migration...');
  await InstructionsService.migrateMockData(topics, allVersions);
  
  console.log('‚úÖ Migration completed!');
  
  // 5. Verify migration
  const migratedTopics = await InstructionsService.getTopics();
  console.log(\`‚úÖ Verification: \${migratedTopics.length} topics now in database\`);
  
} catch (error) {
  console.error('‚ùå Migration failed:', error);
}
\`;

            addResult('üõ†Ô∏è Migration Code', 'info', migrationCode);
            
            // Also show alternative approach
            const alternativeCode = \`
// –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –°–ü–û–°–û–ë –ú–ò–ì–†–ê–¶–ò–ò
// –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

console.log('üì¶ Alternative migration approach...');

// Get localStorage data directly
const instructionKeys = Object.keys(localStorage).filter(k => k.includes('instruction'));
console.log('Found keys:', instructionKeys);

// Show what data we have
instructionKeys.forEach(key => {
  const data = JSON.parse(localStorage.getItem(key) || '[]');
  console.log(\`\${key}: \${data.length} items\`);
  if (data.length > 0) console.log('Sample:', data[0]);
});
\`;

            addResult('üîÑ Alternative Migration Approach', 'warning', alternativeCode);
        };

        window.openInstructionsPage = function() {
            window.open('http://localhost:3003/admin/instructions', '_blank');
            addResult('üìÑ Instructions Page Opened', 'info', '–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É - –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è!');
        };

        // Auto-check localStorage on load
        setTimeout(checkLocalStorageData, 1000);
    </script>
</body>
</html>