<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ä–æ–ª–∏</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
        }
        .container {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid #334155;
        }
        h1 {
            color: #3b82f6;
            margin-bottom: 30px;
            text-align: center;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }
        .success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            color: #4ade80;
        }
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #f87171;
        }
        .info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ä–æ–ª–∏</h1>
        
        <button onclick="checkExistingRoles()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–æ–ª–∏</button>
        <button onclick="testCreateWithManager()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞—Ç—å —Å —Ä–æ–ª—å—é manager</button>
        <button onclick="alterRoleConstraint()">–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å bto_manager –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ</button>

        <div id="result"></div>
    </div>

    <script type="module">
        const resultDiv = document.getElementById('result');
        
        function showResult(message, type = 'info') {
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
        }

        const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

        window.checkExistingRoles = async function() {
            try {
                showResult('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–æ–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ users...', 'info');

                const response = await fetch(`${supabaseUrl}/rest/v1/users?select=role`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${serviceRoleKey}`,
                        'apikey': serviceRoleKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                const roles = [...new Set(users.map(user => user.role))];
                
                showResult(`‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –†–û–õ–ò –í –ë–ê–ó–ï –î–ê–ù–ù–´–•:

üìä –ù–∞–π–¥–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–æ–ª–µ–π: ${roles.length}

üîë –†–û–õ–ò –í –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ò:
${roles.map((role, index) => `${index + 1}. ${role}`).join('\n')}

üìã CHECK CONSTRAINT users_role_check –≤–µ—Ä–æ—è—Ç–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–æ–ª–∏ –¥–æ:
${roles.map(role => `  ‚úÖ "${role}"`).join('\n')}

‚ùå –ù–ï –í–ö–õ–Æ–ß–ê–ï–¢: "bto_manager"

üí° –†–ï–®–ï–ù–ò–ï: –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å "bto_manager" –≤ CHECK constraint
–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "manager").`, 'info');

            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π: ${error.message}`, 'error');
            }
        };

        window.testCreateWithManager = async function() {
            try {
                showResult('üß™ –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–æ–ª—å—é "manager"...', 'info');

                const testUser = {
                    id: 'bb0e8400-e29b-41d4-a716-446655440005', // –î—Ä—É–≥–æ–π ID
                    email: 'test.bto.manager@tradeframe.com',
                    password_hash: '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LeShMKjGEeILVSHFK',
                    name: '–¢–µ—Å—Ç–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ë–¢–û',
                    role: 'manager', // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–æ–ª—å
                    network_id: 'b5e25b51-a950-481e-a09d-ac25e6b5d6ab',
                    trading_point_ids: [],
                    is_active: true
                };

                const response = await fetch(`${supabaseUrl}/rest/v1/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${serviceRoleKey}`,
                        'apikey': serviceRoleKey,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(testUser)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }

                const result = await response.json();
                
                showResult(`‚úÖ –¢–ï–°–¢–û–í–´–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –°–û–ó–î–ê–ù –° –†–û–õ–¨–Æ "MANAGER"!

üéØ –≠—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ —Ä–æ–ª—å "manager" —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –≤ CHECK constraint.

üìä –°–æ–∑–¥–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
${JSON.stringify(result, null, 2)}

üí° –í–ê–†–ò–ê–ù–¢–´ –†–ï–®–ï–ù–ò–Ø:

1. üîÑ –ò–ó–ú–ï–ù–ò–¢–¨ –†–û–õ–¨: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–æ–ª—å "manager" 
   –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–¢–û

2. üõ†Ô∏è –†–ê–°–®–ò–†–ò–¢–¨ CONSTRAINT: –î–æ–±–∞–≤–∏—Ç—å "bto_manager" –≤ users_role_check
   ALTER TABLE users DROP CONSTRAINT users_role_check;
   ALTER TABLE users ADD CONSTRAINT users_role_check 
   CHECK (role IN ('system_admin', 'network_admin', 'manager', 'operator', 'bto_manager'));

3. üìù –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–¢–¨: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å role='manager' –Ω–æ —Å –æ—Ç–¥–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
   –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–µ–Ω–∏—è –æ–±—ã—á–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ë–¢–û

üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –í–∞—Ä–∏–∞–Ω—Ç 2 - —Ä–∞—Å—à–∏—Ä–∏—Ç—å constraint`, 'success');

            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${error.message}`, 'error');
            }
        };

        window.alterRoleConstraint = async function() {
            try {
                showResult('üõ†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è CHECK constraint (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ SQL)...', 'info');

                // –≠—Ç–æ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ REST API, –Ω–æ –ø–æ–∫–∞–∂–µ–º —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å
                showResult(`üõ†Ô∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï CHECK CONSTRAINT

‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –ò–∑–º–µ–Ω–µ–Ω–∏–µ CHECK constraint –Ω–µ–ª—å–∑—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ REST API.
–ù—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∫–æ–º–∞–Ω–¥—ã –Ω–∞–ø—Ä—è–º—É—é –≤ Supabase Dashboard:

üìù SQL –ö–û–ú–ê–ù–î–´ –î–õ–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø:

-- 1. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
ALTER TABLE public.users DROP CONSTRAINT users_role_check;

-- 2. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π bto_manager
ALTER TABLE public.users ADD CONSTRAINT users_role_check 
CHECK (role IN (
  'system_admin',
  'network_admin', 
  'manager',
  'operator',
  'bto_manager'
));

-- 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
SELECT conname, consrc 
FROM pg_constraint 
WHERE conname = 'users_role_check';

üîß –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê: –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–æ–ª—å—é 'manager',
–Ω–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –µ–≥–æ –∫–∞–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–¢–û –ø–æ email.

üí° –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –∫–æ–º–∞–Ω–¥ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 
—Å —Ä–æ–ª—å—é 'bto_manager'.`, 'info');

            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            checkExistingRoles();
        });
    </script>
</body>
</html>