<!DOCTYPE html>
<html>
<head>
    <title>Debug Full Instructions Flow</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #fde8e8; border-color: #f44336; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; font-size: 12px; max-height: 400px; }
        .button { 
            background: #2196f3; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer;
        }
        .button:hover { background: #1976d2; }
        .step { background: #f9f9f9; margin: 5px 0; padding: 10px; border-left: 3px solid #2196f3; }
    </style>
</head>
<body>
    <h1>üîç Debug Full Instructions Flow</h1>
    
    <div class="test info">
        <h3>üéØ –¶–µ–ª—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</h3>
        <p>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –æ—Ç –ë–î –¥–æ UI</p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –†–∞–∑–¥–µ–ª –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –ë–î, –Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ</p>
    </div>
    
    <div class="test">
        <h3>üîÑ –ü–æ—à–∞–≥–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
        <button class="button" onclick="runFullDiagnostic()">‚ñ∂Ô∏è –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–û–õ–ù–£–Æ –î–ò–ê–ì–ù–û–°–¢–ò–ö–£</button>
        <button class="button" onclick="testManualService()">üß™ Test Service Manually</button>
        <button class="button" onclick="checkConsoleErrors()">üñ•Ô∏è Check Console Guide</button>
        <button class="button" onclick="openInstructions()">üìÑ Open Instructions Page</button>
    </div>

    <div id="results"></div>

    <script type="module">
        const results = document.getElementById('results');
        
        function addResult(title, type, data) {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        function addStep(stepNumber, title, status, data) {
            const div = document.createElement('div');
            div.className = 'step';
            const statusIcon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
            div.innerHTML = `
                <strong>–®–∞–≥ ${stepNumber}: ${statusIcon} ${title}</strong>
                <pre style="margin-top: 10px;">${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        async function getSupabaseClient() {
            const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
            
            const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
            const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';

            return createClient(supabaseUrl, serviceRoleKey);
        }

        window.runFullDiagnostic = async function() {
            addResult('üöÄ Starting Full Diagnostic', 'info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π...');

            // Step 1: Test database connection
            addStep(1, 'Test Database Connection', 'pending', 'Connecting to Supabase...');
            try {
                const supabase = await getSupabaseClient();
                const { data: testData, error: testError } = await supabase
                    .from('networks')
                    .select('id')
                    .limit(1);
                
                if (testError) {
                    addStep(1, 'Database Connection', 'error', testError);
                    return;
                } else {
                    addStep(1, 'Database Connection', 'success', 'Connected successfully');
                }
            } catch (error) {
                addStep(1, 'Database Connection', 'error', error.message);
                return;
            }

            // Step 2: Check table exists and has data
            addStep(2, 'Check page_help Table', 'pending', 'Checking table data...');
            try {
                const supabase = await getSupabaseClient();
                const { data: allData, error: allError, count } = await supabase
                    .from('page_help')
                    .select('*', { count: 'exact' });
                
                if (allError) {
                    addStep(2, 'Check page_help Table', 'error', allError);
                    return;
                } else {
                    addStep(2, 'Check page_help Table', 'success', {
                        total_records: count,
                        sample: allData.slice(0, 2)
                    });
                }
            } catch (error) {
                addStep(2, 'Check page_help Table', 'error', error.message);
                return;
            }

            // Step 3: Test InstructionsService query exact replica
            addStep(3, 'Test Service Query Logic', 'pending', 'Testing exact query from InstructionsService...');
            try {
                const supabase = await getSupabaseClient();
                
                // Exact query from InstructionsService.getTopics()
                let query = supabase
                    .from('page_help')
                    .select('*')
                    .is('deleted_at', null)
                    .eq('is_active', true)
                    .order('route');

                const { data: queryData, error: queryError } = await query;
                
                if (queryError) {
                    addStep(3, 'Service Query Logic', 'error', queryError);
                } else {
                    addStep(3, 'Service Query Logic', queryData.length > 0 ? 'success' : 'warning', {
                        found_records: queryData.length,
                        records: queryData,
                        note: queryData.length === 0 ? 'No records match is_active=true filter!' : 'Records found'
                    });
                }
                
                // Step 4: Test without is_active filter
                addStep(4, 'Test Without is_active Filter', 'pending', 'Testing query without is_active filter...');
                
                const { data: noFilterData, error: noFilterError } = await supabase
                    .from('page_help')
                    .select('*')
                    .is('deleted_at', null)
                    .order('route');
                
                if (noFilterError) {
                    addStep(4, 'Test Without is_active Filter', 'error', noFilterError);
                } else {
                    addStep(4, 'Test Without is_active Filter', 'success', {
                        found_records: noFilterData.length,
                        is_active_values: noFilterData.map(r => ({ route: r.route, is_active: r.is_active }))
                    });
                }

            } catch (error) {
                addStep(3, 'Service Query Logic', 'error', error.message);
            }

            // Step 5: Test topic mapping logic
            addStep(5, 'Test Topic Mapping Logic', 'pending', 'Testing data transformation...');
            try {
                const supabase = await getSupabaseClient();
                const { data: rawData } = await supabase
                    .from('page_help')
                    .select('*')
                    .is('deleted_at', null)
                    .limit(5);

                if (rawData && rawData.length > 0) {
                    // Simulate the mapping logic from InstructionsService
                    const topicsMap = new Map();
                    rawData.forEach(record => {
                        const existing = topicsMap.get(record.route);
                        if (!existing || record.version > existing.version) {
                            topicsMap.set(record.route, record);
                        }
                    });
                    
                    const mappedTopics = Array.from(topicsMap.values()).map(record => ({
                        id: record.id,
                        key: record.route.replace(/^\//, '').replace(/\//g, '-'),
                        route: record.route,
                        title: record.title,
                        description: record.content ? record.content.substring(0, 100) + '...' : 'No content',
                        is_active: record.is_active,
                        views_total: 0,
                        created_at: record.created_at,
                        updated_at: record.updated_at
                    }));

                    addStep(5, 'Topic Mapping Logic', 'success', {
                        raw_records: rawData.length,
                        mapped_topics: mappedTopics.length,
                        sample_topic: mappedTopics[0]
                    });
                } else {
                    addStep(5, 'Topic Mapping Logic', 'warning', 'No data to map');
                }
            } catch (error) {
                addStep(5, 'Topic Mapping Logic', 'error', error.message);
            }

            addResult('‚úÖ Diagnostic Complete', 'success', 'Check the steps above to identify the issue');
        };

        window.testManualService = function() {
            const testCode = \`
// MANUAL SERVICE TEST
// Open DevTools Console (F12) and run:

console.log('üîß Testing InstructionsService manually...');

try {
  // Import the service
  const serviceModule = await import('/src/services/instructionsServiceDatabase.ts');
  const InstructionsService = serviceModule.InstructionsService;
  
  console.log('‚úÖ Service imported:', InstructionsService);
  
  // Test getTopics method
  console.log('üìã Calling getTopics()...');
  const topics = await InstructionsService.getTopics();
  
  console.log('üìä getTopics() result:', topics);
  console.log('üìä Topics count:', topics.length);
  
  if (topics.length === 0) {
    console.log('‚ö†Ô∏è No topics found - testing getAllTopics...');
    const allTopics = await InstructionsService.getAllTopics();
    console.log('üìä getAllTopics() result:', allTopics);
  }
  
} catch (error) {
  console.error('‚ùå Service test failed:', error);
}
\`;

            addResult('üõ†Ô∏è Manual Service Test Code', 'info', testCode);
        };

        window.checkConsoleErrors = function() {
            const guide = \`
üñ•Ô∏è –ü–†–û–í–ï–†–¨–¢–ï –ö–û–ù–°–û–õ–¨ –ë–†–ê–£–ó–ï–†–ê (F12 -> Console):

–ß–¢–û –ò–°–ö–ê–¢–¨:
1. –û—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
2. –û—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ InstructionsService.getTopics()
3. –û—à–∏–±–∫–∏ Supabase (PGRST –∫–æ–¥—ã)
4. Network errors

–•–û–†–û–®–ò–ï –°–ò–ì–ù–ê–õ–´:
‚Ä¢ "üîß Supabase Service Client Configuration"
‚Ä¢ "‚úÖ Topics loaded: [...]"
‚Ä¢ –£—Å–ø–µ—à–Ω—ã–µ HTTP 200 –∑–∞–ø—Ä–æ—Å—ã

–ü–õ–û–•–ò–ï –°–ò–ì–ù–ê–õ–´:
‚Ä¢ "‚ùå Error fetching topics"
‚Ä¢ "PGRST116" / "PGRST301" –æ—à–∏–±–∫–∏
‚Ä¢ "relation does not exist"
‚Ä¢ Network 404/500 –æ—à–∏–±–∫–∏

–ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨:
1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3003/admin/instructions
2. F12 -> Console
3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
4. –ù–∞–π–¥–∏—Ç–µ –æ—à–∏–±–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
\`;

            addResult('üñ•Ô∏è Console Check Guide', 'info', guide);
        };

        window.openInstructions = function() {
            window.open('http://localhost:3003/admin/instructions', '_blank');
            addResult('üìÑ Instructions Page Opened', 'info', 'Check the page and browser console for errors');
        };

        // Auto-start a basic check
        setTimeout(() => {
            addResult('üéØ Ready for Diagnostics', 'info', 'Click "–ó–ê–ü–£–°–¢–ò–¢–¨ –ü–û–õ–ù–£–Æ –î–ò–ê–ì–ù–û–°–¢–ò–ö–£" to begin detailed testing');
        }, 500);
    </script>
</body>
</html>