<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Selection Context Values</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .error { background: #f44336; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { background: #2196F3; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #4CAF50; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        pre {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Selection Context Values</h1>
        
        <div class="info">
            –≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ SelectionContext, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ STS API
        </div>
        
        <button onclick="checkSelectionContext()">üìã –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤</button>
        <button onclick="checkLocalStorage()">üíæ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
        <button onclick="openTanksPage()">‚õΩ –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤</button>
        <button onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>

        <div id="results"></div>
    </div>

    <script>
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({
                time: timestamp,
                message: message,
                type: type
            });
            updateDisplay();
            console.log(`[${timestamp}] ${message}`);
        }

        function updateDisplay() {
            const resultsDiv = document.getElementById('results');
            
            let html = '';
            
            if (logs.length > 0) {
                html += '<h2>üìù –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:</h2>';
                logs.forEach(logEntry => {
                    const className = logEntry.type === 'error' ? 'error' : logEntry.type === 'success' ? 'success' : 'info';
                    html += `<div class="${className}">
                        <strong>[${logEntry.time}]</strong> ${logEntry.message}
                    </div>`;
                });
            }
            
            resultsDiv.innerHTML = html;
        }

        function checkSelectionContext() {
            log('üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ SelectionContext...', 'info');
            
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å iframe —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
            try {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ, —á—Ç–æ–±—ã –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const appWindow = window.open('http://localhost:3004/point/tanks', '_blank', 'width=1200,height=800');
                
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º
                setTimeout(() => {
                    try {
                        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Å–æ–ª–∏ –æ–∫–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                        log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –æ—Ç–∫—Ä—ã—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏–π —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤.', 'success');
                        log('–í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ –≤–∏–¥–∞: "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤: {networkId: ..., tradingPointId: ...}"', 'info');
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                        setTimeout(() => {
                            if (appWindow && !appWindow.closed) {
                                appWindow.close();
                                log('üîÑ –û–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', 'info');
                            }
                        }, 10000);
                        
                    } catch (error) {
                        log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–∫–Ω–∞: ${error.message}`, 'error');
                    }
                }, 3000);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ${error.message}`, 'error');
            }
        }

        function checkLocalStorage() {
            log('üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage...', 'info');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã localStorage
                const selectedNetwork = localStorage.getItem('tc:selectedNetwork');
                const selectedTradingPoint = localStorage.getItem('tc:selectedTradingPoint');
                const stsConfig = localStorage.getItem('sts-api-config');
                
                log('=== LocalStorage Values ===', 'info');
                
                if (selectedNetwork) {
                    log(`‚úÖ tc:selectedNetwork = "${selectedNetwork}"`, 'success');
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ ID —Å–µ—Ç–∏, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ —Å–µ—Ç–∏
                    if (selectedNetwork.trim()) {
                        log(`üîç –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ—Ç–∏ ID: ${selectedNetwork}`, 'info');
                        
                        // –ó–¥–µ—Å—å –º—ã –º–æ–∂–µ–º –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å–µ—Ç–∏
                        // –ù–æ –ø–æ—Å–∫–æ–ª—å–∫—É –º—ã –Ω–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –Ω–∞—à–ª–∏ ID
                        log(`üí° –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ ID (external_id) —Å–µ—Ç–∏ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ API —Å–µ—Ç–µ–π`, 'info');
                    }
                } else {
                    log(`‚ùå tc:selectedNetwork –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage`, 'error');
                }
                
                if (selectedTradingPoint) {
                    log(`‚úÖ tc:selectedTradingPoint = "${selectedTradingPoint}"`, 'success');
                } else {
                    log(`‚ùå tc:selectedTradingPoint –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage`, 'error');
                }
                
                if (stsConfig) {
                    try {
                        const config = JSON.parse(stsConfig);
                        log(`‚úÖ sts-api-config –Ω–∞–π–¥–µ–Ω:`, 'success');
                        log(`<pre>${JSON.stringify({
                            url: config.url,
                            username: config.username ? '***' : '–Ω–µ –∑–∞–¥–∞–Ω',
                            enabled: config.enabled,
                            hasToken: !!config.token,
                            tokenExpiry: config.tokenExpiry ? new Date(config.tokenExpiry).toISOString() : '–Ω–µ –∑–∞–¥–∞–Ω'
                        }, null, 2)}</pre>`, 'info');
                    } catch (e) {
                        log(`‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ sts-api-config: ${e.message}`, 'error');
                    }
                } else {
                    log(`‚ùå sts-api-config –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage`, 'error');
                }
                
                log('=== –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ===', 'info');
                log(`üí° –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã STS API –Ω—É–∂–Ω–æ:`, 'info');
                log(`1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ external_id —Å–µ—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—É "system" API`, 'info');
                log(`2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ selectedTradingPoint —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—É "station" API`, 'info');
                log(`3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API –Ω–∞ https://pos.autooplata.ru/tms/docs`, 'info');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ localStorage: ${error.message}`, 'error');
            }
        }

        function openTanksPage() {
            window.open('http://localhost:3004/point/tanks', '_blank');
        }

        function clearLogs() {
            logs.length = 0;
            updateDisplay();
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        window.onload = function() {
            log('üèÅ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
            log('üìã –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏', 'info');
        };
    </script>
</body>
</html>