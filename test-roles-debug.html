<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Roles Page</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1b23;
            color: white;
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #333; 
            border-radius: 8px;
            background: #2a2b35;
        }
        button { 
            background: #3b82f6; 
            color: white; 
            padding: 8px 16px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        .status { 
            display: inline-block; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px;
            font-weight: 500;
        }
        .connected { background: #059669; color: white; }
        .disconnected { background: #dc2626; color: white; }
        pre { 
            background: #1e293b; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Roles Page</h1>
    
    <div class="section">
        <h2>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ä–æ–ª—è–º</h2>
        <div id="diagnosis-result">–ü—Ä–æ–≤–µ—Ä—è—é...</div>
    </div>

    <div class="section">
        <h2>–¢–µ—Å—Ç API –∑–∞–ø—Ä–æ—Å–∞</h2>
        <button onclick="testRolesAPI()">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API —Ä–æ–ª–µ–π</button>
        <div id="api-result"></div>
    </div>

    <div class="section">
        <h2>–≠–º—É–ª—è—Ü–∏—è —Ö—É–∫–∞ useDataSourceInfo</h2>
        <div id="hook-simulation">–°–∏–º—É–ª–∏—Ä—É—é...</div>
    </div>

    <div class="section">
        <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
        <button onclick="openRolesPage()">üìã –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–æ–ª–µ–π</button>
        <button onclick="openExternalDbSettings()">‚öôÔ∏è –û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–π –ë–î</button>
        <button onclick="setValidSettings()">‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button onclick="window.close()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        // –≠–º—É–ª—è—Ü–∏—è —Ö—É–∫–∞ useDataSourceInfo
        function checkExternalDatabase() {
            try {
                const settings = localStorage.getItem('externalDatabase');
                console.log('üîç externalDatabase –∏–∑ localStorage:', settings);
                if (!settings) return false;
                const parsed = JSON.parse(settings);
                console.log('üîç Parsed settings:', parsed);
                const result = !!(parsed.url && parsed.apiKey);
                console.log('üîç Connection check result:', result);
                return result;
            } catch (error) {
                console.error('üîç Error in checkExternalDatabase:', error);
                return false;
            }
        }

        function diagnosePage() {
            const hasExternalDatabase = checkExternalDatabase();
            const diagnosisDiv = document.getElementById('diagnosis-result');
            
            diagnosisDiv.innerHTML = `
                <p>localStorage –∫–ª—é—á 'externalDatabase': <strong>${localStorage.getItem('externalDatabase') ? '–°—É—â–µ—Å—Ç–≤—É–µ—Ç' : '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</strong></p>
                <p>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ hasExternalDatabase: <span class="status ${hasExternalDatabase ? 'connected' : 'disconnected'}">
                    ${hasExternalDatabase ? '‚úÖ true' : '‚ùå false'}
                </span></p>
                <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage:</p>
                <pre>${localStorage.getItem('externalDatabase') || 'null'}</pre>
            `;
        }

        function simulateHook() {
            const hookDiv = document.getElementById('hook-simulation');
            const hasExternalDatabase = checkExternalDatabase();
            
            hookDiv.innerHTML = `
                <p>–°–∏–º—É–ª—è—Ü–∏—è —Ö—É–∫–∞ useDataSourceInfo:</p>
                <pre>const { hasExternalDatabase } = useDataSourceInfo()
// hasExternalDatabase = ${hasExternalDatabase}</pre>
                
                <p>DataSourceIndicator –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:</p>
                <div style="border: 1px solid #333; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <span class="status ${hasExternalDatabase ? 'connected' : 'disconnected'}">
                        üóÑÔ∏è –í–Ω–µ—à–Ω—è—è –ë–î ${hasExternalDatabase ? '(–ø–æ–¥–∫–ª—é—á–µ–Ω–æ)' : '(–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ)'}
                    </span>
                </div>
            `;
        }

        async function testRolesAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<p>üß™ –¢–µ—Å—Ç–∏—Ä—É—é API...</p>';
            
            try {
                const settings = localStorage.getItem('externalDatabase');
                if (!settings) {
                    throw new Error('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–π –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                }
                
                const parsed = JSON.parse(settings);
                if (!parsed.url || !parsed.apiKey) {
                    throw new Error('–ù–µ–ø–æ–ª–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î');
                }
                
                // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ API
                const response = await fetch(`${parsed.url}/rest/v1/roles`, {
                    method: 'GET',
                    headers: {
                        'apikey': parsed.apiKey,
                        'Authorization': `Bearer ${parsed.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                resultDiv.innerHTML = `
                    <p>‚úÖ <strong>API —Ä–∞–±–æ—Ç–∞–µ—Ç!</strong></p>
                    <p>–°—Ç–∞—Ç—É—Å: ${response.status}</p>
                    <p>–ü–æ–ª—É—á–µ–Ω–æ —Ä–æ–ª–µ–π: ${data.length}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p>‚ùå <strong>–û—à–∏–±–∫–∞ API:</strong></p>
                    <p>${error.message}</p>
                `;
            }
        }

        function openRolesPage() {
            window.open('http://localhost:3006/admin/roles', '_blank');
        }

        function openExternalDbSettings() {
            window.open('http://localhost:3006/settings/external-database', '_blank');
        }

        function setValidSettings() {
            const validSettings = {
                url: 'https://your-project.supabase.co',
                apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.example'
            };
            
            localStorage.setItem('externalDatabase', JSON.stringify(validSettings));
            alert('‚úÖ –í–∞–ª–∏–¥–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!');
            diagnosePage();
            simulateHook();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        diagnosePage();
        simulateHook();
        
        console.log('üîç Debug Roles Page –∑–∞–≥—Ä—É–∂–µ–Ω');
        console.log('üîç localStorage.externalDatabase:', localStorage.getItem('externalDatabase'));
    </script>
</body>
</html>