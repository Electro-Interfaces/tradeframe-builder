<!DOCTYPE html>
<html>
<head>
    <title>üöÄ PWA –ü–æ–ª–Ω—ã–π –¢–µ—Å—Ç - TradeControl</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #0f172a; 
            color: white; 
            line-height: 1.6;
        }
        .section { 
            margin: 20px 0; 
            padding: 20px; 
            background: #1e293b; 
            border-radius: 12px; 
            border: 1px solid #334155;
        }
        .feature { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .ready { background: #0f5132; border-left-color: #10b981; }
        .partial { background: #7c2d12; border-left-color: #f59e0b; }
        .missing { background: #7f1d1d; border-left-color: #ef4444; }
        .test-btn { 
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            min-height: 44px;
        }
        .test-btn:hover { background: #2563eb; }
        .test-btn.success { background: #10b981; }
        .test-btn.warning { background: #f59e0b; }
        .test-btn.error { background: #ef4444; }
        .status { 
            display: inline-block; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold; 
            margin-left: 10px;
        }
        .status-ready { background: #10b981; color: white; }
        .status-partial { background: #f59e0b; color: white; }
        .status-missing { background: #ef4444; color: white; }
        h1 { color: #3b82f6; font-size: 2rem; margin-bottom: 10px; }
        h2 { color: #10b981; margin-top: 30px; }
        h3 { color: #f59e0b; margin-top: 20px; }
        .console { 
            background: #0f172a; 
            border: 1px solid #334155; 
            border-radius: 8px; 
            padding: 15px; 
            font-family: 'Courier New', monospace; 
            font-size: 14px; 
            max-height: 200px; 
            overflow-y: auto; 
            margin: 10px 0;
        }
        .install-prompt {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            cursor: pointer;
            display: none;
        }
        
        @media (max-width: 768px) {
            body { font-size: 16px; margin: 10px; }
            h1 { font-size: 1.5rem; }
            .section { padding: 15px; }
        }
    </style>
</head>
<body>
    <h1>üöÄ PWA –ü–æ–ª–Ω—ã–π –¢–µ—Å—Ç TradeControl</h1>
    <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
    
    <div id="install-prompt" class="install-prompt">
        üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ! –ù–∞–∂–º–∏—Ç–µ –∑–¥–µ—Å—å
    </div>

    <div class="section">
        <h2>üîß –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã PWA:</h2>
        
        <div class="feature">
            <h3>Service Worker <span id="sw-status" class="status status-missing">–¢–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è</span></h3>
            <button onclick="testServiceWorker()" class="test-btn">üß™ –¢–µ—Å—Ç Service Worker</button>
            <button onclick="testOfflineMode()" class="test-btn">üì° –¢–µ—Å—Ç Offline —Ä–µ–∂–∏–º–∞</button>
            <div id="sw-console" class="console"></div>
        </div>
        
        <div class="feature">
            <h3>Manifest & Icons <span id="manifest-status" class="status status-missing">–¢–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è</span></h3>
            <button onclick="testManifest()" class="test-btn">üìã –¢–µ—Å—Ç Manifest</button>
            <button onclick="testIcons()" class="test-btn">üé® –¢–µ—Å—Ç Icons</button>
            <div id="manifest-console" class="console"></div>
        </div>
        
        <div class="feature">
            <h3>Install Prompt <span id="install-status" class="status status-missing">–û–∂–∏–¥–∞–µ—Ç—Å—è</span></h3>
            <button onclick="testInstallability()" class="test-btn">üì± –¢–µ—Å—Ç –£—Å—Ç–∞–Ω–æ–≤–∫–∏</button>
            <button onclick="triggerInstall()" class="test-btn">üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞</button>
            <div id="install-console" class="console"></div>
        </div>
    </div>

    <div class="section">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h2>
        <div id="test-results"></div>
    </div>

    <div class="section">
        <h2>üõ†Ô∏è –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã:</h2>
        
        <button onclick="runFullTest()" class="test-btn">üöÄ –ü–æ–ª–Ω—ã–π –¢–µ—Å—Ç PWA</button>
        <button onclick="testMobileFeatures()" class="test-btn">üì± –¢–µ—Å—Ç –º–æ–±–∏–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π</button>
        <button onclick="showDeviceInfo()" class="test-btn">üìü –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</button>
        <button onclick="clearCache()" class="test-btn warning">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
    </div>

    <div class="section">
        <h2>üîó –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏:</h2>
        <a href="http://localhost:3000" class="test-btn" style="display: inline-block; text-decoration: none;">
            üè† –ì–ª–∞–≤–Ω–∞—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        </a>
        <a href="http://localhost:3000/network/equipment" class="test-btn" style="display: inline-block; text-decoration: none;">
            üîß –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (–º–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
        </a>
        <a href="/offline.html" class="test-btn" style="display: inline-block; text-decoration: none;">
            üåê Offline —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        </a>
    </div>

    <script>
        let deferredPrompt;
        let testResults = {
            serviceWorker: false,
            manifest: false,
            icons: false,
            installable: false,
            offline: false
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('‚úÖ PWA Install Prompt Ready');
            e.preventDefault();
            deferredPrompt = e;
            
            const installPrompt = document.getElementById('install-prompt');
            installPrompt.style.display = 'block';
            installPrompt.onclick = triggerInstall;
            
            updateStatus('install-status', '–ì–æ—Ç–æ–≤ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ', 'ready');
            testResults.installable = true;
            updateTestResults();
        });

        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA Installed Successfully');
            document.getElementById('install-prompt').style.display = 'none';
            deferredPrompt = null;
            log('install-console', '‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
        });

        function log(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        function updateStatus(statusId, text, type) {
            const status = document.getElementById(statusId);
            status.textContent = text;
            status.className = `status status-${type}`;
        }

        function testServiceWorker() {
            log('sw-console', 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Service Worker...');
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        log('sw-console', `‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${registrations[0].scope}`);
                        updateStatus('sw-status', '–†–∞–±–æ—Ç–∞–µ—Ç', 'ready');
                        testResults.serviceWorker = true;
                        
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                        registrations[0].addEventListener('updatefound', () => {
                            log('sw-console', 'üîÑ –ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Service Worker');
                        });
                    } else {
                        log('sw-console', '‚ùå Service Worker –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        updateStatus('sw-status', '–ù–µ –Ω–∞–π–¥–µ–Ω', 'missing');
                    }
                    updateTestResults();
                });
            } else {
                log('sw-console', '‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º');
                updateStatus('sw-status', '–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'missing');
                updateTestResults();
            }
        }

        function testOfflineMode() {
            log('sw-console', 'üì° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ offline —Ä–µ–∂–∏–º–∞...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    log('sw-console', `üì¶ –ù–∞–π–¥–µ–Ω–æ –∫—ç—à–µ–π: ${cacheNames.length}`);
                    cacheNames.forEach(name => {
                        log('sw-console', `   - ${name}`);
                    });
                    
                    if (cacheNames.length > 0) {
                        testResults.offline = true;
                        log('sw-console', '‚úÖ Offline –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞');
                    } else {
                        log('sw-console', '‚ö†Ô∏è –ö—ç—à –ø—É—Å—Ç, offline –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å');
                    }
                    updateTestResults();
                });
            }
        }

        function testManifest() {
            log('manifest-console', 'üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ Web App Manifest...');
            
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                fetch(manifestLink.href)
                    .then(response => response.json())
                    .then(manifest => {
                        log('manifest-console', '‚úÖ Manifest –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                        log('manifest-console', `   - –ò–º—è: ${manifest.name}`);
                        log('manifest-console', `   - –†–µ–∂–∏–º: ${manifest.display}`);
                        log('manifest-console', `   - –ò–∫–æ–Ω–æ–∫: ${manifest.icons?.length || 0}`);
                        log('manifest-console', `   - Shortcuts: ${manifest.shortcuts?.length || 0}`);
                        
                        updateStatus('manifest-status', '–ó–∞–≥—Ä—É–∂–µ–Ω', 'ready');
                        testResults.manifest = true;
                        updateTestResults();
                    })
                    .catch(e => {
                        log('manifest-console', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ manifest: ${e.message}`);
                        updateStatus('manifest-status', '–û—à–∏–±–∫–∞', 'missing');
                        updateTestResults();
                    });
            } else {
                log('manifest-console', '‚ùå Manifest link –Ω–µ –Ω–∞–π–¥–µ–Ω');
                updateStatus('manifest-status', '–ù–µ –Ω–∞–π–¥–µ–Ω', 'missing');
                updateTestResults();
            }
        }

        function testIcons() {
            log('manifest-console', 'üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∫–æ–Ω–æ–∫...');
            
            const icons = document.querySelectorAll('link[rel*="icon"]');
            log('manifest-console', `üì± –ù–∞–π–¥–µ–Ω–æ –∏–∫–æ–Ω–æ–∫: ${icons.length}`);
            
            let iconTests = 0;
            let successfulIcons = 0;
            
            icons.forEach(icon => {
                iconTests++;
                const img = new Image();
                img.onload = () => {
                    successfulIcons++;
                    log('manifest-console', `‚úÖ ${icon.href} (${icon.sizes || 'no size'})`);
                    
                    if (iconTests === successfulIcons) {
                        testResults.icons = true;
                        updateTestResults();
                    }
                };
                img.onerror = () => {
                    log('manifest-console', `‚ùå ${icon.href} - –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è`);
                    iconTests--;
                };
                img.src = icon.href;
            });
        }

        function testInstallability() {
            log('install-console', 'üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏...');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ PWA
            const criteria = {
                'Service Worker': 'serviceWorker' in navigator,
                'Manifest': !!document.querySelector('link[rel="manifest"]'),
                'HTTPS/localhost': location.protocol === 'https:' || location.hostname === 'localhost',
                'Display standalone': true // –ø—Ä–æ–≤–µ—Ä–∏–º –≤ manifest
            };
            
            Object.entries(criteria).forEach(([key, value]) => {
                const status = value ? '‚úÖ' : '‚ùå';
                log('install-console', `${status} ${key}: ${value}`);
            });
            
            if (deferredPrompt) {
                log('install-console', '‚úÖ Install prompt –≥–æ—Ç–æ–≤');
                updateStatus('install-status', '–ì–æ—Ç–æ–≤', 'ready');
            } else {
                log('install-console', '‚ö†Ô∏è Install prompt –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
                updateStatus('install-status', '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'partial');
            }
        }

        function triggerInstall() {
            if (deferredPrompt) {
                log('install-console', 'üöÄ –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏...');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        log('install-console', '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É');
                    } else {
                        log('install-console', '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª —É—Å—Ç–∞–Ω–æ–≤–∫—É');
                    }
                    deferredPrompt = null;
                    document.getElementById('install-prompt').style.display = 'none';
                });
            } else {
                log('install-console', '‚ùå Install prompt –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            }
        }

        function runFullTest() {
            console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ PWA —Ç–µ—Å—Ç–∞...');
            
            // –°–±—Ä–æ—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            Object.keys(testResults).forEach(key => testResults[key] = false);
            
            // –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
            setTimeout(testServiceWorker, 100);
            setTimeout(testManifest, 500);
            setTimeout(testIcons, 1000);
            setTimeout(testInstallability, 1500);
            setTimeout(testOfflineMode, 2000);
        }

        function testMobileFeatures() {
            const results = document.getElementById('test-results');
            
            const mobileTests = {
                'Touch Events': 'ontouchstart' in window,
                'Device Orientation': 'DeviceOrientationEvent' in window,
                'Vibration API': 'vibrate' in navigator,
                'Battery API': 'getBattery' in navigator,
                'Network Information': 'connection' in navigator,
                'Geolocation': 'geolocation' in navigator
            };
            
            let html = '<h3>üì± –ú–æ–±–∏–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</h3><ul>';
            Object.entries(mobileTests).forEach(([feature, supported]) => {
                const status = supported ? '‚úÖ' : '‚ùå';
                html += `<li>${status} ${feature}</li>`;
            });
            html += '</ul>';
            
            results.innerHTML = html;
        }

        function showDeviceInfo() {
            const results = document.getElementById('test-results');
            
            const info = {
                'User Agent': navigator.userAgent,
                'Platform': navigator.platform,
                'Language': navigator.language,
                'Online': navigator.onLine,
                'Cookies Enabled': navigator.cookieEnabled,
                'Screen Size': `${screen.width}x${screen.height}`,
                'Viewport Size': `${window.innerWidth}x${window.innerHeight}`,
                'Device Pixel Ratio': window.devicePixelRatio,
                'Color Depth': screen.colorDepth,
                'Timezone': Intl.DateTimeFormat().resolvedOptions().timeZone
            };
            
            let html = '<h3>üìü –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:</h3><ul>';
            Object.entries(info).forEach(([key, value]) => {
                html += `<li><strong>${key}:</strong> ${value}</li>`;
            });
            html += '</ul>';
            
            results.innerHTML = html;
        }

        function clearCache() {
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cacheName => caches.delete(cacheName))
                    );
                }).then(() => {
                    console.log('‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω');
                    alert('–ö—ç—à –æ—á–∏—â–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                });
            }
        }

        function updateTestResults() {
            const results = document.getElementById('test-results');
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(Boolean).length;
            const percentage = Math.round((passed / total) * 100);
            
            let status = '‚ùå –ù–µ –≥–æ—Ç–æ–≤';
            if (percentage >= 80) status = '‚úÖ –ì–æ—Ç–æ–≤';
            else if (percentage >= 60) status = '‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ –≥–æ—Ç–æ–≤';
            
            results.innerHTML = `
                <h3>üìä –û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${status} (${passed}/${total} - ${percentage}%)</h3>
                <ul>
                    <li>${testResults.serviceWorker ? '‚úÖ' : '‚ùå'} Service Worker</li>
                    <li>${testResults.manifest ? '‚úÖ' : '‚ùå'} Web App Manifest</li>
                    <li>${testResults.icons ? '‚úÖ' : '‚ùå'} Icons</li>
                    <li>${testResults.installable ? '‚úÖ' : '‚ùå'} Installable</li>
                    <li>${testResults.offline ? '‚úÖ' : '‚ùå'} Offline Support</li>
                </ul>
            `;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
        window.addEventListener('load', () => {
            setTimeout(runFullTest, 1000);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–µ—Ç–∏
        window.addEventListener('online', () => {
            console.log('üåê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        });

        window.addEventListener('offline', () => {
            console.log('üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ –ø–æ—Ç–µ—Ä—è–Ω–æ');
        });

        console.log('üöÄ PWA Test Page –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    </script>
</body>
</html>