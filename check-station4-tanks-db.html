<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –ê–ó–°-004 –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1a1a1a; 
            color: #0f0; 
            padding: 20px;
            line-height: 1.4;
        }
        .section { 
            margin: 15px 0; 
            padding: 10px; 
            border: 1px solid #0f0;
            background: #0a0a0a;
        }
        h1 { color: #0ff; }
        h2 { color: #ff0; }
        .step {
            margin: 10px 0;
            padding: 8px;
            background: #001100;
            border-left: 3px solid #0f0;
        }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .success { color: #0f0; }
        pre {
            background: #000;
            padding: 10px;
            border: 1px solid #333;
            overflow-x: auto;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: #0a0a0a;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            cursor: pointer;
            font-family: monospace;
            margin: 5px;
        }
        button:hover {
            background: #001100;
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –ê–ó–°-004 (—Å–µ—Ç—å 15, —Å—Ç–∞–Ω—Ü–∏—è 4)</h1>
    
    <div class="section">
        <h2>–®–∞–≥ 1: –ü–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏</h2>
        <button onclick="findTradingPoint()">üîç –ù–∞–π—Ç–∏ —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É —Å–µ—Ç–∏ 15, —Å—Ç–∞–Ω—Ü–∏–∏ 4</button>
        <div id="tradingPointResult"></div>
    </div>

    <div class="section">
        <h2>–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —Ç–∏–ø–∞ fuel_tank</h2>
        <button onclick="checkFuelTankEquipment()">üõ¢Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤</button>
        <div id="equipmentResult"></div>
    </div>

    <div class="section">
        <h2>–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –≤ tanksService</h2>
        <button onclick="checkTanksService()">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ tanksService</button>
        <div id="tanksResult"></div>
    </div>

    <script>
        const log = (containerId, msg, type = '') => {
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = msg;
            document.getElementById(containerId).appendChild(div);
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞
        const supabaseUrl = 'https://tohtryzyffcebtyvkxwh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg3NTQ0OCwiZXhwIjoyMDcyNDUxNDQ4fQ.kN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        let foundTradingPointId = null;

        async function findTradingPoint() {
            document.getElementById('tradingPointResult').innerHTML = '';
            log('tradingPointResult', 'üîç –ò—â–µ–º —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É —Å–µ—Ç–∏ 15, —Å—Ç–∞–Ω—Ü–∏–∏ 4...', 'warning');
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–µ–º —Å–µ—Ç—å —Å external_id = 15 –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Å–æ–¥–µ—Ä–∂–∞—â–∏–º "15"
                const { data: networks, error: networksError } = await supabase
                    .from('networks')
                    .select('*')
                    .or('external_id.eq.15,external_id.eq."15",name.ilike.%15%');

                if (networksError) {
                    log('tradingPointResult', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Å–µ—Ç–µ–π: ${networksError.message}`, 'error');
                    return;
                }

                log('tradingPointResult', `üìä –ù–∞–π–¥–µ–Ω–æ —Å–µ—Ç–µ–π: ${networks.length}`, 'success');
                networks.forEach(network => {
                    log('tradingPointResult', `  –°–µ—Ç—å: ${network.name} (ID: ${network.id}, external_id: ${network.external_id})`);
                });

                if (networks.length === 0) {
                    log('tradingPointResult', '‚ùå –°–µ—Ç—å —Å ID 15 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    return;
                }

                // –¢–µ–ø–µ—Ä—å –Ω–∞–π–¥–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è —ç—Ç–∏—Ö —Å–µ—Ç–µ–π
                const networkIds = networks.map(n => n.id);
                const { data: tradingPoints, error: tpError } = await supabase
                    .from('trading_points')
                    .select('*')
                    .in('network_id', networkIds);

                if (tpError) {
                    log('tradingPointResult', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${tpError.message}`, 'error');
                    return;
                }

                log('tradingPointResult', `üìç –ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${tradingPoints.length}`, 'success');

                // –ò—â–µ–º —Ç–æ—á–∫—É —Å–æ —Å—Ç–∞–Ω—Ü–∏–µ–π 4
                const station4Points = tradingPoints.filter(tp => 
                    tp.external_id === '4' || 
                    tp.external_id === 4 || 
                    tp.name.includes('4') || 
                    tp.name.includes('–ê–ó–°-004') ||
                    tp.name.includes('–°—Ç–∞–Ω—Ü–∏—è 4')
                );

                if (station4Points.length > 0) {
                    const targetPoint = station4Points[0];
                    foundTradingPointId = targetPoint.id;
                    
                    log('tradingPointResult', `‚úÖ –ù–∞–π–¥–µ–Ω–∞ —Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ —Å—Ç–∞–Ω—Ü–∏–∏ 4:`, 'success');
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify({
                        id: targetPoint.id,
                        name: targetPoint.name,
                        external_id: targetPoint.external_id,
                        network_id: targetPoint.network_id,
                        address: targetPoint.address
                    }, null, 2);
                    document.getElementById('tradingPointResult').appendChild(pre);
                } else {
                    log('tradingPointResult', '‚ö†Ô∏è –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ —Å—Ç–∞–Ω—Ü–∏–∏ 4 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏:', 'warning');
                    tradingPoints.forEach(tp => {
                        log('tradingPointResult', `  –¢–ü: ${tp.name} (ID: ${tp.id}, external_id: ${tp.external_id})`);
                    });
                }

            } catch (error) {
                log('tradingPointResult', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function checkFuelTankEquipment() {
            document.getElementById('equipmentResult').innerHTML = '';
            
            if (!foundTradingPointId) {
                log('equipmentResult', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É', 'warning');
                return;
            }

            log('equipmentResult', `üõ¢Ô∏è –ò—â–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ fuel_tank –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ ${foundTradingPointId}...`, 'warning');
            
            try {
                const { data: equipment, error } = await supabase
                    .from('equipment')
                    .select('*')
                    .eq('trading_point_id', foundTradingPointId)
                    .eq('system_type', 'fuel_tank');

                if (error) {
                    log('equipmentResult', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');
                    return;
                }

                log('equipmentResult', `üìä –ù–∞–π–¥–µ–Ω–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è fuel_tank: ${equipment.length}`, 'success');

                if (equipment.length > 0) {
                    equipment.forEach((tank, index) => {
                        log('equipmentResult', `<br><strong>üõ¢Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä ${index + 1}:</strong>`);
                        const tankInfo = {
                            id: tank.id,
                            name: tank.name,
                            display_name: tank.display_name,
                            external_id: tank.external_id,
                            status: tank.status,
                            params: tank.params
                        };
                        
                        const pre = document.createElement('pre');
                        pre.textContent = JSON.stringify(tankInfo, null, 2);
                        document.getElementById('equipmentResult').appendChild(pre);
                    });
                    
                    log('equipmentResult', `<br>‚úÖ –ù–∞–π–¥–µ–Ω–æ ${equipment.length} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ equipment`, 'success');
                } else {
                    log('equipmentResult', '‚ùå –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã —Ç–∏–ø–∞ fuel_tank –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ equipment', 'error');
                    
                    // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ª—é–±–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
                    const { data: allEquipment } = await supabase
                        .from('equipment')
                        .select('*')
                        .eq('trading_point_id', foundTradingPointId);
                    
                    log('equipmentResult', `üìã –í—Å–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏: ${allEquipment?.length || 0}`, 'warning');
                    if (allEquipment && allEquipment.length > 0) {
                        allEquipment.forEach(eq => {
                            log('equipmentResult', `  - ${eq.name} (—Ç–∏–ø: ${eq.system_type}, —Å—Ç–∞—Ç—É—Å: ${eq.status})`);
                        });
                    }
                }

            } catch (error) {
                log('equipmentResult', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function checkTanksService() {
            document.getElementById('tanksResult').innerHTML = '';
            log('tanksResult', 'üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage –∏ —Ç–∞–Ω–∫–∞—Ö...', 'warning');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
                const tanksData = localStorage.getItem('tanks_data');
                if (tanksData) {
                    const tanks = JSON.parse(tanksData);
                    log('tanksResult', `üíæ –í localStorage –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤: ${tanks.length}`, 'success');
                    
                    const station4Tanks = tanks.filter(tank => 
                        tank.name && (
                            tank.name.includes('4') || 
                            tank.name.includes('–ê–ó–°-004') ||
                            tank.id?.includes('4')
                        )
                    );
                    
                    if (station4Tanks.length > 0) {
                        log('tanksResult', `üõ¢Ô∏è –†–µ–∑–µ—Ä–≤—É–∞—Ä—ã —Å—Ç–∞–Ω—Ü–∏–∏ 4 –≤ localStorage:`, 'success');
                        station4Tanks.forEach((tank, index) => {
                            log('tanksResult', `<br><strong>–†–µ–∑–µ—Ä–≤—É–∞—Ä ${index + 1}:</strong>`);
                            const tankInfo = {
                                id: tank.id,
                                name: tank.name,
                                fuelType: tank.fuelType,
                                currentLevelLiters: tank.currentLevelLiters,
                                capacityLiters: tank.capacityLiters,
                                status: tank.status
                            };
                            
                            const pre = document.createElement('pre');
                            pre.textContent = JSON.stringify(tankInfo, null, 2);
                            document.getElementById('tanksResult').appendChild(pre);
                        });
                    } else {
                        log('tanksResult', '‚ö†Ô∏è –í localStorage –Ω–µ—Ç —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ 4', 'warning');
                        log('tanksResult', '–í—Å–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ã –≤ localStorage:', 'warning');
                        tanks.slice(0, 3).forEach(tank => {
                            log('tanksResult', `  - ${tank.name} (ID: ${tank.id})`);
                        });
                    }
                } else {
                    log('tanksResult', '‚ùå –î–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage', 'error');
                }

                // –ü—Ä–æ–≤–µ—Ä–∏–º —Ç–∞–∫–∂–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Ç–∏
                const tradingConfig = localStorage.getItem('trading_network_config');
                if (tradingConfig) {
                    const config = JSON.parse(tradingConfig);
                    log('tanksResult', '<br>üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Ç–∏:', 'warning');
                    const configInfo = {
                        baseUrl: config.baseUrl,
                        systemId: config.systemId,
                        defaultStationId: config.defaultStationId,
                        enabled: config.enabled
                    };
                    
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(configInfo, null, 2);
                    document.getElementById('tanksResult').appendChild(pre);
                } else {
                    log('tanksResult', '‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                }

            } catch (error) {
                log('tanksResult', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            console.log('üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏...');
            findTradingPoint();
        };
    </script>
</body>
</html>