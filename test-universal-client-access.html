<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–æ–≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #2d5a2d; border-left: 4px solid #4caf50; }
        .error { background: #5a2d2d; border-left: 4px solid #f44336; }
        .warning { background: #5a5a2d; border-left: 4px solid #ff9800; }
        .info { background: #2d3a5a; border-left: 4px solid #2196f3; }
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .test-section {
            border-left: 3px solid #4caf50;
            padding-left: 15px;
            margin: 15px 0;
        }
        .config-panel {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .config-panel input, .config-panel select {
            background: #444;
            color: #fff;
            border: 1px solid #666;
            padding: 8px;
            border-radius: 3px;
            margin: 5px;
            width: 200px;
        }
        .flex-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .test-group {
            flex: 1;
            min-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞</h1>
        <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase –∏ –≤–Ω–µ—à–Ω–∏–º API —á–µ—Ä–µ–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç</p>
        
        <div class="config-panel">
            <h3>‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div class="flex-row">
                <div>
                    <label>Supabase URL:</label><br>
                    <input type="url" id="supabaseUrl" placeholder="https://your-project.supabase.co" />
                </div>
                <div>
                    <label>Supabase Key:</label><br>
                    <input type="text" id="supabaseKey" placeholder="Anon –∏–ª–∏ Service Role key" />
                </div>
                <div>
                    <label>External API URL:</label><br>
                    <input type="url" id="apiUrl" placeholder="https://pos.autooplata.ru/tms" />
                </div>
                <div>
                    <label>API Username:</label><br>
                    <input type="text" id="apiUsername" placeholder="UserApi" />
                </div>
                <div>
                    <label>API Password:</label><br>
                    <input type="password" id="apiPassword" placeholder="PasswordApi" />
                </div>
            </div>
        </div>

        <div class="flex-row">
            <div class="test-group">
                <h3>üìä –¢–µ—Å—Ç—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Supabase</h3>
                <button onclick="testSupabaseConnection()" id="testSupabaseBtn">1. –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Supabase</button>
                <button onclick="testSupabaseAuth()" id="testAuthBtn">2. –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</button>
                <button onclick="testSupabaseQuery()" id="testQueryBtn">3. –¢–µ—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ</button>
                <button onclick="testSupabaseInsert()" id="testInsertBtn">4. –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö</button>
            </div>
            
            <div class="test-group">
                <h3>üåç –¢–µ—Å—Ç—ã –≤–Ω–µ—à–Ω–∏—Ö API</h3>
                <button onclick="testExternalApiConnection()" id="testExtApiBtn">1. –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API</button>
                <button onclick="testApiAuth()" id="testApiAuthBtn">2. –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ API</button>
                <button onclick="testApiEndpoints()" id="testEndpointsBtn">3. –¢–µ—Å—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤</button>
                <button onclick="testTokenRefresh()" id="testTokenBtn">4. –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞</button>
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="runAllTests()" id="runAllBtn" style="background: #2196f3; font-size: 16px; padding: 15px 30px;">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
        </div>
    </div>

    <div id="results"></div>

    <script type="module">
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        let currentConfig = {
            supabaseUrl: 'https://your-project.supabase.co',
            supabaseKey: 'your-anon-key',
            apiUrl: 'https://pos.autooplata.ru/tms',
            apiUsername: 'UserApi',
            apiPassword: 'PasswordApi'
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'container';
            div.innerHTML = `
                <div class="test-section">
                    <h3>${title}</h3>
                    <div class="status ${type}">
                        <pre>${content}</pre>
                    </div>
                </div>
            `;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ —Ñ–æ—Ä–º—ã
        function getCurrentConfig() {
            return {
                supabaseUrl: document.getElementById('supabaseUrl').value || currentConfig.supabaseUrl,
                supabaseKey: document.getElementById('supabaseKey').value || currentConfig.supabaseKey,
                apiUrl: document.getElementById('apiUrl').value || currentConfig.apiUrl,
                apiUsername: document.getElementById('apiUsername').value || currentConfig.apiUsername,
                apiPassword: document.getElementById('apiPassword').value || currentConfig.apiPassword
            };
        }

        // –≠–º—É–ª—è—Ç–æ—Ä —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞
        class MockUniversalHttpClient {
            constructor(config) {
                this.config = config;
            }

            async request(endpoint, options = {}) {
                const {
                    method = 'GET',
                    destination = 'external-api',
                    useAuth = true,
                    queryParams = {},
                    timeout = 30000
                } = options;

                const startTime = Date.now();
                
                try {
                    let baseUrl, authHeaders = {};

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é
                    if (destination === 'supabase') {
                        baseUrl = this.config.supabaseUrl;
                        if (useAuth) {
                            authHeaders = {
                                'apikey': this.config.supabaseKey,
                                'Authorization': `Bearer ${this.config.supabaseKey}`,
                                'Content-Type': 'application/json'
                            };
                        }
                    } else if (destination === 'external-api') {
                        baseUrl = this.config.apiUrl;
                        if (useAuth) {
                            const credentials = btoa(`${this.config.apiUsername}:${this.config.apiPassword}`);
                            authHeaders = {
                                'Authorization': `Basic ${credentials}`,
                                'Content-Type': 'application/json'
                            };
                        }
                    }

                    // –°—Ç—Ä–æ–∏–º –ø–æ–ª–Ω—ã–π URL
                    const url = new URL(endpoint.startsWith('http') ? endpoint : `${baseUrl}${endpoint}`);
                    Object.entries(queryParams).forEach(([key, value]) => {
                        if (value !== undefined && value !== null) {
                            url.searchParams.append(key, String(value));
                        }
                    });

                    // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
                    const headers = {
                        'Accept': 'application/json',
                        ...authHeaders,
                        ...(options.headers || {})
                    };

                    console.log(`üåê Mock HTTP ${method} ${url.toString()}`);
                    console.log('üìã Headers:', headers);

                    // –≠–º—É–ª–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
                    const mockResponse = await this.mockFetch(url.toString(), {
                        method,
                        headers,
                        body: options.body ? JSON.stringify(options.body) : undefined
                    });

                    const responseTime = Date.now() - startTime;

                    return {
                        success: mockResponse.ok,
                        data: mockResponse.data,
                        status: mockResponse.status,
                        responseTime,
                        error: mockResponse.ok ? undefined : mockResponse.error
                    };

                } catch (error) {
                    const responseTime = Date.now() - startTime;
                    return {
                        success: false,
                        error: error.message,
                        responseTime
                    };
                }
            }

            async get(endpoint, options = {}) {
                return this.request(endpoint, { ...options, method: 'GET' });
            }

            async post(endpoint, body, options = {}) {
                return this.request(endpoint, { ...options, method: 'POST', body });
            }

            // –≠–º—É–ª—è—Ç–æ—Ä fetch —Å –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
            async mockFetch(url, options) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
                await new Promise(resolve => setTimeout(resolve, Math.random() * 500 + 200));

                const urlObj = new URL(url);
                
                // –≠–º—É–ª—è—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ Supabase
                if (urlObj.hostname.includes('supabase')) {
                    if (urlObj.pathname.includes('/rest/v1/networks')) {
                        return {
                            ok: true,
                            status: 200,
                            data: [
                                { id: '1', name: '–î–µ–º–æ —Å–µ—Ç—å', external_id: '1', status: 'active' },
                                { id: '2', name: '–¢–µ—Å—Ç–æ–≤–∞—è —Å–µ—Ç—å', external_id: '2', status: 'active' }
                            ]
                        };
                    }
                    if (urlObj.pathname.includes('/rest/v1/system_config')) {
                        return {
                            ok: true,
                            status: 200,
                            data: [
                                { config_key: 'database_connections', config_type: 'database' },
                                { config_key: 'trading_network_integration', config_type: 'api' }
                            ]
                        };
                    }
                    if (options.method === 'POST') {
                        return {
                            ok: true,
                            status: 201,
                            data: { id: 'test-' + Date.now(), message: '–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ' }
                        };
                    }
                    
                    // –ò–º–∏—Ç–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∫–ª—é—á–µ
                    if (!options.headers?.Authorization || options.headers.Authorization.includes('your-anon-key')) {
                        return {
                            ok: false,
                            status: 401,
                            error: 'Invalid API key'
                        };
                    }
                    
                    return { ok: true, status: 200, data: { message: 'Supabase connection OK' } };
                }
                
                // –≠–º—É–ª—è—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ API
                if (urlObj.hostname.includes('autooplata.ru') || urlObj.hostname.includes('pos.')) {
                    // –ò–º–∏—Ç–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    if (!options.headers?.Authorization || options.headers.Authorization === 'Basic VXNlckFwaTpQYXNzd29yZEFwaQ==') {
                        if (urlObj.pathname.includes('/tanks')) {
                            return {
                                ok: true,
                                status: 200,
                                data: [
                                    { id: 1, name: '–†–µ–∑–µ—Ä–≤—É–∞—Ä –ê–ò-92', capacity: 50000, volume: 35000 },
                                    { id: 2, name: '–†–µ–∑–µ—Ä–≤—É–∞—Ä –ê–ò-95', capacity: 50000, volume: 42000 },
                                    { id: 3, name: '–†–µ–∑–µ—Ä–≤—É–∞—Ä –î–¢', capacity: 50000, volume: 28000 }
                                ]
                            };
                        }
                        if (urlObj.pathname.includes('/transactions')) {
                            return {
                                ok: true,
                                status: 200,
                                data: [
                                    { id: 1, fuel_type: '–ê–ò-92', amount: 25.5, price: 45.90, timestamp: new Date().toISOString() },
                                    { id: 2, fuel_type: '–ê–ò-95', amount: 30.0, price: 48.50, timestamp: new Date().toISOString() }
                                ]
                            };
                        }
                        if (urlObj.pathname.includes('/auth')) {
                            return {
                                ok: true,
                                status: 200,
                                data: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJhcGkiLCJhdWQiOiJjbGllbnQiLCJpYXQiOjE2ODc1ODc2MDAsImV4cCI6MTY4NzU5MTIwMH0.example_token'
                            };
                        }
                        return { ok: true, status: 200, data: { message: 'External API connection OK' } };
                    } else {
                        return {
                            ok: false,
                            status: 403,
                            error: 'Invalid credentials'
                        };
                    }
                }

                // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ö–æ—Å—Ç
                return {
                    ok: false,
                    status: 404,
                    error: 'Not Found'
                };
            }
        }

        // === –¢–ï–°–¢–´ SUPABASE ===

        window.testSupabaseConnection = async function() {
            try {
                addResult('üîÑ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
                
                const config = getCurrentConfig();
                const client = new MockUniversalHttpClient(config);

                const response = await client.get('/rest/v1/', {
                    destination: 'supabase',
                    useAuth: false
                });

                if (response.success) {
                    addResult('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase', 
                        `–°—Ç–∞—Ç—É—Å: ${response.status}\n` +
                        `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${response.responseTime}–º—Å\n` +
                        `URL: ${config.supabaseUrl}`, 'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase', 
                        `–°—Ç–∞—Ç—É—Å: ${response.status}\n` +
                        `–û—à–∏–±–∫–∞: ${response.error}`, 'error');
                }
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase', error.message, 'error');
            }
        };

        window.testSupabaseAuth = async function() {
            try {
                addResult('üîê –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Supabase', '–ü—Ä–æ–≤–µ—Ä—è–µ–º API –∫–ª—é—á–∏...', 'info');
                
                const config = getCurrentConfig();
                const client = new MockUniversalHttpClient(config);

                const response = await client.get('/rest/v1/system_config', {
                    destination: 'supabase',
                    useAuth: true,
                    queryParams: { limit: 1 }
                });

                if (response.success) {
                    addResult('‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Supabase', 
                        `API –∫–ª—é—á –≤–∞–ª–∏–¥–Ω—ã–π\n` +
                        `–î–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º: OK\n` +
                        `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${response.responseTime}–º—Å`, 'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Supabase', 
                        `–°—Ç–∞—Ç—É—Å: ${response.status}\n` +
                        `–û—à–∏–±–∫–∞: ${response.error}\n` +
                        `–ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö`, 'error');
                }
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏', error.message, 'error');
            }
        };

        window.testSupabaseQuery = async function() {
            try {
                addResult('üìä –¢–µ—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ Supabase', '–í—ã–ø–æ–ª–Ω—è–µ–º SELECT –∑–∞–ø—Ä–æ—Å...', 'info');
                
                const config = getCurrentConfig();
                const client = new MockUniversalHttpClient(config);

                const response = await client.get('/rest/v1/networks', {
                    destination: 'supabase',
                    useAuth: true,
                    queryParams: {
                        select: 'id,name,external_id,status',
                        limit: 5
                    }
                });

                if (response.success) {
                    addResult('‚úÖ –ó–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ networks', 
                        `–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${response.data?.length || 0}\n` +
                        `–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:\n${JSON.stringify(response.data?.[0] || {}, null, 2)}\n` +
                        `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${response.responseTime}–º—Å`, 'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ', 
                        `–°—Ç–∞—Ç—É—Å: ${response.status}\n` +
                        `–û—à–∏–±–∫–∞: ${response.error}`, 'error');
                }
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞', error.message, 'error');
            }
        };

        window.testSupabaseInsert = async function() {
            try {
                addResult('‚úèÔ∏è –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –≤ Supabase', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∑–∞–ø–∏—Å–∏...', 'info');
                
                const config = getCurrentConfig();
                const client = new MockUniversalHttpClient(config);

                const testData = {
                    name: '–¢–ï–°–¢ - –£–¥–∞–ª–∏—Ç—å',
                    external_id: 'test-' + Date.now(),
                    description: '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å –æ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞',
                    status: 'active'
                };

                const response = await client.post('/rest/v1/networks', testData, {
                    destination: 'supabase',
                    useAuth: true
                });

                if (response.success) {
                    addResult('‚úÖ –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –≤ Supabase', 
                        `–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ\n` +
                        `ID: ${response.data?.id}\n` +
                        `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${response.responseTime}–º—Å\n` +
                        `‚ö†Ô∏è –í —Ä–µ–∞–ª—å–Ω–æ–π –ë–î —É–¥–∞–ª–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å`, 'success');
                } else {
                    if (response.status === 403 || response.status === 401) {
                        addResult('‚ö†Ô∏è –ù–µ—Ç –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏ –≤ Supabase', 
                            `–°—Ç–∞—Ç—É—Å: ${response.status}\n` +
                            `–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è anon –∫–ª—é—á\n` +
                            `–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω—É–∂–µ–Ω service_role –∫–ª—é—á`, 'warning');
                    } else {
                        addResult('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ Supabase', 
                            `–°—Ç–∞—Ç—É—Å: ${response.status}\n` +
                            `–û—à–∏–±–∫–∞: ${response.error}`, 'error');
                    }
                }
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏', error.message, 'error');
            }
        };

        // === –¢–ï–°–¢–´ –í–ù–ï–®–ù–ò–• API ===

        window.testExternalApiConnection = async function() {
            try {
                addResult('üåç –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–Ω–µ—à–Ω–µ–º—É API', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞...', 'info');
                
                const config = getCurrentConfig();
                const client = new MockUniversalHttpClient(config);

                const response = await client.get('/', {
                    destination: 'external-api',
                    useAuth: false
                });

                if (response.success) {
                    addResult('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–Ω–µ—à–Ω–µ–º—É API', 
                        `–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω\n` +
                        `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${response.responseTime}–º—Å\n` +
                        `URL: ${config.apiUrl}`, 'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API', 
                        `–°—Ç–∞—Ç—É—Å: ${response.status}\n` +
                        `–û—à–∏–±–∫–∞: ${response.error}\n` +
                        `–ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö`, 'error');
                }
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API', error.message, 'error');
            }
        };

        window.testApiAuth = async function() {
            try {
                addResult('üîê –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–Ω–µ—à–Ω–µ–≥–æ API', '–ü—Ä–æ–≤–µ—Ä—è–µ–º —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...', 'info');
                
                const config = getCurrentConfig();
                const client = new MockUniversalHttpClient(config);

                const response = await client.get('/tanks', {
                    destination: 'external-api',
                    useAuth: true,
                    queryParams: {
                        system: '1',
                        station: '1'
                    }
                });

                if (response.success) {
                    addResult('‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ API', 
                        `–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã\n` +
                        `–õ–æ–≥–∏–Ω: ${config.apiUsername}\n` +
                        `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${response.responseTime}–º—Å`, 'success');
                } else {
                    if (response.status === 403 || response.status === 401) {
                        addResult('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ API', 
                            `–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n` +
                            `–õ–æ–≥–∏–Ω: ${config.apiUsername}\n` +
                            `–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö`, 'error');
                    } else {
                        addResult('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ API', 
                            `–°—Ç–∞—Ç—É—Å: ${response.status}\n` +
                            `–û—à–∏–±–∫–∞: ${response.error}`, 'error');
                    }
                }
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ API', error.message, 'error');
            }
        };

        window.testApiEndpoints = async function() {
            try {
                addResult('üõ¢Ô∏è –¢–µ—Å—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ API', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã...', 'info');
                
                const config = getCurrentConfig();
                const client = new MockUniversalHttpClient(config);

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤
                const tanksResponse = await client.get('/tanks', {
                    destination: 'external-api',
                    useAuth: true,
                    queryParams: {
                        system: '1',
                        station: '4'
                    }
                });

                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
                const transactionsResponse = await client.get('/transactions', {
                    destination: 'external-api',
                    useAuth: true,
                    queryParams: {
                        system: '1',
                        station: '4',
                        shift: '6'
                    }
                });

                let results = [];
                
                if (tanksResponse.success) {
                    results.push(`‚úÖ /tanks: ${tanksResponse.data?.length || 0} —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–æ–≤`);
                } else {
                    results.push(`‚ùå /tanks: ${tanksResponse.error}`);
                }

                if (transactionsResponse.success) {
                    results.push(`‚úÖ /transactions: ${transactionsResponse.data?.length || 0} –æ–ø–µ—Ä–∞—Ü–∏–π`);
                } else {
                    results.push(`‚ùå /transactions: ${transactionsResponse.error}`);
                }

                const allSuccess = tanksResponse.success && transactionsResponse.success;
                
                addResult(allSuccess ? '‚úÖ –¢–µ—Å—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ API' : '‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ API', 
                    results.join('\n') + `\n\n–í—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${Date.now()}`, 
                    allSuccess ? 'success' : 'warning');

            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤', error.message, 'error');
            }
        };

        window.testTokenRefresh = async function() {
            try {
                addResult('üîÑ –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ö–∞–Ω–∏–∑–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤...', 'info');
                
                const config = getCurrentConfig();
                const client = new MockUniversalHttpClient(config);

                // –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
                const authResponse = await client.post('/auth', null, {
                    destination: 'external-api',
                    useAuth: true
                });

                if (authResponse.success) {
                    const token = authResponse.data;
                    
                    addResult('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞', 
                        `–ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω\n` +
                        `–¢–∏–ø: JWT Bearer\n` +
                        `–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: ${typeof token === 'string' ? token.substring(0, 50) + '...' : 'Binary token'}\n` +
                        `–í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è: ${authResponse.responseTime}–º—Å`, 'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞', 
                        `–°—Ç–∞—Ç—É—Å: ${authResponse.status}\n` +
                        `–û—à–∏–±–∫–∞: ${authResponse.error}\n` +
                        `–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏`, 'error');
                }
            } catch (error) {
                addResult('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞', error.message, 'error');
            }
        };

        // === –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –¢–ï–°–¢ ===

        window.runAllTests = async function() {
            try {
                addResult('üöÄ –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞', '–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤...', 'info');
                
                const config = getCurrentConfig();
                addResult('üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 
                    `Supabase URL: ${config.supabaseUrl}\n` +
                    `API URL: ${config.apiUrl}\n` +
                    `API Username: ${config.apiUsername}\n` +
                    `–ö–ª—é—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã: ${config.supabaseKey ? '–î–∞' : '–ù–µ—Ç'}`, 'info');

                // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã
                console.log('üîÑ Running Supabase tests...');
                await testSupabaseConnection();
                await new Promise(r => setTimeout(r, 500));
                
                await testSupabaseAuth();
                await new Promise(r => setTimeout(r, 500));
                
                await testSupabaseQuery();
                await new Promise(r => setTimeout(r, 500));
                
                await testSupabaseInsert();
                await new Promise(r => setTimeout(r, 1000));

                console.log('üîÑ Running External API tests...');
                await testExternalApiConnection();
                await new Promise(r => setTimeout(r, 500));
                
                await testApiAuth();
                await new Promise(r => setTimeout(r, 500));
                
                await testApiEndpoints();
                await new Promise(r => setTimeout(r, 500));
                
                await testTokenRefresh();

                addResult('üéâ –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω', 
                    '–í—Å–µ —Ç–µ—Å—Ç—ã —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.\n' +
                    '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—à–µ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º.\n\n' +
                    'üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n' +
                    '‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL –∏ –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞\n' +
                    '‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Supabase –ø—Ä–æ–µ–∫—Ç –∞–∫—Ç–∏–≤–µ–Ω\n' +
                    '‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–∞–º\n' +
                    '‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API\n' +
                    '‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞', 'success');

            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞', error.message, 'error');
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            document.getElementById('supabaseUrl').value = currentConfig.supabaseUrl;
            document.getElementById('supabaseKey').value = 'your-anon-key';
            document.getElementById('apiUrl').value = currentConfig.apiUrl;
            document.getElementById('apiUsername').value = currentConfig.apiUsername;
            document.getElementById('apiPassword').value = currentConfig.apiPassword;

            addResult('üîß –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ HTTP –∫–ª–∏–µ–Ω—Ç–∞', 
                '–ì–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤—ã—à–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã.\n\n' +
                'üéØ –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:\n' +
                '‚Ä¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase\n' +
                '‚Ä¢ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ API –∫–ª—é—á–∏\n' +
                '‚Ä¢ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏\n' +
                '‚Ä¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–Ω–µ—à–Ω–∏–º API\n' +
                '‚Ä¢ Basic Auth –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é\n' +
                '‚Ä¢ Bearer —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\n' +
                '‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤', 'info');
        });
    </script>
</body>
</html>