<!DOCTYPE html>
<html>
<head>
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–∏ 4</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; background: #1e293b; color: white; padding: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: #374151; padding: 20px; border-radius: 8px; margin: 15px 0; }
        .debug { background: #0f172a; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; overflow-x: auto; }
        button { background: #3b82f6; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px; }
        button:hover { background: #2563eb; }
        .success { background: #10b981; color: white; padding: 10px; border-radius: 6px; margin: 10px 0; }
        .error { background: #dc2626; color: white; padding: 10px; border-radius: 6px; margin: 10px 0; }
        .warning { background: #f59e0b; color: black; padding: 10px; border-radius: 6px; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 12px; border: 1px solid #4b5563; text-align: left; }
        th { background: #4b5563; }
        tr:nth-child(even) { background: #374151; }
        .metric { display: inline-block; background: #4b5563; padding: 15px; margin: 10px; border-radius: 8px; text-align: center; min-width: 120px; }
        .metric-label { display: block; font-size: 12px; color: #9ca3af; margin-bottom: 5px; }
        .metric-value { display: block; font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–∏ 4 (–°–µ—Ç—å 15)</h1>
        
        <div class="section">
            <h3>üìã –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</h3>
            <div class="debug">
UUID —Å—Ç–∞–Ω—Ü–∏–∏ 4: 6969b08d-1cbe-45c2-ae9c-8002c7022b59
UUID —Å–µ—Ç–∏ 15:   b5e25b51-a950-481e-a09d-ac25e6b5d6ab
–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ç–∏:  "–ù–æ—Ä–¥ –õ–∞–π–Ω"
–ö–æ–¥ —Å—Ç–∞–Ω—Ü–∏–∏:    4
            </div>
        </div>

        <div class="section">
            <h3>üß™ –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</h3>
            <button onclick="testSupabaseConnection()">üîå –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase</button>
            <button onclick="testStation4Operations()">üéØ –¢–µ—Å—Ç 2: –û–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞–Ω—Ü–∏–∏ 4 –Ω–∞–ø—Ä—è–º—É—é</button>
            <button onclick="testNetwork15TradingPoints()">üè™ –¢–µ—Å—Ç 3: –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ —Å–µ—Ç–∏ 15</button>
            <button onclick="testFilteringLogic()">üîç –¢–µ—Å—Ç 4: –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</button>
            <button onclick="runAllTests()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
            <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div id="results"></div>
    </div>

    <script type="module">
        const STATION_4_UUID = '6969b08d-1cbe-45c2-ae9c-8002c7022b59';
        const NETWORK_15_UUID = 'b5e25b51-a950-481e-a09d-ac25e6b5d6ab';
        
        let supabaseClient;
        let operationsService;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞
        async function initializeServices() {
            try {
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                const supabaseUrl = 'https://dlvggjmirqhmdylfwngm.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsdmdnam1pcnFobWR5bGZ3bmdtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczNTY5Njg2NSwiZXhwIjoyMDUxMjcyODY1fQ.SLOvfECCNMeWX-V7Hl4mjfyDGfTLUmLF9GCn3R3NfAY'; // service_role key
                
                supabaseClient = createClient(supabaseUrl, supabaseKey);
                
                console.log('‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', error);
                return false;
            }
        }

        window.testSupabaseConnection = async function() {
            const results = document.getElementById('results');
            addResult('üîå –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase...', 'info');

            try {
                if (!supabaseClient) {
                    const initialized = await initializeServices();
                    if (!initialized) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Supabase –∫–ª–∏–µ–Ω—Ç');
                    }
                }

                // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                const { data, error } = await supabaseClient
                    .from('operations')
                    .select('count')
                    .limit(1);

                if (error) throw error;

                addResult('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ', 'success');
                addResult(`üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞`, 'success');
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        window.testStation4Operations = async function() {
            addResult('üéØ –ü–æ–∏—Å–∫ –æ–ø–µ—Ä–∞—Ü–∏–π —Å—Ç–∞–Ω—Ü–∏–∏ 4...', 'info');

            try {
                if (!supabaseClient) await initializeServices();

                // –ü–æ–ª—É—á–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ 4
                const { data, error } = await supabaseClient
                    .from('operations')
                    .select('*')
                    .eq('trading_point_id', STATION_4_UUID)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const operationsCount = data?.length || 0;
                
                if (operationsCount === 0) {
                    addResult('‚ö†Ô∏è –û–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ 4 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
                    addResult(`üîç UUID —Å—Ç–∞–Ω—Ü–∏–∏: ${STATION_4_UUID}`, 'info');
                } else {
                    addResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ 4: ${operationsCount}`, 'success');
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
                    const totalRevenue = data.reduce((sum, op) => sum + (op.total_cost || 0), 0);
                    const totalFuel = data.reduce((sum, op) => sum + (op.quantity || 0), 0);
                    const avgTicket = operationsCount > 0 ? totalRevenue / operationsCount : 0;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
                    const metricsHtml = `
                        <div class="section">
                            <h4>üìä –ú–µ—Ç—Ä–∏–∫–∏ —Å—Ç–∞–Ω—Ü–∏–∏ 4:</h4>
                            <div class="metric">
                                <span class="metric-label">–û–ø–µ—Ä–∞—Ü–∏–π</span>
                                <span class="metric-value">${operationsCount}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">–í—ã—Ä—É—á–∫–∞</span>
                                <span class="metric-value">${totalRevenue.toLocaleString('ru-RU')} ‚ÇΩ</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">–¢–æ–ø–ª–∏–≤–æ</span>
                                <span class="metric-value">${totalFuel.toLocaleString('ru-RU')} –ª</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</span>
                                <span class="metric-value">${avgTicket.toLocaleString('ru-RU')} ‚ÇΩ</span>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('results').innerHTML += metricsHtml;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã –æ–ø–µ—Ä–∞—Ü–∏–π
                    const samplesTable = `
                        <div class="section">
                            <h4>üßæ –ü—Ä–∏–º–µ—Ä—ã –æ–ø–µ—Ä–∞—Ü–∏–π:</h4>
                            <table>
                                <tr>
                                    <th>ID</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–õ–∏—Ç—Ä—ã</th>
                                    <th>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</th>
                                    <th>–¢–æ–ø–ª–∏–≤–æ</th>
                                </tr>
                                ${data.slice(0, 5).map(op => `
                                    <tr>
                                        <td>${op.id}</td>
                                        <td>${new Date(op.created_at).toLocaleDateString('ru-RU')}</td>
                                        <td>${(op.total_cost || 0).toLocaleString('ru-RU')} ‚ÇΩ</td>
                                        <td>${(op.quantity || 0).toLocaleString('ru-RU')} –ª</td>
                                        <td>${op.payment_method || 'N/A'}</td>
                                        <td>${op.fuel_type || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </table>
                        </div>
                    `;
                    
                    document.getElementById('results').innerHTML += samplesTable;
                }
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π: ${error.message}`, 'error');
            }
        }

        window.testNetwork15TradingPoints = async function() {
            addResult('üè™ –ü–æ–∏—Å–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ —Å–µ—Ç–∏ 15...', 'info');

            try {
                if (!supabaseClient) await initializeServices();

                // –ü–æ–ª—É—á–∞–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ —Å–µ—Ç–∏ 15
                const { data, error } = await supabaseClient
                    .from('trading_points')
                    .select('*')
                    .eq('network_id', NETWORK_15_UUID);

                if (error) throw error;

                const pointsCount = data?.length || 0;
                
                if (pointsCount === 0) {
                    addResult('‚ö†Ô∏è –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ —Å–µ—Ç–∏ 15 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
                } else {
                    addResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤ —Å–µ—Ç–∏ 15: ${pointsCount}`, 'success');
                    
                    // –ò—â–µ–º —Å—Ç–∞–Ω—Ü–∏—é 4
                    const station4 = data.find(tp => tp.id === STATION_4_UUID);
                    
                    if (station4) {
                        addResult(`‚úÖ –°—Ç–∞–Ω—Ü–∏—è 4 –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–µ—Ç–∏ 15`, 'success');
                        addResult(`üìç –ù–∞–∑–≤–∞–Ω–∏–µ: ${station4.name || 'N/A'}`, 'info');
                        addResult(`üéØ UUID: ${station4.id}`, 'info');
                    } else {
                        addResult('‚ö†Ô∏è –°—Ç–∞–Ω—Ü–∏—è 4 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–µ—Ç–∏ 15', 'warning');
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ —Å–µ—Ç–∏
                    const pointsTable = `
                        <div class="section">
                            <h4>üè™ –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ —Å–µ—Ç–∏ 15:</h4>
                            <table>
                                <tr>
                                    <th>UUID</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–ö–æ–¥ —Å—Ç–∞–Ω—Ü–∏–∏</th>
                                    <th>–ê–¥—Ä–µ—Å</th>
                                </tr>
                                ${data.map(tp => `
                                    <tr${tp.id === STATION_4_UUID ? ' style="background: #10b981; color: white;"' : ''}>
                                        <td>${tp.id}</td>
                                        <td>${tp.name || 'N/A'}</td>
                                        <td>${tp.station_code || 'N/A'}</td>
                                        <td>${tp.address || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </table>
                        </div>
                    `;
                    
                    document.getElementById('results').innerHTML += pointsTable;
                }
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${error.message}`, 'error');
            }
        }

        window.testFilteringLogic = async function() {
            addResult('üîç –¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏...', 'info');

            try {
                if (!supabaseClient) await initializeServices();

                // –¢–µ—Å—Ç 1: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                const { data: allOps, error: allError } = await supabaseClient
                    .from('operations')
                    .select('trading_point_id, total_cost')
                    .eq('status', 'completed');

                if (allError) throw allError;

                // –¢–µ—Å—Ç 2: –û–ø–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ —Å—Ç–∞–Ω—Ü–∏–∏ 4
                const { data: station4Ops, error: station4Error } = await supabaseClient
                    .from('operations')
                    .select('trading_point_id, total_cost')
                    .eq('status', 'completed')
                    .eq('trading_point_id', STATION_4_UUID);

                if (station4Error) throw station4Error;

                const allOperationsCount = allOps?.length || 0;
                const station4OperationsCount = station4Ops?.length || 0;
                
                const allRevenue = allOps?.reduce((sum, op) => sum + (op.total_cost || 0), 0) || 0;
                const station4Revenue = station4Ops?.reduce((sum, op) => sum + (op.total_cost || 0), 0) || 0;

                addResult(`üìä –í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ: ${allOperationsCount}`, 'info');
                addResult(`üéØ –û–ø–µ—Ä–∞—Ü–∏–π —Å—Ç–∞–Ω—Ü–∏–∏ 4: ${station4OperationsCount}`, 'info');
                addResult(`üí∞ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ —Å–∏—Å—Ç–µ–º—ã: ${allRevenue.toLocaleString('ru-RU')} ‚ÇΩ`, 'info');
                addResult(`üí∞ –í—ã—Ä—É—á–∫–∞ —Å—Ç–∞–Ω—Ü–∏–∏ 4: ${station4Revenue.toLocaleString('ru-RU')} ‚ÇΩ`, 'info');

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                if (station4OperationsCount > 0 && station4OperationsCount < allOperationsCount) {
                    addResult('‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'success');
                    addResult(`üî¢ –°—Ç–∞–Ω—Ü–∏—è 4 —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${((station4OperationsCount / allOperationsCount) * 100).toFixed(1)}% –æ—Ç –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π`, 'success');
                } else if (station4OperationsCount === 0) {
                    addResult('‚ö†Ô∏è –û–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏ 4 –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'warning');
                } else if (station4OperationsCount === allOperationsCount) {
                    addResult('‚ùå –ü–†–û–ë–õ–ï–ú–ê: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏!', 'error');
                }
                
                // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –≤ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —Å—Ç–∞–Ω—Ü–∏–∏ 4
                const uniquePoints = [...new Set(station4Ops?.map(op => op.trading_point_id).filter(Boolean))];
                addResult(`üè™ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –≤ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö: ${uniquePoints.length}`, 'info');
                
                if (uniquePoints.length === 1 && uniquePoints[0] === STATION_4_UUID) {
                    addResult('‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç —Å—Ç–∞–Ω—Ü–∏–∏ 4', 'success');
                } else {
                    addResult(`‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ù–∞–π–¥–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥—Ä—É–≥–∏—Ö —Å—Ç–∞–Ω—Ü–∏–π: ${uniquePoints.filter(id => id !== STATION_4_UUID).join(', ')}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }

        window.runAllTests = async function() {
            clearResults();
            addResult('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —Ç–µ—Å—Ç–æ–≤...', 'info');
            
            await testSupabaseConnection();
            await testStation4Operations();
            await testNetwork15TradingPoints();
            await testFilteringLogic();
            
            addResult('‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã', 'success');
        }

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(message);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', async function() {
            console.log('üî¨ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            addResult('üìã –ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–∏ 4', 'info');
        });
    </script>
</body>
</html>