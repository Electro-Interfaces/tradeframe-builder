<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Password Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ddd; background: #f8f9fa; }
        button { margin: 5px; padding: 10px; }
        pre { background: #e9ecef; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>–ü—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π</h1>

    <h2>‚ùå –ü—Ä–æ–±–ª–µ–º–∞: Web Crypto API —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–µ–Ω!</h2>
    <div class="result">
        <p><strong>–¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞:</strong> –ü–∞—Ä–æ–ª—å ‚Üí PBKDF2 (100,000 –∏—Ç–µ—Ä–∞—Ü–∏–π) ‚Üí SHA-256 ‚Üí Base64</p>
        <p><strong>–ü—Ä–æ–±–ª–µ–º—ã:</strong></p>
        <ul>
            <li>–¢—Ä–µ–±—É–µ—Ç HTTPS (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ localhost HTTP)</li>
            <li>–ú–µ–¥–ª–µ–Ω–Ω–æ (100,000 –∏—Ç–µ—Ä–∞—Ü–∏–π)</li>
            <li>–°–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å</li>
            <li>–ú–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö</li>
        </ul>
    </div>

    <h2>‚úÖ –ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ: SHA-256 –Ω–∞–ø—Ä—è–º—É—é</h2>
    <div>
        <input type="text" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" value="qwerty">
        <button onclick="testSimpleHash()">–ü—Ä–æ—Å—Ç–æ–π —Ö–µ—à (SHA-256)</button>
        <button onclick="testCurrentHash()">–¢–µ–∫—É—â–∏–π –º–µ—Ç–æ–¥ (PBKDF2)</button>
    </div>

    <h2>üî® –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
    <div>
        <input type="email" id="newEmail" placeholder="Email" value="test@simple.com">
        <input type="text" id="newPassword" placeholder="–ü–∞—Ä–æ–ª—å" value="123456">
        <button onclick="createSimpleUser()">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–æ—Å—Ç—ã–º —Ö–µ—à–µ–º</button>
    </div>

    <div id="results"></div>

    <script>
        // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è SHA-256 (–±–µ–∑ Web Crypto API)
        async function simpleHash(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);

            // –ï—Å–ª–∏ Web Crypto –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if (crypto && crypto.subtle) {
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } else {
                // Fallback - –ø—Ä–æ—Å—Ç–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
                return btoa(text);
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–π —Å–æ–ª–∏
        function generateSimpleSalt() {
            return Math.random().toString(36).substring(2, 15);
        }

        // Web Crypto PBKDF2 (—Ç–µ–∫—É—â–∏–π –º–µ—Ç–æ–¥)
        async function pbkdf2Hash(password, salt) {
            try {
                if (!crypto || !crypto.subtle) {
                    return "Web Crypto API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω";
                }

                const encoder = new TextEncoder();
                const passwordBytes = encoder.encode(password);
                const saltBytes = encoder.encode(atob(salt)); // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64 —Å–æ–ª—å

                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    passwordBytes,
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits']
                );

                const hashBuffer = await crypto.subtle.deriveBits(
                    {
                        name: 'PBKDF2',
                        salt: saltBytes,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    32 * 8
                );

                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return btoa(String.fromCharCode(...hashArray));
            } catch (error) {
                return `–û—à–∏–±–∫–∞ PBKDF2: ${error.message}`;
            }
        }

        function addResult(title, content) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'result';
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            results.appendChild(div);
        }

        async function testSimpleHash() {
            const password = document.getElementById('password').value;
            const salt = generateSimpleSalt();
            const hash = await simpleHash(password + salt);

            addResult('–ü—Ä–æ—Å—Ç–æ–π —Ö–µ—à', JSON.stringify({
                password: password,
                salt: salt,
                hash: hash,
                method: 'SHA-256 –∏–ª–∏ Base64',
                fast: true,
                works_everywhere: true
            }, null, 2));
        }

        async function testCurrentHash() {
            const password = document.getElementById('password').value;
            const salt = btoa(generateSimpleSalt()); // Base64 —Å–æ–ª—å –∫–∞–∫ –≤ –ë–î
            const hash = await pbkdf2Hash(password, salt);

            addResult('–¢–µ–∫—É—â–∏–π –º–µ—Ç–æ–¥ (PBKDF2)', JSON.stringify({
                password: password,
                salt: salt,
                hash: hash,
                method: 'PBKDF2 + SHA-256 + 100k –∏—Ç–µ—Ä–∞—Ü–∏–π',
                fast: false,
                works_everywhere: false,
                requires_https: true
            }, null, 2));
        }

        async function createSimpleUser() {
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;

            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const salt = generateSimpleSalt();
            const hash = await simpleHash(password + salt);

            const userData = {
                email: email,
                name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                status: 'active',
                pwd_salt: btoa(salt), // –ö–æ–¥–∏—Ä—É–µ–º –≤ base64 –∫–∞–∫ –≤ –ë–î
                pwd_hash: hash,
                preferences: {}
            };

            addResult('–ù–æ–≤—ã–π –ø—Ä–æ—Å—Ç–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', JSON.stringify(userData, null, 2));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º SQL –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
            const sql = `INSERT INTO users (id, tenant_id, email, name, status, pwd_salt, pwd_hash, preferences)
VALUES (
    gen_random_uuid(),
    '00000000-0000-0000-0000-000000000001',
    '${email}',
    '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
    'active',
    '${userData.pwd_salt}',
    '${userData.pwd_hash}',
    '{}'
);`;

            addResult('SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', sql);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏
        window.addEventListener('load', () => {
            addResult('–°—Ç–∞—Ç—É—Å Web Crypto API', JSON.stringify({
                protocol: window.location.protocol,
                isSecure: window.isSecureContext,
                crypto_available: !!crypto,
                subtle_available: !!(crypto && crypto.subtle),
                recommendation: crypto && crypto.subtle ?
                    'Web Crypto —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å–ª–æ–∂–µ–Ω' :
                    'Web Crypto –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç - –Ω—É–∂–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞'
            }, null, 2));
        });
    </script>
</body>
</html>