<!DOCTYPE html>
<html>
<head>
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π</h1>
    
    <div>
        <button onclick="checkOperationsTradingPoints()">1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π</button>
        <button onclick="checkAllTradingPoints()">2Ô∏è‚É£ –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫</button>
        <button onclick="checkOperationsWithoutFilter()">3Ô∏è‚É£ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞</button>
    </div>
    
    <div id="logs"></div>
    <div id="results"></div>

    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            logsDiv.appendChild(logEntry);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function checkOperationsTradingPoints() {
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –∫–∞–∫–∏—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–∫–∞—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏...', 'info');
            
            try {
                const response = await fetch('/supabase-proxy/rest/v1/operations?select=trading_point_id&order=start_time.desc', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const operations = await response.json();
                log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –ë–î: ${operations.length}`, 'success');
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–æ—Ä–≥–æ–≤—ã–º —Ç–æ—á–∫–∞–º
                const tradingPointGroups = {};
                operations.forEach(op => {
                    const tpId = op.trading_point_id;
                    if (!tradingPointGroups[tpId]) {
                        tradingPointGroups[tpId] = 0;
                    }
                    tradingPointGroups[tpId]++;
                });
                
                log('üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ —Ç–æ—Ä–≥–æ–≤—ã–º —Ç–æ—á–∫–∞–º:', 'info');
                Object.entries(tradingPointGroups).forEach(([tpId, count]) => {
                    log(`   ${tpId}: ${count} –æ–ø–µ—Ä–∞—Ü–∏–π`, 'info');
                });
                
                const resultsDiv = document.getElementById('results');
                let html = '<h3>üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ —Ç–æ—Ä–≥–æ–≤—ã–º —Ç–æ—á–∫–∞–º</h3><table>';
                html += '<tr><th>Trading Point ID</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π</th></tr>';
                Object.entries(tradingPointGroups).forEach(([tpId, count]) => {
                    html += `<tr><td>${tpId}</td><td>${count}</td></tr>`;
                });
                html += '</table>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`, 'error');
            }
        }

        async function checkAllTradingPoints() {
            log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏...', 'info');
            
            try {
                const response = await fetch('/supabase-proxy/rest/v1/trading_points?select=id,name,external_id', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY'
                    }
                });
                
                const tradingPoints = await response.json();
                log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${tradingPoints.length}`, 'success');
                
                tradingPoints.forEach(tp => {
                    log(`   ${tp.id} - ${tp.name} (external_id: ${tp.external_id})`, 'info');
                });
                
                const resultsDiv = document.getElementById('results');
                let html = '<h3>üè™ –í—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏</h3><table>';
                html += '<tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>External ID</th></tr>';
                tradingPoints.forEach(tp => {
                    html += `<tr><td>${tp.id}</td><td>${tp.name}</td><td>${tp.external_id || 'null'}</td></tr>`;
                });
                html += '</table>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–µ–∫: ${error.message}`, 'error');
            }
        }

        async function checkOperationsWithoutFilter() {
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞...', 'info');
            
            try {
                const response = await fetch('/supabase-proxy/rest/v1/operations?select=id,trading_point_id,start_time,transaction_id&order=start_time.desc&limit=10', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5NDkwMDAsImV4cCI6MjA1MjUyNTAwMH0.Mn0fYenKB2H0fRD8u_7aTpTw_M-iqGCrVk5M5hKZkN6uF9YhJzbzu2ugHRQCyzuNOwawsTDtwelGO0uCjyY'
                    }
                });
                
                const operations = await response.json();
                log(`‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –æ–ø–µ—Ä–∞—Ü–∏–π:`, 'success');
                
                operations.forEach((op, index) => {
                    log(`   ${index + 1}. ID: ${op.id}, Trading Point: ${op.trading_point_id}, Time: ${op.start_time}, Transaction: ${op.transaction_id}`, 'info');
                });
                
                const resultsDiv = document.getElementById('results');
                let html = '<h3>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –æ–ø–µ—Ä–∞—Ü–∏–π</h3><table>';
                html += '<tr><th>ID</th><th>Trading Point ID</th><th>Start Time</th><th>Transaction ID</th></tr>';
                operations.forEach(op => {
                    html += `<tr><td>${op.id}</td><td>${op.trading_point_id}</td><td>${op.start_time}</td><td>${op.transaction_id}</td></tr>`;
                });
                html += '</table>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π: ${error.message}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            checkOperationsTradingPoints();
        };
    </script>
</body>
</html>