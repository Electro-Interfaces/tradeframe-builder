<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>API Configuration Diagnosis</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #1a1a1a; 
            color: #fff; 
            padding: 20px; 
            max-width: 1000px; 
            margin: 0 auto;
        }
        .container { 
            background: #2d3748; 
            padding: 25px; 
            border-radius: 15px; 
            margin: 15px 0; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .error { background: #742a2a; }
        .success { background: #2d5a27; }
        .warning { background: #b7791f; }
        button { 
            background: #4299e1; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 8px;
        }
        button:hover { background: #3182ce; }
        .log { 
            background: #000; 
            padding: 20px; 
            border-radius: 10px; 
            font-family: monospace; 
            white-space: pre-wrap; 
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success-text { color: #48bb78; }
        .error-text { color: #f56565; }
        .warning-text { color: #ed8936; }
        .info-text { color: #63b3ed; }
        input, textarea {
            width: 100%;
            padding: 10px;
            background: #4a5568;
            border: 1px solid #718096;
            border-radius: 5px;
            color: #fff;
            margin: 5px 0;
        }
        .key-display {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîç API Configuration Diagnosis</h1>
    <p>–î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Supabase API</p>

    <div class="container">
        <h3>üìã Current Configuration</h3>
        <div class="key-display">
            <strong>URL:</strong> <span id="current-url">https://tohtryzyffcebtyvkxwh.supabase.co</span><br>
            <strong>API Key:</strong> <span id="current-key">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMwNjAzNDcsImV4cCI6MjA0ODYzNjM0N30.0R0hKfITlTOlQHYgP4JVfFQi_7xz3kW5nC7VZq6K3k0</span>
        </div>
        <button onclick="testCurrentConfig()">Test Current Config</button>
        <div id="current-result" class="log"></div>
    </div>

    <div class="container">
        <h3>üîß Alternative Configuration Test</h3>
        <p>–ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</p>
        
        <label>Supabase URL:</label>
        <input type="text" id="alt-url" value="https://tohtryzyffcebtyvkxwh.supabase.co" />
        
        <label>API Key (Anon):</label>
        <textarea id="alt-key" rows="3">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMwNjAzNDcsImV4cCI6MjA0ODYzNjM0N30.0R0hKfITlTOlQHYgP4JVfFQi_7xz3kW5nC7VZq6K3k0</textarea>
        
        <button onclick="testAlternativeConfig()">Test Alternative Config</button>
        <div id="alternative-result" class="log"></div>
    </div>

    <div class="container">
        <h3>üåê Direct API Tests</h3>
        <button onclick="testBasicEndpoint()">Test Basic Endpoint</button>
        <button onclick="testWithoutAuth()">Test Without Auth</button>
        <button onclick="testDifferentHeaders()">Test Different Headers</button>
        <div id="direct-result" class="log"></div>
    </div>

    <div class="container">
        <h3>üîç API Key Analysis</h3>
        <button onclick="analyzeAPIKey()">Analyze Current API Key</button>
        <div id="analysis-result" class="log"></div>
    </div>

    <div class="container">
        <h3>üìä Network Debugging</h3>
        <button onclick="debugNetwork()">Debug Network Issues</button>
        <div id="network-result" class="log"></div>
    </div>

    <div class="container">
        <h3>üí° Solutions</h3>
        <div id="solutions" class="log">
–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞ –≤ Supabase Dashboard
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ URL –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ–µ–∫—Ç –∞–∫—Ç–∏–≤–µ–Ω –∏ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
4. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å service key –≤–º–µ—Å—Ç–æ anon key
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Supabase
        </div>
    </div>

    <script>
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error-text' : type === 'success' ? 'success-text' : type === 'warning' ? 'warning-text' : 'info-text';
            container.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            container.scrollTop = container.scrollHeight;
        }

        async function testCurrentConfig() {
            const container = document.getElementById('current-result');
            container.innerHTML = '';
            
            const url = 'https://tohtryzyffcebtyvkxwh.supabase.co';
            const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMwNjAzNDcsImV4cCI6MjA0ODYzNjM0N30.0R0hKfITlTOlQHYgP4JVfFQi_7xz3kW5nC7VZq6K3k0';

            log('current-result', 'üîç Testing current configuration...', 'info');

            try {
                const response = await fetch(`${url}/rest/v1/`, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`
                    }
                });

                log('current-result', `Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log('current-result', `Response: ${responseText.substring(0, 200)}...`, 'info');

                if (response.status === 401) {
                    log('current-result', '‚ùå 401 Unauthorized - API key issue!', 'error');
                    log('current-result', 'üí° Check if API key is expired or incorrect', 'warning');
                } else if (response.status === 403) {
                    log('current-result', '‚ùå 403 Forbidden - Access denied', 'error');
                } else if (response.status === 404) {
                    log('current-result', '‚ùå 404 Not Found - URL might be wrong', 'error');
                } else if (response.ok) {
                    log('current-result', '‚úÖ Connection successful!', 'success');
                }

            } catch (error) {
                log('current-result', `‚ùå Network error: ${error.message}`, 'error');
                log('current-result', 'üí° Check internet connection and CORS', 'warning');
            }
        }

        async function testAlternativeConfig() {
            const container = document.getElementById('alternative-result');
            container.innerHTML = '';
            
            const url = document.getElementById('alt-url').value.trim();
            const key = document.getElementById('alt-key').value.trim();

            log('alternative-result', 'üîç Testing alternative configuration...', 'info');

            if (!url || !key) {
                log('alternative-result', '‚ùå Please provide both URL and API key', 'error');
                return;
            }

            try {
                const response = await fetch(`${url}/rest/v1/`, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`
                    }
                });

                log('alternative-result', `Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log('alternative-result', `Response: ${responseText.substring(0, 200)}...`, 'info');

            } catch (error) {
                log('alternative-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testBasicEndpoint() {
            const container = document.getElementById('direct-result');
            container.innerHTML = '';
            
            log('direct-result', 'üåê Testing basic endpoint access...', 'info');

            const url = 'https://tohtryzyffcebtyvkxwh.supabase.co';
            
            // Test 1: No headers
            try {
                log('direct-result', '1. Testing without headers...', 'info');
                const response1 = await fetch(`${url}/rest/v1/`);
                log('direct-result', `No headers: ${response1.status} ${response1.statusText}`, 'info');
            } catch (error) {
                log('direct-result', `No headers error: ${error.message}`, 'error');
            }

            // Test 2: Only apikey header
            try {
                log('direct-result', '2. Testing with apikey only...', 'info');
                const response2 = await fetch(`${url}/rest/v1/`, {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMwNjAzNDcsImV4cCI6MjA0ODYzNjM0N30.0R0hKfITlTOlQHYgP4JVfFQi_7xz3kW5nC7VZq6K3k0'
                    }
                });
                log('direct-result', `Apikey only: ${response2.status} ${response2.statusText}`, 'info');
            } catch (error) {
                log('direct-result', `Apikey only error: ${error.message}`, 'error');
            }

            // Test 3: Only Authorization header
            try {
                log('direct-result', '3. Testing with Authorization only...', 'info');
                const response3 = await fetch(`${url}/rest/v1/`, {
                    headers: {
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMwNjAzNDcsImV4cCI6MjA0ODYzNjM0N30.0R0hKfITlTOlQHYgP4JVfFQi_7xz3kW5nC7VZq6K3k0'
                    }
                });
                log('direct-result', `Authorization only: ${response3.status} ${response3.statusText}`, 'info');
            } catch (error) {
                log('direct-result', `Authorization only error: ${error.message}`, 'error');
            }
        }

        function analyzeAPIKey() {
            const container = document.getElementById('analysis-result');
            container.innerHTML = '';
            
            const apiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMwNjAzNDcsImV4cCI6MjA0ODYzNjM0N30.0R0hKfITlTOlQHYgP4JVfFQi_7xz3kW5nC7VZq6K3k0';

            log('analysis-result', 'üîç Analyzing API key...', 'info');

            try {
                // Decode JWT token
                const parts = apiKey.split('.');
                if (parts.length !== 3) {
                    log('analysis-result', '‚ùå Invalid JWT format', 'error');
                    return;
                }

                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));

                log('analysis-result', 'üìã JWT Header:', 'info');
                log('analysis-result', JSON.stringify(header, null, 2), 'info');

                log('analysis-result', 'üìã JWT Payload:', 'info');
                log('analysis-result', JSON.stringify(payload, null, 2), 'info');

                // Check expiration
                const now = Date.now() / 1000;
                if (payload.exp && payload.exp < now) {
                    log('analysis-result', '‚ùå API Key is EXPIRED!', 'error');
                    log('analysis-result', `Expired on: ${new Date(payload.exp * 1000).toLocaleString()}`, 'error');
                } else if (payload.exp) {
                    log('analysis-result', `‚úÖ API Key expires: ${new Date(payload.exp * 1000).toLocaleString()}`, 'success');
                } else {
                    log('analysis-result', '‚úÖ API Key does not expire', 'success');
                }

                // Check role
                if (payload.role) {
                    log('analysis-result', `üîë Role: ${payload.role}`, 'info');
                } else {
                    log('analysis-result', '‚ö†Ô∏è No role specified in token', 'warning');
                }

                // Check project reference
                if (payload.ref) {
                    log('analysis-result', `üèóÔ∏è Project reference: ${payload.ref}`, 'info');
                } else {
                    log('analysis-result', '‚ö†Ô∏è No project reference in token', 'warning');
                }

            } catch (error) {
                log('analysis-result', `‚ùå Error analyzing JWT: ${error.message}`, 'error');
            }
        }

        async function debugNetwork() {
            const container = document.getElementById('network-result');
            container.innerHTML = '';
            
            log('network-result', 'üåê Debugging network connectivity...', 'info');

            // Test 1: Basic ping
            try {
                log('network-result', '1. Testing basic connectivity...', 'info');
                const startTime = Date.now();
                const response = await fetch('https://httpbin.org/status/200');
                const endTime = Date.now();
                log('network-result', `‚úÖ Internet connectivity OK (${endTime - startTime}ms)`, 'success');
            } catch (error) {
                log('network-result', `‚ùå No internet connectivity: ${error.message}`, 'error');
                return;
            }

            // Test 2: Supabase domain resolution
            try {
                log('network-result', '2. Testing Supabase domain...', 'info');
                const response = await fetch('https://supabase.com/', { method: 'HEAD' });
                log('network-result', `‚úÖ Supabase.com reachable (${response.status})`, 'success');
            } catch (error) {
                log('network-result', `‚ùå Cannot reach supabase.com: ${error.message}`, 'error');
            }

            // Test 3: Your specific Supabase instance
            try {
                log('network-result', '3. Testing your Supabase instance...', 'info');
                const response = await fetch('https://tohtryzyffcebtyvkxwh.supabase.co/');
                log('network-result', `Supabase instance: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'warning');
            } catch (error) {
                log('network-result', `‚ùå Cannot reach your instance: ${error.message}`, 'error');
            }

            // Test 4: CORS preflight
            try {
                log('network-result', '4. Testing CORS preflight...', 'info');
                const response = await fetch('https://tohtryzyffcebtyvkxwh.supabase.co/rest/v1/', {
                    method: 'OPTIONS'
                });
                log('network-result', `CORS preflight: ${response.status}`, response.ok ? 'success' : 'warning');
            } catch (error) {
                log('network-result', `‚ùå CORS preflight failed: ${error.message}`, 'error');
            }
        }

        async function testWithoutAuth() {
            const container = document.getElementById('direct-result');
            log('direct-result', '4. Testing completely without authentication...', 'info');
            
            try {
                const response = await fetch('https://tohtryzyffcebtyvkxwh.supabase.co/rest/v1/equipment_templates?limit=1');
                log('direct-result', `No auth: ${response.status} ${response.statusText}`, 'info');
                if (response.status === 401) {
                    log('direct-result', '‚úÖ 401 expected without auth - server is working', 'success');
                }
            } catch (error) {
                log('direct-result', `No auth error: ${error.message}`, 'error');
            }
        }

        async function testDifferentHeaders() {
            const container = document.getElementById('direct-result');
            log('direct-result', '5. Testing with different header combinations...', 'info');
            
            const url = 'https://tohtryzyffcebtyvkxwh.supabase.co/rest/v1/equipment_templates?limit=1';
            const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaHRyeXp5ZmZjZWJ0eXZreHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMwNjAzNDcsImV4cCI6MjA0ODYzNjM0N30.0R0hKfITlTOlQHYgP4JVfFQi_7xz3kW5nC7VZq6K3k0';

            const headerTests = [
                {
                    name: 'Standard headers',
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`
                    }
                },
                {
                    name: 'With Content-Type',
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    }
                },
                {
                    name: 'With Accept header',
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Accept': 'application/json'
                    }
                }
            ];

            for (const test of headerTests) {
                try {
                    const response = await fetch(url, { headers: test.headers });
                    log('direct-result', `${test.name}: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                } catch (error) {
                    log('direct-result', `${test.name} error: ${error.message}`, 'error');
                }
            }
        }

        // Auto-run analysis on page load
        setTimeout(() => {
            analyzeAPIKey();
        }, 1000);
    </script>
</body>
</html>